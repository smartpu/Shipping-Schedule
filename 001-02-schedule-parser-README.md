# 维运网 船期解析工具使用说明

## 工具简介

**维运网 船期解析工具** 是一个零安装、离线运行的数据解析工具，用于将 `001-view-source` 目录下的 HTML 船期网页批量解析成 CSV 文件（可直接用 Excel 打开）。工具会自动提取船期信息，包括启运港、目的港、航线信息、船名航次、开航日期、码头信息等，并自动去重合并重复记录。

---

## 快速开始

1. **准备工作**：首先需要使用"维运网 船期网页手动下载工具"（`001-01-manual-download.html`）下载并保存所有船期网页到 `001-view-source` 文件夹中
2. **打开工具**：双击打开 `001-02-schedule-parser.html`（或在浏览器中打开）
3. **选择文件夹**：点击"选择 view-source 文件夹"按钮，选择项目中的 `001-view-source` 目录
4. **开始解析**：点击"开始解析"按钮，等待进度完成
5. **查看结果**：预览下方会显示前 50 行样例
6. **下载 CSV**：确认解析结果无误后，点击"下载 CSV"保存全部结果

---

## 前置准备

在使用解析工具之前，需要先完成以下准备工作：

1. **下载船期网页**：使用"维运网 船期网页手动下载工具"（`001-01-manual-download.html`）下载并保存所有船期网页到 `001-view-source` 文件夹中
2. **确认文件夹**：确保 `001-view-source` 文件夹中包含需要解析的 HTML 文件
3. **浏览器要求**：建议使用最新的 Chrome 或 Edge 浏览器

---

## 详细操作步骤

### 步骤 1：打开工具

双击打开 `001-02-schedule-parser.html` 文件，会在浏览器中打开工具页面。

### 步骤 2：选择文件夹

1. 点击"选择 view-source 文件夹"按钮
2. 在文件选择对话框中选择 `001-view-source` 文件夹
3. 选择后，工具会自动识别文件夹中的所有 HTML 文件
4. "开始解析"按钮将变为可用状态
5. 工具会显示已选择的文件数量

### 步骤 3：开始解析

1. 点击"开始解析"按钮
2. 工具会自动解析所有 HTML 文件中的船期信息
3. **重要**：仅解析直航船期，遇到"中转"或"接二程"标记时停止解析
4. 解析过程中会显示实时日志，包括：
   - 正在解析的文件名
   - 解析到的数据条数
   - 错误或警告信息（如有）
   - "无船期"提示（如果某个网页中没有船期数据）

### 步骤 4：查看结果

1. 解析完成后，可以在下方预览表格中查看解析结果
2. 预览表格最多显示前 50 条数据
3. 可以滚动查看所有列的数据
4. 统计信息会显示总文件数、成功解析数、总数据条数等

### 步骤 5：下载 CSV

1. 确认解析结果无误后，点击"下载 CSV"按钮
2. CSV 文件会自动下载到浏览器的默认下载文件夹
3. 文件名格式：`weiyun-schedule-YYYY-MM-DD-HH-MM-SS.csv`（包含当前日期和时间）

---

## 输出列说明（按顺序）

CSV 文件包含以下 15 列数据：

| 序号 | 列名 | 说明 | 示例 |
|------|------|------|------|
| 1 | 启运港 | 页面顶部"由...发往..."或 JSON 中的 `startPortEnName/startPortCnName` | `QINGDAO(青岛)` |
| 2 | 目的港 | 页面顶部或 JSON 中的 `destPortEnName/destPortCnName` | `JEBEL ALI(杰贝阿里)` |
| 3 | 航线ID | 来自 JSON 中的 `fleetId` | `2533` |
| 4 | 港口ID | 来自 JSON 中的 `fleetIdPort` | `19` |
| 5 | 开航日 | 来自 JSON 中的 `weekdayOfETDFormatter` | `周一` |
| 6 | 航程 | 来自 JSON 中的 `shipdays` | `22天` |
| 7 | 共舱船公司 | 从 `<a href="#1_航线ID_港口ID">` 的 `title` 属性提取，或从 JSON 中的 `carrierShortName/svcCode` | `ARVIA（JFX） \| CUL 中联航运（JFX） \| ECONSHIP（JFX）...` |
| 8 | 船名 | 来自 JSON 中的 `vslName` | `MUMBAI BRIDGE` |
| 9 | 航次 | 来自 JSON 中的 `voyNo` | `2507W` |
| 10 | 船型 | 来自 JSON 中的 `shipCapacity` | `8030TEU` |
| 11 | 计划开航 | 来自 JSON 中的 `etdFormatter` 或 `portSailingDateFormatter`，提取日期部分 | `2025/11/07` |
| 12 | 实际离港 | 来自 JSON 中的 `atdFormatter`，若为空则留空 | `2025/11/08` |
| 13 | 预计到港 | 来自 JSON 中的 `etaFormatter`，提取日期部分 | `2025/11/29` |
| 14 | 启运港码头 | 来自 JSON 中的 `wharfName` 或 `startPortWharfEnShortName/startPortWharfEnFullName` | `QQCT` |
| 15 | 目的港码头 | 来自 JSON 中的 `destPortWharfEnShortName/destPortWharfEnFullName` | `JEBEL ALI CONTAINER TERMINAL 3` |

> **说明**：
> - 程序会自动处理数据清洗，包括去除多余空格、修复断开的单词（如 `QQ CT` → `QQCT`、`TERMINA L` → `TERMINAL`）等
> - 有的页面可能资料不完整（无年份/IMO/船型），程序会自动留空，不会中断解析
> - 共舱船公司信息会从网页中的 `<a>` 标签 `title` 属性自动提取，如果提取失败，会使用 JSON 中的 `carrierShortName` 和 `svcCode`

---

## 解析规则要点

### 数据提取流程

1. **解码 HTML 数据**：
   - 从 HTML 中的 `self.__next_f.push([1,"..."])` 片段解码并拼接 JSON 数据
   - 利用 JSON.parse 解码转义序列，得到可解析的文本

2. **截断处理**：
   - 解析从页面顶部"由...发往..."开始
   - 遇到以下标记时停止解析：
     - HTML 中的 `<div class="text-[14px] font-bold">中转`
     - JSON 中的 `"lineTypeShowName":"接二程"`
   - 仅解析直航船期，不包含中转船期

3. **航线分组解析**：
   - 每个航线分组（`fleetId` + `fleetIdPort`）读取以下信息：
     - **航线信息**：开航日、航程、共舱船公司、启运港码头、目的港码头
     - **船期列表**：从 `scheduleNotices`、`notices` 或 `scheduleNoticeShare` 引用的数组中提取每条船的详细信息

4. **共舱船公司提取**：
   - 根据 `href` 以 `_航线ID_港口ID` 结尾的 `<a>` 标签，提取其完整的 `title` 属性值
   - 使用多种策略进行匹配（正则匹配、DOM 解析等）
   - 如果提取失败，会使用 JSON 中的 `carrierShortName` 和 `svcCode`

5. **数据清洗**：
   - 去除前后空白，压缩内部空白到单空格，移除换行与制表
   - 修复被错误断开的缩写/单词：
     - `QQ CT` → `QQCT`
     - `TERMINA L` → `TERMINAL`
     - `SEA PORT` → `SEAPORT`
     - `PANJA NG` → `PANJANG`
     - `GUDA NG` → `GUDANG`

6. **去重合并**：
   - 按"启运港+目的港+航线ID+港口ID+船名+航次"作为唯一键，合并重复记录
   - 合并规则：
     - 开航日/航程：若已有值则保留，若为空则补充
     - 共舱船公司：优先保留已存在的非空值
     - 其他字段以首条记录为准

---

## 工具特点

- 🎨 **现代化界面**：全屏宽度设计，美观易用
- 📋 **详细说明**：页面内置完整的使用说明，无需查看文档
- 🔄 **自动去重**：自动合并重复的船期记录（相同启运港+目的港+航线ID+港口ID+船名+航次）
- 📊 **实时预览**：解析完成后可立即预览前50条数据
- 💾 **Excel兼容**：CSV文件使用UTF-8带BOM编码，Excel可直接打开
- 🧹 **数据清洗**：自动清洗数据，修复断开的单词和格式问题
- 🚢 **仅解析直航**：自动过滤中转船期，只提取直航数据

---

## 常见问题

### Q1: 解析过程中显示"无船期"或"跳过"

**A**: 可能的原因：

1. 网页中没有直航船期数据（只有中转船期）
2. 网页格式不符合预期
3. 网页数据不完整
4. 网页结构发生变化

**解决**：这是正常现象，工具会继续解析其他文件，不会中断整个解析过程。如果多个文件都显示"无船期"，请检查：

1. HTML 文件是否正确下载
2. 网页结构是否发生变化
3. 是否包含船期数据

### Q2: CSV 文件在 Excel 中打开中文乱码

**A**: 工具生成的 CSV 文件使用 UTF-8 带 BOM 编码，应该可以在 Excel 中正常打开。如果仍然出现乱码，请尝试：

1. 使用 Excel 的"数据" → "从文本/CSV"功能导入
2. 在导入时选择 UTF-8 编码
3. 或者使用其他支持 UTF-8 的软件（如 WPS、LibreOffice）打开

### Q3: 解析速度很慢

**A**: 解析速度取决于：

1. **文件数量**：文件越多，解析时间越长
2. **文件大小**：文件越大，解析时间越长
3. **浏览器性能**：建议使用 Chrome 或 Edge 浏览器

**优化建议**：
- 可以分批解析，不需要一次性解析所有文件
- 关闭其他占用资源的程序
- 使用性能较好的浏览器

### Q4: 预览表格显示不完整

**A**: 预览表格最多显示前 50 条数据，这是为了性能考虑。完整数据会包含在下载的 CSV 文件中。

### Q5: 下载的 CSV 文件在哪里？

**A**: CSV 文件会下载到浏览器的默认下载文件夹。通常位于：

- **Windows**: `C:\Users\用户名\Downloads`
- **Mac**: `~/Downloads`
- **Linux**: `~/Downloads`

可以在浏览器设置中查看或修改默认下载位置。

### Q6: 可以只解析部分文件吗？

**A**: 可以。有两种方式：

1. **临时方式**：在 `001-view-source` 文件夹中临时移动不需要解析的文件到其他位置，解析完成后再移回
2. **分批解析**：可以多次运行解析工具，每次解析不同的文件

### Q7: 解析结果不准确怎么办？

**A**: 如果发现解析结果不准确，请检查：

1. **源文件格式**：确认 HTML 文件格式是否正确
2. **网页结构**：确认网页结构是否符合工具的解析规则
3. **浏览器控制台**：按 F12 打开开发者工具，查看 Console 标签页的错误信息

如果问题持续，可以：
- 检查具体的 HTML 文件内容
- 查看工具页面的日志输出
- 确认网页结构是否发生变化

### Q8: 共舱船公司信息缺失或不完整

**A**: 共舱船公司信息是从网页中的 `<a>` 标签 `title` 属性提取的。如果信息缺失或不完整，可能的原因：

1. 网页中没有对应的 `<a>` 标签
2. `title` 属性为空或不完整
3. 网页结构发生变化

**解决**：工具会尝试多种策略提取共舱船公司信息，如果提取失败，会使用 JSON 中的 `carrierShortName` 和 `svcCode` 作为备选。

---

## 技术说明

### 浏览器要求

建议使用以下浏览器的最新版本：

- **Google Chrome**（推荐）
- **Microsoft Edge**（推荐）
- Mozilla Firefox
- Safari

### 文件格式要求

- **输入格式**：HTML 文件（`.html` 或 `.htm`）
- **输出格式**：CSV 文件（UTF-8 带 BOM 编码）
- **Excel 兼容**：✅ 可直接用 Excel 打开

### 数据存储

- **所有操作在本地完成**：不会上传任何数据到服务器
- **CSV 文件**：保存在浏览器的默认下载文件夹
- **不保存解析历史**：每次运行都是全新的解析过程

### 性能说明

- **解析速度**：取决于文件数量和大小，通常每个文件 1-3 秒
- **内存占用**：解析过程中会占用一定内存，建议关闭其他占用资源的程序
- **浏览器限制**：某些浏览器可能对文件数量有限制，如果文件过多可能无法一次性选择

---

## 目录结构

```
Shipping Schedule/
├─ 001-view-source/                    ← 保存下载的网页文件
│  ├─ 青岛到香港供应商_船期查询_供应商查询_海运费查询_维运网.html
│  ├─ 青岛到新加坡供应商_船期查询_供应商查询_海运费查询_维运网.html
│  └─ ...
├─ 001-01-manual-download.html         ← 维运网船期网页手动下载工具
├─ 001-01-manual-download-README.md    ← 下载工具使用说明
├─ 001-02-schedule-parser.html          ← 维运网船期解析工具
├─ 001-02-schedule-parser-README.md    ← 本说明文档
└─ 001-03-market-schedule.xlsx          ← 数据整合 Excel 文件（可选）
```

---

## 工作流程

### 完整工作流程

1. **第一步：下载网页**
   - 使用 `001-01-manual-download.html` 下载船期网页
   - 保存到 `001-view-source` 文件夹

2. **第二步：解析船期数据**
   - 使用 `001-02-schedule-parser.html` 解析船期信息
   - 导出为 CSV 文件（如：`viyun-vessels-2025-11-20-14-30-00.csv`）

3. **第三步：数据整合**（可选）
   - 将解析后的 CSV 文件整合到 Excel 文件中
   - 可以使用 Excel 的数据导入功能或手动复制粘贴

4. **第四步：数据分析**（可选）
   - 使用其他分析工具进行数据分析
   - 生成市场观察报告

---

## 后续步骤

解析完成后，可以使用以下工具处理数据：

1. **数据整合**：将解析后的 CSV 文件整合到 Excel 文件中
   - 可以使用 Excel 的"数据" → "从文本/CSV"功能导入
   - 或者手动复制粘贴到 Excel 工作表中

2. **数据分析**：使用其他分析工具进行数据分析
   - 分析船期趋势
   - 统计航线运力
   - 生成市场报告

3. **数据更新**：定期更新数据
   - 定期下载最新的船期网页
   - 重新解析生成最新的 CSV 文件
   - 更新到 Excel 文件中

---

## 更新日志

### 当前版本功能

- ✅ 自动解析维运网船期网页
- ✅ 提取 15 列船期数据
- ✅ 自动去重合并重复记录
- ✅ 实时预览功能：解析完成后可立即预览前50条数据
- ✅ Excel 兼容：CSV 文件使用 UTF-8 带 BOM 编码
- ✅ 现代化界面：全屏宽度设计，美观易用
- ✅ 详细日志：解析过程中显示详细的日志信息
- ✅ 数据清洗：自动修复断开的单词和格式问题
- ✅ 仅解析直航：自动过滤中转船期

---

## 技术支持

如有问题或建议，请检查：

1. **浏览器控制台**：按 F12 打开开发者工具，查看 Console 标签页的错误信息
2. **文件格式**：确认 HTML 文件格式是否正确
3. **文件夹路径**：确认 `001-view-source` 文件夹路径是否正确
4. **浏览器版本**：确认使用的是最新版本的浏览器

---

## 免责声明

本工具仅用于辅助解析本地 HTML 文件，所有操作均在本地完成，不会上传任何数据到服务器。解析的内容仅供内部使用，请遵守相关法律法规和网站使用条款。
