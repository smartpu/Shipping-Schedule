<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»´è¿ç½‘ èˆ¹æœŸè§£æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #333;
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }

        .back-home-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .back-home-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .instructions {
            padding: 25px 40px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px 40px;
            border-radius: 8px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #856404;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .instructions strong {
            color: #856404;
        }

        .content {
            padding: 20px 40px 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .file-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .file-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .file-btn input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn[disabled] {
            background: #d2d2d7;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #summary {
            color: #6c757d;
            font-size: 14px;
            margin-left: 10px;
        }

        .log {
            margin-top: 15px;
            background: #fafafa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        #preview {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #e9ecef;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f7f7f9;
            z-index: 1;
            font-weight: 600;
            color: #495057;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .footer {
            padding: 20px 40px;
            background: #f8f9fa;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }

        .page-footer {
            width: 100%;
            background: linear-gradient(135deg, #5f7ae0 0%, #4f2d8c 100%);
            color: white;
            padding: 32px 30px 36px;
            text-align: center;
            margin-top: 0;
            box-sizing: border-box;
        }
        .page-footer h2 {
            font-size: 18px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .page-footer p {
            margin: 6px 0;
            font-size: 13px;
            color: rgba(255,255,255,0.82);
            line-height: 1.5;
        }

        /* ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡†æ ·å¼ */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .auth-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .auth-modal h2 {
            font-size: 24px;
            color: #1f2d3d;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 600;
        }

        .auth-modal p {
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-form-group {
            margin-bottom: 20px;
        }

        .auth-form-group label {
            display: block;
            color: #495057;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .auth-form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .auth-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-submit-btn:active {
            transform: translateY(0);
        }

        .auth-error {
            color: #dc3545;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-overlay.hidden {
            display: none;
        }

        body.auth-locked {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>ğŸ” è®¿é—®éªŒè¯</h2>
            <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">å§“å *</label>
                    <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
                    <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">æ‰‹æœºå· *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">é‚®ç®± *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
                    <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
                </div>
                <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools001" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
            <h1>ç»´è¿ç½‘ èˆ¹æœŸè§£æå·¥å…·</h1>
            <p>è‡ªåŠ¨è§£æç»´è¿ç½‘èˆ¹æœŸç½‘é¡µï¼Œæå–èˆ¹æœŸä¿¡æ¯å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶</p>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li><strong>å‡†å¤‡å·¥ä½œ</strong>ï¼šé¦–å…ˆéœ€è¦ä½¿ç”¨"ç»´è¿ç½‘ èˆ¹æœŸç½‘é¡µæ‰‹åŠ¨ä¸‹è½½å·¥å…·"ä¸‹è½½å¹¶ä¿å­˜æ‰€æœ‰èˆ¹æœŸç½‘é¡µåˆ° <strong>001-view-source</strong> æ–‡ä»¶å¤¹ä¸­</li>
                <li><strong>é€‰æ‹©æ–‡ä»¶å¤¹</strong>ï¼šç‚¹å‡»"é€‰æ‹© view-source æ–‡ä»¶å¤¹"æŒ‰é’®ï¼Œé€‰æ‹©åŒ…å«æ‰€æœ‰ HTML æ–‡ä»¶çš„ <strong>001-view-source</strong> æ–‡ä»¶å¤¹</li>
                <li><strong>å¼€å§‹è§£æ</strong>ï¼šé€‰æ‹©æ–‡ä»¶å¤¹åï¼Œç‚¹å‡»"å¼€å§‹è§£æ"æŒ‰é’®ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è§£ææ‰€æœ‰ HTML æ–‡ä»¶ä¸­çš„èˆ¹æœŸä¿¡æ¯</li>
                <li><strong>æŸ¥çœ‹ç»“æœ</strong>ï¼šè§£æå®Œæˆåï¼Œå¯ä»¥åœ¨ä¸‹æ–¹é¢„è§ˆè¡¨æ ¼ä¸­æŸ¥çœ‹è§£æç»“æœï¼ˆæœ€å¤šæ˜¾ç¤ºå‰50æ¡ï¼‰</li>
                <li><strong>ä¸‹è½½ CSV</strong>ï¼šç¡®è®¤è§£æç»“æœæ— è¯¯åï¼Œç‚¹å‡»"ä¸‹è½½ CSV"æŒ‰é’®ï¼Œå°†æ•°æ®ä¿å­˜ä¸º CSV æ–‡ä»¶</li>
                <li><strong>ç»“æœè¯´æ˜</strong>ï¼šCSV æ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—ï¼šå¯è¿æ¸¯ã€ç›®çš„æ¸¯ã€èˆªçº¿IDã€æ¸¯å£IDã€å¼€èˆªæ—¥ã€èˆªç¨‹ã€å…±èˆ±èˆ¹å…¬å¸ã€èˆ¹åã€èˆªæ¬¡ã€èˆ¹å‹ã€è®¡åˆ’å¼€èˆªã€å®é™…ç¦»æ¸¯ã€é¢„è®¡åˆ°æ¸¯ã€å¯è¿æ¸¯ç å¤´ã€ç›®çš„æ¸¯ç å¤´</li>
                <li><strong>æ³¨æ„äº‹é¡¹</strong>ï¼šå·¥å…·ä¼šè‡ªåŠ¨åˆå¹¶é‡å¤çš„èˆ¹æœŸè®°å½•ï¼ˆç›¸åŒå¯è¿æ¸¯+ç›®çš„æ¸¯+èˆªçº¿ID+æ¸¯å£ID+èˆ¹å+èˆªæ¬¡ï¼‰ï¼Œå…±èˆ±èˆ¹å…¬å¸ä¿¡æ¯ä¼šä»ç½‘é¡µä¸­è‡ªåŠ¨æå–</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        é€‰æ‹© view-source æ–‡ä»¶å¤¹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>å¼€å§‹è§£æ</button>
                    <button id="download" class="btn" disabled>ä¸‹è½½ CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>æç¤ºï¼šè§£æè¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢ï¼Œè§£æå®Œæˆåä¼šè‡ªåŠ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</p>
        </div>
    </div>

<script>
        // ç”¨æˆ·éªŒè¯ç³»ç»Ÿ
        (function() {
            const AUTH_STORAGE_KEY = 'shipping_tools_auth';
            const AUTH_EXPIRY_DAYS = 7;
            const ACCESS_LOG_KEY = 'shipping_tools_access_log';
            const MAX_LOG_ENTRIES = 100;

            function checkAuth() {
                try {
                    const authData = localStorage.getItem(AUTH_STORAGE_KEY);
                    if (!authData) return false;
                    const data = JSON.parse(authData);
                    const now = Date.now();
                    if (data.expiry && now > data.expiry) {
                        localStorage.removeItem(AUTH_STORAGE_KEY);
                        return false;
                    }
                    return true;
                } catch (e) {
                    return false;
                }
            }

            function saveAuth(name, phone, email) {
                const expiry = Date.now() + (AUTH_EXPIRY_DAYS * 24 * 60 * 60 * 1000);
                const authData = {
                    name: name.trim(),
                    phone: phone.trim(),
                    email: email.trim().toLowerCase(),
                    timestamp: Date.now(),
                    expiry: expiry
                };
                localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(authData));
            }

            function logAccess(pageName) {
                try {
                    const authData = JSON.parse(localStorage.getItem(AUTH_STORAGE_KEY) || '{}');
                    const logEntry = {
                        page: pageName,
                        name: authData.name || 'æœªçŸ¥',
                        phone: authData.phone || 'æœªçŸ¥',
                        email: authData.email || 'æœªçŸ¥',
                        timestamp: Date.now(),
                        date: new Date().toLocaleString('zh-CN')
                    };
                    let logs = [];
                    try {
                        const existingLogs = localStorage.getItem(ACCESS_LOG_KEY);
                        if (existingLogs) logs = JSON.parse(existingLogs);
                    } catch (e) {
                        logs = [];
                    }
                    logs.unshift(logEntry);
                    if (logs.length > MAX_LOG_ENTRIES) logs = logs.slice(0, MAX_LOG_ENTRIES);
                    localStorage.setItem(ACCESS_LOG_KEY, JSON.stringify(logs));
                } catch (e) {
                    console.warn('è®°å½•è®¿é—®æ—¥å¿—å¤±è´¥', e);
                }
            }

            function initAuth() {
                const authOverlay = document.getElementById('authOverlay');
                const authForm = document.getElementById('authForm');
                const nameInput = document.getElementById('userName');
                const phoneInput = document.getElementById('userPhone');
                const emailInput = document.getElementById('userEmail');
                const nameError = document.getElementById('nameError');
                const phoneError = document.getElementById('phoneError');
                const emailError = document.getElementById('emailError');

                if (!authOverlay || !authForm) return;

                if (checkAuth()) {
                    authOverlay.classList.add('hidden');
                    document.body.classList.remove('auth-locked');
                    logAccess('001-02-schedule-parser.html');
                    return;
                }

                document.body.classList.add('auth-locked');
                authOverlay.classList.remove('hidden');
                if (nameInput) nameInput.focus();

                authForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = nameInput.value.trim();
                    const phone = phoneInput.value.trim();
                    const email = emailInput.value.trim().toLowerCase();
                    
                    if (!name) {
                        nameError.classList.add('show');
                        nameInput.focus();
                        return;
                    } else {
                        nameError.classList.remove('show');
                    }

                    const phoneRegex = /^1[3-9]\d{9}$/;
                    if (!phone || !phoneRegex.test(phone)) {
                        phoneError.classList.add('show');
                        phoneInput.focus();
                        return;
                    } else {
                        phoneError.classList.remove('show');
                    }

                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!email || !emailRegex.test(email)) {
                        emailError.classList.add('show');
                        emailInput.focus();
                        return;
                    } else {
                        emailError.classList.remove('show');
                    }

                    saveAuth(name, phone, email);
                    logAccess('001-02-schedule-parser.html');
                    authOverlay.classList.add('hidden');
                    document.body.classList.remove('auth-locked');
                });

                nameInput.addEventListener('input', () => {
                    if (nameInput.value.trim()) nameError.classList.remove('show');
                });

                phoneInput.addEventListener('input', () => {
                    const phone = phoneInput.value.trim();
                    if (phone && /^1[3-9]\d{9}$/.test(phone)) {
                        phoneError.classList.remove('show');
                    }
                });

                emailInput.addEventListener('input', () => {
                    const email = emailInput.value.trim();
                    if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        emailError.classList.remove('show');
                    }
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initAuth);
            } else {
                initAuth();
            }
        })();

(function(){
    const $ = (s) => document.querySelector(s);
    const logBox = $('#log');
    function log(m, cls){ const d=document.createElement('div'); if(cls) d.style.color=cls; d.textContent=m; logBox.appendChild(d); logBox.scrollTop=logBox.scrollHeight; }

    function toCsvCell(v){ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s; }
    function rowsToCsv(rows){ return rows.map(r=>r.map(toCsvCell).join(',')).join('\n'); }
    function downloadBlob(content, name, type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),5e3); }

    function text(el){ return el? (el.textContent||'').trim():''; }

    // ç»Ÿä¸€æ¸…æ´—ï¼šå»é™¤å‰åç©ºç™½ï¼Œå‹ç¼©å†…éƒ¨ç©ºç™½åˆ°å•ç©ºæ ¼ï¼Œç§»é™¤æ¢è¡Œä¸åˆ¶è¡¨
    function clean(v){
        if(v==null) return '';
        const s = String(v).replace(/[\r\n\t]+/g,' ').replace(/\s+/g,' ').trim();
        return s;
    }

    // ç å¤´åæ¸…æ´—ï¼šä¿®å¤è¢«é”™è¯¯æ–­å¼€çš„ç¼©å†™/å•è¯ï¼Œå¦‚ "QQ CT" -> "QQCT", "TERMINA L" -> "TERMINAL"
    function normalizeWharfTokens(name){
        let s = clean(name);
        if(!s) return s;
        const parts = s.split(' ');
        const out = [];
        for(let i=0;i<parts.length;i++){
            const cur = parts[i];
            if(!cur){ continue; }
            // è‹¥ä¸‹ä¸€ä¸ªæ˜¯å•ä¸ªå¤§å†™å­—æ¯ï¼Œä¸”å½“å‰ä¸ºå…¨å¤§å†™å­—æ¯ï¼ˆå¦‚ TERMINA + Lï¼‰-> åˆå¹¶
            if(i+1<parts.length){
                const next = parts[i+1];
                if(/^[A-Z]+$/.test(cur) && /^[A-Z]$/.test(next)){
                    out.push(cur + next);
                    i++; continue;
                }
                // è‹¥ä¸¤è¾¹å‡ä¸º 1-2 ä½çš„å¤§å†™å­—æ¯ç¼©å†™ï¼ˆå¦‚ QQ + CTï¼‰-> åˆå¹¶
                if(/^[A-Z]{1,2}$/.test(cur) && /^[A-Z]{1,2}$/.test(next)){
                    out.push(cur + next);
                    i++; continue;
                }
            }
            out.push(cur);
        }
        s = out.join(' ');
        // ç‰¹å®šè¯ä¿®æ­£ï¼šTER MINALã€SEA PORTã€PANJA NGã€GUDA NG
        s = s.replace(/\bTER MINAL\b/g, 'TERMINAL')
             .replace(/\bSEA PORT\b/g, 'SEAPORT')
             .replace(/\bPANJA NG\b/g, 'PANJANG')
             .replace(/\bGUDA NG\b/g, 'GUDANG');
        return s;
    }

    // æ ¹æ®"_èˆªçº¿ID_æ¸¯å£ID"åç¼€ç²¾å‡†å®šä½ <a ... title="...">
    // è¦æ±‚ï¼šhref å¿…é¡»ä»¥ "_èˆªçº¿ID_æ¸¯å£ID" ç»“å°¾ï¼ˆå¯èƒ½å‰é¢æœ‰ #1_ ç­‰å‰ç¼€ï¼‰
    function findCosTitle(decodedHtml, fleetId, fleetIdPort, originalHtml){
        const suffix = `_${fleetId}_${fleetIdPort}`;
        const sufEsc = suffix.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        
        // åœ¨å¤šä¸ªæ–‡æœ¬æºä¸­æœç´¢
        const searchTexts = [decodedHtml];
        if(originalHtml && originalHtml !== decodedHtml){
            searchTexts.push(originalHtml);
        }
        
        for(const searchText of searchTexts){
            // ç­–ç•¥1ï¼šå…ˆæ‰¾åˆ°æ‰€æœ‰åŒ…å«è¯¥ suffix çš„ href ä½ç½®
            const hrefPattern = new RegExp(`href=["']([^"']*${sufEsc})["']`, 'gi');
            let hrefMatch;
            while((hrefMatch = hrefPattern.exec(searchText)) !== null){
                const hrefValue = hrefMatch[1];
                if(!hrefValue || !hrefValue.endsWith(suffix)) continue;
                
                const hrefStart = hrefMatch.index;
                const hrefEnd = hrefMatch.index + hrefMatch[0].length;
                
                // å‘å‰æŸ¥æ‰¾ <a æ ‡ç­¾çš„å¼€å§‹ï¼ˆæœ€å¤šå‘å‰500å­—ç¬¦ï¼‰
                const searchStart = Math.max(0, hrefStart - 500);
                const beforeHref = searchText.substring(searchStart, hrefStart);
                const tagStart = beforeHref.lastIndexOf('<a');
                if(tagStart === -1) continue;
                const actualTagStart = searchStart + tagStart;
                
                // å‘åæŸ¥æ‰¾ > æ ‡ç­¾çš„ç»“æŸï¼ˆæœ€å¤šå‘å1000å­—ç¬¦ï¼Œå› ä¸ºtitleå¯èƒ½å¾ˆé•¿ï¼‰
                const searchEnd = Math.min(searchText.length, hrefEnd + 1000);
                const afterHref = searchText.substring(hrefEnd, searchEnd);
                const tagEnd = afterHref.indexOf('>');
                if(tagEnd === -1) continue;
                const actualTagEnd = hrefEnd + tagEnd;
                
                // æå–æ•´ä¸ªæ ‡ç­¾å†…å®¹
                const tagContent = searchText.substring(actualTagStart, actualTagEnd + 1);
                
                // åœ¨æ ‡ç­¾å†…å®¹ä¸­æŸ¥æ‰¾ titleï¼ˆæ”¯æŒå„ç§æ ¼å¼ï¼‰
                // å°è¯•å¤šç§æ¨¡å¼
                const titlePatterns = [
                    /title=(["'])((?:(?!\1)[\s\S])*?)\1/i,  // title="..." æˆ– title='...'
                    /title\s*=\s*(["'])((?:(?!\1)[\s\S])*?)\1/i,  // title = "..." (æœ‰ç©ºæ ¼)
                    /title\s*:\s*(["'])((?:(?!\1)[\s\S])*?)\1/i   // title: "..." (JSONæ ¼å¼)
                ];
                
                for(const titleRe of titlePatterns){
                    const titleMatch = tagContent.match(titleRe);
                    if(titleMatch && titleMatch[2]){
                        let titleValue = titleMatch[2];
                        // å¤„ç†å„ç§è½¬ä¹‰
                        titleValue = titleValue.replace(/\\"/g, '"')
                                             .replace(/\\'/g, "'")
                                             .replace(/\\n/g, ' ')
                                             .replace(/\\t/g, ' ')
                                             .replace(/\\r/g, '');
                        const cleaned = clean(titleValue);
                        if(cleaned) return cleaned;
                    }
                }
            }
            
            // ç­–ç•¥2ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç›´æ¥åŒ¹é…ï¼ˆå•è¡Œæ¨¡å¼ï¼Œä½œä¸ºè¡¥å……ï¼‰
            const pattern1 = new RegExp(`<a[\\s\\S]{0,2000}?href=["']([^"']*${sufEsc})["'][\\s\\S]{0,2000}?title=(["'])([\\s\\S]*?)\\2`, 'i');
            const pattern2 = new RegExp(`<a[\\s\\S]{0,2000}?title=(["'])([\\s\\S]*?)\\1[\\s\\S]{0,2000}?href=["']([^"']*${sufEsc})["']`, 'i');
            
            for(const re of [pattern1, pattern2]){
                let m;
                while((m = re.exec(searchText)) !== null){
                    if(m && m.length >= 4){
                        let hrefValue, titleValue;
                        if(re === pattern1){
                            hrefValue = m[1];
                            titleValue = m[3];
                        }else{
                            titleValue = m[2];
                            hrefValue = m[3];
                        }
                        if(hrefValue && titleValue && hrefValue.endsWith(suffix)){
                            let cleaned = titleValue.replace(/\\"/g, '"')
                                                   .replace(/\\'/g, "'")
                                                   .replace(/\\n/g, ' ')
                                                   .replace(/\\t/g, ' ')
                                                   .replace(/\\r/g, '');
                            cleaned = clean(cleaned);
                            if(cleaned) return cleaned;
                        }
                    }
                }
            }
        }
        
        // ç­–ç•¥3ï¼šæ›´æ¿€è¿›çš„æœç´¢ - ç›´æ¥æœç´¢åŒ…å« suffix çš„æ–‡æœ¬ç‰‡æ®µ
        // æ‰¾åˆ°æ‰€æœ‰åŒ…å« suffix çš„ä½ç½®ï¼ŒéªŒè¯å®ƒåœ¨ href ä¸­ï¼Œç„¶ååœ¨å…¶å‰åæœç´¢ title
        for(const searchText of searchTexts){
            let searchIndex = 0;
            while(true){
                const suffixIndex = searchText.indexOf(suffix, searchIndex);
                if(suffixIndex === -1) break;
                searchIndex = suffixIndex + 1;
                
                // éªŒè¯ suffix åœ¨ href å±æ€§ä¸­ï¼ˆå‘å‰æŸ¥æ‰¾ href=ï¼Œå‘åæŸ¥æ‰¾å¼•å·ï¼‰
                const beforeSuffix = searchText.substring(Math.max(0, suffixIndex - 100), suffixIndex);
                const afterSuffix = searchText.substring(suffixIndex, Math.min(searchText.length, suffixIndex + suffix.length + 50));
                
                // æ£€æŸ¥æ˜¯å¦åœ¨ href å±æ€§ä¸­
                const hrefMatch = beforeSuffix.match(/href\s*=\s*["']/i);
                if(!hrefMatch) continue;
                
                // åœ¨ suffix å‰åå„2000å­—ç¬¦èŒƒå›´å†…æœç´¢
                const searchStart = Math.max(0, suffixIndex - 2000);
                const searchEnd = Math.min(searchText.length, suffixIndex + suffix.length + 2000);
                const context = searchText.substring(searchStart, searchEnd);
                
                // åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾ <a> æ ‡ç­¾å’Œ title
                const aTagMatch = context.match(/<a[\s\S]{0,3000}?>/i);
                if(aTagMatch){
                    const aTagStartInContext = context.indexOf(aTagMatch[0]);
                    const aTagEnd = searchStart + aTagStartInContext + aTagMatch[0].length;
                    // åœ¨ <a> æ ‡ç­¾åæŸ¥æ‰¾ titleï¼ˆæœ€å¤šå‘å1500å­—ç¬¦ï¼‰
                    const afterTag = searchText.substring(aTagEnd, Math.min(searchText.length, aTagEnd + 1500));
                    const titleMatch = afterTag.match(/title\s*=\s*(["'])((?:(?!\1)[\s\S])*?)\1/i);
                    if(titleMatch && titleMatch[2]){
                        let titleValue = titleMatch[2];
                        titleValue = titleValue.replace(/\\"/g, '"')
                                             .replace(/\\'/g, "'")
                                             .replace(/\\n/g, ' ')
                                             .replace(/\\t/g, ' ')
                                             .replace(/\\r/g, '');
                        const cleaned = clean(titleValue);
                        if(cleaned) return cleaned;
                    }
                }
            }
        }
        
        // ç­–ç•¥4ï¼šDOM å›é€€ï¼ˆåªåœ¨è§£ç åçš„HTMLä¸­å°è¯•ï¼‰
        try{
            const doc = new DOMParser().parseFromString(decodedHtml, 'text/html');
            const links = Array.from(doc.querySelectorAll('a[href]'));
            for(const link of links){
                const href = link.getAttribute('href') || '';
                if(href && href.endsWith(suffix) && link.hasAttribute('title')){
                    return clean(link.getAttribute('title'));
                }
            }
        }catch(e){}
        return '';
    }

    // æŠŠ self.__next_f.push([1,"..."]) é‡Œçš„å­—ç¬¦ä¸²è§£ç æ‹¼æ¥ï¼Œå¾—åˆ°å¯è§£ææ–‡æœ¬
    function extractDecodedPayload(html){
        let out = '';
        const re = /self\.__next_f\.push\(\[\d+\s*,\s*(["'])([\s\S]*?)\1\]\)/g;
        let m;
        while((m=re.exec(html))){
            try{
                // åˆ©ç”¨ JSON.parse è§£ç è½¬ä¹‰åºåˆ—
                out += JSON.parse('"'+m[2].replace(/\\"/g,'\\\"')+'"');
            }catch(e){
                // é€€åŒ–å¤„ç†å¸¸è§è½¬ä¹‰
                out += m[2].replace(/\\n/g,'\n').replace(/\\t/g,'\t').replace(/\\"/g,'"');
            }
            out += '\n';
        }
        // å¦‚æœæ²¡æŠ“åˆ° push ç‰‡æ®µï¼Œå°±ç›´æ¥ç”¨åŸ html
        return out || html;
    }

    // æ„å»º label -> å¯¹è±¡/æ•°ç»„ çš„ç´¢å¼•ï¼ˆå…¨é¡µï¼‰
    function buildLabelIndex(html){
        const objects = new Map();
        const arrays = new Map();
        const objRe = /([A-Za-z0-9_]+)\s*:\s*\{([\s\S]*?)\}\s*(?=\n|\r|\]|,|<|$)/g; let m;
        while((m=objRe.exec(html))){
            const label=m[1]; const raw='{'+m[2].replace(/,\s*\}/g,'}')+'}';
            try{ const o=JSON.parse(raw); objects.set(label,o);}catch(e){}
        }
        const arrRe = /([A-Za-z0-9_]+)\s*:\s*\[([\s\S]*?)\]\s*(?=\n|\r|\}|,|<|$)/g; let m2;
        while((m2=arrRe.exec(html))){
            const label=m2[1]; const body=m2[2]; const items=[];
            const itemRe=/"\$?([A-Za-z0-9_]+)"/g; let t; while((t=itemRe.exec(body))){ items.push(t[1]); }
            arrays.set(label, items);
        }
        return {objects, arrays};
    }

    // è§£å¼•ç”¨ notices/scheduleNotices/scheduleNoticeShare -> èˆ¹æœŸå¯¹è±¡æ•°ç»„
    function derefList(labelIndex, label){
        if(!label) return [];
        const key=String(label).replace(/^\$/,'');
        const labs=labelIndex.arrays.get(key)||[];
        const out=[]; for(const lb of labs){ const o=labelIndex.objects.get(lb); if(o && (o.vslName||o.voyNo)) out.push(o); }
        return out;
    }

    // ä»æ•´é¡µæå–"fleetå— + å¯¹åº”èˆ¹æœŸ"å¯¹
    function extractFleetAndVessels(html, labelIndex){
        const out=[];
        const re=/\{[^}]*?"fleetId"\s*:\s*(\d+)[^}]*?"fleetIdPort"\s*:\s*(\d+)[^}]*?\}/g; let m;
        while((m=re.exec(html))){
            const seg=m[0];
            const fleetId=m[1]; const fleetIdPort=m[2];
            const cs=/("carrierShortName"\s*:\s*"([^"]*)")/.exec(seg); const carrierShortName=cs? cs[2]:'';
            const sc=/("svcCode"\s*:\s*"([^"]*)")/.exec(seg); const svcCode=sc? sc[2]:'';
            const wd=/("weekdayOfETDFormatter"\s*:\s*"([^"]*)")/.exec(seg); const weekday=wd? wd[2]:'';
            const sd=/("shipdays"\s*:\s*(\d+))/.exec(seg); const shipdays=sd? sd[2]:'';
            const pol=/("wharfName"\s*:\s*"([^"]*)")/.exec(seg); let polWharf=pol? pol[2]:'';
            // å¯è¿æ¸¯ç å¤´æ›´å¤šå…¼å®¹å­—æ®µ
            if(!polWharf){ const spS=/("startPortWharfEnShortName"\s*:\s*"([^"]*)")/.exec(seg); const spF=/("startPortWharfEnFullName"\s*:\s*"([^"]*)")/.exec(seg); if(spS||spF){ polWharf = spS? spS[2] : (spF? spF[2] : ''); } }
            let podShort=(/("destPortWharfEnShortName"\s*:\s*"([^"]*)")/.exec(seg)||[])[2]||'';
            let podFull=(/("destPortWharfEnFullName"\s*:\s*"([^"]*)")/.exec(seg)||[])[2]||'';
            // åº”ç”¨ç å¤´åè§„èŒƒåŒ–
            polWharf = normalizeWharfTokens(polWharf);
            podShort = normalizeWharfTokens(podShort);
            podFull = normalizeWharfTokens(podFull);
            const spE=/("startPortEnName"\s*:\s*"([^"]*)")/.exec(seg); const spC=/("startPortCnName"\s*:\s*"([^"]*)")/.exec(seg);
            const dpE=/("destPortEnName"\s*:\s*"([^"]*)")/.exec(seg); const dpC=/("destPortCnName"\s*:\s*"([^"]*)")/.exec(seg);
            const sn=/("scheduleNotices"\s*:\s*"\$?([A-Za-z0-9_]+)")/.exec(seg); const lab1=sn? sn[2]:'';
            const an=/("notices"\s*:\s*"\$?([A-Za-z0-9_]+)")/.exec(seg); const lab2=an? an[2]:'';
            const sh=/("scheduleNoticeShare"\s*:\s*"\$?([A-Za-z0-9_]+)")/.exec(seg); const lab3=sh? sh[2]:'';

            let vessels=[]; 
            vessels = derefList(labelIndex, lab1);
            if(!vessels.length) vessels = derefList(labelIndex, lab2);
            if(!vessels.length) vessels = derefList(labelIndex, lab3);

            const origin = spE && spC ? `${spE[2]}(${spC[2]})` : '';
            const dest = dpE && dpC ? `${dpE[2]}(${dpC[2]})` : '';
            out.push({fleetId, fleetIdPort, carrierShortName, svcCode, weekday, shipdays, polWharf, podShort, podFull, origin, dest, vessels});
        }
        return out;
    }

    // é¡¶éƒ¨"ç”± XXX å‘å¾€ YYY ..."
    // ä¼˜å…ˆï¼šåœ¨ä»»æ„å¯¹è±¡ç‰‡æ®µä¸­æŸ¥æ‰¾ start/dest å››ä¸ªå­—æ®µï¼ˆé€‚é… fc:{...} ç»“æ„ï¼‰
    // æ¬¡çº§ï¼šDOM ä¸Šæ–¹æç¤ºæ¡
    // å…œåº•ï¼šæ­£åˆ™åŒ¹é…"ç”±...å‘å¾€..."
    function extractOriginDest(html){
        const mJson = html.match(/"startPortEnName"\s*:\s*"([^"]+)"[\s\S]*?"startPortCnName"\s*:\s*"([^"]+)"[\s\S]*?"destPortEnName"\s*:\s*"([^"]+)"[\s\S]*?"destPortCnName"\s*:\s*"([^"]+)"/);
        if(mJson){
            const origin = `${mJson[1]}(${mJson[2]})`;
            const dest = `${mJson[3]}(${mJson[4]})`;
            return {origin, dest};
        }
        try{
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const bar = doc.querySelector('span.flex.items-center.text-\\[12px\\]');
            if(bar){
                const strongs = Array.from(bar.querySelectorAll('span.font-bold'));
                const o = strongs[0]? (strongs[0].textContent||'').trim():'';
                const d = strongs[1]? (strongs[1].textContent||'').trim():'';
                if(o && d) return {origin:o, dest:d};
            }
        }catch(e){}
        const mText=html.match(/>\s*([A-Z][A-Z\s]+)<!-- -->\(<!-- -->([\u4e00-\u9fa5]+)<!-- -->\)<\/span>å‘å¾€<\span[^>]*>\s*([A-Z][A-Z\s]+)<!-- -->\(<!-- -->([\u4e00-\u9fa5]+)<!-- -->\)\s*<\/span>/);
        if(mText) return {origin:`${mText[1].trim()}(${mText[2]})`, dest:`${mText[3].trim()}(${mText[4]})`};
        return {origin:'',dest:''};
    }

    function datePart(s){ if(!s) return ''; const m=String(s).match(/(\d{4}\/\d{2}\/\d{2})/); return m? m[1]:''; }

    function parseFile(name, html){
        const decoded = extractDecodedPayload(html);
        // æˆªæ–­ï¼šå‡ºç°"ä¸­è½¬"æˆ–"æ¥äºŒç¨‹"åé¢çš„å†…å®¹å¿½ç•¥
        const cutMarkers = [
            'text-[14px] font-bold">ä¸­è½¬',
            'lineTypeShowName":"æ¥äºŒç¨‹"'
        ];
        let cutPos = -1;
        for(const mk of cutMarkers){ const p = decoded.indexOf(mk); if(p>=0 && (cutPos===-1 || p<cutPos)) cutPos = p; }
        const mainText = cutPos>0 ? decoded.slice(0, cutPos) : decoded;

        const labelIndex = buildLabelIndex(mainText);
        const fleets = extractFleetAndVessels(mainText, labelIndex);
        const odTop = extractOriginDest(decoded);

        const rows=[];
        for(const f of fleets){
            const lineId=f.fleetId; const portId=f.fleetIdPort;
            // å…±èˆ±èˆ¹å…¬å¸ï¼šåœ¨å®Œæ•´è§£ç æ–‡æœ¬å’ŒåŸå§‹HTMLä¸­æŸ¥æ‰¾ _lineId_portId å¯¹åº”çš„ <a> çš„ title
            let cos = findCosTitle(decoded, lineId, portId, html);
            if(!cos){ cos = [f.carrierShortName && f.svcCode? `${f.carrierShortName}(${f.svcCode})`:f.carrierShortName].filter(Boolean).join(''); }
            const podCombined = f.podShort? `${f.podShort}/${f.podFull||''}`: (f.podFull||'');
            const origin = f.origin || odTop.origin || '';
            const dest = f.dest || odTop.dest || '';
            for(const v of f.vessels){
                const vsl=v.vslName||''; const voy=v.voyNo||''; const st=v.shipCapacity||'';
                const plan=datePart(v.etdFormatter||v.portSailingDateFormatter||'');
                const atd=datePart(v.atdFormatter||'');
                const eta=datePart(v.etaFormatter||'');
                rows.push([
                    clean(origin),                      // å¯è¿æ¸¯
                    clean(dest),                        // ç›®çš„æ¸¯
                    clean(lineId),                      // èˆªçº¿ID
                    clean(portId),                      // æ¸¯å£ID
                    clean(f.weekday||''),               // å¼€èˆªæ—¥
                    clean(f.shipdays||''),              // èˆªç¨‹
                    clean(cos),                         // å…±èˆ±èˆ¹å…¬å¸
                    clean(vsl),                         // èˆ¹å
                    clean(voy),                         // èˆªæ¬¡
                    clean(st),                          // èˆ¹å‹
                    clean(plan),                        // è®¡åˆ’å¼€èˆª
                    clean(atd),                         // å®é™…ç¦»æ¸¯
                    clean(eta),                         // é¢„è®¡åˆ°æ¸¯
                    clean(f.polWharf||''),              // å¯è¿æ¸¯ç å¤´
                    clean(podCombined)                  // ç›®çš„æ¸¯ç å¤´
                ]);
            }
        }
        // å…¨å±€å…œåº•ï¼šè‹¥ä»æ— èˆ¹æœŸï¼Œä»æ•´é¡µç›´æ¥æŠ“å–å« vslName çš„å¯¹è±¡
        if(rows.length===0){
            const re=/\{[^{}]*?"vslName"\s*:\s*"[^"]+"[\s\S]*?\}/g; let m;
            while((m=re.exec(mainText))){
                const objText=m[0].replace(/,\s*\}/g,'}');
                try{
                    const v=JSON.parse(objText);
                    if(!v.vslName && !v.voyNo) continue;
                    const vsl=v.vslName||''; const voy=v.voyNo||''; const st=v.shipCapacity||'';
                    const plan=datePart(v.etdFormatter||v.portSailingDateFormatter||'');
                    const atd=datePart(v.atdFormatter||'');
                    const eta=datePart(v.etaFormatter||'');
                    rows.push([clean(odTop.origin||''), clean(odTop.dest||''), '', '', '', '', '', clean(vsl), clean(voy), clean(st), clean(plan), clean(atd), clean(eta), '', '']);
                }catch(e){ /* ignore */ }
            }
        }
        return rows;
    }

    function renderPreview(rows){
        const headers=['å¯è¿æ¸¯','ç›®çš„æ¸¯','èˆªçº¿ID','æ¸¯å£ID','å¼€èˆªæ—¥','èˆªç¨‹','å…±èˆ±èˆ¹å…¬å¸','èˆ¹å','èˆªæ¬¡','èˆ¹å‹','è®¡åˆ’å¼€èˆª','å®é™…ç¦»æ¸¯','é¢„è®¡åˆ°æ¸¯','å¯è¿æ¸¯ç å¤´','ç›®çš„æ¸¯ç å¤´'];
        const table=$('#table'); const container=$('#preview');
        table.innerHTML='';
        const thead=document.createElement('thead'); const trh=document.createElement('tr');
        headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); }); thead.appendChild(trh); table.appendChild(thead);
        const tbody=document.createElement('tbody');
        for(let i=0;i<Math.min(rows.length,50);i++){
            const tr=document.createElement('tr'); rows[i].forEach(c=>{ const td=document.createElement('td'); td.textContent=c||''; tr.appendChild(td); }); tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        container.classList.toggle('hidden', rows.length===0);
    }

    const picker=$('#picker'); const runBtn=$('#run'); const downloadBtn=$('#download'); const summary=$('#summary');
    let files=[]; let output=[];

    picker.addEventListener('change', ()=>{
        logBox.innerHTML=''; output=[]; summary.textContent='';
        files = Array.from(picker.files).filter(f=>/\.html?$/i.test(f.name)).sort((a,b)=>a.name.localeCompare(b.name));
        if(!files.length){ log('æœªé€‰æ‹©åˆ° HTML æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹© view-sourceã€‚', '#b00020'); runBtn.disabled=true; downloadBtn.disabled=true; return; }
        log(`å·²é€‰æ‹© ${files.length} ä¸ª HTML æ–‡ä»¶ã€‚`, '#0a7d33');
        runBtn.disabled=false; downloadBtn.disabled=true; $('#preview').classList.add('hidden');
    });

    runBtn.addEventListener('click', async ()=>{
        runBtn.disabled=true; downloadBtn.disabled=true; output=[]; $('#preview').classList.add('hidden');
        const header=['å¯è¿æ¸¯','ç›®çš„æ¸¯','èˆªçº¿ID','æ¸¯å£ID','å¼€èˆªæ—¥','èˆªç¨‹','å…±èˆ±èˆ¹å…¬å¸','èˆ¹å','èˆªæ¬¡','èˆ¹å‹','è®¡åˆ’å¼€èˆª','å®é™…ç¦»æ¸¯','é¢„è®¡åˆ°æ¸¯','å¯è¿æ¸¯ç å¤´','ç›®çš„æ¸¯ç å¤´'];
        const rows=[header];
        let ok=0, warn=0;
        for(const f of files){
            try{
                const html = await f.text();
                const r = parseFile(f.name, html);
                if(!r.length){ warn++; log(`[æ— èˆ¹æœŸ] ${f.name}`, '#b36b00'); }
                else { ok++; log(`[OK] ${f.name} -> ${r.length} è¡Œ`, '#0a7d33'); rows.push(...r); }
            }catch(e){ warn++; log(`[å¤±è´¥] ${f.name}: ${e && e.message? e.message: e}`, '#b00020'); }
        }
        // å»é‡åˆå¹¶ï¼šé”® = å¯è¿æ¸¯ + ç›®çš„æ¸¯ + èˆªçº¿ID + æ¸¯å£ID + èˆ¹å + èˆªæ¬¡ï¼›å…±èˆ±èˆ¹å…¬å¸åˆå¹¶å»é‡
        const map = new Map();
        for(let i=1;i<rows.length;i++){
            const [o,d,lineId,portId,day,sd,cos,vsl,voy,stype,plan,atd,eta,polW,podW] = rows[i].map(clean);
            const key = [o,d,lineId,portId,vsl,voy].join('|');
            if(!map.has(key)){
                map.set(key, [o,d,lineId,portId,day,sd,cos,vsl,voy,stype,plan,atd,eta,polW,podW]);
            }else{
                const ex = map.get(key);
                // åˆå¹¶å¼€èˆªæ—¥/èˆªç¨‹ï¼ˆä¿ç•™å·²æœ‰ï¼Œè‹¥ç©ºåˆ™è¡¥ï¼‰
                if(!ex[4] && day) ex[4]=day;
                if(!ex[5] && sd) ex[5]=sd;
                // å…±èˆ±ï¼šæŒ‰éœ€æ±‚ä½¿ç”¨ <a title> çš„æ–‡æœ¬ï¼Œä¸å†æ‹¼æ¥åˆå¹¶ï¼›ä¼˜å…ˆä¿ç•™å·²å­˜åœ¨çš„éç©ºå€¼
                if(!ex[6] && cos) ex[6] = cos;
                // å…¶ä»–å­—æ®µä»¥é¦–æ¡ä¸ºå‡†ï¼Œå¦‚è®¡åˆ’/ATD/ETA/ç å¤´ä¸€èˆ¬ä¸€è‡´
            }
        }
        const merged = [header, ...Array.from(map.values())];
        output = merged;
        renderPreview(merged.slice(1));
        downloadBtn.disabled = merged.length<=1;
        summary.textContent = `å®Œæˆï¼š${ok} æ–‡ä»¶ï¼Œ${warn} æé†’ï¼Œåˆå¹¶å ${merged.length-1} æ¡ã€‚`;
    });

    downloadBtn.addEventListener('click', ()=>{
        if(!output || output.length<=1) return;
        const csv='\uFEFF'+rowsToCsv(output);
        const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        downloadBlob(csv, `weiyun-schedule-${ts}.csv`, 'text/csv;charset=utf-8');
    });
})();
</script>
    </div>
    <div class="page-footer">
        <h2>ç»´è¿ç½‘ èˆ¹æœŸè§£æå·¥å…·ä½¿ç”¨å£°æ˜</h2>
        <p>æœ¬å·¥å…·ç”¨äºè§£æä»ç»´è¿ç½‘ï¼ˆweiyun.comï¼‰ä¸‹è½½çš„èˆ¹æœŸç½‘é¡µï¼Œæå–èˆªçº¿ã€èˆ¹åã€èˆªæ¬¡ã€å¼€èˆ¹æ—¥æœŸç­‰æ•°æ®å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶ã€‚</p>
        <p>æ‰€æœ‰æ•°æ®æ¥æºäºç»´è¿ç½‘å…¬å¼€ä¿¡æ¯ï¼Œè§£æç»“æœä»…ä¾›å†…éƒ¨ä½¿ç”¨ï¼Œè¯·éµå®ˆç»´è¿ç½‘çš„ä½¿ç”¨æ¡æ¬¾å’Œç‰ˆæƒè§„å®šã€‚</p>
    </div>
</body>
</html>
