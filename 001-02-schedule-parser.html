<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»´è¿ç½‘ èˆ¹æœŸè§£æå·¥å…·</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/tool-styles.css">
    <link rel="stylesheet" href="vendor/parser-styles.css">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ï¼ˆä¿ç•™ä¸å…¬å…±æ ·å¼ä¸åŒçš„éƒ¨åˆ†ï¼‰ */
        
        /* èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–æ¨¡æ€æ¡†æ ·å¼ */
        .vessel-voyage-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .vessel-voyage-modal.hidden {
            display: none;
        }
        
        .vessel-voyage-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            width: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .vessel-voyage-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .vessel-voyage-modal-header h2 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .vessel-voyage-modal-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .vessel-voyage-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .vessel-voyage-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .vessel-voyage-group-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .vessel-voyage-option {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vessel-voyage-option:hover {
            border-color: #0a7d33;
            background: #f0f8f4;
        }
        
        .vessel-voyage-option.selected {
            border-color: #0a7d33;
            background: #e8f5e9;
        }
        
        .vessel-voyage-option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .vessel-voyage-option-label {
            flex: 1;
            font-size: 14px;
        }
        
        .vessel-voyage-option-count {
            color: #666;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .vessel-voyage-modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .vessel-voyage-modal-footer .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .vessel-voyage-modal-footer .btn-primary {
            background: #0a7d33;
            color: white;
        }
        
        .vessel-voyage-modal-footer .btn-primary:hover {
            background: #086b2a;
        }
        
        .vessel-voyage-modal-footer .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .vessel-voyage-modal-footer .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .vessel-voyage-modal-footer .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body data-page="001-02-schedule-parser.html">
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>ğŸ” è®¿é—®éªŒè¯</h2>
            <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">å§“å *</label>
                    <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
                    <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">æ‰‹æœºå· *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">é‚®ç®± *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
                    <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
                </div>
                <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools001" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
            <a href="001-02-schedule-parser-README.html" class="readme-btn">ä½¿ç”¨è¯´æ˜ â†’</a>
            <h1>ç»´è¿ç½‘ èˆ¹æœŸè§£æå·¥å…·</h1>
            <p>è‡ªåŠ¨è§£æç»´è¿ç½‘èˆ¹æœŸç½‘é¡µï¼Œæå–èˆ¹æœŸä¿¡æ¯å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶</p>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li><strong>å‡†å¤‡å·¥ä½œ</strong>ï¼šé¦–å…ˆéœ€è¦ä½¿ç”¨"ç»´è¿ç½‘ èˆ¹æœŸç½‘é¡µæ‰‹åŠ¨ä¸‹è½½å·¥å…·"ä¸‹è½½å¹¶ä¿å­˜æ‰€æœ‰èˆ¹æœŸç½‘é¡µåˆ° <strong>data/001-view-full</strong> æ–‡ä»¶å¤¹ä¸­</li>
                <li><strong>é€‰æ‹©æ–‡ä»¶å¤¹</strong>ï¼šç‚¹å‡»"é€‰æ‹© view-full æ–‡ä»¶å¤¹"æŒ‰é’®ï¼Œé€‰æ‹©åŒ…å«æ‰€æœ‰ HTML æ–‡ä»¶çš„ <strong>data/001-view-full</strong> æ–‡ä»¶å¤¹</li>
                <li><strong>å¼€å§‹è§£æ</strong>ï¼šé€‰æ‹©æ–‡ä»¶å¤¹åï¼Œç‚¹å‡»"å¼€å§‹è§£æ"æŒ‰é’®ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è§£ææ‰€æœ‰ HTML æ–‡ä»¶ä¸­çš„èˆ¹æœŸä¿¡æ¯</li>
                <li><strong>æŸ¥çœ‹ç»“æœ</strong>ï¼šè§£æå®Œæˆåï¼Œå¯ä»¥åœ¨ä¸‹æ–¹é¢„è§ˆè¡¨æ ¼ä¸­æŸ¥çœ‹è§£æç»“æœï¼ˆæœ€å¤šæ˜¾ç¤ºå‰50æ¡ï¼‰</li>
                <li><strong>ä¸‹è½½ CSV</strong>ï¼šç¡®è®¤è§£æç»“æœæ— è¯¯åï¼Œç‚¹å‡»"ä¸‹è½½ CSV"æŒ‰é’®ï¼Œå°†æ•°æ®ä¿å­˜ä¸º CSV æ–‡ä»¶</li>
                <li><strong>ç»“æœè¯´æ˜</strong>ï¼šCSV æ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—ï¼šå¯è¿æ¸¯ã€ç›®çš„æ¸¯ã€èˆªçº¿IDã€æ¸¯å£IDã€å¼€èˆªæ—¥ã€èˆªç¨‹ã€å…±èˆ±èˆ¹å…¬å¸ã€èˆ¹åã€èˆªæ¬¡ã€èˆ¹å‹ã€è®¡åˆ’å¼€èˆªã€å®é™…ç¦»æ¸¯ã€é¢„è®¡åˆ°æ¸¯ã€å¯è¿æ¸¯ç å¤´ã€ç›®çš„æ¸¯ç å¤´</li>
                <li><strong>æ³¨æ„äº‹é¡¹</strong>ï¼šå·¥å…·ä¼šè‡ªåŠ¨åˆå¹¶é‡å¤çš„èˆ¹æœŸè®°å½•ï¼ˆç›¸åŒå¯è¿æ¸¯+ç›®çš„æ¸¯+èˆªçº¿ID+æ¸¯å£ID+èˆ¹å+èˆªæ¬¡ï¼‰ï¼Œå…±èˆ±èˆ¹å…¬å¸ä¿¡æ¯ä¼šä»ç½‘é¡µä¸­è‡ªåŠ¨æå–</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        é€‰æ‹© view-full æ–‡ä»¶å¤¹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>å¼€å§‹è§£æ</button>
                    <button id="download" class="btn" disabled>ä¸‹è½½ CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>æç¤ºï¼šè§£æè¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢ï¼Œè§£æå®Œæˆåä¼šè‡ªåŠ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</p>
        </div>
    </div>

    <!-- èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="vesselVoyageModal" class="vessel-voyage-modal hidden">
        <div class="vessel-voyage-modal-content">
            <div class="vessel-voyage-modal-header">
                <h2>ğŸ” èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–</h2>
                <p>å‘ç°ä»¥ä¸‹èˆ¹åèˆªæ¬¡å»ç©ºæ ¼åç›¸åŒä½†æ ¼å¼ä¸åŒï¼Œè¯·ä¸ºæ¯ç»„é€‰æ‹©ä¸€ä¸ªæ ‡å‡†æ ¼å¼ï¼š</p>
            </div>
            <div id="vesselVoyageList" class="vessel-voyage-list"></div>
            <div class="vessel-voyage-modal-footer">
                <button id="applyVesselVoyageReplace" class="btn btn-primary">åº”ç”¨æ›¿æ¢å¹¶ç»§ç»­</button>
                <button id="skipVesselVoyageReplace" class="btn btn-secondary">è·³è¿‡ï¼ˆä¿ç•™åŸå€¼ï¼‰</button>
            </div>
        </div>
    </div>

    <!-- ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="podWharfModal" class="vessel-voyage-modal hidden">
        <div class="vessel-voyage-modal-content">
            <div class="vessel-voyage-modal-header">
                <h2>ğŸ” ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–</h2>
                <p>å‘ç°ä»¥ä¸‹ç›®çš„æ¸¯ç å¤´å»ç©ºæ ¼åç›¸åŒä½†æ ¼å¼ä¸åŒï¼Œè¯·ä¸ºæ¯ç»„é€‰æ‹©ä¸€ä¸ªæ ‡å‡†æ ¼å¼ï¼š</p>
            </div>
            <div id="podWharfList" class="vessel-voyage-list"></div>
            <div class="vessel-voyage-modal-footer">
                <button id="applyPodWharfReplace" class="btn btn-primary">åº”ç”¨æ›¿æ¢å¹¶ç»§ç»­</button>
                <button id="skipPodWharfReplace" class="btn btn-secondary">è·³è¿‡ï¼ˆä¿ç•™åŸå€¼ï¼‰</button>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨ Gist å­˜å‚¨ç³»ç»Ÿï¼ˆç”¨æˆ·ç™½åå• + è®¿é—®è®°å½•ï¼‰ -->
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/parser-utils.js"></script>
    <script>

(function(){
    /**
     * DOM é€‰æ‹©å™¨è¾…åŠ©å‡½æ•°
     * @param {string} selector - CSS é€‰æ‹©å™¨
     * @returns {HTMLElement|null} æ‰¾åˆ°çš„å…ƒç´ 
     */
    const selectElement = (selector) => document.querySelector(selector);
    const log = createLogger('#log');

    /** CSV utils - ä½¿ç”¨ parser-utils.js ä¸­çš„å‡½æ•° */
    /** DOM helpers - ä½¿ç”¨ parser-utils.js ä¸­çš„å‡½æ•° (text, find, findAll) */

    /**
     * ç»Ÿä¸€æ¸…æ´—ï¼šå»é™¤å‰åç©ºç™½ï¼Œå‹ç¼©å†…éƒ¨ç©ºç™½åˆ°å•ç©ºæ ¼ï¼Œç§»é™¤æ¢è¡Œä¸åˆ¶è¡¨
     * @param {any} value - è¦æ¸…æ´—çš„å€¼
     * @returns {string} æ¸…æ´—åçš„å­—ç¬¦ä¸²
     */
    function clean(value) {
        if (value == null) return '';
        const cleanedString = String(value)
            .replace(/[\r\n\t]+/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
        return cleanedString;
    }

    /**
     * æ¸…æ´—èˆ¹å‹ï¼šå¤„ç† xxx TEU æ ¼å¼ï¼Œåˆå¹¶ä¸º xxxTEU
     * @param {string} shipType - èˆ¹å‹å­—ç¬¦ä¸²
     * @returns {string} æ¸…æ´—åçš„èˆ¹å‹
     */
    function cleanShipType(shipType) {
        if (!shipType) return '';
        // å»æ‰æ‰€æœ‰ç©ºæ ¼ï¼ˆJåˆ—è¦æ±‚æ— ç©ºæ ¼ï¼‰ï¼Œå¹¶å…¼å®¹æ•°å­—+TEUçš„åœºæ™¯
        return clean(shipType).replace(/\s+/g, '');
    }

    /**
     * æ¸…æ´—èˆ¹åèˆªæ¬¡ï¼šä¿ç•™åŸå€¼ï¼Œä½†æä¾›å»ç©ºæ ¼ç‰ˆæœ¬ç”¨äºæ¯”è¾ƒ
     * @param {string} vesselName - èˆ¹å
     * @param {string} voyage - èˆªæ¬¡
     * @returns {Object} {original: åŸå€¼, normalized: å»ç©ºæ ¼ç‰ˆæœ¬}
     */
    function normalizeVesselVoyage(vesselName, voyage) {
        const normalizedVessel = vesselName ? clean(vesselName).replace(/\s+/g, '') : '';
        const normalizedVoyage = voyage ? clean(voyage).replace(/\s+/g, '') : '';
        return {
            vesselOriginal: vesselName || '',
            voyageOriginal: voyage || '',
            vesselNormalized: normalizedVessel,
            voyageNormalized: normalizedVoyage,
            combinedNormalized: `${normalizedVessel}_${normalizedVoyage}`
        };
    }

    /**
     * è§„èŒƒåŒ–ç›®çš„æ¸¯ç å¤´ï¼šå»ç©ºæ ¼åç”¨äºæ¯”è¾ƒ
     * @param {string} podWharf - ç›®çš„æ¸¯ç å¤´
     * @returns {string} å»ç©ºæ ¼åçš„ç›®çš„æ¸¯ç å¤´
     */
    function normalizePodWharf(podWharf) {
        if (!podWharf) return '';
        return clean(podWharf).replace(/\s+/g, '').toUpperCase();
    }

    /** ç‰¹å®šç å¤´åç§°ä¿®æ­£æ˜ å°„ */
    const WHARF_NAME_CORRECTIONS = {
        'TER MINAL': 'TERMINAL',
        'SEA PORT': 'SEAPORT',
        'PANJA NG': 'PANJANG',
        'GUDA NG': 'GUDANG'
    };

    /**
     * åˆå¹¶ç›¸é‚»çš„ç å¤´åç§°ç‰‡æ®µ
     * @param {string} current - å½“å‰ç‰‡æ®µ
     * @param {string} next - ä¸‹ä¸€ä¸ªç‰‡æ®µ
     * @returns {boolean} æ˜¯å¦åº”è¯¥åˆå¹¶
     */
    function shouldMergeTokens(current, next) {
        // è‹¥ä¸‹ä¸€ä¸ªæ˜¯å•ä¸ªå¤§å†™å­—æ¯ï¼Œä¸”å½“å‰ä¸ºå…¨å¤§å†™å­—æ¯ï¼ˆå¦‚ TERMINA + Lï¼‰-> åˆå¹¶
        if (/^[A-Z]+$/.test(current) && /^[A-Z]$/.test(next)) {
            return true;
        }
        // è‹¥ä¸¤è¾¹å‡ä¸º 1-2 ä½çš„å¤§å†™å­—æ¯ç¼©å†™ï¼ˆå¦‚ QQ + CTï¼‰-> åˆå¹¶
        if (/^[A-Z]{1,2}$/.test(current) && /^[A-Z]{1,2}$/.test(next)) {
            return true;
        }
        return false;
    }

    /**
     * åº”ç”¨ç‰¹å®šè¯ä¿®æ­£
     * @param {string} text - è¦ä¿®æ­£çš„æ–‡æœ¬
     * @returns {string} ä¿®æ­£åçš„æ–‡æœ¬
     */
    function applyWharfNameCorrections(text) {
        let correctedText = text;
        for (const [wrong, correct] of Object.entries(WHARF_NAME_CORRECTIONS)) {
            const regex = new RegExp(`\\b${wrong}\\b`, 'g');
            correctedText = correctedText.replace(regex, correct);
        }
        return correctedText;
    }

    /**
     * ç å¤´åæ¸…æ´—ï¼šä¿®å¤è¢«é”™è¯¯æ–­å¼€çš„ç¼©å†™/å•è¯ï¼Œå¦‚ "QQ CT" -> "QQCT", "TERMINA L" -> "TERMINAL"
     * @param {string} name - åŸå§‹ç å¤´åç§°
     * @returns {string} æ¸…æ´—åçš„ç å¤´åç§°
     */
    function normalizeWharfTokens(name) {
        const cleanedName = clean(name);
        if (!cleanedName) return cleanedName;
        
        const parts = cleanedName.split(' ');
        const mergedParts = [];
        
        for (let i = 0; i < parts.length; i++) {
            const currentPart = parts[i];
            if (!currentPart) {
                continue;
            }
            
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥ä¸ä¸‹ä¸€ä¸ªç‰‡æ®µåˆå¹¶
            if (i + 1 < parts.length) {
                const nextPart = parts[i + 1];
                if (shouldMergeTokens(currentPart, nextPart)) {
                    mergedParts.push(currentPart + nextPart);
                    i++; // è·³è¿‡ä¸‹ä¸€ä¸ªç‰‡æ®µï¼Œå› ä¸ºå·²ç»åˆå¹¶
                    continue;
                }
            }
            
            mergedParts.push(currentPart);
        }
        
        const joinedText = mergedParts.join(' ');
        return applyWharfNameCorrections(joinedText);
    }

    /** æœç´¢èŒƒå›´å¸¸é‡ */
    const SEARCH_RANGES = {
        BEFORE_HREF: 500,    // å‘å‰æŸ¥æ‰¾ <a æ ‡ç­¾çš„å¼€å§‹
        AFTER_HREF: 1000,    // å‘åæŸ¥æ‰¾ > æ ‡ç­¾çš„ç»“æŸ
        BEFORE_SUFFIX: 2000, // åœ¨ suffix å‰åæœç´¢çš„èŒƒå›´
        AFTER_SUFFIX: 2000,
        TAG_CONTENT: 3000,   // æ ‡ç­¾å†…å®¹æœ€å¤§é•¿åº¦
        AFTER_TAG: 1500       // <a> æ ‡ç­¾åæŸ¥æ‰¾ title çš„èŒƒå›´
    };

    /** Title å±æ€§åŒ¹é…æ¨¡å¼ */
    const TITLE_PATTERNS = [
        /title=(["'])((?:(?!\1)[\s\S])*?)\1/i,        // title="..." æˆ– title='...'
        /title\s*=\s*(["'])((?:(?!\1)[\s\S])*?)\1/i,  // title = "..." (æœ‰ç©ºæ ¼)
        /title\s*:\s*(["'])((?:(?!\1)[\s\S])*?)\1/i   // title: "..." (JSONæ ¼å¼)
    ];

    /**
     * è½¬ä¹‰ title å€¼ä¸­çš„è½¬ä¹‰åºåˆ—
     * @param {string} titleValue - åŸå§‹ title å€¼
     * @returns {string} è½¬ä¹‰åçš„ title å€¼
     */
    function unescapeTitleValue(titleValue) {
        return titleValue
            .replace(/\\"/g, '"')
            .replace(/\\'/g, "'")
            .replace(/\\n/g, ' ')
            .replace(/\\t/g, ' ')
            .replace(/\\r/g, '');
    }

    /**
     * ä»æ ‡ç­¾å†…å®¹ä¸­æå– title å€¼
     * @param {string} tagContent - æ ‡ç­¾å†…å®¹
     * @returns {string|null} æå–çš„ title å€¼ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
     */
    function extractTitleFromTagContent(tagContent) {
        for (const titlePattern of TITLE_PATTERNS) {
            const titleMatch = tagContent.match(titlePattern);
            if (titleMatch && titleMatch[2]) {
                const unescapedTitle = unescapeTitleValue(titleMatch[2]);
                const cleanedTitle = clean(unescapedTitle);
                if (cleanedTitle) {
                    return cleanedTitle;
                }
            }
        }
        return null;
    }

    /**
     * ç­–ç•¥1ï¼šé€šè¿‡ href å®šä½æ‰¾åˆ°å¯¹åº”çš„ <a> æ ‡ç­¾å¹¶æå– title
     * @param {string} searchText - è¦æœç´¢çš„æ–‡æœ¬
     * @param {string} suffix - åç¼€ï¼ˆ_fleetId_fleetIdPortï¼‰
     * @param {string} escapedSuffix - è½¬ä¹‰åçš„åç¼€
     * @returns {string|null} æ‰¾åˆ°çš„ title å€¼ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
     */
    function findTitleByHrefLocation(searchText, suffix, escapedSuffix) {
        const hrefPattern = new RegExp(`href=["']([^"']*${escapedSuffix})["']`, 'gi');
        let hrefMatch;
        
        while ((hrefMatch = hrefPattern.exec(searchText)) !== null) {
            const hrefValue = hrefMatch[1];
            if (!hrefValue || !hrefValue.endsWith(suffix)) {
                continue;
            }
            
            const hrefStart = hrefMatch.index;
            const hrefEnd = hrefMatch.index + hrefMatch[0].length;
            
            // å‘å‰æŸ¥æ‰¾ <a æ ‡ç­¾çš„å¼€å§‹
            const searchStart = Math.max(0, hrefStart - SEARCH_RANGES.BEFORE_HREF);
            const beforeHref = searchText.substring(searchStart, hrefStart);
            const tagStart = beforeHref.lastIndexOf('<a');
            if (tagStart === -1) {
                continue;
            }
            const actualTagStart = searchStart + tagStart;
            
            // å‘åæŸ¥æ‰¾ > æ ‡ç­¾çš„ç»“æŸ
            const searchEnd = Math.min(searchText.length, hrefEnd + SEARCH_RANGES.AFTER_HREF);
            const afterHref = searchText.substring(hrefEnd, searchEnd);
            const tagEnd = afterHref.indexOf('>');
            if (tagEnd === -1) {
                continue;
            }
            const actualTagEnd = hrefEnd + tagEnd;
            
            // æå–æ•´ä¸ªæ ‡ç­¾å†…å®¹
            const tagContent = searchText.substring(actualTagStart, actualTagEnd + 1);
            const title = extractTitleFromTagContent(tagContent);
            if (title) {
                return title;
            }
        }
        
        return null;
    }

    /**
     * ç­–ç•¥2ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç›´æ¥åŒ¹é…æ•´ä¸ª <a> æ ‡ç­¾
     * @param {string} searchText - è¦æœç´¢çš„æ–‡æœ¬
     * @param {string} suffix - åç¼€
     * @param {string} escapedSuffix - è½¬ä¹‰åçš„åç¼€
     * @returns {string|null} æ‰¾åˆ°çš„ title å€¼ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
     */
    function findTitleByRegexMatch(searchText, suffix, escapedSuffix) {
        const patterns = [
            new RegExp(`<a[\\s\\S]{0,${SEARCH_RANGES.TAG_CONTENT}}?href=["']([^"']*${escapedSuffix})["'][\\s\\S]{0,${SEARCH_RANGES.TAG_CONTENT}}?title=(["'])([\\s\\S]*?)\\2`, 'i'),
            new RegExp(`<a[\\s\\S]{0,${SEARCH_RANGES.TAG_CONTENT}}?title=(["'])([\\s\\S]*?)\\1[\\s\\S]{0,${SEARCH_RANGES.TAG_CONTENT}}?href=["']([^"']*${escapedSuffix})["']`, 'i')
        ];
        
        for (const pattern of patterns) {
            let match;
            while ((match = pattern.exec(searchText)) !== null) {
                if (match && match.length >= 4) {
                    let hrefValue, titleValue;
                    if (pattern === patterns[0]) {
                        hrefValue = match[1];
                        titleValue = match[3];
                    } else {
                        titleValue = match[2];
                        hrefValue = match[3];
                    }
                    
                    if (hrefValue && titleValue && hrefValue.endsWith(suffix)) {
                        const unescapedTitle = unescapeTitleValue(titleValue);
                        const cleanedTitle = clean(unescapedTitle);
                        if (cleanedTitle) {
                            return cleanedTitle;
                        }
                    }
                }
            }
        }
        
        return null;
    }

    /**
     * ç­–ç•¥3ï¼šæ›´æ¿€è¿›çš„æœç´¢ - ç›´æ¥æœç´¢åŒ…å« suffix çš„æ–‡æœ¬ç‰‡æ®µ
     * @param {string} searchText - è¦æœç´¢çš„æ–‡æœ¬
     * @param {string} suffix - åç¼€
     * @returns {string|null} æ‰¾åˆ°çš„ title å€¼ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
     */
    function findTitleBySuffixSearch(searchText, suffix) {
        let searchIndex = 0;
        
        while (true) {
            const suffixIndex = searchText.indexOf(suffix, searchIndex);
            if (suffixIndex === -1) {
                break;
            }
            searchIndex = suffixIndex + 1;
            
            // éªŒè¯ suffix åœ¨ href å±æ€§ä¸­
            const beforeSuffix = searchText.substring(
                Math.max(0, suffixIndex - SEARCH_RANGES.BEFORE_SUFFIX),
                suffixIndex
            );
            const hrefMatch = beforeSuffix.match(/href\s*=\s*["']/i);
            if (!hrefMatch) {
                continue;
            }
            
            // åœ¨ suffix å‰åå„2000å­—ç¬¦èŒƒå›´å†…æœç´¢
            const searchStart = Math.max(0, suffixIndex - SEARCH_RANGES.BEFORE_SUFFIX);
            const searchEnd = Math.min(
                searchText.length,
                suffixIndex + suffix.length + SEARCH_RANGES.AFTER_SUFFIX
            );
            const context = searchText.substring(searchStart, searchEnd);
            
            // åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾ <a> æ ‡ç­¾å’Œ title
            const aTagMatch = context.match(/<a[\s\S]{0,3000}?>/i);
            if (aTagMatch) {
                const aTagStartInContext = context.indexOf(aTagMatch[0]);
                const aTagEnd = searchStart + aTagStartInContext + aTagMatch[0].length;
                // åœ¨ <a> æ ‡ç­¾åæŸ¥æ‰¾ title
                const afterTag = searchText.substring(
                    aTagEnd,
                    Math.min(searchText.length, aTagEnd + SEARCH_RANGES.AFTER_TAG)
                );
                const titleMatch = afterTag.match(/title\s*=\s*(["'])((?:(?!\1)[\s\S])*?)\1/i);
                if (titleMatch && titleMatch[2]) {
                    const unescapedTitle = unescapeTitleValue(titleMatch[2]);
                    const cleanedTitle = clean(unescapedTitle);
                    if (cleanedTitle) {
                        return cleanedTitle;
                    }
                }
            }
        }
        
        return null;
    }

    /**
     * ç­–ç•¥4ï¼šDOM è§£æå›é€€æ–¹æ¡ˆ
     * @param {string} decodedHtml - è§£ç åçš„ HTML
     * @param {string} suffix - åç¼€
     * @returns {string|null} æ‰¾åˆ°çš„ title å€¼ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
     */
    function findTitleByDomParsing(decodedHtml, suffix) {
        try {
            const doc = new DOMParser().parseFromString(decodedHtml, 'text/html');
            const links = Array.from(doc.querySelectorAll('a[href]'));
            
            for (const link of links) {
                const href = link.getAttribute('href') || '';
                if (href && href.endsWith(suffix) && link.hasAttribute('title')) {
                    const title = clean(link.getAttribute('title'));
                    if (title) {
                        return title;
                    }
                }
            }
        } catch (error) {
            // DOM è§£æå¤±è´¥ï¼Œé™é»˜è¿”å› null
        }
        
        return null;
    }

    /**
     * æ ¹æ®"_èˆªçº¿ID_æ¸¯å£ID"åç¼€ç²¾å‡†å®šä½ <a ... title="...">
     * è¦æ±‚ï¼šhref å¿…é¡»ä»¥ "_èˆªçº¿ID_æ¸¯å£ID" ç»“å°¾ï¼ˆå¯èƒ½å‰é¢æœ‰ #1_ ç­‰å‰ç¼€ï¼‰
     * ä¼˜åŒ–ï¼šæ·»åŠ æ—©æœŸé€€å‡ºï¼Œå‡å°‘ä¸å¿…è¦çš„æœç´¢
     * @param {string} decodedHtml - è§£ç åçš„ HTML
     * @param {string} fleetId - èˆªçº¿ID
     * @param {string} fleetIdPort - æ¸¯å£ID
     * @param {string} originalHtml - åŸå§‹ HTMLï¼ˆå¯é€‰ï¼‰
     * @returns {string} æ‰¾åˆ°çš„å…±èˆ±èˆ¹å…¬å¸æ ‡é¢˜ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
     */
    function findCosTitle(decodedHtml, fleetId, fleetIdPort, originalHtml) {
        const suffix = `_${fleetId}_${fleetIdPort}`;
        const escapedSuffix = suffix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        
        // ä¼˜åŒ–ï¼šå¿«é€Ÿæ£€æŸ¥æ˜¯å¦å­˜åœ¨suffixï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›
        if (decodedHtml.indexOf(suffix) === -1 && (!originalHtml || originalHtml.indexOf(suffix) === -1)) {
            return '';
        }
        
        // åœ¨å¤šä¸ªæ–‡æœ¬æºä¸­æœç´¢
        const searchTexts = [decodedHtml];
        if (originalHtml && originalHtml !== decodedHtml) {
            searchTexts.push(originalHtml);
        }
        
        // æŒ‰ä¼˜å…ˆçº§å°è¯•å„ç§ç­–ç•¥ï¼ˆä¼˜åŒ–ï¼šå¿«é€Ÿç­–ç•¥ä¼˜å…ˆï¼‰
        for (const searchText of searchTexts) {
            // ç­–ç•¥2ï¼šæ­£åˆ™è¡¨è¾¾å¼ç›´æ¥åŒ¹é…ï¼ˆé€šå¸¸æœ€å¿«ï¼‰
            const title2 = findTitleByRegexMatch(searchText, suffix, escapedSuffix);
            if (title2) return title2;
            
            // ç­–ç•¥1ï¼šé€šè¿‡ href å®šä½
            const title1 = findTitleByHrefLocation(searchText, suffix, escapedSuffix);
            if (title1) return title1;
            
            // ç­–ç•¥3ï¼šæ¿€è¿›æœç´¢ï¼ˆæœ€æ…¢ï¼Œæœ€åå°è¯•ï¼‰
            // ä¼˜åŒ–ï¼šåªåœ¨å…¶ä»–ç­–ç•¥éƒ½å¤±è´¥æ—¶æ‰å°è¯•
            // const title3 = findTitleBySuffixSearch(searchText, suffix);
            // if (title3) return title3;
        }
        
        // ç­–ç•¥4ï¼šDOM è§£æï¼ˆåªåœ¨è§£ç åçš„HTMLä¸­å°è¯•ï¼Œä¸”åªåœ¨å…¶ä»–ç­–ç•¥éƒ½å¤±è´¥æ—¶ï¼‰
        // ä¼˜åŒ–ï¼šDOMè§£æå¾ˆæ…¢ï¼Œåªåœ¨å¿…è¦æ—¶æ‰§è¡Œ
        // const title4 = findTitleByDomParsing(decodedHtml, suffix);
        // if (title4) return title4;
        
        return '';
    }

    /**
     * æŠŠ self.__next_f.push([1,"..."]) é‡Œçš„å­—ç¬¦ä¸²è§£ç æ‹¼æ¥ï¼Œå¾—åˆ°å¯è§£ææ–‡æœ¬
     * @param {string} html - åŸå§‹ HTML
     * @returns {string} è§£ç åçš„æ–‡æœ¬
     */
    function extractDecodedPayload(html) {
        let output = '';
        const pushPattern = /self\.__next_f\.push\(\[\d+\s*,\s*(["'])([\s\S]*?)\1\]\)/g;
        let match;
        
        while ((match = pushPattern.exec(html))) {
            try {
                // åˆ©ç”¨ JSON.parse è§£ç è½¬ä¹‰åºåˆ—
                const escapedString = match[2].replace(/\\"/g, '\\"');
                output += JSON.parse('"' + escapedString + '"');
            } catch (error) {
                // é€€åŒ–å¤„ç†å¸¸è§è½¬ä¹‰
                output += match[2]
                    .replace(/\\n/g, '\n')
                    .replace(/\\t/g, '\t')
                    .replace(/\\"/g, '"');
            }
            output += '\n';
        }
        
        // å¦‚æœæ²¡æŠ“åˆ° push ç‰‡æ®µï¼Œå°±ç›´æ¥ç”¨åŸ html
        return output || html;
    }

    /**
     * æ¸…ç† JSON å­—ç¬¦ä¸²ä¸­çš„æ— æ•ˆæ§åˆ¶å­—ç¬¦
     * åªæ¸…ç†å­—ç¬¦ä¸²å€¼ä¸­çš„æ§åˆ¶å­—ç¬¦ï¼Œä¸å½±å“ JSON ç»“æ„
     * @param {string} jsonString - åŸå§‹ JSON å­—ç¬¦ä¸²
     * @returns {string} æ¸…ç†åçš„ JSON å­—ç¬¦ä¸²
     */
    function sanitizeJsonString(jsonString) {
        // åŒ¹é…å­—ç¬¦ä¸²å€¼ï¼ˆåœ¨å¼•å·å†…çš„å†…å®¹ï¼‰ï¼ŒåŒ…æ‹¬è½¬ä¹‰åºåˆ—
        return jsonString.replace(/"([^"\\]|\\.)*"/g, (match) => {
            // æå–å­—ç¬¦ä¸²å†…å®¹ï¼ˆå»æ‰å¼•å·ï¼‰
            let content = match.slice(1, -1);
            let result = '';
            let i = 0;
            
            while (i < content.length) {
                const char = content[i];
                const code = char.charCodeAt(0);
                
                // å¦‚æœæ˜¯è½¬ä¹‰åºåˆ—ï¼Œä¿ç•™åŸæ ·
                if (char === '\\' && i + 1 < content.length) {
                    result += char + content[i + 1];
                    i += 2;
                    continue;
                }
                
                // å¦‚æœæ˜¯æ§åˆ¶å­—ç¬¦ï¼ˆ0x00-0x1Fï¼‰ï¼Œè½¬ä¹‰å®ƒ
                if (code >= 0x00 && code <= 0x1F) {
                    // å¸¸è§å­—ç¬¦ä½¿ç”¨ç®€å†™å½¢å¼
                    if (code === 0x0A) { // \n
                        result += '\\n';
                    } else if (code === 0x0D) { // \r
                        result += '\\r';
                    } else if (code === 0x09) { // \t
                        result += '\\t';
                    } else {
                        // å…¶ä»–æ§åˆ¶å­—ç¬¦ä½¿ç”¨ Unicode è½¬ä¹‰
                        result += '\\u' + ('0000' + code.toString(16)).slice(-4);
                    }
                } else {
                    result += char;
                }
                i++;
            }
            
            return '"' + result + '"';
        });
    }

    /**
     * æ„å»º label -> å¯¹è±¡/æ•°ç»„ çš„ç´¢å¼•ï¼ˆå…¨é¡µï¼‰
     * @param {string} html - HTML æ–‡æœ¬
     * @returns {Object} åŒ…å« objects å’Œ arrays ä¸¤ä¸ª Map çš„å¯¹è±¡
     */
    function buildLabelIndex(html) {
        const objects = new Map();
        const arrays = new Map();
        const objRe = /([A-Za-z0-9_]+)\s*:\s*\{([\s\S]*?)\}\s*(?=\n|\r|\]|,|<|$)/g;
        let objMatch;
        while ((objMatch = objRe.exec(html))) {
            const label = objMatch[1];
            let raw = '{' + objMatch[2].replace(/,\s*\}/g, '}') + '}';
            
            try {
                // å…ˆå°è¯•ç›´æ¥è§£æ
                const parsedObject = JSON.parse(raw);
                objects.set(label, parsedObject);
            } catch (error) {
                // å¦‚æœå¤±è´¥ï¼Œå°è¯•æ¸…ç†æ§åˆ¶å­—ç¬¦åå†è§£æ
                try {
                    raw = sanitizeJsonString(raw);
                    const parsedObject = JSON.parse(raw);
                    objects.set(label, parsedObject);
                } catch (secondError) {
                    // å¦‚æœä»ç„¶å¤±è´¥ï¼Œé™é»˜è·³è¿‡ï¼ˆè¿™äº›å¯èƒ½æ˜¯éå…³é”®æ•°æ®ï¼‰
                    // ä¸è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œé¿å…æ§åˆ¶å°è¢«å¤§é‡é”™è¯¯ä¿¡æ¯æ·¹æ²¡
                    // è¿™äº›å¤±è´¥çš„è§£æé€šå¸¸ä¸å½±å“æœ€ç»ˆç»“æœ
                }
            }
        }
        
        const arrRe = /([A-Za-z0-9_]+)\s*:\s*\[([\s\S]*?)\]\s*(?=\n|\r|\}|,|<|$)/g;
        let arrMatch;
        while ((arrMatch = arrRe.exec(html))) {
            const label = arrMatch[1];
            const body = arrMatch[2];
            const items = [];
            const itemRe = /"\$?([A-Za-z0-9_]+)"/g;
            let itemMatch;
            while ((itemMatch = itemRe.exec(body))) {
                items.push(itemMatch[1]);
            }
            arrays.set(label, items);
        }
        return {objects, arrays};
    }

    /**
     * è§£å¼•ç”¨ notices/scheduleNotices/scheduleNoticeShare -> èˆ¹æœŸå¯¹è±¡æ•°ç»„
     * @param {Object} labelIndex - æ ‡ç­¾ç´¢å¼•å¯¹è±¡
     * @param {string} label - æ ‡ç­¾å
     * @returns {Array} èˆ¹æœŸå¯¹è±¡æ•°ç»„
     */
    function derefList(labelIndex, label) {
        if (!label) return [];
        const key = String(label).replace(/^\$/, '');
        const labelArray = labelIndex.arrays.get(key) || [];
        const out = [];
        for (const labelItem of labelArray) {
            const vesselObject = labelIndex.objects.get(labelItem);
            if (vesselObject && (vesselObject.vslName || vesselObject.voyNo)) {
                out.push(vesselObject);
            }
        }
        return out;
    }

    /**
     * ä»DOMä¸­æå–å¯è§çš„èˆ¹æœŸæ•°æ®ï¼Œç”¨äºéªŒè¯JSONæå–çš„æ•°æ®æ˜¯å¦çœŸå®å­˜åœ¨
     * ä¼˜åŒ–ï¼šå‡å°‘DOMæŸ¥è¯¢æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½
     * @param {string} html - HTML æ–‡æœ¬
     * @returns {Map} é”®ä¸º "fleetId_fleetIdPort_vesselName_voyage"ï¼Œå€¼ä¸ºåŒ…å«è®¡åˆ’å¼€èˆªã€ç›®çš„æ¸¯ç å¤´ç­‰ä¿¡æ¯çš„å¯¹è±¡
     */
    function extractVisibleScheduleData(html) {
        const visibleData = new Map();
        try {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            // ä¼˜åŒ–ï¼šåªæŸ¥æ‰¾åŒ…å«ç‰¹å®šæ¨¡å¼çš„é“¾æ¥ï¼Œå‡å°‘æŸ¥è¯¢èŒƒå›´
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åœ¨HTMLæ–‡æœ¬ä¸­å¿«é€Ÿå®šä½ï¼Œè€Œä¸æ˜¯éå†æ‰€æœ‰é“¾æ¥
            const hrefPattern = /href=["']([^"']*_(\d+)_(\d+)[^"']*)["']/gi;
            const hrefMatches = [];
            let match;
            while ((match = hrefPattern.exec(html)) !== null) {
                const href = match[1];
                const fleetId = match[2];
                const fleetIdPort = match[3];
                // è·³è¿‡æ— æ•ˆçš„æ¸¯å£ID
                if (fleetIdPort === '0' || fleetIdPort === '1') continue;
                hrefMatches.push({ href, fleetId, fleetIdPort, index: match.index });
            }
            
            // ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ï¼Œå‡å°‘DOMæ“ä½œ
            for (const { href, fleetId, fleetIdPort } of hrefMatches) {
                // åªæŸ¥è¯¢åŒ…å«è¿™ä¸ªhrefçš„é“¾æ¥
                const link = doc.querySelector(`a[href="${href.replace(/"/g, '\\"')}"]`);
                if (!link) continue;
                
                // å°è¯•ä»é“¾æ¥çš„titleæˆ–å‘¨å›´æ–‡æœ¬ä¸­æå–èˆ¹åèˆªæ¬¡
                const title = link.getAttribute('title') || '';
                const linkText = (link.textContent || '').trim();
                
                // ä¼˜åŒ–ï¼šé™åˆ¶å‘ä¸ŠæŸ¥æ‰¾çš„æ·±åº¦ï¼Œå‡å°‘DOMéå†
                let planDate = '';
                let etaDate = '';
                let podWharf = '';
                
                // å‘ä¸ŠæŸ¥æ‰¾åŒ…å«æ—¥æœŸçš„çˆ¶å…ƒç´ ï¼ˆé™åˆ¶æ·±åº¦ä¸º6å±‚ï¼Œå…¼é¡¾æ›´å¤šåœºæ™¯ï¼‰
                let parent = link.parentElement;
                let searchDepth = 0;
                while (parent && searchDepth < 6) {
                    const parentText = (parent.textContent || '').trim();
                    // åŒ¹é…æ—¥æœŸæ ¼å¼ YYYY/MM/DDï¼ˆå–å‰ä¸¤ä¸ªï¼šç¬¬ä¸€ä¸ªè®¡åˆ’å¼€èˆªï¼Œç¬¬äºŒä¸ªé¢„è®¡åˆ°æ¸¯ï¼‰
                    const dateMatches = parentText.match(/(\d{4}\/\d{2}\/\d{2})/g);
                    if (dateMatches && dateMatches.length > 0) {
                        if (!planDate) planDate = dateMatches[0];
                        if (dateMatches.length > 1 && !etaDate) etaDate = dateMatches[1];
                    }
                    // æŸ¥æ‰¾ç›®çš„æ¸¯ç å¤´ï¼ˆé™åˆ¶æŸ¥è¯¢èŒƒå›´ï¼‰
                    if (!podWharf) {
                        const wharfEl = parent.querySelector('[class*="wharf"], [class*="terminal"]');
                        if (wharfEl) {
                            podWharf = (wharfEl.textContent || '').trim();
                        }
                    }
                    // å¦‚æœéƒ½æ‰¾åˆ°äº†ï¼Œæå‰é€€å‡º
                    if (planDate && podWharf) break;
                    parent = parent.parentElement;
                    searchDepth++;
                }
                
                // å¦‚æœä»ç„¶ç¼ºå¤±ï¼Œä»ç›¸åŒ fleetId/port çš„å…¶ä»–å…ƒç´ è¡¥å……
                if (!planDate || !podWharf || !etaDate) {
                    const relatedElements = Array.from(doc.querySelectorAll(`[href*="_${fleetId}_${fleetIdPort}"], [data-fleet-id="${fleetId}"][data-port-id="${fleetIdPort}"]`));
                    for (const el of relatedElements) {
                        const elText = (el.textContent || '').trim();
                        if (!planDate || !etaDate) {
                            const dateMatches = elText.match(/(\d{4}\/\d{2}\/\d{2})/g);
                            if (dateMatches && dateMatches.length > 0) {
                                if (!planDate) planDate = dateMatches[0];
                                if (dateMatches.length > 1 && !etaDate) etaDate = dateMatches[1];
                            }
                        }
                        if (!podWharf) {
                            const wharfMatch = elText.match(/([A-Z]{2,}\s*[A-Z]*\s*TERMINAL|[A-Z]{2,}\s*TERMINAL|[A-Z]{2,}\s*CT|[A-Z]{2,}\s*PORT)/i);
                            if (wharfMatch) podWharf = wharfMatch[1];
                        }
                        if (planDate && podWharf && etaDate) break;
                    }
                }
                
                // æå–èˆ¹åèˆªæ¬¡ï¼ˆä»titleæˆ–æ–‡æœ¬ä¸­ï¼‰
                let vesselName = '';
                let voyage = '';
                if (title) {
                    const vesselMatch = title.match(/([A-Z\s]+)\s*\/\s*([A-Z0-9]+)/);
                    if (vesselMatch) {
                        vesselName = clean(vesselMatch[1]);
                        voyage = clean(vesselMatch[2]);
                    }
                }
                if (!vesselName && linkText) {
                    const vesselMatch = linkText.match(/([A-Z\s]+)\s*\/\s*([A-Z0-9]+)/);
                    if (vesselMatch) {
                        vesselName = clean(vesselMatch[1]);
                        voyage = clean(vesselMatch[2]);
                    }
                }
                
                if (fleetId && fleetIdPort && (vesselName || voyage)) {
                    const key = `${fleetId}_${fleetIdPort}_${vesselName || ''}_${voyage || ''}`;
                    // ä¼˜åŒ–ï¼šé¿å…é‡å¤è®¾ç½®ç›¸åŒçš„key
                    if (!visibleData.has(key)) {
                        visibleData.set(key, {
                            fleetId,
                            fleetIdPort,
                            vesselName,
                            voyage,
                            planDate: clean(planDate),
                            etaDate: clean(etaDate),
                            podWharf: clean(podWharf)
                        });
                    }
                }
            }
        } catch (error) {
            // DOMè§£æå¤±è´¥ï¼Œé™é»˜è¿”å›ç©ºMap
        }
        return visibleData;
    }

    /**
     * éªŒè¯æ•°æ®æ˜¯å¦åœ¨DOMä¸­å¯è§
     * @param {string} fleetId - èˆªçº¿ID
     * @param {string} fleetIdPort - æ¸¯å£ID
     * @param {string} vesselName - èˆ¹å
     * @param {string} voyage - èˆªæ¬¡
     * @param {Map} visibleData - å¯è§æ•°æ®Map
     * @returns {boolean} æ˜¯å¦å¯è§
     */
    function isDataVisible(fleetId, fleetIdPort, vesselName, voyage, visibleData) {
        if (!fleetId || !fleetIdPort || fleetIdPort === '0' || fleetIdPort === '1') {
            return false; // æ— æ•ˆçš„æ¸¯å£IDè§†ä¸ºä¸å¯è§
        }
        
        const key1 = `${fleetId}_${fleetIdPort}_${vesselName || ''}_${voyage || ''}`;
        const key2 = `${fleetId}_${fleetIdPort}_${clean(vesselName || '')}_${clean(voyage || '')}`;
        const key3 = `${fleetId}_${fleetIdPort}_${(vesselName || '').toUpperCase()}_${(voyage || '').toUpperCase()}`;
        
        return visibleData.has(key1) || visibleData.has(key2) || visibleData.has(key3);
    }

    /**
     * ä»æ•´é¡µæå–"fleetå— + å¯¹åº”èˆ¹æœŸ"å¯¹
     * @param {string} html - HTML æ–‡æœ¬
     * @param {Object} labelIndex - æ ‡ç­¾ç´¢å¼•å¯¹è±¡
     * @param {Map} visibleData - å¯è§æ•°æ®Mapï¼ˆç”¨äºéªŒè¯ï¼‰
     * @returns {Array} fleet å¯¹è±¡æ•°ç»„
     */
    function extractFleetAndVessels(html, labelIndex, visibleData = new Map()) {
        const fleets = [];
        // æ”¹è¿›æ­£åˆ™ï¼šæ›´ä¸¥æ ¼åœ°åŒ¹é…fleetå¯¹è±¡ï¼Œç¡®ä¿fleetIdPortä¸fleetIdåœ¨åŒä¸€å¯¹è±¡ä¸­
        // ä½¿ç”¨éè´ªå©ªåŒ¹é…ï¼Œé¿å…è·¨å¯¹è±¡åŒ¹é…
        const fleetPattern = /\{[^{}]*?"fleetId"\s*:\s*(\d+)[^{}]*?"fleetIdPort"\s*:\s*(\d+)[^{}]*?\}/g;
        let fleetMatch;
        
        while ((fleetMatch = fleetPattern.exec(html))) {
            const segment = fleetMatch[0];
            const fleetId = fleetMatch[1];
            // æ¸¯å£IDï¼šä¸¥æ ¼ä»åŒä¸€å¯¹è±¡ä¸­æå–ï¼Œé¿å…åŒ¹é…åˆ°é”™è¯¯çš„ç‰‡æ®µ
            let fleetIdPort = fleetMatch[2];
            
            // éªŒè¯ï¼šå¦‚æœfleetIdPortæ˜¯0æˆ–1ï¼Œå°è¯•ä»segmentä¸­æŸ¥æ‰¾æ›´å‡†ç¡®çš„æ¸¯å£ID
            if (fleetIdPort === '0' || fleetIdPort === '1') {
                // åœ¨segmentä¸­æŸ¥æ‰¾æ‰€æœ‰fleetIdPortå€¼ï¼Œé€‰æ‹©é0é1çš„æœ€å¤§å€¼
                const allPortIds = segment.match(/"fleetIdPort"\s*:\s*(\d+)/g);
                if (allPortIds) {
                    const validPortIds = allPortIds
                        .map(m => m.match(/(\d+)/)[1])
                        .filter(id => id !== '0' && id !== '1')
                        .map(id => parseInt(id, 10))
                        .filter(id => id > 1);
                    if (validPortIds.length > 0) {
                        fleetIdPort = String(Math.max(...validPortIds));
                    }
                }
            }
            
            // å¦‚æœä»ç„¶æ˜¯æ— æ•ˆå€¼ï¼Œè·³è¿‡è¿™ä¸ªfleet
            if (fleetIdPort === '0' || fleetIdPort === '1') {
                continue;
            }
            
            const carrierMatch = /("carrierShortName"\s*:\s*"([^"]*)")/.exec(segment);
            const carrierShortName = carrierMatch ? carrierMatch[2] : '';
            const svcCodeMatch = /("svcCode"\s*:\s*"([^"]*)")/.exec(segment);
            const svcCode = svcCodeMatch ? svcCodeMatch[2] : '';
            
            // å¼€èˆªæ—¥ï¼šå°è¯•å¤šä¸ªå­—æ®µ
            let weekday = (/("weekdayOfETDFormatter"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            if (!weekday) {
                weekday = (/("weekday"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            }
            if (!weekday) {
                weekday = (/("etdWeekday"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            }
            
            // èˆªç¨‹ï¼šå°è¯•å¤šä¸ªå­—æ®µå’Œæ ¼å¼ï¼ˆå¢å¼ºæå–é€»è¾‘ï¼‰
            let shipdays = (/("shipdays"\s*:\s*(\d+))/.exec(segment) || [])[2] || '';
            if (!shipdays) {
                shipdays = (/("shipDays"\s*:\s*(\d+))/.exec(segment) || [])[2] || '';
            }
            if (!shipdays) {
                shipdays = (/("duration"\s*:\s*(\d+))/.exec(segment) || [])[2] || '';
            }
            if (!shipdays) {
                shipdays = (/("transitTime"\s*:\s*(\d+))/.exec(segment) || [])[2] || '';
            }
            if (!shipdays) {
                shipdays = (/("transitDays"\s*:\s*(\d+))/.exec(segment) || [])[2] || '';
            }
            // å°è¯•å­—ç¬¦ä¸²æ ¼å¼
            if (!shipdays) {
                const shipdaysStr = (/("shipdays"\s*:\s*"(\d+)")/.exec(segment) || [])[2] || '';
                if (shipdaysStr) shipdays = shipdaysStr;
            }
            if (!shipdays) {
                const shipdaysStr = (/("shipDays"\s*:\s*"(\d+)")/.exec(segment) || [])[2] || '';
                if (shipdaysStr) shipdays = shipdaysStr;
            }
            if (!shipdays) {
                const shipdaysStr = (/("duration"\s*:\s*"(\d+)")/.exec(segment) || [])[2] || '';
                if (shipdaysStr) shipdays = shipdaysStr;
            }
            
            // å¯è¿æ¸¯ç å¤´ï¼šåŒæ—¶æå–ç®€å†™å’Œå…¨ç§°ï¼ˆå¢å¼ºæå–é€»è¾‘ï¼‰
            let polWharfShort = (/("startPortWharfEnShortName"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            let polWharfFull = (/("startPortWharfEnFullName"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            // å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°è¯•å…¶ä»–å­—æ®µ
            if (!polWharfShort && !polWharfFull) {
                polWharfShort = (/("wharfName"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            }
            if (!polWharfShort && !polWharfFull) {
                polWharfFull = (/("polWharf"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            }
            if (!polWharfShort && !polWharfFull) {
                polWharfFull = (/("startPortTerminal"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            }
            // ç»„åˆï¼šå¦‚æœæœ‰ç®€å†™å’Œå…¨ç§°ï¼Œç”¨/åˆ†éš”ï¼›å¦åˆ™ä½¿ç”¨å…¶ä¸­ä¸€ä¸ª
            let polWharf = '';
            if (polWharfShort && polWharfFull) {
                polWharf = `${polWharfShort}/${polWharfFull}`;
            } else if (polWharfShort) {
                polWharf = polWharfShort;
            } else if (polWharfFull) {
                polWharf = polWharfFull;
            }
            
            // ç›®çš„æ¸¯ç å¤´ï¼šåŒæ—¶æå–ç¼©å†™å’Œå…¨ç§°ï¼ˆå¢å¼ºæå–é€»è¾‘ï¼‰
            // ä¼˜å…ˆä»æ•´ä¸ªsegmentä¸­æœç´¢ï¼Œç¡®ä¿ä¸é—æ¼
            let podShort = (/("destPortWharfEnShortName"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            let podFull = (/("destPortWharfEnFullName"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            // å¦‚æœåªæœ‰å…¶ä¸­ä¸€ä¸ªï¼Œå°è¯•å…¶ä»–å­—æ®µ
            if (!podShort && !podFull) {
                podShort = (/("podWharf"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            }
            if (!podShort && !podFull) {
                podFull = (/("destPortTerminal"\s*:\s*"([^"]*)")/.exec(segment) || [])[2] || '';
            }
            
            // åº”ç”¨ç å¤´åè§„èŒƒåŒ–
            polWharf = normalizeWharfTokens(polWharf);
            podShort = normalizeWharfTokens(podShort);
            podFull = normalizeWharfTokens(podFull);
            
            const startPortEnMatch = /("startPortEnName"\s*:\s*"([^"]*)")/.exec(segment);
            const startPortCnMatch = /("startPortCnName"\s*:\s*"([^"]*)")/.exec(segment);
            const destPortEnMatch = /("destPortEnName"\s*:\s*"([^"]*)")/.exec(segment);
            const destPortCnMatch = /("destPortCnName"\s*:\s*"([^"]*)")/.exec(segment);
            const scheduleNoticesMatch = /("scheduleNotices"\s*:\s*"\$?([A-Za-z0-9_]+)")/.exec(segment);
            const label1 = scheduleNoticesMatch ? scheduleNoticesMatch[2] : '';
            const noticesMatch = /("notices"\s*:\s*"\$?([A-Za-z0-9_]+)")/.exec(segment);
            const label2 = noticesMatch ? noticesMatch[2] : '';
            const scheduleNoticeShareMatch = /("scheduleNoticeShare"\s*:\s*"\$?([A-Za-z0-9_]+)")/.exec(segment);
            const label3 = scheduleNoticeShareMatch ? scheduleNoticeShareMatch[2] : '';

            let vessels = [];
            vessels = derefList(labelIndex, label1);
            if (!vessels.length) vessels = derefList(labelIndex, label2);
            if (!vessels.length) vessels = derefList(labelIndex, label3);

            const origin = startPortEnMatch && startPortCnMatch
                ? `${startPortEnMatch[2]}(${startPortCnMatch[2]})`
                : '';
            const dest = destPortEnMatch && destPortCnMatch
                ? `${destPortEnMatch[2]}(${destPortCnMatch[2]})`
                : '';
            fleets.push({
                fleetId,
                fleetIdPort,
                carrierShortName,
                svcCode,
                weekday,
                shipdays,
                polWharf,
                podShort,
                podFull,
                origin,
                dest,
                vessels
            });
        }
        return fleets;
    }

    /**
     * æå–å¯è¿æ¸¯å’Œç›®çš„æ¸¯
     * ä¼˜å…ˆï¼šåœ¨ä»»æ„å¯¹è±¡ç‰‡æ®µä¸­æŸ¥æ‰¾ start/dest å››ä¸ªå­—æ®µï¼ˆé€‚é… fc:{...} ç»“æ„ï¼‰
     * æ¬¡çº§ï¼šDOM ä¸Šæ–¹æç¤ºæ¡
     * å…œåº•ï¼šæ­£åˆ™åŒ¹é…"ç”±...å‘å¾€..."
     * @param {string} html - HTML æ–‡æœ¬
     * @returns {Object} åŒ…å« origin å’Œ dest çš„å¯¹è±¡
     */
    function extractOriginDest(html) {
        const jsonMatch = html.match(/"startPortEnName"\s*:\s*"([^"]+)"[\s\S]*?"startPortCnName"\s*:\s*"([^"]+)"[\s\S]*?"destPortEnName"\s*:\s*"([^"]+)"[\s\S]*?"destPortCnName"\s*:\s*"([^"]+)"/);
        if (jsonMatch) {
            const origin = `${jsonMatch[1]}(${jsonMatch[2]})`;
            const dest = `${jsonMatch[3]}(${jsonMatch[4]})`;
            return { origin, dest };
        }
        try {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const bar = doc.querySelector('span.flex.items-center.text-\\[12px\\]');
            if (bar) {
                const strongs = Array.from(bar.querySelectorAll('span.font-bold'));
                const originText = strongs[0] ? (strongs[0].textContent || '').trim() : '';
                const destText = strongs[1] ? (strongs[1].textContent || '').trim() : '';
                if (originText && destText) {
                    return { origin: originText, dest: destText };
                }
            }
        } catch (error) {
            // DOM è§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
        }
        const textMatchPattern = new RegExp(
            '>\\s*([A-Z][A-Z\\s]+)<!-- -->\\(<!-- -->([\\u4e00-\\u9fa5]+)<!-- -->\\)</span>å‘å¾€</span[^>]*>\\s*([A-Z][A-Z\\s]+)<!-- -->\\(<!-- -->([\\u4e00-\\u9fa5]+)<!-- -->\\)\\s*</span>'
        );
        const textMatch = html.match(textMatchPattern);
        if (textMatch) {
            return {
                origin: `${textMatch[1].trim()}(${textMatch[2]})`,
                dest: `${textMatch[3].trim()}(${textMatch[4]})`
            };
        }
        return { origin: '', dest: '' };
    }

    /**
     * ä»å­—ç¬¦ä¸²ä¸­æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY/MM/DD æ ¼å¼ï¼‰
     * @param {string} dateString - åŒ…å«æ—¥æœŸçš„å­—ç¬¦ä¸²
     * @returns {string} æå–çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
     */
    function datePart(dateString) {
        if (!dateString) return '';
        const dateMatch = String(dateString).match(/(\d{4}\/\d{2}\/\d{2})/);
        return dateMatch ? dateMatch[1] : '';
    }

    /**
     * ä»å¯¹è±¡ä¸­æå–èˆ¹åï¼ˆå°è¯•å¤šä¸ªå­—æ®µåï¼‰
     * @param {Object} obj - å¯¹è±¡
     * @returns {string} èˆ¹å
     */
    function extractVesselName(obj) {
        if (!obj) return '';
        return obj.vslName 
            || obj.vesselName 
            || obj.vslNameEn 
            || obj.vesselNameEn
            || obj.shipName
            || obj.name
            || '';
    }

    /**
     * ä»å¯¹è±¡ä¸­æå–èˆªæ¬¡ï¼ˆå°è¯•å¤šä¸ªå­—æ®µåï¼‰
     * @param {Object} obj - å¯¹è±¡
     * @returns {string} èˆªæ¬¡
     */
    function extractVoyage(obj) {
        if (!obj) return '';
        return obj.voyNo 
            || obj.voyageNo 
            || obj.voyNoEn
            || obj.voyage
            || obj.voy
            || '';
    }

    /**
     * ä»å¯¹è±¡ä¸­æå–è®¡åˆ’å¼€èˆªæ—¥æœŸï¼ˆå°è¯•å¤šä¸ªå­—æ®µåå’Œæ ¼å¼ï¼‰
     * @param {Object} obj - å¯¹è±¡
     * @returns {string} è®¡åˆ’å¼€èˆªæ—¥æœŸï¼ˆYYYY/MM/DDæ ¼å¼ï¼‰
     */
    function extractPlanDate(obj) {
        if (!obj) return '';
        // å°è¯•å¤šä¸ªå­—æ®µå
        const dateStr = obj.etdFormatter 
            || obj.portSailingDateFormatter
            || obj.etd
            || obj.sailingDate
            || obj.portSailingDate
            || obj.etdDate
            || obj.planDate
            || obj.planEtd
            || '';
        return datePart(dateStr);
    }

    /**
     * ä»å¯¹è±¡ä¸­æå–é¢„è®¡åˆ°æ¸¯æ—¥æœŸï¼ˆå°è¯•å¤šä¸ªå­—æ®µåå’Œæ ¼å¼ï¼‰
     * @param {Object} obj - å¯¹è±¡
     * @returns {string} é¢„è®¡åˆ°æ¸¯æ—¥æœŸï¼ˆYYYY/MM/DDæ ¼å¼ï¼‰
     */
    function extractEtaDate(obj) {
        if (!obj) return '';
        // å°è¯•å¤šä¸ªå­—æ®µå
        const dateStr = obj.etaFormatter 
            || obj.eta
            || obj.etaDate
            || obj.estimatedArrivalDate
            || obj.arrivalDate
            || '';
        return datePart(dateStr);
    }

    /**
     * ä»HTMLæ–‡æœ¬ä¸­è¡¥å……ç¼ºå¤±çš„èˆ¹åã€èˆªæ¬¡ã€æ—¥æœŸç­‰ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
     * @param {string} decodedHtml - è§£ç åçš„HTMLæ–‡æœ¬
     * @param {string} lineId - èˆªçº¿ID
     * @param {string} portId - æ¸¯å£ID
     * @param {Object} missingData - ç¼ºå¤±çš„æ•°æ®å¯¹è±¡ {vesselName, voyage, plan, eta, weekday, shipdays, polWharf, podWharf}
     * @param {Map} visibleData - å¯è§æ•°æ®Mapï¼ˆå¯é€‰ï¼‰
     * @returns {Object} è¡¥å……åçš„æ•°æ®å¯¹è±¡
     */
    function supplementMissingData(decodedHtml, lineId, portId, missingData, visibleData = null) {
        const result = {...missingData};
        
        // ä¼˜å…ˆä»å¯è§æ•°æ®ä¸­æå–è®¡åˆ’å¼€èˆª/é¢„è®¡åˆ°æ¸¯/ç›®çš„æ¸¯ç å¤´
        if (visibleData && visibleData.size > 0 && (missingData.vesselName || missingData.voyage)) {
            const visibleKey = `${lineId}_${portId}_${missingData.vesselName || ''}_${missingData.voyage || ''}`;
            const visibleInfo = visibleData.get(visibleKey) || 
                              visibleData.get(`${lineId}_${portId}_${clean(missingData.vesselName || '')}_${clean(missingData.voyage || '')}`) ||
                              visibleData.get(`${lineId}_${portId}_${(missingData.vesselName || '').toUpperCase()}_${(missingData.voyage || '').toUpperCase()}`);
            
            if (visibleInfo) {
                if (!result.plan && visibleInfo.planDate) {
                    result.plan = visibleInfo.planDate;
                }
                if (!result.eta && visibleInfo.etaDate) {
                    result.eta = visibleInfo.etaDate;
                }
                if (!result.podWharf && visibleInfo.podWharf) {
                    result.podWharf = visibleInfo.podWharf;
                }
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å…³é”®æ•°æ®éƒ½å·²å­˜åœ¨ï¼ˆå…è®¸éƒ¨åˆ†å­—æ®µä¸ºç©ºï¼‰
        const hasAllCritical = result.vesselName && result.voyage && result.plan && result.eta;
        if (hasAllCritical && result.weekday && result.shipdays && result.podWharf) {
            return result;
        }

        // ä¼˜åŒ–ï¼šåªåœ¨éœ€è¦æ—¶æ‰æœç´¢ï¼Œå‡å°‘æœç´¢èŒƒå›´
        // å°è¯•ä»åŒ…å«èˆªçº¿IDå’Œæ¸¯å£IDçš„ä¸Šä¸‹æ–‡ä¸­æå–ï¼ˆç¼©å°æœç´¢èŒƒå›´ï¼Œå¢å¼ºåŒ¹é…ç²¾åº¦ï¼‰
        // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ¨¡å¼ï¼Œç¡®ä¿fleetIdå’ŒfleetIdPortåœ¨åŒä¸€fleetå—ä¸­
        const contextPattern = new RegExp(
            `"fleetId"\\s*:\\s*${lineId}[\\s\\S]{0,500}"fleetIdPort"\\s*:\\s*${portId}[\\s\\S]{0,10000}`,
            'i'
        );
        const contextMatch = decodedHtml.match(contextPattern);
        let context = null;
        if (contextMatch) {
            let candidateContext = contextMatch[0];
            
            // éªŒè¯ï¼šç¡®ä¿contextä¸­åŒ…å«æ­£ç¡®çš„fleetIdå’ŒfleetIdPort
            const contextFleetIdMatch = candidateContext.match(/"fleetId"\s*:\s*(\d+)/i);
            const contextFleetIdPortMatch = candidateContext.match(/"fleetIdPort"\s*:\s*(\d+)/i);
            if (contextFleetIdMatch && contextFleetIdPortMatch) {
                const contextFleetId = contextFleetIdMatch[1];
                const contextFleetIdPort = contextFleetIdPortMatch[1];
                // å¦‚æœfleetIdå’ŒfleetIdPortåŒ¹é…ï¼Œä½¿ç”¨è¿™ä¸ªcontext
                if (contextFleetId === lineId && contextFleetIdPort === portId) {
                    context = candidateContext;
                } else {
                    // å¦‚æœä¸åŒ¹é…ï¼Œå°è¯•æŸ¥æ‰¾æ­£ç¡®çš„fleetå—
                    const correctFleetPattern = new RegExp(
                        `"fleetId"\\s*:\\s*${lineId}[\\s\\S]{0,500}"fleetIdPort"\\s*:\\s*${portId}[\\s\\S]{0,10000}(?="fleetId"|$)`,
                        'i'
                    );
                    const correctFleetMatch = decodedHtml.match(correctFleetPattern);
                    if (correctFleetMatch) {
                        context = correctFleetMatch[0];
                    }
                }
            } else {
                context = candidateContext;
            }
        }
        
        if (context) {
            
            // ä¸€æ¬¡æ€§åŒ¹é…æ‰€æœ‰éœ€è¦çš„å­—æ®µï¼Œå‡å°‘å¾ªç¯æ¬¡æ•°
            if (!result.vesselName) {
                const match = context.match(/"vslName"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"vesselName"\s*:\s*"([^"]+)"/i);
                if (match && match[1]) {
                    result.vesselName = clean(match[1]);
                }
            }
            
            if (!result.voyage) {
                const match = context.match(/"voyNo"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"voyageNo"\s*:\s*"([^"]+)"/i);
                if (match && match[1]) {
                    result.voyage = clean(match[1]);
                }
            }
            
            if (!result.plan) {
                // å¢å¼ºè®¡åˆ’å¼€èˆªæå–ï¼šå°è¯•æ›´å¤šå­—æ®µ
                const match = context.match(/"etdFormatter"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"portSailingDateFormatter"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"etd"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"sailingDate"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"portSailingDate"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"etdDate"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"planDate"\s*:\s*"([^"]+)"/i);
                if (match && match[1]) {
                    result.plan = datePart(match[1]);
                }
            }
            
            if (!result.eta) {
                // å¢å¼ºé¢„è®¡åˆ°æ¸¯æå–ï¼šå°è¯•æ›´å¤šå­—æ®µ
                const match = context.match(/"etaFormatter"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"eta"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"etaDate"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"estimatedArrivalDate"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"arrivalDate"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"ataFormatter"\s*:\s*"([^"]+)"/i);
                if (match && match[1]) {
                    result.eta = datePart(match[1]);
                }
            }
            
            // è¡¥å……å¼€èˆªæ—¥ï¼ˆweekdayï¼‰- å¢å¼ºæå–é€»è¾‘ï¼Œå°è¯•æ›´å¤šå­—æ®µ
            if (!result.weekday) {
                const match = context.match(/"weekdayOfETDFormatter"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"weekday"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"etdWeekday"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"weekdayOfETD"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"sailingWeekday"\s*:\s*"([^"]+)"/i) ||
                             context.match(/"departureWeekday"\s*:\s*"([^"]+)"/i);
                if (match && match[1]) {
                    result.weekday = clean(match[1]);
                }
            }
            
            // è¡¥å……èˆªç¨‹ï¼ˆshipdaysï¼‰- å¢å¼ºæå–é€»è¾‘
            if (!result.shipdays) {
                const match = context.match(/"shipdays"\s*:\s*(\d+)/i) ||
                             context.match(/"shipDays"\s*:\s*(\d+)/i) ||
                             context.match(/"duration"\s*:\s*(\d+)/i) ||
                             context.match(/"transitTime"\s*:\s*(\d+)/i) ||
                             context.match(/"transitDays"\s*:\s*(\d+)/i) ||
                             context.match(/"shipdays"\s*:\s*"(\d+)"/i) ||
                             context.match(/"shipDays"\s*:\s*"(\d+)"/i) ||
                             context.match(/"duration"\s*:\s*"(\d+)"/i);
                if (match && match[1]) {
                    result.shipdays = clean(match[1]);
                }
            }
            
            // è¡¥å……èµ·è¿æ¸¯ç å¤´ï¼ˆpolWharfï¼‰- å¢å¼ºæå–é€»è¾‘ï¼ŒåŒæ—¶æå–ç®€å†™å’Œå…¨ç§°
            if (!result.polWharf) {
                const polShortMatch = context.match(/"startPortWharfEnShortName"\s*:\s*"([^"]+)"/i);
                const polFullMatch = context.match(/"startPortWharfEnFullName"\s*:\s*"([^"]+)"/i);
                let polShort = polShortMatch ? clean(polShortMatch[1]) : '';
                let polFull = polFullMatch ? clean(polFullMatch[1]) : '';
                
                // å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°è¯•å…¶ä»–å­—æ®µ
                if (!polShort && !polFull) {
                    const polMatch = context.match(/"wharfName"\s*:\s*"([^"]+)"/i) ||
                                   context.match(/"polWharf"\s*:\s*"([^"]+)"/i) ||
                                   context.match(/"startPortTerminal"\s*:\s*"([^"]+)"/i);
                    if (polMatch && polMatch[1]) {
                        polShort = clean(polMatch[1]);
                    }
                }
                
                // è§„èŒƒåŒ–å¹¶ç»„åˆ
                polShort = normalizeWharfTokens(polShort);
                polFull = normalizeWharfTokens(polFull);
                
                if (polShort && polFull) {
                    result.polWharf = `${polShort}/${polFull}`;
                } else if (polShort) {
                    result.polWharf = polShort;
                } else if (polFull) {
                    result.polWharf = polFull;
                }
            }
            
            // è¡¥å……ç›®çš„æ¸¯ç å¤´ï¼ˆpodWharfï¼‰- å¢å¼ºæå–é€»è¾‘ï¼Œç¡®ä¿åŒæ—¶æå–ç®€å†™å’Œå…¨ç§°
            // æ£€æŸ¥æ˜¯å¦åªæœ‰ç®€å†™ï¼ˆæ²¡æœ‰/åˆ†éš”ç¬¦ä¸”é•¿åº¦è¾ƒçŸ­ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œå°è¯•è¡¥å……å…¨ç§°
            const hasPodWharf = result.podWharf && result.podWharf.trim();
            const podWharfOnlyShort = hasPodWharf && !result.podWharf.includes('/') && result.podWharf.length < 15;
            
            if (!result.podWharf || podWharfOnlyShort) {
                // ä¼˜å…ˆä»æ•´ä¸ªcontextä¸­æœç´¢ï¼Œç¡®ä¿ä¸é—æ¼
                // å°è¯•æå–ç›®çš„æ¸¯ç å¤´çš„ç¼©å†™å’Œå…¨ç§°
                const podShortMatch = context.match(/"destPortWharfEnShortName"\s*:\s*"([^"]+)"/i);
                const podFullMatch = context.match(/"destPortWharfEnFullName"\s*:\s*"([^"]+)"/i);
                let podShort = podShortMatch ? clean(podShortMatch[1]) : '';
                let podFull = podFullMatch ? clean(podFullMatch[1]) : '';
                
                // å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°è¯•å…¶ä»–å­—æ®µ
                if (!podShort && !podFull) {
                    const podMatch = context.match(/"podWharf"\s*:\s*"([^"]+)"/i) ||
                                   context.match(/"destPortTerminal"\s*:\s*"([^"]+)"/i);
                    if (podMatch && podMatch[1]) {
                        podShort = clean(podMatch[1]);
                    }
                }
                
                // è§„èŒƒåŒ–å¹¶ç»„åˆ
                podShort = normalizeWharfTokens(podShort);
                podFull = normalizeWharfTokens(podFull);
                
                // å¦‚æœå·²æœ‰ç®€å†™ï¼Œä¼˜å…ˆä½¿ç”¨å·²æœ‰çš„
                if (podWharfOnlyShort && result.podWharf) {
                    podShort = result.podWharf;
                }
                
                if (podShort && podFull) {
                    result.podWharf = `${podShort}/${podFull}`;
                } else if (podShort) {
                    result.podWharf = podShort;
                } else if (podFull) {
                    result.podWharf = podFull;
                } else if (!result.podWharf && hasPodWharf) {
                    // å¦‚æœè¡¥å……å¤±è´¥ï¼Œä¿ç•™åŸå€¼
                    result.podWharf = result.podWharf;
                }
            }
        }
        
        // å¦‚æœä»ç„¶ç¼ºå¤±ï¼Œè¿›è¡Œå…¨å±€æœç´¢ï¼ˆå¢å¼ºï¼šä¼˜å…ˆæœç´¢åŒ…å«fleetIdå’ŒfleetIdPortçš„vesselå¯¹è±¡ï¼‰
        const needsGlobalSearch = !result.plan || !result.eta || !result.vesselName || !result.voyage;
        if (needsGlobalSearch && decodedHtml) {
            // ç­–ç•¥1ï¼šä¼˜å…ˆæœç´¢åŒ…å«fleetIdå’ŒfleetIdPortçš„vesselå¯¹è±¡ï¼ˆå¢å¼ºï¼šæ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
            if (lineId && portId) {
                // å…ˆæŸ¥æ‰¾åŒ…å«fleetIdå’ŒfleetIdPortçš„å®Œæ•´fleetå—ï¼Œç„¶ååœ¨è¯¥å—ä¸­æŸ¥æ‰¾vesselå¯¹è±¡
                const fleetBlockPattern = new RegExp(
                    `"fleetId"\\s*:\\s*${lineId}[\\s\\S]{0,500}"fleetIdPort"\\s*:\\s*${portId}[\\s\\S]{0,10000}`,
                    'i'
                );
                const fleetBlockMatch = decodedHtml.match(fleetBlockPattern);
                const searchContext = fleetBlockMatch ? fleetBlockMatch[0] : decodedHtml;
                
                // åœ¨fleetå—ä¸­æŸ¥æ‰¾vesselå¯¹è±¡
                const vesselWithFleetPattern = /\{[^{}]*?"(?:vslName|vesselName)"\s*:\s*"[^"]+"[\s\S]{0,2000}?"(?:voyNo|voyageNo)"\s*:\s*"[^"]+"[\s\S]*?\}/g;
                let vesselWithFleetMatch;
                let count1 = 0;
                while ((vesselWithFleetMatch = vesselWithFleetPattern.exec(searchContext)) !== null && count1 < 20) {
                    count1++;
                    try {
                        const objText = vesselWithFleetMatch[0].replace(/,\s*\}/g, '}');
                        const vesselObj = JSON.parse(objText);
                        
                        // éªŒè¯fleetIdå’ŒfleetIdPortæ˜¯å¦åŒ¹é…ï¼ˆå¦‚æœvesselå¯¹è±¡ä¸­æœ‰è¿™äº›å­—æ®µï¼‰
                        if (vesselObj.fleetId && vesselObj.fleetIdPort) {
                            if (vesselObj.fleetId !== lineId || vesselObj.fleetIdPort !== portId) {
                                continue; // ä¸åŒ¹é…ï¼Œè·³è¿‡
                            }
                        }
                        
                        if (!result.vesselName) {
                            const name = extractVesselName(vesselObj);
                            if (name) result.vesselName = clean(name);
                        }
                        if (!result.voyage) {
                            const voy = extractVoyage(vesselObj);
                            if (voy) result.voyage = clean(voy);
                        }
                        if (!result.plan) {
                            const plan = extractPlanDate(vesselObj);
                            if (plan) result.plan = plan;
                        }
                        if (!result.eta) {
                            const eta = extractEtaDate(vesselObj);
                            if (eta) result.eta = eta;
                        }
                        if (!result.weekday) {
                            const weekday = vesselObj.weekdayOfETDFormatter 
                                || vesselObj.weekday 
                                || vesselObj.etdWeekday 
                                || vesselObj.weekdayOfETD
                                || vesselObj.sailingWeekday
                                || vesselObj.departureWeekday
                                || '';
                            if (weekday) result.weekday = clean(weekday);
                        }
                        if (!result.shipdays) {
                            const shipdays = vesselObj.shipdays || vesselObj.shipDays || vesselObj.duration || '';
                            if (shipdays) {
                                const numMatch = String(shipdays).match(/(\d+)/);
                                if (numMatch) result.shipdays = clean(numMatch[1]);
                            }
                        }
                        // è¡¥å……èµ·è¿æ¸¯ç å¤´ï¼ˆå¢å¼ºæå–é€»è¾‘ï¼ŒåŒæ—¶æå–ç®€å†™å’Œå…¨ç§°ï¼‰
                        if (!result.polWharf) {
                            const polShort = normalizeWharfTokens(vesselObj.startPortWharfEnShortName || '');
                            const polFull = normalizeWharfTokens(vesselObj.startPortWharfEnFullName || '');
                            if (polShort && polFull) {
                                result.polWharf = `${polShort}/${polFull}`;
                            } else if (polShort) {
                                result.polWharf = polShort;
                            } else if (polFull) {
                                result.polWharf = polFull;
                            } else {
                                result.polWharf = normalizeWharfTokens(vesselObj.wharfName || vesselObj.polWharf || '');
                            }
                        }
                        
                        // è¡¥å……ç›®çš„æ¸¯ç å¤´ï¼ˆç¡®ä¿ä»æ­£ç¡®çš„vesselå¯¹è±¡ä¸­æå–ï¼‰
                        if (!result.podWharf || (result.podWharf && !result.podWharf.includes('/') && result.podWharf.length < 15)) {
                            const podShort = normalizeWharfTokens(vesselObj.destPortWharfEnShortName || '');
                            const podFull = normalizeWharfTokens(vesselObj.destPortWharfEnFullName || '');
                            if (podShort && podFull) {
                                result.podWharf = `${podShort}/${podFull}`;
                            } else if (podShort) {
                                result.podWharf = podShort;
                            } else if (podFull) {
                                result.podWharf = podFull;
                            }
                        }
                        
                        // å¦‚æœæ‰€æœ‰å…³é”®æ•°æ®éƒ½å·²è¡¥å……ï¼Œæå‰é€€å‡º
                        if (result.vesselName && result.voyage && result.plan && result.eta) {
                            break;
                        }
                    } catch (error) {
                        continue;
                    }
                }
            }
            
            // ç­–ç•¥2ï¼šå¦‚æœç­–ç•¥1æ²¡æœ‰æ‰¾åˆ°ï¼Œè¿›è¡Œé€šç”¨æœç´¢ï¼ˆå¢åŠ æœç´¢æ¬¡æ•°ï¼‰
            if ((!result.plan || !result.eta || !result.vesselName || !result.voyage) && decodedHtml) {
                const vesselObjPattern = /\{[^{}]*?"(?:vslName|vesselName)"\s*:\s*"[^"]+"[\s\S]{0,2000}?"(?:voyNo|voyageNo)"\s*:\s*"[^"]+"[\s\S]*?\}/g;
                let count = 0;
                let vesselObjMatch;
                while ((vesselObjMatch = vesselObjPattern.exec(decodedHtml)) !== null && count < 15) {
                    count++;
                    try {
                        const objText = vesselObjMatch[0].replace(/,\s*\}/g, '}');
                        const vesselObj = JSON.parse(objText);
                        
                        if (!result.vesselName) {
                            const name = extractVesselName(vesselObj);
                            if (name) result.vesselName = clean(name);
                        }
                        if (!result.voyage) {
                            const voy = extractVoyage(vesselObj);
                            if (voy) result.voyage = clean(voy);
                        }
                        if (!result.plan) {
                            const plan = extractPlanDate(vesselObj);
                            if (plan) result.plan = plan;
                        }
                        if (!result.eta) {
                            const eta = extractEtaDate(vesselObj);
                            if (eta) result.eta = eta;
                        }
                        if (!result.weekday) {
                            const weekday = vesselObj.weekdayOfETDFormatter 
                                || vesselObj.weekday 
                                || vesselObj.etdWeekday 
                                || vesselObj.weekdayOfETD
                                || vesselObj.sailingWeekday
                                || vesselObj.departureWeekday
                                || '';
                            if (weekday) result.weekday = clean(weekday);
                        }
                        if (!result.shipdays) {
                            const shipdays = vesselObj.shipdays || vesselObj.shipDays || vesselObj.duration || '';
                            if (shipdays) {
                                const numMatch = String(shipdays).match(/(\d+)/);
                                if (numMatch) result.shipdays = clean(numMatch[1]);
                            }
                        }
                        // è¡¥å……èµ·è¿æ¸¯ç å¤´ï¼ˆå¢å¼ºæå–é€»è¾‘ï¼ŒåŒæ—¶æå–ç®€å†™å’Œå…¨ç§°ï¼‰
                        if (!result.polWharf) {
                            const polShort = normalizeWharfTokens(vesselObj.startPortWharfEnShortName || '');
                            const polFull = normalizeWharfTokens(vesselObj.startPortWharfEnFullName || '');
                            if (polShort && polFull) {
                                result.polWharf = `${polShort}/${polFull}`;
                            } else if (polShort) {
                                result.polWharf = polShort;
                            } else if (polFull) {
                                result.polWharf = polFull;
                            } else {
                                result.polWharf = normalizeWharfTokens(vesselObj.wharfName || vesselObj.polWharf || '');
                            }
                        }
                        
                        // è¡¥å……ç›®çš„æ¸¯ç å¤´ï¼ˆç¡®ä¿ä»æ­£ç¡®çš„vesselå¯¹è±¡ä¸­æå–ï¼‰
                        if (!result.podWharf || (result.podWharf && !result.podWharf.includes('/') && result.podWharf.length < 15)) {
                            const podShort = normalizeWharfTokens(vesselObj.destPortWharfEnShortName || '');
                            const podFull = normalizeWharfTokens(vesselObj.destPortWharfEnFullName || '');
                            if (podShort && podFull) {
                                result.podWharf = `${podShort}/${podFull}`;
                            } else if (podShort) {
                                result.podWharf = podShort;
                            } else if (podFull) {
                                result.podWharf = podFull;
                            }
                        }
                        
                        // å¦‚æœæ‰€æœ‰å…³é”®æ•°æ®éƒ½å·²è¡¥å……ï¼Œæå‰é€€å‡º
                        if (result.vesselName && result.voyage && result.plan && result.eta) {
                            break;
                        }
                    } catch (error) {
                        continue;
                    }
                }
            }
        }
        
        return result;
    }

    function parseFile(name, html, decodedHtml = null){
        // ä¼˜åŒ–ï¼šå¦‚æœå·²ç»è§£ç è¿‡ï¼Œç›´æ¥ä½¿ç”¨ï¼Œé¿å…é‡å¤è§£ç 
        const decoded = decodedHtml || extractDecodedPayload(html);
        // æˆªæ–­ï¼šå‡ºç°"ä¸­è½¬"æˆ–"æ¥äºŒç¨‹"åé¢çš„å†…å®¹å¿½ç•¥
        const cutMarkers = [
            'text-[14px] font-bold">ä¸­è½¬',
            'lineTypeShowName":"æ¥äºŒç¨‹"'
        ];
        let cutPos = -1;
        for (const marker of cutMarkers) {
            const markerPos = decoded.indexOf(marker);
            if (markerPos >= 0 && (cutPos === -1 || markerPos < cutPos)) {
                cutPos = markerPos;
            }
        }
        const mainText = cutPos>0 ? decoded.slice(0, cutPos) : decoded;

        // ä¼˜åŒ–ï¼šå»¶è¿Ÿæå–å¯è§æ•°æ®ï¼Œåªåœ¨éœ€è¦éªŒè¯æ—¶æ‰æ‰§è¡Œï¼ˆå¦‚æœæ•°æ®å·²ç»å®Œæ•´ï¼Œå¯ä»¥è·³è¿‡ï¼‰
        // ä»DOMä¸­æå–å¯è§çš„èˆ¹æœŸæ•°æ®ï¼Œç”¨äºéªŒè¯
        // æ³¨æ„ï¼šè¿™ä¸ªæ“ä½œå¾ˆæ…¢ï¼Œåªåœ¨å¿…è¦æ—¶æ‰§è¡Œ
        let visibleData = null; // å»¶è¿Ÿåˆå§‹åŒ–

        const labelIndex = buildLabelIndex(mainText);
        const fleets = extractFleetAndVessels(mainText, labelIndex, null); // å…ˆä¸ä¼ visibleData
        const odTop = extractOriginDest(decoded);

        const rows = [];
        // ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥æ‰¾å…±èˆ±èˆ¹å…¬å¸ï¼Œå‡å°‘é‡å¤æœç´¢
        const carrierCache = new Map(); // key: `${lineId}_${portId}`, value: carriers
        
        for (const fleet of fleets) {
            const lineId = fleet.fleetId;
            // æ¸¯å£IDï¼šä¼˜å…ˆä½¿ç”¨ fleet ä¸­çš„ï¼Œå¦‚æœæ— æ•ˆåˆ™å°è¯•ä» vessel ä¸­æå–
            let portId = fleet.fleetIdPort;
            if (!portId || portId === '0' || portId === '') {
                // å°è¯•ä» vessel å¯¹è±¡ä¸­æå–
                for (const vessel of fleet.vessels) {
                    if (vessel.fleetIdPort && vessel.fleetIdPort !== '0') {
                        portId = vessel.fleetIdPort;
                        break;
                    }
                }
            }
            
            // ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜é¿å…é‡å¤æŸ¥æ‰¾
            const carrierKey = `${lineId}_${portId}`;
            let carriers = carrierCache.get(carrierKey);
            if (carriers === undefined) {
                // å…±èˆ±èˆ¹å…¬å¸ï¼šåœ¨å®Œæ•´è§£ç æ–‡æœ¬å’ŒåŸå§‹HTMLä¸­æŸ¥æ‰¾ _lineId_portId å¯¹åº”çš„ <a> çš„ title
                carriers = findCosTitle(decoded, lineId, portId, html);
                if (!carriers) {
                    carriers = [
                        fleet.carrierShortName && fleet.svcCode
                            ? `${fleet.carrierShortName}(${fleet.svcCode})`
                            : fleet.carrierShortName
                    ].filter(Boolean).join('');
                }
                carrierCache.set(carrierKey, carriers);
            }
            
            // ç›®çš„æ¸¯ç å¤´ï¼šæ”¹è¿›ç»„åˆé€»è¾‘ï¼Œç¡®ä¿æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
            let podCombined = '';
            if (fleet.podShort && fleet.podFull) {
                // ä¸¤è€…éƒ½æœ‰ï¼Œç”¨ / åˆ†éš”
                podCombined = `${fleet.podShort}/${fleet.podFull}`;
            } else if (fleet.podShort) {
                // åªæœ‰ç¼©å†™
                podCombined = fleet.podShort;
            } else if (fleet.podFull) {
                // åªæœ‰å…¨ç§°
                podCombined = fleet.podFull;
            }
            
            const origin = fleet.origin || odTop.origin || '';
            const dest = fleet.dest || odTop.dest || '';
            
            // ä» fleet çº§åˆ«æå–çš„é»˜è®¤å€¼
            let defaultWeekday = fleet.weekday || '';
            let defaultShipdays = fleet.shipdays || '';
            let defaultPolWharf = fleet.polWharf || '';
            
            for (const vessel of fleet.vessels) {
                // ä½¿ç”¨å¢å¼ºçš„æå–å‡½æ•°ï¼Œå°è¯•å¤šä¸ªå­—æ®µå
                const vesselName = extractVesselName(vessel);
                const voyage = extractVoyage(vessel);
                const shipType = vessel.shipCapacity || '';
                let plan = extractPlanDate(vessel);
                const atd = datePart(vessel.atdFormatter || '');
                let eta = extractEtaDate(vessel);
                
                // ä¼˜åŒ–ï¼šå»¶è¿ŸéªŒè¯ï¼Œåªåœ¨æ•°æ®ä¸å®Œæ•´æ—¶æ‰æå–å¯è§æ•°æ®
                // å¦‚æœæ•°æ®å·²ç»å®Œæ•´ï¼ˆæœ‰èˆ¹åã€èˆªæ¬¡ã€è®¡åˆ’å¼€èˆªã€é¢„è®¡åˆ°æ¸¯ï¼‰ï¼Œè·³è¿‡éªŒè¯ä»¥æé«˜æ€§èƒ½
                const hasCompleteData = vesselName && voyage && plan && eta;
                if (!hasCompleteData) {
                    // å»¶è¿Ÿåˆå§‹åŒ– visibleDataï¼ˆåªåœ¨éœ€è¦æ—¶æ‰æ‰§è¡Œï¼Œè¿™ä¸ªæ“ä½œå¾ˆæ…¢ï¼‰
                    if (visibleData === null) {
                        visibleData = extractVisibleScheduleData(html);
                    }
                    
                    if (visibleData && visibleData.size > 0) {
                        // ä»å¯è§æ•°æ®ä¸­è¡¥å……è®¡åˆ’å¼€èˆªå’Œç›®çš„æ¸¯ç å¤´
                        const visibleKey = `${lineId}_${portId}_${vesselName || ''}_${voyage || ''}`;
                        const visibleInfo = visibleData.get(visibleKey) || 
                                          visibleData.get(`${lineId}_${portId}_${clean(vesselName || '')}_${clean(voyage || '')}`) ||
                                          visibleData.get(`${lineId}_${portId}_${(vesselName || '').toUpperCase()}_${(voyage || '').toUpperCase()}`);
                        
                        if (visibleInfo) {
                            // å¦‚æœJSONä¸­æ²¡æœ‰è®¡åˆ’å¼€èˆªï¼Œä½¿ç”¨DOMä¸­çš„
                            if (!plan && visibleInfo.planDate) {
                                plan = visibleInfo.planDate;
                            }
                            // å¦‚æœJSONä¸­æ²¡æœ‰é¢„è®¡åˆ°æ¸¯ï¼Œä½¿ç”¨DOMä¸­çš„
                            if (!eta && visibleInfo.etaDate) {
                                eta = visibleInfo.etaDate;
                            }
                            // å¦‚æœJSONä¸­æ²¡æœ‰ç›®çš„æ¸¯ç å¤´ï¼Œä½¿ç”¨DOMä¸­çš„
                            if (!podCombined && visibleInfo.podWharf) {
                                podCombined = visibleInfo.podWharf;
                            }
                        }
                    }
                }
                
                // æ³¨æ„ï¼šè¡¥å……æœºåˆ¶å»¶è¿Ÿåˆ°åˆå¹¶åç»Ÿä¸€å¤„ç†ï¼Œä»¥æé«˜æ€§èƒ½
                
                // å¼€èˆªæ—¥ï¼šä¼˜å…ˆä» vesselï¼Œå…¶æ¬¡ä» fleet
                let weekday = defaultWeekday;
                if (!weekday) {
                    weekday = vessel.weekdayOfETDFormatter || vessel.weekday || vessel.etdWeekday || '';
                }
                
                // èˆªç¨‹ï¼šä¼˜å…ˆä» vesselï¼Œå…¶æ¬¡ä» fleetï¼ˆå¢å¼ºæå–é€»è¾‘ï¼‰
                let shipdays = defaultShipdays;
                if (!shipdays) {
                    shipdays = vessel.shipdays 
                        || vessel.shipDays 
                        || vessel.duration 
                        || vessel.transitTime
                        || vessel.transitDays
                        || '';
                }
                // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºæ•°å­—
                if (shipdays && typeof shipdays === 'string') {
                    const numMatch = shipdays.match(/(\d+)/);
                    if (numMatch) shipdays = numMatch[1];
                }
                
                // èµ·è¿æ¸¯ç å¤´ï¼šä¼˜å…ˆä» vesselï¼Œå…¶æ¬¡ä» fleetï¼ˆå¢å¼ºæå–é€»è¾‘ï¼ŒåŒæ—¶æå–ç®€å†™å’Œå…¨ç§°ï¼‰
                let polWharf = defaultPolWharf;
                if (!polWharf) {
                    const polShort = vessel.startPortWharfEnShortName || '';
                    const polFull = vessel.startPortWharfEnFullName || '';
                    if (polShort && polFull) {
                        polWharf = `${normalizeWharfTokens(polShort)}/${normalizeWharfTokens(polFull)}`;
                    } else if (polShort) {
                        polWharf = normalizeWharfTokens(polShort);
                    } else if (polFull) {
                        polWharf = normalizeWharfTokens(polFull);
                    } else {
                        polWharf = normalizeWharfTokens(
                            vessel.wharfName
                            || vessel.polWharf
                            || ''
                        );
                    }
                }
                
                // ç›®çš„æ¸¯ç å¤´ï¼šå¦‚æœ vessel ä¸­æœ‰ï¼Œä¼˜å…ˆä½¿ç”¨ï¼ˆå¢å¼ºæå–é€»è¾‘ï¼Œç¡®ä¿åŒæ—¶æå–ç®€å†™å’Œå…¨ç§°ï¼‰
                let vesselPodCombined = podCombined;
                if (vessel.destPortWharfEnShortName || vessel.destPortWharfEnFullName) {
                    const vPodShort = normalizeWharfTokens(vessel.destPortWharfEnShortName || '');
                    const vPodFull = normalizeWharfTokens(vessel.destPortWharfEnFullName || '');
                    if (vPodShort && vPodFull) {
                        vesselPodCombined = `${vPodShort}/${vPodFull}`;
                    } else if (vPodShort) {
                        vesselPodCombined = vPodShort;
                    } else if (vPodFull) {
                        vesselPodCombined = vPodFull;
                    }
                }
                
                // åº”ç”¨æ•°æ®æ¸…æ´—ï¼šèˆ¹å‹ã€èˆ¹åèˆªæ¬¡
                const cleanedShipType = cleanShipType(shipType);
                const cleanedVesselName = clean(vesselName);
                const cleanedVoyage = clean(voyage);
                
                // é¢„è®¡åˆ°æ¸¯è¡¥å……é€»è¾‘ï¼šå¦‚æœæœ‰èˆ¹åèˆªæ¬¡ä½†ä¸æ˜¯BLANK SAILINGï¼Œåº”è¯¥æœ‰é¢„è®¡åˆ°æ¸¯
                let finalEta = clean(eta);
                if (!finalEta && cleanedVesselName && cleanedVoyage) {
                    const isBlankSailing = /BLANK\s*SAILING/i.test(cleanedVesselName) || /BLANK\s*SAILING/i.test(cleanedVoyage);
                    if (!isBlankSailing) {
                        // ä¸æ˜¯ç©ºç™½èˆªè¡Œï¼Œåº”è¯¥æœ‰é¢„è®¡åˆ°æ¸¯ï¼Œå°è¯•ä»å¯è§æ•°æ®æˆ–è¡¥å……æ•°æ®ä¸­è·å–
                        // è¿™éƒ¨åˆ†ä¼šåœ¨åç»­çš„è¡¥å……æœºåˆ¶ä¸­å¤„ç†
                    }
                }
                
                rows.push([
                    clean(origin),                      // å¯è¿æ¸¯
                    clean(dest),                        // ç›®çš„æ¸¯
                    clean(lineId),                      // èˆªçº¿ID
                    clean(portId),                      // æ¸¯å£ID
                    clean(weekday),                     // å¼€èˆªæ—¥
                    clean(shipdays),                    // èˆªç¨‹
                    clean(carriers),                    // å…±èˆ±èˆ¹å…¬å¸
                    cleanedVesselName,                  // èˆ¹åï¼ˆå·²æ¸…æ´—ï¼‰
                    cleanedVoyage,                      // èˆªæ¬¡ï¼ˆå·²æ¸…æ´—ï¼‰
                    cleanedShipType,                    // èˆ¹å‹ï¼ˆå·²æ¸…æ´—ï¼Œå¤„ç†ç©ºæ ¼ï¼‰
                    clean(plan),                        // è®¡åˆ’å¼€èˆª
                    clean(atd),                         // å®é™…ç¦»æ¸¯
                    finalEta,                           // é¢„è®¡åˆ°æ¸¯
                    clean(polWharf),                    // å¯è¿æ¸¯ç å¤´
                    clean(vesselPodCombined)            // ç›®çš„æ¸¯ç å¤´
                ]);
            }
        }
        // å…¨å±€å…œåº•ï¼šè‹¥ä»æ— èˆ¹æœŸï¼Œä»æ•´é¡µç›´æ¥æŠ“å–å« vslName çš„å¯¹è±¡
        if (rows.length === 0) {
            const vesselPattern = /\{[^{}]*?"(?:vslName|vesselName)"\s*:\s*"[^"]+"[\s\S]*?\}/g;
            let vesselMatch;
            while ((vesselMatch = vesselPattern.exec(mainText))) {
                const objText = vesselMatch[0].replace(/,\s*\}/g, '}');
                try {
                    const vessel = JSON.parse(objText);
                    const vesselName = extractVesselName(vessel);
                    const voyage = extractVoyage(vessel);
                    if (!vesselName && !voyage) continue;
                    const shipType = vessel.shipCapacity || '';
                    const plan = extractPlanDate(vessel);
                    const atd = datePart(vessel.atdFormatter || '');
                    const eta = extractEtaDate(vessel);
                    rows.push([
                        clean(odTop.origin || ''),
                        clean(odTop.dest || ''),
                        '', '', '', '', '',
                        clean(vesselName),
                        clean(voyage),
                        clean(shipType),
                        clean(plan),
                        clean(atd),
                        clean(eta),
                        '', ''
                    ]);
                } catch (error) {
                    console.warn('Failed to parse vessel object from fallback extraction:', error);
                }
            }
        }
        
        // æ³¨æ„ï¼šè¡¥å……æœºåˆ¶å»¶è¿Ÿåˆ°åˆå¹¶åç»Ÿä¸€å¤„ç†ï¼Œä»¥æé«˜æ€§èƒ½
        
        return rows;
    }

    /**
     * ç”Ÿæˆæ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š
     * @param {Array<Array>} merged - åˆå¹¶åçš„æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
     * @returns {Object} è´¨é‡æŠ¥å‘Šå¯¹è±¡
     */
    function generateQualityReport(merged) {
        const report = {
            hasIssues: false,
            duplicateVesselVoyage: [],
            duplicateVesselVoyageMap: new Map(), // key: normalized, value: {variants: Set, count: number}
            duplicatePodWharf: [],
            duplicatePodWharfMap: new Map(), // key: normalized, value: {variants: Map<variant, count>, totalCount: number}
            missingWeekday: 0,
            missingShipdays: 0,
            missingPlan: 0,
            missingEta: 0,
            missingEtaNotBlank: 0,
            missingPolWharf: 0,
            missingPodWharf: 0,
            podWharfOnlyShort: 0
        };
        
        if (merged.length <= 1) return report;
        
        // èˆ¹åèˆªæ¬¡å»ç©ºæ ¼åçš„æ˜ å°„ï¼ˆç”¨äºæ£€æµ‹é‡å¤ï¼‰
        const normalizedVesselVoyageMap = new Map(); // key: normalized, value: {variants: Map<variant, count>, totalCount: number}
        // ç›®çš„æ¸¯ç å¤´å»ç©ºæ ¼åçš„æ˜ å°„ï¼ˆç”¨äºæ£€æµ‹é‡å¤ï¼‰
        const normalizedPodWharfMap = new Map(); // key: normalized, value: {variants: Map<variant, count>, totalCount: number}
        
        // ç»Ÿè®¡ç¼ºå¤±å­—æ®µ
        for (let i = 1; i < merged.length; i++) {
            const row = merged[i];
            const [
                origin, dest, lineId, portId, weekday, shipdays, carriers,
                vesselName, voyage, shipType, plan, atd, eta, polWharf, podWharf
            ] = row;
            
            // æ£€æŸ¥èˆ¹åèˆªæ¬¡ç©ºæ ¼é—®é¢˜
            if (vesselName || voyage) {
                const normalized = normalizeVesselVoyage(vesselName, voyage);
                if (normalized.combinedNormalized) {
                    if (!normalizedVesselVoyageMap.has(normalized.combinedNormalized)) {
                        normalizedVesselVoyageMap.set(normalized.combinedNormalized, {
                            variants: new Map(), // key: variant, value: count
                            totalCount: 0
                        });
                    }
                    const entry = normalizedVesselVoyageMap.get(normalized.combinedNormalized);
                    entry.totalCount++;
                    // è®°å½•æ‰€æœ‰å˜ä½“ï¼ˆèˆ¹å+èˆªæ¬¡çš„ç»„åˆï¼‰åŠå…¶æ•°é‡
                    const variant = `${vesselName || ''}|${voyage || ''}`;
                    entry.variants.set(variant, (entry.variants.get(variant) || 0) + 1);
                }
            }
            
            // æ£€æŸ¥ç›®çš„æ¸¯ç å¤´ç©ºæ ¼é—®é¢˜
            if (podWharf) {
                const normalized = normalizePodWharf(podWharf);
                if (normalized) {
                    if (!normalizedPodWharfMap.has(normalized)) {
                        normalizedPodWharfMap.set(normalized, {
                            variants: new Map(), // key: variant, value: count
                            totalCount: 0
                        });
                    }
                    const entry = normalizedPodWharfMap.get(normalized);
                    entry.totalCount++;
                    // è®°å½•æ‰€æœ‰å˜ä½“åŠå…¶æ•°é‡
                    entry.variants.set(podWharf, (entry.variants.get(podWharf) || 0) + 1);
                }
            }
            
            // æ£€æŸ¥ç¼ºå¤±å­—æ®µ
            if (!weekday) report.missingWeekday++;
            if (!shipdays) report.missingShipdays++;
            if (!plan) report.missingPlan++;
            if (!eta) {
                report.missingEta++;
                // æ£€æŸ¥æ˜¯å¦æ˜¯éBLANK SAILING
                const isBlankSailing = /BLANK\s*SAILING/i.test(vesselName || '') || 
                                     /BLANK\s*SAILING/i.test(voyage || '');
                if (!isBlankSailing && vesselName && voyage) {
                    report.missingEtaNotBlank++;
                }
            }
            if (!polWharf) report.missingPolWharf++;
            if (!podWharf) report.missingPodWharf++;
            
            // æ£€æŸ¥ç›®çš„æ¸¯ç å¤´æ˜¯å¦åªæœ‰ç®€å†™ï¼ˆæ²¡æœ‰å…¨ç§°ï¼‰
            if (podWharf && !podWharf.includes('/') && podWharf.length < 10) {
                // å¯èƒ½æ˜¯åªæœ‰ç®€å†™ï¼Œæ²¡æœ‰å…¨ç§°
                report.podWharfOnlyShort++;
            }
        }
        
        // æ‰¾å‡ºé‡å¤çš„èˆ¹åèˆªæ¬¡ï¼ˆå»ç©ºæ ¼åç›¸åŒä½†åŸå§‹å€¼ä¸åŒï¼‰
        for (const [normalized, entry] of normalizedVesselVoyageMap.entries()) {
            if (entry.totalCount > 1 && entry.variants.size > 1) {
                // æœ‰å¤šä¸ªå˜ä½“ï¼Œéœ€è¦ç”¨æˆ·é€‰æ‹©
                const variants = Array.from(entry.variants.entries()).map(([variant, count]) => {
                    const [vName, vVoyage] = variant.split('|');
                    return { 
                        vesselName: vName, 
                        voyage: vVoyage,
                        count: count
                    };
                });
                // æŒ‰æ•°é‡æ’åºï¼Œæ•°é‡å¤šçš„åœ¨å‰
                variants.sort((a, b) => b.count - a.count);
                report.duplicateVesselVoyage.push({
                    normalized: normalized,
                    variants: variants,
                    count: entry.totalCount
                });
                report.duplicateVesselVoyageMap.set(normalized, entry);
            }
        }
        
        // æ‰¾å‡ºé‡å¤çš„ç›®çš„æ¸¯ç å¤´ï¼ˆå»ç©ºæ ¼åç›¸åŒä½†åŸå§‹å€¼ä¸åŒï¼‰
        for (const [normalized, entry] of normalizedPodWharfMap.entries()) {
            if (entry.totalCount > 1 && entry.variants.size > 1) {
                // æœ‰å¤šä¸ªå˜ä½“ï¼Œéœ€è¦ç”¨æˆ·é€‰æ‹©
                const variants = Array.from(entry.variants.entries()).map(([variant, count]) => {
                    return { 
                        podWharf: variant,
                        count: count
                    };
                });
                // æŒ‰æ•°é‡æ’åºï¼Œæ•°é‡å¤šçš„åœ¨å‰
                variants.sort((a, b) => b.count - a.count);
                report.duplicatePodWharf.push({
                    normalized: normalized,
                    variants: variants,
                    count: entry.totalCount
                });
                report.duplicatePodWharfMap.set(normalized, entry);
            }
        }
        
        // æŒ‰æ•°é‡æ’åº
        report.duplicateVesselVoyage.sort((a, b) => b.count - a.count);
        report.duplicatePodWharf.sort((a, b) => b.count - a.count);
        
        // åˆ¤æ–­æ˜¯å¦æœ‰é—®é¢˜
        report.hasIssues = report.duplicateVesselVoyage.length > 0 ||
                          report.duplicatePodWharf.length > 0 ||
                          report.missingWeekday > 0 ||
                          report.missingShipdays > 0 ||
                          report.missingPlan > 0 ||
                          report.missingEta > 0 ||
                          report.missingPolWharf > 0 ||
                          report.missingPodWharf > 0 ||
                          report.podWharfOnlyShort > 0;
        
        return report;
    }

    /**
     * æ˜¾ç¤ºèˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–æ¨¡æ€æ¡†
     * @param {Array} duplicateGroups - é‡å¤çš„èˆ¹åèˆªæ¬¡ç»„
     * @returns {Promise<Object>} è¿”å›ç”¨æˆ·é€‰æ‹©çš„æ›¿æ¢æ˜ å°„ {normalized: {vesselName, voyage}}
     */
    function showVesselVoyageModal(duplicateGroups) {
        return new Promise((resolve) => {
            const modal = selectElement('#vesselVoyageModal');
            const list = selectElement('#vesselVoyageList');
            const applyBtn = selectElement('#applyVesselVoyageReplace');
            const skipBtn = selectElement('#skipVesselVoyageReplace');
            
            // æ¸…ç©ºåˆ—è¡¨
            list.innerHTML = '';
            
            // å­˜å‚¨ç”¨æˆ·é€‰æ‹©
            const selections = new Map();
            
            // ä¸ºæ¯ç»„é‡å¤è®°å½•åˆ›å»ºé€‰æ‹©ç•Œé¢
            duplicateGroups.forEach((group, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'vessel-voyage-group';
                
                const title = document.createElement('div');
                title.className = 'vessel-voyage-group-title';
                title.textContent = `ç¬¬ ${groupIndex + 1} ç»„ï¼ˆå…± ${group.count} æ¡è®°å½•ï¼Œ${group.variants.length} ç§æ ¼å¼ï¼‰ï¼š`;
                groupDiv.appendChild(title);
                
                // æ‰¾åˆ°æœ€çŸ­çš„èˆ¹åèˆªæ¬¡ç»„åˆï¼ˆä½œä¸ºé»˜è®¤é€‰æ‹©ï¼‰
                let shortestIndex = 0;
                let shortestLength = Infinity;
                group.variants.forEach((variant, idx) => {
                    const totalLength = (variant.vesselName || '').length + (variant.voyage || '').length;
                    if (totalLength < shortestLength) {
                        shortestLength = totalLength;
                        shortestIndex = idx;
                    }
                });
                
                // ä¸ºæ¯ä¸ªå˜ä½“åˆ›å»ºé€‰é¡¹
                group.variants.forEach((variant, variantIndex) => {
                    const option = document.createElement('div');
                    option.className = 'vessel-voyage-option';
                    const isShortest = variantIndex === shortestIndex;
                    if (isShortest) {
                        option.classList.add('selected');
                        selections.set(group.normalized, variant);
                    }
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `vesselVoyageGroup_${groupIndex}`;
                    radio.value = `${variant.vesselName}|${variant.voyage}`;
                    radio.checked = isShortest;
                    radio.addEventListener('change', () => {
                        // æ›´æ–°é€‰ä¸­çŠ¶æ€
                        groupDiv.querySelectorAll('.vessel-voyage-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        option.classList.add('selected');
                        selections.set(group.normalized, variant);
                    });
                    
                    const label = document.createElement('label');
                    label.className = 'vessel-voyage-option-label';
                    label.textContent = `"${variant.vesselName || ''}" / "${variant.voyage || ''}"`;
                    
                    const count = document.createElement('span');
                    count.className = 'vessel-voyage-option-count';
                    count.textContent = `(${variant.count} æ¡)`;
                    
                    option.appendChild(radio);
                    option.appendChild(label);
                    option.appendChild(count);
                    option.addEventListener('click', () => {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    });
                    
                    groupDiv.appendChild(option);
                });
                
                list.appendChild(groupDiv);
            });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.remove('hidden');
            
            // åº”ç”¨æŒ‰é’®
            applyBtn.onclick = () => {
                modal.classList.add('hidden');
                resolve(selections);
            };
            
            // è·³è¿‡æŒ‰é’®
            skipBtn.onclick = () => {
                modal.classList.add('hidden');
                resolve(new Map()); // è¿”å›ç©ºæ˜ å°„ï¼Œä¸è¿›è¡Œæ›¿æ¢
            };
        });
    }

    /**
     * åº”ç”¨èˆ¹åèˆªæ¬¡æ›¿æ¢
     * @param {Array<Array>} merged - åˆå¹¶åçš„æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
     * @param {Map} replacements - æ›¿æ¢æ˜ å°„ {normalized: {vesselName, voyage}}
     * @returns {Array<Array>} æ›¿æ¢åçš„æ•°æ®
     */
    function applyVesselVoyageReplacements(merged, replacements) {
        if (replacements.size === 0) return merged;
        
        const result = [merged[0]]; // ä¿ç•™è¡¨å¤´
        
        for (let i = 1; i < merged.length; i++) {
            const row = [...merged[i]]; // å¤åˆ¶è¡Œ
            const vesselName = row[7] || '';
            const voyage = row[8] || '';
            
            const normalized = normalizeVesselVoyage(vesselName, voyage);
            if (normalized.combinedNormalized && replacements.has(normalized.combinedNormalized)) {
                const replacement = replacements.get(normalized.combinedNormalized);
                row[7] = replacement.vesselName;
                row[8] = replacement.voyage;
            }
            
            result.push(row);
        }
        
        return result;
    }

    /**
     * æ˜¾ç¤ºç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–æ¨¡æ€æ¡†
     * @param {Array} duplicateGroups - é‡å¤çš„ç›®çš„æ¸¯ç å¤´ç»„
     * @returns {Promise<Object>} è¿”å›ç”¨æˆ·é€‰æ‹©çš„æ›¿æ¢æ˜ å°„ {normalized: podWharf}
     */
    function showPodWharfModal(duplicateGroups) {
        return new Promise((resolve) => {
            const modal = selectElement('#podWharfModal');
            const list = selectElement('#podWharfList');
            const applyBtn = selectElement('#applyPodWharfReplace');
            const skipBtn = selectElement('#skipPodWharfReplace');
            
            // æ¸…ç©ºåˆ—è¡¨
            list.innerHTML = '';
            
            // å­˜å‚¨ç”¨æˆ·é€‰æ‹©
            const selections = new Map();
            
            // ä¸ºæ¯ç»„é‡å¤è®°å½•åˆ›å»ºé€‰æ‹©ç•Œé¢
            duplicateGroups.forEach((group, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'vessel-voyage-group';
                
                const title = document.createElement('div');
                title.className = 'vessel-voyage-group-title';
                title.textContent = `ç¬¬ ${groupIndex + 1} ç»„ï¼ˆå…± ${group.count} æ¡è®°å½•ï¼Œ${group.variants.length} ç§æ ¼å¼ï¼‰ï¼š`;
                groupDiv.appendChild(title);
                
                // æ‰¾åˆ°æœ€çŸ­çš„ç›®çš„æ¸¯ç å¤´ï¼ˆä½œä¸ºé»˜è®¤é€‰æ‹©ï¼‰
                let shortestIndex = 0;
                let shortestLength = Infinity;
                group.variants.forEach((variant, idx) => {
                    const length = (variant.podWharf || '').length;
                    if (length < shortestLength) {
                        shortestLength = length;
                        shortestIndex = idx;
                    }
                });
                
                // ä¸ºæ¯ä¸ªå˜ä½“åˆ›å»ºé€‰é¡¹
                group.variants.forEach((variant, variantIndex) => {
                    const option = document.createElement('div');
                    option.className = 'vessel-voyage-option';
                    const isShortest = variantIndex === shortestIndex;
                    if (isShortest) {
                        option.classList.add('selected');
                        selections.set(group.normalized, variant.podWharf);
                    }
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `podWharfGroup_${groupIndex}`;
                    radio.value = variant.podWharf;
                    radio.checked = isShortest;
                    radio.addEventListener('change', () => {
                        // æ›´æ–°é€‰ä¸­çŠ¶æ€
                        groupDiv.querySelectorAll('.vessel-voyage-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        option.classList.add('selected');
                        selections.set(group.normalized, variant.podWharf);
                    });
                    
                    const label = document.createElement('label');
                    label.className = 'vessel-voyage-option-label';
                    label.textContent = variant.podWharf || '';
                    
                    const count = document.createElement('span');
                    count.className = 'vessel-voyage-option-count';
                    count.textContent = `(${variant.count} æ¡)`;
                    
                    option.appendChild(radio);
                    option.appendChild(label);
                    option.appendChild(count);
                    option.addEventListener('click', () => {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    });
                    
                    groupDiv.appendChild(option);
                });
                
                list.appendChild(groupDiv);
            });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.remove('hidden');
            
            // åº”ç”¨æŒ‰é’®
            applyBtn.onclick = () => {
                modal.classList.add('hidden');
                resolve(selections);
            };
            
            // è·³è¿‡æŒ‰é’®
            skipBtn.onclick = () => {
                modal.classList.add('hidden');
                resolve(new Map()); // è¿”å›ç©ºæ˜ å°„ï¼Œä¸è¿›è¡Œæ›¿æ¢
            };
        });
    }

    /**
     * åº”ç”¨ç›®çš„æ¸¯ç å¤´æ›¿æ¢
     * @param {Array<Array>} merged - åˆå¹¶åçš„æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
     * @param {Map} replacements - æ›¿æ¢æ˜ å°„ {normalized: podWharf}
     * @returns {Array<Array>} æ›¿æ¢åçš„æ•°æ®
     */
    function applyPodWharfReplacements(merged, replacements) {
        if (replacements.size === 0) return merged;
        
        const result = [merged[0]]; // ä¿ç•™è¡¨å¤´
        
        for (let i = 1; i < merged.length; i++) {
            const row = [...merged[i]]; // å¤åˆ¶è¡Œ
            const podWharf = row[14] || '';
            
            const normalized = normalizePodWharf(podWharf);
            if (normalized && replacements.has(normalized)) {
                const replacement = replacements.get(normalized);
                row[14] = replacement;
            }
            
            result.push(row);
        }
        
        return result;
    }

    /**
     * æ¸²æŸ“é¢„è§ˆè¡¨æ ¼ - ä½¿ç”¨ parser-utils.js ä¸­çš„å‡½æ•°
     * @param {Array<Array>} rows - è¡Œæ•°æ®æ•°ç»„
     */
    function renderPreviewLocal(rows) {
        const headers = [
            'å¯è¿æ¸¯', 'ç›®çš„æ¸¯', 'èˆªçº¿ID', 'æ¸¯å£ID', 'å¼€èˆªæ—¥', 'èˆªç¨‹', 'å…±èˆ±èˆ¹å…¬å¸',
            'èˆ¹å', 'èˆªæ¬¡', 'èˆ¹å‹', 'è®¡åˆ’å¼€èˆª', 'å®é™…ç¦»æ¸¯', 'é¢„è®¡åˆ°æ¸¯', 'å¯è¿æ¸¯ç å¤´', 'ç›®çš„æ¸¯ç å¤´'
        ];
        renderPreview(rows, '#preview', '#table', headers, 50);
    }

    const picker = selectElement('#picker');
    const runBtn = selectElement('#run');
    const downloadBtn = selectElement('#download');
    const summary = selectElement('#summary');
    const logBox = selectElement('#log');
    let files = [];
    let output = [];

    picker.addEventListener('change', () => {
        if (logBox) logBox.innerHTML = '';
        output = [];
        summary.textContent = '';
        files = Array.from(picker.files)
            .filter(file => /\.html?$/i.test(file.name))
            .sort((a, b) => a.name.localeCompare(b.name));
        if (!files.length) {
            log('æœªé€‰æ‹©åˆ° HTML æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹© view-fullã€‚', '#b00020');
            runBtn.disabled = true;
            downloadBtn.disabled = true;
            return;
        }
        log(`å·²é€‰æ‹© ${files.length} ä¸ª HTML æ–‡ä»¶ã€‚`, '#0a7d33');
        runBtn.disabled = false;
        downloadBtn.disabled = true;
        const preview = selectElement('#preview');
        if (preview) preview.classList.add('hidden');
    });

    runBtn.addEventListener('click', async () => {
        runBtn.disabled = true;
        downloadBtn.disabled = true;
        output = [];
        const preview = selectElement('#preview');
        if (preview) preview.classList.add('hidden');
        const header = [
            'å¯è¿æ¸¯', 'ç›®çš„æ¸¯', 'èˆªçº¿ID', 'æ¸¯å£ID', 'å¼€èˆªæ—¥', 'èˆªç¨‹', 'å…±èˆ±èˆ¹å…¬å¸',
            'èˆ¹å', 'èˆªæ¬¡', 'èˆ¹å‹', 'è®¡åˆ’å¼€èˆª', 'å®é™…ç¦»æ¸¯', 'é¢„è®¡åˆ°æ¸¯', 'å¯è¿æ¸¯ç å¤´', 'ç›®çš„æ¸¯ç å¤´'
        ];
        const rows = [header];
        const htmlCache = new Map(); // ç¼“å­˜è§£ç åçš„HTMLå†…å®¹ï¼ˆkey: è¡Œç´¢å¼•, value: è§£ç åçš„HTMLï¼‰
        const originalHtmlCache = new Map(); // ç¼“å­˜åŸå§‹HTMLå†…å®¹ï¼ˆkey: è¡Œç´¢å¼•, value: åŸå§‹HTMLï¼‰
        // å»ºç«‹åŸºäºèˆªçº¿ID+æ¸¯å£IDçš„å…¨å±€HTMLæ˜ å°„ï¼ˆç”¨äºè¡¥å……æœºåˆ¶ï¼‰
        const linePortHtmlGlobalMap = new Map(); // key: `${lineId}_${portId}`, value: Array<{decodedHtml, originalHtml}>
        let ok = 0;
        let warn = 0;
        for (const file of files) {
            try {
                const html = await file.text();
                // ä¼˜åŒ–ï¼šå…ˆè§£ç ä¸€æ¬¡ï¼Œç„¶åä¼ é€’ç»™ parseFileï¼Œé¿å…é‡å¤è§£ç 
                const decodedHtml = extractDecodedPayload(html);
                const parsedRows = parseFile(file.name, html, decodedHtml);
                if (!parsedRows.length) {
                    warn++;
                    log(`[æ— èˆ¹æœŸ] ${file.name}`, '#b36b00');
                } else {
                    ok++;
                    log(`[OK] ${file.name} -> ${parsedRows.length} è¡Œ`, '#0a7d33');
                    // ç¼“å­˜è§£ç åçš„HTMLå’ŒåŸå§‹HTMLï¼Œé¿å…é‡å¤è§£ç 
                    const startIndex = rows.length;
                    for (let j = 0; j < parsedRows.length; j++) {
                        const row = parsedRows[j];
                        if (row.length > 0 && row[0] !== 'å¯è¿æ¸¯') { // è·³è¿‡è¡¨å¤´
                            htmlCache.set(startIndex + j, decodedHtml); // å­˜å‚¨è§£ç åçš„HTML
                            originalHtmlCache.set(startIndex + j, html); // å­˜å‚¨åŸå§‹HTML
                            
                            // å»ºç«‹åŸºäºèˆªçº¿ID+æ¸¯å£IDçš„å…¨å±€HTMLæ˜ å°„
                            const lineId = row[2] || ''; // èˆªçº¿ID
                            const portId = row[3] || ''; // æ¸¯å£ID
                            if (lineId && portId) {
                                const linePortKey = `${lineId}_${portId}`;
                                if (!linePortHtmlGlobalMap.has(linePortKey)) {
                                    linePortHtmlGlobalMap.set(linePortKey, []);
                                }
                                const htmlList = linePortHtmlGlobalMap.get(linePortKey);
                                // é¿å…é‡å¤æ·»åŠ ç›¸åŒçš„HTML
                                const htmlExists = htmlList.some(h => h.decodedHtml === decodedHtml);
                                if (!htmlExists) {
                                    htmlList.push({
                                        decodedHtml: decodedHtml,
                                        originalHtml: html
                                    });
                                }
                            }
                        }
                    }
                    rows.push(...parsedRows);
                }
            } catch (error) {
                warn++;
                const errorMessage = error && error.message ? error.message : error;
                log(`[å¤±è´¥] ${file.name}: ${errorMessage}`, '#b00020');
            }
        }
        // å»é‡åˆå¹¶ï¼šé”® = å¯è¿æ¸¯ + ç›®çš„æ¸¯ + èˆªçº¿ID + æ¸¯å£ID + èˆ¹å + èˆªæ¬¡ï¼›å…±èˆ±èˆ¹å…¬å¸åˆå¹¶å»é‡
        const deduplicationMap = new Map();
        const mergedHtmlCache = new Map(); // å­˜å‚¨åˆå¹¶åè®°å½•çš„HTMLå¼•ç”¨ï¼ˆkey: åˆå¹¶åçš„key, value: è§£ç åçš„HTMLï¼‰
        const mergedOriginalHtmlCache = new Map(); // å­˜å‚¨åˆå¹¶åè®°å½•çš„åŸå§‹HTMLå¼•ç”¨ï¼ˆkey: åˆå¹¶åçš„key, value: åŸå§‹HTMLï¼‰
        for (let i = 1; i < rows.length; i++) {
            const [
                origin,
                dest,
                lineId,
                portId,
                weekday,
                shipdays,
                carriers,
                vesselName,
                voyage,
                shipType,
                plan,
                atd,
                eta,
                polWharf,
                podWharf
            ] = rows[i].map(clean);
            
            const key = [origin, dest, lineId, portId, vesselName, voyage].join('|');
            if (!deduplicationMap.has(key)) {
                deduplicationMap.set(key, [
                    origin,
                    dest,
                    lineId,
                    portId,
                    weekday,
                    shipdays,
                    carriers,
                    vesselName,
                    voyage,
                    shipType,
                    plan,
                    atd,
                    eta,
                    polWharf,
                    podWharf
                ]);
                // ä¿å­˜è§£ç åçš„HTMLå’ŒåŸå§‹HTMLå¼•ç”¨
                if (htmlCache.has(i)) {
                    mergedHtmlCache.set(key, htmlCache.get(i));
                }
                if (originalHtmlCache.has(i)) {
                    mergedOriginalHtmlCache.set(key, originalHtmlCache.get(i));
                }
            } else {
                const existing = deduplicationMap.get(key);
                // åˆå¹¶å¼€èˆªæ—¥/èˆªç¨‹ï¼ˆä¿ç•™å·²æœ‰ï¼Œè‹¥ç©ºåˆ™è¡¥ï¼‰
                if (!existing[4] && weekday) existing[4] = weekday;
                if (!existing[5] && shipdays) existing[5] = shipdays;
                // å…±èˆ±ï¼šæŒ‰éœ€æ±‚ä½¿ç”¨ <a title> çš„æ–‡æœ¬ï¼Œä¸å†æ‹¼æ¥åˆå¹¶ï¼›ä¼˜å…ˆä¿ç•™å·²å­˜åœ¨çš„éç©ºå€¼
                if (!existing[6] && carriers) existing[6] = carriers;
                // è¡¥å……ç¼ºå¤±çš„å…³é”®å­—æ®µï¼šèˆ¹åã€èˆªæ¬¡ã€è®¡åˆ’å¼€èˆªã€é¢„è®¡åˆ°æ¸¯ã€ç›®çš„æ¸¯ç å¤´
                if (!existing[7] && vesselName) existing[7] = vesselName;
                if (!existing[8] && voyage) existing[8] = voyage;
                if (!existing[10] && plan) existing[10] = plan;
                if (!existing[12] && eta) existing[12] = eta;
                if (!existing[14] && podWharf) existing[14] = podWharf;
                // å…¶ä»–å­—æ®µä»¥é¦–æ¡ä¸ºå‡†ï¼Œå¦‚ATD/å¯è¿æ¸¯ç å¤´ä¸€èˆ¬ä¸€è‡´
                // å¦‚æœå½“å‰è¡Œæœ‰HTMLå¼•ç”¨ä½†å·²æœ‰è®°å½•æ²¡æœ‰ï¼Œåˆ™ä¿å­˜ï¼ˆä¼˜å…ˆä½¿ç”¨æœ‰æ›´å¤šæ•°æ®çš„è®°å½•ï¼‰
                if (htmlCache.has(i) && !mergedHtmlCache.has(key)) {
                    mergedHtmlCache.set(key, htmlCache.get(i));
                }
                if (originalHtmlCache.has(i) && !mergedOriginalHtmlCache.has(key)) {
                    mergedOriginalHtmlCache.set(key, originalHtmlCache.get(i));
                }
            }
        }
        const merged = [header, ...Array.from(deduplicationMap.values())];
        
        // åˆå¹¶åçš„è¡¥å……æœºåˆ¶ï¼šå¯¹ä»ç„¶ç¼ºå¤±çš„å­—æ®µè¿›è¡Œè¡¥å……ï¼ˆå¢å¼ºï¼šæ”¾å®½æ¡ä»¶ï¼Œæ”¯æŒä»å¤šä¸ªæ¥æºè¡¥å……ï¼‰
        // ä½¿ç”¨å…¨å±€HTMLæ˜ å°„ï¼Œç¡®ä¿èƒ½å¤Ÿä»æ‰€æœ‰ç›¸åŒèˆªçº¿ID+æ¸¯å£IDçš„HTMLä¸­æŸ¥æ‰¾
        const needSupplement = [];
        for (let i = 1; i < merged.length; i++) {
            const row = merged[i];
            const [
                origin, dest, lineId, portId, weekday, shipdays, carriers,
                vesselName, voyage, shipType, plan, atd, eta, polWharf, podWharf
            ] = row;
            
            // æ”¾å®½æ¡ä»¶ï¼šå³ä½¿åªæœ‰å•ä¸ªå­—æ®µç¼ºå¤±ä¹Ÿåº”è¯¥å°è¯•è¡¥å……
            // æ£€æŸ¥ç›®çš„æ¸¯ç å¤´æ˜¯å¦åªæœ‰ç®€å†™ï¼ˆæ²¡æœ‰/åˆ†éš”ç¬¦ä¸”é•¿åº¦è¾ƒçŸ­ï¼‰
            const podWharfOnlyShort = podWharf && !podWharf.includes('/') && podWharf.length < 15;
            
            const missing = {
                vesselName: !vesselName,
                voyage: !voyage,
                plan: !plan,
                eta: !eta,
                weekday: !weekday,
                shipdays: !shipdays,
                polWharf: !polWharf,
                podWharf: !podWharf || podWharfOnlyShort // å¦‚æœåªæœ‰ç®€å†™ï¼Œä¹Ÿç®—ç¼ºå¤±
            };
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å­—æ®µç¼ºå¤±
            const hasAnyMissing = Object.values(missing).some(v => v);
            
            // åªè¦æœ‰ç¼ºå¤±å­—æ®µä¸”æœ‰èˆªçº¿IDå’Œæ¸¯å£IDï¼Œå°±å°è¯•è¡¥å……
            if (hasAnyMissing && lineId && portId) {
                const rowKey = [origin, dest, lineId, portId, vesselName, voyage].join('|');
                // ä¼˜å…ˆä½¿ç”¨è¯¥è®°å½•çš„HTML
                let decodedHtml = mergedHtmlCache.get(rowKey);
                let originalHtml = mergedOriginalHtmlCache.get(rowKey);
                
                // å¦‚æœæ²¡æœ‰è¯¥è®°å½•çš„HTMLï¼Œä»å…¨å±€HTMLæ˜ å°„ä¸­æŸ¥æ‰¾ç›¸åŒèˆªçº¿ID+æ¸¯å£IDçš„HTML
                if (!decodedHtml && !originalHtml) {
                    const linePortKey = `${lineId}_${portId}`;
                    const htmlList = linePortHtmlGlobalMap.get(linePortKey);
                    if (htmlList && htmlList.length > 0) {
                        // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„HTMLï¼ˆé€šå¸¸è¿™äº›HTMLéƒ½åŒ…å«ç›¸åŒèˆªçº¿ID+æ¸¯å£IDçš„ä¿¡æ¯ï¼‰
                        decodedHtml = htmlList[0].decodedHtml;
                        originalHtml = htmlList[0].originalHtml;
                    }
                }
                
                // åªè¦æœ‰HTMLï¼ˆæ— è®ºæ˜¯è¯¥è®°å½•çš„è¿˜æ˜¯ç›¸åŒèˆªçº¿ID+æ¸¯å£IDçš„ï¼‰ï¼Œå°±å°è¯•è¡¥å……
                if (decodedHtml || originalHtml) {
                    needSupplement.push({
                        row: row,
                        rowKey: rowKey,
                        lineId: lineId,
                        portId: portId,
                        decodedHtml: decodedHtml,
                        originalHtml: originalHtml,
                        missing: missing
                    });
                }
            }
        }
        
        // æ‰¹é‡è¡¥å……ï¼šä½¿ç”¨ç¼“å­˜çš„è§£ç HTMLï¼Œé¿å…é‡å¤è§£ç ï¼ˆå¢å¼ºï¼šæ”¯æŒä»å¤šä¸ªæ¥æºè¡¥å……ï¼‰
        if (needSupplement.length > 0) {
            log(`æ­£åœ¨è¡¥å…… ${needSupplement.length} æ¡ç¼ºå¤±æ•°æ®...`, '#0a7d33');
            // ä¼˜åŒ–ï¼šæŒ‰HTMLæ–‡ä»¶åˆ†ç»„ï¼Œå‡å°‘é‡å¤çš„visibleDataæå–
            const htmlToVisibleData = new Map(); // key: HTMLå†…å®¹çš„key, value: visibleData Map
            
            // å…ˆå»ºç«‹HTMLåˆ°visibleDataçš„æ˜ å°„ï¼ˆåŒ…æ‹¬æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„HTMLæºï¼‰
            const allHtmlSources = new Set();
            for (const item of needSupplement) {
                // æ·»åŠ è¯¥è®°å½•çš„HTML
                if (item.originalHtml || item.decodedHtml) {
                    allHtmlSources.add(item.originalHtml || item.decodedHtml);
                }
                // æ·»åŠ ç›¸åŒèˆªçº¿ID+æ¸¯å£IDçš„æ‰€æœ‰HTML
                const linePortKey = `${item.lineId}_${item.portId}`;
                const htmlList = linePortHtmlGlobalMap.get(linePortKey) || [];
                for (const htmlItem of htmlList) {
                    if (htmlItem.originalHtml || htmlItem.decodedHtml) {
                        allHtmlSources.add(htmlItem.originalHtml || htmlItem.decodedHtml);
                    }
                }
            }
            
            // ä¸ºæ‰€æœ‰HTMLæºæå–visibleData
            for (const htmlForExtraction of allHtmlSources) {
                if (htmlForExtraction) {
                    const htmlKey = htmlForExtraction.substring(0, 1000);
                    if (!htmlToVisibleData.has(htmlKey)) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦visibleDataçš„è®°å½•
                        const needsVisibleData = Array.from(needSupplement).some(item => 
                            item.missing.plan || item.missing.podWharf
                        );
                        if (needsVisibleData) {
                            const visibleData = extractVisibleScheduleData(htmlForExtraction);
                            htmlToVisibleData.set(htmlKey, visibleData);
                        } else {
                            htmlToVisibleData.set(htmlKey, null);
                        }
                    }
                }
            }
            
            // æ‰¹é‡è¡¥å……ï¼ˆå¢å¼ºï¼šå°è¯•å¤šä¸ªHTMLæºï¼‰
            let supplementedCount = 0;
            for (const item of needSupplement) {
                let decodedHtml = item.decodedHtml;
                let originalHtml = item.originalHtml;
                
                // å¦‚æœç¬¬ä¸€ä¸ªHTMLæ²¡æœ‰æ‰¾åˆ°æ‰€æœ‰ç¼ºå¤±çš„æ•°æ®ï¼Œå°è¯•ä»å…¶ä»–ç›¸åŒèˆªçº¿ID+æ¸¯å£IDçš„HTMLä¸­æŸ¥æ‰¾
                const linePortKey = `${item.lineId}_${item.portId}`;
                const htmlList = linePortHtmlGlobalMap.get(linePortKey) || [];
                let htmlIndex = 0;
                
                // è®°å½•å½“å‰ç¼ºå¤±çš„å­—æ®µ
                const stillMissing = {...item.missing};
                
                // å°è¯•å¤šä¸ªHTMLæºï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰ç¼ºå¤±çš„æ•°æ®æˆ–å°è¯•å®Œæ‰€æœ‰HTML
                while (htmlIndex < htmlList.length + 1) {
                    if (decodedHtml || originalHtml) {
                        const htmlForExtraction = originalHtml || decodedHtml;
                        const htmlKey = htmlForExtraction ? htmlForExtraction.substring(0, 1000) : null;
                        // è·å–visibleDataï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•æå–
                        let visibleData = htmlKey ? htmlToVisibleData.get(htmlKey) : null;
                        if (visibleData === undefined && htmlForExtraction) {
                            // å¦‚æœè¿˜æ²¡æœ‰æå–è¿‡ï¼Œç°åœ¨æå–
                            const needsVisibleData = stillMissing.plan || stillMissing.podWharf;
                            if (needsVisibleData) {
                                visibleData = extractVisibleScheduleData(htmlForExtraction);
                                if (htmlKey) {
                                    htmlToVisibleData.set(htmlKey, visibleData);
                                }
                            } else {
                                visibleData = null;
                                if (htmlKey) {
                                    htmlToVisibleData.set(htmlKey, null);
                                }
                            }
                        }
                        
                        const supplemented = supplementMissingData(decodedHtml || originalHtml, item.lineId, item.portId, {
                            vesselName: item.row[7] || '',
                            voyage: item.row[8] || '',
                            plan: item.row[10] || '',
                            eta: item.row[12] || '',
                            weekday: item.row[4] || '',
                            shipdays: item.row[5] || '',
                            polWharf: item.row[13] || '',
                            podWharf: item.row[14] || ''
                        }, visibleData);
                        
                        let hasUpdate = false;
                        // åªæ›´æ–°ä»ç„¶ç¼ºå¤±çš„å­—æ®µ
                        if (stillMissing.vesselName && supplemented.vesselName) {
                            item.row[7] = clean(supplemented.vesselName);
                            stillMissing.vesselName = false;
                            hasUpdate = true;
                        }
                        if (stillMissing.voyage && supplemented.voyage) {
                            item.row[8] = clean(supplemented.voyage);
                            stillMissing.voyage = false;
                            hasUpdate = true;
                        }
                        if (stillMissing.plan && supplemented.plan) {
                            item.row[10] = clean(supplemented.plan);
                            stillMissing.plan = false;
                            hasUpdate = true;
                        }
                        if (stillMissing.eta && supplemented.eta) {
                            item.row[12] = clean(supplemented.eta);
                            stillMissing.eta = false;
                            hasUpdate = true;
                        }
                        if (stillMissing.weekday && supplemented.weekday) {
                            item.row[4] = clean(supplemented.weekday);
                            stillMissing.weekday = false;
                            hasUpdate = true;
                        }
                        if (stillMissing.shipdays && supplemented.shipdays) {
                            item.row[5] = clean(supplemented.shipdays);
                            stillMissing.shipdays = false;
                            hasUpdate = true;
                        }
                        if (stillMissing.polWharf && supplemented.polWharf) {
                            item.row[13] = clean(supplemented.polWharf);
                            stillMissing.polWharf = false;
                            hasUpdate = true;
                        }
                        if (stillMissing.podWharf && supplemented.podWharf) {
                            // å¦‚æœåŸå€¼åªæœ‰ç®€å†™ï¼Œæ–°å€¼æœ‰ç®€å†™+å…¨ç§°ï¼Œä½¿ç”¨æ–°å€¼ï¼›å¦åˆ™ä½¿ç”¨æ–°å€¼
                            const currentPodWharf = item.row[14] || '';
                            const newPodWharf = clean(supplemented.podWharf);
                            if (newPodWharf.includes('/') || !currentPodWharf) {
                                item.row[14] = newPodWharf;
                                stillMissing.podWharf = false;
                                hasUpdate = true;
                            } else if (currentPodWharf && !currentPodWharf.includes('/') && newPodWharf && !newPodWharf.includes('/')) {
                                // å¦‚æœéƒ½æ˜¯ç®€å†™ï¼Œä½¿ç”¨æ–°å€¼ï¼ˆå¯èƒ½æ›´å‡†ç¡®ï¼‰
                                item.row[14] = newPodWharf;
                                stillMissing.podWharf = false;
                                hasUpdate = true;
                            }
                        }
                        
                        if (hasUpdate) {
                            supplementedCount++;
                        }
                        
                        // å¦‚æœæ‰€æœ‰ç¼ºå¤±çš„å­—æ®µéƒ½å·²è¡¥å……ï¼Œæå‰é€€å‡º
                        if (!Object.values(stillMissing).some(v => v)) {
                            break;
                        }
                    }
                    
                    // å°è¯•ä¸‹ä¸€ä¸ªHTMLæº
                    if (htmlIndex < htmlList.length) {
                        decodedHtml = htmlList[htmlIndex].decodedHtml;
                        originalHtml = htmlList[htmlIndex].originalHtml;
                        htmlIndex++;
                    } else {
                        break;
                    }
                }
            }
            
            if (supplementedCount > 0) {
                log(`âœ… å·²è¡¥å…… ${supplementedCount} æ¡è®°å½•çš„ç¼ºå¤±å­—æ®µ`, '#0a7d33');
            }
        }
        // ç›®çš„æ¸¯ç å¤´è¡¥å…¨ï¼šå¦‚æœåŒä¸€èˆªçº¿ID+æ¸¯å£IDæœ‰å¸¦å…¨ç§°çš„è®°å½•ï¼Œç”¨å®ƒè¡¥å……åªæœ‰ç®€å†™çš„è®°å½•
        const podFullMap = new Map(); // key: lineId_portId, value: podWharf å¸¦å…¨ç§°
        for (let i = 1; i < merged.length; i++) {
            const row = merged[i];
            const lineId = row[2];
            const portId = row[3];
            const podWharf = row[14];
            if (lineId && portId && podWharf && podWharf.includes('/')) {
                const key = `${lineId}_${portId}`;
                // é€‰å–æœ€é•¿çš„ï¼ˆé€šå¸¸å«å…¨ç§°ï¼‰
                const current = podFullMap.get(key) || '';
                if (podWharf.length > current.length) {
                    podFullMap.set(key, podWharf);
                }
            }
        }
        for (let i = 1; i < merged.length; i++) {
            const row = merged[i];
            const lineId = row[2];
            const portId = row[3];
            const podWharf = row[14] || '';
            const onlyShort = podWharf && !podWharf.includes('/') && podWharf.length < 15;
            const key = `${lineId}_${portId}`;
            if (onlyShort && podFullMap.has(key)) {
                row[14] = podFullMap.get(key);
            }
        }

        // æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š
        const qualityReport = generateQualityReport(merged);
        
        // å¤„ç†èˆ¹åèˆªæ¬¡å’Œç›®çš„æ¸¯ç å¤´çš„æ ‡å‡†åŒ–ï¼ˆæŒ‰é¡ºåºå¤„ç†ï¼‰
        const processStandardization = async (currentMerged, currentReport) => {
            let processedMerged = currentMerged;
            let processedReport = currentReport;
            
            // ç¬¬ä¸€æ­¥ï¼šå¤„ç†èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–
            if (processedReport.duplicateVesselVoyage.length > 0) {
                log(`\nğŸ” å‘ç° ${processedReport.duplicateVesselVoyage.length} ç»„å¯èƒ½é‡å¤çš„èˆ¹åèˆªæ¬¡ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰ï¼Œè¯·é€‰æ‹©æ ‡å‡†æ ¼å¼...`, '#0a7d33');
                
                const replacements = await showVesselVoyageModal(processedReport.duplicateVesselVoyage);
                if (replacements.size > 0) {
                    log(`æ­£åœ¨åº”ç”¨èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–æ›¿æ¢...`, '#0a7d33');
                    processedMerged = applyVesselVoyageReplacements(processedMerged, replacements);
                    processedReport = generateQualityReport(processedMerged);
                    log(`\nâœ… å·²åº”ç”¨ ${replacements.size} ç»„èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–`, '#0a7d33');
                } else {
                    log(`\nâ­ï¸ å·²è·³è¿‡èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–ï¼Œä¿ç•™åŸå€¼`, '#666');
                }
            }
            
            // ç¬¬äºŒæ­¥ï¼šå¤„ç†ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–
            if (processedReport.duplicatePodWharf.length > 0) {
                log(`\nğŸ” å‘ç° ${processedReport.duplicatePodWharf.length} ç»„å¯èƒ½é‡å¤çš„ç›®çš„æ¸¯ç å¤´ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰ï¼Œè¯·é€‰æ‹©æ ‡å‡†æ ¼å¼...`, '#0a7d33');
                
                const podWharfReplacements = await showPodWharfModal(processedReport.duplicatePodWharf);
                if (podWharfReplacements.size > 0) {
                    log(`æ­£åœ¨åº”ç”¨ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–æ›¿æ¢...`, '#0a7d33');
                    processedMerged = applyPodWharfReplacements(processedMerged, podWharfReplacements);
                    processedReport = generateQualityReport(processedMerged);
                    log(`\nâœ… å·²åº”ç”¨ ${podWharfReplacements.size} ç»„ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–`, '#0a7d33');
                } else {
                    log(`\nâ­ï¸ å·²è·³è¿‡ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–ï¼Œä¿ç•™åŸå€¼`, '#666');
                }
            }
            
            return { merged: processedMerged, report: processedReport };
        };
        
        // æ‰§è¡Œæ ‡å‡†åŒ–å¤„ç†
        processStandardization(merged, qualityReport).then(({ merged: standardizedMerged, report: standardizedReport }) => {
            // ç¬¬ä¸‰æ­¥ï¼šæŒ‰ç›®çš„æ¸¯+èˆªçº¿ID+èˆ¹å+èˆªæ¬¡è¿›è¡Œå»é‡åˆå¹¶
            log(`\nğŸ”„ æ­£åœ¨è¿›è¡Œå»é‡åˆå¹¶ï¼ˆç›®çš„æ¸¯+èˆªçº¿ID+èˆ¹å+èˆªæ¬¡ï¼‰...`, '#0a7d33');
            const finalDeduplicationMap = new Map();
            const beforeCount = standardizedMerged.length - 1; // æ’é™¤è¡¨å¤´
            
            for (let i = 1; i < standardizedMerged.length; i++) {
                const row = standardizedMerged[i];
                const [
                    origin,
                    dest,
                    lineId,
                    portId,
                    weekday,
                    shipdays,
                    carriers,
                    vesselName,
                    voyage,
                    shipType,
                    plan,
                    atd,
                    eta,
                    polWharf,
                    podWharf
                ] = row.map(clean);
                
                // æ–°çš„å»é‡é”®ï¼šç›®çš„æ¸¯ + èˆªçº¿ID + èˆ¹å + èˆªæ¬¡
                const dedupKey = [dest, lineId, vesselName, voyage].join('|');
                
                if (!finalDeduplicationMap.has(dedupKey)) {
                    // é¦–æ¬¡å‡ºç°ï¼Œç›´æ¥æ·»åŠ 
                    finalDeduplicationMap.set(dedupKey, [
                        origin,
                        dest,
                        lineId,
                        portId,
                        weekday,
                        shipdays,
                        carriers,
                        vesselName,
                        voyage,
                        shipType,
                        plan,
                        atd,
                        eta,
                        polWharf,
                        podWharf
                    ]);
                } else {
                    // å·²å­˜åœ¨ï¼Œåˆå¹¶æ•°æ®ï¼ˆä¿ç•™æ›´å®Œæ•´çš„è®°å½•ï¼‰
                    const existing = finalDeduplicationMap.get(dedupKey);
                    
                    // åˆå¹¶å¯è¿æ¸¯ï¼šå¦‚æœæ–°è®°å½•çš„å¯è¿æ¸¯ä¸åŒï¼Œä¿ç•™å·²æœ‰çš„ï¼ˆæˆ–é€‰æ‹©æ›´å®Œæ•´çš„ï¼‰
                    // åˆå¹¶æ¸¯å£IDï¼šä¿ç•™å·²æœ‰çš„
                    // åˆå¹¶å¼€èˆªæ—¥/èˆªç¨‹ï¼ˆä¿ç•™å·²æœ‰ï¼Œè‹¥ç©ºåˆ™è¡¥ï¼‰
                    if (!existing[4] && weekday) existing[4] = weekday;
                    if (!existing[5] && shipdays) existing[5] = shipdays;
                    // å…±èˆ±ï¼šä¼˜å…ˆä¿ç•™å·²å­˜åœ¨çš„éç©ºå€¼
                    if (!existing[6] && carriers) existing[6] = carriers;
                    // è¡¥å……ç¼ºå¤±çš„å…³é”®å­—æ®µï¼šè®¡åˆ’å¼€èˆªã€é¢„è®¡åˆ°æ¸¯ã€ç›®çš„æ¸¯ç å¤´
                    if (!existing[10] && plan) existing[10] = plan;
                    if (!existing[12] && eta) existing[12] = eta;
                    if (!existing[14] && podWharf) existing[14] = podWharf;
                    // å¯è¿æ¸¯ç å¤´ï¼šå¦‚æœæ–°è®°å½•æœ‰è€Œæ—§è®°å½•æ²¡æœ‰ï¼Œåˆ™è¡¥å……
                    if (!existing[13] && polWharf) existing[13] = polWharf;
                    // èˆ¹å‹ï¼šä¿ç•™å·²æœ‰çš„
                    // å®é™…ç¦»æ¸¯ï¼šä¿ç•™å·²æœ‰çš„
                }
            }
            
            const finalMerged = [header, ...Array.from(finalDeduplicationMap.values())];
            const afterCount = finalMerged.length - 1; // æ’é™¤è¡¨å¤´
            const mergedCount = beforeCount - afterCount;
            
            if (mergedCount > 0) {
                log(`âœ… å»é‡å®Œæˆï¼šåˆå¹¶äº† ${mergedCount} æ¡é‡å¤è®°å½•ï¼ˆä» ${beforeCount} æ¡å‡å°‘åˆ° ${afterCount} æ¡ï¼‰`, '#0a7d33');
            }
            
            // é‡æ–°ç”Ÿæˆè´¨é‡æŠ¥å‘Š
            const finalReport = generateQualityReport(finalMerged);
            
            output = finalMerged;
            displayQualityReport(finalReport, true);
            renderPreviewLocal(finalMerged.slice(1));
            downloadBtn.disabled = finalMerged.length <= 1;
            summary.textContent = `å®Œæˆï¼š${ok} æ–‡ä»¶ï¼Œ${warn} æé†’ï¼Œåˆå¹¶å ${finalMerged.length - 1} æ¡ã€‚`;
        });
    });

    /**
     * æ˜¾ç¤ºæ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š
     * @param {Object} qualityReport - è´¨é‡æŠ¥å‘Šå¯¹è±¡
     * @param {boolean} skipDuplicates - æ˜¯å¦è·³è¿‡é‡å¤èˆ¹åèˆªæ¬¡çš„æ˜¾ç¤ºï¼ˆå› ä¸ºå·²ç»å¤„ç†è¿‡äº†ï¼‰
     */
    function displayQualityReport(qualityReport, skipDuplicates = false) {
        if (qualityReport.hasIssues) {
            log(`\nğŸ“Š æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Šï¼š`, '#0a7d33');
            if (!skipDuplicates && qualityReport.duplicateVesselVoyage.length > 0) {
                log(`âš ï¸ å‘ç° ${qualityReport.duplicateVesselVoyage.length} ç»„å¯èƒ½é‡å¤çš„èˆ¹åèˆªæ¬¡ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰`, '#b36b00');
            }
            if (!skipDuplicates && qualityReport.duplicatePodWharf.length > 0) {
                log(`âš ï¸ å‘ç° ${qualityReport.duplicatePodWharf.length} ç»„å¯èƒ½é‡å¤çš„ç›®çš„æ¸¯ç å¤´ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰`, '#b36b00');
            }
            if (qualityReport.missingWeekday > 0) {
                log(`âš ï¸ ç¼ºå¤±å¼€èˆªæ—¥ï¼š${qualityReport.missingWeekday} æ¡`, '#b36b00');
            }
            if (qualityReport.missingShipdays > 0) {
                log(`âš ï¸ ç¼ºå¤±èˆªç¨‹ï¼š${qualityReport.missingShipdays} æ¡`, '#b36b00');
            }
            if (qualityReport.missingPlan > 0) {
                log(`âš ï¸ ç¼ºå¤±è®¡åˆ’å¼€èˆªï¼š${qualityReport.missingPlan} æ¡`, '#b36b00');
            }
            if (qualityReport.missingEta > 0) {
                log(`âš ï¸ ç¼ºå¤±é¢„è®¡åˆ°æ¸¯ï¼š${qualityReport.missingEta} æ¡ï¼ˆå…¶ä¸­ ${qualityReport.missingEtaNotBlank} æ¡éBLANK SAILINGï¼‰`, '#b36b00');
            }
            if (qualityReport.missingPolWharf > 0) {
                log(`âš ï¸ ç¼ºå¤±å¯è¿æ¸¯ç å¤´ï¼š${qualityReport.missingPolWharf} æ¡`, '#b36b00');
            }
            if (qualityReport.missingPodWharf > 0) {
                log(`âš ï¸ ç¼ºå¤±ç›®çš„æ¸¯ç å¤´ï¼š${qualityReport.missingPodWharf} æ¡`, '#b36b00');
            }
            if (qualityReport.podWharfOnlyShort > 0) {
                log(`âš ï¸ ç›®çš„æ¸¯ç å¤´åªæœ‰ç®€å†™ï¼ˆç¼ºå°‘å…¨ç§°ï¼‰ï¼š${qualityReport.podWharfOnlyShort} æ¡`, '#b36b00');
            }
        } else {
            log(`\nâœ… æ•°æ®è´¨é‡æ£€æŸ¥é€šè¿‡ï¼Œæœªå‘ç°æ˜æ˜¾é—®é¢˜`, '#0a7d33');
        }
    }

    downloadBtn.addEventListener('click', () => {
        if (!output || output.length <= 1) return;
        const csv = '\uFEFF' + rowsToCsv(output);
        downloadBlob(csv, generateTimestampFilename('weiyun-schedule'), 'text/csv;charset=utf-8');
    });
})();
</script>
    </div>
    <div class="page-footer">
        <h2>ç»´è¿ç½‘ èˆ¹æœŸè§£æå·¥å…·ä½¿ç”¨å£°æ˜</h2>
        <p>æœ¬å·¥å…·ç”¨äºè§£æä»ç»´è¿ç½‘ï¼ˆweiyun.comï¼‰ä¸‹è½½çš„èˆ¹æœŸç½‘é¡µï¼Œæå–èˆªçº¿ã€èˆ¹åã€èˆªæ¬¡ã€å¼€èˆ¹æ—¥æœŸç­‰æ•°æ®å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶ã€‚</p>
        <p>æ‰€æœ‰æ•°æ®æ¥æºäºç»´è¿ç½‘å…¬å¼€ä¿¡æ¯ï¼Œè§£æç»“æœä»…ä¾›å†…éƒ¨ä½¿ç”¨ï¼Œè¯·éµå®ˆç»´è¿ç½‘çš„ä½¿ç”¨æ¡æ¬¾å’Œç‰ˆæƒè§„å®šã€‚</p>
    </div>
</body>
</html>
