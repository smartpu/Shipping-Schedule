<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维运网 港口标准化工具</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/port-sort-utils.js"></script>
</head>
<body data-page="001-03-port-standardizer.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>维运网 港口标准化工具</h2>
                            <p>将 001-02 解析的 CSV 文件中的港口名称标准化为统一格式，支持模糊匹配和转换报告</p>
                        </div>
                        <div class="section-intro-actions">
                            <a href="dashboard.html?tab=tools001" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="001-03-port-standardizer-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 文件上传区域 -->
                <div class="grid-2-col" style="margin-bottom: 0;">
                    <!-- 左侧：载入 CSV 文件 -->
                    <div class="card-white">
                        <div class="file-upload-section">
                            <label for="csvFileInput" class="file-upload-label" aria-label="选择CSV文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradCsv)" />
                                    <rect x="8" y="8" width="20" height="20" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="14" x2="28" y2="14" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="20" x2="28" y2="20" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="14" y1="8" x2="14" y2="28" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M18 22L22 26L14 26Z" fill="#fff"/>
                                    <defs>
                                        <linearGradient id="gradCsv" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#28a745" />
                                            <stop offset="1" stop-color="#5cb85c" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入 CSV 文件</div>
                                    <div class="file-upload-desc">选择 001-02 解析生成的船期 CSV 文件</div>
                                </div>
                                <input type="file" id="csvFileInput" class="file-upload-input" accept=".csv" aria-label="选择CSV文件">
                            </label>
                        </div>
                    </div>
                    
                    <!-- 右侧：载入港口列表文件（可选，用于覆盖默认列表） -->
                    <div class="card-white hidden" id="portListFileCard">
                        <div class="file-upload-section">
                            <label for="portListFileInput" class="file-upload-label" aria-label="选择港口列表文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradPortList)" />
                                    <rect x="10" y="9" width="16" height="18" rx="1" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M10 9L10 15L16 15" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="13" y1="20" x2="23" y2="20" stroke="#fff" stroke-width="1.2"/>
                                    <line x1="13" y1="23" x2="23" y2="23" stroke="#fff" stroke-width="1.2"/>
                                    <defs>
                                        <linearGradient id="gradPortList" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#0071e3" />
                                            <stop offset="1" stop-color="#54a4ff" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入港口列表（可选）</div>
                                    <div class="file-upload-desc">可选择自定义港口列表文件覆盖默认列表</div>
                                </div>
                                <input type="file" id="portListFileInput" class="file-upload-input" accept=".txt" aria-label="选择港口列表文件">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 处理状态和下载区域 -->
                <div class="grid-2-col mt-20 hidden" id="processingCard" style="margin-bottom: 0;">
                    <!-- 左侧：处理状态 -->
                    <div class="card-white">
                        <div class="data-status-container">
                            <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradProcessing)" />
                                <rect x="11" y="10" width="14" height="16" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                <rect x="15" y="8" width="6" height="4" rx="1" fill="#fff"/>
                                <path d="M14 18L17 21L23 15" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                <defs>
                                    <linearGradient id="gradProcessing" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#FF8A00" />
                                        <stop offset="1" stop-color="#FFB347" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="data-status-content">
                                <div class="data-status-title">处理状态</div>
                                <div id="processingStatus" class="data-status-text">准备处理...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：下载区域（可点击） -->
                    <div class="card-white hidden" id="downloadCard" style="cursor: pointer; transition: all 0.2s ease; min-height: 100px;" role="button" tabindex="0" aria-label="下载标准化后的CSV文件">
                        <div class="data-status-container">
                            <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradDownload)" />
                                <path d="M18 10V22M18 22L13 17M18 22L23 17M8 26H28" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
                                <defs>
                                    <linearGradient id="gradDownload" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#007AFF" />
                                        <stop offset="1" stop-color="#5AC8FA" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="data-status-content">
                                <div class="data-status-title">下载标准化后的 CSV</div>
                                <div id="fileInfo" class="data-status-text" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">处理完成后可下载</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 转换报告区域 -->
                <div class="card-white mt-20 hidden" id="reportCard">
                    <h3 class="section-title" style="margin-bottom: 20px;">转换报告</h3>
                    <div id="reportContent">
                        <!-- 报告内容将动态生成 -->
                    </div>
                </div>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">维运网 港口标准化工具使用声明</h2>
                    <p class="usage-statement-text">本工具用于将 001-02 解析生成的 CSV 文件中的名称标准化为统一格式 [英文名|代码|区域]，基于列表进行匹配。</p>
                    <p class="usage-statement-text">转换过程中会生成详细的转换报告，包括成功匹配、模糊匹配和未匹配的项目，便于改进代码或手动处理。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/sidebar-loader.js"></script>
    <script>
        init001ToolPage('001-03-port-standardizer.html', 'tools001');
    </script>
    <script>
        (function() {
            'use strict';

            // DOM 元素
            const csvFileInput = document.getElementById('csvFileInput');
            const portListFileInput = document.getElementById('portListFileInput');
            const portListFileCard = document.getElementById('portListFileCard');
            const processingCard = document.getElementById('processingCard');
            const processingStatus = document.getElementById('processingStatus');
            const reportCard = document.getElementById('reportCard');
            const reportContent = document.getElementById('reportContent');
            const fileInfo = document.getElementById('fileInfo');

            // 全局变量
            let portMapping = new Map(); // 港口名称映射：原始名称 -> [英文名|代码|区域]
            let processedCsvData = null; // 处理后的 CSV 数据
            let originalFileName = ''; // 原始文件名
            let portListText = null; // 港口列表文件内容（如果手动加载）

            // 始终显示港口列表上传卡片（服务器端和本地都可以使用）
            portListFileCard.classList.remove('hidden');
            
            // 页面加载时自动尝试从服务器加载港口列表
            (async () => {
                try {
                    await loadPortMapping();
                    console.log('港口列表已自动加载');
                } catch (error) {
                    console.warn('自动加载港口列表失败，用户可手动上传:', error);
                }
            })();

            /**
             * 从文本内容构建港口映射
             */
            function buildPortMappingFromText(text) {
                const lines = text.split('\n').filter(l => l.trim());
                
                // 清空映射
                portMapping.clear();

                // 解析每一行，构建映射
                lines.forEach((line) => {
                    const portInfo = window.portSortUtils.parsePortLine(line);
                    if (portInfo && portInfo.code) {
                        const standardized = `[${portInfo.englishName}|${portInfo.code}|${portInfo.region}]`;
                        
                        // 1. 001 格式（最后一部分，带引号）："BALBOA(巴尔博亚)"
                        if (portInfo.port001) {
                            // 提取英文部分（括号前）
                            const enMatch = portInfo.port001.match(/^([^(,]+)/);
                            if (enMatch) {
                                const enPart = enMatch[1].trim();
                                portMapping.set(enPart, standardized);
                                portMapping.set(enPart.toUpperCase(), standardized);
                                portMapping.set(enPart.toLowerCase(), standardized);
                            }
                            
                            // 提取中文部分（括号内，逗号前）
                            const cnMatch = portInfo.port001.match(/\(([^,)]+)/);
                            if (cnMatch) {
                                const cnPart = cnMatch[1].trim();
                                portMapping.set(cnPart, standardized);
                                // 去除"港"后缀
                                if (cnPart.endsWith('港')) {
                                    portMapping.set(cnPart.slice(0, -1), standardized);
                                }
                            }
                            
                            // 完整格式
                            portMapping.set(portInfo.port001, standardized);
                            // 去掉引号
                            const withoutQuotes = portInfo.port001.replace(/^"|"$/g, '');
                            portMapping.set(withoutQuotes, standardized);
                        }

                        // 2. 英文名
                        if (portInfo.englishName) {
                            portMapping.set(portInfo.englishName, standardized);
                            portMapping.set(portInfo.englishName.toUpperCase(), standardized);
                            portMapping.set(portInfo.englishName.toLowerCase(), standardized);
                        }

                        // 3. Alphaliner 名称
                        if (portInfo.alphalinerName) {
                            portMapping.set(portInfo.alphalinerName, standardized);
                            portMapping.set(portInfo.alphalinerName.toUpperCase(), standardized);
                        }

                        // 4. 365 格式（提取中文部分）
                        if (portInfo.port365) {
                            const cnMatch = portInfo.port365.match(/[\u4e00-\u9fa5]+$/);
                            if (cnMatch) {
                                portMapping.set(cnMatch[0], standardized);
                            }
                        }
                    }
                });
            }

            /**
             * 加载港口列表并构建映射关系
             */
            async function loadPortMapping() {
                try {
                    // 确保 portSortUtils 已加载
                    if (typeof window.portSortUtils === 'undefined') {
                        throw new Error('portSortUtils 未加载，请刷新页面重试');
                    }

                    // 加载港口列表和映射
                    await window.portSortUtils.loadPortsList();
                    await window.portSortUtils.loadPortsMapping();

                    // 优先使用手动加载的港口列表文件
                    if (portListText) {
                        buildPortMappingFromText(portListText);
                        console.log(`港口映射已加载（手动文件），共 ${portMapping.size} 个映射`);
                        return true;
                    }

                    // 尝试从网络加载
                    try {
                        const response = await fetch('data/Material-parsed_ports_list.txt');
                        if (response.ok) {
                            const text = await response.text();
                            buildPortMappingFromText(text);
                            console.log(`港口映射已加载（网络文件），共 ${portMapping.size} 个映射`);
                            return true;
                        }
                    } catch (fetchError) {
                        // 网络加载失败，尝试使用 portSortUtils 已有的数据
                        console.warn('无法从网络加载港口列表文件，尝试使用已加载的数据:', fetchError);
                    }

                    // 降级方案：使用 portSortUtils 已有的映射数据
                    // 注意：这可能不完整，因为 portInfoMap 在本地环境下可能为空
                    if (window.portSortUtils.portCodeToDisplayMap && Object.keys(window.portSortUtils.portCodeToDisplayMap).length > 0) {
                        portMapping.clear();
                        for (const [code, info] of Object.entries(window.portSortUtils.portCodeToDisplayMap)) {
                            const standardized = info.displayText;
                            if (info.englishName) {
                                portMapping.set(info.englishName, standardized);
                                portMapping.set(info.englishName.toUpperCase(), standardized);
                            }
                        }
                        console.log(`港口映射已加载（降级方案），共 ${portMapping.size} 个映射`);
                        console.warn('注意：降级方案的映射可能不完整，建议手动加载港口列表文件');
                        return true;
                    }

                    throw new Error('无法加载港口映射，请手动上传港口列表文件或检查网络连接');
                } catch (error) {
                    console.error('加载港口映射失败:', error);
                    throw error;
                }
            }

            /**
             * 去除方向词（东西南北）
             */
            function removeDirectionWords(portName) {
                if (!portName) return '';
                return portName
                    .replace(/^东|^西|^南|^北/g, '')
                    .replace(/东$|西$|南$|北$/g, '')
                    .trim();
            }

            /**
             * 模糊匹配港口名称
             */
            function fuzzyMatchPort(portName) {
                if (!portName) return null;

                // 1. 精确匹配
                if (portMapping.has(portName)) {
                    return { matched: portMapping.get(portName), method: 'exact' };
                }

                // 2. 去除方向词后匹配
                const withoutDirection = removeDirectionWords(portName);
                if (withoutDirection && withoutDirection !== portName) {
                    if (portMapping.has(withoutDirection)) {
                        return { matched: portMapping.get(withoutDirection), method: 'direction_removed' };
                    }
                }

                // 3. 大小写不敏感匹配
                const upper = portName.toUpperCase();
                if (portMapping.has(upper)) {
                    return { matched: portMapping.get(upper), method: 'case_insensitive' };
                }

                const lower = portName.toLowerCase();
                if (portMapping.has(lower)) {
                    return { matched: portMapping.get(lower), method: 'case_insensitive' };
                }

                // 4. 去除方向词 + 大小写不敏感
                if (withoutDirection) {
                    const upperWithout = withoutDirection.toUpperCase();
                    if (portMapping.has(upperWithout)) {
                        return { matched: portMapping.get(upperWithout), method: 'direction_case' };
                    }
                }

                // 5. 包含匹配（模糊）
                for (const [key, value] of portMapping.entries()) {
                    if (key.includes(portName) || portName.includes(key)) {
                        // 优先匹配较长的键
                        if (key.length >= portName.length * 0.8) {
                            return { matched: value, method: 'fuzzy' };
                        }
                    }
                }

                return null;
            }

            /**
             * 标准化单个港口名称
             */
            function standardizePort(portName) {
                if (!portName || !portName.trim()) {
                    return { standardized: '', method: 'empty' };
                }

                const trimmed = portName.trim();

                // 尝试精确匹配
                const exactMatch = fuzzyMatchPort(trimmed);
                if (exactMatch) {
                    return { standardized: exactMatch.matched, method: exactMatch.method, original: trimmed };
                }

                // 如果包含括号，尝试提取括号内的内容
                if (trimmed.includes('(') && trimmed.includes(')')) {
                    // 提取括号前的英文部分
                    const beforeBracket = trimmed.split('(')[0].trim();
                    if (beforeBracket) {
                        const match = fuzzyMatchPort(beforeBracket);
                        if (match) {
                            return { standardized: match.matched, method: match.method + '_bracket_en', original: trimmed };
                        }
                    }

                    // 提取括号内的中文部分
                    const cnMatch = trimmed.match(/\(([^,)]+)/);
                    if (cnMatch && cnMatch[1]) {
                        const cnPart = cnMatch[1].trim();
                        const match = fuzzyMatchPort(cnPart);
                        if (match) {
                            return { standardized: match.matched, method: match.method + '_bracket_cn', original: trimmed };
                        }
                    }
                }

                // 如果包含逗号，尝试提取逗号前的部分
                if (trimmed.includes(',')) {
                    const beforeComma = trimmed.split(',')[0].trim();
                    if (beforeComma) {
                        const match = fuzzyMatchPort(beforeComma);
                        if (match) {
                            return { standardized: match.matched, method: match.method + '_comma', original: trimmed };
                        }
                    }
                }

                return { standardized: trimmed, method: 'no_match', original: trimmed };
            }

            /**
             * 解析 CSV 文件
             */
            function parseCsv(csvText) {
                const lines = csvText.split('\n').filter(l => l.trim());
                if (lines.length === 0) {
                    throw new Error('CSV 文件为空');
                }

                // 解析表头
                const headers = lines[0].split(',').map(h => h.trim());
                const originPortIndex = headers.findIndex(h => 
                    h === '启运港' || h.toLowerCase().includes('origin') || h.toLowerCase().includes('pol')
                );
                const destPortIndex = headers.findIndex(h => 
                    h === '目的港' || h.toLowerCase().includes('destination') || h.toLowerCase().includes('pod')
                );

                if (originPortIndex === -1 || destPortIndex === -1) {
                    throw new Error('CSV 文件必须包含"启运港"和"目的港"列');
                }

                // 解析数据行
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // 处理包含逗号的字段（使用简单的 CSV 解析）
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());

                    if (values.length >= Math.max(originPortIndex, destPortIndex) + 1) {
                        rows.push({
                            values: values,
                            originPort: values[originPortIndex] || '',
                            destPort: values[destPortIndex] || ''
                        });
                    }
                }

                return { headers, rows, originPortIndex, destPortIndex };
            }

            /**
             * 处理 CSV 数据
             */
            async function processCsv(csvText) {
                try {
                    processingStatus.textContent = '正在加载港口映射...';
                    
                    // 加载港口映射
                    await loadPortMapping();

                    processingStatus.textContent = '正在解析 CSV 文件...';
                    
                    // 解析 CSV
                    const parsed = parseCsv(csvText);

                    processingStatus.textContent = '正在标准化港口名称...';

                    // 统计信息
                    const stats = {
                        total: parsed.rows.length,
                        originMatched: { exact: 0, fuzzy: 0, noMatch: 0 },
                        destMatched: { exact: 0, fuzzy: 0, noMatch: 0 },
                        originNoMatch: [],
                        destNoMatch: []
                    };

                    // 处理每一行
                    const processedRows = parsed.rows.map(row => {
                        // 标准化起运港
                        const originResult = standardizePort(row.originPort);
                        if (originResult.method === 'exact' || originResult.method === 'case_insensitive') {
                            stats.originMatched.exact++;
                        } else if (originResult.method !== 'no_match' && originResult.method !== 'empty') {
                            stats.originMatched.fuzzy++;
                        } else {
                            stats.originMatched.noMatch++;
                            if (originResult.original && !stats.originNoMatch.includes(originResult.original)) {
                                stats.originNoMatch.push(originResult.original);
                            }
                        }

                        // 标准化目的港
                        const destResult = standardizePort(row.destPort);
                        if (destResult.method === 'exact' || destResult.method === 'case_insensitive') {
                            stats.destMatched.exact++;
                        } else if (destResult.method !== 'no_match' && destResult.method !== 'empty') {
                            stats.destMatched.fuzzy++;
                        } else {
                            stats.destMatched.noMatch++;
                            if (destResult.original && !stats.destNoMatch.includes(destResult.original)) {
                                stats.destNoMatch.push(destResult.original);
                            }
                        }

                        // 更新行数据
                        const newValues = [...row.values];
                        newValues[parsed.originPortIndex] = originResult.standardized;
                        newValues[parsed.destPortIndex] = destResult.standardized;

                        return {
                            values: newValues,
                            originResult,
                            destResult
                        };
                    });

                    processingStatus.textContent = '处理完成！';

                    return {
                        headers: parsed.headers,
                        rows: processedRows,
                        stats
                    };
                } catch (error) {
                    console.error('处理 CSV 失败:', error);
                    throw error;
                }
            }

            /**
             * 生成转换报告（卡片式设计，符合苹果审美）
             */
            function generateReport(result) {
                const { stats } = result;
                
                let html = '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">';
                
                // 总体统计卡片（居中显示）
                html += '<div style="padding: 20px; background: linear-gradient(135deg, rgba(0, 122, 255, 0.08) 0%, rgba(90, 200, 250, 0.08) 100%); border-radius: 12px; border: 1px solid rgba(0, 122, 255, 0.15); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">';
                html += '<div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%); display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">';
                html += '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12 7H17L13 10L15 15L10 12L5 15L7 10L3 7H8L10 2Z" fill="white"/></svg>';
                html += '</div>';
                html += '<h4 style="margin: 0 0 12px 0; color: var(--color-text-primary); font-size: 16px; font-weight: 600;">总体统计</h4>';
                html += `<div style="font-size: 48px; font-weight: 700; color: var(--color-primary); line-height: 1.2; margin-bottom: 8px;">${stats.total.toLocaleString()}</div>`;
                html += '<div style="font-size: 14px; color: var(--color-text-secondary);">总行数</div>';
                html += '</div>';

                // 起运港统计卡片
                html += '<div style="padding: 20px; background: var(--color-bg-secondary); border-radius: 12px; border: 1px solid var(--color-border-light);">';
                html += '<h4 style="margin: 0 0 16px 0; color: var(--color-text-primary); font-size: 16px; font-weight: 600;">起运港匹配</h4>';
                html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
                
                // 精确匹配
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(52, 199, 89, 0.08); border-radius: 8px; border: 1px solid rgba(52, 199, 89, 0.2);">';
                html += '<div style="display: flex; align-items: center; gap: 8px;">';
                html += '<div style="width: 8px; height: 8px; border-radius: 50%; background: #34C759;"></div>';
                html += '<span style="font-size: 14px; color: var(--color-text-primary);">精确匹配</span>';
                html += '</div>';
                html += `<span style="font-size: 18px; font-weight: 600; color: #34C759;">${stats.originMatched.exact}</span>`;
                html += '</div>';
                
                // 模糊匹配
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255, 149, 0, 0.08); border-radius: 8px; border: 1px solid rgba(255, 149, 0, 0.2);">';
                html += '<div style="display: flex; align-items: center; gap: 8px;">';
                html += '<div style="width: 8px; height: 8px; border-radius: 50%; background: #FF9500;"></div>';
                html += '<span style="font-size: 14px; color: var(--color-text-primary);">模糊匹配</span>';
                html += '</div>';
                html += `<span style="font-size: 18px; font-weight: 600; color: #FF9500;">${stats.originMatched.fuzzy}</span>`;
                html += '</div>';
                
                // 未匹配
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255, 59, 48, 0.08); border-radius: 8px; border: 1px solid rgba(255, 59, 48, 0.2);">';
                html += '<div style="display: flex; align-items: center; gap: 8px;">';
                html += '<div style="width: 8px; height: 8px; border-radius: 50%; background: #FF3B30;"></div>';
                html += '<span style="font-size: 14px; color: var(--color-text-primary);">未匹配</span>';
                html += '</div>';
                html += `<span style="font-size: 18px; font-weight: 600; color: #FF3B30;">${stats.originMatched.noMatch}</span>`;
                html += '</div>';
                
                html += '</div>';
                
                // 未匹配列表
                if (stats.originNoMatch.length > 0) {
                    html += '<div style="margin-top: 16px; padding: 12px; background: rgba(255, 149, 0, 0.05); border-radius: 8px; border: 1px solid rgba(255, 149, 0, 0.15);">';
                    html += '<div style="font-size: 13px; font-weight: 600; color: var(--color-text-primary); margin-bottom: 8px;">未匹配的起运港</div>';
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                    html += stats.originNoMatch.map(p => `<span style="padding: 4px 10px; background: var(--color-bg-secondary); border-radius: 6px; font-size: 12px; color: var(--color-text-primary); border: 1px solid var(--color-border-light);">${p}</span>`).join('');
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '</div>';

                // 目的港统计卡片
                html += '<div style="padding: 20px; background: var(--color-bg-secondary); border-radius: 12px; border: 1px solid var(--color-border-light);">';
                html += '<h4 style="margin: 0 0 16px 0; color: var(--color-text-primary); font-size: 16px; font-weight: 600;">目的港匹配</h4>';
                html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
                
                // 精确匹配
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(52, 199, 89, 0.08); border-radius: 8px; border: 1px solid rgba(52, 199, 89, 0.2);">';
                html += '<div style="display: flex; align-items: center; gap: 8px;">';
                html += '<div style="width: 8px; height: 8px; border-radius: 50%; background: #34C759;"></div>';
                html += '<span style="font-size: 14px; color: var(--color-text-primary);">精确匹配</span>';
                html += '</div>';
                html += `<span style="font-size: 18px; font-weight: 600; color: #34C759;">${stats.destMatched.exact}</span>`;
                html += '</div>';
                
                // 模糊匹配
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255, 149, 0, 0.08); border-radius: 8px; border: 1px solid rgba(255, 149, 0, 0.2);">';
                html += '<div style="display: flex; align-items: center; gap: 8px;">';
                html += '<div style="width: 8px; height: 8px; border-radius: 50%; background: #FF9500;"></div>';
                html += '<span style="font-size: 14px; color: var(--color-text-primary);">模糊匹配</span>';
                html += '</div>';
                html += `<span style="font-size: 18px; font-weight: 600; color: #FF9500;">${stats.destMatched.fuzzy}</span>`;
                html += '</div>';
                
                // 未匹配
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255, 59, 48, 0.08); border-radius: 8px; border: 1px solid rgba(255, 59, 48, 0.2);">';
                html += '<div style="display: flex; align-items: center; gap: 8px;">';
                html += '<div style="width: 8px; height: 8px; border-radius: 50%; background: #FF3B30;"></div>';
                html += '<span style="font-size: 14px; color: var(--color-text-primary);">未匹配</span>';
                html += '</div>';
                html += `<span style="font-size: 18px; font-weight: 600; color: #FF3B30;">${stats.destMatched.noMatch}</span>`;
                html += '</div>';
                
                html += '</div>';
                
                // 未匹配列表
                if (stats.destNoMatch.length > 0) {
                    html += '<div style="margin-top: 16px; padding: 12px; background: rgba(255, 149, 0, 0.05); border-radius: 8px; border: 1px solid rgba(255, 149, 0, 0.15);">';
                    html += '<div style="font-size: 13px; font-weight: 600; color: var(--color-text-primary); margin-bottom: 8px;">未匹配的目的港</div>';
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                    html += stats.destNoMatch.map(p => `<span style="padding: 4px 10px; background: var(--color-bg-secondary); border-radius: 6px; font-size: 12px; color: var(--color-text-primary); border: 1px solid var(--color-border-light);">${p}</span>`).join('');
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '</div>';
                html += '</div>';
                
                reportContent.innerHTML = html;
            }

            /**
             * 生成 CSV 内容
             */
            function generateCsv(result) {
                const { headers, rows } = result;
                
                // 生成 CSV 行
                const csvLines = [];
                
                // 表头
                csvLines.push(headers.join(','));
                
                // 数据行
                rows.forEach(row => {
                    // 处理包含逗号的字段，用引号包裹
                    const escapedValues = row.values.map(val => {
                        if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                            return `"${val.replace(/"/g, '""')}"`;
                        }
                        return val;
                    });
                    csvLines.push(escapedValues.join(','));
                });
                
                return csvLines.join('\n');
            }

            /**
             * 下载 CSV 文件
             */
            function downloadCsv(csvContent, fileName) {
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName.replace(/\.csv$/i, '_标准化.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // 事件监听：港口列表文件
            portListFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    portListText = text;
                    
                    // 统计文件中的记录数
                    const lines = text.split('\n').filter(l => l.trim());
                    const recordCount = lines.length;
                    
                    console.log(`港口列表文件已加载，共 ${recordCount} 条记录`);
                } catch (error) {
                    console.error('读取港口列表文件失败:', error);
                    showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { 
                        message: '读取港口列表文件失败' 
                    }, error);
                    portListFileInput.value = '';
                }
            });

            // 事件监听：CSV 文件
            csvFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    showError(ErrorType.FILE_LOAD, 'FILE_VALIDATION_FAILED', { 
                        message: '请选择 CSV 文件' 
                    });
                    csvFileInput.value = '';
                    return;
                }

                try {
                    // 显示处理卡片
                    processingCard.classList.remove('hidden');
                    processingStatus.textContent = '正在读取文件...';

                    // 读取文件
                    const text = await file.text();
                    originalFileName = file.name;

                    // 处理 CSV
                    const result = await processCsv(text);
                    processedCsvData = result;

                    // 生成报告
                    generateReport(result);
                    reportCard.classList.remove('hidden');

                    // 显示下载卡片和信息
                    const downloadCardEl2 = document.getElementById('downloadCard');
                    if (downloadCardEl2) {
                        downloadCardEl2.classList.remove('hidden');
                    }
                    if (fileInfo) {
                        fileInfo.innerHTML = `<span>已处理 ${result.stats.total.toLocaleString()} 行数据</span>`;
                    }

                } catch (error) {
                    console.error('处理失败:', error);
                    showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', { 
                        message: error.message || '处理 CSV 文件时发生错误' 
                    }, error);
                    processingCard.classList.add('hidden');
                    reportCard.classList.add('hidden');
                    const downloadCardEl = document.getElementById('downloadCard');
                    if (downloadCardEl) {
                        downloadCardEl.classList.add('hidden');
                    }
                } finally {
                    csvFileInput.value = '';
                }
            });

            // 下载卡片点击事件
            const downloadCardEl = document.getElementById('downloadCard');
            if (downloadCardEl) {
                downloadCardEl.addEventListener('click', () => {
                    if (!processedCsvData) {
                        showError(ErrorType.USER_ACTION, 'NO_DATA', { 
                            message: '没有可下载的数据，请先处理 CSV 文件' 
                        });
                        return;
                    }

                    try {
                        const csvContent = generateCsv(processedCsvData);
                        downloadCsv(csvContent, originalFileName);
                    } catch (error) {
                        console.error('生成 CSV 失败:', error);
                        showError(ErrorType.SYSTEM_ERROR, 'EXPORT_FAILED', { 
                            message: '生成 CSV 文件时发生错误' 
                        }, error);
                    }
                });
                
                // 添加悬停效果
                downloadCardEl.addEventListener('mouseenter', () => {
                    downloadCardEl.style.transform = 'translateY(-2px)';
                    downloadCardEl.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                });
                
                downloadCardEl.addEventListener('mouseleave', () => {
                    downloadCardEl.style.transform = 'translateY(0)';
                    downloadCardEl.style.boxShadow = '';
                });
            }
        })();
    </script>
</body>
</html>

