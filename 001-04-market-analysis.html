<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analysis Â· å¸‚åœºåˆ†æ</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/market-analysis-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/ai-config.js"></script>
    <script src="vendor/ai-prompts.js"></script>
    <script src="vendor/ai-utils.js"></script>
    <script src="vendor/market-analysis-utils.js"></script>
    <script src="vendor/template-utils.js"></script>
    <!-- é¡µé¢ç‰¹å®šæ ·å¼ï¼šå½“å‰æ— ç‰¹æ®Šæ ·å¼ï¼Œæ‰€æœ‰æ ·å¼å·²åœ¨ vendor æ–‡ä»¶ä¸­å®šä¹‰ -->
</head>
<body data-page="001-04-market-analysis.html">
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>ğŸ” è®¿é—®éªŒè¯</h2>
            <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">å§“å *</label>
                    <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
                    <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">æ‰‹æœºå· *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">é‚®ç®± *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
                    <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
                </div>
                <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools001" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
            <a href="001-04-market-analysis-README.html" class="readme-btn">ä½¿ç”¨è¯´æ˜ â†’</a>
            <h1>Market Analysis Â· å¸‚åœºåˆ†æ</h1>
            <p>ä¸€ä»½ Excel ä¸å‘¨æŠ¥å³å¯è”åŠ¨èˆªçº¿ä¾›ç»™ä¸ AI å†³ç­–ï¼Œè½»æ¾å®Œæˆè·¨æ¿å—æ´å¯Ÿ</p>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls top-controls">
                    <label class="file-btn" title="é€‰æ‹©Excelæ–‡ä»¶ï¼šæ–‡ä»¶éœ€åŒ…å« schedule å·¥ä½œè¡¨">
                        é€‰æ‹©Excelæ–‡ä»¶
                        <input id="fileInput" type="file" accept=".xlsx,.xls">
                    </label>
                    <label class="file-btn" title="è½½å…¥å¸‚åœºå‘¨æŠ¥ï¼šæ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä»½ PDFï¼ˆå¦‚ Alphaliner_Newsletterã€Linerlytica Weekly ç­‰ï¼‰ï¼Œç”¨äºè¾…åŠ© AI åˆ†æ">
                        è½½å…¥å¸‚åœºå‘¨æŠ¥ (PDF)
                        <input id="marketReportInput" type="file" accept=".pdf" multiple>
                    </label>
                    <button type="button" class="file-btn" id="exportPdfBtn" title="å¯¼å‡ºåŒ…å«å½“å‰ç­›é€‰è§†å›¾ä¸ AI ç»“è®ºçš„æ•´é¡µ PDF">
                        å¯¼å‡ºæ•´é¡µ PDF
                    </button>
                    <span class="file-hint">
                        é€‰æ‹©Excelæ–‡ä»¶ï¼šæ–‡ä»¶éœ€åŒ…å« schedule å·¥ä½œè¡¨ï¼›
                        è½½å…¥å¸‚åœºå‘¨æŠ¥ï¼šæ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä»½ PDFï¼ˆå¦‚ Alphaliner_Newsletterã€Linerlytica Weekly ç­‰ï¼‰ï¼Œç”¨äºè¾…åŠ© AI åˆ†æã€‚
                    </span>
                </div>
                <div class="market-report-upload">
                    <h5>å¸‚åœºå‘¨æŠ¥åˆ—è¡¨</h5>
                    <ul class="market-report-list" id="marketReportList">
                        <li>å°šæœªè½½å…¥å¸‚åœºæŠ¥å‘Š</li>
                    </ul>
                </div>
            </div>

            <section id="capacityModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 01</span>
                    <div>
                        <h2 class="section-title">èˆªçº¿è¿åŠ›åˆ†æ <span>SAILING SCHEDULE PULSE</span></h2>
                        <p class="module-desc">æ¸¯å£ç­›é€‰è”åŠ¨è¿åŠ›ã€æ´¾èˆ¹ä¸è¶‹åŠ¿ï¼Œç²¾å‡†é”å®šå½“å‘¨+æœªæ¥å››å‘¨ä¾›ç»™</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="capacity">
                    <div class="controls">
                        <div class="view-toggle hidden" id="viewToggle">
                            <label>æ˜¾ç¤ºæ¨¡å¼ï¼š</label>
                            <button id="btnAll" class="active">å…¨éƒ¨</button>
                            <button id="btnCapacity">è¿åŠ›</button>
                            <button id="btnShips">æ´¾èˆ¹</button>
                        </div>
                    </div>
                    <div id="destinationFilters" class="destination-filters hidden">
                        <div class="filter-group">
                            <label for="portSelect">é€‰æ‹©æ¸¯å£</label>
                            <small class="multi-hint">å¯å¤šé€‰ï¼ˆCtrl/ç‚¹å‡»åˆ‡æ¢ï¼‰</small>
                            <select id="portSelect" multiple size="6" class="multi-select">
                                <option value="">å…¨éƒ¨æ¸¯å£</option>
                            </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="portSelectAll">å…¨éƒ¨é€‰æ‹©</button>
                                <button type="button" class="filter-btn" id="portClearAll">æ¸…é™¤é€‰æ‹©</button>
                            </div>
                        </div>
                    </div>
                    <div id="infoBox" class="info-box hidden">
                        <p id="infoText"></p>
                    </div>
                    <div id="tableContainer" class="table-container hidden">
                        <table id="pivotTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div id="chartContainer" class="chart-container hidden">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                            <h3 style="color:#1f2d3d; font-size:20px; letter-spacing:0.5px;">è¿åŠ›ä¸æ´¾èˆ¹è¶‹åŠ¿å›¾</h3>
                            <span style="color:#6c757d; font-size:13px;">é«˜åº¦ Ã—2 å±•ç¤ºï¼Œä¾¿äºå¯¹æ¯”å¤šèˆªçº¿</span>
                        </div>
                        <div id="emptyChartMessage" class="empty-chart-message hidden">
                            è¯·é€‰æ‹©æ¸¯å£ä»¥æŸ¥çœ‹å›¾è¡¨
                        </div>
                        <div class="chart-wrapper hidden" id="chartWrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="aiModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 02</span>
                    <div>
                        <h2 class="section-title">AI è¶‹åŠ¿åˆ†æ <span>AI TREND ANALYSIS</span></h2>
                        <p class="module-desc">DeepSeek Ã— KIMI Ã— é€šä¹‰åƒé—® ä¸‰æ¨¡å‹äº¤å‰éªŒè¯èˆªçº¿ç­–ç•¥ã€ä¾›éœ€ä¸ä»·æ ¼å»ºè®®</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="ai">
                    <div id="aiAnalysisContainer" class="ai-analysis-container">
                        <div class="ai-header">
                            <h3>AI èˆ¹æœŸè¶‹åŠ¿åˆ†æ</h3>
                            <p>åŒä¸€ä»½ç­›é€‰æ•°æ®å¯ç”±å¤šæ¨¡å‹å¹¶è¡Œåˆ†æï¼Œå¿«é€Ÿå¯¹æ¯”è§‚ç‚¹å¹¶äº¤å‰éªŒè¯ç»“è®º</p>
                        </div>
                        <div id="emptyAiMessage" class="empty-chart-message" style="display: none;">
                            è¯·å…ˆåŠ è½½æ•°æ®æ–‡ä»¶å¹¶é€‰æ‹©ç­›é€‰æ¡ä»¶ä»¥å¯ç”¨ AI åˆ†æ
                        </div>
                        <div id="aiConfigSection" style="display: none;">
                            <!-- å…¶ä»–å½±å“å› ç´ è¡¨æ ¼ - ä½¿ç”¨å…¬å…±æ¨¡æ¿ï¼ˆvendor/template-utils.jsï¼‰ -->
                            <div id="bookingDataTableContainer"></div>
                            <!-- å¸‚åœºæ•°æ®ä¿¡æ¯å— - ä½¿ç”¨å…¬å…±æ¨¡æ¿ï¼ˆvendor/template-utils.jsï¼‰ -->
                            <div id="marketDataInfoBlocksContainer"></div>
                            <!-- AI é…ç½®é¢æ¿ - ä½¿ç”¨å…¬å…±æ¨¡æ¿ï¼ˆvendor/template-utils.jsï¼‰ -->
                            <div id="aiConfigPanelsContainer"></div>
                            </div>
    </div>
    </div>
    <div class="page-footer">
        <h2>Market Analysis Â· å¸‚åœºåˆ†æä½¿ç”¨å£°æ˜</h2>
        <p>èµ„æ–™æ•´åˆè‡ªç”¨æˆ· Excelã€ç”¨æˆ·è½½å…¥å¸‚åœºå‘¨æŠ¥ã€Ship & Bunkerã€ä¸Šæµ·èˆªè¿äº¤æ˜“æ‰€ã€Drewryã€Freightos ç­‰å…¬å¼€æ¸ é“ï¼Œä»…ä¾›å†…éƒ¨ç ”åˆ¤ï¼Œä¸æ„æˆå¯¹å¤–æŠ¥ä»·æˆ–æŠ•èµ„å»ºè®®ã€‚</p>
        <p>AI æœåŠ¡ç”± DeepSeek / KIMI / é€šä¹‰åƒé—® API é©±åŠ¨ï¼Œæ‰€æœ‰è°ƒç”¨è´¹ç”¨ä¸åˆè§„è´£ä»»ç”±ä½¿ç”¨è€…è‡ªæ‹…ï¼Œæ¶‰åŠå®¢æˆ·æˆ–æ•æ„Ÿæ•°æ®æ—¶è¯·å…ˆå®Œæˆè„±æ•å¤„ç†ã€‚</p>
    </div>
    <!-- ä½¿ç”¨ Gist å­˜å‚¨ç³»ç»Ÿï¼ˆç”¨æˆ·ç™½åå• + è®¿é—®è®°å½•ï¼‰ -->
    <script src="vendor/auth-gist.js"></script>
    <script>

        // ==================== è°ƒè¯•æ¨¡å¼ ====================
        // è°ƒè¯•å‡½æ•°å·²ç»Ÿä¸€åˆ° vendor/debug-utils.js
        // ä½¿ç”¨ï¼šdebugLog(), debugWarn(), debugError()

        // ==================== é”™è¯¯å¤„ç† ====================
        // é”™è¯¯å¤„ç†å·²ç»Ÿä¸€åˆ° vendor/error-handler.js
        // ä½¿ç”¨ï¼šshowError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED')
        // ErrorType å’Œ showError å‡½æ•°å·²ä» error-handler.js åŠ è½½

        let pdfJsReady = false;
        let pdfJsLoadingPromise = null;

        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            // ä¼˜å…ˆä½¿ç”¨æœ¬åœ° workerï¼Œå¤±è´¥æ—¶ä½¿ç”¨ CDN
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'vendor/pdf.worker.min.js';
            } catch (e) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            pdfJsReady = true;
        }

        const loadedScripts = new Set();
        const loadedWorkers = new Map();

        // loadScript, loadWorkerAsBlob, ensurePdfJsLoaded å·²ä» vendor/market-analysis-utils.js åŠ è½½

        let marketReports = [];
        let bunkerData = null;
        let wciData = null;
        let fbxData = null;
        let scfiData = null;
        const excelLoadState = { schedule: false };
        let modulesVisible = false;

        const fileInput = document.getElementById('fileInput');
        const marketReportInput = document.getElementById('marketReportInput');
        const marketReportList = document.getElementById('marketReportList');
        // çŠ¶æ€å…ƒç´ å¼•ç”¨å°†åœ¨æ¨¡æ¿ç”Ÿæˆåé‡æ–°è·å–ï¼ˆåœ¨ window.addEventListener('load') ä¸­ï¼‰
        // ä½¿ç”¨ let ä»¥ä¾¿åœ¨æ¨¡æ¿ç”Ÿæˆåæ›´æ–°
        let bunkerStatusEl = null;
        let bunkerUpdatedEl = null;
        let wciStatusEl = null;
        let wciUpdatedEl = null;
        let fbxStatusEl = null;
        let fbxUpdatedEl = null;

        // renderMarketReportList å·²ä» vendor/market-analysis-utils.js åŠ è½½
        renderMarketReportList();

        // è‡ªåŠ¨åŠ è½½ Data ç›®å½•ä¸‹çš„ Excel æ–‡ä»¶
        // ä½¿ç”¨å…¬å…±å‡½æ•°åŠ è½½ Excel æ–‡ä»¶ï¼ˆä» vendor/common-utils.jsï¼‰
        async function loadExcelFile() {
            await window.loadDefaultExcelFile('001-04-market-analysis', async (file) => {
                // ç›´æ¥è°ƒç”¨å¤„ç†å‡½æ•°ï¼ˆæ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©ï¼‰
                if (typeof XLSX === 'undefined') {
                    showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                    return;
                }

                try {
                    const data = await readExcelFile(file);
                    scheduleData = data;
                    generatePivotTable(data);
                    const infoText = document.getElementById('infoText');
                    const infoBox = document.getElementById('infoBox');
                    if (infoText) infoText.textContent = `å·²åŠ è½½ ${data.length} æ¡èˆ¹æœŸæ•°æ®`;
                    if (infoBox) infoBox.classList.remove('hidden');
                    excelLoadState.schedule = true;
                    tryRevealModules();
                } catch (error) {
                    showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                    debugError(error);
                }
            });
        }
        
        // è‡ªåŠ¨åŠ è½½ linerlytica ç›®å½•ä¸‹çš„å¸‚åœºå‘¨æŠ¥ PDF æ–‡ä»¶
        // ä½¿ç”¨å…¬å…±å‡½æ•°åŠ è½½å¸‚åœºå‘¨æŠ¥ PDF æ–‡ä»¶ï¼ˆä» vendor/common-utils.jsï¼‰
        async function loadMarketReports() {
            if (marketReportList) {
                marketReportList.innerHTML = '<li>æ­£åœ¨è‡ªåŠ¨åŠ è½½å¸‚åœºå‘¨æŠ¥...</li>';
            }
            
            await window.loadDefaultMarketReports(async (file) => {
                await handleMarketReportFile(file);
                // æ£€æŸ¥æ˜¯å¦æå–åˆ° SCFI æ•°æ®
                const latestReport = marketReports[marketReports.length - 1];
                if (latestReport) {
                    if (latestReport.scfiData) {
                        scfiData = latestReport.scfiData;
                        renderScfiTable(latestReport.scfiData, file.name);
                    } else {
                        // å°è¯•æ‰‹åŠ¨æå–
                        try {
                            const fullText = latestReport.text;
                            if (fullText) {
                                const extractedScfi = parseScfiTable(fullText);
                                if (extractedScfi) {
                                    scfiData = extractedScfi;
                                    renderScfiTable(extractedScfi, file.name);
                                }
                            }
                        } catch (e) {
                            // å¿½ç•¥æå–é”™è¯¯
                        }
                    }
                }
            });
            
            // æ›´æ–°å¸‚åœºå‘¨æŠ¥åˆ—è¡¨æ˜¾ç¤º
            renderMarketReportList();
        }

        // ç­‰å¾… XLSX å’Œ PDF.js åº“åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ–‡ä»¶
        if (typeof window.ensureXlsx === 'function') {
            window.ensureXlsx().then(async () => {
                await loadExcelFile();
                // ç­‰å¾… PDF.js åŠ è½½å®Œæˆåå†åŠ è½½å¸‚åœºå‘¨æŠ¥
                if (typeof window.ensurePdfJsLoaded === 'function') {
                    await window.ensurePdfJsLoaded();
                }
                // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿ PDF.js å®Œå…¨åˆå§‹åŒ–
                setTimeout(() => {
                    loadMarketReports();
                }, 500);
            });
        } else {
            // å¦‚æœ ensureXlsx ä¸å­˜åœ¨ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åå°è¯•åŠ è½½
            setTimeout(async () => {
                if (typeof XLSX !== 'undefined') {
                    await loadExcelFile();
                    if (typeof window.ensurePdfJsLoaded === 'function') {
                        await window.ensurePdfJsLoaded();
                    }
                    setTimeout(() => {
                        loadMarketReports();
                    }, 500);
                }
            }, 1000);
        }
        function tryRevealModules() {
            if (modulesVisible) return;
            if (excelLoadState.schedule) {
                // åªæ˜¾ç¤ºç­›é€‰æ§ä»¶ï¼Œæ¨¡å—æ ‡é¢˜å§‹ç»ˆæ˜¾ç¤º
                const destinationFiltersPanel = document.getElementById('destinationFilters');
                if (destinationFiltersPanel) destinationFiltersPanel.classList.remove('hidden');
                
                const viewToggle = document.getElementById('viewToggle');
                if (viewToggle) viewToggle.classList.remove('hidden');

                document.querySelectorAll('.module-card').forEach(card => {
                    card.classList.remove('hidden');
                });
                
                modulesVisible = true;
            }
        }

        // æŒ‰é’®äº‹ä»¶ç»‘å®šå·²ç§»è‡³ initMarketAnalysisPage å‡½æ•°ä¸­ï¼ˆæ¨¡æ¿ç”Ÿæˆåï¼‰

        const CACHE_KEYS = {
            wci: 'wciDataCache',
            fbx: 'fbxDataCache'
        };

        // escapeRegex, computePercentChange, formatPercent, loadCachedData, saveCachedData å·²ä» vendor/common-utils.js åŠ è½½
        // applyWoWFromCache, extractTextFromPdf, handleMarketReportFile, parseScfiTable, buildScfiDataSection å·²ä» vendor/market-analysis-utils.js åŠ è½½

        // æ³¨å†Œ SCFI æ•°æ®æå–å›è°ƒ
        window.onScfiDataExtracted = (data, fileName) => {
            scfiData = data;
            renderScfiTable(data, fileName);
        };

        if (marketReportInput) {
            marketReportInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                if (marketReportList) {
                    marketReportList.innerHTML = '<li>æ­£åœ¨è§£æè½½å…¥çš„æŠ¥å‘Š...</li>';
                }
                for (const file of files) {
                    try {
                        await handleMarketReportFile(file);
                        // æ£€æŸ¥æ˜¯å¦æå–åˆ° SCFI æ•°æ®
                        const latestReport = marketReports[marketReports.length - 1];
                        if (latestReport) {
                            debugLog('å¸‚åœºæŠ¥å‘Šè§£æå®Œæˆ:', {
                                name: latestReport.name,
                                hasScfiData: !!latestReport.scfiData,
                                scfiData: latestReport.scfiData
                            });
                            if (latestReport.scfiData) {
                                scfiData = latestReport.scfiData;
                                renderScfiTable(latestReport.scfiData, file.name);
                            } else {
                                debugWarn('æœªæ‰¾åˆ° SCFI æ•°æ®ï¼Œå°è¯•æ‰‹åŠ¨æå–...');
                                // å¦‚æœè‡ªåŠ¨æå–å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä»å…¨æ–‡æå–
                                try {
                                    const fullText = latestReport.text;
                                    if (fullText) {
                                        const extractedScfi = parseScfiTable(fullText);
                                        if (extractedScfi) {
                                            debugLog('æ‰‹åŠ¨æå– SCFI æ•°æ®æˆåŠŸ:', extractedScfi);
                                            scfiData = extractedScfi;
                                            latestReport.scfiData = extractedScfi;
                                            renderScfiTable(extractedScfi, file.name);
                                        } else {
                                            debugWarn('æ‰‹åŠ¨æå–ä¹Ÿå¤±è´¥ï¼Œæ–‡æœ¬å†…å®¹:', fullText.substring(0, 500));
                                        }
                                    }
                                } catch (extractError) {
                                    debugError('æ‰‹åŠ¨æå– SCFI å¤±è´¥:', extractError);
                                }
                            }
                        }
                    } catch (error) {
                        debugError('è§£æPDFå¤±è´¥:', error);
                        showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', { message: error.message || String(error) }, error);
                    }
                }
                renderMarketReportList();
                marketReportInput.value = '';
            });
        }

        /**
         * æ¸²æŸ“ SCFI è¡¨æ ¼
         * @param {Object} data - SCFI æ•°æ®
         * @param {string} source - æ•°æ®æ¥æºæ–‡ä»¶å
         */
        function renderScfiTable(data, source) {
            const container = document.getElementById('scfiTableContainer');
            const sourceEl = document.getElementById('scfiSource');
            const infoContainer = document.getElementById('scfiInfoContainer');
            
            if (!container || !infoContainer) {
                debugWarn('SCFI è¡¨æ ¼å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            debugLog('æ¸²æŸ“ SCFI è¡¨æ ¼ï¼Œæ•°æ®:', data);
            
            if (!data || (!data.index && (!data.routes || data.routes.length === 0))) {
                debugWarn('SCFI æ•°æ®ä¸ºç©ºï¼Œéšè—è¡¨æ ¼');
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            let html = '<table class="scfi-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; table-layout: fixed;">';
            
            // è¡¨å¤´
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; text-align: left; border: 1px solid #ddd; width: 15%;">èˆªçº¿</th>';
            html += '<th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 5%;">å•ä½</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">å½“æœŸæŒ‡æ•°</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸ŠæœŸæŒ‡æ•°</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸ŠæœŸå¯¹æ¯”%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸ŠæœˆæŒ‡æ•°</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸Šæœˆå¯¹æ¯”%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸Šå­£åº¦æŒ‡æ•°</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸Šå­£åº¦å¯¹æ¯”%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸Šå¹´æŒ‡æ•°</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">ä¸Šå¹´å¯¹æ¯”%</th>';
            html += '</tr>';
            
            // SCFI ç»¼åˆæŒ‡æ•°è¡Œï¼ˆä½œä¸ºç¬¬ä¸€è¡Œæ•°æ®ï¼Œåœ¨è¡¨å¤´ä¸‹é¢ï¼‰
            if (data.index) {
                const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : 'â€”';
                const formatPercent = (val) => {
                    if (val === null || val === undefined) return 'â€”';
                    const sign = val >= 0 ? '+' : '';
                    return sign + val.toFixed(1) + '%';
                };
                
                html += '<tr style="background: #f9f9f9; font-weight: bold;">';
                html += '<td style="padding: 8px; border: 1px solid #ddd;">SCFI ç»¼åˆæŒ‡æ•°</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">â€”</td>'; // å•ä½åˆ—
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.index) + '</td>';
                // ä¸ŠæœŸæŒ‡æ•° = 1å‘¨æŒ‡æ•° (indexWeek1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexWeek1) + '</td>';
                // ä¸ŠæœŸå¯¹æ¯”% = 1å‘¨å˜åŒ–% (indexWeek1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexWeek1Change) + '</td>';
                // ä¸ŠæœˆæŒ‡æ•° = 1ä¸ªæœˆæŒ‡æ•° (indexMonth1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexMonth1) + '</td>';
                // ä¸Šæœˆå¯¹æ¯”% = 1ä¸ªæœˆå˜åŒ–% (indexMonth1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexMonth1Change) + '</td>';
                // ä¸Šå­£åº¦æŒ‡æ•° = 3ä¸ªæœˆæŒ‡æ•° (indexQuarter3)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexQuarter3) + '</td>';
                // ä¸Šå­£åº¦å¯¹æ¯”% = 3ä¸ªæœˆå˜åŒ–% (indexQuarter3Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexQuarter3Change) + '</td>';
                // ä¸Šå¹´æŒ‡æ•° = 1å¹´æŒ‡æ•° (indexYear1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexYear1) + '</td>';
                // ä¸Šå¹´å¯¹æ¯”% = 1å¹´å˜åŒ–% (indexYear1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexYear1Change) + '</td>';
                html += '</tr>';
            }
            
            if (data.routes && data.routes.length > 0) {
                // æ•°æ®è¡Œ
                data.routes.forEach(route => {
                    const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : 'â€”';
                    const formatPercent = (val) => {
                        if (val === null || val === undefined) return 'â€”';
                        const sign = val >= 0 ? '+' : '';
                        return sign + val.toFixed(1) + '%';
                    };
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯India/East Africa/Central Americaï¼Œè¿™äº›èˆªçº¿æ²¡æœ‰ä¸Šå¹´æ•°æ®
                    const routeNameLower = (route.name || '').toLowerCase();
                    const hasNoYearData = routeNameLower.includes('india') || 
                                         routeNameLower.includes('nhava sheva') ||
                                         routeNameLower.includes('east africa') ||
                                         routeNameLower.includes('mombasa') ||
                                         routeNameLower.includes('central america') ||
                                         routeNameLower.includes('manzanillo');
                    
                    html += '<tr>';
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd;">${route.name}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">${route.unit || 'â€”'}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.current)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.week1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.week1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.month1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.month1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.quarter3Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.quarter3Change)}</td>`;
                    // å¦‚æœæ˜¯India/East Africa/Central Americaï¼Œä¸Šå¹´æ•°æ®æ˜¾ç¤ºä¸º"â€”"
                    if (hasNoYearData) {
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">â€”</td>';
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">â€”</td>';
                    } else {
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.year1Price)}</td>`;
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.year1Change)}</td>`;
                    }
                    html += '</tr>';
                });
            }
            
            html += '</table>';
            container.innerHTML = html;
            
            if (sourceEl) {
                sourceEl.textContent = `æ•°æ®æ¥æºï¼š${source}`;
            }
        }

    </script>

    <script>
        let scheduleData = [];
        let processedRecords = [];
        let groupedTableData = [];
        let latestFilteredRecords = [];
        let availablePorts = [];
        let destinationFilters = {
            ports: []
        };
        let currentView = 'all'; // 'all', 'capacity', 'ships'
        let weekColumns = []; // 5å‘¨çš„å‘¨åˆ«
        let capacityChart = null; // Chart.jså®ä¾‹
        let routeFilterValue = '';
        let routeLabelMap = {};

        const infoBox = document.getElementById('infoBox');
        const infoText = document.getElementById('infoText');
        const tableContainer = document.getElementById('tableContainer');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const viewToggle = document.getElementById('viewToggle');
        const btnAll = document.getElementById('btnAll');
        const btnCapacity = document.getElementById('btnCapacity');
        const btnShips = document.getElementById('btnShips');
        const destinationFiltersPanel = document.getElementById('destinationFilters');
        const portSelect = document.getElementById('portSelect');
        const portSelectAllBtn = document.getElementById('portSelectAll');
        const portClearAllBtn = document.getElementById('portClearAll');

        // getSelectedValues å’Œ setupMultiSelect å·²ä» vendor/common-utils.js åŠ è½½

        // normalizeDestinationValue, populateSelect, registerRouteLabel, getRouteLabel å·²ä» vendor/market-analysis-utils.js åŠ è½½

        // STANDARD_PORT_ORDER å·²ä» vendor/market-analysis-utils.js åŠ è½½

        function refreshAvailablePorts() {
            const portSet = new Set();
            processedRecords.forEach(record => {
                const port = record.port || '';
                if (port && port !== 'æœªåˆ†é…' && port.trim()) {
                    portSet.add(port);
                }
            });
            const ports = Array.from(portSet);
            // ä½¿ç”¨æ ‡å‡†æ¸¯å£é¡ºåºæ’åºï¼ˆä¸¥æ ¼æŒ‰ç…§ STANDARD_PORT_ORDER çš„é¡ºåºï¼‰
            if (typeof sortPortsByStandardOrder === 'function') {
                availablePorts = sortPortsByStandardOrder(ports);
            } else if (typeof STANDARD_PORT_ORDER !== 'undefined') {
                // å¦‚æœ sortPortsByStandardOrder ä¸å¯ç”¨ï¼Œæ‰‹åŠ¨æ’åº
                const portOrderMap = new Map();
                STANDARD_PORT_ORDER.forEach((port, index) => {
                    portOrderMap.set(port, index);
                });
                availablePorts = ports.sort((a, b) => {
                    const indexA = portOrderMap.has(a) ? portOrderMap.get(a) : Infinity;
                    const indexB = portOrderMap.has(b) ? portOrderMap.get(b) : Infinity;
                    if (indexA !== Infinity && indexB !== Infinity) {
                        return indexA - indexB;
                    }
                    if (indexA !== Infinity) return -1;
                    if (indexB !== Infinity) return 1;
                    return a.localeCompare(b, 'zh-Hans-CN');
                });
            } else {
                availablePorts = ports.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            }
        }

        function updatePortFilterOptions() {
            refreshAvailablePorts();
            // availablePorts å·²ç»åœ¨ refreshAvailablePorts ä¸­æ’åºè¿‡äº†ï¼Œè¿™é‡Œä¸éœ€è¦å†æ¬¡æ’åº
            // ä½†ä¸ºäº†ç¡®ä¿é¡ºåºæ­£ç¡®ï¼Œä»ç„¶ä¼ å…¥ usePortOrder=true
            populateSelect(
                portSelect,
                availablePorts,
                'å…¨éƒ¨æ¸¯å£',
                destinationFilters.ports,
                availablePorts.length === 0,
                true  // ä½¿ç”¨æ ‡å‡†æ¸¯å£é¡ºåº
            );
        }

        function getCurrentGroupLevel() {
            return destinationFilters.ports.length > 0 ? 1 : 0;
        }

        function getFilteredRecords() {
            const routeFilterText = routeFilterValue.trim().toLowerCase();
            const filtered = processedRecords.filter(record => {
                if (destinationFilters.ports.length && !destinationFilters.ports.includes(record.port)) return false;
                if (routeFilterText) {
                    const routeText = String(record.routeLabel || record.route || '').toLowerCase();
                    if (!routeText.includes(routeFilterText)) return false;
                }
                return true;
            });
            // ç»Ÿä¸€å»é‡ï¼ˆä½¿ç”¨ vendor ä¸­çš„æ ‡å‡†å‡½æ•°ï¼‰
            if (typeof deduplicateSailingItems === 'function') {
                return deduplicateSailingItems(filtered);
            }
            return filtered;
        }

        // buildShipSignature å·²ä» vendor/market-analysis-utils.js åŠ è½½

        // buildDedupKey å·²ä¸å†ç”¨äºå»é‡ï¼ˆæ”¹ç”¨ deduplicateSailingItemsï¼‰

        function groupRecords(records, groupByPort = false) {
            const groups = new Map();

            records.forEach(record => {
                const port = record.port || 'æœªåˆ†é…';
                const routeLabel = record.routeLabel || record.route || 'æœªçŸ¥èˆªçº¿';
                const routeKey = record.routeId || routeLabel;
                const routeRemark = record.routeRemark || '';
                // å¦‚æœ groupByPort ä¸º trueï¼ŒæŒ‰æ¸¯å£+èˆªçº¿åˆ†ç»„ï¼›å¦åˆ™åªæŒ‰èˆªçº¿åˆ†ç»„ï¼ˆåˆå¹¶ä¸åŒæ¸¯å£ï¼‰
                const key = groupByPort ? `${port}|${routeKey}` : routeKey;

                if (!groups.has(key)) {
                    groups.set(key, {
                        port: groupByPort ? port : '', // å¦‚æœä¸æŒ‰æ¸¯å£åˆ†ç»„ï¼Œport è®¾ä¸ºç©ºå­—ç¬¦ä¸²
                        routeLabel,
                        routeId: record.routeId || '',
                        routeRemark,
                        weeks: {}
                    });
                }

                const group = groups.get(key);
                if (!group.weeks[record.weekCode]) {
                    group.weeks[record.weekCode] = [];
                }

                const entries = group.weeks[record.weekCode];
                // å¦‚æœä¸æŒ‰æ¸¯å£åˆ†ç»„ï¼Œå»é‡æ—¶åªè€ƒè™‘èˆ¹åèˆªæ¬¡+è¿åŠ›+æ—¥æœŸï¼Œä¸è€ƒè™‘æ¸¯å£
                // å¦‚æœæŒ‰æ¸¯å£åˆ†ç»„ï¼Œå»é‡æ—¶è€ƒè™‘æ¸¯å£+èˆ¹åèˆªæ¬¡+è¿åŠ›+æ—¥æœŸ
                const dedupKey = groupByPort ? buildDedupKey(record) : buildShipSignature(record);
                const exists = entries.some(item => {
                    // ç»Ÿä¸€ä½¿ç”¨ dedupKey è¿›è¡Œæ¯”è¾ƒï¼Œç¡®ä¿æ—¥æœŸæ ¼å¼ä¸€è‡´
                    // buildShipSignature å·²ç»ç»Ÿä¸€æ ¼å¼åŒ–äº†æ—¥æœŸä¸º YYYY/MM/DD
                    return item.dedupKey === dedupKey;
                });
                if (exists) {
                    return;
                }
                entries.push({
                    capacity: record.capacity,
                    shipName: record.shipName,
                    shipDate: record.shipDate,
                    routeId: record.routeId || '',
                    dedupKey: dedupKey
                });
            });

            const sorted = Array.from(groups.values()).sort((a, b) => {
                // å¦‚æœæŒ‰æ¸¯å£åˆ†ç»„ï¼Œå…ˆæŒ‰æ¸¯å£æ’åºï¼›å¦åˆ™åªæŒ‰èˆªçº¿æ’åº
                if (groupByPort && (a.port || '') !== (b.port || '')) {
                    return (a.port || '').localeCompare(b.port || '');
                }
                return (a.routeLabel || '').localeCompare(b.routeLabel || '');
            });

            return {
                data: sorted
            };
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // æ£€æŸ¥ XLSX æ˜¯å¦å·²åŠ è½½
            if (typeof XLSX === 'undefined') {
                showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                return;
            }

            try {
                const data = await readExcelFile(file);
                scheduleData = data;
                generatePivotTable(data);
                infoText.textContent = `å·²åŠ è½½ ${data.length} æ¡èˆ¹æœŸæ•°æ®`;
                infoBox.classList.remove('hidden');
                excelLoadState.schedule = true;
                tryRevealModules();
            } catch (error) {
                showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                debugError(error);
            }
        });

        btnAll.addEventListener('click', () => {
            currentView = 'all';
            btnAll.classList.add('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnCapacity.addEventListener('click', () => {
            currentView = 'capacity';
            btnAll.classList.remove('active');
            btnCapacity.classList.add('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnShips.addEventListener('click', () => {
            currentView = 'ships';
            btnAll.classList.remove('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.add('active');
            renderTable();
        });

        if (portSelect) {
            setupMultiSelect(portSelect);
            portSelect.addEventListener('change', () => {
                destinationFilters.ports = getSelectedValues(portSelect);
                renderTable();
            });
        }
        if (portSelectAllBtn && portClearAllBtn && portSelect) {
            portSelectAllBtn.addEventListener('click', () => selectAllOptions(portSelect));
            portClearAllBtn.addEventListener('click', () => clearSelectOptions(portSelect));
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false });
                        
                        // æŸ¥æ‰¾ schedule å·¥ä½œè¡¨
                        const sheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('schedule')
                        ) || workbook.SheetNames[0];
                        
                        const worksheet = workbook.Sheets[sheetName];
                        // ä½¿ç”¨ raw: true ä¿ç•™åŸå§‹ç±»å‹ï¼ˆDateå¯¹è±¡ã€æ•°å­—ç­‰ï¼‰ï¼Œä»¥ä¾¿æ­£ç¡®è§£æMåˆ—çš„æ—¥æœŸæ•°æ®
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: null, dateNF: 'yyyy/mm/dd' });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // å°†å‘¨åˆ«æ–‡æœ¬è½¬æ¢ä¸ºYYYYWWæ ¼å¼ï¼ˆå¦‚ï¼š202547ï¼‰
        // parseWeekText, getCurrentWeekCode, getWeekRange, getWeekNumber, getISOWeek, getWeekDateRange å·²ä» vendor/market-analysis-utils.js åŠ è½½


        function generatePivotTable(data) {
            if (!data || data.length === 0) {
                showError(ErrorType.DATA_VALIDATION, 'DATA_EMPTY');
                return;
            }

            const firstRow = data[0];
            const columnKeys = Object.keys(firstRow);

            const matchesKeyword = (key, keyword) => {
                if (!key) return false;
                const lowerKey = key.toLowerCase();
                return lowerKey.includes(keyword.toLowerCase()) || key.includes(keyword);
            };

            const columnLetterToIndex = (letter) => {
                if (!letter) return null;
                let index = 0;
                const up = letter.trim().toUpperCase();
                for (let i = 0; i < up.length; i++) {
                    const charCode = up.charCodeAt(i);
                    if (charCode < 65 || charCode > 90) return null;
                    index = index * 26 + (charCode - 64);
                }
                return index - 1;
            };

            const getColumnKey = (keywords, fallbackLetter = null) => {
                const key = columnKeys.find(col =>
                    keywords.some(keyword => matchesKeyword(col, keyword))
                );
                if (key) return key;
                if (fallbackLetter) {
                    const idx = columnLetterToIndex(fallbackLetter);
                    if (idx !== null && columnKeys[idx]) {
                        return columnKeys[idx];
                    }
                }
                return null;
            };

            const weekCol = getColumnKey(['å‘¨åˆ«', 'å‘¨æ¬¡', 'å‘¨æ•°', 'week'], 'R');
            const capacityCol = getColumnKey(['è¿åŠ›', 'teu', 'èˆ±ä½'], 'L');
            // å¼ºåˆ¶ä½¿ç”¨ K åˆ—ï¼ˆç´¢å¼•10ï¼‰ä½œä¸ºèˆ¹åèˆªæ¬¡åˆ—
            // å…ˆé€šè¿‡ç´¢å¼•è·å–ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åˆ—
            const kIndex = columnLetterToIndex('K'); // Kåˆ— = ç´¢å¼•10
            const shipNameCol = (kIndex !== null && columnKeys[kIndex]) ? columnKeys[kIndex] : getColumnKey(['èˆ¹å', 'èˆªæ¬¡', 'vessel'], 'K');
            // å¼ºåˆ¶ä½¿ç”¨ M åˆ—ï¼ˆç´¢å¼•12ï¼‰ä½œä¸ºå¼€èˆ¹æ—¥æœŸåˆ—
            // å…ˆé€šè¿‡ç´¢å¼•è·å–ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åˆ—
            const mIndex = columnLetterToIndex('M'); // Måˆ— = ç´¢å¼•12
            const shipDateCol = (mIndex !== null && columnKeys[mIndex]) ? columnKeys[mIndex] : getColumnKey(['å¼€èˆ¹', 'èˆ¹æœŸ', 'ç¦»æ¸¯', 'etd', 'æ—¶é—´'], 'M');
            const routeIdCol = getColumnKey(['èˆªçº¿id', 'èˆªçº¿ID', 'route id', 'group_id', 'groupid'], 'C');
            const routeCol = getColumnKey(['å…±èˆ±èˆ¹å…¬å¸', 'å…±èˆ±', 'èˆ±å…¬å¸', 'èˆ¹å…¬å¸'], 'G');
            const portCol = getColumnKey(['æ¸¯å£', 'ç›®çš„æ¸¯', 'pod'], 'B');
            const routeRemarkCol = columnKeys[7] || null; // Håˆ—ï¼ˆç´¢å¼•7ï¼‰

            if (!weekCol || !capacityCol || !shipNameCol || !shipDateCol || !routeCol || !portCol) {
                showError(ErrorType.FILE_PARSE, 'MISSING_COLUMNS', { columns: columnKeys.join(', ') });
                return;
            }

            // å›ºå®šæ˜¾ç¤ºå½“å‘¨+æœªæ¥4å‘¨ï¼ˆå…±5å‘¨ï¼‰
            const weekCodes = getWeekRange();
            weekColumns = weekCodes.map(code => {
                const year = code.substring(0, 4);
                const weekNo = parseInt(code.substring(4), 10);
                const dateRange = getWeekDateRange(code);
                return {
                    code,
                    label: `${year}/${String(weekNo).padStart(2, '0')}`,
                    range: dateRange.range
                };
            });

            processedRecords = [];
            destinationFilters = { ports: [] };
            routeFilterValue = '';
            routeLabelMap = {};

            data.forEach(row => {
                const weekText = String(row[weekCol] ?? '').trim();
                const weekCode = parseWeekText(weekText);
                if (!weekCode || !weekCodes.includes(weekCode)) {
                    return;
                }

                // ä½¿ç”¨ normalizePortName è¿›è¡Œæ¸¯å£åç§°åŒ¹é…ï¼ˆä¸ Monitor-Sailing-Schedule ä¿æŒä¸€è‡´ï¼‰
                const rawPort = row[portCol];
                const port = (typeof normalizePortName === 'function')
                    ? normalizePortName(rawPort ? String(rawPort).trim() : '')
                    : normalizeDestinationValue(rawPort);
                let route = String(row[routeCol] ?? '').trim();
                const routeId = routeIdCol ? String(row[routeIdCol] ?? '').trim() : '';
                const routeRemark = routeRemarkCol ? String(row[routeRemarkCol] ?? '').trim() : '';
                const capacity = parseFloat(row[capacityCol]) || 0;
                const shipName = String(row[shipNameCol] ?? '').trim();
                // ä¿ç•™åŸå§‹å€¼ï¼Œå¯èƒ½æ˜¯æ•°å­—ï¼ˆExcelæ—¥æœŸåºåˆ—å·ï¼‰ã€Dateå¯¹è±¡æˆ–å­—ç¬¦ä¸²
                let shipDate = row[shipDateCol];
                // å¦‚æœæ˜¯ null æˆ– undefinedï¼Œè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²
                if (shipDate === null || shipDate === undefined) {
                    shipDate = '';
                }
                // å¦‚æœæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¿æŒä¸ºç©ºå­—ç¬¦ä¸²
                // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œä¿ç•™åŸå§‹ç±»å‹ä»¥ä¾¿åç»­è§£æ

                if (!route) {
                    route = 'æœªçŸ¥èˆªçº¿';
                }

                if (routeId) {
                    if (route && route !== 'æœªçŸ¥èˆªçº¿') {
                        registerRouteLabel(routeId, route);
                    }
                    route = getRouteLabel(routeId, route);
                }

                const record = {
                    port,
                    route,
                    routeId,
                    routeRemark,
                    weekCode,
                    capacity,
                    shipName,
                    shipDate
                };
                processedRecords.push(record);
            });

            processedRecords = processedRecords.map(record => ({
                ...record,
                routeLabel: getRouteLabel(record.routeId, record.route)
            }));
            if (processedRecords.length === 0) {
                showError(ErrorType.FILE_PARSE, 'NO_SCHEDULE_DATA');
                return;
            }

            updatePortFilterOptions();
            renderTable();
            updateAiAnalysis(false);
        }

        function renderTable() {
            if (!processedRecords.length) {
                tableContainer.classList.add('hidden');
                updateChart(false, []);
                updateAiAnalysis(false);
                return;
            }

            const filteredRecords = getFilteredRecords();
            latestFilteredRecords = filteredRecords;
            // æ— è®ºæ˜¯å¦é€‰æ‹©æ¸¯å£ï¼Œéƒ½æŒ‰èˆªçº¿åˆ†ç»„ï¼ˆåˆå¹¶ä¸åŒæ¸¯å£ï¼‰ï¼Œè¿™æ ·åŒä¸€èˆ¹åèˆªæ¬¡åœ¨ä¸åŒæ¸¯å£æ—¶ä¸ä¼šé‡å¤ç»Ÿè®¡
            const hasPortSelection = destinationFilters.ports.length > 0;
            const groupedResult = groupRecords(filteredRecords, false); // å§‹ç»ˆä¸æŒ‰æ¸¯å£åˆ†ç»„ï¼Œåˆå¹¶ç›¸åŒèˆªçº¿
            const groupedData = groupedResult.data;
            groupedTableData = groupedData;

            const safeRouteValue = (routeFilterValue || '').replace(/"/g, '&quot;');

            tableHead.innerHTML = `
                <tr>
                    <th class="filter-header" style="width: 200px;">èˆªçº¿å¤‡æ³¨</th>
                    <th class="filter-header">
                        å…±èˆ±èˆ¹å…¬å¸
                        <input type="text" class="filter-input" id="routeFilter" placeholder="ç­›é€‰å…±èˆ±èˆ¹å…¬å¸..." value="${safeRouteValue}" autocomplete="off">
                    </th>
                    ${weekColumns.map(week => `
                        <th class="week-header week-cell">
                            <div>${week.label}</div>
                            ${week.range ? `<div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">(${week.range})</div>` : ''}
                        </th>
                    `).join('')}
                </tr>
            `;

            const routeFilter = document.getElementById('routeFilter');
            if (routeFilter) {
                let composing = false;
                const newRouteFilter = routeFilter.cloneNode(true);
                routeFilter.parentNode.replaceChild(newRouteFilter, routeFilter);
                newRouteFilter.addEventListener('compositionstart', function() {
                    composing = true;
                });
                newRouteFilter.addEventListener('compositionend', function() {
                    composing = false;
                    routeFilterValue = this.value;
                    setTimeout(() => {
                        renderTable();
                    }, 0);
                });
                newRouteFilter.addEventListener('input', function() {
                    if (!composing) {
                        routeFilterValue = this.value;
                        clearTimeout(newRouteFilter._inputTimeout);
                        newRouteFilter._inputTimeout = setTimeout(() => {
                            renderTable();
                        }, 300);
                    }
                });
            }

            tableBody.innerHTML = '';
            groupedData.forEach(item => {
                const row = document.createElement('tr');
                const cells = [
                    `<td>${item.routeRemark || 'â€”'}</td>`,
                    `<td>${item.routeLabel || 'æœªçŸ¥èˆªçº¿'}</td>`
                ];

                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    
                    // è®¡ç®—è¯¥å‘¨çš„è¿åŠ›å’Œæ´¾èˆ¹æ•°
                    const totalCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    const shipCount = ships.length;
                    
                    // æ„å»ºtooltipå†…å®¹ï¼ˆèˆ¹åèˆªæ¬¡ã€è¿åŠ›å’Œå¼€èˆ¹æ—¥æœŸï¼‰
                    let tooltipData = '';
                    if (ships.length > 0) {
                        const shipDetails = ships.map(ship => {
                            const name = ship.shipName || 'æœªçŸ¥';
                            const capacity = ship.capacity || 0;
                            let date = ship.shipDate;
                            
                            // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY/MM/DDï¼ˆMåˆ—æ•°æ®ï¼‰
                            // ä½¿ç”¨ç»Ÿä¸€çš„æ—¥æœŸè§£æå’Œæ ¼å¼åŒ–å‡½æ•°
                            let formattedDate = '';
                            if (date !== null && date !== undefined && date !== '') {
                                formattedDate = formatDateToYYYYMMDD(date);
                                // å¦‚æœæ ¼å¼åŒ–å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨åŸå€¼
                                if (!formattedDate || formattedDate === 'æœªçŸ¥') {
                                    formattedDate = String(date);
                                }
                            } else {
                                formattedDate = 'â€”';
                            }
                            
                            // æ ¼å¼ï¼šèˆ¹åèˆªæ¬¡ï¼ˆKåˆ—ï¼‰+ xx TEUï¼ˆLåˆ—ï¼‰+ (å¼€èˆªæ—¶é—´)ï¼ˆMåˆ—ï¼Œæ ¼å¼ï¼šYYYY/MM/DDï¼‰
                            const capacityStr = capacity > 0 ? `${capacity.toLocaleString()} TEU` : '0 TEU';
                            // ç¡®ä¿æ ¼å¼ä¸ºï¼šèˆ¹åèˆªæ¬¡ + è¿åŠ›TEU + (YYYY/MM/DD)
                            return `${name} ${capacityStr} (${formattedDate})`;
                        }).join('\n');
                        tooltipData = shipDetails;
                    }
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `è¿åŠ›: ${totalCapacity.toLocaleString()} TEU<br>æ´¾èˆ¹: ${shipCount}`;
                    } else if (currentView === 'capacity') {
                        cellContent = totalCapacity.toLocaleString() + ' TEU';
                    } else if (currentView === 'ships') {
                        cellContent = shipCount.toString();
                    }
                    
                    // å¦‚æœæœ‰æ•°æ®ï¼Œæ·»åŠ tooltipå’Œæ‚¬åœæ ·å¼
                    const cellClass = ships.length > 0 ? 'number-cell hover-cell' : 'number-cell';
                    const tooltipAttr = tooltipData ? `data-tooltip="${tooltipData.replace(/"/g, '&quot;')}"` : '';
                    cells.push(`<td class="${cellClass}" ${tooltipAttr}>${cellContent}</td>`);
                });

                row.innerHTML = cells.join('');
                tableBody.appendChild(row);
            });
            
            const hasDestinationSelection = Boolean(
                destinationFilters.ports.length ||
                routeFilterValue.trim()
            );

            if (hasDestinationSelection && groupedData.length > 0) {
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'summary-row';
                const summaryCells = [
                    '<td><strong>åˆè®¡</strong></td>',
                    '<td></td>'
                ];

                let totalCapacityByWeek = {};
                let totalShipsByWeek = {};
                
                // è®¡ç®—æ¯å‘¨çš„åˆè®¡
                groupedData.forEach(item => {
                    weekColumns.forEach((week) => {
                        const weekCode = week.code;
                        const ships = item.weeks[weekCode] || [];
                        const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                        const weekShips = ships.length;
                        
                        if (!totalCapacityByWeek[weekCode]) {
                            totalCapacityByWeek[weekCode] = 0;
                            totalShipsByWeek[weekCode] = 0;
                        }
                        totalCapacityByWeek[weekCode] += weekCapacity;
                        totalShipsByWeek[weekCode] += weekShips;
                    });
                });
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const totalCapacity = totalCapacityByWeek[weekCode] || 0;
                    const totalShips = totalShipsByWeek[weekCode] || 0;
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `è¿åŠ›: ${totalCapacity.toLocaleString()} TEU<br>æ´¾èˆ¹: ${totalShips}`;
                    } else if (currentView === 'capacity') {
                        cellContent = `${totalCapacity.toLocaleString()} TEU`;
                    } else if (currentView === 'ships') {
                        cellContent = `${totalShips}`;
                    }
                    
                    summaryCells.push(`<td class="number-cell"><strong>${cellContent}</strong></td>`);
                });
                
                summaryRow.innerHTML = summaryCells.join('');
                tableBody.appendChild(summaryRow);
            }

            // æ·»åŠ tooltipäº‹ä»¶ç›‘å¬
            const hoverCells = tableBody.querySelectorAll('.hover-cell');
            hoverCells.forEach(cell => {
                const tooltipText = cell.getAttribute('data-tooltip');
                if (!tooltipText) return;
                
                let tooltip = null;
                
                cell.addEventListener('mouseenter', (e) => {
                    tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.style.display = 'block';
                    // å¯¹äºèˆ¹æœŸä¿¡æ¯ï¼Œç›´æ¥æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬ï¼Œä½¿ç”¨ pre-wrap ä¿æŒæ ¼å¼
                    const displayText = tooltipText;
                    const span = document.createElement('span');
                    span.className = 'tooltip-line';
                    span.textContent = displayText;
                    span.style.whiteSpace = 'pre-wrap';
                    tooltip.appendChild(span);
                    document.body.appendChild(tooltip);
                    
                    // ä½¿ç”¨é¼ æ ‡ä½ç½®æ¥å®šä½tooltipï¼Œè¿™æ ·æ»šåŠ¨æ—¶ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
                    const updateTooltipPosition = (event) => {
                        if (!tooltip || !tooltip.parentNode) return;
                        
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;
                        // ä½¿ç”¨ getBoundingClientRect è·å–æ›´å‡†ç¡®çš„å°ºå¯¸
                        const rect = tooltip.getBoundingClientRect();
                        const tooltipWidth = rect.width || tooltip.offsetWidth;
                        const tooltipHeight = rect.height || tooltip.offsetHeight;
                        const padding = 10;
                        
                        // é»˜è®¤æ˜¾ç¤ºåœ¨é¼ æ ‡å³ä¸‹æ–¹
                        let tooltipX = mouseX + padding;
                        let tooltipY = mouseY + padding;
                        
                        // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨å·¦ä¾§
                        if (tooltipX + tooltipWidth > window.innerWidth) {
                            tooltipX = mouseX - tooltipWidth - padding;
                        }
                        
                        // å¦‚æœå·¦ä¾§ä¹Ÿä¸å¤Ÿï¼Œå±…ä¸­æ˜¾ç¤º
                        if (tooltipX < 0) {
                            tooltipX = (window.innerWidth - tooltipWidth) / 2;
                        }
                        
                        // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸Šæ–¹
                        if (tooltipY + tooltipHeight > window.innerHeight) {
                            tooltipY = mouseY - tooltipHeight - padding;
                        }
                        
                        // å¦‚æœä¸Šæ–¹ä¹Ÿä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨é¼ æ ‡ä½ç½®
                        if (tooltipY < 0) {
                            tooltipY = mouseY + padding;
                        }
                        
                        tooltip.style.left = tooltipX + 'px';
                        tooltip.style.top = tooltipY + 'px';
                    };
                    
                    // åˆå§‹å®šä½ - ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å·²æ›´æ–°
                    requestAnimationFrame(() => {
                        updateTooltipPosition(e);
                    });
                    
                    // é¼ æ ‡ç§»åŠ¨æ—¶æ›´æ–°ä½ç½®
                    cell.addEventListener('mousemove', updateTooltipPosition);
                    cell._tooltipMoveHandler = updateTooltipPosition;
                });
                
                cell.addEventListener('mouseleave', () => {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                    // ç§»é™¤mousemoveäº‹ä»¶ç›‘å¬
                    if (cell._tooltipMoveHandler) {
                        cell.removeEventListener('mousemove', cell._tooltipMoveHandler);
                        cell._tooltipMoveHandler = null;
                    }
                });
            });

            if (infoText) {
                const totalCombos = groupedData.length;
                const totalRecords = filteredRecords.length;
                const portText = destinationFilters.ports.length ? destinationFilters.ports.join('ã€') : 'å…¨éƒ¨æ¸¯å£';
                infoText.textContent = `å·²åŠ è½½ ${totalRecords} æ¡è®°å½•ï¼Œç»„åˆ ${totalCombos} è¡Œï¼›ç­›é€‰æ¸¯å£ï¼š${portText}`;
            }

            tableContainer.classList.remove('hidden');
            
            // æ›´æ–°å›¾è¡¨
            updateChart(hasPortSelection, groupedData);
            
            // æ›´æ–°AIåˆ†æåŒºåŸŸ
            updateAiAnalysis(hasPortSelection);
        }
        
        function updateChart(hasPortSelection, groupedData) {
            const chartContainer = document.getElementById('chartContainer');
            const chartWrapper = document.getElementById('chartWrapper');
            const emptyChartMessage = document.getElementById('emptyChartMessage');
            
            chartContainer.classList.remove('hidden');
            
            if (!hasPortSelection || groupedData.length === 0) {
                chartWrapper.classList.add('hidden');
                emptyChartMessage.classList.remove('hidden');
                if (capacityChart) {
                    capacityChart.destroy();
                    capacityChart = null;
                }
                return;
            }
            
            emptyChartMessage.classList.add('hidden');
            chartWrapper.classList.remove('hidden');
            
            const weekCodes = weekColumns.map(week => week.code);
            const weekLabels = weekColumns.map(week => {
                const range = week.range ? ` (${week.range})` : '';
                return `${week.label}${range}`;
            });
            
            // å‡†å¤‡æ•°æ®
            const shipData = []; // æ¯å‘¨çš„æ€»æ´¾èˆ¹æ•°ï¼ˆç”¨äºæŠ˜çº¿å›¾ï¼‰
            const datasets = [];
            const podRoutePairs = [];
            
            // æ”¶é›†æ‰€æœ‰èˆªçº¿å¤‡æ³¨+å…±èˆ±èˆ¹å…¬å¸ç»„åˆ
            groupedData.forEach(item => {
                const routeLabel = item.routeLabel || 'æœªçŸ¥èˆªçº¿';
                const routeRemark = item.routeRemark || 'â€”';
                podRoutePairs.push({
                    label: `${routeRemark} - ${routeLabel}`,
                    routeLabel: routeLabel,
                    routeId: item.routeId || '',
                    routeRemark: routeRemark
                });
            });
            
            // ä¸ºæ¯ä¸ªç›®çš„æ¸¯+èˆªçº¿ç»„åˆåˆ›å»ºè¿åŠ›æ•°æ®é›†
            podRoutePairs.forEach((pair, index) => {
                const item = groupedData[index];
                const capacityValues = [];
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    capacityValues.push(weekCapacity);
                });
                
                // ç”Ÿæˆé¢œè‰²
                const hue = (index * 137.508) % 360; // ä½¿ç”¨é»„é‡‘è§’åº¦åˆ†å¸ƒé¢œè‰²
                const color = `hsl(${hue}, 70%, 50%)`;
                
                datasets.push({
                    label: pair.label,
                    data: capacityValues,
                    type: 'bar',
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1
                });
            });
            
            // è®¡ç®—æ¯å‘¨çš„æ€»æ´¾èˆ¹æ•°
            weekColumns.forEach((week) => {
                const weekCode = week.code;
                let totalShips = 0;
                groupedData.forEach(item => {
                    const ships = item.weeks[weekCode] || [];
                    totalShips += ships.length;
                });
                shipData.push(totalShips);
            });
            
            // æ·»åŠ æ´¾èˆ¹æŠ˜çº¿å›¾æ•°æ®é›†
            datasets.push({
                label: 'æ´¾èˆ¹æ€»æ•°',
                data: shipData,
                type: 'line',
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                yAxisID: 'y1'
            });
            
            // é”€æ¯æ—§å›¾è¡¨
            if (capacityChart) {
                capacityChart.destroy();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            const ctx = document.getElementById('trendChart').getContext('2d');
            capacityChart = new Chart(ctx, {
                data: {
                    labels: weekLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'è¿åŠ›ä¸æ´¾èˆ¹è¶‹åŠ¿åˆ†æ',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'å‘¨åˆ«'
                            }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'è¿åŠ› (TEU)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æ´¾èˆ¹æ•°'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // AIåˆ†æç›¸å…³åŠŸèƒ½
        const aiProviders = {
            deepseek: {
                id: 'deepseek',
                name: 'DeepSeek',
                keyInputId: 'apiKeyInput',
                urlInputId: 'apiUrlInput',
                modelInputId: 'apiModelInput',
                buttonId: 'aiAnalysisBtn',
                loadingId: 'aiLoading',
                resultContainerId: 'aiResult',
                resultContentId: 'aiResultContent',
                defaultUrl: 'https://api.deepseek.com/v1/chat/completions',
                defaultModel: 'deepseek-chat',
                storagePrefix: 'deepseek',
                temperature: 0.7,
                maxTokens: 8000
            },
            kimi: {
                id: 'kimi',
                name: 'KIMI (Moonshot)',
                keyInputId: 'kimiApiKeyInput',
                urlInputId: 'kimiApiUrlInput',
                modelInputId: 'kimiModelInput',
                buttonId: 'kimiAnalysisBtn',
                loadingId: 'kimiAiLoading',
                resultContainerId: 'kimiAiResult',
                resultContentId: 'kimiAiResultContent',
                defaultUrl: 'https://api.moonshot.cn/v1/chat/completions',
                defaultModel: 'moonshot-v1-32k',
                storagePrefix: 'kimi',
                temperature: 0.7,
                maxTokens: 8000
            },
            qwen: {
                id: 'qwen',
                name: 'é€šä¹‰åƒé—® (Qwen)',
                keyInputId: 'qwenApiKeyInput',
                urlInputId: 'qwenApiUrlInput',
                modelInputId: 'qwenModelInput',
                buttonId: 'qwenAnalysisBtn',
                loadingId: 'qwenAiLoading',
                resultContainerId: 'qwenAiResult',
                resultContentId: 'qwenAiResultContent',
                defaultUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                defaultModel: 'qwen-max',
                storagePrefix: 'qwen',
                temperature: 0.7,
                maxTokens: 8000
            }
        };
        // æç¤ºè¯å·²ä»å…±äº«æ–‡ä»¶ vendor/ai-prompts.js åŠ è½½
        // baseSystemPrompt å’Œ aiInstructionTemplate ç°åœ¨ä»å¤–éƒ¨æ–‡ä»¶å¼•ç”¨
        let activeAiProvider = 'deepseek';
        
        // ä½¿ç”¨ç»Ÿä¸€çš„ AI æ¨¡å—åˆå§‹åŒ–ï¼ˆä» vendor/ai-utils.jsï¼‰
        // æ³¨æ„ï¼šinitAiModule éœ€è¦åœ¨æ¨¡æ¿ç”Ÿæˆåè°ƒç”¨ï¼Œæ‰€ä»¥ç§»åˆ° window.addEventListener('load') ä¸­
        let setActiveAiPanelBound = null;

        function setActiveAiPanel(providerId = 'deepseek') {
            if (setActiveAiPanelBound) {
                const result = setActiveAiPanelBound(providerId);
                if (result) {
                    activeAiProvider = result;
                }
            } else {
                // é™çº§æ–¹æ¡ˆï¼šå¦‚æœ initAiModule æœªè°ƒç”¨ï¼Œä½¿ç”¨æœ¬åœ°å®ç°
                if (!aiProviders[providerId]) return;
                activeAiProvider = providerId;
                const aiTabButtons = document.querySelectorAll('.ai-tab-btn');
                const aiPanels = document.querySelectorAll('.ai-panel');
                aiTabButtons.forEach(btn => {
                    if (btn.dataset.provider === providerId) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                aiPanels.forEach(panel => {
                    if (panel.dataset.provider === providerId) {
                        panel.classList.add('active');
                    } else {
                        panel.classList.remove('active');
                    }
                });
            }
        }

        // ä½¿ç”¨å…¬å…±å‡½æ•°åŠ è½½ AI é…ç½®ï¼ˆä» vendor/ai-utils.jsï¼‰
        function loadAiConfigs() {
            loadAiConfigsFromStorage(aiProviders);
        }

        // ä½¿ç”¨å…¬å…±å‡½æ•°è·å– AI é…ç½®ï¼ˆä» vendor/ai-utils.jsï¼‰
        function getAiConfig(providerId = 'deepseek') {
            return getAiConfigFromInputs(providerId, aiProviders);
        }

        function saveAiConfig(providerId = 'deepseek') {
            saveAiConfigToStorage(providerId, aiProviders, (providerName) => {
                // ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å—
                const configSavedMsg = typeof getErrorMessage === 'function' 
                    ? getErrorMessage(ErrorType.USER_ACTION, 'CONFIG_SAVED', { provider: providerName })
                    : `${providerName} API é…ç½®å·²ä¿å­˜`;
                showSuccess(configSavedMsg);
            });
        }
        
        // å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾›æ¨¡æ¿ä¸­çš„ onclick ä½¿ç”¨
        window.saveAiConfig = saveAiConfig;

        // fetchBunkerData, extractBunkerTables, parseBunkerTable, updateBunkerStatus, describeBunkerLine å·²ä» vendor/market-analysis-utils.js åŠ è½½

        // fetchWciData, parseWciText, renderWciStatus å·²ä» vendor/market-analysis-utils.js åŠ è½½

        const wciCodeMap = {
            'WCI-COMPOSITE': 'å…¨çƒç»¼åˆ',
            'WCI-SHA-RTM': 'ä¸Šæµ· â†’ é¹¿ç‰¹ä¸¹',
            'WCI-RTM-SHA': 'é¹¿ç‰¹ä¸¹ â†’ ä¸Šæµ·',
            'WCI-SHA-GOA': 'ä¸Šæµ· â†’ çƒ­é‚£äºš',
            'WCI-SHA-LAX': 'ä¸Šæµ· â†’ æ´›æ‰çŸ¶',
            'WCI-LAX-SHA': 'æ´›æ‰çŸ¶ â†’ ä¸Šæµ·',
            'WCI-SHA-NYC': 'ä¸Šæµ· â†’ çº½çº¦',
            'WCI-NYC-RTM': 'çº½çº¦ â†’ é¹¿ç‰¹ä¸¹',
            'WCI-RTM-NYC': 'é¹¿ç‰¹ä¸¹ â†’ çº½çº¦'
        };

        const fbxCodeMap = {
            FBX: 'FBXï¼ˆFreightos Baltic Index å…¨çƒç»¼åˆï¼‰',
            FBX01: 'FBX01 ä¸­å›½/ä¸œäºš â†’ åŒ—ç¾è¥¿æµ·å²¸',
            FBX02: 'FBX02 åŒ—ç¾è¥¿æµ·å²¸ â†’ ä¸­å›½/ä¸œäºš',
            FBX03: 'FBX03 ä¸­å›½/ä¸œäºš â†’ åŒ—ç¾ä¸œæµ·å²¸',
            FBX04: 'FBX04 åŒ—ç¾ä¸œæµ·å²¸ â†’ ä¸­å›½/ä¸œäºš',
            FBX11: 'FBX11 ä¸­å›½/ä¸œäºš â†’ åŒ—æ¬§',
            FBX12: 'FBX12 åŒ—æ¬§ â†’ ä¸­å›½/ä¸œäºš',
            FBX13: 'FBX13 ä¸­å›½/ä¸œäºš â†’ åœ°ä¸­æµ·',
            FBX14: 'FBX14 åœ°ä¸­æµ· â†’ ä¸­å›½/ä¸œäºš',
            FBX21: 'FBX21 åŒ—ç¾ä¸œæµ·å²¸ â†’ åŒ—æ¬§',
            FBX22: 'FBX22 åŒ—æ¬§ â†’ åŒ—ç¾ä¸œæµ·å²¸',
            FBX24: 'FBX24 æ¬§æ´² â†’ å—ç¾ä¸œæµ·å²¸',
            FBX26: 'FBX26 æ¬§æ´² â†’ å—ç¾è¥¿æµ·å²¸'
        };

        // fetchFbxData, parseFbxText, renderFbxStatus å·²ä» vendor/market-analysis-utils.js åŠ è½½

        const cachedWci = loadCachedData(CACHE_KEYS.wci);
        if (cachedWci) {
            wciData = cachedWci;
            renderWciStatus();
        }
        const cachedFbx = loadCachedData(CACHE_KEYS.fbx);
        if (cachedFbx) {
            fbxData = cachedFbx;
            renderFbxStatus();
        }

        // fetchTextContent å·²ä» vendor/market-analysis-utils.js åŠ è½½

        /**
         * æ›´æ–°AIåˆ†ææ¨¡å—å¯è§æ€§ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼Œç±»ä¼¼ Monitor-Sailing-Scheduleï¼‰
         * @param {boolean} hasPortSelection - æ˜¯å¦æœ‰æ¸¯å£é€‰æ‹©
         */
        function updateAiAnalysis(hasPortSelection) {
            const aiAnalysisContainer = document.getElementById('aiAnalysisContainer');
            const emptyAiMessage = document.getElementById('emptyAiMessage');
            const aiConfigSection = document.getElementById('aiConfigSection');
            
            if (!aiAnalysisContainer) return;
            
            // AI æ¨¡å—å§‹ç»ˆæ˜¾ç¤ºï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰
            aiAnalysisContainer.style.display = 'block';
            
            // æ ¹æ®æ•°æ®çŠ¶æ€æ˜¾ç¤º/éšè—é…ç½®åŒºåŸŸ
            if (!hasPortSelection || !latestFilteredRecords || latestFilteredRecords.length === 0) {
                if (emptyAiMessage) emptyAiMessage.style.display = 'block';
                if (aiConfigSection) aiConfigSection.style.display = 'none';
                return;
            }
            
            if (emptyAiMessage) emptyAiMessage.style.display = 'none';
            if (aiConfigSection) aiConfigSection.style.display = 'block';
            loadAiConfigs();
            setActiveAiPanel(activeAiProvider);
        }

        async function runAiAnalysis(providerId = 'deepseek') {
            await executeAiAnalysis(
                providerId,
                aiProviders,
                buildAiPrompt,
                baseSystemPrompt,
                {
                    beforeAnalysis: async () => {
                        // åˆ†æå‰è·å–æ•°æ®
                        await Promise.allSettled([
                            fetchBunkerData(false),
                            fetchWciData(false),
                            fetchFbxData(false)
                        ]);
                    }
                }
            );
        }
        
        // å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾›æ¨¡æ¿ä¸­çš„ onclick ä½¿ç”¨
        window.runAiAnalysis = runAiAnalysis;

        function buildAiPrompt() {
            const filteredRecords = latestFilteredRecords;
            if (!filteredRecords.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_DATA');
                return null;
            }
            // æ— è®ºæ˜¯å¦é€‰æ‹©æ¸¯å£ï¼Œéƒ½æŒ‰èˆªçº¿åˆ†ç»„ï¼ˆåˆå¹¶ä¸åŒæ¸¯å£ï¼‰ï¼Œè¿™æ ·åŒä¸€èˆ¹åèˆªæ¬¡åœ¨ä¸åŒæ¸¯å£æ—¶ä¸ä¼šé‡å¤ç»Ÿè®¡
            const hasPortSelection = destinationFilters.ports.length > 0;
            // å§‹ç»ˆä¸æŒ‰æ¸¯å£åˆ†ç»„ï¼Œåˆå¹¶ç›¸åŒèˆªçº¿
            const analysisGroups = groupedTableData.length ? groupedTableData : groupRecords(filteredRecords, false).data;
            if (!analysisGroups.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_ROUTE_DATA');
                return null;
            }

            // ä½¿ç”¨å…¬å…±å‡½æ•°å‡†å¤‡åˆ†ææ•°æ®
            const prepared = prepareAnalysisData(analysisGroups, weekColumns, showError, ErrorType);
            if (!prepared) return null;
            const { analysisData, weeklySummary, analysisWeekCodes, analysisWeekLabels } = prepared;

            // æ„å»ºç›®çš„åœ°æ‘˜è¦ï¼ˆ001-04æ ¼å¼ï¼‰
            const destinationSummary = destinationFilters.ports.length
                ? destinationFilters.ports.join('ã€')
                : 'å…¨éƒ¨æ¸¯å£';

            // ä½¿ç”¨å…¬å…±å‡½æ•°æ„å»ºæç¤ºè¯
            let prompt = buildDataOverview(destinationSummary, analysisData.length, analysisWeekCodes, analysisWeekLabels, weeklySummary);
            prompt += buildDetailedData001(analysisData, analysisWeekCodes, analysisWeekLabels);
            prompt += buildBookingDataSection(getBookingDataLocal());
            prompt += buildMarketReportsSection(marketReports);
            prompt += buildBunkerDataSection(bunkerData);
            prompt += buildWciDataSection(wciData);
            prompt += buildFbxDataSection(fbxData);
            // æ·»åŠ  SCFI æ•°æ®ï¼ˆä»å¸‚åœºæŠ¥å‘Šä¸­æå–ï¼‰
            prompt += buildScfiDataSection(marketReports);

            prompt += aiInstructionTemplate;
            return prompt;
        }


        // ä½¿ç”¨å…¬å…±å‡½æ•°è·å–è®¢èˆ±æ•°æ®ï¼ˆä» vendor/market-analysis-utils.jsï¼‰
        // ç›´æ¥ä½¿ç”¨å…¨å±€å‡½æ•°ï¼Œé¿å…å‘½åå†²çª
        function getBookingDataLocal() {
            return window.getBookingData ? window.getBookingData('bookingDataBody') : [];
        }

        /**
         * å¯¼å‡ºæ•´é¡µ PDFï¼ˆä½¿ç”¨ vendor/pdf-utils.jsï¼‰
         */
        // ä½¿ç”¨å…¬å…±å‡½æ•°åˆ›å»º PDF å¯¼å‡ºå‡½æ•°ï¼ˆä» vendor/pdf-utils.jsï¼‰
        const exportPageToPdf = window.createExportPageToPdfFunction 
            ? window.createExportPageToPdfFunction('å¸‚åœºåˆ†ææŠ¥å‘Š')
            : async function() {
                        showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: 'PDF å¯¼å‡ºåŠŸèƒ½æœªåŠ è½½' 
                });
            };

        document.getElementById('exportPdfBtn')?.addEventListener('click', exportPageToPdf);
        window.addEventListener('load', () => {
            // ä½¿ç”¨å…¬å…±æ¨¡æ¿ç”Ÿæˆå¸‚åœºæ•°æ®ä¿¡æ¯å—
            if (typeof window.generateMarketDataInfoBlocks === 'function') {
                const marketDataContainer = document.getElementById('marketDataInfoBlocksContainer');
                if (marketDataContainer) {
                    marketDataContainer.innerHTML = window.generateMarketDataInfoBlocks();
                    }
            }
            
            // é‡æ–°è·å–çŠ¶æ€å…ƒç´ å¼•ç”¨ï¼ˆæ¨¡æ¿ç”Ÿæˆåï¼‰
            bunkerStatusEl = document.getElementById('bunkerStatus');
            bunkerUpdatedEl = document.getElementById('bunkerUpdated');
            wciStatusEl = document.getElementById('wciStatus');
            wciUpdatedEl = document.getElementById('wciUpdated');
            fbxStatusEl = document.getElementById('fbxStatus');
            fbxUpdatedEl = document.getElementById('fbxUpdated');
            
            // ä½¿ç”¨å…¬å…±åˆå§‹åŒ–å‡½æ•°ï¼ˆä» vendor/template-utils.jsï¼‰
            if (typeof window.initMarketAnalysisPage === 'function') {
                window.initMarketAnalysisPage({
                    updateAiAnalysis,
                    fetchBunkerData,
                    fetchWciData,
                    fetchFbxData,
                    bunkerStatusEl,
                    bunkerUpdatedEl,
                    wciStatusEl,
                    fbxStatusEl
                });
                
                // æ¨¡æ¿ç”Ÿæˆåï¼Œåˆå§‹åŒ– AI æ¨¡å—ï¼ˆç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶ï¼‰
                if (typeof window.initAiModule === 'function') {
                    setActiveAiPanelBound = window.initAiModule(aiProviders);
                    // è®¾ç½®é»˜è®¤æ¿€æ´»çš„æä¾›å•†
                    if (setActiveAiPanelBound) {
                        setActiveAiPanelBound(activeAiProvider);
                    }
                }
            } else {
                // é™çº§æ–¹æ¡ˆï¼šå¦‚æœå…¬å…±å‡½æ•°æœªåŠ è½½ï¼Œä½¿ç”¨æœ¬åœ°å®ç°
                if (typeof window.generateBookingDataTable === 'function') {
                    const container = document.getElementById('bookingDataTableContainer');
                    if (container) {
                        container.innerHTML = window.generateBookingDataTable();
                    }
                }
                if (typeof window.generateAiConfigPanels === 'function') {
                    const aiContainer = document.getElementById('aiConfigPanelsContainer');
                    if (aiContainer) {
                        aiContainer.innerHTML = window.generateAiConfigPanels();
                    }
                }
                
                // é™çº§æ–¹æ¡ˆï¼šæ¨¡æ¿ç”Ÿæˆåï¼Œåˆå§‹åŒ– AI æ¨¡å—ï¼ˆç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶ï¼‰
                if (typeof window.initAiModule === 'function') {
                    setActiveAiPanelBound = window.initAiModule(aiProviders);
                    // è®¾ç½®é»˜è®¤æ¿€æ´»çš„æä¾›å•†
                    if (setActiveAiPanelBound) {
                        setActiveAiPanelBound(activeAiProvider);
                    }
                }
                
            updateAiAnalysis(false);
            Promise.allSettled([
                fetchBunkerData(false),
                fetchWciData(false),
                fetchFbxData(false)
            ]);
            }
        });

        // ç­›é€‰åŠŸèƒ½åœ¨renderTableä¸­å·²å®ç°
    </script>
</body>
</html>
