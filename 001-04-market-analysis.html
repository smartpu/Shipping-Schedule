<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analysis · 市场分析</title>
    <script>
        (function ensureXlsx() {
            const remoteSources = [
                'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
            ];

            async function loadXlsxViaBlob(url) {
                try {
                    const response = await fetch(url, { cache: 'no-store' });
                    if (!response.ok) throw new Error(response.statusText);
                    const code = await response.text();
                    const blob = new Blob([code], { type: 'text/javascript' });
                    const blobUrl = URL.createObjectURL(blob);
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = blobUrl;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    console.log('XLSX loaded via fetch:', url);
                    return true;
                } catch (error) {
                    console.error('XLSX fetch fallback failed:', url, error);
                    return false;
                }
            }

            async function loadXlsx() {
                // 先尝试直接加载
                for (const url of remoteSources) {
                    try {
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = url;
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                        console.log('XLSX loaded from', url);
                        return true;
                    } catch (error) {
                        console.warn('XLSX direct load failed:', url, error);
                    }
                }
                // 如果直接加载失败，使用 fetch + Blob 方式
                for (const url of remoteSources) {
                    if (await loadXlsxViaBlob(url)) return true;
                }
                return false;
            }

            if (typeof XLSX === 'undefined') {
                loadXlsx().then(success => {
                    if (!success) {
                        console.error('XLSX 无法加载，请检查网络或手动刷新后重试');
                    }
                });
            }
        })();
    </script>
    <script>
        (function ensureChartJs() {
            const remoteSources = [
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js',
                'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js',
                'https://storage.googleapis.com/chartjs-4-4/chart.umd.min.js'
            ];

            async function loadChartViaBlob(url) {
                try {
                    const response = await fetch(url, { cache: 'no-store' });
                    if (!response.ok) throw new Error(response.statusText);
                    const code = await response.text();
                    const blob = new Blob([code], { type: 'text/javascript' });
                    const blobUrl = URL.createObjectURL(blob);
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = blobUrl;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    console.log('Chart.js loaded via fetch:', url);
                    return true;
                } catch (error) {
                    console.error('Chart.js fetch fallback failed:', url, error);
                    return false;
                }
            }

            async function loadChartJs() {
                for (const url of remoteSources) {
                    try {
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = url;
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                        console.log('Chart.js loaded from', url);
                        return true;
                    } catch (error) {
                        console.warn('Chart.js direct load failed:', url, error);
                    }
                }
                for (const url of remoteSources) {
                    if (await loadChartViaBlob(url)) return true;
                }
                return false;
            }

            if (typeof Chart === 'undefined') {
                loadChartJs().then(success => {
                    if (!success) {
                        alert('Chart.js 无法加载，请检查网络或手动刷新后重试');
                    }
                });
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #333;
            width: 100%;
            overflow-x: hidden;
        }
        body.pdf-export {
            background: #ffffff !important;
        }
        body.pdf-export * {
            box-shadow: none !important;
        }
        body.pdf-export .card,
        body.pdf-export .chart-container,
        body.pdf-export .table-container,
        body.pdf-export .info-box,
        body.pdf-export .instructions,
        body.pdf-export .market-report-upload,
        body.pdf-export .ai-analysis-container,
        body.pdf-export .booking-data-table,
        body.pdf-export .bunker-info,
        body.pdf-export .index-info,
        body.pdf-export .summary-row,
        body.pdf-export .footer {
            background: #ffffff !important;
        }
        body.pdf-export .header,
        body.pdf-export .page-footer {
            background: linear-gradient(135deg, #5f7ae0 0%, #4f2d8c 100%) !important;
        }
        body.pdf-export canvas,
        body.pdf-export .chart-wrapper,
        body.pdf-export .chart-container,
        body.pdf-export .chart-wrapper canvas {
            background: #ffffff !important;
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #5f7ae0 0%, #4f2d8c 100%);
            color: white;
            padding: 48px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 30px;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header p {
            opacity: 0.92;
            font-size: 15px;
            letter-spacing: 0.4px;
        }

        details.instructions {
            padding: 25px 40px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px 40px;
            border-radius: 8px;
        }
        details.instructions summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            list-style: none;
            color: #856404;
            font-weight: 600;
            font-size: 16px;
        }
        details.instructions summary::-webkit-details-marker {
            display: none;
        }
        details.instructions summary::after {
            content: '⌄';
            font-size: 16px;
            transition: transform 0.2s ease;
        }
        details.instructions[open] summary::after {
            transform: rotate(180deg);
        }
        details.instructions[open] .instruction-section {
            margin-top: 16px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #856404;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .instructions strong {
            color: #856404;
        }

        .instruction-section {
            margin-top: 16px;
        }

        .instruction-section h4 {
            color: #495057;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .content {
            padding: 20px 40px 30px;
        }

        .feature-section.hidden {
            display: none;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .destination-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }

        .destination-filters.hidden {
            display: none;
        }

        .filter-group {
            flex: 1 1 180px;
            min-width: 160px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .multi-hint {
            font-size: 11px;
            color: #6c757d;
        }
        body.pdf-export .container {
            box-shadow: none !important;
        }

        .file-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .file-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .file-btn input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .top-controls {
            justify-content: flex-start;
            gap: 16px;
            width: 100%;
            flex-wrap: wrap;
        }
        .top-controls .file-hint {
            flex-basis: 100%;
        }
        button.file-btn {
            border: none;
            font-family: inherit;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            border-radius: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #f0f0ff;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
        }

        .file-hint {
            color: #6c757d;
            font-size: 13px;
        }

        .feature-section {
            margin-top: 40px;
        }

        .section-title {
            font-size: 22px;
            color: #1f2d3d;
            font-weight: 600;
            margin-bottom: 15px;
            letter-spacing: 0.3px;
        }
        .section-title span {
            font-size: 12px;
            color: #98a2b3;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-left: 10px;
        }
        .module-header {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 18px;
        }
        .module-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(102, 126, 234, 0.15);
            color: #5568d3;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .module-desc {
            margin: 4px 0 0;
            color: #6c757d;
            font-size: 13px;
        }

        .market-report-upload {
            margin-top: 20px;
            padding: 16px 20px;
            background: #f8fbff;
            border: 1px solid #dbe5fb;
            border-radius: 10px;
        }

        .market-report-upload h5 {
            margin-bottom: 10px;
            font-size: 15px;
            color: #1f2d3d;
        }

        .market-report-upload .file-hint {
            margin-top: 8px;
            display: block;
        }

        .market-report-list {
            margin-top: 12px;
            list-style: none;
            padding-left: 0;
            color: #495057;
            font-size: 13px;
        }

        .market-report-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .market-report-list li:last-child {
            border-bottom: none;
        }

        .market-report-list span {
            font-size: 12px;
            color: #6c757d;
        }


        .view-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .view-toggle label {
            font-weight: 500;
            color: #495057;
        }

        .view-toggle button {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .view-toggle button.active {
            background: #667eea;
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: #f0f0ff;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #e9ecef;
            padding: 12px;
            text-align: left;
            width: calc(100% / 7);
        }

        thead th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        thead th.filter-header {
            padding: 8px;
            background: #5568d3;
        }

        thead th.week-header {
            background: #5568d3;
            text-align: center;
            vertical-align: middle;
        }
        
        thead th.week-header > div {
            line-height: 1.4;
        }

        .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            margin-top: 4px;
            box-sizing: border-box;
        }

        .filter-input::placeholder {
            color: #999;
        }

        .filter-input:focus {
            outline: none;
            background: white;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:hover {
            background: #e9ecef;
        }

        .number-cell {
            text-align: right;
            font-weight: 500;
        }

        .hover-cell {
            cursor: help;
            position: relative;
        }

        .hover-cell:hover {
            background: #e7f3ff !important;
        }

        .tooltip {
            position: fixed;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            line-height: 1.6;
            overflow-x: auto;
        }
        
        .tooltip-line {
            white-space: nowrap;
            display: block;
        }

        .week-cell {
            text-align: center;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .page-footer {
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            background: linear-gradient(135deg, #5f7ae0 0%, #4f2d8c 100%);
            color: white;
            padding: 32px 30px 36px;
            text-align: center;
            margin-top: 60px;
            box-sizing: border-box;
        }
        .page-footer h2 {
            font-size: 18px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .page-footer p {
            margin: 6px 0;
            font-size: 13px;
            color: rgba(255,255,255,0.82);
            line-height: 1.5;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #007aff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            margin: 5px 0;
            color: #004085;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(21, 31, 64, 0.12);
        }

        .chart-wrapper {
            position: relative;
            height: 800px;
            margin-top: 30px;
        }

        .summary-row {
            background: #f0f0ff !important;
            font-weight: 600;
        }

        .empty-chart-message {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 16px;
        }

        .ai-analysis-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .api-config {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .ai-header {
            margin-bottom: 16px;
        }

        .ai-header h3 {
            margin: 0;
            color: #495057;
            font-size: 18px;
        }

        .ai-header p {
            margin-top: 6px;
            color: #6c757d;
            font-size: 13px;
        }

        .ai-tabs {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .ai-tab-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ai-tab-btn {
            border: 2px solid #d0d7ff;
            background: white;
            color: #5568d3;
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-tab-btn.active {
            background: #5568d3;
            color: white;
            box-shadow: 0 6px 16px rgba(85, 104, 211, 0.25);
        }

        .ai-tab-btn:hover:not(.active) {
            background: #f5f6ff;
        }

        .ai-tab-hint {
            font-size: 12px;
            color: #6c757d;
        }

        .ai-panels {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ai-panel {
            display: none;
        }

        .ai-panel.active {
            display: block;
        }

        .api-config h4 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .api-input-group label {
            min-width: 120px;
            font-weight: 500;
            color: #495057;
        }

        .api-input-group input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .api-save-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .api-save-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .ai-analysis-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-top: 15px;
        }

        .ai-analysis-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .ai-analysis-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .ai-analysis-btn.secondary {
            background: #ff7b6b;
            box-shadow: none;
        }

        .ai-analysis-btn.secondary:hover:not(:disabled) {
            background: #ff624f;
            box-shadow: 0 4px 12px rgba(255, 123, 107, 0.4);
        }

        .bunker-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .bunker-copy h4 {
            margin: 0 0 6px;
            font-size: 15px;
            color: #495057;
        }

        .bunker-copy p {
            margin: 0;
            color: #343a40;
            font-size: 13px;
        }

        .bunker-meta {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #6c757d;
        }
        .index-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .index-info h4 {
            margin: 0 0 6px;
            font-size: 15px;
            color: #495057;
        }
        .index-info p {
            margin: 0;
            color: #343a40;
            font-size: 13px;
            white-space: pre-line;
        }
        .index-meta {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #6c757d;
        }

        .ai-result {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .ai-result h4 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }

        .ai-result-content {
            color: #333;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .ai-loading {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-size: 14px;
        }

        .ai-loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .booking-data-table {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .booking-data-table h4 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }

        .booking-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 13px;
            table-layout: fixed;
        }

        .booking-table th,
        .booking-table td {
            border: 1px solid #e9ecef;
            padding: 10px;
            text-align: left;
        }

        .booking-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .booking-table th:first-child,
        .booking-table td:first-child {
            width: 20%;
        }

        .booking-table th.description-header,
        .booking-table td.description-cell {
            width: 80%;
        }

        .booking-table td input,
        .booking-table td textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            box-sizing: border-box;
            font-family: inherit;
            background: white;
        }

        .booking-table td textarea {
            resize: vertical;
            min-height: 70px;
            line-height: 1.5;
        }

        .booking-table td input:focus,
        .booking-table td textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .booking-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Market Analysis · 市场分析</h1>
            <p>一份 Excel 与周报即可联动航线供给与 AI 决策，轻松完成跨板块洞察</p>
        </div>

        <details class="instructions">
            <summary>
                <span>📋 使用说明 · 展开仔细阅读，建议按顺序完成</span>
            </summary>
            <div class="instruction-section">
                <h4>① 通用准备</h4>
                <ol>
                    <li><strong>上传 Excel 数据源</strong>：文件需包含 <strong>schedule</strong> 工作表，并具备港口、航线、周别、运力、船名航次等字段。</li>
                    <li><strong>上传市场周报</strong>：支持一次选择多份 PDF（如 Alphaliner Newsletter、Linerlytica Weekly 等），便于 AI 参考最新情报。</li>
                    <li><strong>准备 AI 密钥</strong>：DeepSeek / KIMI / 通义千问 API Key 请由用户自备，调用费用及合规责任由使用方承担。</li>
                </ol>
            </div>
            <div class="instruction-section">
                <h4>② Module 01 · 航线运力分析</h4>
                <ol>
                    <li>使用港口多选筛选与航线搜索锁定目标市场。</li>
                    <li>“全部 / 运力 / 派船”视图用于聚焦不同指标；表格支持即输即筛。</li>
                    <li>选择目的港后自动绘制堆积柱（运力）+ 折线（派船）趋势，便于观察当周+未来四周变化。</li>
                </ol>
            </div>
            <div class="instruction-section">
                <h4>③ Module 02 · AI 趋势分析</h4>
                <ol>
                    <li>填写"其他影响因素"表格、刷新燃油/指数数据，作为 AI 提示词的优先依据。</li>
                    <li>分别配置 DeepSeek / KIMI / 通义千问 API 后，可对比三种模型的洞察结果，支持导出 PDF 汇报。</li>
                    <li><strong>模型选择建议</strong>：
                        <ul style="margin-top: 8px; margin-left: 20px; list-style: disc;">
                            <li><strong>DeepSeek</strong>：推荐 <code>deepseek-chat</code>（基础）或 <code>deepseek-v3</code>（高性能）
                                <br>申请 API Key：<a href="https://platform.deepseek.com" target="_blank" style="color: #667eea; text-decoration: underline;">https://platform.deepseek.com</a>
                            </li>
                            <li><strong>KIMI</strong>：推荐 <code>moonshot-v1-32k</code>（平衡），<code>moonshot-v1-k2</code>（K2新模型，需确认API可用）
                                <br>申请 API Key：<a href="https://platform.moonshot.cn/console/api-keys" target="_blank" style="color: #667eea; text-decoration: underline;">https://platform.moonshot.cn/console/api-keys</a>
                            </li>
                            <li><strong>通义千问</strong>：推荐 <code>qwen-max</code>（最佳性能），<code>qwen-turbo</code>（经济型）
                                <br>申请 API Key：<a href="https://dashscope.console.aliyun.com/apiKey" target="_blank" style="color: #667eea; text-decoration: underline;">https://dashscope.console.aliyun.com/apiKey</a>
                            </li>
                        </ul>
                    </li>
                    <li><strong>收费说明</strong>：各模型按调用次数/Token 计费，具体价格请参考各平台官网。建议先使用经济型模型测试，再根据需求选择高性能模型。</li>
                </ol>
            </div>
        </details>

        <div class="content">
            <div class="card">
                <div class="controls top-controls">
                    <label class="file-btn" title="选择Excel文件：文件需包含 schedule 工作表">
                        选择Excel文件
                        <input id="fileInput" type="file" accept=".xlsx,.xls">
                    </label>
                    <label class="file-btn" title="上传市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析">
                        上传市场周报 (PDF)
                        <input id="marketReportInput" type="file" accept=".pdf" multiple>
                    </label>
                    <button type="button" class="file-btn" id="exportPdfBtn" title="导出包含当前筛选视图与 AI 结论的整页 PDF">
                        导出整页 PDF
                    </button>
                    <span class="file-hint">
                        选择Excel文件：文件需包含 schedule 工作表；
                        上传市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析。
                    </span>
                </div>
                <div class="market-report-upload">
                    <h5>市场周报列表</h5>
                    <ul class="market-report-list" id="marketReportList">
                        <li>尚未上传市场报告</li>
                    </ul>
                </div>
            </div>

            <section id="capacityModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 01</span>
                    <div>
                        <h2 class="section-title">航线运力分析 <span>SAILING SCHEDULE PULSE</span></h2>
                        <p class="module-desc">港口筛选联动运力、派船与趋势，精准锁定当周+未来四周供给</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="capacity">
                    <div class="controls">
                        <div class="view-toggle hidden" id="viewToggle">
                            <label>显示模式：</label>
                            <button id="btnAll" class="active">全部</button>
                            <button id="btnCapacity">运力</button>
                            <button id="btnShips">派船</button>
                        </div>
                    </div>
                    <div id="destinationFilters" class="destination-filters hidden">
                        <div class="filter-group">
                            <label for="portSelect">选择港口</label>
                            <select id="portSelect" multiple size="6" class="multi-select">
                                <option value="">全部港口</option>
                            </select>
                            <small class="multi-hint">可多选（点击即可勾选或取消）</small>
                        </div>
                    </div>
                    <div id="infoBox" class="info-box hidden">
                        <p id="infoText"></p>
                    </div>
                    <div id="tableContainer" class="table-container hidden">
                        <table id="pivotTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div id="chartContainer" class="chart-container hidden">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                            <h3 style="color:#1f2d3d; font-size:20px; letter-spacing:0.5px;">运力与派船趋势图</h3>
                            <span style="color:#6c757d; font-size:13px;">高度 ×2 展示，便于对比多航线</span>
                        </div>
                        <div id="emptyChartMessage" class="empty-chart-message hidden">
                            请选择港口以查看图表
                        </div>
                        <div class="chart-wrapper hidden" id="chartWrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="aiModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 02</span>
                    <div>
                        <h2 class="section-title">AI 趋势分析 <span>AI TREND ANALYSIS</span></h2>
                        <p class="module-desc">DeepSeek × KIMI × 通义千问 三模型交叉验证航线策略、供需与价格建议</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="ai">
                    <div id="aiAnalysisContainer" class="ai-analysis-container hidden">
                        <div class="ai-header">
                            <h3>AI 船期趋势分析</h3>
                            <p>同一份筛选数据可由多模型并行分析，快速对比观点并交叉验证结论</p>
                        </div>
                        <div id="emptyAiMessage" class="empty-chart-message hidden">
                            请选择港口以启用 AI 分析
                        </div>
                        <div id="aiConfigSection" class="hidden">
                            <div class="booking-data-table">
                                <h4>其他影响因素</h4>
                                <table class="booking-table" id="bookingDataTable">
                                    <thead>
                                        <tr>
                                            <th>项目</th>
                                            <th class="description-header">说明</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingDataBody">
                                        <tr>
                                            <td><input type="text" value="收货情况" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="当周及未来2周订舱情况；主观判断目前处于旺季或淡季、重点流向表现、装载率预估等"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="码头情况" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="起运港/目的港的拥堵情况、靠泊等待平均时间、天气或其他码头运营影响"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="额外运力" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="具体船公司在某周临时加开/取消/减舱的情况（航线运力分析未覆盖的部分）"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="市场运费" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="填写现行报价，市场上较为激进的高价或低价（如 XX 公司报价表）"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="其他事件" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="如调高关税、出口退税、查验力度、环保政策变化等特殊事件"></textarea>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bunker-info">
                                <div class="bunker-copy">
                                    <h4>燃油行情（Ship & Bunker · 新加坡）</h4>
                                    <p id="bunkerStatus">尚未抓取燃油报价</p>
                                    <small id="bunkerUpdated" class="bunker-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshBunkerBtn">更新燃油价格</button>
                            </div>
                            <div class="index-info">
                                <div>
                                    <h4>中国出口集装箱运价指数（CCFI）</h4>
                                    <p id="ccfiStatus">尚未抓取 CCFI 数据</p>
                                    <small id="ccfiUpdated" class="index-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshCcfiBtn">更新 CCFI</button>
                            </div>
                            <div class="index-info">
                                <div>
                                    <h4>WCI 主要航线现货价</h4>
                                    <p id="wciStatus">尚未抓取 WCI 数据</p>
                                    <small id="wciUpdated" class="index-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshWciBtn">更新 WCI</button>
                            </div>
                            <div class="index-info">
                                <div>
                                    <h4>FBX 全球航线指数</h4>
                                    <p id="fbxStatus">尚未抓取 FBX 数据</p>
                                    <small id="fbxUpdated" class="index-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshFbxBtn">更新 FBX</button>
                            </div>
                            <div class="ai-tabs">
                                <div class="ai-tab-buttons">
                                    <button class="ai-tab-btn active" data-provider="deepseek">DeepSeek</button>
                                    <button class="ai-tab-btn" data-provider="kimi">KIMI (Moonshot)</button>
                                    <button class="ai-tab-btn" data-provider="qwen">通义千问 (Qwen)</button>
                                </div>
                                <span class="ai-tab-hint">可切换不同模型对比观点一致性</span>
                            </div>
                            <div class="ai-panels">
                                <div class="ai-panel active" data-provider="deepseek">
                                    <div class="api-config">
                                        <h4>DeepSeek API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="apiKeyInput" placeholder="请输入 DeepSeek API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="apiUrlInput" placeholder="https://api.deepseek.com/v1/chat/completions" value="https://api.deepseek.com/v1/chat/completions">
                                        </div>
                                            <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="apiModelInput" placeholder="deepseek-chat" value="deepseek-chat" list="deepseekModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('deepseek')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn" id="aiAnalysisBtn" onclick="runAiAnalysis('deepseek')">使用 DeepSeek 分析</button>
                                    <div id="aiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="aiResult" class="ai-result hidden">
                                        <h4>DeepSeek 分析结果</h4>
                                        <div class="ai-result-content" id="aiResultContent"></div>
                                    </div>
                                </div>
                                <div class="ai-panel" data-provider="kimi">
                                    <div class="api-config">
                                        <h4>KIMI (Moonshot) API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="kimiApiKeyInput" placeholder="请输入 KIMI / Moonshot API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="kimiApiUrlInput" placeholder="https://api.moonshot.cn/v1/chat/completions" value="https://api.moonshot.cn/v1/chat/completions">
                                        </div>
                                        <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="kimiModelInput" placeholder="moonshot-v1-32k" value="moonshot-v1-32k" list="kimiModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('kimi')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn secondary" id="kimiAnalysisBtn" onclick="runAiAnalysis('kimi')">使用 KIMI 分析</button>
                                    <div id="kimiAiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="kimiAiResult" class="ai-result hidden">
                                        <h4>KIMI 分析结果</h4>
                                        <div class="ai-result-content" id="kimiAiResultContent"></div>
                                    </div>
                                </div>
                                <div class="ai-panel" data-provider="qwen">
                                    <div class="api-config">
                                        <h4>通义千问 (Qwen) API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="qwenApiKeyInput" placeholder="请输入通义千问 API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="qwenApiUrlInput" placeholder="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" value="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions">
                                        </div>
                                        <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="qwenModelInput" placeholder="qwen-max" value="qwen-max" list="qwenModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('qwen')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn" id="qwenAnalysisBtn" onclick="runAiAnalysis('qwen')" style="background: #ff6b35;">使用通义千问分析</button>
                                    <div id="qwenAiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="qwenAiResult" class="ai-result hidden">
                                        <h4>通义千问 分析结果</h4>
                                        <div class="ai-result-content" id="qwenAiResultContent"></div>
                                    </div>
                                </div>
                            </div>
                            <datalist id="deepseekModelOptions">
                                <option value="deepseek-chat">基础对话模型（推荐）</option>
                                <option value="deepseek-v3">V3 高性能模型（2024年12月发布）</option>
                                <option value="deepseek-reasoner">推理模型（逻辑推理）</option>
                                <option value="deepseek-r1">R1 推理模型（2025年1月发布）</option>
                                <option value="deepseek-coder">代码模型</option>
                            </datalist>
                            <datalist id="kimiModelOptions">
                                <option value="moonshot-v1-8k">8K 上下文（经济型）</option>
                                <option value="moonshot-v1-32k">32K 上下文（推荐）</option>
                                <option value="moonshot-v1-128k">128K 上下文（长文档）</option>
                                <option value="moonshot-v1-k2">K2 模型（320亿参数，需确认API可用性）</option>
                            </datalist>
                            <datalist id="qwenModelOptions">
                                <option value="qwen-turbo">Turbo 快速模型（经济型）</option>
                                <option value="qwen-plus">Plus 平衡模型</option>
                                <option value="qwen-max">Max 高性能模型（推荐，最佳性能）</option>
                                <option value="qwen-max-longcontext">Max 长上下文模型</option>
                            </datalist>
                        </div>
    </div>
    </div>
    <div class="page-footer">
        <h2>Market Analysis · 市场分析使用声明</h2>
        <p>资料整合自用户 Excel、用户上传市场周报、Ship & Bunker、上海航运交易所、Drewry、Freightos 等公开渠道，仅供内部研判，不构成对外报价或投资建议。</p>
        <p>AI 服务由 DeepSeek / KIMI / 通义千问 API 驱动，所有调用费用与合规责任由使用者自担，涉及客户或敏感数据时请先完成脱敏处理。</p>
    </div>
    <script>
        let pdfJsReady = false;
        let pdfJsLoadingPromise = null;

        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            pdfJsReady = true;
        }

        const loadedScripts = new Set();
        const loadedWorkers = new Map();

        async function loadScript(url) {
            if (loadedScripts.has(url)) {
                return;
            }
            const response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) {
                throw new Error(`无法加载脚本: ${url}`);
            }
            const code = await response.text();
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.text = code;
            document.head.appendChild(script);
            loadedScripts.add(url);
        }

        async function loadWorkerAsBlob(url) {
            if (loadedWorkers.has(url)) {
                return loadedWorkers.get(url);
            }
            const response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) {
                throw new Error(`无法加载Worker: ${url}`);
            }
            const code = await response.text();
            const blobUrl = URL.createObjectURL(new Blob([code], { type: 'text/javascript' }));
            loadedWorkers.set(url, blobUrl);
            return blobUrl;
        }

        async function ensurePdfJsLoaded() {
            if (typeof window.pdfjsLib !== 'undefined') {
                if (!pdfJsReady && pdfjsLib.GlobalWorkerOptions) {
                    // 直接使用 CDN URL，避免 Blob URL 问题
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    pdfJsReady = true;
                }
                return;
            }
            if (pdfJsLoadingPromise) {
                return pdfJsLoadingPromise;
            }
            pdfJsLoadingPromise = (async () => {
                const sources = [
                    {
                        script: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
                        worker: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'
                    },
                    {
                        script: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
                        worker: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
                    },
                    {
                        script: 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js',
                        worker: 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
                    }
                ];
                let lastError = null;
                for (const src of sources) {
                    try {
                        await loadScript(src.script);
                        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
                            // 直接使用 CDN URL，不尝试 Blob URL
                            pdfjsLib.GlobalWorkerOptions.workerSrc = src.worker;
                            pdfJsReady = true;
                            lastError = null;
                            break;
                        }
                    } catch (error) {
                        lastError = error;
                        console.warn('PDF.js 加载失败，尝试下一个源:', src.script, error);
                    }
                }
                if (!pdfJsReady) {
                    pdfJsLoadingPromise = null;
                    throw new Error('PDF 解析库加载失败: ' + (lastError?.message || '所有源都失败'));
                }
            })();
            return pdfJsLoadingPromise;
        }

        let marketReports = [];
        let bunkerData = null;
        let ccfiData = null;
        let wciData = null;
        let fbxData = null;
        const excelLoadState = { schedule: false };
        let modulesVisible = false;

        const fileInput = document.getElementById('fileInput');
        const marketReportInput = document.getElementById('marketReportInput');
        const marketReportList = document.getElementById('marketReportList');
        const bunkerStatusEl = document.getElementById('bunkerStatus');
        const bunkerUpdatedEl = document.getElementById('bunkerUpdated');
        const refreshBunkerBtn = document.getElementById('refreshBunkerBtn');
        const ccfiStatusEl = document.getElementById('ccfiStatus');
        const ccfiUpdatedEl = document.getElementById('ccfiUpdated');
        const refreshCcfiBtn = document.getElementById('refreshCcfiBtn');
        const wciStatusEl = document.getElementById('wciStatus');
        const wciUpdatedEl = document.getElementById('wciUpdated');
        const refreshWciBtn = document.getElementById('refreshWciBtn');
        const fbxStatusEl = document.getElementById('fbxStatus');
        const fbxUpdatedEl = document.getElementById('fbxUpdated');
        const refreshFbxBtn = document.getElementById('refreshFbxBtn');

        function renderMarketReportList() {
            if (!marketReportList) return;
            if (!marketReports.length) {
                marketReportList.innerHTML = '<li>尚未上传市场报告</li>';
                return;
            }
            marketReportList.innerHTML = marketReports.map(report => `
                <li>
                    <strong>${report.name}</strong>
                    <span>${report.textLength} 字</span>
                </li>
            `).join('');
        }

        renderMarketReportList();
        function tryRevealModules() {
            if (modulesVisible) return;
            if (excelLoadState.schedule) {
                // 只显示筛选控件，模块标题始终显示
                const destinationFiltersPanel = document.getElementById('destinationFilters');
                if (destinationFiltersPanel) destinationFiltersPanel.classList.remove('hidden');
                
                const viewToggle = document.getElementById('viewToggle');
                if (viewToggle) viewToggle.classList.remove('hidden');

                document.querySelectorAll('.module-card').forEach(card => {
                    card.classList.remove('hidden');
                });
                
                modulesVisible = true;
            }
        }

        refreshBunkerBtn?.addEventListener('click', () => {
            fetchBunkerData(true).catch(error => {
                console.warn('燃油行情抓取失败', error);
                bunkerStatusEl && (bunkerStatusEl.textContent = '抓取失败，请稍后重试或检查网络');
                bunkerUpdatedEl && (bunkerUpdatedEl.textContent = '最近更新时间：—');
            });
        });
        refreshCcfiBtn?.addEventListener('click', () => {
            fetchCcfiData(true).catch(error => {
                console.warn('CCFI 数据抓取失败', error);
                ccfiStatusEl && (ccfiStatusEl.textContent = '抓取失败，请稍后重试或检查网络');
                ccfiUpdatedEl && (ccfiUpdatedEl.textContent = '最近更新时间：—');
            });
        });
        refreshWciBtn?.addEventListener('click', () => {
            fetchWciData(true).catch(error => {
                console.warn('WCI 抓取失败', error);
                if (wciStatusEl) wciStatusEl.textContent = '抓取失败，请稍后重试';
            });
        });
        refreshFbxBtn?.addEventListener('click', () => {
            fetchFbxData(true).catch(error => {
                console.warn('FBX 抓取失败', error);
                if (fbxStatusEl) fbxStatusEl.textContent = '抓取失败，请稍后重试';
            });
        });

        const CACHE_KEYS = {
            ccfi: 'ccfiDataCache',
            wci: 'wciDataCache',
            fbx: 'fbxDataCache'
        };

        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function computePercentChange(current, previous) {
            if (typeof current !== 'number' || typeof previous !== 'number' || !isFinite(current) || !isFinite(previous) || previous === 0) {
                return null;
            }
            return ((current - previous) / previous) * 100;
        }

        function formatPercent(value, digits = 1) {
            if (typeof value !== 'number' || !isFinite(value)) return '—';
            const sign = value > 0 ? '+' : '';
            return `${sign}${value.toFixed(digits)}%`;
        }

        function loadCachedData(key) {
            try {
                if (typeof localStorage === 'undefined') return null;
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (error) {
                console.warn('加载缓存失败', error);
                return null;
            }
        }

        function saveCachedData(key, data) {
            try {
                if (typeof localStorage === 'undefined') return;
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.warn('写入缓存失败', error);
            }
        }

        function applyWoWFromCache(current, previous, options = {}) {
            if (!current || !previous) return;
            const { routeKey = 'code', valueKey = 'rate', targetCollection = 'routes' } = options;
            const prevCollection = previous[targetCollection] || [];
            const prevMap = new Map();
            if (Array.isArray(prevCollection)) {
                prevCollection.forEach(item => {
                    const key = item[routeKey] || item.route;
                    if (key && typeof item[valueKey] === 'number') {
                        prevMap.set(key, item[valueKey]);
                    }
                });
            }
            const currentCollection = current[targetCollection] || [];
            if (Array.isArray(currentCollection)) {
                currentCollection.forEach(item => {
                    const key = item[routeKey] || item.route;
                    if (key && prevMap.has(key) && typeof item[valueKey] === 'number') {
                        const wow = computePercentChange(item[valueKey], prevMap.get(key));
                        if (wow !== null) {
                            item.wow = wow;
                        }
                    }
                });
            }
            if (typeof current.worldIndex === 'number' && typeof previous.worldIndex === 'number') {
                current.worldIndexWoW = computePercentChange(current.worldIndex, previous.worldIndex);
            }
        }

        async function extractTextFromPdf(file) {
            try {
                await ensurePdfJsLoaded();
            } catch (error) {
                throw new Error('PDF 解析库加载失败：' + (error.message || error) + '。请刷新页面重试。');
            }
            if (!window.pdfjsLib || !pdfjsLib.getDocument) {
                throw new Error('PDF 解析库尚未加载，请稍后重试');
            }
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = '';
                const maxPages = Math.min(pdf.numPages, 20);
                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    text += pageText + '\n';
                    if (text.length > 20000) break;
                }
                return text.trim();
            } catch (error) {
                throw new Error('PDF 文件解析失败：' + (error.message || error));
            }
        }

        async function handleMarketReportFile(file) {
            try {
                const text = await extractTextFromPdf(file);
                if (text) {
                    marketReports.push({
                        name: file.name,
                        text,
                        textLength: text.length
                    });
                }
            } catch (error) {
                console.error('解析PDF失败', file.name, error);
                alert(`解析 ${file.name} 失败：${error.message || error}`);
            }
        }

        if (marketReportInput) {
            marketReportInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                if (marketReportList) {
                    marketReportList.innerHTML = '<li>正在解析上传的报告...</li>';
                }
                for (const file of files) {
                    await handleMarketReportFile(file);
                }
                renderMarketReportList();
                marketReportInput.value = '';
            });
        }

    </script>

    <script>
        let scheduleData = [];
        let processedRecords = [];
        let groupedTableData = [];
        let latestFilteredRecords = [];
        let availablePorts = [];
        let destinationFilters = {
            ports: []
        };
        let currentView = 'all'; // 'all', 'capacity', 'ships'
        let weekColumns = []; // 5周的周别
        let capacityChart = null; // Chart.js实例
        let routeFilterValue = '';
        let routeLabelMap = {};

        const infoBox = document.getElementById('infoBox');
        const infoText = document.getElementById('infoText');
        const tableContainer = document.getElementById('tableContainer');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const viewToggle = document.getElementById('viewToggle');
        const btnAll = document.getElementById('btnAll');
        const btnCapacity = document.getElementById('btnCapacity');
        const btnShips = document.getElementById('btnShips');
        const destinationFiltersPanel = document.getElementById('destinationFilters');
        const portSelect = document.getElementById('portSelect');

        function getSelectedValues(selectEl) {
            if (!selectEl) return [];
            return Array.from(selectEl.selectedOptions || [])
                .map(option => option.value)
                .filter(value => value);
        }

        function setupMultiSelect(selectEl) {
            if (!selectEl || !selectEl.multiple) return;
            selectEl.addEventListener('mousedown', (event) => {
                const option = event.target;
                if (!option || option.tagName !== 'OPTION') return;
                event.preventDefault();
                if (option.value === '') {
                    Array.from(selectEl.options).forEach(opt => {
                        opt.selected = false;
                    });
                } else {
                    option.selected = !option.selected;
                }
                selectEl.dispatchEvent(new Event('change'));
            });
        }

        function normalizeDestinationValue(value) {
            const text = String(value ?? '').trim();
            return text || '未分配';
        }

        function populateSelect(selectEl, options, placeholder, selectedValues, shouldDisable = false) {
            if (!selectEl) return;
            const uniqueOptions = Array.from(new Set(options)).sort((a, b) => a.localeCompare(b));
            const selectedArray = Array.isArray(selectedValues)
                ? selectedValues
                : (selectedValues ? [selectedValues] : []);
            const selectedSet = new Set(selectedArray);
            selectEl.innerHTML = '';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = placeholder;
            if (!selectedSet.size) {
                placeholderOption.selected = true;
            }
            selectEl.appendChild(placeholderOption);
            uniqueOptions.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                if (selectedSet.has(optionValue)) {
                    option.selected = true;
                }
                selectEl.appendChild(option);
            });
            selectEl.disabled = shouldDisable || uniqueOptions.length === 0;
        }

        function registerRouteLabel(routeId, routeText) {
            if (!routeId) return;
            const cleaned = String(routeText ?? '').trim();
            if (!cleaned) return;
            const current = routeLabelMap[routeId];
            if (!current || cleaned.length > current.length) {
                routeLabelMap[routeId] = cleaned;
            }
        }

        function getRouteLabel(routeId, fallback) {
            if (routeId && routeLabelMap[routeId]) {
                return routeLabelMap[routeId];
            }
            const cleaned = String(fallback ?? '').trim();
            return cleaned || '未知航线';
        }

        function refreshAvailablePorts() {
            const portSet = new Set();
            processedRecords.forEach(record => {
                const port = record.port || '未分配';
                portSet.add(port);
            });
            availablePorts = Array.from(portSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
        }

        function updatePortFilterOptions() {
            refreshAvailablePorts();
            populateSelect(
                portSelect,
                availablePorts,
                '全部港口',
                destinationFilters.ports,
                availablePorts.length === 0
            );
        }

        function getCurrentGroupLevel() {
            return destinationFilters.ports.length > 0 ? 1 : 0;
        }

        function getFilteredRecords() {
            const routeFilterText = routeFilterValue.trim().toLowerCase();
            return processedRecords.filter(record => {
                if (destinationFilters.ports.length && !destinationFilters.ports.includes(record.port)) return false;
                if (routeFilterText) {
                    const routeText = String(record.routeLabel || record.route || '').toLowerCase();
                    if (!routeText.includes(routeFilterText)) return false;
                }
                return true;
            });
        }

        function buildShipSignature(record) {
            const shipName = record.shipName || '';
            const shipDate = record.shipDate || '';
            const capacity = record.capacity || 0;
            return `${shipName}|${shipDate}|${capacity}`;
        }

        function buildDedupKey(record) {
            const routeId = record.routeId && record.routeId.trim ? record.routeId.trim() : (record.routeId || '');
            const port = (record.port || '未分配').trim();
            const shipSignature = buildShipSignature(record);
            return `${port}|${routeId}|${shipSignature}`;
        }

        function groupRecords(records, groupByPort = false) {
            const groups = new Map();

            records.forEach(record => {
                const port = record.port || '未分配';
                const routeLabel = record.routeLabel || record.route || '未知航线';
                const routeKey = record.routeId || routeLabel;
                const routeRemark = record.routeRemark || '';
                // 如果 groupByPort 为 true，按港口+航线分组；否则只按航线分组（合并不同港口）
                const key = groupByPort ? `${port}|${routeKey}` : routeKey;

                if (!groups.has(key)) {
                    groups.set(key, {
                        port: groupByPort ? port : '', // 如果不按港口分组，port 设为空字符串
                        routeLabel,
                        routeId: record.routeId || '',
                        routeRemark,
                        weeks: {}
                    });
                }

                const group = groups.get(key);
                if (!group.weeks[record.weekCode]) {
                    group.weeks[record.weekCode] = [];
                }

                const entries = group.weeks[record.weekCode];
                // 如果不按港口分组，去重时只考虑船名航次+运力+日期，不考虑港口
                // 如果按港口分组，去重时考虑港口+船名航次+运力+日期
                const dedupKey = groupByPort ? buildDedupKey(record) : buildShipSignature(record);
                const exists = entries.some(item => {
                    // 如果不按港口分组，比较时只考虑船名航次+运力+日期
                    if (!groupByPort) {
                        return item.shipName === record.shipName && 
                               item.shipDate === record.shipDate && 
                               item.capacity === record.capacity;
                    }
                    // 如果按港口分组，使用 dedupKey 比较
                    return item.dedupKey === dedupKey;
                });
                if (exists) {
                    return;
                }
                entries.push({
                    capacity: record.capacity,
                    shipName: record.shipName,
                    shipDate: record.shipDate,
                    routeId: record.routeId || '',
                    dedupKey: groupByPort ? dedupKey : buildShipSignature(record)
                });
            });

            const sorted = Array.from(groups.values()).sort((a, b) => {
                // 如果按港口分组，先按港口排序；否则只按航线排序
                if (groupByPort && (a.port || '') !== (b.port || '')) {
                    return (a.port || '').localeCompare(b.port || '');
                }
                return (a.routeLabel || '').localeCompare(b.routeLabel || '');
            });

            return {
                data: sorted
            };
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // 检查 XLSX 是否已加载
            if (typeof XLSX === 'undefined') {
                alert('XLSX 库尚未加载完成，请稍候几秒后重试。\n\n如果问题持续，请检查网络连接或刷新页面。');
                return;
            }

            try {
                const data = await readExcelFile(file);
                scheduleData = data;
                generatePivotTable(data);
                infoText.textContent = `已加载 ${data.length} 条船期数据`;
                infoBox.classList.remove('hidden');
                excelLoadState.schedule = true;
                tryRevealModules();
            } catch (error) {
                alert('读取文件失败：' + error.message);
                console.error(error);
            }
        });

        btnAll.addEventListener('click', () => {
            currentView = 'all';
            btnAll.classList.add('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnCapacity.addEventListener('click', () => {
            currentView = 'capacity';
            btnAll.classList.remove('active');
            btnCapacity.classList.add('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnShips.addEventListener('click', () => {
            currentView = 'ships';
            btnAll.classList.remove('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.add('active');
            renderTable();
        });

        if (portSelect) {
            setupMultiSelect(portSelect);
            portSelect.addEventListener('change', () => {
                destinationFilters.ports = getSelectedValues(portSelect);
                renderTable();
            });
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX 库未加载，请刷新页面重试'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false });
                        
                        // 查找 schedule 工作表
                        const sheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('schedule')
                        ) || workbook.SheetNames[0];
                        
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // 将周别文本转换为YYYYWW格式（如：202547）
        function parseWeekText(weekText) {
            if (!weekText) return null;
            const text = String(weekText).trim();
            
            // 尝试匹配"2025年第47周"格式
            const match1 = text.match(/(\d{4})年[第]?(\d{1,2})周/);
            if (match1) {
                const year = parseInt(match1[1]);
                const week = parseInt(match1[2]);
                return String(year) + String(week).padStart(2, '0');
            }
            
            // 尝试匹配"202547"格式（已经是目标格式）
            const match2 = text.match(/^(\d{4})(\d{2})$/);
            if (match2) {
                return text;
            }
            
            // 尝试匹配"2025-47"或"2025/47"格式
            const match3 = text.match(/(\d{4})[-/](\d{1,2})/);
            if (match3) {
                const year = parseInt(match3[1]);
                const week = parseInt(match3[2]);
                return String(year) + String(week).padStart(2, '0');
            }
            
            return null;
        }

        // 获取当前周的周别代码
        function getCurrentWeekCode() {
            const today = new Date();
            const year = today.getFullYear();
            const weekNo = getWeekNumber(today);
            return String(year) + String(weekNo).padStart(2, '0');
        }

        // 获取当周+未来4周（共5周）
        function getWeekRange() {
            const weeks = [];
            const currentWeekCode = getCurrentWeekCode();
            
            // 解析当前周
            const currentYear = parseInt(currentWeekCode.substring(0, 4));
            const currentWeekNo = parseInt(currentWeekCode.substring(4));
            
            // 生成当周+未来4周（共5周）
            for (let i = 0; i < 5; i++) {
                let year = currentYear;
                let weekNo = currentWeekNo + i;
                
                // 处理跨年
                if (weekNo > 53) {
                    year = year + 1;
                    weekNo = weekNo - 53;
                }
                
                const weekStr = String(year) + String(weekNo).padStart(2, '0');
                weeks.push(weekStr);
            }
            
            return weeks;
        }

        // 获取周数（周日到周六为一周）
        function getWeekNumber(date) {
            const d = new Date(date);
            // 将日期调整到该周的周日（周日是0，周六是6）
            const dayOfWeek = d.getDay(); // 0=周日, 1=周一, ..., 6=周六
            const sunday = new Date(d);
            sunday.setDate(d.getDate() - dayOfWeek); // 调整到该周的周日
            
            // 计算该周日所在年份的1月1日
            const yearStart = new Date(sunday.getFullYear(), 0, 1);
            // 找到1月1日所在周的周日
            const yearStartDay = yearStart.getDay();
            const yearStartSunday = new Date(yearStart);
            yearStartSunday.setDate(yearStart.getDate() - yearStartDay);
            
            // 计算周数（从1月1日所在周的周日开始计算）
            const diffTime = sunday - yearStartSunday;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const weekNo = Math.floor(diffDays / 7) + 1;
            
            // 处理跨年情况
            if (weekNo < 1) {
                // 如果周数小于1，说明是上一年的最后几周
                const prevYear = new Date(sunday.getFullYear() - 1, 11, 31);
                return getWeekNumber(prevYear);
            }
            
            // 如果周数超过52/53，可能需要调整年份
            if (weekNo > 53) {
                return 1; // 下一年的第一周
            }
            
            return weekNo;
        }

        // 保留ISO周数函数用于兼容（但实际使用getWeekNumber）
        function getISOWeek(date) {
            return getWeekNumber(date);
        }

        // 根据周别代码（如202547）获取该周的周日到周六日期范围
        function getWeekDateRange(weekCode) {
            const year = parseInt(weekCode.substring(0, 4));
            const weekNo = parseInt(weekCode.substring(4));
            
            // 计算该年1月1日
            const yearStart = new Date(year, 0, 1);
            // 找到1月1日所在周的周日
            const yearStartDay = yearStart.getDay();
            const yearStartSunday = new Date(yearStart);
            yearStartSunday.setDate(yearStart.getDate() - yearStartDay);
            
            // 计算目标周的周日（第weekNo周的周日）
            const targetSunday = new Date(yearStartSunday);
            targetSunday.setDate(yearStartSunday.getDate() + (weekNo - 1) * 7);
            
            // 计算该周的周六
            const targetSaturday = new Date(targetSunday);
            targetSaturday.setDate(targetSunday.getDate() + 6);
            
            // 格式化日期为 YYYY/MM/DD
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            }
            
            return {
                sunday: formatDate(targetSunday),
                saturday: formatDate(targetSaturday),
                range: `${formatDate(targetSunday)}~${formatDate(targetSaturday)}`
            };
        }


        function generatePivotTable(data) {
            if (!data || data.length === 0) {
                alert('数据为空');
                return;
            }

            const firstRow = data[0];
            const columnKeys = Object.keys(firstRow);

            const matchesKeyword = (key, keyword) => {
                if (!key) return false;
                const lowerKey = key.toLowerCase();
                return lowerKey.includes(keyword.toLowerCase()) || key.includes(keyword);
            };

            const columnLetterToIndex = (letter) => {
                if (!letter) return null;
                let index = 0;
                const up = letter.trim().toUpperCase();
                for (let i = 0; i < up.length; i++) {
                    const charCode = up.charCodeAt(i);
                    if (charCode < 65 || charCode > 90) return null;
                    index = index * 26 + (charCode - 64);
                }
                return index - 1;
            };

            const getColumnKey = (keywords, fallbackLetter = null) => {
                const key = columnKeys.find(col =>
                    keywords.some(keyword => matchesKeyword(col, keyword))
                );
                if (key) return key;
                if (fallbackLetter) {
                    const idx = columnLetterToIndex(fallbackLetter);
                    if (idx !== null && columnKeys[idx]) {
                        return columnKeys[idx];
                    }
                }
                return null;
            };

            const weekCol = getColumnKey(['周别', '周次', '周数', 'week'], 'R');
            const capacityCol = getColumnKey(['运力', 'teu', '舱位'], 'L');
            // 强制使用 K 列（索引10）作为船名航次列
            // 先通过索引获取，确保使用正确的列
            const kIndex = columnLetterToIndex('K'); // K列 = 索引10
            const shipNameCol = (kIndex !== null && columnKeys[kIndex]) ? columnKeys[kIndex] : getColumnKey(['船名', '航次', 'vessel'], 'K');
            // 强制使用 M 列（索引12）作为开船日期列
            // 先通过索引获取，确保使用正确的列
            const mIndex = columnLetterToIndex('M'); // M列 = 索引12
            const shipDateCol = (mIndex !== null && columnKeys[mIndex]) ? columnKeys[mIndex] : getColumnKey(['开船', '船期', '离港', 'etd', '时间'], 'M');
            const routeIdCol = getColumnKey(['航线id', '航线ID', 'route id', 'group_id', 'groupid'], 'C');
            const routeCol = getColumnKey(['共舱船公司', '共舱', '舱公司', '船公司'], 'G');
            const portCol = getColumnKey(['港口', '目的港', 'pod'], 'B');
            const routeRemarkCol = columnKeys[7] || null; // H列（索引7）

            if (!weekCol || !capacityCol || !shipNameCol || !shipDateCol || !routeCol || !portCol) {
                alert('无法找到必要的列。请检查Excel文件格式。\n\n找到的列：' + columnKeys.join(', '));
                return;
            }

            // 固定显示当周+未来4周（共5周）
            const weekCodes = getWeekRange();
            weekColumns = weekCodes.map(code => {
                const year = code.substring(0, 4);
                const weekNo = parseInt(code.substring(4), 10);
                const dateRange = getWeekDateRange(code);
                return {
                    code,
                    label: `${year}/${String(weekNo).padStart(2, '0')}`,
                    range: dateRange.range
                };
            });

            processedRecords = [];
            destinationFilters = { ports: [] };
            routeFilterValue = '';
            routeLabelMap = {};

            data.forEach(row => {
                const weekText = String(row[weekCol] ?? '').trim();
                const weekCode = parseWeekText(weekText);
                if (!weekCode || !weekCodes.includes(weekCode)) {
                    return;
                }

                const port = normalizeDestinationValue(row[portCol]);
                let route = String(row[routeCol] ?? '').trim();
                const routeId = routeIdCol ? String(row[routeIdCol] ?? '').trim() : '';
                const routeRemark = routeRemarkCol ? String(row[routeRemarkCol] ?? '').trim() : '';
                const capacity = parseFloat(row[capacityCol]) || 0;
                const shipName = String(row[shipNameCol] ?? '').trim();
                // 保留原始值，可能是数字（Excel日期序列号）、Date对象或字符串
                let shipDate = row[shipDateCol];
                // 如果是 null 或 undefined，设置为空字符串
                if (shipDate === null || shipDate === undefined) {
                    shipDate = '';
                }
                // 如果是空字符串，保持为空字符串
                // 注意：不要在这里转换为字符串，保留原始类型以便后续解析

                if (!route) {
                    route = '未知航线';
                }

                if (routeId) {
                    if (route && route !== '未知航线') {
                        registerRouteLabel(routeId, route);
                    }
                    route = getRouteLabel(routeId, route);
                }

                const record = {
                    port,
                    route,
                    routeId,
                    routeRemark,
                    weekCode,
                    capacity,
                    shipName,
                    shipDate
                };
                processedRecords.push(record);
            });

            processedRecords = processedRecords.map(record => ({
                ...record,
                routeLabel: getRouteLabel(record.routeId, record.route)
            }));
            if (processedRecords.length === 0) {
                alert('当前时间范围内没有符合条件的船期数据');
                return;
            }

            updatePortFilterOptions();
            renderTable();
            updateAiAnalysis(false);
        }

        function renderTable() {
            if (!processedRecords.length) {
                tableContainer.classList.add('hidden');
                updateChart(false, []);
                updateAiAnalysis(false);
                return;
            }

            const filteredRecords = getFilteredRecords();
            latestFilteredRecords = filteredRecords;
            // 无论是否选择港口，都按航线分组（合并不同港口），这样同一船名航次在不同港口时不会重复统计
            const hasPortSelection = destinationFilters.ports.length > 0;
            const groupedResult = groupRecords(filteredRecords, false); // 始终不按港口分组，合并相同航线
            const groupedData = groupedResult.data;
            groupedTableData = groupedData;

            const safeRouteValue = (routeFilterValue || '').replace(/"/g, '&quot;');

            tableHead.innerHTML = `
                <tr>
                    <th class="filter-header" style="width: 200px;">航线备注</th>
                    <th class="filter-header">
                        共舱船公司
                        <input type="text" class="filter-input" id="routeFilter" placeholder="筛选共舱船公司..." value="${safeRouteValue}" autocomplete="off">
                    </th>
                    ${weekColumns.map(week => `
                        <th class="week-header week-cell">
                            <div>${week.label}</div>
                            ${week.range ? `<div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">(${week.range})</div>` : ''}
                        </th>
                    `).join('')}
                </tr>
            `;

            const routeFilter = document.getElementById('routeFilter');
            if (routeFilter) {
                let composing = false;
                const newRouteFilter = routeFilter.cloneNode(true);
                routeFilter.parentNode.replaceChild(newRouteFilter, routeFilter);
                newRouteFilter.addEventListener('compositionstart', function() {
                    composing = true;
                });
                newRouteFilter.addEventListener('compositionend', function() {
                    composing = false;
                    routeFilterValue = this.value;
                    setTimeout(() => {
                        renderTable();
                    }, 0);
                });
                newRouteFilter.addEventListener('input', function() {
                    if (!composing) {
                        routeFilterValue = this.value;
                        clearTimeout(newRouteFilter._inputTimeout);
                        newRouteFilter._inputTimeout = setTimeout(() => {
                            renderTable();
                        }, 300);
                    }
                });
            }

            tableBody.innerHTML = '';
            groupedData.forEach(item => {
                const row = document.createElement('tr');
                const cells = [
                    `<td>${item.routeRemark || '—'}</td>`,
                    `<td>${item.routeLabel || '未知航线'}</td>`
                ];

                weekColumns.forEach(week => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    
                    // 计算该周的运力和派船数
                    const totalCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    const shipCount = ships.length;
                    
                    // 构建tooltip内容（船名航次、运力和开船日期）
                    let tooltipData = '';
                    if (ships.length > 0) {
                        const shipDetails = ships.map(ship => {
                            const name = ship.shipName || '未知';
                            const capacity = ship.capacity || 0;
                            let date = ship.shipDate;
                            
                            // 格式化日期为 YYYY/MM/DD
                            // 检查日期是否有效（不是空字符串、null、undefined）
                            const dateIsValid = date !== null && 
                                               date !== undefined && 
                                               date !== '' && 
                                               (typeof date === 'string' ? date.trim() !== '' : true);
                            if (dateIsValid) {
                                try {
                                    let dateObj = null;
                                    
                                    // 先检查是否是 Date 对象
                                    if (date instanceof Date && !isNaN(date.getTime())) {
                                        dateObj = date;
                                    } 
                                    // 再检查是否是数字（Excel日期序列号）
                                    else if (typeof date === 'number') {
                                        // 尝试使用 XLSX 的日期解析（如果可用）
                                        if (typeof XLSX !== 'undefined' && XLSX.SSF && XLSX.SSF.parse_date_code) {
                                            try {
                                                const parsed = XLSX.SSF.parse_date_code(date);
                                                if (parsed) {
                                                    dateObj = new Date(parsed.y, parsed.m - 1, parsed.d, parsed.H || 0, parsed.M || 0, parsed.S || 0);
                                                }
                                            } catch (error) {
                                                // 如果 XLSX 解析失败，使用备用方法
                                            }
                                        }
                                        // 如果 XLSX 解析失败或不可用，使用备用方法
                                        if (!dateObj) {
                                            const numValue = date;
                                            // Excel日期序列号通常在1000-100000之间（1900-2174年）
                                            if (numValue > 1000 && numValue < 100000) {
                                                // Excel日期从1900-01-01开始，但Excel错误地认为1900是闰年
                                                // 所以需要减去1天（除了1900-03-01之前）
                                                const excelEpoch = new Date(1899, 11, 30);
                                                dateObj = new Date(excelEpoch.getTime() + numValue * 24 * 60 * 60 * 1000);
                                                // 修正 Excel 日期偏移
                                                if (dateObj.getFullYear() > 1900 || (dateObj.getFullYear() === 1900 && dateObj.getMonth() >= 2)) {
                                                    dateObj = new Date(dateObj.getTime() - 24 * 60 * 60 * 1000);
                                                }
                                            } else {
                                                // 可能是时间戳
                                                dateObj = new Date(numValue);
                                            }
                                        }
                                    } else {
                                        // 尝试解析字符串日期
                                        const dateStr = String(date).trim();
                                        if (!dateStr || dateStr === '') {
                                            dateObj = null;
                                        } else {
                                            // 如果看起来像日期序列号（纯数字且长度合理）
                                            if (/^\d+$/.test(dateStr) && dateStr.length >= 4 && dateStr.length <= 6) {
                                                const numValue = parseFloat(dateStr);
                                                if (numValue > 1000 && numValue < 100000) {
                                                    const excelEpoch = new Date(1899, 11, 30);
                                                    dateObj = new Date(excelEpoch.getTime() + numValue * 24 * 60 * 60 * 1000);
                                                } else {
                                                    dateObj = new Date(dateStr);
                                                }
                                            } else {
                                                // 尝试解析各种日期格式
                                                dateObj = new Date(dateStr);
                                                // 如果解析失败，尝试其他格式
                                                if (isNaN(dateObj.getTime())) {
                                                    // 尝试 YYYY/MM/DD 格式
                                                    const ymdMatch = dateStr.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                                                    if (ymdMatch) {
                                                        dateObj = new Date(parseInt(ymdMatch[1]), parseInt(ymdMatch[2]) - 1, parseInt(ymdMatch[3]));
                                                    } else {
                                                        // 尝试 MM/DD 格式（假设当前年份）
                                                        const mdMatch = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})/);
                                                        if (mdMatch) {
                                                            const currentYear = new Date().getFullYear();
                                                            dateObj = new Date(currentYear, parseInt(mdMatch[1]) - 1, parseInt(mdMatch[2]));
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    if (dateObj && !isNaN(dateObj.getTime())) {
                                        const year = dateObj.getFullYear();
                                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                        const day = String(dateObj.getDate()).padStart(2, '0');
                                        date = `${year}/${month}/${day}`;
                                    } else {
                                        // 如果解析失败，尝试显示原值，如果是空字符串则显示"未知"
                                        const dateStr = String(date).trim();
                                        date = dateStr || '未知';
                                    }
                                } catch (e) {
                                    // 如果解析失败，尝试显示原值，如果是空字符串则显示"未知"
                                    const dateStr = String(date).trim();
                                    date = dateStr || '未知';
                                }
                            } else {
                                // 如果日期为空或无效，显示"未知"
                                date = '未知';
                            }
                            
                            // 格式：船名航次（K列）+ xx TEU（L列）+ (开航时间)（M列）
                            const capacityStr = capacity > 0 ? `${capacity.toLocaleString()} TEU` : '0 TEU';
                            // 确保格式为：船名航次 + 运力TEU + (开航时间)
                            return `${name} ${capacityStr} (${date})`;
                        }).join('\n');
                        tooltipData = shipDetails;
                    }
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${shipCount}`;
                    } else if (currentView === 'capacity') {
                        cellContent = totalCapacity.toLocaleString() + ' TEU';
                    } else if (currentView === 'ships') {
                        cellContent = shipCount.toString();
                    }
                    
                    // 如果有数据，添加tooltip和悬停样式
                    const cellClass = ships.length > 0 ? 'number-cell hover-cell' : 'number-cell';
                    const tooltipAttr = tooltipData ? `data-tooltip="${tooltipData.replace(/"/g, '&quot;')}"` : '';
                    cells.push(`<td class="${cellClass}" ${tooltipAttr}>${cellContent}</td>`);
                });

                row.innerHTML = cells.join('');
                tableBody.appendChild(row);
            });
            
            const hasDestinationSelection = Boolean(
                destinationFilters.ports.length ||
                routeFilterValue.trim()
            );

            if (hasDestinationSelection && groupedData.length > 0) {
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'summary-row';
                const summaryCells = [
                    '<td><strong>合计</strong></td>',
                    '<td></td>'
                ];

                let totalCapacityByWeek = {};
                let totalShipsByWeek = {};
                
                // 计算每周的合计
                groupedData.forEach(item => {
                    weekColumns.forEach(week => {
                        const weekCode = week.code;
                        const ships = item.weeks[weekCode] || [];
                        const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                        const weekShips = ships.length;
                        
                        if (!totalCapacityByWeek[weekCode]) {
                            totalCapacityByWeek[weekCode] = 0;
                            totalShipsByWeek[weekCode] = 0;
                        }
                        totalCapacityByWeek[weekCode] += weekCapacity;
                        totalShipsByWeek[weekCode] += weekShips;
                    });
                });
                
                weekColumns.forEach(week => {
                    const weekCode = week.code;
                    const totalCapacity = totalCapacityByWeek[weekCode] || 0;
                    const totalShips = totalShipsByWeek[weekCode] || 0;
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${totalShips}`;
                    } else if (currentView === 'capacity') {
                        cellContent = `${totalCapacity.toLocaleString()} TEU`;
                    } else if (currentView === 'ships') {
                        cellContent = `${totalShips}`;
                    }
                    
                    summaryCells.push(`<td class="number-cell"><strong>${cellContent}</strong></td>`);
                });
                
                summaryRow.innerHTML = summaryCells.join('');
                tableBody.appendChild(summaryRow);
            }

            // 添加tooltip事件监听
            const hoverCells = tableBody.querySelectorAll('.hover-cell');
            hoverCells.forEach(cell => {
                const tooltipText = cell.getAttribute('data-tooltip');
                if (!tooltipText) return;
                
                let tooltip = null;
                
                cell.addEventListener('mouseenter', (e) => {
                    tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    // 对于船期信息，直接显示完整文本，使用 pre-wrap 保持格式
                    const displayText = tooltipText;
                    const span = document.createElement('span');
                    span.className = 'tooltip-line';
                    span.textContent = displayText;
                    span.style.whiteSpace = 'pre-wrap';
                    tooltip.appendChild(span);
                    document.body.appendChild(tooltip);
                    
                    // 使用鼠标位置来定位tooltip，这样滚动时也能正确显示
                    const updateTooltipPosition = (event) => {
                        if (!tooltip) return;
                        
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;
                        const tooltipWidth = tooltip.offsetWidth;
                        const tooltipHeight = tooltip.offsetHeight;
                        const padding = 10;
                        
                        // 默认显示在鼠标右下方
                        let tooltipX = mouseX + padding;
                        let tooltipY = mouseY + padding;
                        
                        // 如果右侧空间不够，显示在左侧
                        if (tooltipX + tooltipWidth > window.innerWidth) {
                            tooltipX = mouseX - tooltipWidth - padding;
                        }
                        
                        // 如果左侧也不够，居中显示
                        if (tooltipX < 0) {
                            tooltipX = (window.innerWidth - tooltipWidth) / 2;
                        }
                        
                        // 如果下方空间不够，显示在上方
                        if (tooltipY + tooltipHeight > window.innerHeight) {
                            tooltipY = mouseY - tooltipHeight - padding;
                        }
                        
                        // 如果上方也不够，显示在鼠标位置
                        if (tooltipY < 0) {
                            tooltipY = mouseY + padding;
                        }
                        
                        tooltip.style.left = tooltipX + 'px';
                        tooltip.style.top = tooltipY + 'px';
                    };
                    
                    // 初始定位
                    updateTooltipPosition(e);
                    
                    // 鼠标移动时更新位置
                    cell.addEventListener('mousemove', updateTooltipPosition);
                    cell._tooltipMoveHandler = updateTooltipPosition;
                });
                
                cell.addEventListener('mouseleave', () => {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                    // 移除mousemove事件监听
                    if (cell._tooltipMoveHandler) {
                        cell.removeEventListener('mousemove', cell._tooltipMoveHandler);
                        cell._tooltipMoveHandler = null;
                    }
                });
            });

            if (infoText) {
                const totalCombos = groupedData.length;
                const totalRecords = filteredRecords.length;
                const portText = destinationFilters.ports.length ? destinationFilters.ports.join('、') : '全部港口';
                infoText.textContent = `已加载 ${totalRecords} 条记录，组合 ${totalCombos} 行；筛选港口：${portText}`;
            }

            tableContainer.classList.remove('hidden');
            
            // 更新图表
            updateChart(hasPortSelection, groupedData);
            
            // 更新AI分析区域
            updateAiAnalysis(hasPortSelection);
        }
        
        function updateChart(hasPortSelection, groupedData) {
            const chartContainer = document.getElementById('chartContainer');
            const chartWrapper = document.getElementById('chartWrapper');
            const emptyChartMessage = document.getElementById('emptyChartMessage');
            
            chartContainer.classList.remove('hidden');
            
            if (!hasPortSelection || groupedData.length === 0) {
                chartWrapper.classList.add('hidden');
                emptyChartMessage.classList.remove('hidden');
                if (capacityChart) {
                    capacityChart.destroy();
                    capacityChart = null;
                }
                return;
            }
            
            emptyChartMessage.classList.add('hidden');
            chartWrapper.classList.remove('hidden');
            
            const weekCodes = weekColumns.map(week => week.code);
            const weekLabels = weekColumns.map(week => {
                const range = week.range ? ` (${week.range})` : '';
                return `${week.label}${range}`;
            });
            
            // 准备数据
            const shipData = []; // 每周的总派船数（用于折线图）
            const datasets = [];
            const podRoutePairs = [];
            
            // 收集所有航线备注+共舱船公司组合
            groupedData.forEach(item => {
                const routeLabel = item.routeLabel || '未知航线';
                const routeRemark = item.routeRemark || '—';
                podRoutePairs.push({
                    label: `${routeRemark} - ${routeLabel}`,
                    routeLabel: routeLabel,
                    routeId: item.routeId || '',
                    routeRemark: routeRemark
                });
            });
            
            // 为每个目的港+航线组合创建运力数据集
            podRoutePairs.forEach((pair, index) => {
                const item = groupedData[index];
                const capacityValues = [];
                
                weekCodes.forEach(weekCode => {
                    const ships = item.weeks[weekCode] || [];
                    const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    capacityValues.push(weekCapacity);
                });
                
                // 生成颜色
                const hue = (index * 137.508) % 360; // 使用黄金角度分布颜色
                const color = `hsl(${hue}, 70%, 50%)`;
                
                datasets.push({
                    label: pair.label,
                    data: capacityValues,
                    type: 'bar',
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1
                });
            });
            
            // 计算每周的总派船数
            weekCodes.forEach(weekCode => {
                let totalShips = 0;
                groupedData.forEach(item => {
                    const ships = item.weeks[weekCode] || [];
                    totalShips += ships.length;
                });
                shipData.push(totalShips);
            });
            
            // 添加派船折线图数据集
            datasets.push({
                label: '派船总数',
                data: shipData,
                type: 'line',
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                yAxisID: 'y1'
            });
            
            // 销毁旧图表
            if (capacityChart) {
                capacityChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('trendChart').getContext('2d');
            capacityChart = new Chart(ctx, {
                data: {
                    labels: weekLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '运力与派船趋势分析',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '周别'
                            }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '运力 (TEU)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '派船数'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // AI分析相关功能
        const aiProviders = {
            deepseek: {
                id: 'deepseek',
                name: 'DeepSeek',
                keyInputId: 'apiKeyInput',
                urlInputId: 'apiUrlInput',
                modelInputId: 'apiModelInput',
                buttonId: 'aiAnalysisBtn',
                loadingId: 'aiLoading',
                resultContainerId: 'aiResult',
                resultContentId: 'aiResultContent',
                defaultUrl: 'https://api.deepseek.com/v1/chat/completions',
                defaultModel: 'deepseek-chat',
                storagePrefix: 'deepseek',
                temperature: 0.7,
                maxTokens: 2000
            },
            kimi: {
                id: 'kimi',
                name: 'KIMI (Moonshot)',
                keyInputId: 'kimiApiKeyInput',
                urlInputId: 'kimiApiUrlInput',
                modelInputId: 'kimiModelInput',
                buttonId: 'kimiAnalysisBtn',
                loadingId: 'kimiAiLoading',
                resultContainerId: 'kimiAiResult',
                resultContentId: 'kimiAiResultContent',
                defaultUrl: 'https://api.moonshot.cn/v1/chat/completions',
                defaultModel: 'moonshot-v1-32k',
                storagePrefix: 'kimi',
                temperature: 0.7,
                maxTokens: 2000
            },
            qwen: {
                id: 'qwen',
                name: '通义千问 (Qwen)',
                keyInputId: 'qwenApiKeyInput',
                urlInputId: 'qwenApiUrlInput',
                modelInputId: 'qwenModelInput',
                buttonId: 'qwenAnalysisBtn',
                loadingId: 'qwenAiLoading',
                resultContainerId: 'qwenAiResult',
                resultContentId: 'qwenAiResultContent',
                defaultUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                defaultModel: 'qwen-max',
                storagePrefix: 'qwen',
                temperature: 0.7,
                maxTokens: 2000
            }
        };
        const baseSystemPrompt = '你是一名资深海运公司定价与航线分析专家，熟悉全球主要航线（美西、美东、欧基、欧地、东南亚、中东、南美）的供需逻辑、空班机制、港口操作与 SCFI 指数。';
        const aiInstructionTemplate = `
【AI任务说明】
你是一名顶级海运公司定价与航线分析专家，熟悉美西、美东、欧基、欧地、东南亚、中东印巴、南美等航线的供需节奏、空班机制、港口操作规律与 SCFI/WCI/FBX 逻辑。你服务的主要起运港为青岛（货源地山东、覆盖沿黄流域）。务必综合：
1) Excel 中 schedule 数据（如存在 market 模块则同步引用历史价格及区间摘要）；
2) “其他影响因素”表格内的收货情况、码头情况、额外运力、市场运费、其他事件；
3) 用户上传的 PDF（如 Linerlytica Weekly、Alphaliner Newsletter等）；
4) Ship & Bunker 新加坡 VLSFO / MGO / IFO380 最新燃油价格；
5) 必要时参考公开渠道及最新航运预测研究（例如 STL+RL 动态区间预测、LSTM/CNN 运力预测等），并注明来源。
输出本周“运价调整分析报告”，给出明确涨/维/降建议。

【自动航线识别】
根据目的港或航线数据自动识别航线类型（美西、美东、欧基、欧地、东南亚、中东、印巴、南美东、西、澳新、非洲、地中海、红海绕/不绕航），结合舱位结构、绕航特征展开分析。

【供需矩阵判断】
- 运力充足 + 订舱火爆 =“真正旺季”，建议聚焦控价与优先客户。
- 运力充足 + 订舱低迷 =“淡季/供过于求”，需检视报价是否偏离市场，并给出让利幅度或新增需求建议。
- 运力短缺 + 订舱火爆 =“结构性爆舱”，指出卡位航次、联盟动作、加班船及甩柜风险。
- 运力短缺 + 订舱低迷 =“错配/定价偏离”，要求分析目标客户结构、竞争对手策略。
所有判断需逐周对比未来四周有效运力（TEU/班次）与用户提供的订舱/现行报价，明确供需属于哪一象限。

【自动数据获取与引用规则】
当用户资料不足时，按以下优先级补充并注明来源（如“基于网页运力模块统计”“基于用户上传 PDF”“基于公开资料”）：
1. 市场有效运力变化：逐周列出 TEU/班次，解释空班、加开、缩减、航班挤压、绕航、跳靠、船型切换、联盟调舱等驱动，可引用 Linerlytica/Alphaliner 以交叉验证。
2. 港口天气与拥堵：优先引用“码头情况”与 PDF，必要时补充官方公告，量化等待天数或靠泊效率。
3. 查验率 / 政策：列明政策名称、生效日期、涉及范围与查验或费用变化。
4. 红海及地缘风险：说明最新时间节点及对航程/舱位的影响。
5. 指数对比：列出 CCFI/SCFI/WCI/FBX 全球与重点航线指数，对比用户现行报价与运费走势图，解释背离原因（指数滞后、客户结构差异等）。
6. 目的港码头/河港效率：若缺失则补充公开资料并量化（靠泊等待 X 天、吃水限制减少 Y% 有效运力等）。
7. 竞争对手策略：结合“市场运费”现行报价、极端报价、指数走势与 PDF，判断 Promo、GRI、空班、重柜限制等策略，并标注由头部或中小船公司主导。
8. 山东/沿黄货源趋势：引用青岛/济南海关按产业或区域的 YoY/WoW，结合季节性（春节备货、欧美签约季、黑五/圣诞）。
9. “额外运力”“其他事件”：逐条回应，引用具体航次、TEU、政策时间；为空则补足公开数据并量化。
10. 燃油/Bunker：引用 Ship & Bunker 报价与 WoW（若抓取失败需说明），有 PDF 值则对比。

【量化与一致性要求】
- 任何结论必须给出数值（TEU、船次、价格、指数、百分比、YoY/WoW、等待天数等），禁止“略有增加”。
- 将“未来两周订舱情况（用户填报）”与“市场有效运力”视为同权核心指标，需计算每周运力相对当前订舱/装载率的覆盖比例，描述供需象限变化。
- 涨/维/降建议需同步说明：现行报价 vs 极端报价、SCFI/WCI/FBX/CCFI、运费走势图三者是否一致；若不一致，解释原因并给出权重。
- 对 Linerlytica/Alphaliner 与网页数据的差异需说明统计口径（全球 vs 青岛）并估算误差区间。

【模型评分机制】
按照下列权重量化评分，最终分值 ≥3.6 判定涨价，2.6–3.5 维持，<2.6 降价。
一、需求面（33%）
  1. 未来两周订舱情况（20%）：100% = 目标装载率；<90% 偏弱；100–110% 中性；>120% 强势。需含 YoY/WoW、重点流向、重箱占比、山东/沿黄货源特征。
  2. 季节性因素（8%）：结合青岛/济南海关及当年春节、欧美签约季、黑五/圣诞等。
  3. 宏观需求（5%）：PMI、库存、消费信心等。
二、供给面（32%）
  1. 市场有效运力（20%）：逐周列出未来四周可用运力/班次，结合空班、挤压、绕航、跳靠、船型切换、联盟调舱等驱动，判断宽松/吃紧/分化。
  2. 竞争对手策略（12%）：联盟动作、Promo、GRI、空班或重柜限制，区分头部/中小船公司影响。
三、突发事件（20%）
  1. 黑天鹅（10%）：红海、地缘、制裁、罢工及最新复航预期。
  2. 天气/拥堵（6%）：青岛、目的港、途径关键港。
  3. 政策 / 查验变化（4%）。
四、内部策略（7%）
  1. 航线营收 / HQ 指令（4%）。
  2. 成本变化（3%）：燃油、码头、拖车等。
五、市场指数（8%）
  - SCFI/WCI/FBX/CCFI 涨跌、连续性、对市场价偏离度与客户敏感度。

【运费综合考量】
在结论处需同步呈现：
1. 用户现行报价是否与指数/走势图一致；
2. 极端报价（区分头部/中小船公司）及潜在影响力；
3. 运费走势图最近 2–4 周 20GP/40GP 趋势、拐点、波动幅度、相对历史分位；
4. CCFI/SCFI/WCI/FBX 的 WoW/YoY 与现行报价的偏离度；
5. 若三者信号不一致，解释权重分配，并给出谨慎或渐进型建议。

【输出结构】
1. 本周结论（涨/维/降 + 核心逻辑 + 数据来源）。
2. 五大类评分表（维度 / 评分 / 权重 / 加权分 + 总分与判定）。
3. 需求面分析（含供需象限结论、订舱 YoY/WoW、装载率、山东/沿黄货源）。
4. 供给面分析（有效周运力、空班/跳港/改道/挤压、竞争对手策略、目的港限制）。
5. 突发事件影响（红海及其他黑天鹅）。
6. 内部策略与成本（含 Ship & Bunker 数据或缺失说明）。
7. 指数解读（SCFI/WCI/FBX/CCFI 与报价/走势图的偏离原因）。
8. 风险提示。
9. 下周展望与可执行建议（调价、控舱、甩柜预警、客户沟通要点）。

【特别要求】
- 自动识别航线类型，并结合航程/船型/绕航结构解释供需差异。
- 若用户数据不足，务必补足公开资料并注明“推算”或“外部估值”。
- 结论必须契合青岛港现实操作与山东货源结构，语言需专业、客观、可执行。

【模型增强参考】
- 可提示用户后续引入 STL+RL 动态区间预测或 LSTM/CNN 运力预测方法，以提升对特定港口航线的供需预估精度；若引用此类研究，请简述方法与作用场景。
`;
        let activeAiProvider = 'deepseek';

        const aiTabButtons = document.querySelectorAll('.ai-tab-btn');
        const aiPanels = document.querySelectorAll('.ai-panel');

        aiTabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const providerId = btn.dataset.provider;
                setActiveAiPanel(providerId);
            });
        });

        function setActiveAiPanel(providerId = 'deepseek') {
            if (!aiProviders[providerId]) return;
            activeAiProvider = providerId;
            aiTabButtons.forEach(btn => {
                if (btn.dataset.provider === providerId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            aiPanels.forEach(panel => {
                if (panel.dataset.provider === providerId) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
        }

        function loadAiConfigs() {
            Object.values(aiProviders).forEach(provider => {
                const keyInput = document.getElementById(provider.keyInputId);
                const urlInput = document.getElementById(provider.urlInputId);
                const modelInput = document.getElementById(provider.modelInputId);
                const savedKey = localStorage.getItem(`${provider.storagePrefix}_api_key`) || '';
                const savedUrl = localStorage.getItem(`${provider.storagePrefix}_api_url`) || provider.defaultUrl;
                const savedModel = localStorage.getItem(`${provider.storagePrefix}_model`) || provider.defaultModel;
                if (keyInput) keyInput.value = savedKey;
                if (urlInput) urlInput.value = savedUrl;
                if (modelInput) modelInput.value = savedModel;
            });
        }

        function getAiConfig(providerId = 'deepseek') {
            const provider = aiProviders[providerId];
            if (!provider) return null;
            const keyInput = document.getElementById(provider.keyInputId);
            const urlInput = document.getElementById(provider.urlInputId);
            const modelInput = document.getElementById(provider.modelInputId);
            return {
                apiKey: keyInput ? keyInput.value.trim() : '',
                apiUrl: urlInput ? (urlInput.value.trim() || provider.defaultUrl) : provider.defaultUrl,
                model: modelInput ? (modelInput.value.trim() || provider.defaultModel) : provider.defaultModel
            };
        }

        function saveAiConfig(providerId = 'deepseek') {
            const provider = aiProviders[providerId];
            if (!provider) return;
            const config = getAiConfig(providerId);
            if (!config) return;
            localStorage.setItem(`${provider.storagePrefix}_api_key`, config.apiKey);
            localStorage.setItem(`${provider.storagePrefix}_api_url`, config.apiUrl);
            localStorage.setItem(`${provider.storagePrefix}_model`, config.model);
            alert(`${provider.name} API 配置已保存`);
        }

        async function fetchBunkerData(force = false) {
            const sixHours = 6 * 60 * 60 * 1000;
            if (!force && bunkerData && Date.now() - bunkerData.timestamp < sixHours) {
                updateBunkerStatus();
                return bunkerData;
            }
            bunkerStatusEl && (bunkerStatusEl.textContent = '正在从 Ship & Bunker 抓取...');
            const text = await fetchTextContent('https://r.jina.ai/https://www.shipandbunker.com/prices');
            const tables = extractBunkerTables(text);
            const result = { timestamp: Date.now(), source: 'Ship & Bunker' };
            const fuelOrder = [
                { key: 'vlsfo', label: 'VLSFO 0.5%', tableIndex: 0 },
                { key: 'mgo', label: 'MGO 0.1%', tableIndex: 1 },
                { key: 'ifo380', label: 'IFO380', tableIndex: 2 }
            ];
            fuelOrder.forEach(item => {
                const tableText = tables[item.tableIndex];
                if (tableText) {
                    const parsed = parseBunkerTable(tableText);
                    if (parsed) {
                        result[item.key] = { ...parsed, label: item.label };
                    }
                }
            });
            bunkerData = result;
            updateBunkerStatus();
            return bunkerData;
        }

        function extractBunkerTables(text) {
            const normalized = text.replace(/\r/g, '');
            const tables = [];
            const regex = /\| Port \|[\s\S]*?(?=\n\n|$)/g;
            let match;
            while ((match = regex.exec(normalized)) !== null) {
                tables.push(match[0]);
            }
            return tables;
        }

        function parseBunkerTable(tableText) {
            const sgLine = tableText.split('\n').find(line => line.includes('[Singapore]'));
            if (!sgLine) return null;
            const cols = sgLine.split('|').map(col => col.trim());
            const price = parseFloat(cols[2]);
            const change = parseFloat((cols[3] || '').replace(/[^\d+\-\.]/g, ''));
            if (!isFinite(price)) return null;
            return {
                price,
                delta: isFinite(change) ? change : null
            };
        }

        function updateBunkerStatus() {
            if (!bunkerStatusEl) return;
            if (!bunkerData || (!bunkerData.vlsfo && !bunkerData.mgo)) {
                bunkerStatusEl.textContent = '尚未抓取燃油报价';
                bunkerUpdatedEl && (bunkerUpdatedEl.textContent = '最近更新时间：—');
                return;
            }
            const parts = [];
            if (bunkerData.vlsfo) {
                parts.push(describeBunkerLine('VLSFO 0.5%', bunkerData.vlsfo));
            }
            if (bunkerData.mgo) {
                parts.push(describeBunkerLine('MGO 0.1%', bunkerData.mgo));
            }
            if (bunkerData.ifo380) {
                parts.push(describeBunkerLine('IFO380', bunkerData.ifo380));
            }
            bunkerStatusEl.textContent = parts.join('；');
            if (bunkerUpdatedEl) {
                bunkerUpdatedEl.textContent = `最近更新时间：${new Date(bunkerData.timestamp).toLocaleString()}`;
            }
        }

        function describeBunkerLine(label, data) {
            const priceText = typeof data.price === 'number' ? `${data.price.toFixed(2)} USD/t` : '—';
            let deltaText = '';
            if (typeof data.delta === 'number') {
                const formatted = data.delta >= 0 ? `+${data.delta.toFixed(2)}` : data.delta.toFixed(2);
                deltaText = `（WoW ${formatted}）`;
            }
            return `${label}：${priceText}${deltaText}`;
        }

        const ccfiRoutes = [
            { label: '综合指数', match: 'CHINA CONTAINERIZED FREIGHT INDEX', parenthesized: false },
            { label: '日本航线', match: 'JAPAN SERVICE', parenthesized: true },
            { label: '欧洲航线', match: 'EUROPE SERVICE', parenthesized: true },
            { label: '美西航线', match: 'W/C AMERICA SERVICE', parenthesized: true },
            { label: '美东航线', match: 'E/C AMERICA SERVICE', parenthesized: true },
            { label: '韩国航线', match: 'KOREA SERVICE', parenthesized: true },
            { label: '东南亚航线', match: 'SOUTHEAST ASIA SERVICE', parenthesized: true },
            { label: '地中海航线', match: 'MEDITERRANEAN SERVICE', parenthesized: true },
            { label: '澳新航线', match: 'AUSTRALIA/NEW ZEALAND SERVICE', parenthesized: true },
            { label: '南非航线', match: 'SOUTH AFRICA SERVICE', parenthesized: true },
            { label: '南美航线', match: 'SOUTH AMERICA SERVICE', parenthesized: true },
            { label: '东西非航线', match: 'WEST EAST AFRICA SERVICE', parenthesized: true },
            { label: '波红航线', match: 'PERSIAN GULF/RED SEA SERVICE', parenthesized: true }
        ];

        async function fetchCcfiData(force = false) {
            const sixHours = 6 * 60 * 60 * 1000;
            if (!force && ccfiData && Date.now() - ccfiData.timestamp < sixHours) {
                renderCcfiStatus();
                return ccfiData;
            }
            if (ccfiStatusEl) ccfiStatusEl.textContent = '正在抓取 CCFI 数据...';
            const url = 'https://r.jina.ai/https://www.sse.net.cn/index/singleIndex?indexType=ccfi';
            const text = await fetchTextContent(url, { encoding: 'gb18030' });
            ccfiData = parseCcfiText(text);
            saveCachedData(CACHE_KEYS.ccfi, ccfiData);
            renderCcfiStatus();
            return ccfiData;
        }

        function parseCcfiText(text) {
            const normalized = text.replace(/\r/g, '');
            const headerMatch = normalized.match(/上期(\d{4}-\d{2}-\d{2}).*?本期(\d{4}-\d{2}-\d{2})/);
            const result = {
                timestamp: Date.now(),
                period: headerMatch ? { previous: headerMatch[1], current: headerMatch[2] } : null,
                routes: []
            };
            ccfiRoutes.forEach(route => {
                const escaped = escapeRegex(route.match);
                const target = route.parenthesized ? `\\(${escaped}\\)` : escaped;
                const regex = new RegExp(`${target}[\\s\\S]{0,80}?([\\d\\.]+)\\s+([\\d\\.]+)\\s*([+\\-]?\\d+(?:\\.\\d+)?)`, 'i');
                const match = normalized.match(regex);
                if (match) {
                    const previous = parseFloat(match[1]);
                    const current = parseFloat(match[2]);
                    const wow = parseFloat(match[3]);
                    result.routes.push({
                        id: route.match,
                        label: route.label,
                        previous: isFinite(previous) ? previous : null,
                        current: isFinite(current) ? current : null,
                        wow: isFinite(wow) ? wow : null
                    });
                }
            });
            return result;
        }

        function renderCcfiStatus() {
            if (!ccfiStatusEl) return;
            if (!ccfiData || !ccfiData.routes?.length) {
                ccfiStatusEl.textContent = '尚未抓取 CCFI 数据';
                ccfiUpdatedEl && (ccfiUpdatedEl.textContent = '最近更新时间：—');
                return;
            }
            const lines = [];
            if (ccfiData.period) {
                lines.push(`本期：${ccfiData.period.current || '—'}（对比上期 ${ccfiData.period.previous || '—'}）`);
            }
            ccfiData.routes.forEach(route => {
                const currentText = typeof route.current === 'number' ? route.current.toLocaleString() : '—';
                const previousText = typeof route.previous === 'number' ? route.previous.toLocaleString() : '—';
                lines.push(`${route.label}：${currentText}（上期 ${previousText}，WoW ${formatPercent(route.wow)}）`);
            });
            ccfiStatusEl.textContent = lines.join('\n');
            if (ccfiUpdatedEl) {
                ccfiUpdatedEl.textContent = `最近更新时间：${new Date(ccfiData.timestamp).toLocaleString()}`;
            }
        }

        async function fetchWciData(force = false) {
            const sixHours = 6 * 60 * 60 * 1000;
            if (!force && wciData && Date.now() - wciData.timestamp < sixHours) {
                renderWciStatus();
                return wciData;
            }
            if (wciStatusEl) wciStatusEl.textContent = '正在抓取 WCI 数据...';
            const url = 'https://r.jina.ai/https://www.drewry.co.uk/supply-chain-advisors/supply-chain-expertise/world-container-index-assessed-by-drewry';
            const text = await fetchTextContent(url);
            const previousCache = loadCachedData(CACHE_KEYS.wci);
            wciData = parseWciText(text);
            applyWoWFromCache(wciData, previousCache, { routeKey: 'code', valueKey: 'rate', targetCollection: 'routes' });
            saveCachedData(CACHE_KEYS.wci, wciData);
            renderWciStatus();
            return wciData;
        }

        function parseWciText(text) {
            const normalized = text.replace(/\r/g, ' ');
            const result = { timestamp: Date.now(), worldIndex: null, changePct: null, routes: [] };
            Object.entries(wciCodeMap).forEach(([code, label]) => {
                const regex = new RegExp(`${code}\\s*(?:=|:)?\\s*\\$?([\\d,]+(?:\\.\\d+)?)`, 'i');
                const match = normalized.match(regex);
                if (match) {
                    const value = parseFloat(match[1].replace(/,/g, ''));
                    if (isFinite(value)) {
                        if (code === 'WCI-COMPOSITE') {
                            result.worldIndex = value;
                            const changeRegex = new RegExp(`${code}[^%]*(?:\\(|\\s)([+\\-]?\\d+(?:\\.\\d+)?)%`, 'i');
                            const changeMatch = normalized.match(changeRegex);
                            if (changeMatch) {
                                result.changePct = parseFloat(changeMatch[1]);
                            }
                        } else {
                            result.routes.push({ code, route: label, rate: value });
                        }
                    }
                }
            });
            if (!result.routes.length) {
                const fallbackMap = [
                    { code: 'WCI-SHA-RTM', label: wciCodeMap['WCI-SHA-RTM'], regex: /Shanghai to Rotterdam[^$]*\$(\d[\d,]*)/i },
                    { code: 'WCI-SHA-GOA', label: wciCodeMap['WCI-SHA-GOA'], regex: /Shanghai to Genoa[^$]*\$(\d[\d,]*)/i },
                    { code: 'WCI-SHA-LAX', label: wciCodeMap['WCI-SHA-LAX'], regex: /to Los Angeles[^$]*\$(\d[\d,]*)/i },
                    { code: 'WCI-SHA-NYC', label: wciCodeMap['WCI-SHA-NYC'], regex: /Shanghai to New York[^$]*\$(\d[\d,]*)/i },
                    { code: 'WCI-RTM-SHA', label: wciCodeMap['WCI-RTM-SHA'], regex: /Rotterdam to Shanghai[^$]*\$(\d[\d,]*)/i },
                    { code: 'WCI-LAX-SHA', label: wciCodeMap['WCI-LAX-SHA'], regex: /Los Angeles to Shanghai[^$]*\$(\d[\d,]*)/i },
                    { code: 'WCI-NYC-RTM', label: wciCodeMap['WCI-NYC-RTM'], regex: /New York to Rotterdam[^$]*\$(\d[\d,]*)/i },
                    { code: 'WCI-RTM-NYC', label: wciCodeMap['WCI-RTM-NYC'], regex: /Rotterdam to New York[^$]*\$(\d[\d,]*)/i }
                ];
                fallbackMap.forEach(({ code, label, regex }) => {
                    const match = normalized.match(regex);
                    if (match) {
                        const value = parseFloat(match[1].replace(/,/g, ''));
                        if (isFinite(value)) {
                            result.routes.push({ code, route: label, rate: value });
                        }
                    }
                });
            }
            if (result.worldIndex === null) {
                const compositeMatch = normalized.match(/World Container Index.*?(decreased|increased)\s+(\d+)%\s+to\s+\$([\d,]+)/i);
                if (compositeMatch) {
                    const sign = compositeMatch[1].toLowerCase().includes('decrease') ? -1 : 1;
                    result.changePct = sign * parseFloat(compositeMatch[2]);
                    const compositeValue = parseFloat(compositeMatch[3].replace(/,/g, ''));
                    if (isFinite(compositeValue)) {
                        result.worldIndex = compositeValue;
                    }
                }
            }
            return result;
        }

        function renderWciStatus() {
            if (!wciStatusEl) return;
            if (!wciData) {
                wciStatusEl.textContent = '尚未抓取 WCI 数据';
                wciUpdatedEl && (wciUpdatedEl.textContent = '最近更新时间：—');
                return;
            }
            const lines = [];
            if (typeof wciData.worldIndex === 'number') {
                let headline = `全球指数：${wciData.worldIndex.toLocaleString()} USD/FEU`;
                if (typeof wciData.worldIndexWoW === 'number') {
                    headline += `（WoW ${formatPercent(wciData.worldIndexWoW)}）`;
                } else if (typeof wciData.changePct === 'number') {
                    headline += `（${wciData.changePct >= 0 ? '+' : ''}${wciData.changePct}% WoW）`;
                }
                lines.push(headline);
            }
            if (wciData.routes?.length) {
                wciData.routes.slice(0, 8).forEach(route => {
                    const codeLabel = route.code ? `${route.code} ` : '';
                    let detail = `${codeLabel}${route.route}：${route.rate.toLocaleString()} USD/FEU`;
                    if (typeof route.wow === 'number') {
                        detail += `（WoW ${formatPercent(route.wow)}）`;
                    }
                    lines.push(detail);
                });
            }
            wciStatusEl.textContent = lines.length ? lines.join('\n') : '未解析到航线价格';
            if (wciUpdatedEl) {
                wciUpdatedEl.textContent = `最近更新时间：${new Date(wciData.timestamp).toLocaleString()}`;
            }
        }

        const wciCodeMap = {
            'WCI-COMPOSITE': '全球综合',
            'WCI-SHA-RTM': '上海 → 鹿特丹',
            'WCI-RTM-SHA': '鹿特丹 → 上海',
            'WCI-SHA-GOA': '上海 → 热那亚',
            'WCI-SHA-LAX': '上海 → 洛杉矶',
            'WCI-LAX-SHA': '洛杉矶 → 上海',
            'WCI-SHA-NYC': '上海 → 纽约',
            'WCI-NYC-RTM': '纽约 → 鹿特丹',
            'WCI-RTM-NYC': '鹿特丹 → 纽约'
        };

        const fbxCodeMap = {
            FBX: 'FBX（Freightos Baltic Index 全球综合）',
            FBX01: 'FBX01 中国/东亚 → 北美西海岸',
            FBX02: 'FBX02 北美西海岸 → 中国/东亚',
            FBX03: 'FBX03 中国/东亚 → 北美东海岸',
            FBX04: 'FBX04 北美东海岸 → 中国/东亚',
            FBX11: 'FBX11 中国/东亚 → 北欧',
            FBX12: 'FBX12 北欧 → 中国/东亚',
            FBX13: 'FBX13 中国/东亚 → 地中海',
            FBX14: 'FBX14 地中海 → 中国/东亚',
            FBX21: 'FBX21 北美东海岸 → 北欧',
            FBX22: 'FBX22 北欧 → 北美东海岸',
            FBX24: 'FBX24 欧洲 → 南美东海岸',
            FBX26: 'FBX26 欧洲 → 南美西海岸'
        };

        async function fetchFbxData(force = false) {
            const threeHours = 3 * 60 * 60 * 1000;
            if (!force && fbxData && Date.now() - fbxData.timestamp < threeHours) {
                renderFbxStatus();
                return fbxData;
            }
            if (fbxStatusEl) fbxStatusEl.textContent = '正在抓取 FBX 数据...';
            const url = 'https://r.jina.ai/https://fbx.freightos.com/';
            const text = await fetchTextContent(url);
            fbxData = parseFbxText(text);
            saveCachedData(CACHE_KEYS.fbx, fbxData);
            renderFbxStatus();
            return fbxData;
        }

        function parseFbxText(text) {
            const normalized = text.replace(/\r/g, '');
            const indices = [];
            Object.entries(fbxCodeMap).forEach(([code, label]) => {
                const idx = normalized.indexOf(code);
                if (idx === -1) return;
                const segment = normalized.slice(idx, idx + 300);
                const priceMatch = segment.match(/\$([0-9.,]+)/);
                const changeMatch = segment.match(/([+\-]?\d+(?:\.\d+)?)%/);
                if (priceMatch) {
                    const rate = parseFloat(priceMatch[1].replace(/,/g, ''));
                    if (isFinite(rate)) {
                        indices.push({
                            code,
                            label,
                            rate,
                            wow: changeMatch ? parseFloat(changeMatch[1]) : null
                        });
                    }
                }
            });
            return { timestamp: Date.now(), indices };
        }

        function renderFbxStatus() {
            if (!fbxStatusEl) return;
            if (!fbxData || !fbxData.indices?.length) {
                fbxStatusEl.textContent = '尚未抓取 FBX 数据';
                fbxUpdatedEl && (fbxUpdatedEl.textContent = '最近更新时间：—');
                return;
            }
            const lines = [];
            fbxData.indices.forEach(item => {
                let line = `${item.label}：${item.rate.toLocaleString()} USD/FEU`;
                if (typeof item.wow === 'number') {
                    line += `（WoW ${formatPercent(item.wow)}）`;
                }
                lines.push(line);
            });
            fbxStatusEl.textContent = lines.join('\n');
            if (fbxUpdatedEl) {
                fbxUpdatedEl.textContent = `最近更新时间：${new Date(fbxData.timestamp).toLocaleString()}`;
            }
        }

        const cachedCcfi = loadCachedData(CACHE_KEYS.ccfi);
        if (cachedCcfi) {
            ccfiData = cachedCcfi;
            renderCcfiStatus();
        }
        const cachedWci = loadCachedData(CACHE_KEYS.wci);
        if (cachedWci) {
            wciData = cachedWci;
            renderWciStatus();
        }
        const cachedFbx = loadCachedData(CACHE_KEYS.fbx);
        if (cachedFbx) {
            fbxData = cachedFbx;
            renderFbxStatus();
        }

        async function fetchTextContent(url, options = {}) {
            const response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) {
                throw new Error(`无法加载数据：${response.status} ${response.statusText}`);
            }
            if (options.encoding && window.TextDecoder) {
                try {
                    const buffer = await response.arrayBuffer();
                    const decoder = new TextDecoder(options.encoding);
                    return decoder.decode(buffer);
                } catch (error) {
                    console.warn('自定义编码解析失败，回退到默认编码', error);
                }
            }
            return response.text();
        }

        function updateAiAnalysis(hasPortSelection) {
            const aiAnalysisContainer = document.getElementById('aiAnalysisContainer');
            const emptyAiMessage = document.getElementById('emptyAiMessage');
            const aiConfigSection = document.getElementById('aiConfigSection');
            
            aiAnalysisContainer.classList.remove('hidden');
            
            if (!hasPortSelection || latestFilteredRecords.length === 0) {
                emptyAiMessage.classList.remove('hidden');
                aiConfigSection.classList.add('hidden');
                return;
            }
            
            emptyAiMessage.classList.add('hidden');
            aiConfigSection.classList.remove('hidden');
            loadAiConfigs();
            setActiveAiPanel(activeAiProvider);
        }

        async function runAiAnalysis(providerId = 'deepseek') {
            const provider = aiProviders[providerId] || aiProviders.deepseek;
            if (!provider) return;
            const config = getAiConfig(providerId);
            if (!config || !config.apiKey) {
                alert(`请先配置 ${provider?.name || 'AI'} 的 API Key`);
                return;
            }
            await Promise.allSettled([
                fetchBunkerData(false),
                fetchCcfiData(false),
                fetchWciData(false),
                fetchFbxData(false)
            ]);
            const prompt = buildAiPrompt();
            if (!prompt) {
                return;
            }

            const button = document.getElementById(provider.buttonId);
            const loading = document.getElementById(provider.loadingId);
            const resultContainer = document.getElementById(provider.resultContainerId);
            const resultContent = document.getElementById(provider.resultContentId);

            if (button) button.disabled = true;
            if (loading) loading.classList.remove('hidden');
            if (resultContainer) resultContainer.classList.add('hidden');

            try {
                const response = await fetch((config.apiUrl || provider.defaultUrl), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model || provider.defaultModel,
                        messages: [
                            { role: 'system', content: baseSystemPrompt },
                            { role: 'user', content: prompt }
                        ],
                        temperature: provider.temperature,
                        max_tokens: provider.maxTokens
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API请求失败: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const analysisText = data.choices?.[0]?.message?.content || '分析结果为空';
                if (resultContent) {
                    resultContent.textContent = analysisText;
                }
                if (resultContainer) {
                    resultContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('AI分析失败:', error);
                if (resultContent) {
                    resultContent.textContent = `分析失败：${error.message}\n\n请检查：\n1. API Key 是否正确\n2. 网络连接是否正常\n3. API URL / 模型是否正确`;
                }
                if (resultContainer) {
                    resultContainer.classList.remove('hidden');
                }
            } finally {
                if (button) button.disabled = false;
                if (loading) loading.classList.add('hidden');
            }
        }

        function buildAiPrompt() {
            const filteredRecords = latestFilteredRecords;
            if (!filteredRecords.length) {
                alert('没有可分析的数据');
                return null;
            }
            // 无论是否选择港口，都按航线分组（合并不同港口），这样同一船名航次在不同港口时不会重复统计
            const hasPortSelection = destinationFilters.ports.length > 0;
            // 始终不按港口分组，合并相同航线
            const analysisGroups = groupedTableData.length ? groupedTableData : groupRecords(filteredRecords, false).data;
            if (!analysisGroups.length) {
                alert('没有可分析的航线数据');
                return null;
            }

            const weekCodes = weekColumns.map(week => week.code);
            if (!weekCodes.length) {
                alert('暂未找到可用于分析的周别');
                return null;
            }

            const labelByCode = {};
            weekColumns.forEach(week => {
                const range = week.range ? ` (${week.range})` : '';
                labelByCode[week.code] = `${week.label}${range}`;
            });

            const analysisWeekCodes = weekCodes.length > 1 ? weekCodes.slice(1) : weekCodes;
            if (!analysisWeekCodes.length) {
                alert('当周+未来四周数据不足，请检查 Excel 是否包含最新船期');
                return null;
            }
            const analysisWeekLabels = analysisWeekCodes.map(code => labelByCode[code] || code);

            const analysisData = [];
            const weeklySummary = {};
            analysisWeekCodes.forEach(code => {
                weeklySummary[code] = { capacity: 0, ships: 0 };
            });

            analysisGroups.forEach(item => {
                const weekData = {};
                analysisWeekCodes.forEach(weekCode => {
                    const ships = item.weeks[weekCode] || [];
                    const totalCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    const shipCount = ships.length;
                    weeklySummary[weekCode].capacity += totalCapacity;
                    weeklySummary[weekCode].ships += shipCount;
                    weekData[weekCode] = {
                        capacity: totalCapacity,
                        ships: shipCount
                    };
                });
                analysisData.push({
                    port: item.port,
                    routeLabel: item.routeLabel,
                    weeks: weekData
                });
            });

            if (!analysisData.length) {
                alert('没有可分析的航线数据');
                return null;
            }

            const destinationSummary = destinationFilters.ports.length
                ? destinationFilters.ports.join('、')
                : '全部港口';

            let prompt = `请分析以下船期数据，提供专业的趋势分析和预测：

【数据概览】
分析目的港路径：${destinationSummary}
分析航线数量：${analysisData.length}条

【当周+未来四周数据汇总】
`;

            analysisWeekCodes.forEach((weekCode, index) => {
                const weekLabel = analysisWeekLabels[index];
                const summary = weeklySummary[weekCode];
                prompt += `周别 ${weekLabel} (${weekCode}): 总运力 ${summary.capacity.toLocaleString()} TEU, 总派船数 ${summary.ships}艘\n`;
            });

            prompt += `\n【详细数据】
`;

            analysisData.forEach(item => {
                prompt += `\n港口：${item.port || '未分配'}，航线：${item.routeLabel || '未知航线'}\n`;
                analysisWeekCodes.forEach((weekCode, index) => {
                    const weekLabel = analysisWeekLabels[index];
                    const weekData = item.weeks[weekCode] || {};
                    prompt += `  周别 ${weekLabel}: 运力 ${weekData.capacity.toLocaleString()} TEU, 派船 ${weekData.ships}艘\n`;
                });
            });

            const bookingData = getBookingData();
            if (bookingData.length > 0) {
                prompt += `\n【其他影响因素（用户补充）】
`;
                bookingData.forEach((item, index) => {
                    const title = item.remark || `数据项 ${index + 1}`;
                    const description = item.description || '（用户未填写）';
                    prompt += `\n- ${title}：${description}\n`;
                });
            }


            if (marketReports && marketReports.length > 0) {
                prompt += `\n【市场周报 / 指数节选】
（以下内容来自用户上传PDF，请优先参考）
`;
                marketReports.forEach((report, index) => {
                    const snippet = report.text.length > 1200 ? report.text.slice(0, 1200) + '…' : report.text;
                    prompt += `\n报告 ${index + 1}（${report.name}）：
${snippet}
`;
                });
            }

            if (bunkerData && (bunkerData.vlsfo || bunkerData.mgo || bunkerData.ifo380)) {
                prompt += `\n【燃油行情（Ship & Bunker · 新加坡）】
`;
                if (bunkerData.vlsfo) {
                    const delta = typeof bunkerData.vlsfo.delta === 'number' ? (bunkerData.vlsfo.delta >= 0 ? `+${bunkerData.vlsfo.delta.toFixed(2)}` : bunkerData.vlsfo.delta.toFixed(2)) : 'N/A';
                    prompt += `- VLSFO 0.5%：${bunkerData.vlsfo.price?.toFixed(2) ?? 'N/A'} USD/t${delta !== 'N/A' ? `（WoW ${delta}）` : ''}\n`;
                }
                if (bunkerData.mgo) {
                    const delta = typeof bunkerData.mgo.delta === 'number' ? (bunkerData.mgo.delta >= 0 ? `+${bunkerData.mgo.delta.toFixed(2)}` : bunkerData.mgo.delta.toFixed(2)) : 'N/A';
                    prompt += `- MGO 0.1%：${bunkerData.mgo.price?.toFixed(2) ?? 'N/A'} USD/t${delta !== 'N/A' ? `（WoW ${delta}）` : ''}\n`;
                }
                if (bunkerData.ifo380) {
                    const delta = typeof bunkerData.ifo380.delta === 'number' ? (bunkerData.ifo380.delta >= 0 ? `+${bunkerData.ifo380.delta.toFixed(2)}` : bunkerData.ifo380.delta.toFixed(2)) : 'N/A';
                    prompt += `- IFO380：${bunkerData.ifo380.price?.toFixed(2) ?? 'N/A'} USD/t${delta !== 'N/A' ? `（WoW ${delta}）` : ''}\n`;
                }
                prompt += `（抓取时间：${new Date(bunkerData.timestamp).toLocaleString()}）\n`;
            }
            if (ccfiData && ccfiData.routes?.length) {
                prompt += `\n【中国出口集装箱运价指数（CCFI）】
`;
                if (ccfiData.period) {
                    prompt += `- 本期 ${ccfiData.period.current || '—'}，对比上期 ${ccfiData.period.previous || '—'}\n`;
                }
                ccfiData.routes.forEach(route => {
                    const currentText = typeof route.current === 'number' ? route.current.toLocaleString() : '—';
                    const previousText = typeof route.previous === 'number' ? route.previous.toLocaleString() : '—';
                    prompt += `- ${route.label}：${currentText}（上期 ${previousText}，WoW ${formatPercent(route.wow)}）\n`;
                });
            }
            if (wciData && (typeof wciData.worldIndex === 'number' || (wciData.routes?.length))) {
                prompt += `\n【Drewry WCI 现货趋势】
`;
                if (typeof wciData.worldIndex === 'number') {
                    const changeValue = typeof wciData.worldIndexWoW === 'number'
                        ? `（WoW ${formatPercent(wciData.worldIndexWoW)}）`
                        : (typeof wciData.changePct === 'number' ? `（${wciData.changePct >= 0 ? '+' : ''}${wciData.changePct}% WoW）` : '');
                    prompt += `- 全球指数：${wciData.worldIndex.toLocaleString()} USD/FEU${changeValue}\n`;
                }
                if (wciData.routes?.length) {
                    wciData.routes.slice(0, 6).forEach(route => {
                        const codeLabel = route.code ? `${route.code} ` : '';
                        const wowText = typeof route.wow === 'number' ? `（WoW ${formatPercent(route.wow)}）` : '';
                        prompt += `- ${codeLabel}${route.route}：${route.rate.toLocaleString()} USD/FEU${wowText}\n`;
                    });
                }
            }
            if (fbxData && fbxData.indices?.length) {
                prompt += `\n【Freightos FBX 航线指数】
`;
                fbxData.indices.forEach(item => {
                    const wowText = typeof item.wow === 'number' ? `（WoW ${formatPercent(item.wow)}）` : '';
                    prompt += `- ${item.label}：${item.rate.toLocaleString()} USD/FEU${wowText}\n`;
                });
            }

            prompt += aiInstructionTemplate;
            return prompt;
        }


        function getBookingData() {
            const tbody = document.getElementById('bookingDataBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const data = [];
            
            rows.forEach(row => {
                const remarkInput = row.querySelector('.booking-remark');
                const descInput = row.querySelector('.booking-desc');
                const remark = remarkInput ? remarkInput.value.trim() : '';
                const description = descInput ? descInput.value.trim() : '';
                
                if (remark || description) {
                    data.push({
                        remark,
                        description
                    });
                }
            });
            
            return data;
        }

        let exportLibsReady = false;

        async function ensureExportLibs() {
            if (exportLibsReady) return;
            const html2CanvasSources = [
                'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js',
                'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'
            ];
            const jsPdfSources = [
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
                'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'
            ];

            let loaded = false;
            for (const src of html2CanvasSources) {
                try {
                    await loadScript(src);
                    loaded = true;
                    break;
                } catch (error) {
                    console.warn('html2canvas 加载失败', src, error);
                }
            }
            if (!loaded || typeof window.html2canvas === 'undefined') {
                throw new Error('无法加载 html2canvas 库');
            }

            loaded = false;
            for (const src of jsPdfSources) {
                try {
                    await loadScript(src);
                    loaded = true;
                    break;
                } catch (error) {
                    console.warn('jsPDF 加载失败', src, error);
                }
            }
            if (!loaded || typeof window.jspdf === 'undefined') {
                throw new Error('无法加载 jsPDF 库');
            }

            exportLibsReady = true;
        }

        async function exportPageToPdf() {
            const exportBtn = document.getElementById('exportPdfBtn');
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.textContent = '正在导出...';
            }
            try {
                await ensureExportLibs();
                const target = document.querySelector('.container');
                if (!target) {
                    throw new Error('未找到需要导出的内容区域');
                }
                const originalHtmlBg = document.documentElement.style.background;
                const originalBodyBg = document.body.style.background;
                const originalBodyBgImage = document.body.style.backgroundImage;
                const originalHtmlBgImage = document.documentElement.style.backgroundImage;
                const originalTargetBg = target.style.background;
                const originalTargetBgImage = target.style.backgroundImage;
                const originalTargetWidth = target.style.width;
                const originalTargetPadding = target.style.padding;
                const originalTargetMargin = target.style.margin;
                document.body.classList.add('pdf-export');
                document.documentElement.style.background = '#ffffff';
                document.body.style.background = '#ffffff';
                document.body.style.backgroundImage = 'none';
                document.documentElement.style.backgroundImage = 'none';
                target.style.background = '#ffffff';
                target.style.backgroundImage = 'none';
                target.style.width = '100%';
                target.style.padding = '0 24px';
                target.style.margin = '0 auto';
                const captureScale = Math.min(1.2, window.devicePixelRatio || 1.2);
                const canvas = await html2canvas(target, {
                    scale: captureScale,
                    useCORS: true,
                    scrollY: -window.scrollY,
                    windowWidth: document.documentElement.scrollWidth,
                    windowHeight: document.documentElement.scrollHeight,
                    backgroundColor: '#ffffff'
                });
                document.body.classList.remove('pdf-export');
                document.documentElement.style.background = originalHtmlBg;
                document.body.style.background = originalBodyBg;
                document.body.style.backgroundImage = originalBodyBgImage;
                document.documentElement.style.backgroundImage = originalHtmlBgImage;
                target.style.background = originalTargetBg;
                target.style.backgroundImage = originalTargetBgImage;
                target.style.width = originalTargetWidth;
                target.style.padding = originalTargetPadding;
                target.style.margin = originalTargetMargin;
                const imgData = canvas.toDataURL('image/jpeg', 0.65);
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4', true);
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 8; // mm margins for better readability
                const imgWidth = pageWidth - margin * 2;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                let heightLeft = imgHeight;
                let position = margin;
                const pageContentHeight = pageHeight - margin * 2;

                pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pageContentHeight;

                while (heightLeft > -pageContentHeight) {
                    pdf.addPage();
                    position = margin - (imgHeight - heightLeft);
                    pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight, undefined, 'FAST');
                    heightLeft -= pageContentHeight;
                }

                pdf.save('市场分析报告.pdf');
            } catch (error) {
                console.error('导出 PDF 失败', error);
                alert(`导出 PDF 失败：${error.message || error}`);
            } finally {
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.textContent = '导出整页 PDF';
                }
            }
        }

        document.getElementById('exportPdfBtn')?.addEventListener('click', exportPageToPdf);
        window.addEventListener('load', () => {
            Promise.allSettled([
                fetchBunkerData(false),
                fetchCcfiData(false),
                fetchWciData(false),
                fetchFbxData(false)
            ]);
        });

        // 筛选功能在renderTable中已实现
    </script>
</body>
</html>
