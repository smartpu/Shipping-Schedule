<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analysis · 市场分析</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <!-- Toast 提示组件（中优先级优化：错误处理和反馈） -->
    <script src="vendor/toast.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/filter-utils.js"></script>
    <script src="vendor/excel-reader-utils.js"></script>
    <script src="vendor/ai-config.js"></script>
    <script src="vendor/ai-prompts.js"></script>
    <script src="vendor/ai-utils.js"></script>
    <script src="vendor/market-data-fetchers.js"></script>
    <script src="vendor/pdf-processing-utils.js"></script>
    <script src="vendor/week-processing-utils.js"></script>
    <script src="vendor/data-normalization-utils.js"></script>
    <script src="vendor/market-analysis-utils.js"></script>
    <script src="vendor/template-utils.js"></script>
    <script src="vendor/port-sort-utils.js"></script>
    <script src="vendor/week-utils.js"></script>
    <script src="vendor/week-definition-parser.js"></script>
    <!-- PDF导出库 -->
    <script src="vendor/html2canvas.min.js"></script>
    <script src="vendor/jspdf.umd.min.js"></script>
</head>
<body data-page="001-04-market-analysis.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <!-- ARIA Live Region：用于动态内容更新提示（中优先级优化：ARIA 标签完善） -->
            <div id="aria-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
            <div class="container">
                <!-- 顶部介绍卡片，沿用 dashboard 风格 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>Market Analysis · 市场分析</h2>
                            <p>一份 Excel 与周报即可联动航线供给与 AI 决策，轻松完成跨板块洞察</p>
                        </div>
                        <div class="section-intro-actions">
                            <button type="button" class="tool-link" id="exportPdfBtn" aria-label="导出PDF">导出PDF</button>
                            <a href="dashboard.html?tab=tools001" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="001-04-market-analysis-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 文件上传和数据状态区域 - 两行布局 -->
                <div style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 0;">
                    <!-- 第一行：载入 Excel 和 Excel 数据状态 -->
                    <div class="grid-2-col" style="margin-bottom: 0;">
                        <!-- 左侧：载入 Excel -->
                        <div class="card-white">
                            <label for="fileInput" class="file-upload-label" aria-label="选择Excel文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradExcel)" />
                                    <!-- Excel表格图标 -->
                                    <rect x="8" y="8" width="20" height="20" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="14" x2="28" y2="14" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="20" x2="28" y2="20" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="14" y1="8" x2="14" y2="28" stroke="#fff" stroke-width="1.5"/>
                                    <!-- 向下箭头 -->
                                    <path d="M18 22L22 26L14 26Z" fill="#fff"/>
                                    <defs>
                                        <linearGradient id="gradExcel" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#0071e3" />
                                            <stop offset="1" stop-color="#54a4ff" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入 Excel</div>
                                    <div class="file-upload-desc">支持 .xlsx / .xls，数据仅在本地浏览器解析</div>
                                </div>
                                <input type="file" id="fileInput" class="file-upload-input" accept=".xlsx,.xls" aria-label="选择Excel文件" title="选择Excel文件：文件需包含 schedule 工作表">
                        </label>
                        </div>
                        
                        <!-- 右侧：Excel 数据状态 -->
                        <div class="card-white">
                            <div class="data-status-container">
                                <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradStatus)" />
                                    <!-- 数据状态图标：剪贴板 + 勾 -->
                                    <rect x="11" y="10" width="14" height="16" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <rect x="15" y="8" width="6" height="4" rx="1" fill="#fff"/>
                                    <path d="M14 18L17 21L23 15" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <defs>
                                        <linearGradient id="gradStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#FF8A00" />
                                            <stop offset="1" stop-color="#FFB347" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="data-status-content">
                                    <div class="data-status-title">数据状态</div>
                                    <div id="excelStatus" class="data-status-text" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">尚未载入数据</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二行：载入报告 和 报告状态 -->
                    <div class="grid-2-col" style="margin-bottom: 0;">
                        <!-- 左侧：载入市场周报 -->
                        <div class="card-white">
                            <label for="marketReportInput" class="file-upload-label" aria-label="选择市场周报PDF文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradPdf)" />
                                    <!-- PDF图标 -->
                                    <rect x="10" y="9" width="16" height="18" rx="1" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M10 9L10 15L16 15" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="13" y1="20" x2="23" y2="20" stroke="#fff" stroke-width="1.2"/>
                                    <line x1="13" y1="23" x2="23" y2="23" stroke="#fff" stroke-width="1.2"/>
                                    <defs>
                                        <linearGradient id="gradPdf" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#dc3545" />
                                            <stop offset="1" stop-color="#ff6b7a" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入市场周报</div>
                                    <div class="file-upload-desc">支持多份 PDF（Alphaliner、Linerlytica 等）</div>
                                </div>
                                <input type="file" id="marketReportInput" class="file-upload-input" accept=".pdf" multiple aria-label="选择市场周报PDF文件" title="载入市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析">
                        </label>
                    </div>
                        
                        <!-- 右侧：报告状态 -->
                        <div class="card-white">
                            <div class="data-status-container">
                                <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradReportStatus)" />
                                    <!-- 报告状态图标：文档 + 勾 -->
                                    <rect x="10" y="9" width="16" height="18" rx="1" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M10 9L10 15L16 15" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M14 20L17 23L23 17" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <defs>
                                        <linearGradient id="gradReportStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#28a745" />
                                            <stop offset="1" stop-color="#5cb85c" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="data-status-content">
                                    <div class="data-status-title">报告状态</div>
                                    <div id="reportStatus" class="data-status-text" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">尚未载入报告</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <section id="capacityModule" class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">MODULE 01</span>
                        <div>
                            <h2 class="section-title">航线运力分析 <span>SAILING SCHEDULE PULSE</span></h2>
                            <p class="module-desc">港口筛选联动运力、派船与趋势，精准锁定当周+未来三周供给</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" data-module="capacity">
                    <div class="controls">
                        <div class="view-toggle hidden" id="viewToggle">
                            <label>显示模式：</label>
                            <button id="btnAll" class="active">全部</button>
                            <button id="btnCapacity">运力</button>
                            <button id="btnShips">派船</button>
                        </div>
                    </div>
                    <div id="destinationFilters" class="destination-filters hidden">
                        <div class="filter-row">
                            <!-- 起运港选择区域 -->
                            <div class="filter-group">
                                <label for="originPortSelect">起运港</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="originPortSearch" class="filter-search" placeholder="搜索起运港..." autocomplete="off">
                                <select id="originPortSelect" multiple size="6" class="multi-select">
                                    <option value="">全部起运港</option>
                                </select>
                                <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="originPortSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="originPortClearAll">清除选择</button>
                                </div>
                            </div>
                            <!-- 目的港选择区域 -->
                            <div class="filter-group">
                                <label for="destPortSelect">目的港</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="destPortSearch" class="filter-search" placeholder="搜索目的港..." autocomplete="off">
                                <select id="destPortSelect" multiple size="6" class="multi-select">
                                    <option value="">全部目的港</option>
                                </select>
                                <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="destPortSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="destPortClearAll">清除选择</button>
                                </div>
                            </div>
                            <!-- 共舱船公司选择区域 -->
                            <div class="filter-group">
                                <label for="routeSelect">共舱船公司</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="routeSearch" class="filter-search" placeholder="搜索共舱船公司..." autocomplete="off">
                                <select id="routeSelect" multiple size="6" class="multi-select">
                                    <option value="">全部共舱船公司</option>
                                </select>
                                <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="routeSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="routeClearAll">清除选择</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="infoBox" class="info-box hidden">
                        <p id="infoText"></p>
                    </div>
                    <div id="tableContainer" class="table-container hidden" role="region" aria-label="数据表格" aria-live="polite">
                        <table id="pivotTable" role="table" aria-label="市场分析数据表">
                            <thead id="tableHead" role="rowgroup"></thead>
                            <tbody id="tableBody" role="rowgroup"></tbody>
                        </table>
                    </div>
                    <div id="chartContainer" class="chart-container hidden">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                            <h3 style="color:var(--color-text-primary); font-size:20px; letter-spacing:0.5px;">运力与派船趋势图</h3>
                            <span style="color:var(--color-text-secondary); font-size:13px;">高度 ×1.5 展示，便于对比多航线</span>
                        </div>
                        <div id="emptyChartMessage" class="empty-chart-message hidden">
                            请选择港口以查看图表
                        </div>
                        <div class="chart-wrapper hidden" id="chartWrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
                </section>

                <section id="aiModule" class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">MODULE 02</span>
                        <div>
                            <h2 class="section-title">AI 趋势分析 <span>AI TREND ANALYSIS</span></h2>
                            <p class="module-desc">DeepSeek × KIMI × 通义千问 三模型交叉验证航线策略、供需与价格建议</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" data-module="ai">
                    <div id="aiAnalysisContainer" class="ai-analysis-container">
                        <div class="ai-header">
                            <h3>AI 船期趋势分析</h3>
                            <p>同一份筛选数据可由多模型并行分析，快速对比观点并交叉验证结论</p>
                        </div>
                        <div id="emptyAiMessage" class="empty-chart-message" style="display: none;">
                            请先加载数据文件并选择筛选条件以启用 AI 分析
                        </div>
                        <div id="aiConfigSection" style="display: none;">
                            <!-- 其他影响因素表格 - 使用公共模板（vendor/template-utils.js） -->
                            <div id="bookingDataTableContainer"></div>
                            <!-- 市场数据信息块 - 使用公共模板（vendor/template-utils.js） -->
                            <div id="marketDataInfoBlocksContainer"></div>
                            <!-- AI 配置面板 - 使用公共模板（vendor/template-utils.js） -->
                            <div id="aiConfigPanelsContainer"></div>
                        </div>
                    </div>
                </section>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">Market Analysis · 市场分析使用声明</h2>
                    <p class="usage-statement-text">资料整合自用户 Excel、用户载入市场周报、Ship & Bunker、上海航运交易所、Drewry、Freightos 等公开渠道，仅供内部研判，不构成对外报价或投资建议。</p>
                    <p class="usage-statement-text">AI 服务由 DeepSeek / KIMI / 通义千问 API 驱动，所有调用费用与合规责任由使用者自担，涉及客户或敏感数据时请先完成脱敏处理。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/sidebar-loader.js"></script>
    <!-- 手势支持组件（低优先级优化：提升移动端操作效率） -->
    <script src="vendor/gesture-handler.js"></script>
    <script>
        init001ToolPage('001-04-market-analysis.html', 'tools001');
    </script>
    <script>

        // ==================== 全局数据变量 =====================
        let scheduleData = [];
        let marketReports = [];
        let bunkerData = null;
        let wciData = null;
        let fbxData = null;
        const excelLoadState = { schedule: false };
        let modulesVisible = false;

        // PDF.js 加载状态变量（ensurePdfJsLoaded 函数需要）
        let pdfJsReady = false;
        let pdfJsLoadingPromise = null;
        const loadedScripts = new Set();
        const loadedWorkers = new Map();

        // 如果 PDF.js 已经加载，初始化状态
        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'vendor/pdf.worker.min.js';
            } catch (e) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            pdfJsReady = true;
        }

        const fileInput = document.getElementById('fileInput');
        const marketReportInput = document.getElementById('marketReportInput');
        const excelStatusEl = document.getElementById('excelStatus');
        const reportStatusEl = document.getElementById('reportStatus');
        let bunkerStatusEl = null;
        let bunkerUpdatedEl = null;
        let wciStatusEl = null;
        let wciUpdatedEl = null;
        let fbxStatusEl = null;
        let fbxUpdatedEl = null;

        async function loadExcelFile() {
            if (typeof window.portSortUtils !== 'undefined') {
                await window.portSortUtils.loadPortsList();
                await window.portSortUtils.loadPortsMapping();
            }
            
            await window.loadDefaultExcelFile('001-04-market-analysis', async (file) => {
                if (typeof XLSX === 'undefined') {
                    showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                    return;
                }

                try {
                    const data = await readExcelFile(file);
                scheduleData = data;
                await generatePivotTable(data);
                    const infoText = document.getElementById('infoText');
                    const infoBox = document.getElementById('infoBox');
                    if (infoText) infoText.textContent = `已加载 ${data.length} 条船期数据`;
                    if (infoBox) infoBox.classList.remove('hidden');
                    excelLoadState.schedule = true;
                    tryRevealModules();
                    updateDataStatus();
                } catch (error) {
                    showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                    debugError(error);
                    if (excelStatusEl) {
                        excelStatusEl.textContent = '文件加载失败，请检查文件格式';
                    }
                }
            });
        }
        
        async function loadMarketReports() {
            await window.loadDefaultMarketReports(async (file) => {
                try {
                    if (typeof window.handleMarketReportFile === 'function') {
                        await window.handleMarketReportFile(file);
                    } else {
                        debugError('handleMarketReportFile 函数未找到，请确保 pdf-processing-utils.js 已加载');
                        return;
                    }
                    // 检查是否提取到 SCFI 数据
                    const latestReport = marketReports[marketReports.length - 1];
                    if (latestReport) {
                        if (latestReport.scfiData) {
                            renderScfiTable(latestReport.scfiData, file.name);
                        } else {
                            // 尝试手动提取
                            try {
                                const fullText = latestReport.text;
                                if (fullText) {
                                    if (typeof window.parseScfiTable === 'function') {
                                        const extractedScfi = window.parseScfiTable(fullText);
                                        if (extractedScfi) {
                                            latestReport.scfiData = extractedScfi;
                                            renderScfiTable(extractedScfi, file.name);
                                        }
                                    } else {
                                        debugWarn('parseScfiTable 函数未找到，请确保 pdf-processing-utils.js 已加载');
                                    }
                                }
                            } catch (e) {
                                // 忽略提取错误
                            }
                        }
                    }
                } catch (error) {
                    debugError('自动加载市场周报失败:', error);
                    // 静默处理自动加载错误，不显示给用户（因为可能是文件不存在）
                }
            });
            
            updateDataStatus();
        }

        if (typeof window.portSortUtils !== 'undefined') {
            window.portSortUtils.loadPortsList().then(() => {
                window.portSortUtils.loadPortsMapping();
            });
        }
        
        if (typeof window.ensureXlsx === 'function') {
            window.ensureXlsx().then(async () => {
                // 确保港口排序工具已加载
                if (typeof window.portSortUtils !== 'undefined') {
                    await window.portSortUtils.loadPortsList();
                    await window.portSortUtils.loadPortsMapping();
                }
                await loadExcelFile();
                // 等待 PDF.js 加载完成后再加载市场周报
                if (typeof window.ensurePdfJsLoaded === 'function') {
                    await window.ensurePdfJsLoaded();
                }
                // 延迟一下，确保 PDF.js 完全初始化
                setTimeout(() => {
                    loadMarketReports();
                }, 500);
            });
        } else {
            // 如果 ensureXlsx 不存在，等待一段时间后尝试加载
            setTimeout(async () => {
                if (typeof XLSX !== 'undefined') {
                    // 确保港口排序工具已加载
                    if (typeof window.portSortUtils !== 'undefined') {
                        await window.portSortUtils.loadPortsList();
                        await window.portSortUtils.loadPortsMapping();
                    }
                    await loadExcelFile();
                    if (typeof window.ensurePdfJsLoaded === 'function') {
                        await window.ensurePdfJsLoaded();
                    }
                    setTimeout(() => {
                        loadMarketReports();
                    }, 500);
                }
            }, 1000);
        }
        function tryRevealModules() {
            if (modulesVisible) return;
            if (excelLoadState.schedule) {
                // 只显示筛选控件，模块标题始终显示
                const destinationFiltersPanel = document.getElementById('destinationFilters');
                if (destinationFiltersPanel) destinationFiltersPanel.classList.remove('hidden');
                
                const viewToggle = document.getElementById('viewToggle');
                if (viewToggle) viewToggle.classList.remove('hidden');

                document.querySelectorAll('.module-card').forEach(card => {
                    card.classList.remove('hidden');
                });
                
                modulesVisible = true;
            }
        }


        window.onScfiDataExtracted = (data, fileName) => {
            renderScfiTable(data, fileName);
        };

        if (marketReportInput) {
            marketReportInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                
                // 确保 PDF.js 已加载（手动选择文件时）
                try {
                    if (typeof window.ensurePdfJsLoaded === 'function') {
                        await window.ensurePdfJsLoaded();
                    }
                } catch (pdfJsError) {
                    debugError('PDF.js 加载失败:', pdfJsError);
                    showError(ErrorType.FILE_LOAD, 'PDF_LIBS_NOT_LOADED', {}, pdfJsError);
                    marketReportInput.value = '';
                    return;
                }
                
                for (const file of files) {
                    try {
                        if (typeof window.handleMarketReportFile === 'function') {
                            await window.handleMarketReportFile(file);
                        } else {
                            debugError('handleMarketReportFile 函数未找到，请确保 pdf-processing-utils.js 已加载');
                            showError(ErrorType.SYSTEM_ERROR, 'FUNCTION_NOT_FOUND', { 
                                message: 'PDF 处理函数未加载，请刷新页面重试' 
                            });
                            continue;
                        }
                        // 检查是否提取到 SCFI 数据
                        const latestReport = marketReports[marketReports.length - 1];
                        if (latestReport) {
                            debugLog('市场报告解析完成:', {
                                name: latestReport.name,
                                hasScfiData: !!latestReport.scfiData,
                                scfiData: latestReport.scfiData
                            });
                            if (latestReport.scfiData) {
                                renderScfiTable(latestReport.scfiData, file.name);
                            } else {
                                debugWarn('未找到 SCFI 数据，尝试手动提取...');
                                // 如果自动提取失败，尝试手动从全文提取
                                try {
                                    const fullText = latestReport.text;
                                    if (fullText) {
                                        if (typeof window.parseScfiTable === 'function') {
                                            const extractedScfi = window.parseScfiTable(fullText);
                                            if (extractedScfi) {
                                                debugLog('手动提取 SCFI 数据成功:', extractedScfi);
                                                latestReport.scfiData = extractedScfi;
                                                renderScfiTable(extractedScfi, file.name);
                                            } else {
                                                debugWarn('手动提取也失败，文本内容:', fullText.substring(0, 500));
                                            }
                                        } else {
                                            debugWarn('parseScfiTable 函数未找到，请确保 pdf-processing-utils.js 已加载');
                                        }
                                    }
                                } catch (extractError) {
                                    debugError('手动提取 SCFI 失败:', extractError);
                                }
                            }
                        }
                    } catch (error) {
                        debugError('解析PDF失败:', {
                            fileName: file.name,
                            fileSize: file.size,
                            fileType: file.type,
                            error: error
                        });
                        // 使用更详细的错误信息
                        const errorMessage = error.message || String(error);
                        showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', { 
                            message: `文件 "${file.name}" 解析失败：${errorMessage}\n\n可能的原因：\n1. 文件不是有效的 PDF 格式\n2. 文件已损坏\n3. 文件已加密\n4. PDF.js 库未正确加载\n\n请检查文件并重试。` 
                        }, error);
                    }
                }
                marketReportInput.value = '';
                
                // 更新数据状态显示
                updateDataStatus();
            });
        }
        
        /**
         * 更新数据状态显示
         */
        function updateDataStatus() {
            const excelRecordCount = scheduleData ? scheduleData.length : 0;
            if (excelStatusEl) {
                if (excelRecordCount > 0) {
                    excelStatusEl.innerHTML = `<span>已载入 1 份表格</span><span style="color: #6c757d;">共 ${excelRecordCount.toLocaleString()} 条记录</span>`;
                } else {
                    excelStatusEl.textContent = '尚未载入数据';
                }
            }
            
            const marketReportCount = marketReports ? marketReports.length : 0;
            if (reportStatusEl) {
                if (marketReportCount > 0) {
                    const totalChars = marketReports.reduce((sum, report) => sum + (report.textLength || 0), 0);
                    reportStatusEl.innerHTML = `<span>已载入 ${marketReportCount} 份报告</span><span style="color: #6c757d;">总字数: ${totalChars.toLocaleString()}</span>`;
                } else {
                    reportStatusEl.textContent = '尚未载入报告';
                }
            }
        }

        /**
         * 渲染 SCFI 表格
         * @param {Object} data - SCFI 数据
         * @param {string} source - 数据来源文件名
         */
        function renderScfiTable(data, source) {
            const container = document.getElementById('scfiTableContainer');
            const sourceEl = document.getElementById('scfiSource');
            const infoContainer = document.getElementById('scfiInfoContainer');
            
            if (!container || !infoContainer) {
                debugWarn('SCFI 表格容器未找到');
                return;
            }
            
            debugLog('渲染 SCFI 表格，数据:', data);
            
            if (!data || (!data.index && (!data.routes || data.routes.length === 0))) {
                debugWarn('SCFI 数据为空，隐藏表格');
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            let html = '<table class="scfi-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; table-layout: fixed;">';
            
            // 表头
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; text-align: left; border: 1px solid #ddd; width: 15%;">航线</th>';
            html += '<th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 5%;">单位</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">当期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年对比%</th>';
            html += '</tr>';
            
            if (data.index) {
                const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                const formatPercent = (val) => {
                    if (val === null || val === undefined) return '—';
                    const sign = val >= 0 ? '+' : '';
                    return sign + val.toFixed(1) + '%';
                };
                
                html += '<tr style="background: #f9f9f9; font-weight: bold;">';
                html += '<td style="padding: 8px; border: 1px solid #ddd;">SCFI 综合指数</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">—</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.index) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexWeek1) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexWeek1Change) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexMonth1) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexMonth1Change) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexQuarter3) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexQuarter3Change) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexYear1) + '</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexYear1Change) + '</td>';
                html += '</tr>';
            }
            
            if (data.routes && data.routes.length > 0) {
                data.routes.forEach(route => {
                    const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                    const formatPercent = (val) => {
                        if (val === null || val === undefined) return '—';
                        const sign = val >= 0 ? '+' : '';
                        return sign + val.toFixed(1) + '%';
                    };
                    
                    // 检查是否是India/East Africa/Central America，这些航线没有上年数据
                    const routeNameLower = (route.name || '').toLowerCase();
                    const hasNoYearData = routeNameLower.includes('india') || 
                                         routeNameLower.includes('nhava sheva') ||
                                         routeNameLower.includes('east africa') ||
                                         routeNameLower.includes('mombasa') ||
                                         routeNameLower.includes('central america') ||
                                         routeNameLower.includes('manzanillo');
                    
                    html += '<tr>';
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd;">${route.name}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">${route.unit || '—'}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.current)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.week1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.week1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.month1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.month1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.quarter3Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.quarter3Change)}</td>`;
                    if (hasNoYearData) {
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                    } else {
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.year1Price)}</td>`;
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.year1Change)}</td>`;
                    }
                    html += '</tr>';
                });
            }
            
            html += '</table>';
            container.innerHTML = html;
            
            if (sourceEl) {
                sourceEl.textContent = `数据来源：${source}`;
            }
        }

    </script>

    <script>
        // 缓存键定义（需要在所有使用之前定义）
        const CACHE_KEYS = {
            wci: 'wciDataCache',
            fbx: 'fbxDataCache'
        };
        
        let processedRecords = [];
        let groupedTableData = [];
        let latestFilteredRecords = [];
        let weekDefinitionMap = {};
        let destinationFilters = {
            originPorts: [],
            destPorts: [],
            routes: []
        };
        let currentView = 'all';
        let weekColumns = [];
        let capacityChart = null;
        let routeSearchValue = '';

        // ==================== 工具函数 =====================
        /**
         * DOM 元素缓存管理器
         */
        const DOMCache = {
            elements: new Map(),
            get(id) {
                if (!this.elements.has(id)) {
                    const element = document.getElementById(id);
                    if (element) {
                        this.elements.set(id, element);
                    }
                }
                return this.elements.get(id);
            },
            clear() {
                this.elements.clear();
            }
        };

        /**
         * 事件监听器管理器（防止内存泄漏）
         */
        const EventManager = {
            listeners: new Map(),
            add(element, event, handler, options = false) {
                if (!element) return;
                const key = `${element.id || 'unknown'}-${event}`;
                element.addEventListener(event, handler, options);
                if (!this.listeners.has(key)) {
                    this.listeners.set(key, []);
                }
                this.listeners.get(key).push({ element, event, handler, options });
            },
            remove(element, event, handler) {
                if (!element) return;
                const key = `${element.id || 'unknown'}-${event}`;
                element.removeEventListener(event, handler);
                const handlers = this.listeners.get(key);
                if (handlers) {
                    const index = handlers.findIndex(h => h.handler === handler);
                    if (index >= 0) {
                        handlers.splice(index, 1);
                    }
                }
            },
            removeAll() {
                this.listeners.forEach((handlers, key) => {
                    handlers.forEach(({ element, event, handler }) => {
                        element.removeEventListener(event, handler);
                    });
                });
                this.listeners.clear();
            }
        };

        /**
         * HTML 转义函数（防止 XSS）
         * @param {string} text - 要转义的文本
         * @returns {string} - 转义后的文本
         */
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        const infoBox = document.getElementById('infoBox');
        const infoText = document.getElementById('infoText');
        const tableContainer = document.getElementById('tableContainer');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        
        if (infoText) DOMCache.elements.set('infoText', infoText);
        if (tableContainer) DOMCache.elements.set('tableContainer', tableContainer);
        if (tableHead) DOMCache.elements.set('tableHead', tableHead);
        if (tableBody) DOMCache.elements.set('tableBody', tableBody);
        const viewToggle = document.getElementById('viewToggle');
        const btnAll = document.getElementById('btnAll');
        const btnCapacity = document.getElementById('btnCapacity');
        const btnShips = document.getElementById('btnShips');
        const destinationFiltersPanel = document.getElementById('destinationFilters');
        const originPortSelect = document.getElementById('originPortSelect');
        const originPortSelectAllBtn = document.getElementById('originPortSelectAll');
        const originPortClearAllBtn = document.getElementById('originPortClearAll');
        const originPortSearch = document.getElementById('originPortSearch');
        const destPortSelect = document.getElementById('destPortSelect');
        const destPortSelectAllBtn = document.getElementById('destPortSelectAll');
        const destPortClearAllBtn = document.getElementById('destPortClearAll');
        const destPortSearch = document.getElementById('destPortSearch');
        const routeSelect = document.getElementById('routeSelect');
        const routeSelectAllBtn = document.getElementById('routeSelectAll');
        const routeClearAllBtn = document.getElementById('routeClearAll');
        const routeSearch = document.getElementById('routeSearch');
        /**
         * 获取多选下拉框的选中值
         */
        function getSelectedValues(selectElement) {
            if (!selectElement) return [];
            return Array.from(selectElement.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');
        }

        /**
         * 设置多选下拉框
         */
        function setupMultiSelect(selectElement) {
            if (!selectElement) return;
            selectElement.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const option = e.target;
                if (option.tagName === 'OPTION') {
                    option.selected = !option.selected;
                    selectElement.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }

        function populateSelect(selectElement, options, defaultLabel, selectedValues, disabled, usePortOrder) {
            if (!selectElement) return;
            
            const currentSelected = getSelectedValues(selectElement);
            selectElement.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultLabel;
            selectElement.appendChild(defaultOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                if (selectedValues && selectedValues.includes(option)) {
                    optionElement.selected = true;
                }
                selectElement.appendChild(optionElement);
            });
            
            selectElement.disabled = !!disabled;
        }

        /**
         * 全选选项
         */
        function selectAllOptions(selectElement) {
            if (!selectElement) return;
            Array.from(selectElement.options).forEach(option => {
                option.selected = true;
            });
            selectElement.dispatchEvent(new Event('change', { bubbles: true }));
        }

        /**
         * 清除所有选择
         */
        function clearSelectOptions(selectElement) {
            if (!selectElement) return;
            Array.from(selectElement.options).forEach(option => {
                option.selected = false;
            });
            selectElement.dispatchEvent(new Event('change', { bubbles: true }));
        }

        let availableOriginPorts = [];
        let availableDestPorts = [];
        let availableRoutes = [];

        async function updateFilterOptions(records) {
            // 显示加载状态（移动端，排除iPad横屏宽屏模式）
            const isLandscape = window.innerWidth > window.innerHeight;
            const isMobileFilter = window.innerWidth <= 1024 && !(window.innerWidth >= 1024 && isLandscape);
            if (isMobileFilter && typeof window.updateFilterDisplay === 'function') {
                const originPortSelect = document.getElementById('originPortSelect');
                const destPortSelect = document.getElementById('destPortSelect');
                const routeSelect = document.getElementById('routeSelect');
                if (originPortSelect) window.updateFilterDisplay(originPortSelect, true);
                if (destPortSelect) window.updateFilterDisplay(destPortSelect, true);
                if (routeSelect) window.updateFilterDisplay(routeSelect, true);
            }
            
            // 保留完整的港口列表，允许用户多选多个港口来覆盖所有航线
            // 从所有原始记录中提取完整的港口列表（不进行过滤）
            const originPortSet = new Set();
            const destPortSet = new Set();
            
            records.forEach(record => {
                if (record.originPort && record.originPort.trim()) {
                    originPortSet.add(record.originPort.trim());
                }
                if (record.destPort && record.destPort.trim()) {
                    destPortSet.add(record.destPort.trim());
                }
            });
            
            // 对于共舱船公司，可以根据已选择的港口进行过滤（可选）
            let filteredRecords = records;
            if (destinationFilters.originPorts.length > 0 || destinationFilters.destPorts.length > 0) {
                filteredRecords = filteredRecords.filter(record => {
                    if (destinationFilters.originPorts.length > 0 && !destinationFilters.originPorts.includes(record.originPort)) {
                        return false;
                    }
                    if (destinationFilters.destPorts.length > 0 && !destinationFilters.destPorts.includes(record.destPort)) {
                        return false;
                    }
                    return true;
                });
            }
            
            // 从过滤后的记录中提取共舱船公司选项
            const routeSet = new Set();
            filteredRecords.forEach(record => {
                if (record.route && record.route.trim()) {
                    routeSet.add(record.route.trim());
                }
            });
            
            // 使用统一的排序函数（按区域顺序和代码顺序排序）
            if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                try {
                    // 确保港口映射已加载
                    if (!window.portSortUtils.portsMappingLoaded) {
                        await window.portSortUtils.loadPortsMapping();
                    }
                    // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                    const sortedOriginPorts = window.portSortUtils.sortPortsByDataAndRegion(Array.from(originPortSet));
                    const sortedDestPorts = window.portSortUtils.sortPortsByDataAndRegion(Array.from(destPortSet));
                    
                    // 确保每个港口都有完整的 [英文名|代码|区域] 格式
                    availableOriginPorts = sortedOriginPorts;
                    
                    availableDestPorts = sortedDestPorts;
                } catch (error) {
                    debugWarn('portSortUtils.sortPortNames 失败，使用降级方案:', error);
                    // 降级方案：简单排序
                    availableOriginPorts = Array.from(originPortSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                    availableDestPorts = Array.from(destPortSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                }
            } else {
                // 降级方案：简单排序
                availableOriginPorts = Array.from(originPortSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                availableDestPorts = Array.from(destPortSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            }
            availableRoutes = Array.from(routeSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            
            const originPortSelect = document.getElementById('originPortSelect');
            const originPortSearch = document.getElementById('originPortSearch');
            if (originPortSelect) {
                const filteredOriginPorts = originPortSearch && originPortSearch.value.trim()
                    ? availableOriginPorts.filter(port => 
                        port.toLowerCase().includes(originPortSearch.value.toLowerCase())
                    )
                    : availableOriginPorts;
                
                // 保留已选择的选项（即使它们不在当前可用选项中）
                const selectedOriginPorts = destinationFilters.originPorts.filter(port => 
                    filteredOriginPorts.includes(port)
                );
                destinationFilters.originPorts = selectedOriginPorts;
                
                populateSelect(
                    originPortSelect,
                    filteredOriginPorts,
                    '全部起运港',
                    destinationFilters.originPorts,
                    filteredOriginPorts.length === 0,
                    false
                );
            }
            
            const destPortSelect = document.getElementById('destPortSelect');
            const destPortSearch = document.getElementById('destPortSearch');
            if (destPortSelect) {
                const filteredDestPorts = destPortSearch && destPortSearch.value.trim()
                    ? availableDestPorts.filter(port => 
                        port.toLowerCase().includes(destPortSearch.value.toLowerCase())
                    )
                    : availableDestPorts;
                
                // 保留已选择的选项（即使它们不在当前可用选项中）
                const selectedDestPorts = destinationFilters.destPorts.filter(port => 
                    filteredDestPorts.includes(port)
                );
                destinationFilters.destPorts = selectedDestPorts;
                
                populateSelect(
                    destPortSelect,
                    filteredDestPorts,
                    '全部目的港',
                    destinationFilters.destPorts,
                    filteredDestPorts.length === 0,
                    false
                );
            }
            
            const routeSelect = document.getElementById('routeSelect');
            if (routeSelect) {
                const filteredRoutes = routeSearchValue.trim()
                    ? availableRoutes.filter(route => 
                        route.toLowerCase().includes(routeSearchValue.toLowerCase())
                    )
                    : availableRoutes;
                
                // 保留已选择的选项（即使它们不在当前可用选项中）
                const selectedRoutes = destinationFilters.routes.filter(route => 
                    filteredRoutes.includes(route)
                );
                destinationFilters.routes = selectedRoutes;
                
                populateSelect(
                    routeSelect,
                    filteredRoutes,
                    '全部共舱船公司',
                    destinationFilters.routes,
                    filteredRoutes.length === 0,
                    false
                );
            }
            
            // 更新移动端筛选框显示（移除加载状态，排除iPad横屏宽屏模式）
            const isLandscape = window.innerWidth > window.innerHeight;
            const isMobileFilter = window.innerWidth <= 1024 && !(window.innerWidth >= 1024 && isLandscape);
            if (isMobileFilter && typeof window.updateFilterDisplay === 'function') {
                setTimeout(() => {
                    if (originPortSelect) window.updateFilterDisplay(originPortSelect, false);
                    if (destPortSelect) window.updateFilterDisplay(destPortSelect, false);
                    if (routeSelect) window.updateFilterDisplay(routeSelect, false);
                }, 50);
            }
        }


        function getFilteredRecords() {
            let originPortFilteredCount = 0;
            let destPortFilteredCount = 0;
            let routeFilteredCount = 0;
            
            const filtered = processedRecords.filter(record => {
                if (destinationFilters.originPorts.length) {
                    if (!destinationFilters.originPorts.includes(record.originPort)) {
                        originPortFilteredCount++;
                        return false;
                    }
                }
                
                if (destinationFilters.destPorts.length) {
                    if (!destinationFilters.destPorts.includes(record.destPort)) {
                        destPortFilteredCount++;
                        return false;
                    }
                }
                
                if (destinationFilters.routes.length) {
                    if (!destinationFilters.routes.includes(record.route)) {
                        routeFilteredCount++;
                        return false;
                    }
                }
                
                return true;
            });
            
            debugLog(`[001-04] 数据过滤统计: 原始=${processedRecords.length}, 过滤后=${filtered.length}, 起运港过滤=${originPortFilteredCount}, 目的港过滤=${destPortFilteredCount}, 共舱船公司过滤=${routeFilteredCount}`);
            
            const dedupMap = new Map();
            const deduplicated = [];
            
            filtered.forEach(record => {
                const dedupKey = `${record.routeId}|${record.portId}|${record.shipName}|${record.shipDate}`;
                
                if (!dedupMap.has(dedupKey)) {
                    dedupMap.set(dedupKey, true);
                    deduplicated.push(record);
                }
            });
            
            debugLog(`[001-04] 去重后记录数: ${deduplicated.length}`);
            return deduplicated;
        }


        function groupRecords(records) {
            const groups = new Map();

            records.forEach(record => {
                const routeRemark = record.routeRemark || '';
                const route = record.route || '未知航线';
                const key = `${routeRemark}|${route}`;

                if (!groups.has(key)) {
                    groups.set(key, {
                        routeRemark,
                        route,
                        weeks: {}
                    });
                }

                const group = groups.get(key);
                if (!group.weeks[record.weekCode]) {
                    group.weeks[record.weekCode] = [];
                }

                const entries = group.weeks[record.weekCode];
                const dedupKey = `${record.routeId}|${record.portId}|${record.shipName}|${record.shipDate}`;
                
                const exists = entries.some(item => item.dedupKey === dedupKey);
                if (exists) {
                    return;
                }
                
                entries.push({
                    capacity: record.capacity,
                    shipName: record.shipName,
                    shipDate: record.shipDate,
                    dedupKey: dedupKey
                });
            });

            const sorted = Array.from(groups.values()).sort((a, b) => {
                return (a.route || '').localeCompare(b.route || '');
            });

            return {
                data: sorted
            };
        }

        /**
         * 验证文件
         * @param {File} file - 文件对象
         * @param {string} type - 文件类型 ('excel' | 'pdf')
         * @returns {Object} - {valid: boolean, error?: string}
         */
        function validateFile(file, type) {
            if (!file) {
                return { valid: false, error: '未选择文件' };
            }

            // 验证文件大小
            const sizeLimit = type === 'excel' ? FILE_SIZE_LIMITS.EXCEL : FILE_SIZE_LIMITS.PDF;
            if (file.size > sizeLimit) {
                const sizeMB = (sizeLimit / (1024 * 1024)).toFixed(0);
                return { valid: false, error: `文件大小超过限制（最大 ${sizeMB}MB）` };
            }

            // 验证文件格式
            const validExtensions = type === 'excel' 
                ? ['.xlsx', '.xls'] 
                : ['.pdf'];
            const fileName = file.name.toLowerCase();
            const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension) {
                return { valid: false, error: `不支持的文件格式，请选择 ${validExtensions.join(' 或 ')} 文件` };
            }

            return { valid: true };
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // 验证文件
            const validation = validateFile(file, 'excel');
            if (!validation.valid) {
                showError(ErrorType.FILE_LOAD, 'FILE_VALIDATION_FAILED', { message: validation.error });
                fileInput.value = '';
                return;
            }

            // 检查 XLSX 是否已加载
            if (typeof XLSX === 'undefined') {
                showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                return;
            }

            try {
                const data = await readExcelFile(file);
                scheduleData = data;
                await generatePivotTable(data);
                infoText.textContent = `已加载 ${data.length} 条船期数据`;
                infoBox.classList.remove('hidden');
                excelLoadState.schedule = true;
                tryRevealModules();
                
                // 更新数据状态显示
                updateDataStatus();
            } catch (error) {
                showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                debugError(error);
                // 更新状态显示错误信息
                if (excelStatusEl) {
                    excelStatusEl.textContent = '文件加载失败，请检查文件格式';
                }
            }
        });

        btnAll.addEventListener('click', () => {
            currentView = 'all';
            btnAll.classList.add('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnCapacity.addEventListener('click', () => {
            currentView = 'capacity';
            btnAll.classList.remove('active');
            btnCapacity.classList.add('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnShips.addEventListener('click', () => {
            currentView = 'ships';
            btnAll.classList.remove('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.add('active');
            renderTable();
        });

        // 起运港选择相关事件（使用防抖优化性能）
        if (originPortSelect) {
            setupMultiSelect(originPortSelect);
            // 防抖函数
            let originPortChangeTimer = null;
            originPortSelect.addEventListener('change', async () => {
                if (originPortChangeTimer) clearTimeout(originPortChangeTimer);
                originPortChangeTimer = setTimeout(async () => {
                    destinationFilters.originPorts = getSelectedValues(originPortSelect);
                    // 级联更新：根据选择的起运港更新目的港和共舱船公司选项
                    await updateFilterOptions(processedRecords);
                    renderTable();
                }, 200);
            });
        }
        if (originPortSelectAllBtn && originPortClearAllBtn && originPortSelect) {
            originPortSelectAllBtn.addEventListener('click', () => selectAllOptions(originPortSelect));
            originPortClearAllBtn.addEventListener('click', () => clearSelectOptions(originPortSelect));
        }
        // 起运港搜索（使用防抖优化）
        if (originPortSearch) {
            if (typeof window.addDebouncedSearch === 'function') {
                window.addDebouncedSearch(originPortSearch, async () => {
                    await updateFilterOptions(processedRecords);
                }, 300);
            } else {
                originPortSearch.addEventListener('input', async () => {
                    await updateFilterOptions(processedRecords);
                });
            }
        }
        
        // 目的港选择相关事件（使用防抖优化性能）
        if (destPortSelect) {
            setupMultiSelect(destPortSelect);
            // 防抖函数
            let destPortChangeTimer = null;
            destPortSelect.addEventListener('change', async () => {
                if (destPortChangeTimer) clearTimeout(destPortChangeTimer);
                destPortChangeTimer = setTimeout(async () => {
                    destinationFilters.destPorts = getSelectedValues(destPortSelect);
                    // 级联更新：根据选择的目的港更新起运港和共舱船公司选项
                    await updateFilterOptions(processedRecords);
                    renderTable();
                }, 200);
            });
        }
        if (destPortSelectAllBtn && destPortClearAllBtn && destPortSelect) {
            destPortSelectAllBtn.addEventListener('click', () => selectAllOptions(destPortSelect));
            destPortClearAllBtn.addEventListener('click', () => clearSelectOptions(destPortSelect));
        }
        // 目的港搜索（使用防抖优化）
        if (destPortSearch) {
            if (typeof window.addDebouncedSearch === 'function') {
                window.addDebouncedSearch(destPortSearch, async () => {
                    await updateFilterOptions(processedRecords);
                }, 300);
            } else {
                destPortSearch.addEventListener('input', async () => {
                    await updateFilterOptions(processedRecords);
                });
            }
        }

        // 航线选择相关事件（使用防抖优化性能）
        if (routeSelect) {
            setupMultiSelect(routeSelect);
            // 防抖函数
            let routeChangeTimer = null;
            routeSelect.addEventListener('change', async () => {
                if (routeChangeTimer) clearTimeout(routeChangeTimer);
                routeChangeTimer = setTimeout(async () => {
                    destinationFilters.routes = getSelectedValues(routeSelect);
                    // 级联更新：根据选择的共舱船公司更新起运港和目的港选项
                    await updateFilterOptions(processedRecords);
                    renderTable();
                }, 200);
            });
        }
        if (routeSelectAllBtn && routeClearAllBtn && routeSelect) {
            routeSelectAllBtn.addEventListener('click', () => selectAllOptions(routeSelect));
            routeClearAllBtn.addEventListener('click', () => clearSelectOptions(routeSelect));
        }
        // 航线搜索（使用防抖优化）
        if (routeSearch) {
            if (typeof window.addDebouncedSearch === 'function') {
                window.addDebouncedSearch(routeSearch, async (e) => {
                    routeSearchValue = e.target.value;
                    await updateFilterOptions(processedRecords);
                }, 300);
            } else {
                routeSearch.addEventListener('input', async (e) => {
                    routeSearchValue = e.target.value;
                    await updateFilterOptions(processedRecords);
                });
            }
        }

        async function readExcelFile(file) {
            // 使用统一的 Excel 读取函数（支持 week 工作表解析）
            if (typeof window.readExcelFileWithWeek === 'function') {
                try {
                    const jsonData = await window.readExcelFileWithWeek(file, {
                        weekConfig: {
                            weekTextColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.WEEK_TEXT,
                            dateRangeColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.DATE_RANGE
                        },
                        onWeekParsed: (parsedWeekMap) => {
                            weekDefinitionMap = parsedWeekMap || {};
                        }
                    });
                    return jsonData;
                } catch (error) {
                    // 如果新函数失败，降级到原始实现
                    debugWarn('readExcelFileWithWeek 失败，使用降级方案:', error);
                }
            }
            
            // 降级方案：使用原始实现
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX 库未加载，请刷新页面重试'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: false, cellNF: false });
                        
                        const weekSheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase() === 'week' || name.toLowerCase().includes('week')
                        );
                        if (weekSheetName) {
                            const weekWorksheet = workbook.Sheets[weekSheetName];
                            const weekData = XLSX.utils.sheet_to_json(weekWorksheet, { header: 1, defval: null, raw: true });
                            if (typeof window.parseWeekDefinitions === 'function') {
                                weekDefinitionMap = window.parseWeekDefinitions(weekData, {
                                    weekTextColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.WEEK_TEXT,
                                    dateRangeColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.DATE_RANGE
                                });
                            } else {
                                debugError('parseWeekDefinitions 函数未加载，请检查 week-definition-parser.js 是否已加载');
                                weekDefinitionMap = {};
                            }
                        } else {
                            debugError('未找到week工作表！工作表列表:', workbook.SheetNames);
                            weekDefinitionMap = {};
                        }
                        
                        // 查找 schedule 工作表
                        const sheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('schedule')
                        ) || workbook.SheetNames[0];
                        
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            raw: true, 
                            defval: null
                        });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // ==================== 常量配置 ====================
        /**
         * 应用配置常量
         */
        const APP_CONFIG = {
            // 文件大小限制（字节）
            FILE_SIZE_LIMITS: {
                EXCEL: 50 * 1024 * 1024,
                PDF: 20 * 1024 * 1024
            },
            // 周别配置
            WEEK_COUNT: 4,
            WEEK_SHEET_COLUMNS: {
                WEEK_TEXT: 3,
                DATE_RANGE: 0
            }
        };
        
        const FILE_SIZE_LIMITS = APP_CONFIG.FILE_SIZE_LIMITS;

        /**
         * Excel 列配置常量
         * 统一管理列索引、列字母和别名，便于维护和修改
         */
        const COLUMN_CONFIG = {
            ORIGIN_PORT: {
                letter: 'A',
                index: 0,
                aliases: ['起运港', 'pol', 'origin', '起运']
            },
            DEST_PORT: {
                letter: 'B',
                index: 1,
                aliases: ['目的港', 'pod', 'destination', '目的']
            },
            ROUTE_ID: {
                letter: 'C',
                index: 2,
                aliases: ['航线id', '航线ID', 'route id', 'group_id', 'groupid']
            },
            PORT_ID: {
                letter: 'D',
                index: 3,
                aliases: ['港口id', '港口ID', 'port id', 'portid']
            },
            ROUTE: {
                letter: 'G',
                index: 6,
                aliases: ['共舱船公司', '共舱', '舱公司', '船公司']
            },
            ROUTE_REMARK: {
                letter: 'H',
                index: 7,
                aliases: ['航线备注', '备注', 'remark']
            },
            SHIP_NAME: {
                letter: 'K',
                index: 10,
                aliases: ['船名', '航次', 'vessel', '船名航次']
            },
            CAPACITY: {
                letter: 'L',
                index: 11,
                aliases: ['运力', 'teu', '舱位', '船型', 'capacity']
            },
            SHIP_DATE: {
                letter: 'M',
                index: 12,
                aliases: ['开船', '船期', '离港', 'etd', '时间', '计划开航', '计划开航时间']
            },
            WEEK: {
                letter: 'R',
                index: 17,
                aliases: ['周别', '周次', '周数', 'week']
            }
        };

        // ==================== 辅助函数 ====================
        /**
         * 将列字母转换为索引（A=0, B=1, ..., Z=25, AA=26, ...）
         * @param {string} letter - 列字母（如 'K', 'M'）
         * @returns {number|null} - 列索引，失败返回 null
         */
        function columnLetterToIndex(letter) {
            if (!letter) return null;
            let index = 0;
            const up = letter.trim().toUpperCase();
            for (let i = 0; i < up.length; i++) {
                const charCode = up.charCodeAt(i);
                if (charCode < 65 || charCode > 90) return null;
                index = index * 26 + (charCode - 64);
            }
            return index - 1;
        }

        /**
         * 检查关键词是否匹配列名
         * @param {string} key - 列名
         * @param {string} keyword - 关键词
         * @returns {boolean} - 是否匹配
         */
        function matchesKeyword(key, keyword) {
            if (!key) return false;
            const lowerKey = key.toLowerCase();
            return lowerKey.includes(keyword.toLowerCase()) || key.includes(keyword);
        }

        /**
         * 根据关键词或列字母获取列键名
         * @param {string[]} keywords - 关键词数组
         * @param {string|null} fallbackLetter - 备用列字母
         * @param {string[]} columnKeys - 所有列键名数组
         * @returns {string|null} - 列键名，未找到返回 null
         */
        function getColumnKey(keywords, fallbackLetter, columnKeys) {
            const key = columnKeys.find(col =>
                keywords.some(keyword => matchesKeyword(col, keyword))
            );
            if (key) return key;
            if (fallbackLetter) {
                const idx = columnLetterToIndex(fallbackLetter);
                if (idx !== null && columnKeys[idx]) {
                    return columnKeys[idx];
                }
            }
            return null;
        }

        /**
         * 规范化日期字符串格式为 yyyy/m/d（去除补零）
         * @param {string} dateStr - 日期字符串（如 "2025/12/21" 或 "2025/12/07"）
         * @returns {string} - 规范化后的日期字符串（如 "2025/12/21" 或 "2025/12/7"）
         */
        function buildWeekColumns(weekCodes, weekDefinitionMap) {
            if (!Array.isArray(weekCodes) || weekCodes.length === 0) {
                debugError('weekCodes为空');
                return [];
            }
            
            return weekCodes.map(code => {
                const year = code.substring(0, 4);
                const weekNo = parseInt(code.substring(4), 10);
                
                const weekDef = weekDefinitionMap[code];
                if (!weekDef || !weekDef.range) {
                    debugError(`周别 ${code} 未在weekDefinitionMap中找到日期范围！`);
                    return {
                        code,
                        label: `${year}/${String(weekNo).padStart(2, '0')}`,
                        range: '[未找到日期范围]'
                    };
                }
                
                return {
                    code,
                    label: `${year}/${String(weekNo).padStart(2, '0')}`,
                    range: weekDef.range
                };
            });
        }

        /**
         * 根据日期从 weekDefinitionMap 中查找对应的周别代码
         * @param {Date|string|number} date - 日期对象、日期字符串或日期序列号
         * @param {Object} weekDefinitionMap - 周别定义映射表
         * @returns {string|null} - 周别代码（格式：YYYYWW），如果找不到则返回 null
         */
        function getWeekCodeFromDate(date, weekDefinitionMap) {
            if (!date || !weekDefinitionMap || Object.keys(weekDefinitionMap).length === 0) {
                return null;
            }
            
            // 解析日期
            let dateObj = null;
            if (date instanceof Date) {
                dateObj = date;
            } else if (typeof date === 'string') {
                dateObj = new Date(date);
            } else if (typeof date === 'number') {
                // Excel 日期序列号
                dateObj = new Date((date - 25569) * 86400 * 1000);
            }
            
            if (!dateObj || isNaN(dateObj.getTime())) {
                return null;
            }
            
            // 遍历 weekDefinitionMap，查找包含该日期的周别
            for (const [weekCode, weekDef] of Object.entries(weekDefinitionMap)) {
                if (!weekDef || !weekDef.sunday || !weekDef.saturday) {
                    continue;
                }
                
                // 解析周别的开始和结束日期
                const parseDateString = (dateStr) => {
                    if (!dateStr) return null;
                    const d = new Date(dateStr);
                    return isNaN(d.getTime()) ? null : d;
                };
                
                const startDate = parseDateString(weekDef.sunday);
                const endDate = parseDateString(weekDef.saturday);
                
                if (!startDate || !endDate) {
                    continue;
                }
                
                // 比较日期（只比较年月日，忽略时分秒）
                const dateYear = dateObj.getFullYear();
                const dateMonth = dateObj.getMonth();
                const dateDay = dateObj.getDate();
                const dateOnly = new Date(dateYear, dateMonth, dateDay);
                
                const startYear = startDate.getFullYear();
                const startMonth = startDate.getMonth();
                const startDay = startDate.getDate();
                const startOnly = new Date(startYear, startMonth, startDay);
                
                const endYear = endDate.getFullYear();
                const endMonth = endDate.getMonth();
                const endDay = endDate.getDate();
                const endOnly = new Date(endYear, endMonth, endDay);
                
                // 检查日期是否在范围内
                if (dateOnly >= startOnly && dateOnly <= endOnly) {
                    return weekCode;
                }
            }
            
            return null;
        }

        function getWeekCodesFromDefinition(weekDefinitionMap) {
            // 如果 weekDefinitionMap 为空，返回空数组，允许所有数据通过
            if (Object.keys(weekDefinitionMap).length === 0) {
                debugWarn('[001-04] weekDefinitionMap 为空，允许所有周别的数据通过');
                return [];
            }
            
            const allWeekCodes = Object.keys(weekDefinitionMap).sort();
            
            // 优先使用当前日期从 weekDefinitionMap 中查找当前周别（而不是使用 getCurrentWeekCode）
            // 这样可以确保与 week 表中的周别定义一致
            const today = new Date();
            let currentWeekCode = getWeekCodeFromDate(today, weekDefinitionMap);
            
            // 如果找不到，回退到使用 getCurrentWeekCode
            if (!currentWeekCode) {
                if (typeof window !== 'undefined' && window.getCurrentWeekCode) {
                    currentWeekCode = window.getCurrentWeekCode();
                    debugWarn(`[001-04] 无法从 weekDefinitionMap 中找到当前日期对应的周别，使用 getCurrentWeekCode: ${currentWeekCode}`);
                } else {
                    debugError('getCurrentWeekCode 函数未找到，请检查 week-utils.js 是否已加载');
                    return [];
                }
            } else {
                debugLog(`[001-04] 从 weekDefinitionMap 中找到当前周别: ${currentWeekCode}`);
            }
            
            const currentIndex = allWeekCodes.indexOf(currentWeekCode);
            
            let selectedWeekCodes = [];
            if (currentIndex >= 0) {
                selectedWeekCodes = allWeekCodes.slice(currentIndex, currentIndex + APP_CONFIG.WEEK_COUNT).filter(Boolean);
                debugLog(`[001-04] 选择的周别范围: ${selectedWeekCodes.join(', ')}`);
            } else {
                debugWarn(`当前周别 ${currentWeekCode} 不在weekDefinitionMap中，使用前${APP_CONFIG.WEEK_COUNT}周`);
                selectedWeekCodes = allWeekCodes.slice(0, APP_CONFIG.WEEK_COUNT).filter(Boolean);
            }
            
            return selectedWeekCodes;
        }

        async function generatePivotTable(data) {
            if (!Array.isArray(data)) {
                showError(ErrorType.DATA_VALIDATION, 'DATA_INVALID', { message: 'data must be an array' });
                return;
            }
            
            if (data.length === 0) {
                showError(ErrorType.DATA_VALIDATION, 'DATA_EMPTY');
                return;
            }

            const firstRow = data[0];
            const columnKeys = Object.keys(firstRow);

            const originPortCol = getColumnKey(COLUMN_CONFIG.ORIGIN_PORT.aliases, COLUMN_CONFIG.ORIGIN_PORT.letter, columnKeys);
            const destPortCol = getColumnKey(COLUMN_CONFIG.DEST_PORT.aliases, COLUMN_CONFIG.DEST_PORT.letter, columnKeys);
            const routeIdCol = getColumnKey(COLUMN_CONFIG.ROUTE_ID.aliases, COLUMN_CONFIG.ROUTE_ID.letter, columnKeys);
            const portIdCol = getColumnKey(COLUMN_CONFIG.PORT_ID.aliases, COLUMN_CONFIG.PORT_ID.letter, columnKeys);
            const routeCol = getColumnKey(COLUMN_CONFIG.ROUTE.aliases, COLUMN_CONFIG.ROUTE.letter, columnKeys);
            const routeRemarkCol = getColumnKey(COLUMN_CONFIG.ROUTE_REMARK.aliases, COLUMN_CONFIG.ROUTE_REMARK.letter, columnKeys);
            const shipNameCol = getColumnKey(COLUMN_CONFIG.SHIP_NAME.aliases, COLUMN_CONFIG.SHIP_NAME.letter, columnKeys);
            const capacityCol = getColumnKey(COLUMN_CONFIG.CAPACITY.aliases, COLUMN_CONFIG.CAPACITY.letter, columnKeys);
            const shipDateCol = getColumnKey(COLUMN_CONFIG.SHIP_DATE.aliases, COLUMN_CONFIG.SHIP_DATE.letter, columnKeys);
            const weekCol = getColumnKey(COLUMN_CONFIG.WEEK.aliases, COLUMN_CONFIG.WEEK.letter, columnKeys);

            if (!originPortCol || !destPortCol || !routeIdCol || !portIdCol || !routeCol || !shipNameCol || !capacityCol || !shipDateCol || !weekCol) {
                showError(ErrorType.FILE_PARSE, 'MISSING_COLUMNS', { columns: columnKeys.join(', ') });
                return;
            }

            const weekCodes = getWeekCodesFromDefinition(weekDefinitionMap);
            weekColumns = buildWeekColumns(weekCodes, weekDefinitionMap);

            processedRecords = [];
            destinationFilters = { originPorts: [], destPorts: [], routes: [] };

            const rawRecords = [];
            data.forEach(row => {
                // 读取原始港口名称（保持 Excel 中的原始值，不进行标准化）
                const originPort = String(row[originPortCol] ?? '').trim();
                const destPort = String(row[destPortCol] ?? '').trim();
                
                const routeId = String(row[routeIdCol] ?? '').trim();
                const portId = String(row[portIdCol] ?? '').trim();
                const route = String(row[routeCol] ?? '').trim();
                const routeRemark = routeRemarkCol ? String(row[routeRemarkCol] ?? '').trim() : '';
                const shipName = String(row[shipNameCol] ?? '').trim();
                const capacity = parseFloat(row[capacityCol]) || 0;
                const shipDate = row[shipDateCol];
                const weekText = String(row[weekCol] ?? '').trim();
                
                // 解析周别（不进行过滤，允许所有数据通过，类似 Market-Sailing-Schedule）
                // 周别过滤在显示时进行，而不是在数据处理时进行
                let weekCode = null;
                if (typeof window !== 'undefined' && window.parseWeekText) {
                    weekCode = window.parseWeekText(weekText);
                } else {
                    debugWarn('[001-04] parseWeekText 函数未找到，将不进行周别解析');
                }
                
                // 如果 weekCode 为 null，尝试根据 shipDate 从 weekDefinitionMap 中查找
                if (!weekCode && shipDate && weekDefinitionMap && Object.keys(weekDefinitionMap).length > 0) {
                    weekCode = getWeekCodeFromDate(shipDate, weekDefinitionMap);
                    if (weekCode) {
                        debugLog(`[001-04] 根据 shipDate 找到周别: ${weekCode}`);
                    }
                }
                
                // 如果仍然为 null，尝试使用 week-utils.js 中的函数根据日期计算
                if (!weekCode && shipDate) {
                    if (typeof window !== 'undefined' && window.getWeekCodeFromDate) {
                        weekCode = window.getWeekCodeFromDate(shipDate);
                    } else if (typeof window !== 'undefined' && window.getWeekNumber && window.getCurrentWeekCode) {
                        // 回退方案：根据日期计算周数，然后构建 weekCode
                        const weekNo = window.getWeekNumber(shipDate);
                        const year = shipDate instanceof Date ? shipDate.getFullYear() : new Date(shipDate).getFullYear();
                        weekCode = `${year}${String(weekNo).padStart(2, '0')}`;
                    }
                }
                
                // 不进行周别过滤，允许所有数据通过（类似 Market-Sailing-Schedule）

                const record = {
                    originPort,
                    destPort,
                    routeId,
                    portId,
                    route,
                    routeRemark,
                    shipName,
                    capacity,
                    shipDate,
                    weekCode
                };
                rawRecords.push(record);
            });

            debugLog(`[001-04] 数据处理统计: 总行数=${data.length}, 处理=${rawRecords.length}`);

            if (rawRecords.length === 0) {
                showError(ErrorType.FILE_PARSE, 'NO_SCHEDULE_DATA');
                return;
            }

            // 如果 weekColumns 为空（weekDefinitionMap 为空），从数据中动态提取周别
            if (!weekColumns || weekColumns.length === 0) {
                const uniqueWeekCodes = [...new Set(rawRecords.map(r => r.weekCode).filter(Boolean))].sort();
                if (uniqueWeekCodes.length > 0) {
                    debugWarn('[001-04] weekDefinitionMap 为空，从数据中动态提取周别:', uniqueWeekCodes);
                    // 构建简单的 weekColumns（没有日期范围信息）
                    weekColumns = uniqueWeekCodes.map(code => {
                        const year = code.substring(0, 4);
                        const weekNo = parseInt(code.substring(4), 10);
                        return {
                            code,
                            label: `${year}/${String(weekNo).padStart(2, '0')}`,
                            range: ''
                        };
                    });
                } else {
                    debugWarn('[001-04] 数据中没有有效的周别信息，使用默认周别');
                    // 如果数据中也没有周别，使用当前周+未来3周
                    const currentWeekCode = window.getCurrentWeekCode ? window.getCurrentWeekCode() : '';
                    if (currentWeekCode) {
                        const defaultWeeks = [];
                        for (let i = 0; i < APP_CONFIG.WEEK_COUNT; i++) {
                            const year = parseInt(currentWeekCode.substring(0, 4), 10);
                            const week = parseInt(currentWeekCode.substring(4), 10) + i;
                            let finalYear = year;
                            let finalWeek = week;
                            if (week > 52) {
                                finalYear = year + 1;
                                finalWeek = week - 52;
                            }
                            const code = `${finalYear}${String(finalWeek).padStart(2, '0')}`;
                            defaultWeeks.push({
                                code,
                                label: `${finalYear}/${String(finalWeek).padStart(2, '0')}`,
                                range: ''
                            });
                        }
                        weekColumns = defaultWeeks;
                    }
                }
            }

            await updateFilterOptions(rawRecords);
            processedRecords = rawRecords;
            renderTable();
            updateAiAnalysis(false);
        }

        function renderTableHeader(weekColumns) {
            const thead = DOMCache.get('tableHead');
            if (!thead) {
                debugWarn('tableHead element not found');
                return;
            }
            
            const routeRemarkWidth = '10%';
            const routeLabelWidth = '40%';
            const weekCount = weekColumns.length;
            const weekColumnWidth = weekCount > 0 ? `${50 / weekCount}%` : '0%';
            
            const headerCells = weekColumns.map(week => {
                const rangeHtml = week.range ? `<div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">(${escapeHtml(week.range)})</div>` : '';
                return `<th class="table-header week-cell" style="width: ${weekColumnWidth};">
                    <div>${escapeHtml(week.label)}</div>
                    ${rangeHtml}
                </th>`;
            }).join('');
            
            // 为表头单元格添加 ARIA 属性
            const headerCellsWithAria = headerCells.replace(/<th/g, '<th role="columnheader" scope="col"');
            
            thead.innerHTML = `
                <tr role="row">
                    <th class="table-header" style="width: ${routeRemarkWidth};" role="columnheader" scope="col">航线备注</th>
                    <th class="table-header" style="width: ${routeLabelWidth};" role="columnheader" scope="col">共舱船公司</th>
                    ${headerCellsWithAria}
                </tr>
            `;
        }

        function formatShipDateForTooltip(shipDate) {
            if (shipDate === null || shipDate === undefined || shipDate === '') {
                return '—';
            }

            if (typeof window !== 'undefined' && typeof window.formatShipDateForTooltip === 'function') {
                try {
                    const result = window.formatShipDateForTooltip(shipDate);
                    if (result && result !== '—' && result !== 'Invalid Date') {
                        return result;
                    }
                } catch (e) {
                    debugError('[001-04] 全局日期格式化函数失败:', e);
                }
            }

            if (typeof shipDate === 'number' && isFinite(shipDate)) {
                if (typeof window !== 'undefined' && typeof window.parseExcelDateSerial === 'function') {
                    try {
                        const date = window.parseExcelDateSerial(shipDate);
                        if (date && !isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}/${month}/${day}`;
                        }
                    } catch (e) {
                        debugError('[001-04] parseExcelDateSerial失败:', e);
                    }
                }
                
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + (shipDate + 1) * 86400000);
                if (shipDate >= 61) {
                    date.setDate(date.getDate() - 1);
                }
                if (!isNaN(date.getTime()) && date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}/${month}/${day}`;
                }
            }

            if (shipDate instanceof Date && !isNaN(shipDate.getTime())) {
                const year = shipDate.getFullYear();
                const month = String(shipDate.getMonth() + 1).padStart(2, '0');
                const day = String(shipDate.getDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            }

            return '—';
        }

        function buildTableCells(item, weekColumns) {
            const cells = [
                `<td class="route-remark-cell" role="cell">${escapeHtml(item.routeRemark || '—')}</td>`,
                `<td class="route-label-cell" role="cell">${escapeHtml(item.route || '未知航线')}</td>`
            ];

            weekColumns.forEach((week) => {
                const weekCode = week.code;
                const ships = item.weeks[weekCode] || [];
                
                const totalCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                const shipCount = ships.length;
                
                let tooltipData = '';
                if (ships.length > 0) {
                    const shipDetails = ships.map(ship => {
                        const shipName = ship.shipName || '未知';
                        const capacity = ship.capacity || 0;
                        const capacityText = capacity > 0 ? `${capacity}TEU` : '0TEU';
                        const formattedDate = formatShipDateForTooltip(ship.shipDate);
                        return `${escapeHtml(shipName)} ${capacityText} (${escapeHtml(formattedDate)})`;
                    }).join('\n');
                    tooltipData = shipDetails;
                }
                
                let cellContent = '';
                if (currentView === 'all') {
                    cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${shipCount}`;
                } else if (currentView === 'capacity') {
                    cellContent = totalCapacity.toLocaleString() + ' TEU';
                } else if (currentView === 'ships') {
                    cellContent = shipCount.toString();
                }
                
                const cellClass = ships.length > 0 ? 'number-cell hover-cell' : 'number-cell';
                const tooltipAttr = tooltipData ? `data-tooltip="${escapeHtml(tooltipData)}"` : '';
                const ariaLabel = tooltipData ? `aria-label="${escapeHtml(tooltipData)}"` : '';
                cells.push(`<td class="${cellClass}" role="cell" ${tooltipAttr} ${ariaLabel}>${cellContent}</td>`);
            });

            return cells;
        }

        // 虚拟滚动实例
        let virtualScrollInstance = null;

        function renderTableBody(groupedData, weekColumns) {
            const tbody = DOMCache.get('tableBody');
            if (!tbody) {
                debugWarn('tableBody element not found');
                return;
            }
            
            // 如果数据量超过阈值，使用虚拟滚动
            if (groupedData.length >= 100 && typeof window.VirtualScroll !== 'undefined') {
                // 销毁旧实例
                if (virtualScrollInstance) {
                    virtualScrollInstance.destroy();
                }
                
                // 获取表格容器
                const tableContainer = DOMCache.get('tableContainer') || document.getElementById('tableContainer');
                if (tableContainer) {
                    // 创建虚拟滚动
                    virtualScrollInstance = window.enableVirtualScrollForTable(
                        tableContainer,
                        groupedData,
                        (item, index) => {
                            const row = document.createElement('tr');
                            row.setAttribute('role', 'row');
                            row.setAttribute('aria-rowindex', index + 2); // +2 因为表头是第1行
                            const cells = buildTableCells(item, weekColumns);
                            row.innerHTML = cells.join('');
                            return row;
                        },
                        {
                            itemHeight: 50, // 表格行高度
                            threshold: 100,
                            buffer: 5
                        }
                    );
                } else {
                    // 降级到普通渲染
                    renderTableBodyNormal(groupedData, weekColumns);
                }
            } else {
                // 数据量不足，使用普通渲染
                renderTableBodyNormal(groupedData, weekColumns);
            }
        }

        function renderTableBodyNormal(groupedData, weekColumns) {
            const tbody = DOMCache.get('tableBody');
            if (!tbody) {
                debugWarn('tableBody element not found');
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            groupedData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.setAttribute('role', 'row');
                row.setAttribute('aria-rowindex', index + 2); // +2 因为表头是第1行
                const cells = buildTableCells(item, weekColumns);
                row.innerHTML = cells.join('');
                fragment.appendChild(row);
            });
            
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function renderTableSummary(groupedData, weekColumns) {
            const tbody = DOMCache.get('tableBody') || tableBody;
            if (!tbody) return;
            
            const hasDestinationSelection = Boolean(
                destinationFilters.originPorts.length ||
                destinationFilters.destPorts.length ||
                destinationFilters.routes.length
            );

            if (!hasDestinationSelection || groupedData.length === 0) return;

            const summaryRow = document.createElement('tr');
            summaryRow.className = 'summary-row';
            summaryRow.setAttribute('role', 'row');
            summaryRow.setAttribute('aria-label', '合计行');
            const summaryCells = [
                '<td role="cell"><strong>合计</strong></td>',
                '<td role="cell"></td>'
            ];

            const totals = weekColumns.reduce((acc, week) => {
                acc[week.code] = { capacity: 0, ships: 0 };
                return acc;
            }, {});

            groupedData.forEach(item => {
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    totals[weekCode].capacity += ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    totals[weekCode].ships += ships.length;
                });
            });
            
            weekColumns.forEach((week) => {
                const weekCode = week.code;
                const totalCapacity = totals[weekCode].capacity || 0;
                const totalShips = totals[weekCode].ships || 0;
                
                let cellContent = '';
                if (currentView === 'all') {
                    cellContent = `运力: ${totalCapacity.toLocaleString()} TEU\n派船: ${totalShips}`;
                } else if (currentView === 'capacity') {
                    cellContent = `${totalCapacity.toLocaleString()} TEU`;
                } else if (currentView === 'ships') {
                    cellContent = `${totalShips}`;
                }
                
                summaryCells.push(`<td class="number-cell"><strong>${escapeHtml(cellContent)}</strong></td>`);
            });
            
            summaryRow.innerHTML = summaryCells.join('');
            tbody.appendChild(summaryRow);
        }

        function attachTableEventListeners() {
            const tbody = DOMCache.get('tableBody');
            if (!tbody) {
                debugWarn('tableBody element not found');
                return;
            }
            
            const existingCells = tbody.querySelectorAll('.hover-cell');
            existingCells.forEach(cell => {
                if (cell._tooltipMoveHandler) {
                    EventManager.remove(cell, 'mousemove', cell._tooltipMoveHandler);
                    cell._tooltipMoveHandler = null;
                }
            });
            
            const hoverCells = tbody.querySelectorAll('.hover-cell');
            hoverCells.forEach(cell => {
                const tooltipText = cell.getAttribute('data-tooltip');
                if (!tooltipText) return;
                
                let tooltip = null;
                
                const handleMouseEnter = (e) => {
                    tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.style.display = 'block';
                    const span = document.createElement('span');
                    span.className = 'tooltip-line';
                    span.textContent = tooltipText;
                    span.style.whiteSpace = 'pre-wrap';
                    tooltip.appendChild(span);
                    document.body.appendChild(tooltip);
                    
                    const updateTooltipPosition = (event) => {
                        if (!tooltip || !tooltip.parentNode) return;
                        
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;
                        const rect = tooltip.getBoundingClientRect();
                        const tooltipWidth = rect.width || tooltip.offsetWidth;
                        const tooltipHeight = rect.height || tooltip.offsetHeight;
                        const padding = 10;
                        
                        let tooltipX = mouseX + padding;
                        let tooltipY = mouseY + padding;
                        
                        if (tooltipX + tooltipWidth > window.innerWidth) {
                            tooltipX = mouseX - tooltipWidth - padding;
                        }
                        if (tooltipX < 0) {
                            tooltipX = (window.innerWidth - tooltipWidth) / 2;
                        }
                        if (tooltipY + tooltipHeight > window.innerHeight) {
                            tooltipY = mouseY - tooltipHeight - padding;
                        }
                        if (tooltipY < 0) {
                            tooltipY = mouseY + padding;
                        }
                        
                        tooltip.style.left = tooltipX + 'px';
                        tooltip.style.top = tooltipY + 'px';
                    };
                    
                    requestAnimationFrame(() => {
                        updateTooltipPosition(e);
                    });
                    
                    EventManager.add(cell, 'mousemove', updateTooltipPosition);
                    cell._tooltipMoveHandler = updateTooltipPosition;
                };
                
                const handleMouseLeave = () => {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                    if (cell._tooltipMoveHandler) {
                        EventManager.remove(cell, 'mousemove', cell._tooltipMoveHandler);
                        cell._tooltipMoveHandler = null;
                    }
                };
                
                EventManager.add(cell, 'mouseenter', handleMouseEnter);
                EventManager.add(cell, 'mouseleave', handleMouseLeave);
            });
        }

        function updateTableInfo(filteredRecords, groupedData) {
            const infoEl = DOMCache.get('infoText');
            if (!infoEl) {
                debugWarn('infoText element not found');
                return;
            }
            
            const totalCombos = groupedData.length;
            const totalRecords = filteredRecords.length;
            const originPortText = destinationFilters.originPorts.length ? destinationFilters.originPorts.join('、') : '全部起运港';
            const destPortText = destinationFilters.destPorts.length ? destinationFilters.destPorts.join('、') : '全部目的港';
            const routeText = destinationFilters.routes.length ? destinationFilters.routes.join('、') : '全部共舱船公司';
            const infoText = `已加载 ${totalRecords} 条记录，组合 ${totalCombos} 行；筛选起运港：${originPortText}；筛选目的港：${destPortText}；筛选共舱船公司：${routeText}`;
            infoEl.textContent = infoText;
            
            // 更新 ARIA Live Region（中优先级优化：ARIA 标签完善）
            const ariaLiveRegion = document.getElementById('aria-live-region');
            if (ariaLiveRegion) {
                ariaLiveRegion.textContent = `表格已更新：${infoText}`;
            }
        }

        function renderTable() {
            if (!Array.isArray(processedRecords)) {
                debugError('processedRecords is not an array');
                return;
            }
            
            if (!processedRecords.length) {
                const container = DOMCache.get('tableContainer') || tableContainer;
                if (container) container.classList.add('hidden');
                updateChart(false, []);
                updateAiAnalysis(false);
                return;
            }

            const filteredRecords = getFilteredRecords();
            latestFilteredRecords = filteredRecords;
            const hasPortSelection = destinationFilters.originPorts.length > 0 || destinationFilters.destPorts.length > 0;
            const groupedResult = groupRecords(filteredRecords);
            const groupedData = groupedResult.data;
            groupedTableData = groupedData;

            // 如果 weekColumns 为空，从数据中动态提取周别
            if (!weekColumns || !Array.isArray(weekColumns) || weekColumns.length === 0) {
                debugWarn('[001-04] renderTable: weekColumns 为空，从数据中动态提取周别');
                const uniqueWeekCodes = [...new Set(processedRecords.map(r => r.weekCode).filter(Boolean))].sort();
                if (uniqueWeekCodes.length > 0) {
                    weekColumns = uniqueWeekCodes.map(code => {
                        const year = code.substring(0, 4);
                        const weekNo = parseInt(code.substring(4), 10);
                        return {
                            code,
                            label: `${year}/${String(weekNo).padStart(2, '0')}`,
                            range: ''
                        };
                    });
                    debugLog('[001-04] renderTable: 从数据中提取的周别:', weekColumns.map(w => w.code));
                } else {
                    debugError('[001-04] renderTable: 数据中没有有效的周别信息，无法渲染表格');
                    const container = DOMCache.get('tableContainer') || tableContainer;
                    if (container) container.classList.add('hidden');
                    return;
                }
            }
            
            renderTableHeader(weekColumns);
            renderTableBody(groupedData, weekColumns);
            renderTableSummary(groupedData, weekColumns);
            attachTableEventListeners();
            updateTableInfo(filteredRecords, groupedData);

            const container = DOMCache.get('tableContainer') || tableContainer;
            if (container) container.classList.remove('hidden');
            
            updateChart(hasPortSelection, groupedData);
            updateAiAnalysis(hasPortSelection);
        }

        function updateChart(hasPortSelection, groupedData) {
            const chartContainer = document.getElementById('chartContainer');
            const chartWrapper = document.getElementById('chartWrapper');
            const emptyChartMessage = document.getElementById('emptyChartMessage');
            
            chartContainer.classList.remove('hidden');
            
            if (!hasPortSelection || groupedData.length === 0) {
                chartWrapper.classList.add('hidden');
                emptyChartMessage.classList.remove('hidden');
                if (capacityChart) {
                    capacityChart.destroy();
                    capacityChart = null;
                }
                return;
            }
            
            emptyChartMessage.classList.add('hidden');
            chartWrapper.classList.remove('hidden');
            
            const weekCodes = weekColumns.map(week => week.code);
            // 检测是否为移动端（排除iPad横屏宽屏模式，>= 1024px且横屏时使用桌面版）
            const isLandscape = window.innerWidth > window.innerHeight;
            const isMobile = window.innerWidth <= 900 || (window.innerWidth < 1024 && !isLandscape);
            const weekLabels = weekColumns.map(week => {
                if (isMobile) {
                    // 移动端只显示周号，如：53, 1, 2, 3
                    const weekNo = week.label.split('/')[1] || week.label;
                    return weekNo.replace(/^0+/, ''); // 去掉前导零
                } else {
                    // 桌面端显示完整信息
                    const range = week.range ? ` (${week.range})` : '';
                    return `${week.label}${range}`;
                }
            });
            
            const shipData = [];
            const datasets = [];
            const podRoutePairs = [];
            
            groupedData.forEach(item => {
                const route = item.route || '未知共舱船公司';
                const routeRemark = item.routeRemark || '—';
                podRoutePairs.push({
                    label: `${routeRemark} - ${route}`,
                    route: route,
                    routeId: item.routeId || '',
                    routeRemark: routeRemark
                });
            });
            
            podRoutePairs.forEach((pair, index) => {
                const item = groupedData[index];
                const capacityValues = [];
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    capacityValues.push(weekCapacity);
                });
                
                const hue = (index * 137.508) % 360;
                const color = `hsl(${hue}, 70%, 50%)`;
                
                datasets.push({
                    label: pair.label,
                    data: capacityValues,
                    type: 'bar',
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1,
                    order: 1
                });
            });
            
            weekColumns.forEach((week) => {
                const weekCode = week.code;
                let totalShips = 0;
                groupedData.forEach(item => {
                    const ships = item.weeks[weekCode] || [];
                    totalShips += ships.length;
                });
                shipData.push(totalShips);
            });
            
            datasets.push({
                label: '派船总数',
                data: shipData,
                type: 'line',
                borderColor: '#FF8A00',
                backgroundColor: 'rgba(255, 138, 0, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#FF8A00',
                pointBorderColor: '#FFFFFF',
                pointBorderWidth: 2,
                yAxisID: 'y1',
                order: 0
            });
            
            if (capacityChart) {
                capacityChart.destroy();
            }
            const ctx = document.getElementById('trendChart').getContext('2d');
            capacityChart = new Chart(ctx, {
                data: {
                    labels: weekLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '运力与派船趋势分析',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '周别'
                            }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '运力 (TEU)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '派船数'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            stacked: false
                        }
                    }
                }
            });
        }

        const aiProviders = {
            deepseek: {
                id: 'deepseek',
                name: 'DeepSeek',
                keyInputId: 'apiKeyInput',
                urlInputId: 'apiUrlInput',
                modelInputId: 'apiModelInput',
                buttonId: 'aiAnalysisBtn',
                loadingId: 'aiLoading',
                resultContainerId: 'aiResult',
                resultContentId: 'aiResultContent',
                defaultUrl: 'https://api.deepseek.com/v1/chat/completions',
                defaultModel: 'deepseek-chat',
                storagePrefix: 'deepseek',
                temperature: 0.7,
                maxTokens: 8000
            },
            kimi: {
                id: 'kimi',
                name: 'KIMI (Moonshot)',
                keyInputId: 'kimiApiKeyInput',
                urlInputId: 'kimiApiUrlInput',
                modelInputId: 'kimiModelInput',
                buttonId: 'kimiAnalysisBtn',
                loadingId: 'kimiAiLoading',
                resultContainerId: 'kimiAiResult',
                resultContentId: 'kimiAiResultContent',
                defaultUrl: 'https://api.moonshot.cn/v1/chat/completions',
                defaultModel: 'moonshot-v1-32k',
                storagePrefix: 'kimi',
                temperature: 0.7,
                maxTokens: 8000
            },
            qwen: {
                id: 'qwen',
                name: '通义千问 (Qwen)',
                keyInputId: 'qwenApiKeyInput',
                urlInputId: 'qwenApiUrlInput',
                modelInputId: 'qwenModelInput',
                buttonId: 'qwenAnalysisBtn',
                loadingId: 'qwenAiLoading',
                resultContainerId: 'qwenAiResult',
                resultContentId: 'qwenAiResultContent',
                defaultUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                defaultModel: 'qwen-max',
                storagePrefix: 'qwen',
                temperature: 0.7,
                maxTokens: 8000
            }
        };
        let activeAiProvider = 'deepseek';
        let setActiveAiPanelBound = null;

        function setActiveAiPanel(providerId = 'deepseek') {
            if (setActiveAiPanelBound) {
                const result = setActiveAiPanelBound(providerId);
                if (result) {
                    activeAiProvider = result;
                }
            } else {
                if (!aiProviders[providerId]) return;
                activeAiProvider = providerId;
                const aiTabButtons = document.querySelectorAll('.ai-tab-btn');
                const aiPanels = document.querySelectorAll('.ai-panel');
                aiTabButtons.forEach(btn => {
                    if (btn.dataset.provider === providerId) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                aiPanels.forEach(panel => {
                    if (panel.dataset.provider === providerId) {
                        panel.classList.add('active');
                    } else {
                        panel.classList.remove('active');
                    }
                });
            }
        }

        function loadAiConfigs() {
            loadAiConfigsFromStorage(aiProviders);
        }

        function getAiConfig(providerId = 'deepseek') {
            return getAiConfigFromInputs(providerId, aiProviders);
        }

        function saveAiConfig(providerId = 'deepseek') {
            saveAiConfigToStorage(providerId, aiProviders, (providerName) => {
                const configSavedMsg = typeof getErrorMessage === 'function' 
                    ? getErrorMessage(ErrorType.USER_ACTION, 'CONFIG_SAVED', { provider: providerName })
                    : `${providerName} API 配置已保存`;
                showSuccess(configSavedMsg);
            });
        }
        
        window.saveAiConfig = saveAiConfig;

        const wciCodeMap = {
            'WCI-COMPOSITE': '全球综合',
            'WCI-SHA-RTM': '上海 → 鹿特丹',
            'WCI-RTM-SHA': '鹿特丹 → 上海',
            'WCI-SHA-GOA': '上海 → 热那亚',
            'WCI-SHA-LAX': '上海 → 洛杉矶',
            'WCI-LAX-SHA': '洛杉矶 → 上海',
            'WCI-SHA-NYC': '上海 → 纽约',
            'WCI-NYC-RTM': '纽约 → 鹿特丹',
            'WCI-RTM-NYC': '鹿特丹 → 纽约'
        };

        const fbxCodeMap = {
            FBX: 'FBX（Freightos Baltic Index 全球综合）',
            FBX01: 'FBX01 中国/东亚 → 北美西海岸',
            FBX02: 'FBX02 北美西海岸 → 中国/东亚',
            FBX03: 'FBX03 中国/东亚 → 北美东海岸',
            FBX04: 'FBX04 北美东海岸 → 中国/东亚',
            FBX11: 'FBX11 中国/东亚 → 北欧',
            FBX12: 'FBX12 北欧 → 中国/东亚',
            FBX13: 'FBX13 中国/东亚 → 地中海',
            FBX14: 'FBX14 地中海 → 中国/东亚',
            FBX21: 'FBX21 北美东海岸 → 北欧',
            FBX22: 'FBX22 北欧 → 北美东海岸',
            FBX24: 'FBX24 欧洲 → 南美东海岸',
            FBX26: 'FBX26 欧洲 → 南美西海岸'
        };

        const cachedWci = loadCachedData(CACHE_KEYS.wci);
        if (cachedWci) {
            wciData = cachedWci;
            renderWciStatus();
        }
        const cachedFbx = loadCachedData(CACHE_KEYS.fbx);
        if (cachedFbx) {
            fbxData = cachedFbx;
            renderFbxStatus();
        }

        function updateAiAnalysis(hasPortSelection) {
            const aiAnalysisContainer = document.getElementById('aiAnalysisContainer');
            const emptyAiMessage = document.getElementById('emptyAiMessage');
            const aiConfigSection = document.getElementById('aiConfigSection');
            
            if (!aiAnalysisContainer) return;
            
            aiAnalysisContainer.style.display = 'block';
            
            if (!hasPortSelection || !latestFilteredRecords || latestFilteredRecords.length === 0) {
                if (emptyAiMessage) emptyAiMessage.style.display = 'block';
                if (aiConfigSection) aiConfigSection.style.display = 'none';
                return;
            }
            
            if (emptyAiMessage) emptyAiMessage.style.display = 'none';
            if (aiConfigSection) aiConfigSection.style.display = 'block';
            loadAiConfigs();
            setActiveAiPanel(activeAiProvider);
        }

        async function runAiAnalysis(providerId = 'deepseek') {
            await executeAiAnalysis(
                providerId,
                aiProviders,
                buildAiPrompt,
                baseSystemPrompt,
                {
                    beforeAnalysis: async () => {
                        const results = await Promise.allSettled([
                            fetchBunkerData(false),
                            fetchWciData(false),
                            fetchFbxData(false)
                        ]);
                        
                        results.forEach((result, index) => {
                            if (result.status === 'rejected') {
                                const dataNames = ['bunker', 'wci', 'fbx'];
                                debugError(`数据加载失败 [${dataNames[index]}]:`, result.reason);
                            }
                        });
                    }
                }
            );
        }
        
        // 导出到全局，供模板中的 onclick 使用
        window.runAiAnalysis = runAiAnalysis;

        window.addEventListener('beforeunload', () => {
            EventManager.removeAll();
            DOMCache.clear();
        });

        function buildAiPrompt() {
            if (!Array.isArray(latestFilteredRecords)) {
                showError(ErrorType.DATA_VALIDATION, 'NO_DATA', { message: 'latestFilteredRecords is not an array' });
                return null;
            }
            
            const filteredRecords = latestFilteredRecords;
            if (!filteredRecords.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_DATA');
                return null;
            }
            
            const analysisGroups = groupedTableData.length ? groupedTableData : groupRecords(filteredRecords).data;
            if (!analysisGroups.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_ROUTE_DATA');
                return null;
            }

            const prepared = prepareAnalysisData(analysisGroups, weekColumns, showError, ErrorType);
            if (!prepared) return null;
            const { analysisData, weeklySummary, analysisWeekCodes, analysisWeekLabels } = prepared;

            const originPortSummary = destinationFilters.originPorts.length
                ? destinationFilters.originPorts.join('、')
                : '全部起运港';
            const destPortSummary = destinationFilters.destPorts.length
                ? destinationFilters.destPorts.join('、')
                : '全部目的港';
            const destinationSummary = `${originPortSummary} / ${destPortSummary}`;

            let prompt = buildDataOverview(destinationSummary, analysisData.length, analysisWeekCodes, analysisWeekLabels, weeklySummary);
            prompt += buildDetailedData001(analysisData, analysisWeekCodes, analysisWeekLabels);
            prompt += buildBookingDataSection(getBookingDataLocal());
            prompt += buildMarketReportsSection(marketReports);
            prompt += buildBunkerDataSection(bunkerData);
            prompt += buildWciDataSection(wciData);
            prompt += buildFbxDataSection(fbxData);
            prompt += buildScfiDataSection(marketReports);
            prompt += aiInstructionTemplate;
            return prompt;
        }

        function getBookingDataLocal() {
            return window.getBookingData ? window.getBookingData('bookingDataBody') : [];
        }

        function showModuleSelectionDialog() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'module-selection-overlay';

                const dialog = document.createElement('div');
                dialog.className = 'module-selection-dialog';

                dialog.innerHTML = `
                    <h2>选择要导出的模块</h2>
                    <div class="module-selection-options">
                        <label class="module-selection-label">
                            <input type="radio" name="moduleSelect" value="capacityModule">
                            <div class="module-selection-content">
                                <div class="module-selection-title">Module 01 · 航线运力分析</div>
                                <div class="module-selection-desc">包含港口筛选、运力表格和趋势图表</div>
                            </div>
                        </label>
                        <label class="module-selection-label">
                            <input type="radio" name="moduleSelect" value="aiModule">
                            <div class="module-selection-content">
                                <div class="module-selection-title">Module 02 · AI 趋势分析</div>
                                <div class="module-selection-desc">包含AI分析结果和配置信息</div>
                            </div>
                        </label>
                        <label class="module-selection-label">
                            <input type="radio" name="moduleSelect" value="all">
                            <div class="module-selection-content">
                                <div class="module-selection-title">Market Analysis · 市场分析 全部导出</div>
                                <div class="module-selection-desc">导出 Module 01 和 Module 02 两个模块</div>
                            </div>
                        </label>
                    </div>
                    <div class="module-selection-actions">
                        <button id="cancelExportBtn" class="btn-sweep-orange">取消</button>
                        <button id="confirmExportBtn" class="btn-sweep-blue">导出</button>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                // 更新标签选中状态（使用CSS类）
                const labels = dialog.querySelectorAll('.module-selection-label');
                const radios = dialog.querySelectorAll('input[type="radio"][name="moduleSelect"]');
                
                const updateLabelStyles = () => {
                    labels.forEach((label, index) => {
                        const radio = label.querySelector('input[type="radio"]');
                        if (radio && radio.checked) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                    });
                };

                // 为每个radio添加change事件监听器，确保视觉状态同步更新
                radios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        updateLabelStyles();
                    });
                });
                
                // 为每个label添加点击事件，确保点击整个区域都能选中
                labels.forEach(label => {
                    label.addEventListener('click', (e) => {
                        const radio = label.querySelector('input[type="radio"]');
                        if (radio && e.target !== radio) {
                            // 如果点击的不是radio本身，手动选中它
                            radio.checked = true;
                            // 手动触发change事件，确保其他radio取消选中并更新样式
                            radio.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                });

                // 确认按钮
                const confirmBtn = dialog.querySelector('#confirmExportBtn');
                confirmBtn.addEventListener('click', () => {
                    const selected = dialog.querySelector('input[name="moduleSelect"]:checked');
                    if (selected) {
                        document.body.removeChild(overlay);
                        resolve(selected.value);
                    } else {
                        // 提示选择模块
                        if (typeof showError === 'function' && typeof ErrorType !== 'undefined') {
                            showError(ErrorType.USER_ACTION, 'MODULE_NOT_SELECTED', { 
                                message: '请选择一个要导出的模块' 
                            });
                        } else {
                            alert('请选择一个要导出的模块');
                        }
                    }
                });

                // 取消按钮
                const cancelBtn = dialog.querySelector('#cancelExportBtn');
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(null);
                });

                // 点击遮罩关闭
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve(null);
                    }
                });

                // 默认选中第一个模块
                const firstRadio = dialog.querySelector('input[type="radio"][value="capacityModule"]');
                if (firstRadio) {
                    firstRadio.checked = true;
                    // 触发change事件，确保样式更新
                    firstRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    updateLabelStyles();
                }
            });
        }

        /**
         * 导出指定模块为 PDF
         * @param {string} moduleId - 模块ID ('capacityModule' 或 'aiModule')
         */
        async function exportModuleToPdf(moduleId) {
            // 获取模块名称
            const moduleNames = {
                'capacityModule': 'Module01-航线运力分析',
                'aiModule': 'Module02-AI趋势分析'
            };
            const moduleName = moduleNames[moduleId] || '模块';

            // 生成文件名
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fileName = `市场分析报告_${moduleName}_${year}${month}${day}`;

            // 获取要导出的模块元素
            const moduleSection = document.getElementById(moduleId);
            if (!moduleSection) {
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: `找不到模块: ${moduleId}` 
                });
                return;
            }

            // 直接使用公共导出函数
            if (typeof window.exportToPdfCommon !== 'function') {
                debugError('exportToPdfCommon 函数未找到，请确保 vendor/pdf-utils.js 已加载');
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: 'PDF 导出功能所需的工具函数未找到，请刷新页面重试' 
                });
                return;
            }

            await window.exportToPdfCommon({
                fileName,
                elements: moduleSection,
                chartCanvasId: moduleId === 'capacityModule' ? 'trendChart' : null
            });
        }

        /**
         * 导出全部模块为 PDF（Module 01 + Module 02）
         */
        async function exportAllModulesToPdf() {
            // 生成文件名
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fileName = `市场分析报告_全部模块_${year}${month}${day}`;

            // 获取两个模块
            const capacityModule = document.getElementById('capacityModule');
            const aiModule = document.getElementById('aiModule');

            if (!capacityModule || !aiModule) {
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: '找不到要导出的模块' 
                });
                return;
            }

            // 直接使用公共导出函数
            if (typeof window.exportToPdfCommon !== 'function') {
                debugError('exportToPdfCommon 函数未找到，请确保 vendor/pdf-utils.js 已加载');
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: 'PDF 导出功能所需的工具函数未找到，请刷新页面重试' 
                });
                return;
            }

            await window.exportToPdfCommon({
                fileName,
                elements: [capacityModule, aiModule],
                chartCanvasId: 'trendChart'
            });
        }

        /**
         * 导出PDF主函数（带模块选择对话框）
         */
        async function exportPageToPdf() {
            const selectedModule = await showModuleSelectionDialog();
            if (selectedModule) {
                if (selectedModule === 'all') {
                    await exportAllModulesToPdf();
                } else {
                    await exportModuleToPdf(selectedModule);
                }
            }
        }

        document.getElementById('exportPdfBtn')?.addEventListener('click', exportPageToPdf);
        window.addEventListener('load', () => {
            // 预加载PDF导出库（在后台加载，不阻塞页面）
            if (typeof window.loadPdfLibraries === 'function') {
                window.loadPdfLibraries().catch(error => {
                    debugWarn('PDF库预加载失败（不影响使用，导出时会重试）:', error);
                });
            }
            
            // 使用公共模板生成市场数据信息块
            if (typeof window.generateMarketDataInfoBlocks === 'function') {
                const marketDataContainer = document.getElementById('marketDataInfoBlocksContainer');
                if (marketDataContainer) {
                    marketDataContainer.innerHTML = window.generateMarketDataInfoBlocks();
                    }
            }
            
            // 重新获取状态元素引用（模板生成后）
            bunkerStatusEl = document.getElementById('bunkerStatus');
            bunkerUpdatedEl = document.getElementById('bunkerUpdated');
            wciStatusEl = document.getElementById('wciStatus');
            wciUpdatedEl = document.getElementById('wciUpdated');
            fbxStatusEl = document.getElementById('fbxStatus');
            fbxUpdatedEl = document.getElementById('fbxUpdated');
            
            // 使用公共初始化函数（从 vendor/template-utils.js）
            if (typeof window.initMarketAnalysisPage === 'function') {
                window.initMarketAnalysisPage({
                    updateAiAnalysis,
                    fetchBunkerData,
                    fetchWciData,
                    fetchFbxData,
                    bunkerStatusEl,
                    bunkerUpdatedEl,
                    wciStatusEl,
                    fbxStatusEl
                });
                
                // 模板生成后，初始化 AI 模块（绑定标签页切换事件）
                if (typeof window.initAiModule === 'function') {
                    setActiveAiPanelBound = window.initAiModule(aiProviders);
                    // 设置默认激活的提供商
                    if (setActiveAiPanelBound) {
                        setActiveAiPanelBound(activeAiProvider);
                    }
                }
            } else {
                // 降级方案：如果公共函数未加载，使用本地实现
                const container = document.getElementById('bookingDataTableContainer');
                const aiContainer = document.getElementById('aiConfigPanelsContainer');
                
                if (container && typeof window.generateBookingDataTable === 'function') {
                    container.innerHTML = window.generateBookingDataTable();
                }
                if (aiContainer && typeof window.generateAiConfigPanels === 'function') {
                    aiContainer.innerHTML = window.generateAiConfigPanels();
                }
                
                // 初始化 AI 模块
                if (typeof window.initAiModule === 'function') {
                    setActiveAiPanelBound = window.initAiModule(aiProviders);
                    if (setActiveAiPanelBound) {
                        setActiveAiPanelBound(activeAiProvider);
                    }
                }
                
                updateAiAnalysis(false);
                Promise.allSettled([
                    fetchBunkerData(false),
                    fetchWciData(false),
                    fetchFbxData(false)
                ]);
            }
        });

        // 筛选功能在renderTable中已实现
        
        // 窗口大小改变时，重新渲染图表以更新X轴标签（移动端/桌面端切换）
        let resizeTimer = null;
        window.addEventListener('resize', () => {
            if (resizeTimer) clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (capacityChart && latestFilteredRecords && latestFilteredRecords.length > 0) {
                    const hasPortSelection = destinationFilters.originPorts.length > 0 || destinationFilters.destPorts.length > 0;
                    if (hasPortSelection) {
                        const groupedResult = groupRecords(latestFilteredRecords);
                        updateChart(hasPortSelection, groupedResult.data);
                    }
                }
            }, 300); // 防抖，300ms后执行
        });
        
        // 移动端筛选框展开时，确保选项已加载
        window.addEventListener('filterExpanded', (e) => {
            const { containerId, selectId } = e.detail;
            if (containerId === 'destinationFilters') {
                // 检查选项是否已加载
                const originSelect = document.getElementById('originPortSelect');
                const destSelect = document.getElementById('destPortSelect');
                const routeSelect = document.getElementById('routeSelect');
                
                // 如果选项未加载（只有默认选项），重新加载
                if ((originSelect && originSelect.options.length <= 1) || 
                    (destSelect && destSelect.options.length <= 1) || 
                    (routeSelect && routeSelect.options.length <= 1)) {
                    if (processedRecords && processedRecords.length > 0) {
                        updateFilterOptions(processedRecords);
                        // 选项加载完成后，更新移动端显示（移除加载状态，排除iPad横屏宽屏模式）
                        setTimeout(() => {
                            const isLandscape = window.innerWidth > window.innerHeight;
                            const isMobileFilter = window.innerWidth <= 1024 && !(window.innerWidth >= 1024 && isLandscape);
                            if (isMobileFilter && typeof window.updateFilterDisplay === 'function') {
                                const originSelect = document.getElementById('originPortSelect');
                                const destSelect = document.getElementById('destPortSelect');
                                const routeSelect = document.getElementById('routeSelect');
                                if (originSelect) window.updateFilterDisplay(originSelect, false);
                                if (destSelect) window.updateFilterDisplay(destSelect, false);
                                if (routeSelect) window.updateFilterDisplay(routeSelect, false);
                            }
                        }, 100);
                    }
                } else {
                    // 选项已存在，更新移动端显示（移除加载状态）
                    if (typeof window.updateFilterDisplay === 'function') {
                        const originSelect = document.getElementById('originPortSelect');
                        const destSelect = document.getElementById('destPortSelect');
                        const routeSelect = document.getElementById('routeSelect');
                        if (originSelect) window.updateFilterDisplay(originSelect, false);
                        if (destSelect) window.updateFilterDisplay(destSelect, false);
                        if (routeSelect) window.updateFilterDisplay(routeSelect, false);
                    }
                }
            }
        });
    </script>
</body>
</html>
