<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analysis · 市场分析</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/market-analysis-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/ai-config.js"></script>
    <script src="vendor/ai-prompts.js"></script>
    <script src="vendor/ai-utils.js"></script>
    <script src="vendor/market-analysis-utils.js"></script>
    <!-- 页面特定样式：当前无特殊样式，所有样式已在 vendor 文件中定义 -->
</head>
<body data-page="001-04-market-analysis.html">
    <!-- 用户验证模态框 -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>🔐 访问验证</h2>
            <p>为了了解工具使用情况，请填写以下信息</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">姓名 *</label>
                    <input type="text" id="userName" name="userName" placeholder="请输入您的姓名" required autocomplete="name">
                    <div class="auth-error" id="nameError">请输入您的姓名</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">手机号 *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="请输入您的手机号" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">请输入有效的手机号</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">邮箱 *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="请输入您的邮箱地址" required autocomplete="email">
                    <div class="auth-error" id="emailError">请输入有效的邮箱地址</div>
                </div>
                <button type="submit" class="auth-submit-btn">确认并继续</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools001" class="back-home-btn">← 返回首页</a>
            <a href="001-04-market-analysis-README.html" class="readme-btn">使用说明 →</a>
            <h1>Market Analysis · 市场分析</h1>
            <p>一份 Excel 与周报即可联动航线供给与 AI 决策，轻松完成跨板块洞察</p>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls top-controls">
                    <label class="file-btn" title="选择Excel文件：文件需包含 schedule 工作表">
                        选择Excel文件
                        <input id="fileInput" type="file" accept=".xlsx,.xls">
                    </label>
                    <label class="file-btn" title="上传市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析">
                        上传市场周报 (PDF)
                        <input id="marketReportInput" type="file" accept=".pdf" multiple>
                    </label>
                    <button type="button" class="file-btn" id="exportPdfBtn" title="导出包含当前筛选视图与 AI 结论的整页 PDF">
                        导出整页 PDF
                    </button>
                    <span class="file-hint">
                        选择Excel文件：文件需包含 schedule 工作表；
                        上传市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析。
                    </span>
                </div>
                <div class="market-report-upload">
                    <h5>市场周报列表</h5>
                    <ul class="market-report-list" id="marketReportList">
                        <li>尚未上传市场报告</li>
                    </ul>
                </div>
            </div>

            <section id="capacityModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 01</span>
                    <div>
                        <h2 class="section-title">航线运力分析 <span>SAILING SCHEDULE PULSE</span></h2>
                        <p class="module-desc">港口筛选联动运力、派船与趋势，精准锁定当周+未来四周供给</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="capacity">
                    <div class="controls">
                        <div class="view-toggle hidden" id="viewToggle">
                            <label>显示模式：</label>
                            <button id="btnAll" class="active">全部</button>
                            <button id="btnCapacity">运力</button>
                            <button id="btnShips">派船</button>
                        </div>
                    </div>
                    <div id="destinationFilters" class="destination-filters hidden">
                        <div class="filter-group">
                            <label for="portSelect">选择港口</label>
                            <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                            <select id="portSelect" multiple size="6" class="multi-select">
                                <option value="">全部港口</option>
                            </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="portSelectAll">全部选择</button>
                                <button type="button" class="filter-btn" id="portClearAll">清除选择</button>
                            </div>
                        </div>
                    </div>
                    <div id="infoBox" class="info-box hidden">
                        <p id="infoText"></p>
                    </div>
                    <div id="tableContainer" class="table-container hidden">
                        <table id="pivotTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div id="chartContainer" class="chart-container hidden">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                            <h3 style="color:#1f2d3d; font-size:20px; letter-spacing:0.5px;">运力与派船趋势图</h3>
                            <span style="color:#6c757d; font-size:13px;">高度 ×2 展示，便于对比多航线</span>
                        </div>
                        <div id="emptyChartMessage" class="empty-chart-message hidden">
                            请选择港口以查看图表
                        </div>
                        <div class="chart-wrapper hidden" id="chartWrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="aiModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 02</span>
                    <div>
                        <h2 class="section-title">AI 趋势分析 <span>AI TREND ANALYSIS</span></h2>
                        <p class="module-desc">DeepSeek × KIMI × 通义千问 三模型交叉验证航线策略、供需与价格建议</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="ai">
                    <div id="aiAnalysisContainer" class="ai-analysis-container">
                        <div class="ai-header">
                            <h3>AI 船期趋势分析</h3>
                            <p>同一份筛选数据可由多模型并行分析，快速对比观点并交叉验证结论</p>
                        </div>
                        <div id="emptyAiMessage" class="empty-chart-message" style="display: none;">
                            请先加载数据文件并选择筛选条件以启用 AI 分析
                        </div>
                        <div id="aiConfigSection" style="display: none;">
                            <div class="booking-data-table">
                                <h4>其他影响因素</h4>
                                <table class="booking-table" id="bookingDataTable">
                                    <thead>
                                        <tr>
                                            <th>项目</th>
                                            <th class="description-header">说明</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingDataBody">
                                        <tr>
                                            <td><input type="text" value="收货情况" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="当周及未来2周订舱情况；主观判断目前处于旺季或淡季、重点流向表现、装载率预估等"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="码头情况" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="起运港/目的港的拥堵情况、靠泊等待平均时间、天气或其他码头运营影响"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="额外运力" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="具体船公司在某周临时加开/取消/减舱的情况（航线运力分析未覆盖的部分）"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="市场运费" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="填写现行报价，市场上较为激进的高价或低价（如 XX 公司报价表）"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="其他事件" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="如调高关税、出口退税、查验力度、环保政策变化等特殊事件"></textarea>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bunker-info">
                                <div class="bunker-copy">
                                    <h4>燃油行情（Ship & Bunker · 新加坡）</h4>
                                    <p id="bunkerStatus">尚未抓取燃油报价</p>
                                    <small id="bunkerUpdated" class="bunker-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshBunkerBtn">更新燃油价格</button>
                            </div>
                            <div class="index-info">
                                <div>
                                    <h4>WCI 主要航线现货价</h4>
                                    <p id="wciStatus">尚未抓取 WCI 数据</p>
                                    <small id="wciUpdated" class="index-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshWciBtn">更新 WCI</button>
                            </div>
                            <div class="index-info">
                                <div>
                                    <h4>FBX 全球航线指数</h4>
                                    <p id="fbxStatus">尚未抓取 FBX 数据</p>
                                    <small id="fbxUpdated" class="index-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshFbxBtn">更新 FBX</button>
                            </div>
                            <div class="index-info" id="scfiInfoContainer" style="display: none;">
                                <div>
                                    <h4>SCFI 运价指数（来自市场报告）</h4>
                                    <div id="scfiTableContainer"></div>
                                    <small id="scfiSource" class="index-meta">数据来源：—</small>
                                </div>
                            </div>
                            <div class="ai-tabs">
                                <div class="ai-tab-buttons">
                                    <button class="ai-tab-btn active" data-provider="deepseek">DeepSeek</button>
                                    <button class="ai-tab-btn" data-provider="kimi">KIMI (Moonshot)</button>
                                    <button class="ai-tab-btn" data-provider="qwen">通义千问 (Qwen)</button>
                                </div>
                                <span class="ai-tab-hint">可切换不同模型对比观点一致性</span>
                            </div>
                            <div class="ai-panels">
                                <div class="ai-panel active" data-provider="deepseek">
                                    <div class="api-config">
                                        <h4>DeepSeek API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="apiKeyInput" placeholder="请输入 DeepSeek API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="apiUrlInput" placeholder="https://api.deepseek.com/v1/chat/completions" value="https://api.deepseek.com/v1/chat/completions">
                                        </div>
                                            <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="apiModelInput" placeholder="deepseek-chat" value="deepseek-chat" list="deepseekModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('deepseek')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn" id="aiAnalysisBtn" onclick="runAiAnalysis('deepseek')">使用 DeepSeek 分析</button>
                                    <div id="aiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="aiResult" class="ai-result hidden">
                                        <h4>DeepSeek 分析结果</h4>
                                        <div class="ai-result-content" id="aiResultContent"></div>
                                    </div>
                                </div>
                                <div class="ai-panel" data-provider="kimi">
                                    <div class="api-config">
                                        <h4>KIMI (Moonshot) API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="kimiApiKeyInput" placeholder="请输入 KIMI / Moonshot API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="kimiApiUrlInput" placeholder="https://api.moonshot.cn/v1/chat/completions" value="https://api.moonshot.cn/v1/chat/completions">
                                        </div>
                                        <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="kimiModelInput" placeholder="moonshot-v1-32k" value="moonshot-v1-32k" list="kimiModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('kimi')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn secondary" id="kimiAnalysisBtn" onclick="runAiAnalysis('kimi')">使用 KIMI 分析</button>
                                    <div id="kimiAiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="kimiAiResult" class="ai-result hidden">
                                        <h4>KIMI 分析结果</h4>
                                        <div class="ai-result-content" id="kimiAiResultContent"></div>
                                    </div>
                                </div>
                                <div class="ai-panel" data-provider="qwen">
                                    <div class="api-config">
                                        <h4>通义千问 (Qwen) API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="qwenApiKeyInput" placeholder="请输入通义千问 API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="qwenApiUrlInput" placeholder="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" value="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions">
                                        </div>
                                        <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="qwenModelInput" placeholder="qwen-max" value="qwen-max" list="qwenModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('qwen')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn" id="qwenAnalysisBtn" onclick="runAiAnalysis('qwen')" style="background: #ff6b35;">使用通义千问分析</button>
                                    <div id="qwenAiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="qwenAiResult" class="ai-result hidden">
                                        <h4>通义千问 分析结果</h4>
                                        <div class="ai-result-content" id="qwenAiResultContent"></div>
                                    </div>
                                </div>
                            </div>
                            <datalist id="deepseekModelOptions">
                                <option value="deepseek-chat">基础对话模型（推荐）</option>
                                <option value="deepseek-v3">V3 高性能模型（2024年12月发布）</option>
                                <option value="deepseek-reasoner">推理模型（逻辑推理）</option>
                                <option value="deepseek-r1">R1 推理模型（2025年1月发布）</option>
                                <option value="deepseek-coder">代码模型</option>
                            </datalist>
                            <datalist id="kimiModelOptions">
                                <option value="moonshot-v1-8k">8K 上下文（经济型）</option>
                                <option value="moonshot-v1-32k">32K 上下文（推荐）</option>
                                <option value="moonshot-v1-128k">128K 上下文（长文档）</option>
                                <option value="moonshot-v1-k2">K2 模型（320亿参数，需确认API可用性）</option>
                            </datalist>
                            <datalist id="qwenModelOptions">
                                <option value="qwen-turbo">Turbo 快速模型（经济型）</option>
                                <option value="qwen-plus">Plus 平衡模型</option>
                                <option value="qwen-max">Max 高性能模型（推荐，最佳性能）</option>
                                <option value="qwen-max-longcontext">Max 长上下文模型</option>
                            </datalist>
                        </div>
    </div>
    </div>
    <div class="page-footer">
        <h2>Market Analysis · 市场分析使用声明</h2>
        <p>资料整合自用户 Excel、用户上传市场周报、Ship & Bunker、上海航运交易所、Drewry、Freightos 等公开渠道，仅供内部研判，不构成对外报价或投资建议。</p>
        <p>AI 服务由 DeepSeek / KIMI / 通义千问 API 驱动，所有调用费用与合规责任由使用者自担，涉及客户或敏感数据时请先完成脱敏处理。</p>
    </div>
    <!-- 使用 Gist 存储系统（用户白名单 + 访问记录） -->
    <script src="vendor/auth-gist.js"></script>
    <script>

        // ==================== 调试模式 ====================
        // 调试函数已统一到 vendor/debug-utils.js
        // 使用：debugLog(), debugWarn(), debugError()

        // ==================== 错误处理 ====================
        // 错误处理已统一到 vendor/error-handler.js
        // 使用：showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED')
        // ErrorType 和 showError 函数已从 error-handler.js 加载

        let pdfJsReady = false;
        let pdfJsLoadingPromise = null;

        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            // 优先使用本地 worker，失败时使用 CDN
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'vendor/pdf.worker.min.js';
            } catch (e) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            pdfJsReady = true;
        }

        const loadedScripts = new Set();
        const loadedWorkers = new Map();

        // loadScript, loadWorkerAsBlob, ensurePdfJsLoaded 已从 vendor/market-analysis-utils.js 加载

        let marketReports = [];
        let bunkerData = null;
        let wciData = null;
        let fbxData = null;
        let scfiData = null;
        const excelLoadState = { schedule: false };
        let modulesVisible = false;

        const fileInput = document.getElementById('fileInput');
        const marketReportInput = document.getElementById('marketReportInput');
        const marketReportList = document.getElementById('marketReportList');
        const bunkerStatusEl = document.getElementById('bunkerStatus');
        const bunkerUpdatedEl = document.getElementById('bunkerUpdated');
        const refreshBunkerBtn = document.getElementById('refreshBunkerBtn');
        const wciStatusEl = document.getElementById('wciStatus');
        const wciUpdatedEl = document.getElementById('wciUpdated');
        const refreshWciBtn = document.getElementById('refreshWciBtn');
        const fbxStatusEl = document.getElementById('fbxStatus');
        const fbxUpdatedEl = document.getElementById('fbxUpdated');
        const refreshFbxBtn = document.getElementById('refreshFbxBtn');

        // renderMarketReportList 已从 vendor/market-analysis-utils.js 加载
        renderMarketReportList();
        function tryRevealModules() {
            if (modulesVisible) return;
            if (excelLoadState.schedule) {
                // 只显示筛选控件，模块标题始终显示
                const destinationFiltersPanel = document.getElementById('destinationFilters');
                if (destinationFiltersPanel) destinationFiltersPanel.classList.remove('hidden');
                
                const viewToggle = document.getElementById('viewToggle');
                if (viewToggle) viewToggle.classList.remove('hidden');

                document.querySelectorAll('.module-card').forEach(card => {
                    card.classList.remove('hidden');
                });
                
                modulesVisible = true;
            }
        }

        refreshBunkerBtn?.addEventListener('click', () => {
            fetchBunkerData(true).catch(error => {
                debugWarn('燃油行情抓取失败', error);
                bunkerStatusEl && (bunkerStatusEl.textContent = '抓取失败，请稍后重试或检查网络');
                bunkerUpdatedEl && (bunkerUpdatedEl.textContent = '最近更新时间：—');
            });
        });
        refreshWciBtn?.addEventListener('click', () => {
            fetchWciData(true).catch(error => {
                debugWarn('WCI 抓取失败', error);
                if (wciStatusEl) wciStatusEl.textContent = '抓取失败，请稍后重试';
            });
        });
        refreshFbxBtn?.addEventListener('click', () => {
            fetchFbxData(true).catch(error => {
                debugWarn('FBX 抓取失败', error);
                if (fbxStatusEl) fbxStatusEl.textContent = '抓取失败，请稍后重试';
            });
        });

        const CACHE_KEYS = {
            wci: 'wciDataCache',
            fbx: 'fbxDataCache'
        };

        // escapeRegex, computePercentChange, formatPercent, loadCachedData, saveCachedData 已从 vendor/common-utils.js 加载
        // applyWoWFromCache, extractTextFromPdf, handleMarketReportFile, parseScfiTable, buildScfiDataSection 已从 vendor/market-analysis-utils.js 加载

        // 注册 SCFI 数据提取回调
        window.onScfiDataExtracted = (data, fileName) => {
            scfiData = data;
            renderScfiTable(data, fileName);
        };

        if (marketReportInput) {
            marketReportInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                if (marketReportList) {
                    marketReportList.innerHTML = '<li>正在解析上传的报告...</li>';
                }
                for (const file of files) {
                    try {
                        await handleMarketReportFile(file);
                        // 检查是否提取到 SCFI 数据
                        const latestReport = marketReports[marketReports.length - 1];
                        if (latestReport) {
                            debugLog('市场报告解析完成:', {
                                name: latestReport.name,
                                hasScfiData: !!latestReport.scfiData,
                                scfiData: latestReport.scfiData
                            });
                            if (latestReport.scfiData) {
                                scfiData = latestReport.scfiData;
                                renderScfiTable(latestReport.scfiData, file.name);
                            } else {
                                debugWarn('未找到 SCFI 数据，尝试手动提取...');
                                // 如果自动提取失败，尝试手动从全文提取
                                try {
                                    const fullText = latestReport.text;
                                    if (fullText) {
                                        const extractedScfi = parseScfiTable(fullText);
                                        if (extractedScfi) {
                                            debugLog('手动提取 SCFI 数据成功:', extractedScfi);
                                            scfiData = extractedScfi;
                                            latestReport.scfiData = extractedScfi;
                                            renderScfiTable(extractedScfi, file.name);
                                        } else {
                                            debugWarn('手动提取也失败，文本内容:', fullText.substring(0, 500));
                                        }
                                    }
                                } catch (extractError) {
                                    debugError('手动提取 SCFI 失败:', extractError);
                                }
                            }
                        }
                    } catch (error) {
                        debugError('解析PDF失败:', error);
                        showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', { message: error.message || String(error) }, error);
                    }
                }
                renderMarketReportList();
                marketReportInput.value = '';
            });
        }

        /**
         * 渲染 SCFI 表格
         * @param {Object} data - SCFI 数据
         * @param {string} source - 数据来源文件名
         */
        function renderScfiTable(data, source) {
            const container = document.getElementById('scfiTableContainer');
            const sourceEl = document.getElementById('scfiSource');
            const infoContainer = document.getElementById('scfiInfoContainer');
            
            if (!container || !infoContainer) {
                debugWarn('SCFI 表格容器未找到');
                return;
            }
            
            debugLog('渲染 SCFI 表格，数据:', data);
            
            if (!data || (!data.index && (!data.routes || data.routes.length === 0))) {
                debugWarn('SCFI 数据为空，隐藏表格');
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            let html = '<table class="scfi-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; table-layout: fixed;">';
            
            // 表头
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; text-align: left; border: 1px solid #ddd; width: 15%;">航线</th>';
            html += '<th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 5%;">单位</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">当期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年对比%</th>';
            html += '</tr>';
            
            // SCFI 综合指数行（作为第一行数据，在表头下面）
            if (data.index) {
                const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                const formatPercent = (val) => {
                    if (val === null || val === undefined) return '—';
                    const sign = val >= 0 ? '+' : '';
                    return sign + val.toFixed(1) + '%';
                };
                
                html += '<tr style="background: #f9f9f9; font-weight: bold;">';
                html += '<td style="padding: 8px; border: 1px solid #ddd;">SCFI 综合指数</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">—</td>'; // 单位列
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.index) + '</td>';
                // 上期指数 = 1周指数 (indexWeek1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexWeek1) + '</td>';
                // 上期对比% = 1周变化% (indexWeek1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexWeek1Change) + '</td>';
                // 上月指数 = 1个月指数 (indexMonth1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexMonth1) + '</td>';
                // 上月对比% = 1个月变化% (indexMonth1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexMonth1Change) + '</td>';
                // 上季度指数 = 3个月指数 (indexQuarter3)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexQuarter3) + '</td>';
                // 上季度对比% = 3个月变化% (indexQuarter3Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexQuarter3Change) + '</td>';
                // 上年指数 = 1年指数 (indexYear1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexYear1) + '</td>';
                // 上年对比% = 1年变化% (indexYear1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexYear1Change) + '</td>';
                html += '</tr>';
            }
            
            if (data.routes && data.routes.length > 0) {
                // 数据行
                data.routes.forEach(route => {
                    const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                    const formatPercent = (val) => {
                        if (val === null || val === undefined) return '—';
                        const sign = val >= 0 ? '+' : '';
                        return sign + val.toFixed(1) + '%';
                    };
                    
                    // 检查是否是India/East Africa/Central America，这些航线没有上年数据
                    const routeNameLower = (route.name || '').toLowerCase();
                    const hasNoYearData = routeNameLower.includes('india') || 
                                         routeNameLower.includes('nhava sheva') ||
                                         routeNameLower.includes('east africa') ||
                                         routeNameLower.includes('mombasa') ||
                                         routeNameLower.includes('central america') ||
                                         routeNameLower.includes('manzanillo');
                    
                    html += '<tr>';
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd;">${route.name}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">${route.unit || '—'}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.current)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.week1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.week1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.month1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.month1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.quarter3Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.quarter3Change)}</td>`;
                    // 如果是India/East Africa/Central America，上年数据显示为"—"
                    if (hasNoYearData) {
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                    } else {
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.year1Price)}</td>`;
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.year1Change)}</td>`;
                    }
                    html += '</tr>';
                });
            }
            
            html += '</table>';
            container.innerHTML = html;
            
            if (sourceEl) {
                sourceEl.textContent = `数据来源：${source}`;
            }
        }

    </script>

    <script>
        let scheduleData = [];
        let processedRecords = [];
        let groupedTableData = [];
        let latestFilteredRecords = [];
        let availablePorts = [];
        let destinationFilters = {
            ports: []
        };
        let currentView = 'all'; // 'all', 'capacity', 'ships'
        let weekColumns = []; // 5周的周别
        let capacityChart = null; // Chart.js实例
        let routeFilterValue = '';
        let routeLabelMap = {};

        const infoBox = document.getElementById('infoBox');
        const infoText = document.getElementById('infoText');
        const tableContainer = document.getElementById('tableContainer');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const viewToggle = document.getElementById('viewToggle');
        const btnAll = document.getElementById('btnAll');
        const btnCapacity = document.getElementById('btnCapacity');
        const btnShips = document.getElementById('btnShips');
        const destinationFiltersPanel = document.getElementById('destinationFilters');
        const portSelect = document.getElementById('portSelect');
        const portSelectAllBtn = document.getElementById('portSelectAll');
        const portClearAllBtn = document.getElementById('portClearAll');

        // getSelectedValues 和 setupMultiSelect 已从 vendor/common-utils.js 加载

        // normalizeDestinationValue, populateSelect, registerRouteLabel, getRouteLabel 已从 vendor/market-analysis-utils.js 加载

        // STANDARD_PORT_ORDER 已从 vendor/market-analysis-utils.js 加载

        function refreshAvailablePorts() {
            const portSet = new Set();
            processedRecords.forEach(record => {
                const port = record.port || '';
                if (port && port !== '未分配' && port.trim()) {
                    portSet.add(port);
                }
            });
            const ports = Array.from(portSet);
            // 使用标准港口顺序排序（严格按照 STANDARD_PORT_ORDER 的顺序）
            if (typeof sortPortsByStandardOrder === 'function') {
                availablePorts = sortPortsByStandardOrder(ports);
            } else if (typeof STANDARD_PORT_ORDER !== 'undefined') {
                // 如果 sortPortsByStandardOrder 不可用，手动排序
                const portOrderMap = new Map();
                STANDARD_PORT_ORDER.forEach((port, index) => {
                    portOrderMap.set(port, index);
                });
                availablePorts = ports.sort((a, b) => {
                    const indexA = portOrderMap.has(a) ? portOrderMap.get(a) : Infinity;
                    const indexB = portOrderMap.has(b) ? portOrderMap.get(b) : Infinity;
                    if (indexA !== Infinity && indexB !== Infinity) {
                        return indexA - indexB;
                    }
                    if (indexA !== Infinity) return -1;
                    if (indexB !== Infinity) return 1;
                    return a.localeCompare(b, 'zh-Hans-CN');
                });
            } else {
                availablePorts = ports.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            }
        }

        function updatePortFilterOptions() {
            refreshAvailablePorts();
            // availablePorts 已经在 refreshAvailablePorts 中排序过了，这里不需要再次排序
            // 但为了确保顺序正确，仍然传入 usePortOrder=true
            populateSelect(
                portSelect,
                availablePorts,
                '全部港口',
                destinationFilters.ports,
                availablePorts.length === 0,
                true  // 使用标准港口顺序
            );
        }

        function getCurrentGroupLevel() {
            return destinationFilters.ports.length > 0 ? 1 : 0;
        }

        function getFilteredRecords() {
            const routeFilterText = routeFilterValue.trim().toLowerCase();
            const filtered = processedRecords.filter(record => {
                if (destinationFilters.ports.length && !destinationFilters.ports.includes(record.port)) return false;
                if (routeFilterText) {
                    const routeText = String(record.routeLabel || record.route || '').toLowerCase();
                    if (!routeText.includes(routeFilterText)) return false;
                }
                return true;
            });
            // 统一去重（使用 vendor 中的标准函数）
            if (typeof deduplicateSailingItems === 'function') {
                return deduplicateSailingItems(filtered);
            }
            return filtered;
        }

        // buildShipSignature 已从 vendor/market-analysis-utils.js 加载

        // buildDedupKey 已不再用于去重（改用 deduplicateSailingItems）

        function groupRecords(records, groupByPort = false) {
            const groups = new Map();

            records.forEach(record => {
                const port = record.port || '未分配';
                const routeLabel = record.routeLabel || record.route || '未知航线';
                const routeKey = record.routeId || routeLabel;
                const routeRemark = record.routeRemark || '';
                // 如果 groupByPort 为 true，按港口+航线分组；否则只按航线分组（合并不同港口）
                const key = groupByPort ? `${port}|${routeKey}` : routeKey;

                if (!groups.has(key)) {
                    groups.set(key, {
                        port: groupByPort ? port : '', // 如果不按港口分组，port 设为空字符串
                        routeLabel,
                        routeId: record.routeId || '',
                        routeRemark,
                        weeks: {}
                    });
                }

                const group = groups.get(key);
                if (!group.weeks[record.weekCode]) {
                    group.weeks[record.weekCode] = [];
                }

                const entries = group.weeks[record.weekCode];
                // 如果不按港口分组，去重时只考虑船名航次+运力+日期，不考虑港口
                // 如果按港口分组，去重时考虑港口+船名航次+运力+日期
                const dedupKey = groupByPort ? buildDedupKey(record) : buildShipSignature(record);
                const exists = entries.some(item => {
                    // 统一使用 dedupKey 进行比较，确保日期格式一致
                    // buildShipSignature 已经统一格式化了日期为 YYYY/MM/DD
                    return item.dedupKey === dedupKey;
                });
                if (exists) {
                    return;
                }
                entries.push({
                    capacity: record.capacity,
                    shipName: record.shipName,
                    shipDate: record.shipDate,
                    routeId: record.routeId || '',
                    dedupKey: dedupKey
                });
            });

            const sorted = Array.from(groups.values()).sort((a, b) => {
                // 如果按港口分组，先按港口排序；否则只按航线排序
                if (groupByPort && (a.port || '') !== (b.port || '')) {
                    return (a.port || '').localeCompare(b.port || '');
                }
                return (a.routeLabel || '').localeCompare(b.routeLabel || '');
            });

            return {
                data: sorted
            };
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // 检查 XLSX 是否已加载
            if (typeof XLSX === 'undefined') {
                showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                return;
            }

            try {
                const data = await readExcelFile(file);
                scheduleData = data;
                generatePivotTable(data);
                infoText.textContent = `已加载 ${data.length} 条船期数据`;
                infoBox.classList.remove('hidden');
                excelLoadState.schedule = true;
                tryRevealModules();
            } catch (error) {
                showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                debugError(error);
            }
        });

        btnAll.addEventListener('click', () => {
            currentView = 'all';
            btnAll.classList.add('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnCapacity.addEventListener('click', () => {
            currentView = 'capacity';
            btnAll.classList.remove('active');
            btnCapacity.classList.add('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnShips.addEventListener('click', () => {
            currentView = 'ships';
            btnAll.classList.remove('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.add('active');
            renderTable();
        });

        if (portSelect) {
            setupMultiSelect(portSelect);
            portSelect.addEventListener('change', () => {
                destinationFilters.ports = getSelectedValues(portSelect);
                renderTable();
            });
        }
        if (portSelectAllBtn && portClearAllBtn && portSelect) {
            portSelectAllBtn.addEventListener('click', () => selectAllOptions(portSelect));
            portClearAllBtn.addEventListener('click', () => clearSelectOptions(portSelect));
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX 库未加载，请刷新页面重试'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false });
                        
                        // 查找 schedule 工作表
                        const sheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('schedule')
                        ) || workbook.SheetNames[0];
                        
                        const worksheet = workbook.Sheets[sheetName];
                        // 使用 raw: true 保留原始类型（Date对象、数字等），以便正确解析M列的日期数据
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: null, dateNF: 'yyyy/mm/dd' });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // 将周别文本转换为YYYYWW格式（如：202547）
        // parseWeekText, getCurrentWeekCode, getWeekRange, getWeekNumber, getISOWeek, getWeekDateRange 已从 vendor/market-analysis-utils.js 加载


        function generatePivotTable(data) {
            if (!data || data.length === 0) {
                showError(ErrorType.DATA_VALIDATION, 'DATA_EMPTY');
                return;
            }

            const firstRow = data[0];
            const columnKeys = Object.keys(firstRow);

            const matchesKeyword = (key, keyword) => {
                if (!key) return false;
                const lowerKey = key.toLowerCase();
                return lowerKey.includes(keyword.toLowerCase()) || key.includes(keyword);
            };

            const columnLetterToIndex = (letter) => {
                if (!letter) return null;
                let index = 0;
                const up = letter.trim().toUpperCase();
                for (let i = 0; i < up.length; i++) {
                    const charCode = up.charCodeAt(i);
                    if (charCode < 65 || charCode > 90) return null;
                    index = index * 26 + (charCode - 64);
                }
                return index - 1;
            };

            const getColumnKey = (keywords, fallbackLetter = null) => {
                const key = columnKeys.find(col =>
                    keywords.some(keyword => matchesKeyword(col, keyword))
                );
                if (key) return key;
                if (fallbackLetter) {
                    const idx = columnLetterToIndex(fallbackLetter);
                    if (idx !== null && columnKeys[idx]) {
                        return columnKeys[idx];
                    }
                }
                return null;
            };

            const weekCol = getColumnKey(['周别', '周次', '周数', 'week'], 'R');
            const capacityCol = getColumnKey(['运力', 'teu', '舱位'], 'L');
            // 强制使用 K 列（索引10）作为船名航次列
            // 先通过索引获取，确保使用正确的列
            const kIndex = columnLetterToIndex('K'); // K列 = 索引10
            const shipNameCol = (kIndex !== null && columnKeys[kIndex]) ? columnKeys[kIndex] : getColumnKey(['船名', '航次', 'vessel'], 'K');
            // 强制使用 M 列（索引12）作为开船日期列
            // 先通过索引获取，确保使用正确的列
            const mIndex = columnLetterToIndex('M'); // M列 = 索引12
            const shipDateCol = (mIndex !== null && columnKeys[mIndex]) ? columnKeys[mIndex] : getColumnKey(['开船', '船期', '离港', 'etd', '时间'], 'M');
            const routeIdCol = getColumnKey(['航线id', '航线ID', 'route id', 'group_id', 'groupid'], 'C');
            const routeCol = getColumnKey(['共舱船公司', '共舱', '舱公司', '船公司'], 'G');
            const portCol = getColumnKey(['港口', '目的港', 'pod'], 'B');
            const routeRemarkCol = columnKeys[7] || null; // H列（索引7）

            if (!weekCol || !capacityCol || !shipNameCol || !shipDateCol || !routeCol || !portCol) {
                showError(ErrorType.FILE_PARSE, 'MISSING_COLUMNS', { columns: columnKeys.join(', ') });
                return;
            }

            // 固定显示当周+未来4周（共5周）
            const weekCodes = getWeekRange();
            weekColumns = weekCodes.map(code => {
                const year = code.substring(0, 4);
                const weekNo = parseInt(code.substring(4), 10);
                const dateRange = getWeekDateRange(code);
                return {
                    code,
                    label: `${year}/${String(weekNo).padStart(2, '0')}`,
                    range: dateRange.range
                };
            });

            processedRecords = [];
            destinationFilters = { ports: [] };
            routeFilterValue = '';
            routeLabelMap = {};

            data.forEach(row => {
                const weekText = String(row[weekCol] ?? '').trim();
                const weekCode = parseWeekText(weekText);
                if (!weekCode || !weekCodes.includes(weekCode)) {
                    return;
                }

                // 使用 normalizePortName 进行港口名称匹配（与 Monitor-Sailing-Schedule 保持一致）
                const rawPort = row[portCol];
                const port = (typeof normalizePortName === 'function')
                    ? normalizePortName(rawPort ? String(rawPort).trim() : '')
                    : normalizeDestinationValue(rawPort);
                let route = String(row[routeCol] ?? '').trim();
                const routeId = routeIdCol ? String(row[routeIdCol] ?? '').trim() : '';
                const routeRemark = routeRemarkCol ? String(row[routeRemarkCol] ?? '').trim() : '';
                const capacity = parseFloat(row[capacityCol]) || 0;
                const shipName = String(row[shipNameCol] ?? '').trim();
                // 保留原始值，可能是数字（Excel日期序列号）、Date对象或字符串
                let shipDate = row[shipDateCol];
                // 如果是 null 或 undefined，设置为空字符串
                if (shipDate === null || shipDate === undefined) {
                    shipDate = '';
                }
                // 如果是空字符串，保持为空字符串
                // 注意：不要在这里转换为字符串，保留原始类型以便后续解析

                if (!route) {
                    route = '未知航线';
                }

                if (routeId) {
                    if (route && route !== '未知航线') {
                        registerRouteLabel(routeId, route);
                    }
                    route = getRouteLabel(routeId, route);
                }

                const record = {
                    port,
                    route,
                    routeId,
                    routeRemark,
                    weekCode,
                    capacity,
                    shipName,
                    shipDate
                };
                processedRecords.push(record);
            });

            processedRecords = processedRecords.map(record => ({
                ...record,
                routeLabel: getRouteLabel(record.routeId, record.route)
            }));
            if (processedRecords.length === 0) {
                showError(ErrorType.FILE_PARSE, 'NO_SCHEDULE_DATA');
                return;
            }

            updatePortFilterOptions();
            renderTable();
            updateAiAnalysis(false);
        }

        function renderTable() {
            if (!processedRecords.length) {
                tableContainer.classList.add('hidden');
                updateChart(false, []);
                updateAiAnalysis(false);
                return;
            }

            const filteredRecords = getFilteredRecords();
            latestFilteredRecords = filteredRecords;
            // 无论是否选择港口，都按航线分组（合并不同港口），这样同一船名航次在不同港口时不会重复统计
            const hasPortSelection = destinationFilters.ports.length > 0;
            const groupedResult = groupRecords(filteredRecords, false); // 始终不按港口分组，合并相同航线
            const groupedData = groupedResult.data;
            groupedTableData = groupedData;

            const safeRouteValue = (routeFilterValue || '').replace(/"/g, '&quot;');

            tableHead.innerHTML = `
                <tr>
                    <th class="filter-header" style="width: 200px;">航线备注</th>
                    <th class="filter-header">
                        共舱船公司
                        <input type="text" class="filter-input" id="routeFilter" placeholder="筛选共舱船公司..." value="${safeRouteValue}" autocomplete="off">
                    </th>
                    ${weekColumns.map(week => `
                        <th class="week-header week-cell">
                            <div>${week.label}</div>
                            ${week.range ? `<div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">(${week.range})</div>` : ''}
                        </th>
                    `).join('')}
                </tr>
            `;

            const routeFilter = document.getElementById('routeFilter');
            if (routeFilter) {
                let composing = false;
                const newRouteFilter = routeFilter.cloneNode(true);
                routeFilter.parentNode.replaceChild(newRouteFilter, routeFilter);
                newRouteFilter.addEventListener('compositionstart', function() {
                    composing = true;
                });
                newRouteFilter.addEventListener('compositionend', function() {
                    composing = false;
                    routeFilterValue = this.value;
                    setTimeout(() => {
                        renderTable();
                    }, 0);
                });
                newRouteFilter.addEventListener('input', function() {
                    if (!composing) {
                        routeFilterValue = this.value;
                        clearTimeout(newRouteFilter._inputTimeout);
                        newRouteFilter._inputTimeout = setTimeout(() => {
                            renderTable();
                        }, 300);
                    }
                });
            }

            tableBody.innerHTML = '';
            groupedData.forEach(item => {
                const row = document.createElement('tr');
                const cells = [
                    `<td>${item.routeRemark || '—'}</td>`,
                    `<td>${item.routeLabel || '未知航线'}</td>`
                ];

                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    
                    // 计算该周的运力和派船数
                    const totalCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    const shipCount = ships.length;
                    
                    // 构建tooltip内容（船名航次、运力和开船日期）
                    let tooltipData = '';
                    if (ships.length > 0) {
                        const shipDetails = ships.map(ship => {
                            const name = ship.shipName || '未知';
                            const capacity = ship.capacity || 0;
                            let date = ship.shipDate;
                            
                            // 格式化日期为 YYYY/MM/DD（M列数据）
                            // 使用统一的日期解析和格式化函数
                            let formattedDate = '';
                            if (date !== null && date !== undefined && date !== '') {
                                formattedDate = formatDateToYYYYMMDD(date);
                                // 如果格式化失败，尝试直接使用原值
                                if (!formattedDate || formattedDate === '未知') {
                                    formattedDate = String(date);
                                }
                            } else {
                                formattedDate = '—';
                            }
                            
                            // 格式：船名航次（K列）+ xx TEU（L列）+ (开航时间)（M列，格式：YYYY/MM/DD）
                            const capacityStr = capacity > 0 ? `${capacity.toLocaleString()} TEU` : '0 TEU';
                            // 确保格式为：船名航次 + 运力TEU + (YYYY/MM/DD)
                            return `${name} ${capacityStr} (${formattedDate})`;
                        }).join('\n');
                        tooltipData = shipDetails;
                    }
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${shipCount}`;
                    } else if (currentView === 'capacity') {
                        cellContent = totalCapacity.toLocaleString() + ' TEU';
                    } else if (currentView === 'ships') {
                        cellContent = shipCount.toString();
                    }
                    
                    // 如果有数据，添加tooltip和悬停样式
                    const cellClass = ships.length > 0 ? 'number-cell hover-cell' : 'number-cell';
                    const tooltipAttr = tooltipData ? `data-tooltip="${tooltipData.replace(/"/g, '&quot;')}"` : '';
                    cells.push(`<td class="${cellClass}" ${tooltipAttr}>${cellContent}</td>`);
                });

                row.innerHTML = cells.join('');
                tableBody.appendChild(row);
            });
            
            const hasDestinationSelection = Boolean(
                destinationFilters.ports.length ||
                routeFilterValue.trim()
            );

            if (hasDestinationSelection && groupedData.length > 0) {
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'summary-row';
                const summaryCells = [
                    '<td><strong>合计</strong></td>',
                    '<td></td>'
                ];

                let totalCapacityByWeek = {};
                let totalShipsByWeek = {};
                
                // 计算每周的合计
                groupedData.forEach(item => {
                    weekColumns.forEach((week) => {
                        const weekCode = week.code;
                        const ships = item.weeks[weekCode] || [];
                        const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                        const weekShips = ships.length;
                        
                        if (!totalCapacityByWeek[weekCode]) {
                            totalCapacityByWeek[weekCode] = 0;
                            totalShipsByWeek[weekCode] = 0;
                        }
                        totalCapacityByWeek[weekCode] += weekCapacity;
                        totalShipsByWeek[weekCode] += weekShips;
                    });
                });
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const totalCapacity = totalCapacityByWeek[weekCode] || 0;
                    const totalShips = totalShipsByWeek[weekCode] || 0;
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${totalShips}`;
                    } else if (currentView === 'capacity') {
                        cellContent = `${totalCapacity.toLocaleString()} TEU`;
                    } else if (currentView === 'ships') {
                        cellContent = `${totalShips}`;
                    }
                    
                    summaryCells.push(`<td class="number-cell"><strong>${cellContent}</strong></td>`);
                });
                
                summaryRow.innerHTML = summaryCells.join('');
                tableBody.appendChild(summaryRow);
            }

            // 添加tooltip事件监听
            const hoverCells = tableBody.querySelectorAll('.hover-cell');
            hoverCells.forEach(cell => {
                const tooltipText = cell.getAttribute('data-tooltip');
                if (!tooltipText) return;
                
                let tooltip = null;
                
                cell.addEventListener('mouseenter', (e) => {
                    tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.style.display = 'block';
                    // 对于船期信息，直接显示完整文本，使用 pre-wrap 保持格式
                    const displayText = tooltipText;
                    const span = document.createElement('span');
                    span.className = 'tooltip-line';
                    span.textContent = displayText;
                    span.style.whiteSpace = 'pre-wrap';
                    tooltip.appendChild(span);
                    document.body.appendChild(tooltip);
                    
                    // 使用鼠标位置来定位tooltip，这样滚动时也能正确显示
                    const updateTooltipPosition = (event) => {
                        if (!tooltip || !tooltip.parentNode) return;
                        
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;
                        // 使用 getBoundingClientRect 获取更准确的尺寸
                        const rect = tooltip.getBoundingClientRect();
                        const tooltipWidth = rect.width || tooltip.offsetWidth;
                        const tooltipHeight = rect.height || tooltip.offsetHeight;
                        const padding = 10;
                        
                        // 默认显示在鼠标右下方
                        let tooltipX = mouseX + padding;
                        let tooltipY = mouseY + padding;
                        
                        // 如果右侧空间不够，显示在左侧
                        if (tooltipX + tooltipWidth > window.innerWidth) {
                            tooltipX = mouseX - tooltipWidth - padding;
                        }
                        
                        // 如果左侧也不够，居中显示
                        if (tooltipX < 0) {
                            tooltipX = (window.innerWidth - tooltipWidth) / 2;
                        }
                        
                        // 如果下方空间不够，显示在上方
                        if (tooltipY + tooltipHeight > window.innerHeight) {
                            tooltipY = mouseY - tooltipHeight - padding;
                        }
                        
                        // 如果上方也不够，显示在鼠标位置
                        if (tooltipY < 0) {
                            tooltipY = mouseY + padding;
                        }
                        
                        tooltip.style.left = tooltipX + 'px';
                        tooltip.style.top = tooltipY + 'px';
                    };
                    
                    // 初始定位 - 使用 requestAnimationFrame 确保 DOM 已更新
                    requestAnimationFrame(() => {
                        updateTooltipPosition(e);
                    });
                    
                    // 鼠标移动时更新位置
                    cell.addEventListener('mousemove', updateTooltipPosition);
                    cell._tooltipMoveHandler = updateTooltipPosition;
                });
                
                cell.addEventListener('mouseleave', () => {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                    // 移除mousemove事件监听
                    if (cell._tooltipMoveHandler) {
                        cell.removeEventListener('mousemove', cell._tooltipMoveHandler);
                        cell._tooltipMoveHandler = null;
                    }
                });
            });

            if (infoText) {
                const totalCombos = groupedData.length;
                const totalRecords = filteredRecords.length;
                const portText = destinationFilters.ports.length ? destinationFilters.ports.join('、') : '全部港口';
                infoText.textContent = `已加载 ${totalRecords} 条记录，组合 ${totalCombos} 行；筛选港口：${portText}`;
            }

            tableContainer.classList.remove('hidden');
            
            // 更新图表
            updateChart(hasPortSelection, groupedData);
            
            // 更新AI分析区域
            updateAiAnalysis(hasPortSelection);
        }
        
        function updateChart(hasPortSelection, groupedData) {
            const chartContainer = document.getElementById('chartContainer');
            const chartWrapper = document.getElementById('chartWrapper');
            const emptyChartMessage = document.getElementById('emptyChartMessage');
            
            chartContainer.classList.remove('hidden');
            
            if (!hasPortSelection || groupedData.length === 0) {
                chartWrapper.classList.add('hidden');
                emptyChartMessage.classList.remove('hidden');
                if (capacityChart) {
                    capacityChart.destroy();
                    capacityChart = null;
                }
                return;
            }
            
            emptyChartMessage.classList.add('hidden');
            chartWrapper.classList.remove('hidden');
            
            const weekCodes = weekColumns.map(week => week.code);
            const weekLabels = weekColumns.map(week => {
                const range = week.range ? ` (${week.range})` : '';
                return `${week.label}${range}`;
            });
            
            // 准备数据
            const shipData = []; // 每周的总派船数（用于折线图）
            const datasets = [];
            const podRoutePairs = [];
            
            // 收集所有航线备注+共舱船公司组合
            groupedData.forEach(item => {
                const routeLabel = item.routeLabel || '未知航线';
                const routeRemark = item.routeRemark || '—';
                podRoutePairs.push({
                    label: `${routeRemark} - ${routeLabel}`,
                    routeLabel: routeLabel,
                    routeId: item.routeId || '',
                    routeRemark: routeRemark
                });
            });
            
            // 为每个目的港+航线组合创建运力数据集
            podRoutePairs.forEach((pair, index) => {
                const item = groupedData[index];
                const capacityValues = [];
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    capacityValues.push(weekCapacity);
                });
                
                // 生成颜色
                const hue = (index * 137.508) % 360; // 使用黄金角度分布颜色
                const color = `hsl(${hue}, 70%, 50%)`;
                
                datasets.push({
                    label: pair.label,
                    data: capacityValues,
                    type: 'bar',
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1
                });
            });
            
            // 计算每周的总派船数
            weekColumns.forEach((week) => {
                const weekCode = week.code;
                let totalShips = 0;
                groupedData.forEach(item => {
                    const ships = item.weeks[weekCode] || [];
                    totalShips += ships.length;
                });
                shipData.push(totalShips);
            });
            
            // 添加派船折线图数据集
            datasets.push({
                label: '派船总数',
                data: shipData,
                type: 'line',
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                yAxisID: 'y1'
            });
            
            // 销毁旧图表
            if (capacityChart) {
                capacityChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('trendChart').getContext('2d');
            capacityChart = new Chart(ctx, {
                data: {
                    labels: weekLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '运力与派船趋势分析',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '周别'
                            }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '运力 (TEU)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '派船数'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // AI分析相关功能
        const aiProviders = {
            deepseek: {
                id: 'deepseek',
                name: 'DeepSeek',
                keyInputId: 'apiKeyInput',
                urlInputId: 'apiUrlInput',
                modelInputId: 'apiModelInput',
                buttonId: 'aiAnalysisBtn',
                loadingId: 'aiLoading',
                resultContainerId: 'aiResult',
                resultContentId: 'aiResultContent',
                defaultUrl: 'https://api.deepseek.com/v1/chat/completions',
                defaultModel: 'deepseek-chat',
                storagePrefix: 'deepseek',
                temperature: 0.7,
                maxTokens: 8000
            },
            kimi: {
                id: 'kimi',
                name: 'KIMI (Moonshot)',
                keyInputId: 'kimiApiKeyInput',
                urlInputId: 'kimiApiUrlInput',
                modelInputId: 'kimiModelInput',
                buttonId: 'kimiAnalysisBtn',
                loadingId: 'kimiAiLoading',
                resultContainerId: 'kimiAiResult',
                resultContentId: 'kimiAiResultContent',
                defaultUrl: 'https://api.moonshot.cn/v1/chat/completions',
                defaultModel: 'moonshot-v1-32k',
                storagePrefix: 'kimi',
                temperature: 0.7,
                maxTokens: 8000
            },
            qwen: {
                id: 'qwen',
                name: '通义千问 (Qwen)',
                keyInputId: 'qwenApiKeyInput',
                urlInputId: 'qwenApiUrlInput',
                modelInputId: 'qwenModelInput',
                buttonId: 'qwenAnalysisBtn',
                loadingId: 'qwenAiLoading',
                resultContainerId: 'qwenAiResult',
                resultContentId: 'qwenAiResultContent',
                defaultUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                defaultModel: 'qwen-max',
                storagePrefix: 'qwen',
                temperature: 0.7,
                maxTokens: 8000
            }
        };
        // 提示词已从共享文件 vendor/ai-prompts.js 加载
        // baseSystemPrompt 和 aiInstructionTemplate 现在从外部文件引用
        let activeAiProvider = 'deepseek';

        const aiTabButtons = document.querySelectorAll('.ai-tab-btn');
        const aiPanels = document.querySelectorAll('.ai-panel');

        aiTabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const providerId = btn.dataset.provider;
                setActiveAiPanel(providerId);
            });
        });

        function setActiveAiPanel(providerId = 'deepseek') {
            if (!aiProviders[providerId]) return;
            activeAiProvider = providerId;
            aiTabButtons.forEach(btn => {
                if (btn.dataset.provider === providerId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            aiPanels.forEach(panel => {
                if (panel.dataset.provider === providerId) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
        }

        function loadAiConfigs() {
            Object.values(aiProviders).forEach(provider => {
                const keyInput = document.getElementById(provider.keyInputId);
                const urlInput = document.getElementById(provider.urlInputId);
                const modelInput = document.getElementById(provider.modelInputId);
                const savedKey = localStorage.getItem(`${provider.storagePrefix}_api_key`) || '';
                const savedUrl = localStorage.getItem(`${provider.storagePrefix}_api_url`) || provider.defaultUrl;
                const savedModel = localStorage.getItem(`${provider.storagePrefix}_model`) || provider.defaultModel;
                if (keyInput) keyInput.value = savedKey;
                if (urlInput) urlInput.value = savedUrl;
                if (modelInput) modelInput.value = savedModel;
            });
        }

        function getAiConfig(providerId = 'deepseek') {
            const provider = aiProviders[providerId];
            if (!provider) return null;
            const keyInput = document.getElementById(provider.keyInputId);
            const urlInput = document.getElementById(provider.urlInputId);
            const modelInput = document.getElementById(provider.modelInputId);
            return {
                apiKey: keyInput ? keyInput.value.trim() : '',
                apiUrl: urlInput ? (urlInput.value.trim() || provider.defaultUrl) : provider.defaultUrl,
                model: modelInput ? (modelInput.value.trim() || provider.defaultModel) : provider.defaultModel
            };
        }

        function saveAiConfig(providerId = 'deepseek') {
            saveAiConfigToStorage(providerId, aiProviders, (providerName) => {
                // 使用统一的错误处理模块
                const configSavedMsg = typeof getErrorMessage === 'function' 
                    ? getErrorMessage(ErrorType.USER_ACTION, 'CONFIG_SAVED', { provider: providerName })
                    : `${providerName} API 配置已保存`;
                showSuccess(configSavedMsg);
            });
        }

        // fetchBunkerData, extractBunkerTables, parseBunkerTable, updateBunkerStatus, describeBunkerLine 已从 vendor/market-analysis-utils.js 加载

        // fetchWciData, parseWciText, renderWciStatus 已从 vendor/market-analysis-utils.js 加载

        const wciCodeMap = {
            'WCI-COMPOSITE': '全球综合',
            'WCI-SHA-RTM': '上海 → 鹿特丹',
            'WCI-RTM-SHA': '鹿特丹 → 上海',
            'WCI-SHA-GOA': '上海 → 热那亚',
            'WCI-SHA-LAX': '上海 → 洛杉矶',
            'WCI-LAX-SHA': '洛杉矶 → 上海',
            'WCI-SHA-NYC': '上海 → 纽约',
            'WCI-NYC-RTM': '纽约 → 鹿特丹',
            'WCI-RTM-NYC': '鹿特丹 → 纽约'
        };

        const fbxCodeMap = {
            FBX: 'FBX（Freightos Baltic Index 全球综合）',
            FBX01: 'FBX01 中国/东亚 → 北美西海岸',
            FBX02: 'FBX02 北美西海岸 → 中国/东亚',
            FBX03: 'FBX03 中国/东亚 → 北美东海岸',
            FBX04: 'FBX04 北美东海岸 → 中国/东亚',
            FBX11: 'FBX11 中国/东亚 → 北欧',
            FBX12: 'FBX12 北欧 → 中国/东亚',
            FBX13: 'FBX13 中国/东亚 → 地中海',
            FBX14: 'FBX14 地中海 → 中国/东亚',
            FBX21: 'FBX21 北美东海岸 → 北欧',
            FBX22: 'FBX22 北欧 → 北美东海岸',
            FBX24: 'FBX24 欧洲 → 南美东海岸',
            FBX26: 'FBX26 欧洲 → 南美西海岸'
        };

        // fetchFbxData, parseFbxText, renderFbxStatus 已从 vendor/market-analysis-utils.js 加载

        const cachedWci = loadCachedData(CACHE_KEYS.wci);
        if (cachedWci) {
            wciData = cachedWci;
            renderWciStatus();
        }
        const cachedFbx = loadCachedData(CACHE_KEYS.fbx);
        if (cachedFbx) {
            fbxData = cachedFbx;
            renderFbxStatus();
        }

        // fetchTextContent 已从 vendor/market-analysis-utils.js 加载

        /**
         * 更新AI分析模块可见性（默认显示，类似 Monitor-Sailing-Schedule）
         * @param {boolean} hasPortSelection - 是否有港口选择
         */
        function updateAiAnalysis(hasPortSelection) {
            const aiAnalysisContainer = document.getElementById('aiAnalysisContainer');
            const emptyAiMessage = document.getElementById('emptyAiMessage');
            const aiConfigSection = document.getElementById('aiConfigSection');
            
            if (!aiAnalysisContainer) return;
            
            // AI 模块始终显示（默认显示）
            aiAnalysisContainer.style.display = 'block';
            
            // 根据数据状态显示/隐藏配置区域
            if (!hasPortSelection || !latestFilteredRecords || latestFilteredRecords.length === 0) {
                if (emptyAiMessage) emptyAiMessage.style.display = 'block';
                if (aiConfigSection) aiConfigSection.style.display = 'none';
                return;
            }
            
            if (emptyAiMessage) emptyAiMessage.style.display = 'none';
            if (aiConfigSection) aiConfigSection.style.display = 'block';
            loadAiConfigs();
            setActiveAiPanel(activeAiProvider);
        }

        async function runAiAnalysis(providerId = 'deepseek') {
            await executeAiAnalysis(
                providerId,
                aiProviders,
                buildAiPrompt,
                baseSystemPrompt,
                {
                    beforeAnalysis: async () => {
                        // 分析前获取数据
                        await Promise.allSettled([
                            fetchBunkerData(false),
                            fetchWciData(false),
                            fetchFbxData(false)
                        ]);
                    }
                }
            );
        }

        function buildAiPrompt() {
            const filteredRecords = latestFilteredRecords;
            if (!filteredRecords.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_DATA');
                return null;
            }
            // 无论是否选择港口，都按航线分组（合并不同港口），这样同一船名航次在不同港口时不会重复统计
            const hasPortSelection = destinationFilters.ports.length > 0;
            // 始终不按港口分组，合并相同航线
            const analysisGroups = groupedTableData.length ? groupedTableData : groupRecords(filteredRecords, false).data;
            if (!analysisGroups.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_ROUTE_DATA');
                return null;
            }

            // 使用公共函数准备分析数据
            const prepared = prepareAnalysisData(analysisGroups, weekColumns, showError, ErrorType);
            if (!prepared) return null;
            const { analysisData, weeklySummary, analysisWeekCodes, analysisWeekLabels } = prepared;

            // 构建目的地摘要（001-04格式）
            const destinationSummary = destinationFilters.ports.length
                ? destinationFilters.ports.join('、')
                : '全部港口';

            // 使用公共函数构建提示词
            let prompt = buildDataOverview(destinationSummary, analysisData.length, analysisWeekCodes, analysisWeekLabels, weeklySummary);
            prompt += buildDetailedData001(analysisData, analysisWeekCodes, analysisWeekLabels);
            prompt += buildBookingDataSection(getBookingData());
            prompt += buildMarketReportsSection(marketReports);
            prompt += buildBunkerDataSection(bunkerData);
            prompt += buildWciDataSection(wciData);
            prompt += buildFbxDataSection(fbxData);
            // 添加 SCFI 数据（从市场报告中提取）
            prompt += buildScfiDataSection(marketReports);

            prompt += aiInstructionTemplate;
            return prompt;
        }


        function getBookingData() {
            const tbody = document.getElementById('bookingDataBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const data = [];
            
            rows.forEach(row => {
                const remarkInput = row.querySelector('.booking-remark');
                const descInput = row.querySelector('.booking-desc');
                const remark = remarkInput ? remarkInput.value.trim() : '';
                const description = descInput ? descInput.value.trim() : '';
                
                if (remark || description) {
                    data.push({
                        remark,
                        description
                    });
                }
            });
            
            return data;
        }

        /**
         * 导出整页 PDF（使用 vendor/pdf-utils.js）
         */
        async function exportPageToPdf() {
            const exportBtn = document.getElementById('exportPdfBtn');
            if (!exportBtn) return;
            
            try {
                // 生成文件名：市场分析报告_年月日.pdf
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const fileName = `市场分析报告_${year}${month}${day}`;
                
                // 使用 vendor/pdf-utils.js 中的 exportToPdf 函数
                await exportToPdf('.container', {
                    fileName: fileName,
                    onStart: () => {
                        exportBtn.disabled = true;
                        exportBtn.textContent = '正在导出...';
                    },
                    onComplete: () => {
                        exportBtn.textContent = '导出整页 PDF';
                        exportBtn.disabled = false;
                    },
                    onError: (error) => {
                        debugError('导出PDF失败:', error);
                        showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                            message: error.message || String(error) 
                        }, error);
                        exportBtn.textContent = '导出整页 PDF';
                        exportBtn.disabled = false;
                    }
                });
            } catch (error) {
                debugError('导出PDF失败:', error);
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: error.message || String(error) 
                }, error);
                if (exportBtn) {
                    exportBtn.textContent = '导出整页 PDF';
                    exportBtn.disabled = false;
                }
            }
        }

        document.getElementById('exportPdfBtn')?.addEventListener('click', exportPageToPdf);
        window.addEventListener('load', () => {
            // 页面加载时显示 AI 模块（默认显示）
            updateAiAnalysis(false);
            
            Promise.allSettled([
                fetchBunkerData(false),
                fetchWciData(false),
                fetchFbxData(false)
            ]);
        });

        // 筛选功能在renderTable中已实现
    </script>
</body>
</html>
