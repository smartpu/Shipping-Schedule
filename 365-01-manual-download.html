<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明日数航 船期网页下载工具</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/auth-gist.js"></script>
</head>
<body data-page="365-01-manual-download.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片，沿用 dashboard 风格 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>明日数航 船期网页下载工具</h2>
                            <p id="totalCountText">提示：建议每保存一个网页后，等待10秒再处理下一个，避免请求过快。</p>
                        </div>
                        <div class="section-intro-actions">
                            <a href="dashboard.html?tab=tools365" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="365-01-manual-download-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 文件上传和数据状态区域 - 一行两个白底圆角框 -->
                <div class="grid-2-col">
                    <!-- 载入 Excel 框 -->
                    <div class="card-white">
                        <label for="excelFileInput" class="file-upload-label" aria-label="选择Excel文件上传">
                            <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradExcel)" />
                                <!-- Excel表格图标 -->
                                <rect x="8" y="8" width="20" height="20" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                <line x1="8" y1="14" x2="28" y2="14" stroke="#fff" stroke-width="1.5"/>
                                <line x1="8" y1="20" x2="28" y2="20" stroke="#fff" stroke-width="1.5"/>
                                <line x1="14" y1="8" x2="14" y2="28" stroke="#fff" stroke-width="1.5"/>
                                <!-- 向下箭头 -->
                                <path d="M18 22L22 26L14 26Z" fill="#fff"/>
                                <defs>
                                    <linearGradient id="gradExcel" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#0071e3" />
                                        <stop offset="1" stop-color="#54a4ff" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="file-upload-content">
                                <div class="file-upload-title">载入 Excel</div>
                                <div class="file-upload-desc">支持 .xlsx / .xls，数据仅在本地浏览器解析</div>
                            </div>
                            <input type="file" id="excelFileInput" class="file-upload-input" accept=".xlsx,.xls" aria-label="选择Excel文件" aria-describedby="excelFileInputDesc">
                            <span id="excelFileInputDesc" class="sr-only">支持 .xlsx 和 .xls 格式的Excel文件</span>
                        </label>
                    </div>
                    
                    <!-- 数据状态框 -->
                    <div class="card-white">
                        <div class="data-status-container">
                            <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradStatus)" />
                                <!-- 数据状态图标：剪贴板 + 勾 -->
                                <rect x="11" y="10" width="14" height="16" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                <rect x="15" y="8" width="6" height="4" rx="1" fill="#fff"/>
                                <path d="M14 18L17 21L23 15" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                <defs>
                                    <linearGradient id="gradStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#FF8A00" />
                                        <stop offset="1" stop-color="#FFB347" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="data-status-content">
                                <div class="data-status-title">数据状态</div>
                                <div id="fileStatus" class="data-status-text" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">尚未载入数据</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 统计信息 - 三个长条白底圆角框 -->
                <div class="grid-3-col" role="region" aria-label="数据统计">
                    <div class="stats-card" role="status" aria-live="polite" aria-atomic="true">
                        <div id="totalCount" class="stats-number" aria-label="总计数量">0</div>
                        <div class="stats-label">总计</div>
                    </div>
                    <div class="stats-card stats-card-clickable" id="clearSavedBtn" title="点击清除所有已保存状态" role="button" tabindex="0" aria-label="清除所有已保存状态" aria-describedby="savedCount" aria-keyshortcuts="Delete">
                        <div id="savedCount" class="stats-number" aria-live="polite" aria-atomic="true" aria-label="已保存数量">0</div>
                        <div class="stats-label">已保存</div>
                    </div>
                    <div class="stats-card" role="status" aria-live="polite" aria-atomic="true">
                        <div id="pendingCount" class="stats-number" aria-label="待处理数量">0</div>
                        <div class="stats-label">待处理</div>
                    </div>
                </div>

                <!-- POL选项卡容器（用于换行显示） -->
                <div class="pol-tabs" id="polTabs">
                    <!-- POL选项卡将通过JavaScript动态生成 -->
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <!-- URL列表 - 大框白色圆角 -->
                <div class="card-white mt-20" role="region" aria-label="网页列表">
                    <div class="url-list" id="urlList" role="list" aria-label="待处理的网页列表" aria-live="polite">
                        <!-- URL列表将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">明日数航 船期网页下载工具使用声明</h2>
                    <p class="usage-statement-text">本工具用于辅助从明日数航（hangyun365.com）手动下载船期网页，所有数据来源于明日数航公开信息，仅供内部使用。</p>
                    <p class="usage-statement-text">下载的网页文件仅供数据解析使用，请遵守明日数航的使用条款和版权规定。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/sidebar-loader.js"></script>
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/port-sort-utils.js"></script>
    <script>
        /**
         * 365-01 网页下载工具
         * 配置对象
         */
        const CONFIG = {
            STORAGE_KEY: '365_savedStatus',
            SHEET_NAME: 'Port Optimization 365',
            DEFAULT_POL: 'CNTAO',
            DEBUG: false
        };

        const debugLog = typeof window !== 'undefined' && typeof window.debugLog === 'function'
            ? (...args) => window.debugLog('[365-01]', ...args)
            : () => {};

        init001ToolPage('365-01-manual-download.html', 'tools365', () => {
            const progressBarEl = DOM_CACHE.progressBar;
            if (progressBarEl) {
                progressBarEl.style.display = 'none';
            }
        });

        // 全局数据
        let excelData = {};
        let currentPol = null;
        let urlData = [];
        let savedStatus = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY) || '{}');

        // DOM 元素缓存（避免重复查询）
        const DOM_CACHE = {
            get fileStatus() { return document.getElementById('fileStatus'); },
            get statusDetail() { return document.getElementById('statusDetail'); },
            get totalCountText() { return document.getElementById('totalCountText'); },
            get totalCount() { return document.getElementById('totalCount'); },
            get savedCount() { return document.getElementById('savedCount'); },
            get pendingCount() { return document.getElementById('pendingCount'); },
            get progressFill() { return document.getElementById('progressFill'); },
            get progressBar() { return document.getElementById('progressBar'); },
            get polTabs() { return document.getElementById('polTabs'); },
            get urlList() { return document.getElementById('urlList'); },
            get clearSavedBtn() { return document.getElementById('clearSavedBtn'); },
            get excelFileInput() { return document.getElementById('excelFileInput'); }
        };

        async function parseExcelFile(file) {
            try {
                await ensureXlsx();
                
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX库未加载，请刷新页面重试');
                }

                await portSortUtils.loadPortsList();

                const fileStatusEl = DOM_CACHE.fileStatus;
                const totalCountTextEl = DOM_CACHE.totalCountText;
                
                if (!fileStatusEl) {
                    throw new Error('必需的DOM元素未找到');
                }
                
                fileStatusEl.textContent = '解析中...';

                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                debugLog('Excel工作表列表:', workbook.SheetNames);
                
                let sheetName = workbook.SheetNames.find(name => 
                    name === CONFIG.SHEET_NAME || 
                    name.includes(CONFIG.SHEET_NAME)
                );
                
                if (!sheetName) {
                    sheetName = workbook.SheetNames.find(name => {
                        const lowerName = name.toLowerCase();
                        return (lowerName.includes('port optimization') || lowerName.includes('365')) && 
                               !lowerName.includes('001');
                    });
                }
                
                if (!sheetName) {
                    sheetName = workbook.SheetNames[0];
                    debugLog('未找到目标表，使用第一个表:', sheetName);
                } else {
                    debugLog('找到工作表:', sheetName);
                }

                const sheet = workbook.Sheets[sheetName];
                if (!sheet) {
                    throw new Error('工作表不存在');
                }
                
                const matrix = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                
                debugLog('数据行数:', matrix.length);
                debugLog('前5行数据:', matrix.slice(0, 5));

                const polDataMap = {};
                
                let headerRowIndex = 0;
                for (let i = 0; i < Math.min(5, matrix.length); i++) {
                    const row = matrix[i];
                    const rowText = row.join('').toLowerCase();
                    if (rowText.includes('pol') || rowText.includes('pod') || rowText.includes('url')) {
                        headerRowIndex = i;
                        debugLog('找到标题行，索引:', i, '内容:', row);
                        break;
                    }
                }
                
                const headerRow = matrix[headerRowIndex] || [];
                debugLog('标题行:', headerRow);
                
                const COL_INDEX = {
                    POL: 0,
                    POD: 1,
                    POL_CODE: 2,
                    URL: 4
                };
                
                debugLog('列配置:', COL_INDEX);
                
                function extractPolName(colA) {
                    if (!colA) return '';
                    const match = colA.match(/\[([^\]]+)\]/);
                    if (match) {
                        const parts = match[1].split('|');
                        if (parts.length >= 2) {
                            return parts[1].trim().toUpperCase();
                        }
                    }
                    return colA.toUpperCase();
                }
                
                let processedCount = 0;
                for (let i = headerRowIndex + 1; i < matrix.length; i++) {
                    const row = matrix[i];
                    const colA = String(row[COL_INDEX.POL] || '').trim();
                    const colB = String(row[COL_INDEX.POD] || '').trim();
                    
                    if (!colA && !colB) continue;
                    
                    const code = portSortUtils.extractCode(colB);
                    const region = portSortUtils.extractRegion(colB);
                    
                    const polCode = String(row[COL_INDEX.POL_CODE] || '').trim().toUpperCase();
                    
                    if (polCode === 'CNTAO' || polCode === 'CNRZH') {
                        if (COL_INDEX.URL < row.length) {
                            const url = String(row[COL_INDEX.URL] || '').trim();
                            if (url && url !== '' && colA) {
                                const polName = extractPolName(colA);
                                if (polName) {
                                    if (!polDataMap[polName]) {
                                        polDataMap[polName] = [];
                                    }
                                    polDataMap[polName].push({
                                        colA: colA,
                                        colB: colB,
                                        url: url,
                                        code: code,
                                        region: region
                                    });
                                    processedCount++;
                                }
                            }
                        }
                    } else if (colA && colA !== '') {
                        if (COL_INDEX.URL < row.length) {
                            const url = String(row[COL_INDEX.URL] || '').trim();
                            if (url && url !== '') {
                                const polName = extractPolName(colA);
                                if (polName) {
                                    if (!polDataMap[polName]) {
                                        polDataMap[polName] = [];
                                    }
                                    polDataMap[polName].push({
                                        colA: colA,
                                        colB: colB,
                                        url: url,
                                        code: code,
                                        region: region
                                    });
                                    processedCount++;
                                }
                            }
                        }
                    }
                }
                
                debugLog('处理的数据行数:', processedCount);
                debugLog('POL数据映射:', Object.keys(polDataMap));
                
                Object.keys(polDataMap).forEach(pol => {
                    polDataMap[pol] = portSortUtils.sortPorts(polDataMap[pol]);
                });
                
                excelData = polDataMap;
                
                renderPolTabs();
                
                if (Object.keys(excelData).length > 0) {
                    const defaultPol = excelData[CONFIG.DEFAULT_POL] ? CONFIG.DEFAULT_POL : Object.keys(excelData)[0];
                    switchPol(defaultPol);
                }
                
                const totalCount = Object.values(excelData).reduce((sum, arr) => sum + arr.length, 0);
                
                if (totalCount > 0) {
                    if (fileStatusEl) {
                        fileStatusEl.innerHTML = `<span>已载入 1 份表格</span><span style="color: #6c757d;">共 ${totalCount.toLocaleString()} 条记录</span>`;
                    }
                    if (totalCountTextEl) {
                        totalCountTextEl.textContent = `共${totalCount}个网页需要保存。提示：建议每保存一个网页后，等待10秒再处理下一个，避免请求过快。`;
                        totalCountTextEl.style.display = 'block';
                    }
                } else {
                    if (fileStatusEl) {
                        fileStatusEl.textContent = '文件为空或格式不正确';
                    }
                    if (typeof window.debugError === 'function') {
                        window.debugError('[365-01] 未解析到任何数据，请检查Excel文件格式');
                    }
                    if (totalCountTextEl) {
                        totalCountTextEl.style.display = 'none';
                    }
                }
                
            } catch (error) {
                if (typeof window.debugError === 'function') {
                    window.debugError('[365-01] 解析Excel文件失败:', error);
                    window.debugError('[365-01] 错误堆栈:', error.stack);
                }
                
                const fileStatusEl = DOM_CACHE.fileStatus;
                const totalCountTextEl = DOM_CACHE.totalCountText;
                
                if (fileStatusEl) {
                    fileStatusEl.textContent = '加载失败，请检查文件格式';
                }
                if (totalCountTextEl) {
                    totalCountTextEl.style.display = 'none';
                }
            }
        }

        /**
         * 创建POL按钮
         * @param {string} pol - POL代码
         * @returns {HTMLButtonElement} 创建的按钮元素
         */
        function createPolButton(pol) {
            const tabBtn = document.createElement('button');
            tabBtn.setAttribute('data-pol', pol);
            tabBtn.className = 'pol-button btn-sweep-orange';
            
            const polItems = excelData[pol];
            if (polItems && polItems.length > 0 && polItems[0].colA) {
                tabBtn.textContent = polItems[0].colA;
            } else {
                tabBtn.textContent = pol;
            }
            
            tabBtn.onclick = () => switchPol(pol);
            
            if (pol === currentPol) {
                tabBtn.classList.add('pol-button-active');
                tabBtn.setAttribute('aria-pressed', 'true');
                tabBtn.setAttribute('aria-current', 'true');
            } else {
                tabBtn.setAttribute('aria-pressed', 'false');
            }
            
            return tabBtn;
        }

        function renderPolTabs() {
            const polTabsContainer = DOM_CACHE.polTabs;
            if (!polTabsContainer) return;
            polTabsContainer.innerHTML = '';
            
            const pols = Object.keys(excelData).sort();
            
            pols.forEach((pol) => {
                const tabBtn = createPolButton(pol);
                polTabsContainer.appendChild(tabBtn);
            });
            
            if (pols.length > 0) {
                polTabsContainer.classList.add('active');
            } else {
                polTabsContainer.classList.remove('active');
            }
        }

        function switchPol(pol) {
            currentPol = pol;
            
            document.querySelectorAll('button[data-pol]').forEach(btn => {
                const btnPol = btn.getAttribute('data-pol');
                if (btnPol === pol) {
                    btn.classList.add('pol-button-active');
                    btn.setAttribute('aria-pressed', 'true');
                    btn.setAttribute('aria-current', 'true');
                } else {
                    btn.classList.remove('pol-button-active');
                    btn.setAttribute('aria-pressed', 'false');
                    btn.removeAttribute('aria-current');
                }
            });
            
            if (excelData[pol]) {
                urlData = excelData[pol].map((item, index) => ({
                    index: `${pol}_${index}`,
                    display: `${item.colA} - ${item.colB}`,
                    url: item.url
                }));
            } else {
                urlData = [];
            }
            
            renderUrlList();
            updateStats();
        }

        /**
         * 初始化页面
         */
        async function init() {
            await portSortUtils.loadPortsList();
            
            const clearSavedBtn = DOM_CACHE.clearSavedBtn;
            if (clearSavedBtn) {
                clearSavedBtn.addEventListener('click', clearAllSaved);
                clearSavedBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        clearAllSaved();
                    }
                });
            }
            
            const excelFileInput = DOM_CACHE.excelFileInput;
            if (excelFileInput) {
                excelFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        await parseExcelFile(file);
                    }
                });
            }
            
            loadDefaultExcelFile('365-01-manual-download', async (file) => {
                if (file) {
                    await parseExcelFile(file);
                }
            });
        }

        function renderUrlList() {
            const urlList = DOM_CACHE.urlList;
            if (!urlList) return;
            urlList.innerHTML = '';

            if (urlData.length === 0) {
                urlList.innerHTML = '<div class="empty-state" role="status" aria-live="polite">请先加载Excel文件</div>';
                return;
            }

            urlData.forEach((item, index) => {
                const isSaved = savedStatus[item.index] || false;
                const urlItem = document.createElement('div');
                urlItem.className = 'url-item';
                urlItem.setAttribute('role', 'listitem');
                urlItem.setAttribute('aria-label', `第${index + 1}项：${item.display}`);
                
                urlItem.innerHTML = `
                    <div class="url-item-number" aria-label="项目编号">${index + 1}</div>
                    <div class="url-item-content">
                        <div class="url-item-title">${item.display}</div>
                        <div class="url-item-url" aria-label="网页地址">${portSortUtils.escapeHtml(item.url)}</div>
                    </div>
                    <div class="url-item-actions">
                        <a href="${item.url}" target="_blank" class="btn-primary-blue btn-sweep-blue" aria-label="在新窗口打开网页 ${item.display}" rel="noopener noreferrer">打开网页</a>
                        <button data-item-index="${item.index}" ${isSaved ? 'disabled' : ''} class="btn-primary-orange ${isSaved ? '' : 'btn-sweep-orange'}" aria-label="${isSaved ? '已保存' : '标记为已保存'}" ${isSaved ? 'aria-pressed="true"' : 'aria-pressed="false"'}>${isSaved ? '✓ 已保存' : '标记为已保存'}</button>
                    </div>
                `;
                
                const markBtn = urlItem.querySelector('button[data-item-index]');
                if (markBtn && !isSaved) {
                    markBtn.addEventListener('click', () => {
                        markAsSaved(item.index);
                    });
                }
                
                urlList.appendChild(urlItem);
            });
        }

        /**
         * 标记为已保存
         * @param {string} index - 项目索引
         */
        function markAsSaved(index) {
            savedStatus[index] = true;
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(savedStatus));
            renderUrlList();
            updateStats();
        }

        /**
         * 更新统计信息（只统计当前POL的已保存数量）
         */
        function updateStats() {
            const totalCountEl = DOM_CACHE.totalCount;
            const savedCountEl = DOM_CACHE.savedCount;
            const pendingCountEl = DOM_CACHE.pendingCount;
            const progressFillEl = DOM_CACHE.progressFill;
            const progressBarEl = DOM_CACHE.progressBar;
            const totalCountTextEl = DOM_CACHE.totalCountText;
            
            if (!currentPol || urlData.length === 0) {
                totalCountEl.textContent = 0;
                savedCountEl.textContent = 0;
                pendingCountEl.textContent = 0;
                if (progressFillEl) {
                    progressFillEl.style.width = '0%';
                }
                if (progressBarEl) {
                    progressBarEl.style.display = 'none';
                }
                totalCountTextEl.style.display = 'none';
                return;
            }
            
            const currentPolSavedCount = urlData.filter(item => savedStatus[item.index]).length;
            const pendingCount = urlData.length - currentPolSavedCount;
            const progress = urlData.length > 0 ? (currentPolSavedCount / urlData.length) * 100 : 0;

            totalCountEl.textContent = urlData.length;
            savedCountEl.textContent = currentPolSavedCount;
            pendingCountEl.textContent = pendingCount;
            
            if (progressFillEl) {
                progressFillEl.style.width = `${progress}%`;
            }
            if (progressBarEl) {
                if (progress === 0) {
                    progressBarEl.style.display = 'none';
                } else {
                    progressBarEl.style.display = 'block';
                }
            }
            
            const allPolTotalCount = Object.values(excelData).reduce((sum, arr) => sum + arr.length, 0);
            if (allPolTotalCount > 0) {
                totalCountTextEl.textContent = `共${allPolTotalCount}个网页需要保存。提示：建议每保存一个网页后，等待10秒再处理下一个，避免请求过快。`;
                totalCountTextEl.style.display = 'block';
            } else {
                totalCountTextEl.style.display = 'none';
            }
        }

        function clearAllSaved() {
            if (!currentPol) {
                const message = '请先选择一个POL';
                if (typeof window.debugError === 'function') {
                    window.debugError(message);
                }
                alert(message);
                return;
            }
            
            const confirmMessage = `确定要清除当前POL（${currentPol}）的所有已保存状态吗？这将重置该POL的进度。`;
            if (confirm(confirmMessage)) {
                urlData.forEach(item => {
                    if (savedStatus[item.index]) {
                        delete savedStatus[item.index];
                    }
                });
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(savedStatus));
                renderUrlList();
                updateStats();
            }
        }

        init();
    </script>
</body>
</html>
