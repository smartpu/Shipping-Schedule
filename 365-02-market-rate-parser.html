<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明日数航 港口行情解析工具</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/auth-gist.js"></script>
</head>
<body data-page="365-02-market-rate-parser.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片，沿用 dashboard 风格 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>明日数航 港口行情解析工具</h2>
                            <p>自动解析明日数航港口行情网页，解析过程中请勿关闭页面，解析完成后会自动显示统计信息。</p>
                        </div>
                        <div class="section-intro-actions">
                            <a href="dashboard.html?tab=tools365" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="365-02-market-rate-schedule-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 解析工具主区域 -->
                <div class="card-white mt-20">
                    <div class="controls">
                        <label class="file-btn" aria-label="选择包含HTML文件的文件夹">
                            选择 view-full 文件夹
                            <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm" aria-label="选择文件夹">
                        </label>
                        <button id="run" class="btn btn-sweep-blue" disabled aria-label="开始解析HTML文件">开始解析</button>
                        <button id="download" class="btn btn-sweep-blue" disabled aria-label="下载CSV文件">下载 CSV</button>
                        <span id="summary" role="status" aria-live="polite"></span>
                    </div>
                    <div id="log" class="log" aria-live="polite" role="log" aria-label="解析日志"></div>
                    <div id="preview" class="hidden" role="region" aria-label="解析结果预览">
                        <table id="table" role="table" aria-label="解析结果表格"></table>
                    </div>
                </div>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">明日数航 港口行情解析工具使用声明</h2>
                    <p class="usage-statement-text">本工具用于解析从明日数航（hangyun365.com）下载的港口行情网页，提取价格信息并导出为 CSV 文件。</p>
                    <p class="usage-statement-text">所有数据来源于明日数航公开信息，解析结果仅供内部使用，请遵守明日数航的使用条款和版权规定。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/sidebar-loader.js"></script>
    <script src="vendor/parser-utils.js"></script>
    <script>
        init001ToolPage('365-02-market-rate-parser.html', 'tools365');
    </script>
    <script>

(function() {
    /**
     * DOM 选择器辅助函数
     * @param {string} selector - CSS 选择器
     * @returns {HTMLElement|null} 找到的元素
     */
    const selectElement = (selector) => document.querySelector(selector);
    const log = createLogger('#log');

    /** CSV utils - 使用 parser-utils.js 中的函数 */
    /** DOM helpers - 使用 parser-utils.js 中的函数 (text, find, findAll) */

    function extractOrigin(doc){
        const el = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
        return el? text(el): '';
    }

    function locateMarketTitles(doc){
        return Array.from(doc.querySelectorAll('.Route_plugin_title'))
            .filter(t => (t.textContent||'').includes('同航线其他港口行情'));
    }

    function parseMarket(doc, fileName){
        const origin = extractOrigin(doc);
        const titles = locateMarketTitles(doc);
        if (!titles.length){
            log(`[无行情模块] ${fileName}`, '#b36b00');
            return [];
        }
        const out = [];
        for (const title of titles){
            let ul = title.nextElementSibling && title.nextElementSibling.matches('ul.Route_plugin_price')
                ? title.nextElementSibling
                : (title.parentElement ? title.parentElement.querySelector('ul.Route_plugin_price') : null);
            if (!ul) continue;
            const items = Array.from(ul.querySelectorAll('li.other-price-li, li[title]'));
            for (const li of items){
                const dest = li.getAttribute('title') || '';
                if (!dest) continue;
                const h6s = Array.from(li.querySelectorAll('h6'));
                const p20Raw = h6s[0]? text(h6s[0]): '';
                const p40Raw = h6s[1]? text(h6s[1]): '';
                const p20m = (p20Raw.match(/-?\d[\d,\.]*/)||[''])[0].replace(/,/g,'');
                const p40m = (p40Raw.match(/-?\d[\d,\.]*/)||[''])[0].replace(/,/g,'');
                const t20 = h6s[0]? (h6s[0].classList.contains('red')? '+': (h6s[0].classList.contains('green')? '-': '')): '';
                const t40 = h6s[1]? (h6s[1].classList.contains('red')? '+': (h6s[1].classList.contains('green')? '-': '')): '';
                if (!p20m && !p40m) continue;
                out.push([origin, dest, p20m, t20, p40m, t40]);
            }
        }
        return out;
    }

    function parseFile(name, textHtml){
        const doc = new DOMParser().parseFromString(textHtml, 'text/html');
        return parseMarket(doc, name);
    }

    /** renderPreview - 使用 parser-utils.js 中的函数 */
    function renderPreviewLocal(rows){
        const headers = ['启运港','目的港','20GP','20GP涨跌','40GP','40GP涨跌'];
        renderPreview(rows, '#preview', '#table', headers, 50);
    }

    const picker = selectElement('#picker');
    const runBtn = selectElement('#run');
    const downloadBtn = selectElement('#download');
    const summary = selectElement('#summary');
    const logBox = selectElement('#log');
    let files=[]; 
    let output=[];

    picker.addEventListener('change', ()=>{
        if (logBox) logBox.innerHTML=''; 
        output=[]; 
        summary.textContent='';
        files = Array.from(picker.files).filter(f=>/\.html?$/i.test(f.name)).sort((a,b)=>a.name.localeCompare(b.name));
        if (!files.length){ 
            log('未选择到 HTML 文件，请重新选择 view-full。', '#b00020'); 
            runBtn.disabled=true; 
            downloadBtn.disabled=true; 
            return; 
        }
        log(`已选择 ${files.length} 个 HTML 文件。`, '#0a7d33');
        runBtn.disabled=false; 
        downloadBtn.disabled=true; 
        selectElement('#preview').classList.add('hidden');
    });

    runBtn.addEventListener('click', async ()=>{
        runBtn.disabled=true; 
        downloadBtn.disabled=true; 
        output=[]; 
        selectElement('#preview').classList.add('hidden');
        const header = ['启运港','目的港','20GP','20GP涨跌','40GP','40GP涨跌'];
        const rows = [header];
        let ok=0, warn=0;

        for (const f of files){
            try{
                const html = await f.text();
                const r = parseFile(f.name, html);
                if (!r.length){ 
                    warn++; 
                    log(`[无数据] ${f.name}`, '#b36b00'); 
                }
                else { 
                    ok++; 
                    log(`[OK] ${f.name} -> ${r.length} 行`, '#0a7d33'); 
                    rows.push(...r); 
                }
            }catch(e){ 
                warn++; 
                log(`[失败] ${f.name}: ${e && e.message? e.message: e}`, '#b00020'); 
            }
        }

        // Merge identical: same origin+dest+20+40 (keep first trend marks)
        const map = new Map();
        for (let i=1;i<rows.length;i++){
            const [o,d,p20,t20,p40,t40] = rows[i];
            const key = [o,d,p20,p40].join('|');
            if (!map.has(key)) map.set(key, [o,d,p20,t20,p40,t40]);
        }
        const merged = [header, ...Array.from(map.values())];
        output = merged;
        renderPreviewLocal(merged.slice(1));
        downloadBtn.disabled = merged.length<=1;
        summary.textContent = `完成：${ok} 文件，${warn} 提醒，合并后 ${merged.length-1} 条。`;
    });

    downloadBtn.addEventListener('click', ()=>{
        if (!output || output.length<=1) return;
        const csv = '\uFEFF'+rowsToCsv(output);
        downloadBlob(csv, generateTimestampFilename('market'), 'text/csv;charset=utf-8');
    });
})();
    </script>
</body>
</html>
