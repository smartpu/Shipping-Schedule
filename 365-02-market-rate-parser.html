<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜æ—¥æ•°èˆª æ¸¯å£è¡Œæƒ…è§£æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #333;
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .instructions {
            padding: 25px 40px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px 40px;
            border-radius: 8px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #856404;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .instructions strong {
            color: #856404;
        }

        .content {
            padding: 20px 40px 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .file-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .file-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .file-btn input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn[disabled] {
            background: #d2d2d7;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #summary {
            color: #6c757d;
            font-size: 14px;
            margin-left: 10px;
        }

        .log {
            margin-top: 15px;
            background: #fafafa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        #preview {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #e9ecef;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f7f7f9;
            z-index: 1;
            font-weight: 600;
            color: #495057;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .footer {
            padding: 20px 40px;
            background: #f8f9fa;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }
    </style>
    <meta name="color-scheme" content="light dark">
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob:;">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ˜æ—¥æ•°èˆª æ¸¯å£è¡Œæƒ…è§£æå·¥å…·</h1>
            <p>è‡ªåŠ¨è§£ææ˜æ—¥æ•°èˆªæ¸¯å£è¡Œæƒ…ç½‘é¡µï¼Œæå–ä»·æ ¼ä¿¡æ¯å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶</p>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li><strong>å‡†å¤‡å·¥ä½œ</strong>ï¼šé¦–å…ˆéœ€è¦ä½¿ç”¨"æ˜æ—¥æ•°èˆª èˆ¹æœŸç½‘é¡µæ‰‹åŠ¨ä¸‹è½½å·¥å…·"ä¸‹è½½å¹¶ä¿å­˜æ‰€æœ‰èˆ¹æœŸç½‘é¡µåˆ° <strong>365-view-source</strong> æ–‡ä»¶å¤¹ä¸­</li>
                <li><strong>é€‰æ‹©æ–‡ä»¶å¤¹</strong>ï¼šç‚¹å‡»"é€‰æ‹© view-source æ–‡ä»¶å¤¹"æŒ‰é’®ï¼Œé€‰æ‹©åŒ…å«æ‰€æœ‰ HTML æ–‡ä»¶çš„ <strong>365-view-source</strong> æ–‡ä»¶å¤¹</li>
                <li><strong>å¼€å§‹è§£æ</strong>ï¼šé€‰æ‹©æ–‡ä»¶å¤¹åï¼Œç‚¹å‡»"å¼€å§‹è§£æ"æŒ‰é’®ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è§£ææ‰€æœ‰ HTML æ–‡ä»¶ä¸­"åŒèˆªçº¿å…¶ä»–æ¸¯å£è¡Œæƒ…"æ¨¡å—çš„ä»·æ ¼ä¿¡æ¯</li>
                <li><strong>æŸ¥çœ‹ç»“æœ</strong>ï¼šè§£æå®Œæˆåï¼Œå¯ä»¥åœ¨ä¸‹æ–¹é¢„è§ˆè¡¨æ ¼ä¸­æŸ¥çœ‹è§£æç»“æœï¼ˆæœ€å¤šæ˜¾ç¤ºå‰50æ¡ï¼‰</li>
                <li><strong>ä¸‹è½½ CSV</strong>ï¼šç¡®è®¤è§£æç»“æœæ— è¯¯åï¼Œç‚¹å‡»"ä¸‹è½½ CSV"æŒ‰é’®ï¼Œå°†æ•°æ®ä¿å­˜ä¸º CSV æ–‡ä»¶</li>
                <li><strong>ç»“æœè¯´æ˜</strong>ï¼šCSV æ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—ï¼šå¯è¿æ¸¯ã€ç›®çš„æ¸¯ã€20GPä»·æ ¼ã€20GPæ¶¨è·Œï¼ˆ+è¡¨ç¤ºä¸Šæ¶¨ï¼Œ-è¡¨ç¤ºä¸‹è·Œï¼‰ã€40GPä»·æ ¼ã€40GPæ¶¨è·Œ</li>
                <li><strong>æ³¨æ„äº‹é¡¹</strong>ï¼šå·¥å…·ä¼šè‡ªåŠ¨åˆå¹¶å®Œå…¨ç›¸åŒçš„è®°å½•ï¼ˆç›¸åŒå¯è¿æ¸¯+ç›®çš„æ¸¯+20GPä»·æ ¼+40GPä»·æ ¼ï¼‰ï¼Œåªä¿ç•™ç¬¬ä¸€æ¡è®°å½•ã€‚å¦‚æœæŸä¸ªç½‘é¡µä¸­æ²¡æœ‰"åŒèˆªçº¿å…¶ä»–æ¸¯å£è¡Œæƒ…"æ¨¡å—ï¼Œä¼šæ˜¾ç¤º"æ— è¡Œæƒ…æ¨¡å—"æç¤º</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        é€‰æ‹© view-source æ–‡ä»¶å¤¹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>å¼€å§‹è§£æ</button>
                    <button id="download" class="btn" disabled>ä¸‹è½½ CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>æç¤ºï¼šè§£æè¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢ï¼Œè§£æå®Œæˆåä¼šè‡ªåŠ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</p>
        </div>
    </div>

<script>
(function() {
    const $ = (s) => document.querySelector(s);
    const logBox = $('#log');
    function log(m, cls) { const d=document.createElement('div'); if (cls) d.style.color=cls; d.textContent=m; logBox.appendChild(d); logBox.scrollTop=logBox.scrollHeight; }

    function toCsvCell(v){ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"': s; }
    function rowsToCsv(rows){ return rows.map(r=>r.map(toCsvCell).join(',')).join('\n'); }
    function downloadBlob(content, name, type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),5e3); }

    function text(el){ return el? (el.textContent||'').trim():''; }
    function find(el, sel){ return el? el.querySelector(sel): null; }
    function findAll(el, sel){ return el? Array.from(el.querySelectorAll(sel)): []; }

    function extractOrigin(doc){
        const el = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
        return el? text(el): '';
    }

    function locateMarketTitles(doc){
        return Array.from(doc.querySelectorAll('.Route_plugin_title'))
            .filter(t => (t.textContent||'').includes('åŒèˆªçº¿å…¶ä»–æ¸¯å£è¡Œæƒ…'));
    }

    function parseMarket(doc, fileName){
        const origin = extractOrigin(doc);
        const titles = locateMarketTitles(doc);
        if (!titles.length){
            log(`[æ— è¡Œæƒ…æ¨¡å—] ${fileName}`, '#b36b00');
            return [];
        }
        const out = [];
        for (const title of titles){
            // Prefer the immediate next UL with class Route_plugin_price
            let ul = title.nextElementSibling && title.nextElementSibling.matches('ul.Route_plugin_price')
                ? title.nextElementSibling
                : (title.parentElement ? title.parentElement.querySelector('ul.Route_plugin_price') : null);
            if (!ul) continue;
            const items = Array.from(ul.querySelectorAll('li.other-price-li, li[title]'));
            for (const li of items){
                const dest = li.getAttribute('title') || '';
                if (!dest) continue;
                const h6s = Array.from(li.querySelectorAll('h6'));
                const p20Raw = h6s[0]? text(h6s[0]): '';
                const p40Raw = h6s[1]? text(h6s[1]): '';
                const p20m = (p20Raw.match(/-?\d[\d,\.]*/)||[''])[0].replace(/,/g,'');
                const p40m = (p40Raw.match(/-?\d[\d,\.]*/)||[''])[0].replace(/,/g,'');
                const t20 = h6s[0]? (h6s[0].classList.contains('red')? '+': (h6s[0].classList.contains('green')? '-': '')): '';
                const t40 = h6s[1]? (h6s[1].classList.contains('red')? '+': (h6s[1].classList.contains('green')? '-': '')): '';
                if (!p20m && !p40m) continue;
                out.push([origin, dest, p20m, t20, p40m, t40]);
            }
        }
        return out;
    }

    function parseFile(name, textHtml){
        const doc = new DOMParser().parseFromString(textHtml, 'text/html');
        return parseMarket(doc, name);
    }

    function renderPreview(rows){
        const headers = ['å¯è¿æ¸¯','ç›®çš„æ¸¯','20GP','20GPæ¶¨è·Œ','40GP','40GPæ¶¨è·Œ'];
        const table = document.getElementById('table');
        const container = document.getElementById('preview');
        table.innerHTML='';
        const thead=document.createElement('thead');
        const trh=document.createElement('tr');
        headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
        thead.appendChild(trh); table.appendChild(thead);
        const tbody=document.createElement('tbody');
        for (let i=0;i<Math.min(rows.length, 50);i++){
            const tr=document.createElement('tr');
            rows[i].forEach(c=>{ const td=document.createElement('td'); td.textContent=c||''; tr.appendChild(td); });
            tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        container.classList.toggle('hidden', rows.length===0);
    }

    const picker = $('#picker');
    const runBtn = $('#run');
    const downloadBtn = $('#download');
    const summary = $('#summary');
    let files=[]; let output=[];

    picker.addEventListener('change', ()=>{
        logBox.innerHTML=''; output=[]; summary.textContent='';
        files = Array.from(picker.files).filter(f=>/\.html?$/i.test(f.name)).sort((a,b)=>a.name.localeCompare(b.name));
        if (!files.length){ log('æœªé€‰æ‹©åˆ° HTML æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹© view-sourceã€‚', '#b00020'); runBtn.disabled=true; downloadBtn.disabled=true; return; }
        log(`å·²é€‰æ‹© ${files.length} ä¸ª HTML æ–‡ä»¶ã€‚`, '#0a7d33');
        runBtn.disabled=false; downloadBtn.disabled=true; $('#preview').classList.add('hidden');
    });

    runBtn.addEventListener('click', async ()=>{
        runBtn.disabled=true; downloadBtn.disabled=true; output=[]; $('#preview').classList.add('hidden');
        const header = ['å¯è¿æ¸¯','ç›®çš„æ¸¯','20GP','20GPæ¶¨è·Œ','40GP','40GPæ¶¨è·Œ'];
        const rows = [header];
        let ok=0, warn=0;

        for (const f of files){
            try{
                const html = await f.text();
                const r = parseFile(f.name, html);
                if (!r.length){ warn++; log(`[æ— æ•°æ®] ${f.name}`, '#b36b00'); }
                else { ok++; log(`[OK] ${f.name} -> ${r.length} è¡Œ`, '#0a7d33'); rows.push(...r); }
            }catch(e){ warn++; log(`[å¤±è´¥] ${f.name}: ${e && e.message? e.message: e}`, '#b00020'); }
        }

        // Merge identical: same origin+dest+20+40 (keep first trend marks)
        const map = new Map();
        for (let i=1;i<rows.length;i++){
            const [o,d,p20,t20,p40,t40] = rows[i];
            const key = [o,d,p20,p40].join('|');
            if (!map.has(key)) map.set(key, [o,d,p20,t20,p40,t40]);
        }
        const merged = [header, ...Array.from(map.values())];
        output = merged;
        renderPreview(merged.slice(1));
        downloadBtn.disabled = merged.length<=1;
        summary.textContent = `å®Œæˆï¼š${ok} æ–‡ä»¶ï¼Œ${warn} æé†’ï¼Œåˆå¹¶å ${merged.length-1} æ¡ã€‚`;
    });

    downloadBtn.addEventListener('click', ()=>{
        if (!output || output.length<=1) return;
        const csv = '\uFEFF'+rowsToCsv(output);
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        downloadBlob(csv, `market-${ts}.csv`, 'text/csv;charset=utf-8');
    });
})();
</script>
</body>
</html>
