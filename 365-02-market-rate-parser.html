<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明日数航 港口行情解析工具</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/tool-styles.css">
    <link rel="stylesheet" href="vendor/parser-styles.css">
    <style>
        /* 页面特定样式（保留与公共样式不同的部分） */
    </style>
    <meta name="color-scheme" content="light dark">
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob:; script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com; connect-src 'self' https://static.cloudflareinsights.com;">
</head>
<body data-page="365-02-market-rate-parser.html">
    <!-- 用户验证模态框 -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>🔐 访问验证</h2>
            <p>为了了解工具使用情况，请填写以下信息</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">姓名 *</label>
                    <input type="text" id="userName" name="userName" placeholder="请输入您的姓名" required autocomplete="name">
                    <div class="auth-error" id="nameError">请输入您的姓名</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">手机号 *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="请输入您的手机号" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">请输入有效的手机号</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">邮箱 *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="请输入您的邮箱地址" required autocomplete="email">
                    <div class="auth-error" id="emailError">请输入有效的邮箱地址</div>
                </div>
                <button type="submit" class="auth-submit-btn">确认并继续</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools365" class="back-home-btn">← 返回首页</a>
            <a href="365-02-market-rate-schedule-README.html" class="readme-btn">使用说明 →</a>
            <h1>明日数航 港口行情解析工具</h1>
            <p>自动解析明日数航港口行情网页，提取价格信息并导出为 CSV 文件</p>
        </div>

        <div class="instructions">
            <h3>📋 使用说明</h3>
            <ol>
                <li><strong>准备工作</strong>：首先需要使用"明日数航 船期网页手动下载工具"下载并保存所有船期网页到 <strong>data/365-view-full</strong> 文件夹中</li>
                <li><strong>选择文件夹</strong>：点击"选择 view-full 文件夹"按钮，选择包含所有 HTML 文件的 <strong>data/365-view-full</strong> 文件夹</li>
                <li><strong>开始解析</strong>：选择文件夹后，点击"开始解析"按钮，工具会自动解析所有 HTML 文件中"同航线其他港口行情"模块的价格信息</li>
                <li><strong>查看结果</strong>：解析完成后，可以在下方预览表格中查看解析结果（最多显示前50条）</li>
                <li><strong>下载 CSV</strong>：确认解析结果无误后，点击"下载 CSV"按钮，将数据保存为 CSV 文件</li>
                <li><strong>结果说明</strong>：CSV 文件包含以下列：启运港、目的港、20GP价格、20GP涨跌（+表示上涨，-表示下跌）、40GP价格、40GP涨跌</li>
                <li><strong>注意事项</strong>：工具会自动合并完全相同的记录（相同启运港+目的港+20GP价格+40GP价格），只保留第一条记录。如果某个网页中没有"同航线其他港口行情"模块，会显示"无行情模块"提示</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        选择 view-full 文件夹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>开始解析</button>
                    <button id="download" class="btn" disabled>下载 CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>提示：解析过程中请勿关闭页面，解析完成后会自动显示统计信息</p>
        </div>
    </div>

    <!-- 使用 Gist 存储系统（用户白名单 + 访问记录） -->
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/parser-utils.js"></script>
    <script>

(function() {
    const $ = (s) => document.querySelector(s);
    const log = createLogger('#log');

    /** CSV utils - 使用 parser-utils.js 中的函数 */
    /** DOM helpers - 使用 parser-utils.js 中的函数 (text, find, findAll) */

    function extractOrigin(doc){
        const el = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
        return el? text(el): '';
    }

    function locateMarketTitles(doc){
        return Array.from(doc.querySelectorAll('.Route_plugin_title'))
            .filter(t => (t.textContent||'').includes('同航线其他港口行情'));
    }

    function parseMarket(doc, fileName){
        const origin = extractOrigin(doc);
        const titles = locateMarketTitles(doc);
        if (!titles.length){
            log(`[无行情模块] ${fileName}`, '#b36b00');
            return [];
        }
        const out = [];
        for (const title of titles){
            // Prefer the immediate next UL with class Route_plugin_price
            let ul = title.nextElementSibling && title.nextElementSibling.matches('ul.Route_plugin_price')
                ? title.nextElementSibling
                : (title.parentElement ? title.parentElement.querySelector('ul.Route_plugin_price') : null);
            if (!ul) continue;
            const items = Array.from(ul.querySelectorAll('li.other-price-li, li[title]'));
            for (const li of items){
                const dest = li.getAttribute('title') || '';
                if (!dest) continue;
                const h6s = Array.from(li.querySelectorAll('h6'));
                const p20Raw = h6s[0]? text(h6s[0]): '';
                const p40Raw = h6s[1]? text(h6s[1]): '';
                const p20m = (p20Raw.match(/-?\d[\d,\.]*/)||[''])[0].replace(/,/g,'');
                const p40m = (p40Raw.match(/-?\d[\d,\.]*/)||[''])[0].replace(/,/g,'');
                const t20 = h6s[0]? (h6s[0].classList.contains('red')? '+': (h6s[0].classList.contains('green')? '-': '')): '';
                const t40 = h6s[1]? (h6s[1].classList.contains('red')? '+': (h6s[1].classList.contains('green')? '-': '')): '';
                if (!p20m && !p40m) continue;
                out.push([origin, dest, p20m, t20, p40m, t40]);
            }
        }
        return out;
    }

    function parseFile(name, textHtml){
        const doc = new DOMParser().parseFromString(textHtml, 'text/html');
        return parseMarket(doc, name);
    }

    /** renderPreview - 使用 parser-utils.js 中的函数 */
    function renderPreviewLocal(rows){
        const headers = ['启运港','目的港','20GP','20GP涨跌','40GP','40GP涨跌'];
        renderPreview(rows, '#preview', '#table', headers, 50);
    }

    const picker = $('#picker');
    const runBtn = $('#run');
    const downloadBtn = $('#download');
    const summary = $('#summary');
    const logBox = $('#log');
    let files=[]; let output=[];

    picker.addEventListener('change', ()=>{
        if (logBox) logBox.innerHTML=''; output=[]; summary.textContent='';
        files = Array.from(picker.files).filter(f=>/\.html?$/i.test(f.name)).sort((a,b)=>a.name.localeCompare(b.name));
        if (!files.length){ log('未选择到 HTML 文件，请重新选择 view-full。', '#b00020'); runBtn.disabled=true; downloadBtn.disabled=true; return; }
        log(`已选择 ${files.length} 个 HTML 文件。`, '#0a7d33');
        runBtn.disabled=false; downloadBtn.disabled=true; $('#preview').classList.add('hidden');
    });

    runBtn.addEventListener('click', async ()=>{
        runBtn.disabled=true; downloadBtn.disabled=true; output=[]; $('#preview').classList.add('hidden');
        const header = ['启运港','目的港','20GP','20GP涨跌','40GP','40GP涨跌'];
        const rows = [header];
        let ok=0, warn=0;

        for (const f of files){
            try{
                const html = await f.text();
                const r = parseFile(f.name, html);
                if (!r.length){ warn++; log(`[无数据] ${f.name}`, '#b36b00'); }
                else { ok++; log(`[OK] ${f.name} -> ${r.length} 行`, '#0a7d33'); rows.push(...r); }
            }catch(e){ warn++; log(`[失败] ${f.name}: ${e && e.message? e.message: e}`, '#b00020'); }
        }

        // Merge identical: same origin+dest+20+40 (keep first trend marks)
        const map = new Map();
        for (let i=1;i<rows.length;i++){
            const [o,d,p20,t20,p40,t40] = rows[i];
            const key = [o,d,p20,p40].join('|');
            if (!map.has(key)) map.set(key, [o,d,p20,t20,p40,t40]);
        }
        const merged = [header, ...Array.from(map.values())];
        output = merged;
        renderPreviewLocal(merged.slice(1));
        downloadBtn.disabled = merged.length<=1;
        summary.textContent = `完成：${ok} 文件，${warn} 提醒，合并后 ${merged.length-1} 条。`;
    });

    downloadBtn.addEventListener('click', ()=>{
        if (!output || output.length<=1) return;
        const csv = '\uFEFF'+rowsToCsv(output);
        downloadBlob(csv, generateTimestampFilename('market'), 'text/csv;charset=utf-8');
    });
})();
</script>
    </div>
    <div class="page-footer">
        <h2>明日数航 市场运价解析工具使用声明</h2>
        <p>本工具用于解析从明日数航（hangyun365.com）下载的市场运价网页，提取航线、运价等信息并导出为 CSV 文件。</p>
        <p>所有数据来源于明日数航公开信息，解析结果仅供内部使用，请遵守明日数航的使用条款和版权规定。</p>
    </div>
</body>
</html>
