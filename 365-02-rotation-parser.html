<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明日数航 航线路径解析工具</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/auth-gist.js"></script>
</head>
<body data-page="365-02-rotation-parser.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片，沿用 dashboard 风格 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>明日数航 航线路径解析工具</h2>
                            <p>自动解析明日数航航线网页，提取航线信息和官方路径并导出为 CSV 文件</p>
                        </div>
                        <div class="section-intro-actions">
                            <a href="dashboard.html?tab=tools365" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="365-02-market-rate-schedule-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 解析工具主区域 -->
                <div class="card-white mt-20">
                    <div class="controls">
                        <label class="file-btn" aria-label="选择包含HTML文件的文件夹">
                            选择 view-full 文件夹
                            <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm" aria-label="选择文件夹">
                        </label>
                        <button id="run" class="btn btn-sweep-blue" disabled aria-label="开始解析HTML文件">开始解析</button>
                        <button id="download" class="btn btn-sweep-blue" disabled aria-label="下载CSV文件">下载 CSV</button>
                        <span id="summary" role="status" aria-live="polite"></span>
                    </div>
                    <div id="log" class="log" aria-live="polite" role="log" aria-label="解析日志"></div>
                    <div id="preview" class="hidden" role="region" aria-label="解析结果预览">
                        <table id="table" role="table" aria-label="解析结果表格"></table>
                    </div>
                </div>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">明日数航 航线路径解析工具使用声明</h2>
                    <p class="usage-statement-text">本工具用于解析从明日数航（hangyun365.com）下载的船期网页，提取航线信息和官方路径并导出为 CSV 文件。</p>
                    <p class="usage-statement-text">所有数据来源于明日数航公开信息，解析结果仅供内部使用，请遵守明日数航的使用条款和版权规定。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/sidebar-loader.js"></script>
    <script src="vendor/parser-utils.js"></script>
    <script>
        init001ToolPage('365-02-rotation-parser.html', 'tools365');
    </script>
    <script>
    (function() {
        /**
         * DOM 选择器辅助函数
         * @param {string} selector - CSS 选择器
         * @returns {HTMLElement|null} 找到的元素
         */
        const selectElement = (selector) => document.querySelector(selector);
        const log = createLogger('#log');

        /** CSV utils - 使用 parser-utils.js 中的函数 */
        /** DOM helpers - 使用 parser-utils.js 中的函数 (text, find, findAll) */

        /** Extract page-level POL/POD */
        function extractPagePolPod(doc) {
            let pagePol = '';
            const polEl = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
            if (polEl) pagePol = text(polEl);

            let pagePod = '';
            const bcnEl = doc.querySelector('.Route_index_title_bcn');
            if (bcnEl) {
                const t = text(bcnEl)
                    .replace(/当前位置：/g, '')
                    .replace(/\s+/g, ' ');
                const matches = t.match(/[\u4e00-\u9fa5A-Za-z]+/g);
                if (matches && matches.length) {
                    const blacklist = new Set(['当前位置', '明日数航', '船期查询']);
                    const parts = matches.filter(w => !blacklist.has(w));
                    if (parts.length >= 1) {
                        pagePod = parts.join('/');
                    } else {
                        pagePod = matches[matches.length - 1];
                    }
                }
            }
            return { pagePol, pagePod };
        }

        /** Parse rotation path */
        function parseRotationPath(rotationBox) {
            if (!rotationBox) return { forward: '', reverse: '', midTime: '' };

            // Forward path (SA_rotation_list1)
            const forwardList = find(rotationBox, '.SA_rotation_list1');
            const forwardItems = forwardList ? findAll(forwardList, '.SA_rotation_item') : [];
            const forwardPath = [];
            for (const item of forwardItems) {
                const port = find(item, '.SA_rotation_port');
                const cnName = port ? text(find(port, 'h1')) : '';
                const enName = port ? text(find(port, 'h2')) : '';
                const time = text(find(item, '.SA_rotation_tt h5'));
                const portStr = cnName + (enName ? `(${enName})` : '');
                forwardPath.push(portStr + (time ? `[${time}]` : ''));
            }

            // Reverse path (SA_rotation_list2)
            const reverseList = find(rotationBox, '.SA_rotation_list2');
            const reverseItems = reverseList ? findAll(reverseList, '.SA_rotation_item') : [];
            const reversePath = [];
            for (const item of reverseItems) {
                const port = find(item, '.SA_rotation_port');
                const cnName = port ? text(find(port, 'h1')) : '';
                const enName = port ? text(find(port, 'h2')) : '';
                const time = text(find(item, '.SA_rotation_tt h5'));
                const portStr = cnName + (enName ? `(${enName})` : '');
                reversePath.push(portStr + (time ? `[${time}]` : ''));
            }

            // Middle time (SA_rotation_list3)
            const midEl = find(rotationBox, '.SA_rotation_list3 .SA_rotation_mid h5');
            const midTime = midEl ? text(midEl) : '';

            return {
                forward: forwardPath.join(' → '),
                reverse: reversePath.join(' → '),
                midTime: midTime
            };
        }

        /** Parse one route group */
        function parseRouteGroup(groupDiv, pagePol, pagePod) {
            const groupId = groupDiv.getAttribute('group_id') || '';
            
            // Extract carriers from .Route_notice_item11 span (same as schedule-parser)
            // Format: "亚海航运(CVT2) | 外运集运(CVTS) | 森罗商船(CVT) | 泛洋(CVT)"
            const nonstop = find(groupDiv, '.Route_list.nonstop-div');
            let carriers = '';
            if (nonstop) {
                const coSpan = find(nonstop, '.Route_notice_item11 span');
                carriers = coSpan ? text(coSpan) : '';
            }
            
            // Fallback to data-carrier if Route_notice_item11 not found
            if (!carriers) {
                const carrierAttr = groupDiv.getAttribute('data-carrier') || '';
                const carrierMatches = carrierAttr.match(/\(([^)]+)\)/g) || [];
                carriers = carrierMatches
                    .map(m => m.replace(/[()]/g, ''))
                    .filter(c => c.trim())
                    .join(' | ');
            }

            // Find the rotation section
            // The SA_rotation is inside the dd-notice-div or in siblings before next dd-notice-div
            let rotationBox = null;
            
            // First try to find it within the group div
            rotationBox = find(groupDiv, '.SA_rotation .SA_rotation_box');
            
            // If not found, search in following siblings until next dd-notice-div
            if (!rotationBox) {
                let next = groupDiv.nextElementSibling;
                while (next) {
                    if (next.matches && next.matches('.dd-notice-div')) {
                        break; // Stop at next route group
                    }
                    rotationBox = find(next, '.SA_rotation .SA_rotation_box');
                    if (rotationBox) break;
                    next = next.nextElementSibling;
                }
            }

            const { forward, reverse, midTime } = parseRotationPath(rotationBox);

            return {
                pagePol,
                pagePod,
                groupId,
                carriers,
                forward,
                reverse,
                midTime
            };
        }

        /** Parse HTML file */
        function parseHtml(fileName, htmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            const { pagePol, pagePod } = extractPagePolPod(doc);

            // Find all route groups (dd-notice-div with group_id)
            const groups = Array.from(doc.querySelectorAll('div.dd-notice-div[group_id]'));
            if (groups.length === 0) {
                log(`[跳过] 未找到航线组: ${fileName}`, '#b36b00');
                return [];
            }

            const allRows = [];
            for (const group of groups) {
                const route = parseRouteGroup(group, pagePol, pagePod);
                allRows.push([
                    route.pagePol,
                    route.pagePod,
                    route.groupId,
                    route.carriers,
                    route.forward,
                    route.reverse,
                    route.midTime
                ]);
            }
            return allRows;
        }

        /** 列索引常量 - 用于提高代码可读性和可维护性 */
        const ROTATION_COLUMN_INDEX = {
            ORIGIN_PORT: 0,        // 启运港
            DESTINATION_PORT: 1,   // 目的港
            ROUTE_ID: 2,          // 航线ID
            CARRIERS: 3,          // 共舱船公司
            FORWARD_PATH: 4,       // 正向路径
            REVERSE_PATH: 5,      // 反向路径
            MID_TIME: 6           // 中间时间
        };

        /**
         * 合并共舱船公司字段，取最长的值
         * @param {string} existing - 现有的共舱船公司
         * @param {string} current - 当前的共舱船公司
         * @returns {string} 合并后的共舱船公司
         */
        function mergeCarriers(existing, current) {
            const existingValue = existing || '';
            const currentValue = current || '';
            return currentValue.length > existingValue.length ? currentValue : existingValue;
        }

        /**
         * 合并字段值：如果现有为空则使用新值，如果都有且 preferLonger 为 true 则取较长的
         * @param {string} existing - 现有值
         * @param {string} current - 当前值
         * @param {boolean} preferLonger - 是否优先取较长的值
         * @returns {string} 合并后的值
         */
        function mergeField(existing, current, preferLonger = false) {
            const existingValue = existing || '';
            const currentValue = current || '';
            
            if (!existingValue && currentValue) {
                return currentValue;
            }
            if (preferLonger && currentValue.length > existingValue.length) {
                return currentValue;
            }
            return existingValue;
        }

        /**
         * 合并单行数据到现有记录
         * @param {Array} existing - 现有记录
         * @param {Array} current - 当前记录
         */
        function mergeRowData(existing, current) {
            // 共舱船公司：取最长的值
            existing[ROTATION_COLUMN_INDEX.CARRIERS] = mergeCarriers(
                existing[ROTATION_COLUMN_INDEX.CARRIERS],
                current[ROTATION_COLUMN_INDEX.CARRIERS]
            );
            
            if (!existing[ROTATION_COLUMN_INDEX.ORIGIN_PORT] && current[ROTATION_COLUMN_INDEX.ORIGIN_PORT]) {
                existing[ROTATION_COLUMN_INDEX.ORIGIN_PORT] = current[ROTATION_COLUMN_INDEX.ORIGIN_PORT];
            }
            
            if (!existing[ROTATION_COLUMN_INDEX.DESTINATION_PORT] && current[ROTATION_COLUMN_INDEX.DESTINATION_PORT]) {
                existing[ROTATION_COLUMN_INDEX.DESTINATION_PORT] = current[ROTATION_COLUMN_INDEX.DESTINATION_PORT];
            }
            
            existing[ROTATION_COLUMN_INDEX.FORWARD_PATH] = mergeField(
                existing[ROTATION_COLUMN_INDEX.FORWARD_PATH],
                current[ROTATION_COLUMN_INDEX.FORWARD_PATH],
                true
            );
            
            existing[ROTATION_COLUMN_INDEX.REVERSE_PATH] = mergeField(
                existing[ROTATION_COLUMN_INDEX.REVERSE_PATH],
                current[ROTATION_COLUMN_INDEX.REVERSE_PATH],
                true
            );
            
            if (!existing[ROTATION_COLUMN_INDEX.MID_TIME] && current[ROTATION_COLUMN_INDEX.MID_TIME]) {
                existing[ROTATION_COLUMN_INDEX.MID_TIME] = current[ROTATION_COLUMN_INDEX.MID_TIME];
            }
        }

        /**
         * 按航线ID合并记录，共舱船公司取最长的值
         * @param {Array<Array>} rows - 行数据数组
         * @returns {Array<Array>} 合并后的行数据数组
         */
        function mergeByRouteId(rows) {
            if (!Array.isArray(rows) || rows.length === 0) {
                return [];
            }
            
            const routeMap = new Map();
            
            for (const row of rows) {
                if (!Array.isArray(row) || row.length === 0) {
                    continue;
                }
                
                const routeId = row[ROTATION_COLUMN_INDEX.ROUTE_ID];
                if (!routeId) {
                    continue;
                }
                
                if (!routeMap.has(routeId)) {
                    routeMap.set(routeId, [...row]);
                } else {
                    const existing = routeMap.get(routeId);
                    mergeRowData(existing, row);
                }
            }
            
            return Array.from(routeMap.values());
        }

        /** Table preview - 使用 parser-utils.js 中的函数 */
        function renderPreviewLocal(rows, container, table) {
            const headers = [
                '启运港', '目的港', '航线ID', '共舱船公司', '正向路径', '反向路径', '中间时间'
            ];
            renderPreview(rows, container, table, headers, 50);
        }

        /** Main flow */
        const picker = selectElement('#picker');
        const runBtn = selectElement('#run');
        const downloadBtn = selectElement('#download');
        const summary = selectElement('#summary');
        const preview = selectElement('#preview');
        const table = selectElement('#table');

        let selectedFiles = [];
        let outputRows = [];

        picker.addEventListener('change', () => {
            const logBox = document.querySelector('#log');
            if (logBox) logBox.innerHTML = '';
            outputRows = [];
            preview.classList.add('hidden');
            selectedFiles = Array.from(picker.files).filter(f => /\.html?$/i.test(f.name));
            if (selectedFiles.length === 0) {
                log('未选择到 HTML 文件，请重新选择 view-full 文件夹。', '#b00020');
                runBtn.disabled = true;
                downloadBtn.disabled = true;
                summary.textContent = '';
                return;
            }
            selectedFiles.sort((a, b) => a.name.localeCompare(b.name));
            log(`已选择 ${selectedFiles.length} 个 HTML 文件。`, '#0a7d33');
            runBtn.disabled = false;
            downloadBtn.disabled = true;
            summary.textContent = '';
        });

        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            downloadBtn.disabled = true;
            outputRows = [];
            preview.classList.add('hidden');
            table.innerHTML = '';
            summary.textContent = '';
            log('开始解析...', '');

            // Header row
            const header = ['启运港', '目的港', '航线ID', '共舱船公司', '正向路径', '反向路径', '中间时间'];
            const all = [];

            let fileOk = 0, fileWarn = 0;
            for (const f of selectedFiles) {
                try {
                    const txt = await f.text();
                    const rows = parseHtml(f.name, txt);
                    if (rows.length === 0) { fileWarn++; log(`[无数据] ${f.name}`, '#b36b00'); }
                    else { fileOk++; log(`[OK] ${f.name} -> ${rows.length} 条航线`, '#0a7d33'); }
                    for (const r of rows) all.push(r);
                } catch (e) {
                    fileWarn++;
                    log(`[失败] ${f.name}: ${e && e.message ? e.message : e}`, '#b00020');
                }
            }

            // 按航线ID合并，共舱船公司取最长的值
            log('开始按航线ID合并...', '');
            const merged = mergeByRouteId(all);
            const originalCount = all.length;
            const mergedCount = merged.length;

            outputRows = [header, ...merged];
            renderPreviewLocal(merged, preview, table);
            downloadBtn.disabled = merged.length === 0;
            summary.textContent = `完成：${fileOk} 个文件，${fileWarn} 个提醒，原始 ${originalCount} 条，合并后 ${mergedCount} 条航线。`;
        });

        downloadBtn.addEventListener('click', () => {
            if (!outputRows || outputRows.length <= 1) return;
            const csv = '\uFEFF' + rowsToCsv(outputRows); // BOM for Excel UTF-8
            downloadBlob(csv, generateTimestampFilename('route-rotation'), 'text/csv;charset=utf-8');
        });
    })();
    </script>
</body>
</html>
