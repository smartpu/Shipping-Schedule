<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明日数航 航线路径解析工具</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/tool-styles.css">
    <link rel="stylesheet" href="vendor/parser-styles.css">
    <style>
        /* 页面特定样式（保留与公共样式不同的部分） */
        /* 注意：.btn[disabled] 样式已在 common-styles.css 中定义，此处不再重复 */
    </style>
    <meta name="color-scheme" content="light dark">
</head>
<body data-page="365-02-rotation-parser.html">
    <!-- 用户验证模态框 -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>🔐 访问验证</h2>
            <p>为了了解工具使用情况，请填写以下信息</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">姓名 *</label>
                    <input type="text" id="userName" name="userName" placeholder="请输入您的姓名" required autocomplete="name">
                    <div class="auth-error" id="nameError">请输入您的姓名</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">手机号 *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="请输入您的手机号" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">请输入有效的手机号</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">邮箱 *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="请输入您的邮箱地址" required autocomplete="email">
                    <div class="auth-error" id="emailError">请输入有效的邮箱地址</div>
                </div>
                <button type="submit" class="auth-submit-btn">确认并继续</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools365" class="back-home-btn">← 返回首页</a>
            <a href="365-02-market-rate-schedule-README.html" class="readme-btn">使用说明 →</a>
            <h1>明日数航 航线路径解析工具</h1>
            <p>自动解析明日数航航线网页，提取航线信息和官方路径并导出为 CSV 文件</p>
        </div>

        <div class="instructions">
            <h3>📋 使用说明</h3>
            <ol>
                <li><strong>准备工作</strong>：首先需要使用"明日数航 船期网页手动下载工具"下载并保存所有船期网页到 <strong>365-view-full</strong> 文件夹中</li>
                <li><strong>选择文件夹</strong>：点击"选择 view-full 文件夹"按钮，选择包含所有 HTML 文件的 <strong>365-view-full</strong> 文件夹</li>
                <li><strong>开始解析</strong>：选择文件夹后，点击"开始解析"按钮，工具会自动解析所有 HTML 文件中的航线信息和官方路径</li>
                <li><strong>查看结果</strong>：解析完成后，可以在下方预览表格中查看解析结果（最多显示前50条）</li>
                <li><strong>下载 CSV</strong>：确认解析结果无误后，点击"下载 CSV"按钮，将数据保存为 CSV 文件</li>
                <li><strong>结果说明</strong>：CSV 文件包含以下列：启运港、目的港、航线ID、共舱船公司、正向路径、反向路径、中间时间</li>
                <li><strong>注意事项</strong>：工具会自动从网页中提取每个航线的 group_id、共舱船公司和官方路径信息。如果某个航线没有官方路径，相关字段将为空</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        选择 view-full 文件夹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>开始解析</button>
                    <button id="download" class="btn" disabled>下载 CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>提示：解析过程中请勿关闭页面，解析完成后会自动显示统计信息</p>
        </div>
    </div>

    <!-- 使用 Gist 存储系统（用户白名单 + 访问记录） -->
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/parser-utils.js"></script>
    <script>
    (function() {
        /** Utility: log area - 使用 parser-utils.js */
        const $ = (sel) => document.querySelector(sel);
        const log = createLogger('#log');

        /** CSV utils - 使用 parser-utils.js 中的函数 */
        /** DOM helpers - 使用 parser-utils.js 中的函数 (text, find, findAll) */

        /** Extract page-level POL/POD */
        function extractPagePolPod(doc) {
            let pagePol = '';
            const polEl = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
            if (polEl) pagePol = text(polEl);

            let pagePod = '';
            const bcnEl = doc.querySelector('.Route_index_title_bcn');
            if (bcnEl) {
                const t = text(bcnEl)
                    .replace(/当前位置：/g, '')
                    .replace(/\s+/g, ' ');
                const matches = t.match(/[\u4e00-\u9fa5A-Za-z]+/g);
                if (matches && matches.length) {
                    const blacklist = new Set(['当前位置', '明日数航', '船期查询']);
                    const parts = matches.filter(w => !blacklist.has(w));
                    if (parts.length >= 1) {
                        pagePod = parts.join('/');
                    } else {
                        pagePod = matches[matches.length - 1];
                    }
                }
            }
            return { pagePol, pagePod };
        }

        /** Parse rotation path */
        function parseRotationPath(rotationBox) {
            if (!rotationBox) return { forward: '', reverse: '', midTime: '' };

            // Forward path (SA_rotation_list1)
            const forwardList = find(rotationBox, '.SA_rotation_list1');
            const forwardItems = forwardList ? findAll(forwardList, '.SA_rotation_item') : [];
            const forwardPath = [];
            for (const item of forwardItems) {
                const port = find(item, '.SA_rotation_port');
                const cnName = port ? text(find(port, 'h1')) : '';
                const enName = port ? text(find(port, 'h2')) : '';
                const time = text(find(item, '.SA_rotation_tt h5'));
                const portStr = cnName + (enName ? `(${enName})` : '');
                forwardPath.push(portStr + (time ? `[${time}]` : ''));
            }

            // Reverse path (SA_rotation_list2)
            const reverseList = find(rotationBox, '.SA_rotation_list2');
            const reverseItems = reverseList ? findAll(reverseList, '.SA_rotation_item') : [];
            const reversePath = [];
            for (const item of reverseItems) {
                const port = find(item, '.SA_rotation_port');
                const cnName = port ? text(find(port, 'h1')) : '';
                const enName = port ? text(find(port, 'h2')) : '';
                const time = text(find(item, '.SA_rotation_tt h5'));
                const portStr = cnName + (enName ? `(${enName})` : '');
                reversePath.push(portStr + (time ? `[${time}]` : ''));
            }

            // Middle time (SA_rotation_list3)
            const midEl = find(rotationBox, '.SA_rotation_list3 .SA_rotation_mid h5');
            const midTime = midEl ? text(midEl) : '';

            return {
                forward: forwardPath.join(' → '),
                reverse: reversePath.join(' → '),
                midTime: midTime
            };
        }

        /** Parse one route group */
        function parseRouteGroup(groupDiv, pagePol, pagePod) {
            const groupId = groupDiv.getAttribute('group_id') || '';
            
            // Extract carriers from .Route_notice_item11 span (same as schedule-parser)
            // Format: "亚海航运(CVT2) | 外运集运(CVTS) | 森罗商船(CVT) | 泛洋(CVT)"
            const nonstop = find(groupDiv, '.Route_list.nonstop-div');
            let carriers = '';
            if (nonstop) {
                const coSpan = find(nonstop, '.Route_notice_item11 span');
                carriers = coSpan ? text(coSpan) : '';
            }
            
            // Fallback to data-carrier if Route_notice_item11 not found
            if (!carriers) {
                const carrierAttr = groupDiv.getAttribute('data-carrier') || '';
                const carrierMatches = carrierAttr.match(/\(([^)]+)\)/g) || [];
                carriers = carrierMatches
                    .map(m => m.replace(/[()]/g, ''))
                    .filter(c => c.trim())
                    .join(' | ');
            }

            // Find the rotation section
            // The SA_rotation is inside the dd-notice-div or in siblings before next dd-notice-div
            let rotationBox = null;
            
            // First try to find it within the group div
            rotationBox = find(groupDiv, '.SA_rotation .SA_rotation_box');
            
            // If not found, search in following siblings until next dd-notice-div
            if (!rotationBox) {
                let next = groupDiv.nextElementSibling;
                while (next) {
                    if (next.matches && next.matches('.dd-notice-div')) {
                        break; // Stop at next route group
                    }
                    rotationBox = find(next, '.SA_rotation .SA_rotation_box');
                    if (rotationBox) break;
                    next = next.nextElementSibling;
                }
            }

            const { forward, reverse, midTime } = parseRotationPath(rotationBox);

            return {
                pagePol,
                pagePod,
                groupId,
                carriers,
                forward,
                reverse,
                midTime
            };
        }

        /** Parse HTML file */
        function parseHtml(fileName, htmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            const { pagePol, pagePod } = extractPagePolPod(doc);

            // Find all route groups (dd-notice-div with group_id)
            const groups = Array.from(doc.querySelectorAll('div.dd-notice-div[group_id]'));
            if (groups.length === 0) {
                log(`[跳过] 未找到航线组: ${fileName}`, '#b36b00');
                return [];
            }

            const allRows = [];
            for (const group of groups) {
                const route = parseRouteGroup(group, pagePol, pagePod);
                allRows.push([
                    route.pagePol,
                    route.pagePod,
                    route.groupId,
                    route.carriers,
                    route.forward,
                    route.reverse,
                    route.midTime
                ]);
            }
            return allRows;
        }

        /** 列索引常量 - 用于提高代码可读性和可维护性 */
        const ROTATION_COLUMN_INDEX = {
            ORIGIN_PORT: 0,        // 启运港
            DESTINATION_PORT: 1,   // 目的港
            ROUTE_ID: 2,          // 航线ID
            CARRIERS: 3,          // 共舱船公司
            FORWARD_PATH: 4,       // 正向路径
            REVERSE_PATH: 5,      // 反向路径
            MID_TIME: 6           // 中间时间
        };

        /**
         * 合并共舱船公司字段，取最长的值
         * @param {string} existing - 现有的共舱船公司
         * @param {string} current - 当前的共舱船公司
         * @returns {string} 合并后的共舱船公司
         */
        function mergeCarriers(existing, current) {
            const existingValue = existing || '';
            const currentValue = current || '';
            return currentValue.length > existingValue.length ? currentValue : existingValue;
        }

        /**
         * 合并字段值：如果现有为空则使用新值，如果都有且 preferLonger 为 true 则取较长的
         * @param {string} existing - 现有值
         * @param {string} current - 当前值
         * @param {boolean} preferLonger - 是否优先取较长的值
         * @returns {string} 合并后的值
         */
        function mergeField(existing, current, preferLonger = false) {
            const existingValue = existing || '';
            const currentValue = current || '';
            
            if (!existingValue && currentValue) {
                return currentValue;
            }
            if (preferLonger && currentValue.length > existingValue.length) {
                return currentValue;
            }
            return existingValue;
        }

        /**
         * 合并单行数据到现有记录
         * @param {Array} existing - 现有记录
         * @param {Array} current - 当前记录
         */
        function mergeRowData(existing, current) {
            // 共舱船公司：取最长的值
            existing[ROTATION_COLUMN_INDEX.CARRIERS] = mergeCarriers(
                existing[ROTATION_COLUMN_INDEX.CARRIERS],
                current[ROTATION_COLUMN_INDEX.CARRIERS]
            );
            
            // 启运港：如果现有为空，使用新的
            if (!existing[ROTATION_COLUMN_INDEX.ORIGIN_PORT] && current[ROTATION_COLUMN_INDEX.ORIGIN_PORT]) {
                existing[ROTATION_COLUMN_INDEX.ORIGIN_PORT] = current[ROTATION_COLUMN_INDEX.ORIGIN_PORT];
            }
            
            // 目的港：如果现有为空，使用新的
            if (!existing[ROTATION_COLUMN_INDEX.DESTINATION_PORT] && current[ROTATION_COLUMN_INDEX.DESTINATION_PORT]) {
                existing[ROTATION_COLUMN_INDEX.DESTINATION_PORT] = current[ROTATION_COLUMN_INDEX.DESTINATION_PORT];
            }
            
            // 正向路径：如果现有为空，使用新的；如果都有，取较长的
            existing[ROTATION_COLUMN_INDEX.FORWARD_PATH] = mergeField(
                existing[ROTATION_COLUMN_INDEX.FORWARD_PATH],
                current[ROTATION_COLUMN_INDEX.FORWARD_PATH],
                true
            );
            
            // 反向路径：如果现有为空，使用新的；如果都有，取较长的
            existing[ROTATION_COLUMN_INDEX.REVERSE_PATH] = mergeField(
                existing[ROTATION_COLUMN_INDEX.REVERSE_PATH],
                current[ROTATION_COLUMN_INDEX.REVERSE_PATH],
                true
            );
            
            // 中间时间：如果现有为空，使用新的
            if (!existing[ROTATION_COLUMN_INDEX.MID_TIME] && current[ROTATION_COLUMN_INDEX.MID_TIME]) {
                existing[ROTATION_COLUMN_INDEX.MID_TIME] = current[ROTATION_COLUMN_INDEX.MID_TIME];
            }
        }

        /**
         * 按航线ID合并记录，共舱船公司取最长的值
         * @param {Array<Array>} rows - 行数据数组
         * @returns {Array<Array>} 合并后的行数据数组
         */
        function mergeByRouteId(rows) {
            if (!Array.isArray(rows) || rows.length === 0) {
                return [];
            }
            
            const routeMap = new Map();
            
            for (const row of rows) {
                if (!Array.isArray(row) || row.length === 0) {
                    continue;
                }
                
                const routeId = row[ROTATION_COLUMN_INDEX.ROUTE_ID];
                if (!routeId) {
                    continue;
                }
                
                if (!routeMap.has(routeId)) {
                    // 首次遇到该航线ID，直接存储
                    routeMap.set(routeId, [...row]);
                } else {
                    // 已存在该航线ID，合并数据
                    const existing = routeMap.get(routeId);
                    mergeRowData(existing, row);
                }
            }
            
            return Array.from(routeMap.values());
        }

        /** Table preview - 使用 parser-utils.js 中的函数 */
        function renderPreviewLocal(rows, container, table) {
            const headers = [
                '启运港', '目的港', '航线ID', '共舱船公司', '正向路径', '反向路径', '中间时间'
            ];
            renderPreview(rows, container, table, headers, 50);
        }

        /** Main flow */
        const picker = $('#picker');
        const runBtn = $('#run');
        const downloadBtn = $('#download');
        const summary = $('#summary');
        const preview = $('#preview');
        const table = $('#table');

        let selectedFiles = [];
        let outputRows = [];

        picker.addEventListener('change', () => {
            const logBox = document.querySelector('#log');
            if (logBox) logBox.innerHTML = '';
            outputRows = [];
            preview.classList.add('hidden');
            selectedFiles = Array.from(picker.files).filter(f => /\.html?$/i.test(f.name));
            if (selectedFiles.length === 0) {
                log('未选择到 HTML 文件，请重新选择 view-full 文件夹。', '#b00020');
                runBtn.disabled = true;
                downloadBtn.disabled = true;
                summary.textContent = '';
                return;
            }
            selectedFiles.sort((a, b) => a.name.localeCompare(b.name));
            log(`已选择 ${selectedFiles.length} 个 HTML 文件。`, '#0a7d33');
            runBtn.disabled = false;
            downloadBtn.disabled = true;
            summary.textContent = '';
        });

        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            downloadBtn.disabled = true;
            outputRows = [];
            preview.classList.add('hidden');
            table.innerHTML = '';
            summary.textContent = '';
            log('开始解析...', '');

            // Header row
            const header = ['启运港', '目的港', '航线ID', '共舱船公司', '正向路径', '反向路径', '中间时间'];
            const all = [];

            let fileOk = 0, fileWarn = 0;
            for (const f of selectedFiles) {
                try {
                    const txt = await f.text();
                    const rows = parseHtml(f.name, txt);
                    if (rows.length === 0) { fileWarn++; log(`[无数据] ${f.name}`, '#b36b00'); }
                    else { fileOk++; log(`[OK] ${f.name} -> ${rows.length} 条航线`, '#0a7d33'); }
                    for (const r of rows) all.push(r);
                } catch (e) {
                    fileWarn++;
                    log(`[失败] ${f.name}: ${e && e.message ? e.message : e}`, '#b00020');
                }
            }

            // 按航线ID合并，共舱船公司取最长的值
            log('开始按航线ID合并...', '');
            const merged = mergeByRouteId(all);
            const originalCount = all.length;
            const mergedCount = merged.length;

            outputRows = [header, ...merged];
            renderPreviewLocal(merged, preview, table);
            downloadBtn.disabled = merged.length === 0;
            summary.textContent = `完成：${fileOk} 个文件，${fileWarn} 个提醒，原始 ${originalCount} 条，合并后 ${mergedCount} 条航线。`;
        });

        downloadBtn.addEventListener('click', () => {
            if (!outputRows || outputRows.length <= 1) return;
            const csv = '\uFEFF' + rowsToCsv(outputRows); // BOM for Excel UTF-8
            downloadBlob(csv, generateTimestampFilename('route-rotation'), 'text/csv;charset=utf-8');
        });
    })();
</script>
    </div>
    <div class="page-footer">
        <h2>明日数航 航线路径解析工具使用声明</h2>
        <p>本工具用于解析从明日数航（hangyun365.com）下载的船期网页，提取航线信息和官方路径并导出为 CSV 文件。</p>
        <p>所有数据来源于明日数航公开信息，解析结果仅供内部使用，请遵守明日数航的使用条款和版权规定。</p>
    </div>
</body>
</html>

