<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜æ—¥æ•°èˆª èˆªçº¿è·¯å¾„è§£æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #333;
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .instructions {
            padding: 25px 40px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px 40px;
            border-radius: 8px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #856404;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .instructions strong {
            color: #856404;
        }

        .content {
            padding: 20px 40px 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .file-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .file-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .file-btn input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn[disabled] {
            background: #d2d2d7;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #summary {
            color: #6c757d;
            font-size: 14px;
            margin-left: 10px;
        }

        .log {
            margin-top: 15px;
            background: #fafafa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        #preview {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #e9ecef;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f7f7f9;
            z-index: 1;
            font-weight: 600;
            color: #495057;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .footer {
            padding: 20px 40px;
            background: #f8f9fa;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }
    </style>
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ˜æ—¥æ•°èˆª èˆªçº¿è·¯å¾„è§£æå·¥å…·</h1>
            <p>è‡ªåŠ¨è§£ææ˜æ—¥æ•°èˆªèˆªçº¿ç½‘é¡µï¼Œæå–èˆªçº¿ä¿¡æ¯å’Œå®˜æ–¹è·¯å¾„å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶</p>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li><strong>å‡†å¤‡å·¥ä½œ</strong>ï¼šé¦–å…ˆéœ€è¦ä½¿ç”¨"æ˜æ—¥æ•°èˆª èˆ¹æœŸç½‘é¡µæ‰‹åŠ¨ä¸‹è½½å·¥å…·"ä¸‹è½½å¹¶ä¿å­˜æ‰€æœ‰èˆ¹æœŸç½‘é¡µåˆ° <strong>365-view-full</strong> æ–‡ä»¶å¤¹ä¸­</li>
                <li><strong>é€‰æ‹©æ–‡ä»¶å¤¹</strong>ï¼šç‚¹å‡»"é€‰æ‹© view-full æ–‡ä»¶å¤¹"æŒ‰é’®ï¼Œé€‰æ‹©åŒ…å«æ‰€æœ‰ HTML æ–‡ä»¶çš„ <strong>365-view-full</strong> æ–‡ä»¶å¤¹</li>
                <li><strong>å¼€å§‹è§£æ</strong>ï¼šé€‰æ‹©æ–‡ä»¶å¤¹åï¼Œç‚¹å‡»"å¼€å§‹è§£æ"æŒ‰é’®ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è§£ææ‰€æœ‰ HTML æ–‡ä»¶ä¸­çš„èˆªçº¿ä¿¡æ¯å’Œå®˜æ–¹è·¯å¾„</li>
                <li><strong>æŸ¥çœ‹ç»“æœ</strong>ï¼šè§£æå®Œæˆåï¼Œå¯ä»¥åœ¨ä¸‹æ–¹é¢„è§ˆè¡¨æ ¼ä¸­æŸ¥çœ‹è§£æç»“æœï¼ˆæœ€å¤šæ˜¾ç¤ºå‰50æ¡ï¼‰</li>
                <li><strong>ä¸‹è½½ CSV</strong>ï¼šç¡®è®¤è§£æç»“æœæ— è¯¯åï¼Œç‚¹å‡»"ä¸‹è½½ CSV"æŒ‰é’®ï¼Œå°†æ•°æ®ä¿å­˜ä¸º CSV æ–‡ä»¶</li>
                <li><strong>ç»“æœè¯´æ˜</strong>ï¼šCSV æ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—ï¼šå¯è¿æ¸¯ã€ç›®çš„æ¸¯ã€èˆªçº¿IDã€å…±èˆ±èˆ¹å…¬å¸ã€æ­£å‘è·¯å¾„ã€åå‘è·¯å¾„ã€ä¸­é—´æ—¶é—´</li>
                <li><strong>æ³¨æ„äº‹é¡¹</strong>ï¼šå·¥å…·ä¼šè‡ªåŠ¨ä»ç½‘é¡µä¸­æå–æ¯ä¸ªèˆªçº¿çš„ group_idã€å…±èˆ±èˆ¹å…¬å¸å’Œå®˜æ–¹è·¯å¾„ä¿¡æ¯ã€‚å¦‚æœæŸä¸ªèˆªçº¿æ²¡æœ‰å®˜æ–¹è·¯å¾„ï¼Œç›¸å…³å­—æ®µå°†ä¸ºç©º</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        é€‰æ‹© view-full æ–‡ä»¶å¤¹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>å¼€å§‹è§£æ</button>
                    <button id="download" class="btn" disabled>ä¸‹è½½ CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>æç¤ºï¼šè§£æè¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢ï¼Œè§£æå®Œæˆåä¼šè‡ªåŠ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</p>
        </div>
    </div>

<script>
    (function() {
        /** Utility: log area */
        const $ = (sel) => document.querySelector(sel);
        const logBox = $('#log');
        function log(msg, cls) {
            const line = document.createElement('div');
            if (cls) line.style.color = cls;
            line.textContent = msg;
            logBox.appendChild(line);
            logBox.scrollTop = logBox.scrollHeight;
        }

        /** CSV utils */
        function toCsvCell(v) {
            if (v == null) return '';
            const s = String(v);
            if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
            return s;
        }
        function rowsToCsv(rows) {
            return rows.map(r => r.map(toCsvCell).join(',')).join('\n');
        }
        function downloadBlob(content, name, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = name; a.click();
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        }

        /** Parse helpers */
        function text(el) { return el ? (el.textContent || '').trim() : ''; }
        function find(el, sel) { return el ? el.querySelector(sel) : null; }
        function findAll(el, sel) { return el ? Array.from(el.querySelectorAll(sel)) : []; }

        /** Extract page-level POL/POD */
        function extractPagePolPod(doc) {
            let pagePol = '';
            const polEl = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
            if (polEl) pagePol = text(polEl);

            let pagePod = '';
            const bcnEl = doc.querySelector('.Route_index_title_bcn');
            if (bcnEl) {
                const t = text(bcnEl)
                    .replace(/å½“å‰ä½ç½®ï¼š/g, '')
                    .replace(/\s+/g, ' ');
                const matches = t.match(/[\u4e00-\u9fa5A-Za-z]+/g);
                if (matches && matches.length) {
                    const blacklist = new Set(['å½“å‰ä½ç½®', 'æ˜æ—¥æ•°èˆª', 'èˆ¹æœŸæŸ¥è¯¢']);
                    const parts = matches.filter(w => !blacklist.has(w));
                    if (parts.length >= 1) {
                        pagePod = parts.join('/');
                    } else {
                        pagePod = matches[matches.length - 1];
                    }
                }
            }
            return { pagePol, pagePod };
        }

        /** Parse rotation path */
        function parseRotationPath(rotationBox) {
            if (!rotationBox) return { forward: '', reverse: '', midTime: '' };

            // Forward path (SA_rotation_list1)
            const forwardList = find(rotationBox, '.SA_rotation_list1');
            const forwardItems = forwardList ? findAll(forwardList, '.SA_rotation_item') : [];
            const forwardPath = [];
            for (const item of forwardItems) {
                const port = find(item, '.SA_rotation_port');
                const cnName = port ? text(find(port, 'h1')) : '';
                const enName = port ? text(find(port, 'h2')) : '';
                const time = text(find(item, '.SA_rotation_tt h5'));
                const portStr = cnName + (enName ? `(${enName})` : '');
                forwardPath.push(portStr + (time ? `[${time}]` : ''));
            }

            // Reverse path (SA_rotation_list2)
            const reverseList = find(rotationBox, '.SA_rotation_list2');
            const reverseItems = reverseList ? findAll(reverseList, '.SA_rotation_item') : [];
            const reversePath = [];
            for (const item of reverseItems) {
                const port = find(item, '.SA_rotation_port');
                const cnName = port ? text(find(port, 'h1')) : '';
                const enName = port ? text(find(port, 'h2')) : '';
                const time = text(find(item, '.SA_rotation_tt h5'));
                const portStr = cnName + (enName ? `(${enName})` : '');
                reversePath.push(portStr + (time ? `[${time}]` : ''));
            }

            // Middle time (SA_rotation_list3)
            const midEl = find(rotationBox, '.SA_rotation_list3 .SA_rotation_mid h5');
            const midTime = midEl ? text(midEl) : '';

            return {
                forward: forwardPath.join(' â†’ '),
                reverse: reversePath.join(' â†’ '),
                midTime: midTime
            };
        }

        /** Parse one route group */
        function parseRouteGroup(groupDiv, pagePol, pagePod) {
            const groupId = groupDiv.getAttribute('group_id') || '';
            
            // Extract carriers from .Route_notice_item11 span (same as schedule-parser)
            // Format: "äºšæµ·èˆªè¿(CVT2) | å¤–è¿é›†è¿(CVTS) | æ£®ç½—å•†èˆ¹(CVT) | æ³›æ´‹(CVT)"
            const nonstop = find(groupDiv, '.Route_list.nonstop-div');
            let carriers = '';
            if (nonstop) {
                const coSpan = find(nonstop, '.Route_notice_item11 span');
                carriers = coSpan ? text(coSpan) : '';
            }
            
            // Fallback to data-carrier if Route_notice_item11 not found
            if (!carriers) {
                const carrierAttr = groupDiv.getAttribute('data-carrier') || '';
                const carrierMatches = carrierAttr.match(/\(([^)]+)\)/g) || [];
                carriers = carrierMatches
                    .map(m => m.replace(/[()]/g, ''))
                    .filter(c => c.trim())
                    .join(' | ');
            }

            // Find the rotation section
            // The SA_rotation is inside the dd-notice-div or in siblings before next dd-notice-div
            let rotationBox = null;
            
            // First try to find it within the group div
            rotationBox = find(groupDiv, '.SA_rotation .SA_rotation_box');
            
            // If not found, search in following siblings until next dd-notice-div
            if (!rotationBox) {
                let next = groupDiv.nextElementSibling;
                while (next) {
                    if (next.matches && next.matches('.dd-notice-div')) {
                        break; // Stop at next route group
                    }
                    rotationBox = find(next, '.SA_rotation .SA_rotation_box');
                    if (rotationBox) break;
                    next = next.nextElementSibling;
                }
            }

            const { forward, reverse, midTime } = parseRotationPath(rotationBox);

            return {
                pagePol,
                pagePod,
                groupId,
                carriers,
                forward,
                reverse,
                midTime
            };
        }

        /** Parse HTML file */
        function parseHtml(fileName, htmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            const { pagePol, pagePod } = extractPagePolPod(doc);

            // Find all route groups (dd-notice-div with group_id)
            const groups = Array.from(doc.querySelectorAll('div.dd-notice-div[group_id]'));
            if (groups.length === 0) {
                log(`[è·³è¿‡] æœªæ‰¾åˆ°èˆªçº¿ç»„: ${fileName}`, '#b36b00');
                return [];
            }

            const allRows = [];
            for (const group of groups) {
                const route = parseRouteGroup(group, pagePol, pagePod);
                allRows.push([
                    route.pagePol,
                    route.pagePod,
                    route.groupId,
                    route.carriers,
                    route.forward,
                    route.reverse,
                    route.midTime
                ]);
            }
            return allRows;
        }

        /** Table preview */
        function renderPreview(rows, container, table) {
            const headers = [
                'å¯è¿æ¸¯', 'ç›®çš„æ¸¯', 'èˆªçº¿ID', 'å…±èˆ±èˆ¹å…¬å¸', 'æ­£å‘è·¯å¾„', 'åå‘è·¯å¾„', 'ä¸­é—´æ—¶é—´'
            ];
            table.innerHTML = '';
            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const maxRows = Math.min(rows.length, 50); // limit preview
            for (let i = 0; i < maxRows; i++) {
                const tr = document.createElement('tr');
                rows[i].forEach(c => { const td = document.createElement('td'); td.textContent = c || ''; tr.appendChild(td); });
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            container.classList.toggle('hidden', rows.length === 0);
        }

        /** Main flow */
        const picker = $('#picker');
        const runBtn = $('#run');
        const downloadBtn = $('#download');
        const summary = $('#summary');
        const preview = $('#preview');
        const table = $('#table');

        let selectedFiles = [];
        let outputRows = [];

        picker.addEventListener('change', () => {
            logBox.innerHTML = '';
            outputRows = [];
            preview.classList.add('hidden');
            selectedFiles = Array.from(picker.files).filter(f => /\.html?$/i.test(f.name));
            if (selectedFiles.length === 0) {
                log('æœªé€‰æ‹©åˆ° HTML æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹© view-full æ–‡ä»¶å¤¹ã€‚', '#b00020');
                runBtn.disabled = true;
                downloadBtn.disabled = true;
                summary.textContent = '';
                return;
            }
            selectedFiles.sort((a, b) => a.name.localeCompare(b.name));
            log(`å·²é€‰æ‹© ${selectedFiles.length} ä¸ª HTML æ–‡ä»¶ã€‚`, '#0a7d33');
            runBtn.disabled = false;
            downloadBtn.disabled = true;
            summary.textContent = '';
        });

        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            downloadBtn.disabled = true;
            outputRows = [];
            preview.classList.add('hidden');
            table.innerHTML = '';
            summary.textContent = '';
            log('å¼€å§‹è§£æ...', '');

            // Header row
            const header = ['å¯è¿æ¸¯', 'ç›®çš„æ¸¯', 'èˆªçº¿ID', 'å…±èˆ±èˆ¹å…¬å¸', 'æ­£å‘è·¯å¾„', 'åå‘è·¯å¾„', 'ä¸­é—´æ—¶é—´'];
            const all = [header];

            let fileOk = 0, fileWarn = 0;
            for (const f of selectedFiles) {
                try {
                    const txt = await f.text();
                    const rows = parseHtml(f.name, txt);
                    if (rows.length === 0) { fileWarn++; log(`[æ— æ•°æ®] ${f.name}`, '#b36b00'); }
                    else { fileOk++; log(`[OK] ${f.name} -> ${rows.length} æ¡èˆªçº¿`, '#0a7d33'); }
                    for (const r of rows) all.push(r);
                } catch (e) {
                    fileWarn++;
                    log(`[å¤±è´¥] ${f.name}: ${e && e.message ? e.message : e}`, '#b00020');
                }
            }

            outputRows = all;
            renderPreview(all.slice(1), preview, table);
            downloadBtn.disabled = all.length <= 1;
            summary.textContent = `å®Œæˆï¼š${fileOk} ä¸ªæ–‡ä»¶ï¼Œ${fileWarn} ä¸ªæé†’ï¼Œå…± ${all.length - 1} æ¡èˆªçº¿ã€‚`;
        });

        downloadBtn.addEventListener('click', () => {
            if (!outputRows || outputRows.length <= 1) return;
            const csv = '\uFEFF' + rowsToCsv(outputRows); // BOM for Excel UTF-8
            const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            downloadBlob(csv, `route-rotation-${ts}.csv`, 'text/csv;charset=utf-8');
        });
    })();
</script>
</body>
</html>

