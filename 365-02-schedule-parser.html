<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜æ—¥æ•°èˆª èˆ¹æœŸè§£æå·¥å…·</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/tool-styles.css">
    <link rel="stylesheet" href="vendor/parser-styles.css">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ï¼ˆä¿ç•™ä¸å…¬å…±æ ·å¼ä¸åŒçš„éƒ¨åˆ†ï¼‰ */
        
        /* èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–æ¨¡æ€æ¡†æ ·å¼ */
        .vessel-voyage-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .vessel-voyage-modal.hidden {
            display: none;
        }
        
        .vessel-voyage-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            width: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .vessel-voyage-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .vessel-voyage-modal-header h2 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .vessel-voyage-modal-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .vessel-voyage-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .vessel-voyage-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .vessel-voyage-group-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .vessel-voyage-option {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vessel-voyage-option:hover {
            border-color: #0a7d33;
            background: #f0f8f4;
        }
        
        .vessel-voyage-option.selected {
            border-color: #0a7d33;
            background: #e8f5e9;
        }
        
        .vessel-voyage-option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .vessel-voyage-option-label {
            flex: 1;
            font-size: 14px;
        }
        
        .vessel-voyage-option-count {
            color: #666;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .vessel-voyage-modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .vessel-voyage-modal-footer .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .vessel-voyage-modal-footer .btn-primary {
            background: #0a7d33;
            color: white;
        }
        
        .vessel-voyage-modal-footer .btn-primary:hover {
            background: #086b2a;
        }
        
        .vessel-voyage-modal-footer .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .vessel-voyage-modal-footer .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .vessel-voyage-modal-footer .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <meta name="color-scheme" content="light dark">
</head>
<body data-page="365-02-schedule-parser.html">
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>ğŸ” è®¿é—®éªŒè¯</h2>
            <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">å§“å *</label>
                    <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
                    <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">æ‰‹æœºå· *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">é‚®ç®± *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
                    <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
                </div>
                <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools365" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
            <a href="365-02-market-rate-schedule-README.html" class="readme-btn">ä½¿ç”¨è¯´æ˜ â†’</a>
            <h1>æ˜æ—¥æ•°èˆª èˆ¹æœŸè§£æå·¥å…·</h1>
            <p>è‡ªåŠ¨è§£ææ˜æ—¥æ•°èˆªèˆ¹æœŸç½‘é¡µï¼Œæå–èˆ¹æœŸä¿¡æ¯å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶</p>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li><strong>å‡†å¤‡å·¥ä½œ</strong>ï¼šé¦–å…ˆéœ€è¦ä½¿ç”¨"æ˜æ—¥æ•°èˆª èˆ¹æœŸç½‘é¡µæ‰‹åŠ¨ä¸‹è½½å·¥å…·"ä¸‹è½½å¹¶ä¿å­˜æ‰€æœ‰èˆ¹æœŸç½‘é¡µåˆ° <strong>365-view-source</strong> æ–‡ä»¶å¤¹ä¸­</li>
                <li><strong>é€‰æ‹©æ–‡ä»¶å¤¹</strong>ï¼šç‚¹å‡»"é€‰æ‹© view-source æ–‡ä»¶å¤¹"æŒ‰é’®ï¼Œé€‰æ‹©åŒ…å«æ‰€æœ‰ HTML æ–‡ä»¶çš„ <strong>365-view-source</strong> æ–‡ä»¶å¤¹</li>
                <li><strong>å¼€å§‹è§£æ</strong>ï¼šé€‰æ‹©æ–‡ä»¶å¤¹åï¼Œç‚¹å‡»"å¼€å§‹è§£æ"æŒ‰é’®ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è§£ææ‰€æœ‰ HTML æ–‡ä»¶ä¸­çš„èˆ¹æœŸä¿¡æ¯ï¼ˆä»…è§£æ"ç›´èˆª"èˆ¹æœŸï¼Œä¸åŒ…å«ä¸­è½¬èˆ¹æœŸï¼‰</li>
                <li><strong>æŸ¥çœ‹ç»“æœ</strong>ï¼šè§£æå®Œæˆåï¼Œå¯ä»¥åœ¨ä¸‹æ–¹é¢„è§ˆè¡¨æ ¼ä¸­æŸ¥çœ‹è§£æç»“æœï¼ˆæœ€å¤šæ˜¾ç¤ºå‰50æ¡ï¼‰</li>
                <li><strong>ä¸‹è½½ CSV</strong>ï¼šç¡®è®¤è§£æç»“æœæ— è¯¯åï¼Œç‚¹å‡»"ä¸‹è½½ CSV"æŒ‰é’®ï¼Œå°†æ•°æ®ä¿å­˜ä¸º CSV æ–‡ä»¶</li>
                <li><strong>ç»“æœè¯´æ˜</strong>ï¼šCSV æ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—ï¼šå¯è¿æ¸¯ã€ç›®çš„æ¸¯ã€èˆªçº¿IDã€å¼€èˆªæ—¥ã€èˆªç¨‹(è®¡åˆ’)ã€å…±èˆ±èˆ¹å…¬å¸ã€èˆªçº¿å¤‡æ³¨ã€èˆ¹åèˆªæ¬¡ã€å¹´ä»½ã€èˆ¹å‹ã€èˆ¹æœŸã€å¯è¿æ¸¯ç å¤´ã€ç›®çš„æ¸¯ç å¤´ã€èˆªç¨‹(å½“æ¬¡)</li>
                <li><strong>æ³¨æ„äº‹é¡¹</strong>ï¼šå·¥å…·ä¼šè‡ªåŠ¨ä»ç½‘é¡µä¸­æå–å¯è¿æ¸¯å’Œç›®çš„æ¸¯ä¿¡æ¯ï¼Œå¦‚æœæŸä¸ªç½‘é¡µä¸­æ²¡æœ‰æ‰¾åˆ°èˆ¹æœŸæ•°æ®ï¼Œä¼šæ˜¾ç¤º"æ— æ•°æ®"æˆ–"è·³è¿‡"æç¤ºã€‚è§£æè¿‡ç¨‹ä¸­è¯·ä¿æŒé¡µé¢æ‰“å¼€ï¼Œä¸è¦å…³é—­æµè§ˆå™¨</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        é€‰æ‹© view-source æ–‡ä»¶å¤¹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>å¼€å§‹è§£æ</button>
                    <button id="download" class="btn" disabled>ä¸‹è½½ CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>æç¤ºï¼šè§£æè¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢ï¼Œè§£æå®Œæˆåä¼šè‡ªåŠ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</p>
        </div>
    </div>

    <!-- èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="vesselVoyageModal" class="vessel-voyage-modal hidden">
        <div class="vessel-voyage-modal-content">
            <div class="vessel-voyage-modal-header">
                <h2>ğŸ” èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–</h2>
                <p>å‘ç°ä»¥ä¸‹èˆ¹åèˆªæ¬¡å»ç©ºæ ¼åç›¸åŒä½†æ ¼å¼ä¸åŒï¼Œè¯·ä¸ºæ¯ç»„é€‰æ‹©ä¸€ä¸ªæ ‡å‡†æ ¼å¼ï¼š</p>
            </div>
            <div id="vesselVoyageList" class="vessel-voyage-list"></div>
            <div class="vessel-voyage-modal-footer">
                <button id="applyVesselVoyageReplace" class="btn btn-primary">åº”ç”¨æ›¿æ¢å¹¶ç»§ç»­</button>
                <button id="skipVesselVoyageReplace" class="btn btn-secondary">è·³è¿‡ï¼ˆä¿ç•™åŸå€¼ï¼‰</button>
            </div>
        </div>
    </div>

    <!-- ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="podWharfModal" class="vessel-voyage-modal hidden">
        <div class="vessel-voyage-modal-content">
            <div class="vessel-voyage-modal-header">
                <h2>ğŸ” ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–</h2>
                <p>å‘ç°ä»¥ä¸‹ç›®çš„æ¸¯ç å¤´å»ç©ºæ ¼åç›¸åŒä½†æ ¼å¼ä¸åŒï¼Œè¯·ä¸ºæ¯ç»„é€‰æ‹©ä¸€ä¸ªæ ‡å‡†æ ¼å¼ï¼š</p>
            </div>
            <div id="podWharfList" class="vessel-voyage-list"></div>
            <div class="vessel-voyage-modal-footer">
                <button id="applyPodWharfReplace" class="btn btn-primary">åº”ç”¨æ›¿æ¢å¹¶ç»§ç»­</button>
                <button id="skipPodWharfReplace" class="btn btn-secondary">è·³è¿‡ï¼ˆä¿ç•™åŸå€¼ï¼‰</button>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨ Gist å­˜å‚¨ç³»ç»Ÿï¼ˆç”¨æˆ·ç™½åå• + è®¿é—®è®°å½•ï¼‰ -->
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/parser-utils.js"></script>
    <script>

    (function() {
        /** Utility: log area - ä½¿ç”¨ parser-utils.js */
        const $ = (sel) => document.querySelector(sel);
        const log = createLogger('#log', { useClassName: true });

        /** CSV utils - ä½¿ç”¨ parser-utils.js ä¸­çš„å‡½æ•° */
        /** DOM helpers - ä½¿ç”¨ parser-utils.js ä¸­çš„å‡½æ•° (text, find, findAll) */

        /**
         * ç»Ÿä¸€æ¸…æ´—ï¼šå»é™¤å‰åç©ºç™½ï¼Œå‹ç¼©å†…éƒ¨ç©ºç™½åˆ°å•ç©ºæ ¼ï¼Œç§»é™¤æ¢è¡Œä¸åˆ¶è¡¨
         * @param {any} value - è¦æ¸…æ´—çš„å€¼
         * @returns {string} æ¸…æ´—åçš„å­—ç¬¦ä¸²
         */
        function clean(value) {
            if (value == null) return '';
            const cleanedString = String(value)
                .replace(/[\r\n\t]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            return cleanedString;
        }

        /**
         * æ¸…æ´—èˆ¹åèˆªæ¬¡ï¼šä¿ç•™åŸå€¼ï¼Œä½†æä¾›å»ç©ºæ ¼ç‰ˆæœ¬ç”¨äºæ¯”è¾ƒ
         * @param {string} vesselVoyage - èˆ¹åèˆªæ¬¡ï¼ˆæ ¼å¼ï¼šèˆ¹å/èˆªæ¬¡ï¼‰
         * @returns {Object} {original: åŸå€¼, normalized: å»ç©ºæ ¼ç‰ˆæœ¬}
         */
        function normalizeVesselVoyage(vesselVoyage) {
            if (!vesselVoyage) return { original: '', normalized: '' };
            const cleaned = clean(vesselVoyage);
            const normalized = cleaned.replace(/\s+/g, '');
            return {
                original: cleaned,
                normalized: normalized
            };
        }

        /**
         * è§„èŒƒåŒ–ç›®çš„æ¸¯ç å¤´ï¼šå»ç©ºæ ¼åç”¨äºæ¯”è¾ƒ
         * @param {string} podWharf - ç›®çš„æ¸¯ç å¤´
         * @returns {string} å»ç©ºæ ¼åçš„ç›®çš„æ¸¯ç å¤´
         */
        function normalizePodWharf(podWharf) {
            if (!podWharf) return '';
            return clean(podWharf).replace(/\s+/g, '').toUpperCase();
        }

        function parseYearImoType(scope) {
            // Within .Route_notice_item5, find divs like <div><h3>å¹´ä»½</h3><h6>2019</h6></div>
            const container = find(scope, '.Route_notice_item5');
            let year = '', imo = '', shipType = '';
            if (container) {
                const blocks = findAll(container, 'div');
                for (const b of blocks) {
                    const k = text(find(b, 'h3'));
                    const v = text(find(b, 'h6'));
                    if (!k) continue;
                    if (k.includes('å¹´ä»½')) year = v;
                    if (k.toUpperCase().includes('IMO')) imo = v;
                    if (k.includes('èˆ¹å‹')) shipType = v;
                }
            }
            return { year, imo, shipType };
        }

        function parseNoticeGroup(group, fileName, pagePol, pagePod) {
            // Only parse nonstop (ç›´èˆª) blocks
            const nonstop = find(group, '.Route_list.nonstop-div');
            if (!nonstop) return [];

            const groupId = group.getAttribute('group_id') || '';
            const routeItem = find(nonstop, '.Route_item');
            const openDay = text(find(routeItem, 'h1'));           // å¼€èˆªæ—¥
            const planDuration = text(find(routeItem, 'h3'));      // èˆªç¨‹(è®¡åˆ’)
            const coSpan = find(nonstop, '.Route_notice_item11 span');
            const coLoad = text(coSpan);                            // å…±èˆ±èˆ¹å…¬å¸

            // èˆªçº¿å¤‡æ³¨ï¼šä¼˜å…ˆå– .notice_scroll h4 span ä¸”ä¸å«"å¤©"å­—æ ·
            let remark = '';
            const remarkCandidates = findAll(nonstop, '.notice_scroll h4 span, .Route_item h4 span');
            for (const s of remarkCandidates) {
                const t = text(s);
                if (t && !/\d+\s*å¤©/.test(t)) { remark = t; break; }
            }

            const rows = [];
            // Each voyage li under this group
            const voyageLis = findAll(group, 'ul.Route_notice.Route_notice_dd li[cur-toggle]');
            for (const li of voyageLis) {
                const etd = (li.getAttribute('data-etd') || '').trim();
                const polTerminal = (li.getAttribute('data-terminal') || '').trim();
                const podTerminal = (li.getAttribute('data-pod-terminal') || '').trim();

                const box = find(li, '.Route_notice_box');
                const item1 = find(box, '.Route_notice_item1');
                const copy = text(find(item1, '.copy-content'));   // èˆ¹åèˆªæ¬¡
                const { year, imo, shipType } = parseYearImoType(box);
                const voyageDuration = text(find(li, '.Route_notice_item3 h4'));

                // Build one row (13 columns; prefixed by page-level POL/POD)
                rows.push([
                    pagePol,
                    pagePod,
                    groupId,
                    openDay,
                    planDuration,
                    coLoad,
                    remark,
                    copy,
                    year,
                    shipType,
                    etd,
                    polTerminal,
                    podTerminal,
                    voyageDuration
                ]);
            }

            // Stop at "ç‚¹å‡»åŠ è½½æ›´å¤šå…¬å‘Šä¿¡æ¯" marker if present (implicit: voyageLis are only current page)
            return rows;
        }

        function parseHtml(fileName, htmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            // Scope from the ç›´èˆªèˆ¹æœŸ title if available; otherwise parse all dd-notice-div
            let scopeEl = doc;
            const directTitle = doc.querySelector('#DD_SC.Route_left_title, .Route_left_title#DD_SC');
            if (directTitle) {
                // Use closest section container
                scopeEl = directTitle.parentElement || doc;
            }

            // Extract page-level POL/POD
            let pagePol = '';
            const polEl = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
            if (polEl) pagePol = (polEl.textContent || '').trim();

            let pagePod = '';
            const bcnEl = doc.querySelector('.Route_index_title_bcn');
            if (bcnEl) {
                const t = (bcnEl.textContent || '')
                    .replace(/å½“å‰ä½ç½®ï¼š/g,'')
                    .replace(/\s+/g, ' ')
                    .trim();
                const matches = t.match(/[\u4e00-\u9fa5A-Za-z]+/g);
                if (matches && matches.length) {
                    const blacklist = new Set(['å½“å‰ä½ç½®', 'æ˜æ—¥æ•°èˆª', 'èˆ¹æœŸæŸ¥è¯¢']);
                    const parts = matches.filter(w => !blacklist.has(w));
                    if (parts.length >= 1) {
                        pagePod = parts.join('/');
                    } else {
                        pagePod = matches[matches.length - 1];
                    }
                }
            }

            const groups = Array.from(scopeEl.querySelectorAll('div.dd-notice-div'));
            if (groups.length === 0) {
                log(`[è·³è¿‡] æœªæ‰¾åˆ°èˆªçº¿ç»„: ${fileName}`, 'warn');
                return [];
            }

            const allRows = [];
            for (const g of groups) {
                const rows = parseNoticeGroup(g, fileName, pagePol, pagePod);
                allRows.push(...rows);
            }
            return allRows;
        }

        /**
         * ç”Ÿæˆæ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š
         * @param {Array<Array>} merged - åˆå¹¶åçš„æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
         * @returns {Object} è´¨é‡æŠ¥å‘Šå¯¹è±¡
         */
        function generateQualityReport(merged) {
            const report = {
                hasIssues: false,
                duplicateVesselVoyage: [],
                duplicateVesselVoyageMap: new Map(),
                duplicatePodWharf: [],
                duplicatePodWharfMap: new Map(),
                missingOpenDay: 0,
                missingPlanDuration: 0,
                missingEtd: 0,
                missingPolWharf: 0,
                missingPodWharf: 0,
                podWharfOnlyShort: 0
            };
            
            if (merged.length <= 1) return report;
            
            // èˆ¹åèˆªæ¬¡å»ç©ºæ ¼åçš„æ˜ å°„ï¼ˆç”¨äºæ£€æµ‹é‡å¤ï¼‰
            const normalizedVesselVoyageMap = new Map();
            // ç›®çš„æ¸¯ç å¤´å»ç©ºæ ¼åçš„æ˜ å°„ï¼ˆç”¨äºæ£€æµ‹é‡å¤ï¼‰
            const normalizedPodWharfMap = new Map();
            
            // ç»Ÿè®¡ç¼ºå¤±å­—æ®µ
            for (let i = 1; i < merged.length; i++) {
                const row = merged[i];
                // åˆ—ï¼šå¯è¿æ¸¯(0), ç›®çš„æ¸¯(1), èˆªçº¿ID(2), å¼€èˆªæ—¥(3), èˆªç¨‹(è®¡åˆ’)(4), å…±èˆ±èˆ¹å…¬å¸(5), èˆªçº¿å¤‡æ³¨(6), èˆ¹åèˆªæ¬¡(7), å¹´ä»½(8), èˆ¹å‹(9), èˆ¹æœŸ(10), å¯è¿æ¸¯ç å¤´(11), ç›®çš„æ¸¯ç å¤´(12), èˆªç¨‹(å½“æ¬¡)(13)
                const vesselVoyage = row[7] || '';
                const podWharf = row[12] || '';
                
                // æ£€æŸ¥èˆ¹åèˆªæ¬¡ç©ºæ ¼é—®é¢˜
                if (vesselVoyage) {
                    const normalized = normalizeVesselVoyage(vesselVoyage);
                    if (normalized.normalized) {
                        if (!normalizedVesselVoyageMap.has(normalized.normalized)) {
                            normalizedVesselVoyageMap.set(normalized.normalized, {
                                variants: new Map(),
                                totalCount: 0
                            });
                        }
                        const entry = normalizedVesselVoyageMap.get(normalized.normalized);
                        entry.totalCount++;
                        entry.variants.set(vesselVoyage, (entry.variants.get(vesselVoyage) || 0) + 1);
                    }
                }
                
                // æ£€æŸ¥ç›®çš„æ¸¯ç å¤´ç©ºæ ¼é—®é¢˜
                if (podWharf) {
                    const normalized = normalizePodWharf(podWharf);
                    if (normalized) {
                        if (!normalizedPodWharfMap.has(normalized)) {
                            normalizedPodWharfMap.set(normalized, {
                                variants: new Map(),
                                totalCount: 0
                            });
                        }
                        const entry = normalizedPodWharfMap.get(normalized);
                        entry.totalCount++;
                        entry.variants.set(podWharf, (entry.variants.get(podWharf) || 0) + 1);
                    }
                }
                
                // æ£€æŸ¥ç¼ºå¤±å­—æ®µ
                if (!row[3]) report.missingOpenDay++;
                if (!row[4]) report.missingPlanDuration++;
                if (!row[10]) report.missingEtd++;
                if (!row[11]) report.missingPolWharf++;
                if (!row[12]) report.missingPodWharf++;
                
                // æ£€æŸ¥ç›®çš„æ¸¯ç å¤´æ˜¯å¦åªæœ‰ç®€å†™
                if (podWharf && !podWharf.includes('/') && podWharf.length < 10) {
                    report.podWharfOnlyShort++;
                }
            }
            
            // æ‰¾å‡ºé‡å¤çš„èˆ¹åèˆªæ¬¡
            for (const [normalized, entry] of normalizedVesselVoyageMap.entries()) {
                if (entry.totalCount > 1 && entry.variants.size > 1) {
                    const variants = Array.from(entry.variants.entries()).map(([variant, count]) => {
                        return { vesselVoyage: variant, count: count };
                    });
                    variants.sort((a, b) => b.count - a.count);
                    report.duplicateVesselVoyage.push({
                        normalized: normalized,
                        variants: variants,
                        count: entry.totalCount
                    });
                    report.duplicateVesselVoyageMap.set(normalized, entry);
                }
            }
            
            // æ‰¾å‡ºé‡å¤çš„ç›®çš„æ¸¯ç å¤´
            for (const [normalized, entry] of normalizedPodWharfMap.entries()) {
                if (entry.totalCount > 1 && entry.variants.size > 1) {
                    const variants = Array.from(entry.variants.entries()).map(([variant, count]) => {
                        return { podWharf: variant, count: count };
                    });
                    variants.sort((a, b) => b.count - a.count);
                    report.duplicatePodWharf.push({
                        normalized: normalized,
                        variants: variants,
                        count: entry.totalCount
                    });
                    report.duplicatePodWharfMap.set(normalized, entry);
                }
            }
            
            // æŒ‰æ•°é‡æ’åº
            report.duplicateVesselVoyage.sort((a, b) => b.count - a.count);
            report.duplicatePodWharf.sort((a, b) => b.count - a.count);
            
            // åˆ¤æ–­æ˜¯å¦æœ‰é—®é¢˜
            report.hasIssues = report.duplicateVesselVoyage.length > 0 ||
                              report.duplicatePodWharf.length > 0 ||
                              report.missingOpenDay > 0 ||
                              report.missingPlanDuration > 0 ||
                              report.missingEtd > 0 ||
                              report.missingPolWharf > 0 ||
                              report.missingPodWharf > 0 ||
                              report.podWharfOnlyShort > 0;
            
            return report;
        }

        /**
         * æ˜¾ç¤ºèˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–æ¨¡æ€æ¡†
         * @param {Array} duplicateGroups - é‡å¤çš„èˆ¹åèˆªæ¬¡ç»„
         * @returns {Promise<Map>} è¿”å›ç”¨æˆ·é€‰æ‹©çš„æ›¿æ¢æ˜ å°„
         */
        function showVesselVoyageModal(duplicateGroups) {
            return new Promise((resolve) => {
                const modal = $('#vesselVoyageModal');
                const list = $('#vesselVoyageList');
                const applyBtn = $('#applyVesselVoyageReplace');
                const skipBtn = $('#skipVesselVoyageReplace');
                
                list.innerHTML = '';
                const selections = new Map();
                
                duplicateGroups.forEach((group, groupIndex) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'vessel-voyage-group';
                    
                    const title = document.createElement('div');
                    title.className = 'vessel-voyage-group-title';
                    title.textContent = `ç¬¬ ${groupIndex + 1} ç»„ï¼ˆå…± ${group.count} æ¡è®°å½•ï¼Œ${group.variants.length} ç§æ ¼å¼ï¼‰ï¼š`;
                    groupDiv.appendChild(title);
                    
                    // æ‰¾åˆ°æœ€çŸ­çš„èˆ¹åèˆªæ¬¡ï¼ˆä½œä¸ºé»˜è®¤é€‰æ‹©ï¼‰
                    let shortestIndex = 0;
                    let shortestLength = Infinity;
                    group.variants.forEach((variant, idx) => {
                        const length = (variant.vesselVoyage || '').length;
                        if (length < shortestLength) {
                            shortestLength = length;
                            shortestIndex = idx;
                        }
                    });
                    
                    group.variants.forEach((variant, variantIndex) => {
                        const option = document.createElement('div');
                        option.className = 'vessel-voyage-option';
                        const isShortest = variantIndex === shortestIndex;
                        if (isShortest) {
                            option.classList.add('selected');
                            selections.set(group.normalized, variant.vesselVoyage);
                        }
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = `vesselVoyageGroup_${groupIndex}`;
                        radio.value = variant.vesselVoyage;
                        radio.checked = isShortest;
                        radio.addEventListener('change', () => {
                            groupDiv.querySelectorAll('.vessel-voyage-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            option.classList.add('selected');
                            selections.set(group.normalized, variant.vesselVoyage);
                        });
                        
                        const label = document.createElement('label');
                        label.className = 'vessel-voyage-option-label';
                        label.textContent = variant.vesselVoyage || '';
                        
                        const count = document.createElement('span');
                        count.className = 'vessel-voyage-option-count';
                        count.textContent = `(${variant.count} æ¡)`;
                        
                        option.appendChild(radio);
                        option.appendChild(label);
                        option.appendChild(count);
                        option.addEventListener('click', () => {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        });
                        
                        groupDiv.appendChild(option);
                    });
                    
                    list.appendChild(groupDiv);
                });
                
                modal.classList.remove('hidden');
                
                applyBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(selections);
                };
                
                skipBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(new Map());
                };
            });
        }

        /**
         * æ˜¾ç¤ºç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–æ¨¡æ€æ¡†
         * @param {Array} duplicateGroups - é‡å¤çš„ç›®çš„æ¸¯ç å¤´ç»„
         * @returns {Promise<Map>} è¿”å›ç”¨æˆ·é€‰æ‹©çš„æ›¿æ¢æ˜ å°„
         */
        function showPodWharfModal(duplicateGroups) {
            return new Promise((resolve) => {
                const modal = $('#podWharfModal');
                const list = $('#podWharfList');
                const applyBtn = $('#applyPodWharfReplace');
                const skipBtn = $('#skipPodWharfReplace');
                
                list.innerHTML = '';
                const selections = new Map();
                
                duplicateGroups.forEach((group, groupIndex) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'vessel-voyage-group';
                    
                    const title = document.createElement('div');
                    title.className = 'vessel-voyage-group-title';
                    title.textContent = `ç¬¬ ${groupIndex + 1} ç»„ï¼ˆå…± ${group.count} æ¡è®°å½•ï¼Œ${group.variants.length} ç§æ ¼å¼ï¼‰ï¼š`;
                    groupDiv.appendChild(title);
                    
                    // æ‰¾åˆ°æœ€çŸ­çš„ç›®çš„æ¸¯ç å¤´ï¼ˆä½œä¸ºé»˜è®¤é€‰æ‹©ï¼‰
                    let shortestIndex = 0;
                    let shortestLength = Infinity;
                    group.variants.forEach((variant, idx) => {
                        const length = (variant.podWharf || '').length;
                        if (length < shortestLength) {
                            shortestLength = length;
                            shortestIndex = idx;
                        }
                    });
                    
                    group.variants.forEach((variant, variantIndex) => {
                        const option = document.createElement('div');
                        option.className = 'vessel-voyage-option';
                        const isShortest = variantIndex === shortestIndex;
                        if (isShortest) {
                            option.classList.add('selected');
                            selections.set(group.normalized, variant.podWharf);
                        }
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = `podWharfGroup_${groupIndex}`;
                        radio.value = variant.podWharf;
                        radio.checked = isShortest;
                        radio.addEventListener('change', () => {
                            groupDiv.querySelectorAll('.vessel-voyage-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            option.classList.add('selected');
                            selections.set(group.normalized, variant.podWharf);
                        });
                        
                        const label = document.createElement('label');
                        label.className = 'vessel-voyage-option-label';
                        label.textContent = variant.podWharf || '';
                        
                        const count = document.createElement('span');
                        count.className = 'vessel-voyage-option-count';
                        count.textContent = `(${variant.count} æ¡)`;
                        
                        option.appendChild(radio);
                        option.appendChild(label);
                        option.appendChild(count);
                        option.addEventListener('click', () => {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        });
                        
                        groupDiv.appendChild(option);
                    });
                    
                    list.appendChild(groupDiv);
                });
                
                modal.classList.remove('hidden');
                
                applyBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(selections);
                };
                
                skipBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(new Map());
                };
            });
        }

        /**
         * åº”ç”¨èˆ¹åèˆªæ¬¡æ›¿æ¢
         * @param {Array<Array>} merged - åˆå¹¶åçš„æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
         * @param {Map} replacements - æ›¿æ¢æ˜ å°„ {normalized: vesselVoyage}
         * @returns {Array<Array>} æ›¿æ¢åçš„æ•°æ®
         */
        function applyVesselVoyageReplacements(merged, replacements) {
            if (replacements.size === 0) return merged;
            
            const result = [merged[0]];
            
            for (let i = 1; i < merged.length; i++) {
                const row = [...merged[i]];
                const vesselVoyage = row[7] || '';
                
                const normalized = normalizeVesselVoyage(vesselVoyage);
                if (normalized.normalized && replacements.has(normalized.normalized)) {
                    row[7] = replacements.get(normalized.normalized);
                }
                
                result.push(row);
            }
            
            return result;
        }

        /**
         * åº”ç”¨ç›®çš„æ¸¯ç å¤´æ›¿æ¢
         * @param {Array<Array>} merged - åˆå¹¶åçš„æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
         * @param {Map} replacements - æ›¿æ¢æ˜ å°„ {normalized: podWharf}
         * @returns {Array<Array>} æ›¿æ¢åçš„æ•°æ®
         */
        function applyPodWharfReplacements(merged, replacements) {
            if (replacements.size === 0) return merged;
            
            const result = [merged[0]];
            
            for (let i = 1; i < merged.length; i++) {
                const row = [...merged[i]];
                const podWharf = row[12] || '';
                
                const normalized = normalizePodWharf(podWharf);
                if (normalized && replacements.has(normalized)) {
                    row[12] = replacements.get(normalized);
                }
                
                result.push(row);
            }
            
            return result;
        }

        /**
         * æ˜¾ç¤ºæ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š
         * @param {Object} qualityReport - è´¨é‡æŠ¥å‘Šå¯¹è±¡
         * @param {boolean} skipDuplicates - æ˜¯å¦è·³è¿‡é‡å¤çš„æ˜¾ç¤º
         */
        function displayQualityReport(qualityReport, skipDuplicates = false) {
            if (qualityReport.hasIssues) {
                log(`\nğŸ“Š æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Šï¼š`, 'ok');
                if (!skipDuplicates && qualityReport.duplicateVesselVoyage.length > 0) {
                    log(`âš ï¸ å‘ç° ${qualityReport.duplicateVesselVoyage.length} ç»„å¯èƒ½é‡å¤çš„èˆ¹åèˆªæ¬¡ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰`, 'warn');
                }
                if (!skipDuplicates && qualityReport.duplicatePodWharf.length > 0) {
                    log(`âš ï¸ å‘ç° ${qualityReport.duplicatePodWharf.length} ç»„å¯èƒ½é‡å¤çš„ç›®çš„æ¸¯ç å¤´ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰`, 'warn');
                }
                if (qualityReport.missingOpenDay > 0) {
                    log(`âš ï¸ ç¼ºå¤±å¼€èˆªæ—¥ï¼š${qualityReport.missingOpenDay} æ¡`, 'warn');
                }
                if (qualityReport.missingPlanDuration > 0) {
                    log(`âš ï¸ ç¼ºå¤±èˆªç¨‹(è®¡åˆ’)ï¼š${qualityReport.missingPlanDuration} æ¡`, 'warn');
                }
                if (qualityReport.missingEtd > 0) {
                    log(`âš ï¸ ç¼ºå¤±èˆ¹æœŸï¼š${qualityReport.missingEtd} æ¡`, 'warn');
                }
                if (qualityReport.missingPolWharf > 0) {
                    log(`âš ï¸ ç¼ºå¤±å¯è¿æ¸¯ç å¤´ï¼š${qualityReport.missingPolWharf} æ¡`, 'warn');
                }
                if (qualityReport.missingPodWharf > 0) {
                    log(`âš ï¸ ç¼ºå¤±ç›®çš„æ¸¯ç å¤´ï¼š${qualityReport.missingPodWharf} æ¡`, 'warn');
                }
                if (qualityReport.podWharfOnlyShort > 0) {
                    log(`âš ï¸ ç›®çš„æ¸¯ç å¤´åªæœ‰ç®€å†™ï¼ˆç¼ºå°‘å…¨ç§°ï¼‰ï¼š${qualityReport.podWharfOnlyShort} æ¡`, 'warn');
                }
            } else {
                log(`\nâœ… æ•°æ®è´¨é‡æ£€æŸ¥é€šè¿‡ï¼Œæœªå‘ç°æ˜æ˜¾é—®é¢˜`, 'ok');
            }
        }

        /** Table preview - ä½¿ç”¨ parser-utils.js ä¸­çš„å‡½æ•° */
        function renderPreviewLocal(rows, container, table) {
            const headers = [
                'å¯è¿æ¸¯', 'ç›®çš„æ¸¯', 'èˆªçº¿ID', 'å¼€èˆªæ—¥', 'èˆªç¨‹(è®¡åˆ’)', 'å…±èˆ±èˆ¹å…¬å¸', 'èˆªçº¿å¤‡æ³¨',
                'èˆ¹åèˆªæ¬¡', 'å¹´ä»½', 'èˆ¹å‹', 'èˆ¹æœŸ', 'å¯è¿æ¸¯ç å¤´', 'ç›®çš„æ¸¯ç å¤´', 'èˆªç¨‹(å½“æ¬¡)'
            ];
            renderPreview(rows, container, table, headers, 50);
        }

        /** Main flow */
        const picker = $('#picker');
        const runBtn = $('#run');
        const downloadBtn = $('#download');
        const summary = $('#summary');
        const preview = $('#preview');
        const table = $('#table');

        let selectedFiles = [];
        let outputRows = [];

        picker.addEventListener('change', () => {
            const logBox = document.querySelector('#log');
            if (logBox) logBox.innerHTML = '';
            outputRows = [];
            preview.classList.add('hidden');
            selectedFiles = Array.from(picker.files).filter(f => /\.html?$/i.test(f.name));
            if (selectedFiles.length === 0) {
                log('æœªé€‰æ‹©åˆ° HTML æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹© view-source æ–‡ä»¶å¤¹ã€‚', 'err');
                runBtn.disabled = true;
                downloadBtn.disabled = true;
                summary.textContent = '';
                return;
            }
            selectedFiles.sort((a,b) => a.name.localeCompare(b.name));
            log(`å·²é€‰æ‹© ${selectedFiles.length} ä¸ª HTML æ–‡ä»¶ã€‚`, 'ok');
            runBtn.disabled = false;
            downloadBtn.disabled = true;
            summary.textContent = '';
        });

        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            downloadBtn.disabled = true;
            outputRows = [];
            preview.classList.add('hidden');
            table.innerHTML = '';
            summary.textContent = '';
            log('å¼€å§‹è§£æ...', '');

            // Header row
            const header = ['å¯è¿æ¸¯','ç›®çš„æ¸¯','èˆªçº¿ID','å¼€èˆªæ—¥','èˆªç¨‹(è®¡åˆ’)','å…±èˆ±èˆ¹å…¬å¸','èˆªçº¿å¤‡æ³¨','èˆ¹åèˆªæ¬¡','å¹´ä»½','èˆ¹å‹','èˆ¹æœŸ','å¯è¿æ¸¯ç å¤´','ç›®çš„æ¸¯ç å¤´','èˆªç¨‹(å½“æ¬¡)'];
            const all = [header];

            let fileOk = 0, fileWarn = 0;
            for (const f of selectedFiles) {
                try {
                    const txt = await f.text();
                    const rows = parseHtml(f.name, txt);
                    if (rows.length === 0) { fileWarn++; log(`[æ— æ•°æ®] ${f.name}`, 'warn'); }
                    else { fileOk++; log(`[OK] ${f.name} -> ${rows.length} è¡Œ`, 'ok'); }
                    for (const r of rows) all.push(r);
                } catch (e) {
                    fileWarn++;
                    log(`[å¤±è´¥] ${f.name}: ${e && e.message ? e.message : e}`, 'err');
                }
            }

            // æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š
            const qualityReport = generateQualityReport(all);
            
            // å¤„ç†èˆ¹åèˆªæ¬¡å’Œç›®çš„æ¸¯ç å¤´çš„æ ‡å‡†åŒ–ï¼ˆæŒ‰é¡ºåºå¤„ç†ï¼‰
            const processStandardization = async (currentAll, currentReport) => {
                let processedAll = currentAll;
                let processedReport = currentReport;
                
                // ç¬¬ä¸€æ­¥ï¼šå¤„ç†èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–
                if (processedReport.duplicateVesselVoyage.length > 0) {
                    log(`\nğŸ” å‘ç° ${processedReport.duplicateVesselVoyage.length} ç»„å¯èƒ½é‡å¤çš„èˆ¹åèˆªæ¬¡ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰ï¼Œè¯·é€‰æ‹©æ ‡å‡†æ ¼å¼...`, 'ok');
                    
                    const replacements = await showVesselVoyageModal(processedReport.duplicateVesselVoyage);
                    if (replacements.size > 0) {
                        log(`æ­£åœ¨åº”ç”¨èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–æ›¿æ¢...`, 'ok');
                        processedAll = applyVesselVoyageReplacements(processedAll, replacements);
                        processedReport = generateQualityReport(processedAll);
                        log(`\nâœ… å·²åº”ç”¨ ${replacements.size} ç»„èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–`, 'ok');
                    } else {
                        log(`\nâ­ï¸ å·²è·³è¿‡èˆ¹åèˆªæ¬¡æ ‡å‡†åŒ–ï¼Œä¿ç•™åŸå€¼`, '');
                    }
                }
                
                // ç¬¬äºŒæ­¥ï¼šå¤„ç†ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–
                if (processedReport.duplicatePodWharf.length > 0) {
                    log(`\nğŸ” å‘ç° ${processedReport.duplicatePodWharf.length} ç»„å¯èƒ½é‡å¤çš„ç›®çš„æ¸¯ç å¤´ï¼ˆç©ºæ ¼å·®å¼‚ï¼‰ï¼Œè¯·é€‰æ‹©æ ‡å‡†æ ¼å¼...`, 'ok');
                    
                    const podWharfReplacements = await showPodWharfModal(processedReport.duplicatePodWharf);
                    if (podWharfReplacements.size > 0) {
                        log(`æ­£åœ¨åº”ç”¨ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–æ›¿æ¢...`, 'ok');
                        processedAll = applyPodWharfReplacements(processedAll, podWharfReplacements);
                        processedReport = generateQualityReport(processedAll);
                        log(`\nâœ… å·²åº”ç”¨ ${podWharfReplacements.size} ç»„ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–`, 'ok');
                    } else {
                        log(`\nâ­ï¸ å·²è·³è¿‡ç›®çš„æ¸¯ç å¤´æ ‡å‡†åŒ–ï¼Œä¿ç•™åŸå€¼`, '');
                    }
                }
                
                return { all: processedAll, report: processedReport };
            };
            
            // æ‰§è¡Œæ ‡å‡†åŒ–å¤„ç†
            processStandardization(all, qualityReport).then(({ all: finalAll, report: finalReport }) => {
                outputRows = finalAll;
                displayQualityReport(finalReport, true);
                renderPreviewLocal(finalAll.slice(1), preview, table);
                downloadBtn.disabled = finalAll.length <= 1;
                summary.textContent = `å®Œæˆï¼š${fileOk} ä¸ªæ–‡ä»¶ï¼Œ${fileWarn} ä¸ªæé†’ï¼Œå…± ${finalAll.length - 1} æ¡è®°å½•ã€‚`;
            });
        });

        downloadBtn.addEventListener('click', () => {
            if (!outputRows || outputRows.length <= 1) return;
            const csv = '\uFEFF' + rowsToCsv(outputRows); // BOM for Excel UTF-8
            downloadBlob(csv, generateTimestampFilename('shipping-schedule'), 'text/csv;charset=utf-8');
        });
    })();
</script>
    </div>
    <div class="page-footer">
        <h2>æ˜æ—¥æ•°èˆª èˆ¹æœŸè§£æå·¥å…·ä½¿ç”¨å£°æ˜</h2>
        <p>æœ¬å·¥å…·ç”¨äºè§£æä»æ˜æ—¥æ•°èˆªï¼ˆhangyun365.comï¼‰ä¸‹è½½çš„èˆ¹æœŸç½‘é¡µï¼Œæå–èˆ¹æœŸä¿¡æ¯å¹¶å¯¼å‡ºä¸º CSV æ–‡ä»¶ã€‚</p>
        <p>æ‰€æœ‰æ•°æ®æ¥æºäºæ˜æ—¥æ•°èˆªå…¬å¼€ä¿¡æ¯ï¼Œè§£æç»“æœä»…ä¾›å†…éƒ¨ä½¿ç”¨ï¼Œè¯·éµå®ˆæ˜æ—¥æ•°èˆªçš„ä½¿ç”¨æ¡æ¬¾å’Œç‰ˆæƒè§„å®šã€‚</p>
    </div>
</body>
</html>
