<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明日数航 船期解析工具</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/tool-styles.css">
    <link rel="stylesheet" href="vendor/parser-styles.css">
    <style>
        /* 页面特定样式（保留与公共样式不同的部分） */
    </style>
    <meta name="color-scheme" content="light dark">
</head>
<body data-page="365-02-schedule-parser.html">
    <!-- 用户验证模态框 -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>🔐 访问验证</h2>
            <p>为了了解工具使用情况，请填写以下信息</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">姓名 *</label>
                    <input type="text" id="userName" name="userName" placeholder="请输入您的姓名" required autocomplete="name">
                    <div class="auth-error" id="nameError">请输入您的姓名</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">手机号 *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="请输入您的手机号" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">请输入有效的手机号</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">邮箱 *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="请输入您的邮箱地址" required autocomplete="email">
                    <div class="auth-error" id="emailError">请输入有效的邮箱地址</div>
                </div>
                <button type="submit" class="auth-submit-btn">确认并继续</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools365" class="back-home-btn">← 返回首页</a>
            <a href="365-02-market-rate-schedule-README.html" class="readme-btn">使用说明 →</a>
            <h1>明日数航 船期解析工具</h1>
            <p>自动解析明日数航船期网页，提取船期信息并导出为 CSV 文件</p>
        </div>

        <div class="instructions">
            <h3>📋 使用说明</h3>
            <ol>
                <li><strong>准备工作</strong>：首先需要使用"明日数航 船期网页手动下载工具"下载并保存所有船期网页到 <strong>365-view-source</strong> 文件夹中</li>
                <li><strong>选择文件夹</strong>：点击"选择 view-source 文件夹"按钮，选择包含所有 HTML 文件的 <strong>365-view-source</strong> 文件夹</li>
                <li><strong>开始解析</strong>：选择文件夹后，点击"开始解析"按钮，工具会自动解析所有 HTML 文件中的船期信息（仅解析"直航"船期，不包含中转船期）</li>
                <li><strong>查看结果</strong>：解析完成后，可以在下方预览表格中查看解析结果（最多显示前50条）</li>
                <li><strong>下载 CSV</strong>：确认解析结果无误后，点击"下载 CSV"按钮，将数据保存为 CSV 文件</li>
                <li><strong>结果说明</strong>：CSV 文件包含以下列：启运港、目的港、航线ID、开航日、航程(计划)、共舱船公司、航线备注、船名航次、年份、船型、船期、启运港码头、目的港码头、航程(当次)</li>
                <li><strong>注意事项</strong>：工具会自动从网页中提取启运港和目的港信息，如果某个网页中没有找到船期数据，会显示"无数据"或"跳过"提示。解析过程中请保持页面打开，不要关闭浏览器</li>
            </ol>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls">
                    <label class="file-btn">
                        选择 view-source 文件夹
                        <input id="picker" type="file" webkitdirectory multiple accept=".html,.htm">
                    </label>
                    <button id="run" class="btn" disabled>开始解析</button>
                    <button id="download" class="btn" disabled>下载 CSV</button>
                    <span id="summary"></span>
                </div>
                <div id="log" class="log" aria-live="polite"></div>
                <div id="preview" class="hidden">
                    <table id="table"></table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>提示：解析过程中请勿关闭页面，解析完成后会自动显示统计信息</p>
        </div>
    </div>

    <!-- 使用 Gist 存储系统（用户白名单 + 访问记录） -->
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/parser-utils.js"></script>
    <script>

    (function() {
        /** Utility: log area - 使用 parser-utils.js */
        const $ = (sel) => document.querySelector(sel);
        const log = createLogger('#log', { useClassName: true });

        /** CSV utils - 使用 parser-utils.js 中的函数 */
        /** DOM helpers - 使用 parser-utils.js 中的函数 (text, find, findAll) */

        function parseYearImoType(scope) {
            // Within .Route_notice_item5, find divs like <div><h3>年份</h3><h6>2019</h6></div>
            const container = find(scope, '.Route_notice_item5');
            let year = '', imo = '', shipType = '';
            if (container) {
                const blocks = findAll(container, 'div');
                for (const b of blocks) {
                    const k = text(find(b, 'h3'));
                    const v = text(find(b, 'h6'));
                    if (!k) continue;
                    if (k.includes('年份')) year = v;
                    if (k.toUpperCase().includes('IMO')) imo = v;
                    if (k.includes('船型')) shipType = v;
                }
            }
            return { year, imo, shipType };
        }

        function parseNoticeGroup(group, fileName, pagePol, pagePod) {
            // Only parse nonstop (直航) blocks
            const nonstop = find(group, '.Route_list.nonstop-div');
            if (!nonstop) return [];

            const groupId = group.getAttribute('group_id') || '';
            const routeItem = find(nonstop, '.Route_item');
            const openDay = text(find(routeItem, 'h1'));           // 开航日
            const planDuration = text(find(routeItem, 'h3'));      // 航程(计划)
            const coSpan = find(nonstop, '.Route_notice_item11 span');
            const coLoad = text(coSpan);                            // 共舱船公司

            // 航线备注：优先取 .notice_scroll h4 span 且不含"天"字样
            let remark = '';
            const remarkCandidates = findAll(nonstop, '.notice_scroll h4 span, .Route_item h4 span');
            for (const s of remarkCandidates) {
                const t = text(s);
                if (t && !/\d+\s*天/.test(t)) { remark = t; break; }
            }

            const rows = [];
            // Each voyage li under this group
            const voyageLis = findAll(group, 'ul.Route_notice.Route_notice_dd li[cur-toggle]');
            for (const li of voyageLis) {
                const etd = (li.getAttribute('data-etd') || '').trim();
                const polTerminal = (li.getAttribute('data-terminal') || '').trim();
                const podTerminal = (li.getAttribute('data-pod-terminal') || '').trim();

                const box = find(li, '.Route_notice_box');
                const item1 = find(box, '.Route_notice_item1');
                const copy = text(find(item1, '.copy-content'));   // 船名航次
                const { year, imo, shipType } = parseYearImoType(box);
                const voyageDuration = text(find(li, '.Route_notice_item3 h4'));

                // Build one row (13 columns; prefixed by page-level POL/POD)
                rows.push([
                    pagePol,
                    pagePod,
                    groupId,
                    openDay,
                    planDuration,
                    coLoad,
                    remark,
                    copy,
                    year,
                    shipType,
                    etd,
                    polTerminal,
                    podTerminal,
                    voyageDuration
                ]);
            }

            // Stop at "点击加载更多公告信息" marker if present (implicit: voyageLis are only current page)
            return rows;
        }

        function parseHtml(fileName, htmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            // Scope from the 直航船期 title if available; otherwise parse all dd-notice-div
            let scopeEl = doc;
            const directTitle = doc.querySelector('#DD_SC.Route_left_title, .Route_left_title#DD_SC');
            if (directTitle) {
                // Use closest section container
                scopeEl = directTitle.parentElement || doc;
            }

            // Extract page-level POL/POD
            let pagePol = '';
            const polEl = doc.querySelector('.Route_index_title_pol .Route_index_title_on');
            if (polEl) pagePol = (polEl.textContent || '').trim();

            let pagePod = '';
            const bcnEl = doc.querySelector('.Route_index_title_bcn');
            if (bcnEl) {
                const t = (bcnEl.textContent || '')
                    .replace(/当前位置：/g,'')
                    .replace(/\s+/g, ' ')
                    .trim();
                const matches = t.match(/[\u4e00-\u9fa5A-Za-z]+/g);
                if (matches && matches.length) {
                    const blacklist = new Set(['当前位置', '明日数航', '船期查询']);
                    const parts = matches.filter(w => !blacklist.has(w));
                    if (parts.length >= 1) {
                        pagePod = parts.join('/');
                    } else {
                        pagePod = matches[matches.length - 1];
                    }
                }
            }

            const groups = Array.from(scopeEl.querySelectorAll('div.dd-notice-div'));
            if (groups.length === 0) {
                log(`[跳过] 未找到航线组: ${fileName}`, 'warn');
                return [];
            }

            const allRows = [];
            for (const g of groups) {
                const rows = parseNoticeGroup(g, fileName, pagePol, pagePod);
                allRows.push(...rows);
            }
            return allRows;
        }

        /** Table preview - 使用 parser-utils.js 中的函数 */
        function renderPreviewLocal(rows, container, table) {
            const headers = [
                '启运港', '目的港', '航线ID', '开航日', '航程(计划)', '共舱船公司', '航线备注',
                '船名航次', '年份', '船型', '船期', '启运港码头', '目的港码头', '航程(当次)'
            ];
            renderPreview(rows, container, table, headers, 50);
        }

        /** Main flow */
        const picker = $('#picker');
        const runBtn = $('#run');
        const downloadBtn = $('#download');
        const summary = $('#summary');
        const preview = $('#preview');
        const table = $('#table');

        let selectedFiles = [];
        let outputRows = [];

        picker.addEventListener('change', () => {
            const logBox = document.querySelector('#log');
            if (logBox) logBox.innerHTML = '';
            outputRows = [];
            preview.classList.add('hidden');
            selectedFiles = Array.from(picker.files).filter(f => /\.html?$/i.test(f.name));
            if (selectedFiles.length === 0) {
                log('未选择到 HTML 文件，请重新选择 view-source 文件夹。', 'err');
                runBtn.disabled = true;
                downloadBtn.disabled = true;
                summary.textContent = '';
                return;
            }
            selectedFiles.sort((a,b) => a.name.localeCompare(b.name));
            log(`已选择 ${selectedFiles.length} 个 HTML 文件。`, 'ok');
            runBtn.disabled = false;
            downloadBtn.disabled = true;
            summary.textContent = '';
        });

        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            downloadBtn.disabled = true;
            outputRows = [];
            preview.classList.add('hidden');
            table.innerHTML = '';
            summary.textContent = '';
            log('开始解析...', '');

            // Header row
            const header = ['启运港','目的港','航线ID','开航日','航程(计划)','共舱船公司','航线备注','船名航次','年份','船型','船期','启运港码头','目的港码头','航程(当次)'];
            const all = [header];

            let fileOk = 0, fileWarn = 0;
            for (const f of selectedFiles) {
                try {
                    const txt = await f.text();
                    const rows = parseHtml(f.name, txt);
                    if (rows.length === 0) { fileWarn++; log(`[无数据] ${f.name}`, 'warn'); }
                    else { fileOk++; log(`[OK] ${f.name} -> ${rows.length} 行`, 'ok'); }
                    for (const r of rows) all.push(r);
                } catch (e) {
                    fileWarn++;
                    log(`[失败] ${f.name}: ${e && e.message ? e.message : e}`, 'err');
                }
            }

            outputRows = all;
            renderPreviewLocal(all.slice(1), preview, table);
            downloadBtn.disabled = all.length <= 1;
            summary.textContent = `完成：${fileOk} 个文件，${fileWarn} 个提醒，共 ${all.length - 1} 条记录。`;
        });

        downloadBtn.addEventListener('click', () => {
            if (!outputRows || outputRows.length <= 1) return;
            const csv = '\uFEFF' + rowsToCsv(outputRows); // BOM for Excel UTF-8
            downloadBlob(csv, generateTimestampFilename('shipping-schedule'), 'text/csv;charset=utf-8');
        });
    })();
</script>
    </div>
    <div class="page-footer">
        <h2>明日数航 船期解析工具使用声明</h2>
        <p>本工具用于解析从明日数航（hangyun365.com）下载的船期网页，提取船期信息并导出为 CSV 文件。</p>
        <p>所有数据来源于明日数航公开信息，解析结果仅供内部使用，请遵守明日数航的使用条款和版权规定。</p>
    </div>
</body>
</html>
