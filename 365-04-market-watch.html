<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Watch · 市场观察</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/market-analysis-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/ai-config.js"></script>
    <script src="vendor/ai-prompts.js"></script>
    <script src="vendor/ai-utils.js"></script>
    <script src="vendor/market-analysis-utils.js"></script>
    <style>
        /* 页面特定样式（保留与公共样式不同的部分） */

        /* #marketModule 特定样式（仅 365-04 使用） */
        #marketModule {
            margin-bottom: 60px;
        }

        #marketModule .filter-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            width: 100%;
        }

        #marketModule .filter-group {
            flex: 1 1 260px;
            min-width: 220px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #marketModule .filter-group label {
            font-weight: 500;
            color: #495057;
        }

        #marketModule .filter-group select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #marketModule .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #marketModule .chart-container {
            margin-top: 20px;
        }

        #marketModule .chart-wrapper {
            height: 400px;
            margin-top: 20px;
        }

        #marketModule .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        #marketModule .chart-date-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: #495057;
        }

        #marketModule .chart-date-controls label {
            font-weight: 500;
        }

        #marketModule .chart-date-controls input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #marketModule .chart-date-controls input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* .page-footer 样式已在 market-analysis-styles.css 中定义，此处不再重复 */

    </style>
</head>
<body data-page="365-04-market-watch.html">
    <!-- 用户验证模态框 -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>🔐 访问验证</h2>
            <p>为了了解工具使用情况，请填写以下信息</p>
            <form id="authForm">
                <div class="auth-form-group">
                    <label for="userName">姓名 *</label>
                    <input type="text" id="userName" name="userName" placeholder="请输入您的姓名" required autocomplete="name">
                    <div class="auth-error" id="nameError">请输入您的姓名</div>
                </div>
                <div class="auth-form-group">
                    <label for="userPhone">手机号 *</label>
                    <input type="tel" id="userPhone" name="userPhone" placeholder="请输入您的手机号" required autocomplete="tel">
                    <div class="auth-error" id="phoneError">请输入有效的手机号</div>
                </div>
                <div class="auth-form-group">
                    <label for="userEmail">邮箱 *</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="请输入您的邮箱地址" required autocomplete="email">
                    <div class="auth-error" id="emailError">请输入有效的邮箱地址</div>
                </div>
                <button type="submit" class="auth-submit-btn">确认并继续</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <a href="index.html?tab=tools365" class="back-home-btn">← 返回首页</a>
            <a href="365-04-market-watch-README.html" class="readme-btn">使用说明 →</a>
            <h1>Market Watch · 市场观察</h1>
            <p>一份 Excel 与周报即可联动运价趋势、航线供给与 AI 决策，轻松完成跨板块洞察</p>
        </div>

        <div class="content">
            <div class="card">
                <div class="controls top-controls">
                    <label class="file-btn" title="选择Excel文件：同一文件需同时包含 market 与 schedule 工作表">
                        选择Excel文件
                        <input id="fileInput" type="file" accept=".xlsx,.xls">
                    </label>
                    <label class="file-btn" title="上传市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析">
                        上传市场周报 (PDF)
                        <input id="marketReportInput" type="file" accept=".pdf" multiple>
                    </label>
                    <button type="button" class="file-btn" id="exportPdfBtn" title="导出包含当前筛选视图与 AI 结论的整页 PDF">
                        导出整页 PDF
                    </button>
                    <span class="file-hint">
                        选择Excel文件：同一文件需同时包含 market 与 schedule 工作表；
                        上传市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析。
                    </span>
                </div>
                <div class="market-report-upload">
                    <h5>市场周报列表</h5>
                    <ul class="market-report-list" id="marketReportList">
                        <li>尚未上传市场报告</li>
                    </ul>
                </div>
            </div>

            <section id="marketModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 01</span>
                    <div>
                        <h2 class="section-title">运费走势图 <span>RATE TRENDS CHART</span></h2>
                        <p class="module-desc">多港口报价、区间提示与时段筛选，一屏掌握市场温度</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="market">
                    <div class="controls">
                        <div class="filter-controls hidden" id="marketFilterControls">
                            <div class="filter-group">
                                <label>选择区域</label>
                                <select id="marketRegionSelect" multiple size="6" class="multi-select">
                                    <option value="">全部区域</option>
                                </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="marketRegionSelectAll">全部选择</button>
                                <button type="button" class="filter-btn" id="marketRegionClear">清除选择</button>
                            </div>
                            <small class="multi-hint">可多选（点击即可勾选或取消）</small>
                            </div>
                            <div class="filter-group">
                                <label>选择港口</label>
                                <select id="marketPortSelect" multiple size="6" class="multi-select" disabled>
                                    <option value="">请先加载数据</option>
                                </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="marketPortSelectAll">全部选择</button>
                                <button type="button" class="filter-btn" id="marketPortClear">清除选择</button>
                            </div>
                            <small class="multi-hint">可多选（点击即可勾选或取消）</small>
                            </div>
                        </div>
                    </div>
                    <div id="marketInfoBox" class="info-box hidden">
                        <p id="marketInfoText"></p>
                    </div>
                    <div class="chart-container hidden" id="marketChartContainer">
                        <div class="chart-header">
                            <h3 style="color:#495057;">运费走势图</h3>
                            <div class="chart-date-controls hidden" id="marketDateControls">
                                <label>开始时间：</label>
                                <input type="date" id="marketStartDate">
                                <label>结束时间：</label>
                                <input type="date" id="marketEndDate">
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="marketTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="capacityModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 02</span>
                    <div>
                        <h2 class="section-title">航线运力分析 <span>SAILING SCHEDULE PULSE</span></h2>
                        <p class="module-desc">四级筛选联动运力、派船与趋势，精准锁定当周+未来四周供给</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="capacity">
                    <div class="controls">
                        <div class="view-toggle hidden" id="viewToggle">
                            <label>显示模式：</label>
                            <button id="btnAll" class="active">全部</button>
                            <button id="btnCapacity">运力</button>
                            <button id="btnShips">派船</button>
                        </div>
                    </div>
                    <div id="destinationFilters" class="destination-filters hidden">
                        <div class="filter-group">
                            <label for="areaSelect">区域</label>
                            <select id="areaSelect" multiple size="6" class="multi-select">
                                <option value="">全部区域</option>
                            </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="areaSelectAll">全部选择</button>
                                <button type="button" class="filter-btn" id="areaClearAll">清除选择</button>
                            </div>
                            <small class="multi-hint">可多选（点击即可勾选或取消）</small>
                        </div>
                        <div class="filter-group">
                            <label for="subAreaSelect">子区域</label>
                            <select id="subAreaSelect" disabled multiple size="6" class="multi-select">
                                <option value="">全部子区域</option>
                            </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="subAreaSelectAll">全部选择</button>
                                <button type="button" class="filter-btn" id="subAreaClearAll">清除选择</button>
                            </div>
                            <small class="multi-hint">可多选（点击即可勾选或取消）</small>
                        </div>
                        <div class="filter-group">
                            <label for="countrySelect">国家 / 地区</label>
                            <select id="countrySelect" disabled multiple size="6" class="multi-select">
                                <option value="">全部国家 / 地区</option>
                            </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="countrySelectAll">全部选择</button>
                                <button type="button" class="filter-btn" id="countryClearAll">清除选择</button>
                            </div>
                            <small class="multi-hint">可多选（点击即可勾选或取消）</small>
                        </div>
                        <div class="filter-group">
                            <label for="portSelect">港口</label>
                            <select id="portSelect" disabled multiple size="6" class="multi-select">
                                <option value="">全部港口</option>
                            </select>
                            <div class="filter-actions">
                                <button type="button" class="filter-btn" id="portSelectAll">全部选择</button>
                                <button type="button" class="filter-btn" id="portClearAll">清除选择</button>
                            </div>
                            <small class="multi-hint">可多选（点击即可勾选或取消）</small>
                        </div>
                    </div>
                    <div id="infoBox" class="info-box hidden">
                        <p id="infoText"></p>
                    </div>
                    <div id="tableContainer" class="table-container hidden">
                        <table id="pivotTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div id="chartContainer" class="chart-container hidden">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                            <h3 style="color:#1f2d3d; font-size:20px; letter-spacing:0.5px;">运力与派船趋势图</h3>
                            <span style="color:#6c757d; font-size:13px;">高度 ×2 展示，便于对比多航线</span>
                        </div>
                        <div id="emptyChartMessage" class="empty-chart-message hidden">
                            请选择区域（或更细分的层级）以查看图表
                        </div>
                        <div class="chart-wrapper hidden" id="chartWrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="aiModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 03</span>
                    <div>
                        <h2 class="section-title">AI 趋势分析 <span>AI TREND ANALYSIS</span></h2>
                        <p class="module-desc">DeepSeek × KIMI × 通义千问 三模型交叉验证航线策略、供需与价格建议</p>
                    </div>
                </div>
                <div class="card module-card hidden" data-module="ai">
                    <div id="aiAnalysisContainer" class="ai-analysis-container">
                        <div class="ai-header">
                            <h3>AI 船期趋势分析</h3>
                            <p>同一份筛选数据可由多模型并行分析，快速对比观点并交叉验证结论</p>
                        </div>
                        <div id="emptyAiMessage" class="empty-chart-message" style="display: none;">
                            请先加载数据文件并选择筛选条件以启用 AI 分析
                        </div>
                        <div id="aiConfigSection" style="display: none;">
                            <div class="booking-data-table">
                                <h4>其他影响因素</h4>
                                <table class="booking-table" id="bookingDataTable">
                                    <thead>
                                        <tr>
                                            <th>项目</th>
                                            <th class="description-header">说明</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingDataBody">
                                        <tr>
                                            <td><input type="text" value="收货情况" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="当周及未来2周订舱情况；主观判断目前处于旺季或淡季、重点流向表现、装载率预估等"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="码头情况" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="起运港/目的港的拥堵情况、靠泊等待平均时间、天气或其他码头运营影响"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="额外运力" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="具体船公司在某周临时加开/取消/减舱的情况（航线运力分析未覆盖的部分）"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="市场运费" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="填写现行报价，市场上较为激进的高价或低价（如 XX 公司报价表）"></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="其他事件" class="booking-remark" readonly style="background: #f8f9fa; cursor: default;"></td>
                                            <td class="description-cell">
                                                <textarea class="booking-desc" placeholder="如调高关税、出口退税、查验力度、环保政策变化等特殊事件"></textarea>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bunker-info">
                                <div class="bunker-copy">
                                    <h4>燃油行情（Ship & Bunker · 新加坡）</h4>
                                    <p id="bunkerStatus">尚未抓取燃油报价</p>
                                    <small id="bunkerUpdated" class="bunker-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshBunkerBtn">更新燃油价格</button>
                            </div>
                            <div class="index-info">
                                <div>
                                    <h4>WCI 主要航线现货价</h4>
                                    <p id="wciStatus">尚未抓取 WCI 数据</p>
                                    <small id="wciUpdated" class="index-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshWciBtn">更新 WCI</button>
                            </div>
                            <div class="index-info">
                                <div>
                                    <h4>FBX 全球航线指数</h4>
                                    <p id="fbxStatus">尚未抓取 FBX 数据</p>
                                    <small id="fbxUpdated" class="index-meta">最近更新时间：—</small>
                                </div>
                                <button class="action-btn" id="refreshFbxBtn">更新 FBX</button>
                            </div>
                            <div class="index-info" id="scfiInfoContainer" style="display: none;">
                                <div>
                                    <h4>SCFI 运价指数（来自市场报告）</h4>
                                    <div id="scfiTableContainer"></div>
                                    <small id="scfiSource" class="index-meta">数据来源：—</small>
                                </div>
                            </div>
                            <div class="ai-tabs">
                                <div class="ai-tab-buttons">
                                    <button class="ai-tab-btn active" data-provider="deepseek">DeepSeek</button>
                                    <button class="ai-tab-btn" data-provider="kimi">KIMI (Moonshot)</button>
                                    <button class="ai-tab-btn" data-provider="qwen">通义千问 (Qwen)</button>
                                </div>
                                <span class="ai-tab-hint">可切换不同模型对比观点一致性</span>
                            </div>
                            <div class="ai-panels">
                                <div class="ai-panel active" data-provider="deepseek">
                                    <div class="api-config">
                                        <h4>DeepSeek API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="apiKeyInput" placeholder="请输入 DeepSeek API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="apiUrlInput" placeholder="https://api.deepseek.com/v1/chat/completions" value="https://api.deepseek.com/v1/chat/completions">
                                        </div>
                                            <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="apiModelInput" placeholder="deepseek-chat" value="deepseek-chat" list="deepseekModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('deepseek')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn" id="aiAnalysisBtn" onclick="runAiAnalysis('deepseek')">使用 DeepSeek 分析</button>
                                    <div id="aiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="aiResult" class="ai-result hidden">
                                        <h4>DeepSeek 分析结果</h4>
                                        <div class="ai-result-content" id="aiResultContent"></div>
                                    </div>
                                </div>
                                <div class="ai-panel" data-provider="kimi">
                                    <div class="api-config">
                                        <h4>KIMI (Moonshot) API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="kimiApiKeyInput" placeholder="请输入 KIMI / Moonshot API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="kimiApiUrlInput" placeholder="https://api.moonshot.cn/v1/chat/completions" value="https://api.moonshot.cn/v1/chat/completions">
                                        </div>
                                        <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="kimiModelInput" placeholder="moonshot-v1-32k" value="moonshot-v1-32k" list="kimiModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('kimi')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn secondary" id="kimiAnalysisBtn" onclick="runAiAnalysis('kimi')">使用 KIMI 分析</button>
                                    <div id="kimiAiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="kimiAiResult" class="ai-result hidden">
                                        <h4>KIMI 分析结果</h4>
                                        <div class="ai-result-content" id="kimiAiResultContent"></div>
                                    </div>
                                </div>
                                <div class="ai-panel" data-provider="qwen">
                                    <div class="api-config">
                                        <h4>通义千问 (Qwen) API 配置</h4>
                                        <div class="api-input-group">
                                            <label>API Key:</label>
                                            <input type="password" id="qwenApiKeyInput" placeholder="请输入通义千问 API Key">
                                        </div>
                                        <div class="api-input-group">
                                            <label>API URL:</label>
                                            <input type="text" id="qwenApiUrlInput" placeholder="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" value="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions">
                                        </div>
                                        <div class="api-input-group">
                                            <label>模型 ID:</label>
                                            <input type="text" id="qwenModelInput" placeholder="qwen-max" value="qwen-max" list="qwenModelOptions">
                                        </div>
                                        <button class="api-save-btn" onclick="saveAiConfig('qwen')">保存配置</button>
                                    </div>
                                    <button class="ai-analysis-btn" id="qwenAnalysisBtn" onclick="runAiAnalysis('qwen')" style="background: #ff6b35;">使用通义千问分析</button>
                                    <div id="qwenAiLoading" class="ai-loading hidden">正在分析中</div>
                                    <div id="qwenAiResult" class="ai-result hidden">
                                        <h4>通义千问 分析结果</h4>
                                        <div class="ai-result-content" id="qwenAiResultContent"></div>
                                    </div>
                                </div>
                            </div>
                            <datalist id="deepseekModelOptions">
                                <option value="deepseek-chat">基础对话模型（推荐）</option>
                                <option value="deepseek-v3">V3 高性能模型（2024年12月发布）</option>
                                <option value="deepseek-reasoner">推理模型（逻辑推理）</option>
                                <option value="deepseek-r1">R1 推理模型（2025年1月发布）</option>
                                <option value="deepseek-coder">代码模型</option>
                            </datalist>
                            <datalist id="kimiModelOptions">
                                <option value="moonshot-v1-8k">8K 上下文（经济型）</option>
                                <option value="moonshot-v1-32k">32K 上下文（推荐）</option>
                                <option value="moonshot-v1-128k">128K 上下文（长文档）</option>
                                <option value="moonshot-v1-k2">K2 模型（320亿参数，需确认API可用性）</option>
                            </datalist>
                            <datalist id="qwenModelOptions">
                                <option value="qwen-turbo">Turbo 快速模型（经济型）</option>
                                <option value="qwen-plus">Plus 平衡模型</option>
                                <option value="qwen-max">Max 高性能模型（推荐，最佳性能）</option>
                                <option value="qwen-max-longcontext">Max 长上下文模型</option>
                            </datalist>
                        </div>
    </div>
    </div>
    <div class="page-footer">
        <h2>Market Watch · 市场观察使用声明</h2>
        <p>资料整合自用户 Excel、用户上传市场周报、Ship & Bunker、上海航运交易所、Drewry、Freightos 等公开渠道，仅供内部研判，不构成对外报价或投资建议。</p>
        <p>AI 服务由 DeepSeek / KIMI / 通义千问 API 驱动，所有调用费用与合规责任由使用者自担，涉及客户或敏感数据时请先完成脱敏处理。</p>
    </div>
    <!-- 使用 Gist 存储系统（用户白名单 + 访问记录） -->
    <script src="vendor/auth-gist.js"></script>
    <script>

        // ==================== 调试模式 ====================
        // 调试函数已统一到 vendor/debug-utils.js
        // 使用：debugLog(), debugWarn(), debugError()

        // ==================== 错误处理 ====================
        // 注意：ErrorType 和 showError/showSuccess 已在 vendor/error-handler.js 中定义
        // 这里只添加页面特定的错误消息
        
        // 添加页面特定的错误消息（使用统一的错误处理模块）
        if (typeof addErrorMessage === 'function') {
            addErrorMessage(ErrorType.DATA_VALIDATION, 'NO_AREA_SELECTION', '请先选择区域（至少第一级）');
            addErrorMessage(ErrorType.DATA_VALIDATION, 'NO_EXCEL_LOADED', '请先加载并解析 Excel 文件');
        }

        // 运费走势图模块逻辑
        let marketData = [];
        let marketChart = null;
        let marketRegions = [];
        let marketRegionPortMap = {};
        let marketColumnConfig = {
            portCol: null,
            dateCol: null
        };
        let marketSelectedRegions = [];
        let marketSelectedPorts = [];
        let marketSelectorsInitialized = false;

        // 自定义区域顺序（用于市场运价与运力区域）
        const CUSTOM_REGION_ORDER = ['北美洲', '拉丁美洲', '欧洲', '中东红海印巴', '澳洲', '非洲', '东南亚'];

        let pdfJsReady = false;
        let pdfJsLoadingPromise = null;

        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            // 优先使用本地 worker，失败时使用 CDN
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'vendor/pdf.worker.min.js';
            } catch (e) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            pdfJsReady = true;
        }

        const loadedScripts = new Set();
        const loadedWorkers = new Map();

        // loadScript, loadWorkerAsBlob, ensurePdfJsLoaded 已从 vendor/market-analysis-utils.js 加载

        let marketReports = [];
        let bunkerData = null;
        let wciData = null;
        let fbxData = null;
        const excelLoadState = { market: false, schedule: false };
        let modulesVisible = false;

        const fileInput = document.getElementById('fileInput');
        const marketRegionSelect = document.getElementById('marketRegionSelect');
        const marketPortSelect = document.getElementById('marketPortSelect');
        const marketFilterControls = document.getElementById('marketFilterControls');
        const marketChartContainer = document.getElementById('marketChartContainer');
        const marketInfoBox = document.getElementById('marketInfoBox');
        const marketInfoText = document.getElementById('marketInfoText');
        const marketStartDate = document.getElementById('marketStartDate');
        const marketEndDate = document.getElementById('marketEndDate');
        const marketDateControls = document.getElementById('marketDateControls');
        const marketReportInput = document.getElementById('marketReportInput');
        const marketReportList = document.getElementById('marketReportList');
        const bunkerStatusEl = document.getElementById('bunkerStatus');
        const bunkerUpdatedEl = document.getElementById('bunkerUpdated');
        const refreshBunkerBtn = document.getElementById('refreshBunkerBtn');
        const wciStatusEl = document.getElementById('wciStatus');
        const wciUpdatedEl = document.getElementById('wciUpdated');
        const refreshWciBtn = document.getElementById('refreshWciBtn');
        const fbxStatusEl = document.getElementById('fbxStatus');
        const fbxUpdatedEl = document.getElementById('fbxUpdated');
        const refreshFbxBtn = document.getElementById('refreshFbxBtn');

        // renderMarketReportList 已从 vendor/market-analysis-utils.js 加载
        renderMarketReportList();
        function tryRevealModules() {
            if (modulesVisible) return;
            if (excelLoadState.market && excelLoadState.schedule) {
                // 只显示筛选控件，模块标题始终显示
                const marketFilterControls = document.getElementById('marketFilterControls');
                if (marketFilterControls) marketFilterControls.classList.remove('hidden');
                
                const destinationFiltersPanel = document.getElementById('destinationFilters');
                if (destinationFiltersPanel) destinationFiltersPanel.classList.remove('hidden');
                
                const viewToggle = document.getElementById('viewToggle');
                if (viewToggle) viewToggle.classList.remove('hidden');

                document.querySelectorAll('.module-card').forEach(card => {
                    card.classList.remove('hidden');
                });
                
                modulesVisible = true;
            }
        }

        refreshBunkerBtn?.addEventListener('click', () => {
            fetchBunkerData(true).catch(error => {
                debugWarn('燃油行情抓取失败', error);
                bunkerStatusEl && (bunkerStatusEl.textContent = '抓取失败，请稍后重试或检查网络');
                bunkerUpdatedEl && (bunkerUpdatedEl.textContent = '最近更新时间：—');
            });
        });
        refreshWciBtn?.addEventListener('click', () => {
            fetchWciData(true).catch(error => {
                debugWarn('WCI 抓取失败', error);
                if (wciStatusEl) wciStatusEl.textContent = '抓取失败，请稍后重试';
            });
        });
        refreshFbxBtn?.addEventListener('click', () => {
            fetchFbxData(true).catch(error => {
                debugWarn('FBX 抓取失败', error);
                if (fbxStatusEl) fbxStatusEl.textContent = '抓取失败，请稍后重试';
            });
        });

        const CACHE_KEYS = {
            wci: 'wciDataCache',
            fbx: 'fbxDataCache'
        };

        // escapeRegex, computePercentChange, formatPercent, loadCachedData, saveCachedData 已从 vendor/common-utils.js 加载
        // applyWoWFromCache, extractTextFromPdf, handleMarketReportFile, parseScfiTable, buildScfiDataSection 已从 vendor/market-analysis-utils.js 加载

        // 注册 SCFI 数据提取回调
        window.onScfiDataExtracted = (data, fileName) => {
            scfiData = data;
            renderScfiTable(data, fileName);
        };

        if (marketReportInput) {
            marketReportInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                if (marketReportList) {
                    marketReportList.innerHTML = '<li>正在解析上传的报告...</li>';
                }
                for (const file of files) {
                    try {
                        await handleMarketReportFile(file);
                        // 检查是否提取到 SCFI 数据
                        const latestReport = marketReports[marketReports.length - 1];
                        if (latestReport) {
                            debugLog('市场报告解析完成:', {
                                name: latestReport.name,
                                hasScfiData: !!latestReport.scfiData,
                                scfiData: latestReport.scfiData
                            });
                            if (latestReport.scfiData) {
                                scfiData = latestReport.scfiData;
                                renderScfiTable(latestReport.scfiData, file.name);
                            } else {
                                debugWarn('未找到 SCFI 数据，尝试手动提取...');
                                // 如果自动提取失败，尝试手动从全文提取
                                try {
                                    const fullText = latestReport.text;
                                    if (fullText) {
                                        const extractedScfi = parseScfiTable(fullText);
                                        if (extractedScfi) {
                                            debugLog('手动提取 SCFI 数据成功:', extractedScfi);
                                            scfiData = extractedScfi;
                                            latestReport.scfiData = extractedScfi;
                                            renderScfiTable(extractedScfi, file.name);
                                        } else {
                                            debugWarn('手动提取也失败，文本内容:', fullText.substring(0, 500));
                                        }
                                    }
                                } catch (extractError) {
                                    debugError('手动提取 SCFI 失败:', extractError);
                                }
                            }
                        }
                    } catch (error) {
                        debugError('解析PDF失败:', error);
                        showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', { message: error.message || String(error) }, error);
                    }
                }
                renderMarketReportList();
                marketReportInput.value = '';
            });
        }

        /**
         * 渲染 SCFI 表格
         * @param {Object} data - SCFI 数据
         * @param {string} source - 数据来源文件名
         */
        function renderScfiTable(data, source) {
            const container = document.getElementById('scfiTableContainer');
            const sourceEl = document.getElementById('scfiSource');
            const infoContainer = document.getElementById('scfiInfoContainer');
            
            if (!container || !infoContainer) {
                debugWarn('SCFI 表格容器未找到');
                return;
            }
            
            debugLog('渲染 SCFI 表格，数据:', data);
            
            if (!data || (!data.index && (!data.routes || data.routes.length === 0))) {
                debugWarn('SCFI 数据为空，隐藏表格');
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            let html = '<table class="scfi-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; table-layout: fixed;">';
            
            // 表头
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; text-align: left; border: 1px solid #ddd; width: 15%;">航线</th>';
            html += '<th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 5%;">单位</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">当期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年对比%</th>';
            html += '</tr>';
            
            // SCFI 综合指数行（作为第一行数据，在表头下面）
            if (data.index) {
                const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                const formatPercent = (val) => {
                    if (val === null || val === undefined) return '—';
                    const sign = val >= 0 ? '+' : '';
                    return sign + val.toFixed(1) + '%';
                };
                
                html += '<tr style="background: #f9f9f9; font-weight: bold;">';
                html += '<td style="padding: 8px; border: 1px solid #ddd;">SCFI 综合指数</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">—</td>'; // 单位列
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.index) + '</td>';
                // 上期指数 = 1周指数 (indexWeek1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexWeek1) + '</td>';
                // 上期对比% = 1周变化% (indexWeek1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexWeek1Change) + '</td>';
                // 上月指数 = 1个月指数 (indexMonth1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexMonth1) + '</td>';
                // 上月对比% = 1个月变化% (indexMonth1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexMonth1Change) + '</td>';
                // 上季度指数 = 3个月指数 (indexQuarter3)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexQuarter3) + '</td>';
                // 上季度对比% = 3个月变化% (indexQuarter3Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexQuarter3Change) + '</td>';
                // 上年指数 = 1年指数 (indexYear1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexYear1) + '</td>';
                // 上年对比% = 1年变化% (indexYear1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexYear1Change) + '</td>';
                html += '</tr>';
            }
            
            if (data.routes && data.routes.length > 0) {
                // 数据行
                data.routes.forEach(route => {
                    const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                    const formatPercent = (val) => {
                        if (val === null || val === undefined) return '—';
                        const sign = val >= 0 ? '+' : '';
                        return sign + val.toFixed(1) + '%';
                    };
                    
                    // 检查是否是India/East Africa/Central America，这些航线没有上年数据
                    const routeNameLower = (route.name || '').toLowerCase();
                    const hasNoYearData = routeNameLower.includes('india') || 
                                         routeNameLower.includes('nhava sheva') ||
                                         routeNameLower.includes('east africa') ||
                                         routeNameLower.includes('mombasa') ||
                                         routeNameLower.includes('central america') ||
                                         routeNameLower.includes('manzanillo');
                    
                    html += '<tr>';
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd;">${route.name}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">${route.unit || '—'}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.current)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.week1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.week1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.month1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.month1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.quarter3Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.quarter3Change)}</td>`;
                    // 如果是India/East Africa/Central America，上年数据显示为"—"
                    if (hasNoYearData) {
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                    } else {
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.year1Price)}</td>`;
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.year1Change)}</td>`;
                    }
                    html += '</tr>';
                });
            }
            
            html += '</table>';
            container.innerHTML = html;
            
            if (sourceEl) {
                sourceEl.textContent = `数据来源：${source}`;
            }
        }

        function initMarketSelectors() {
            if (marketSelectorsInitialized) return;
            if (marketRegionSelect) {
                setupMultiSelect(marketRegionSelect);
                marketRegionSelect.addEventListener('change', () => {
                    marketSelectedRegions = getSelectedValues(marketRegionSelect);
                    updateMarketPortOptions();
                    updateMarketChartFromSelection(false);
                });
            }

            if (marketPortSelect) {
                setupMultiSelect(marketPortSelect);
                marketPortSelect.addEventListener('change', () => {
                    marketSelectedPorts = getSelectedValues(marketPortSelect);
                    updateMarketChartFromSelection(true);
                });
            }

            marketSelectorsInitialized = true;
        }

        function updateMarketPortOptions() {
            if (!marketPortSelect) return;
            const targetRegions = marketSelectedRegions.length ? marketSelectedRegions : marketRegions;
            const portSet = new Set();
            targetRegions.forEach(region => {
                (marketRegionPortMap[region] || []).forEach(port => portSet.add(port));
            });

            // 使用标准港口顺序排序
            const allPorts = Array.from(portSet);
            const uniquePorts = (typeof sortPortsByStandardOrder === 'function')
                ? sortPortsByStandardOrder(allPorts)
                : allPorts.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            const filteredSelection = marketSelectedPorts.filter(port => uniquePorts.includes(port));
            marketSelectedPorts = filteredSelection;
            const selectedSet = new Set(filteredSelection);

            marketPortSelect.innerHTML = '';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = uniquePorts.length ? '全部港口' : '请先选择区域';
            if (!selectedSet.size) {
                placeholderOption.selected = true;
            }
            marketPortSelect.appendChild(placeholderOption);

            uniquePorts.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = port;
                if (selectedSet.has(port)) {
                    option.selected = true;
                }
                marketPortSelect.appendChild(option);
            });

            marketPortSelect.disabled = uniquePorts.length === 0;
        }

        function updateMarketChartFromSelection(showAlertIfEmpty) {
            if (!marketSelectedPorts.length) {
                if (showAlertIfEmpty) {
                    marketInfoText && (marketInfoText.textContent = '请选择至少一个港口以生成走势图');
                }
                if (marketChart) {
                    marketChart.destroy();
                    marketChart = null;
                }
                marketChartContainer?.classList.add('hidden');
                marketDateControls?.classList.add('hidden');
                return;
            }
            updateMarketChart(marketSelectedPorts);
        }

        fileInput?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (typeof XLSX === 'undefined') {
                showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                return;
            }

            try {
                const data = await readMarketExcelFile(file);
                if (!data.length) {
                    showError(ErrorType.FILE_LOAD, 'FILE_EMPTY');
                    return;
                }

                marketData = data;
                const firstRow = data[0] || {};
                const columnKeys = Object.keys(firstRow);

                const findColumn = (keywords, fallbackIndex = null) => {
                    const key = columnKeys.find(col =>
                        keywords.some(word => (col || '').toString().toLowerCase().includes(word.toLowerCase()))
                    );
                    if (key) return key;
                    if (typeof fallbackIndex === 'number' && columnKeys[fallbackIndex]) {
                        return columnKeys[fallbackIndex];
                    }
                    return null;
                };

                const regionCol = findColumn(['区域', 'region', '地区', 'area'], 8);
                const portCol = findColumn(['港口', 'port', '目的港', '目的'], 3);
                const dateCol = findColumn(['日期', 'date', '时间', 'time'], 0);

                if (!regionCol || !portCol) {
                    showError(ErrorType.FILE_PARSE, 'MISSING_REGION_PORT', { columns: columnKeys.join(', ') });
                    return;
                }

                marketColumnConfig = { portCol, dateCol };
                marketRegionPortMap = {};

                data.forEach(row => {
                    const region = String(row[regionCol] || '').trim();
                    const port = String(row[portCol] || '').trim();
                    if (!region || !port) return;
                    if (!marketRegionPortMap[region]) {
                        marketRegionPortMap[region] = new Set();
                    }
                    marketRegionPortMap[region].add(port);
                });

                // 使用标准区域顺序排序（严格按照 STANDARD_AREA_ORDER 的顺序）
                const allRegions = Object.keys(marketRegionPortMap);
                // 处理区域名称变体（如"中东印巴红海" -> "中东红海印巴"）
                const normalizeAreaName = (areaName) => {
                    if (!areaName) return areaName;
                    // 如果包含"中东"、"印巴"、"红海"这些关键词，统一映射到"中东红海印巴"
                    if (areaName.includes('中东') && (areaName.includes('印巴') || areaName.includes('红海'))) {
                        return '中东红海印巴';
                    }
                    return areaName;
                };
                
                // 确保使用标准区域顺序排序
                if (typeof sortAreasByStandardOrder === 'function') {
                    marketRegions = sortAreasByStandardOrder(allRegions);
                } else if (typeof STANDARD_AREA_ORDER !== 'undefined') {
                    // 如果 sortAreasByStandardOrder 不可用，手动排序
                    const areaOrderMap = new Map();
                    STANDARD_AREA_ORDER.forEach((area, index) => {
                        areaOrderMap.set(area, index);
                    });
                    // 创建新数组进行排序，不修改原数组
                    marketRegions = [...allRegions].sort((a, b) => {
                        const normalizedA = normalizeAreaName(a);
                        const normalizedB = normalizeAreaName(b);
                        const indexA = areaOrderMap.has(normalizedA) ? areaOrderMap.get(normalizedA) : Infinity;
                        const indexB = areaOrderMap.has(normalizedB) ? areaOrderMap.get(normalizedB) : Infinity;
                        if (indexA !== Infinity && indexB !== Infinity) {
                            return indexA - indexB;
                        }
                        if (indexA !== Infinity) return -1;
                        if (indexB !== Infinity) return 1;
                        return a.localeCompare(b, 'zh-Hans-CN');
                    });
                } else {
                    marketRegions = [...allRegions].sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                }
                const totalPorts = marketRegions.reduce((sum, region) => sum + marketRegionPortMap[region].size, 0);
                marketRegions.forEach(region => {
                    marketRegionPortMap[region] = Array.from(marketRegionPortMap[region]).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                });

                if (marketRegionSelect) {
                    marketRegionSelect.innerHTML = '';
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = '全部区域';
                    placeholder.selected = true;
                    marketRegionSelect.appendChild(placeholder);
                    // marketRegions 已经按标准顺序排序，直接使用
                    marketRegions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region;
                        option.textContent = `${region} (${marketRegionPortMap[region].length}个港口)`;
                        marketRegionSelect.appendChild(option);
                    });
                }

                initMarketSelectors();
                marketSelectedRegions = [];
                marketSelectedPorts = [];
                updateMarketPortOptions();

                // 筛选控件在 tryRevealModules() 中统一显示
                marketInfoBox?.classList.remove('hidden');
                if (marketInfoText) {
                    marketInfoText.textContent = `已加载 ${data.length} 条数据，共 ${marketRegions.length} 个区域，${totalPorts} 个港口`;
                }

                if (dateCol && marketStartDate && marketEndDate) {
                    const dates = data
                        .map(row => marketParseDate(row[dateCol]))
                        .filter(value => value instanceof Date && !isNaN(value))
                        .sort((a, b) => a - b);

                    if (dates.length) {
                        const minDate = dates[0];
                        const maxDate = dates[dates.length - 1];
                        const minStr = marketFormatDateForInput(minDate);
                        const maxStr = marketFormatDateForInput(maxDate);

                        marketStartDate.min = minStr;
                        marketStartDate.max = maxStr;
                        marketStartDate.value = minStr;

                        marketEndDate.min = minStr;
                        marketEndDate.max = maxStr;
                        marketEndDate.value = maxStr;
                    } else {
                        marketStartDate.value = '';
                        marketEndDate.value = '';
                    }
                }

                marketChartContainer?.classList.add('hidden');
                marketDateControls?.classList.remove('hidden');
                excelLoadState.market = true;
                tryRevealModules();
                } catch (error) {
                    showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                    debugError(error);
                }
        });

        marketRegionSelect?.addEventListener('change', (e) => {
            const selectedRegion = e.target.value;
            if (!marketPortSelect) return;

            marketPortSelect.innerHTML = '<option value="">请选择港口</option>';
            if (selectedRegion && marketRegionPortMap[selectedRegion]) {
                marketRegionPortMap[selectedRegion].forEach(port => {
                    const option = document.createElement('option');
                    option.value = port;
                    option.textContent = port;
                    marketPortSelect.appendChild(option);
                });
            }

            marketPortSelect.value = '';
            marketChartContainer?.classList.add('hidden');
        });

        marketStartDate?.addEventListener('change', () => {
            if (marketSelectedPorts.length) {
                updateMarketChart(marketSelectedPorts);
            } else {
                updateMarketChartFromSelection(false);
            }
        });

        marketEndDate?.addEventListener('change', () => {
            if (marketSelectedPorts.length) {
                updateMarketChart(marketSelectedPorts);
            } else {
                updateMarketChartFromSelection(false);
            }
        });

        async function readMarketExcelFile(file) {
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX 库未加载，请刷新页面重试'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false });
                        const sheetName = workbook.SheetNames.find(name =>
                            name.toLowerCase().includes('market')
                        ) || workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function marketFormatDateForInput(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 使用统一的日期解析函数（从 vendor/date-utils.js）
        function marketParseDate(value) {
            return parseDateValue(value);
        }

        function updateMarketChart(ports) {
            if (!marketData.length || !marketColumnConfig.portCol) {
                showError(ErrorType.DATA_VALIDATION, 'NO_EXCEL_LOADED');
                return;
            }

            const selectedPorts = Array.isArray(ports) ? ports.filter(Boolean) : [ports].filter(Boolean);
            if (!selectedPorts.length) {
                marketChartContainer?.classList.add('hidden');
                return;
            }

            const { portCol, dateCol } = marketColumnConfig;
            const startValue = marketStartDate?.value;
            const endValue = marketEndDate?.value;
            const startDateObj = startValue ? new Date(startValue + 'T00:00:00') : null;
            const endDateObj = endValue ? new Date(endValue + 'T23:59:59') : null;

            const labelMap = new Map(); // label -> Date
            const seriesData = [];

            selectedPorts.forEach(port => {
                let rows = marketData.filter(row => String(row[portCol] || '').trim() === port);

                if (!rows.length) {
                    return;
                }

                if (dateCol) {
                    rows = rows.filter(row => {
                        const rowDate = marketParseDate(row[dateCol]);
                        if (!(rowDate instanceof Date) || isNaN(rowDate)) return false;
                        const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
                        if (startDateObj && rowDateOnly < startDateObj) return false;
                        if (endDateObj && rowDateOnly > endDateObj) return false;
                        return true;
                    });
                }

                if (!rows.length) {
                    return;
                }

                rows.sort((a, b) => {
                    const dateA = marketParseDate(a[dateCol]);
                    const dateB = marketParseDate(b[dateCol]);
                    if (dateA && dateB) {
                        return dateA - dateB;
                    }
                    return 0;
                });

                const valueMap = new Map(); // label -> {gp20, gp40}

                rows.forEach(row => {
                    const date = dateCol ? marketParseDate(row[dateCol]) : null;
                    let label;
                    if (date) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        label = `${year}/${month}/${day}`;
                        labelMap.set(label, date);
                    } else {
                        label = row[dateCol] ? String(row[dateCol]) : '';
                    }
                    const gp20 = row['20GP'] || row['20gp'] || row['GP20'];
                    const gp40 = row['40GP'] || row['40gp'] || row['GP40'];
                    valueMap.set(label, {
                        gp20: gp20 ? parseFloat(gp20) : null,
                        gp40: gp40 ? parseFloat(gp40) : null
                    });
                });

                seriesData.push({
                    port,
                    values: valueMap
                });
            });

            if (!seriesData.length) {
                marketInfoText && (marketInfoText.textContent = '所选港口在当前时间范围内暂无数据');
                if (marketChart) {
                    marketChart.destroy();
                    marketChart = null;
                }
                marketChartContainer?.classList.add('hidden');
                return;
            }

            const sortedLabels = Array.from(labelMap.entries())
                .sort((a, b) => a[1] - b[1])
                .map(entry => entry[0]);

            if (!sortedLabels.length) {
                marketInfoText && (marketInfoText.textContent = '当前筛选下缺少有效日期');
                marketChartContainer?.classList.add('hidden');
                return;
            }

            const palettes = [
                '#667eea',
                '#ff6b6b',
                '#20c997',
                '#f9a826',
                '#845ef7',
                '#17a2b8',
                '#ff9f43',
                '#6f42c1'
            ];

            const datasets = [];

            seriesData.forEach((series, index) => {
                const color = palettes[index % palettes.length];
                const gp20Values = [];
                const gp40Values = [];

                sortedLabels.forEach(label => {
                    const record = series.values.get(label);
                    gp20Values.push(record?.gp20 ?? null);
                    gp40Values.push(record?.gp40 ?? null);
                });

                datasets.push({
                    label: `${series.port} - 20GP`,
                    data: gp20Values,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    spanGaps: true
                });

                datasets.push({
                    label: `${series.port} - 40GP`,
                    data: gp40Values,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderDash: [6, 4],
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    spanGaps: true
                });
            });

            if (marketChart) {
                marketChart.destroy();
            }

            const ctx = document.getElementById('marketTrendChart').getContext('2d');
            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedLabels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback(value) {
                                    return '$' + value;
                                }
                            },
                            title: {
                                display: true,
                                text: '价格 (USD)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            marketChartContainer?.classList.remove('hidden');
            marketDateControls?.classList.remove('hidden');

            if (marketInfoText) {
                const labelCount = sortedLabels.length;
                let infoText = `已选择 ${seriesData.length} 个港口（${selectedPorts.join('、')}），共 ${labelCount} 个时间节点`;
                
                // 计算每个港口的价格范围
                const priceRanges = [];
                seriesData.forEach(series => {
                    const gp20Prices = [];
                    const gp40Prices = [];
                    
                    sortedLabels.forEach(label => {
                        const record = series.values.get(label);
                        if (record?.gp20 !== null && record?.gp20 !== undefined) {
                            gp20Prices.push(record.gp20);
                        }
                        if (record?.gp40 !== null && record?.gp40 !== undefined) {
                            gp40Prices.push(record.gp40);
                        }
                    });
                    
                    if (gp20Prices.length > 0 || gp40Prices.length > 0) {
                        const gp20Min = gp20Prices.length > 0 ? Math.min(...gp20Prices) : null;
                        const gp20Max = gp20Prices.length > 0 ? Math.max(...gp20Prices) : null;
                        const gp40Min = gp40Prices.length > 0 ? Math.min(...gp40Prices) : null;
                        const gp40Max = gp40Prices.length > 0 ? Math.max(...gp40Prices) : null;
                        
                        let rangeText = `${series.port}：`;
                        const parts = [];
                        if (gp20Min !== null && gp20Max !== null) {
                            parts.push(`20GP ${gp20Min.toLocaleString()} ~ ${gp20Max.toLocaleString()}`);
                        }
                        if (gp40Min !== null && gp40Max !== null) {
                            parts.push(`40GP ${gp40Min.toLocaleString()} ~ ${gp40Max.toLocaleString()}`);
                        }
                        if (parts.length > 0) {
                            rangeText += parts.join('，');
                            priceRanges.push(rangeText);
                        }
                    }
                });
                
                // 将价格范围信息添加到主文本中，如果内容较长则分行显示
                if (priceRanges.length > 0) {
                    infoText += '\n' + priceRanges.join('\n');
                }
                
                marketInfoText.textContent = infoText;
            }
        }
    </script>

    <script>
        let scheduleData = [];
        let processedRecords = [];
        let groupedTableData = [];
        let latestFilteredRecords = [];
        let destinationHierarchy = {};
        let destinationFilters = {
            areas: [],
            subAreas: [],
            countries: [],
            ports: []
        };
        let currentView = 'all'; // 'all', 'capacity', 'ships'
        let weekColumns = []; // 当周+未来四周（共5周）
        let capacityChart = null; // Chart.js实例
        let routeFilterValue = '';
        let routeLabelMap = {};
        let routePathMap = {}; // 存储routeId -> routePath的映射

        const infoBox = document.getElementById('infoBox');
        const infoText = document.getElementById('infoText');
        const tableContainer = document.getElementById('tableContainer');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const viewToggle = document.getElementById('viewToggle');
        const btnAll = document.getElementById('btnAll');
        const btnCapacity = document.getElementById('btnCapacity');
        const btnShips = document.getElementById('btnShips');
        const destinationFiltersPanel = document.getElementById('destinationFilters');
        const areaSelect = document.getElementById('areaSelect');
        const subAreaSelect = document.getElementById('subAreaSelect');
        const countrySelect = document.getElementById('countrySelect');
        const portSelect = document.getElementById('portSelect');

        // getSelectedValues 和 setupMultiSelect 已从 vendor/common-utils.js 加载

        // normalizeDestinationValue, registerRouteLabel, getRouteLabel 已从 vendor/market-analysis-utils.js 加载

        function addToDestinationHierarchy(area, subArea, country, port) {
            const areaKey = area || '未分配';
            const subAreaKey = subArea || '未分配';
            const countryKey = country || '未分配';
            const portKey = port || '未分配';

            if (!destinationHierarchy[areaKey]) {
                destinationHierarchy[areaKey] = { subAreas: {} };
            }
            if (!destinationHierarchy[areaKey].subAreas[subAreaKey]) {
                destinationHierarchy[areaKey].subAreas[subAreaKey] = { countries: {} };
            }
            if (!destinationHierarchy[areaKey].subAreas[subAreaKey].countries[countryKey]) {
                destinationHierarchy[areaKey].subAreas[subAreaKey].countries[countryKey] = { ports: new Set() };
            }
            destinationHierarchy[areaKey]
                .subAreas[subAreaKey]
                .countries[countryKey]
                .ports
                .add(portKey);
        }

        // populateSelect 函数已从 vendor/market-analysis-utils.js 加载
        // 本地的 populateSelect 函数已被移除，统一使用 vendor 中的版本以支持 useAreaOrder 和 usePortOrder 参数
        // 如果需要调用，直接使用 populateSelect 即可（它会使用全局函数）

        function collectCountryOptions(area, selectedSubAreas) {
            if (!area || !selectedSubAreas || !selectedSubAreas.length) return [];
            const subAreaMap = destinationHierarchy[area]?.subAreas || {};
            const set = new Set();
            selectedSubAreas.forEach(subArea => {
                const countries = subAreaMap[subArea]?.countries || {};
                Object.keys(countries).forEach(country => set.add(country));
            });
            return Array.from(set);
        }

        function collectPortOptions(area, selectedSubAreas, selectedCountries) {
            if (!area || !selectedSubAreas?.length || !selectedCountries?.length) return [];
            const subAreaMap = destinationHierarchy[area]?.subAreas || {};
            const set = new Set();
            selectedSubAreas.forEach(subArea => {
                const countriesMap = subAreaMap[subArea]?.countries || {};
                selectedCountries.forEach(country => {
                    const portsSet = countriesMap[country]?.ports || new Set();
                    portsSet.forEach(port => set.add(port));
                });
            });
            return Array.from(set);
        }

        function collectSubAreaOptions(selectedAreas) {
            if (!selectedAreas?.length) return [];
            const set = new Set();
            selectedAreas.forEach(area => {
                const subMap = destinationHierarchy[area]?.subAreas || {};
                Object.keys(subMap).forEach(sub => set.add(sub));
            });
            return Array.from(set);
        }

        function collectCountryOptions(selectedAreas, selectedSubAreas) {
            if (!selectedAreas?.length) return [];
            const set = new Set();
            selectedAreas.forEach(area => {
                const subMap = destinationHierarchy[area]?.subAreas || {};
                const subKeys = selectedSubAreas.length ? selectedSubAreas : Object.keys(subMap);
                subKeys.forEach(sub => {
                    const countries = subMap[sub]?.countries || {};
                    Object.keys(countries).forEach(country => set.add(country));
                });
            });
            return Array.from(set);
        }

        function collectPortOptions(selectedAreas, selectedSubAreas, selectedCountries) {
            if (!selectedAreas?.length) return [];
            const set = new Set();
            selectedAreas.forEach(area => {
                const subMap = destinationHierarchy[area]?.subAreas || {};
                const subKeys = selectedSubAreas.length ? selectedSubAreas : Object.keys(subMap);
                subKeys.forEach(sub => {
                    const countriesMap = subMap[sub]?.countries || {};
                    const countryKeys = selectedCountries.length ? selectedCountries : Object.keys(countriesMap);
                    countryKeys.forEach(country => {
                        const portsSet = countriesMap[country]?.ports || new Set();
                        portsSet.forEach(port => set.add(port));
                    });
                });
            });
            return Array.from(set);
        }

        function updateDestinationFilterOptions() {
            const areaOptions = Object.keys(destinationHierarchy || {});
            destinationFilters.areas = destinationFilters.areas.filter(value => areaOptions.includes(value));
            if (!destinationFilters.areas.length) {
                destinationFilters.subAreas = [];
                destinationFilters.countries = [];
                destinationFilters.ports = [];
            }

            const subAreaOptions = destinationFilters.areas.length
                ? collectSubAreaOptions(destinationFilters.areas)
                : [];
            destinationFilters.subAreas = destinationFilters.subAreas.filter(value => subAreaOptions.includes(value));
            if (!destinationFilters.subAreas.length) {
                destinationFilters.countries = [];
                destinationFilters.ports = [];
            }

            const countryOptions = destinationFilters.areas.length
                ? collectCountryOptions(destinationFilters.areas, destinationFilters.subAreas)
                : [];
            destinationFilters.countries = destinationFilters.countries.filter(value => countryOptions.includes(value));
            if (!destinationFilters.countries.length) {
                destinationFilters.ports = [];
            }

            const portOptions = destinationFilters.areas.length
                ? collectPortOptions(
                    destinationFilters.areas,
                    destinationFilters.subAreas,
                    destinationFilters.countries
                )
                : [];
            destinationFilters.ports = destinationFilters.ports.filter(value => portOptions.includes(value));

            // 使用标准区域顺序排序（严格按照 STANDARD_AREA_ORDER 的顺序）
            // 处理区域名称变体（如"中东印巴红海" -> "中东红海印巴"）
            const normalizeAreaName = (areaName) => {
                if (!areaName) return areaName;
                // 如果包含"中东"、"印巴"、"红海"这些关键词，统一映射到"中东红海印巴"
                if (areaName.includes('中东') && (areaName.includes('印巴') || areaName.includes('红海'))) {
                    return '中东红海印巴';
                }
                return areaName;
            };
            
            // 确保使用标准区域顺序排序
            // 注意：直接使用 useAreaOrder=true，让 populateSelect 内部处理排序
            // 这样可以确保排序逻辑统一，避免重复排序
            populateSelect(areaSelect, areaOptions, '全部区域', destinationFilters.areas, false, false, true);
            populateSelect(
                subAreaSelect,
                subAreaOptions,
                '全部子区域',
                destinationFilters.subAreas,
                !destinationFilters.areas.length
            );
            populateSelect(
                countrySelect,
                countryOptions,
                '全部国家 / 地区',
                destinationFilters.countries,
                !(destinationFilters.areas.length && destinationFilters.subAreas.length)
            );
            populateSelect(
                portSelect,
                portOptions,
                '全部港口',
                destinationFilters.ports,
                !(destinationFilters.areas.length && destinationFilters.subAreas.length && destinationFilters.countries.length)
            );
        }


        function getCurrentGroupLevel() {
            if (destinationFilters.ports.length > 0) return 4;
            if (destinationFilters.countries.length > 0) return 3;
            if (destinationFilters.subAreas.length > 0) return 2;
            if (destinationFilters.areas.length > 0) return 1;
            return 0;
        }

        function getFilteredRecords() {
            const routeFilterText = routeFilterValue.trim().toLowerCase();
            const weekCodes = getWeekRange();
            const filtered = processedRecords.filter(record => {
                if (destinationFilters.areas.length && !destinationFilters.areas.includes(record.area)) return false;
                if (destinationFilters.subAreas.length && !destinationFilters.subAreas.includes(record.subArea)) return false;
                if (destinationFilters.countries.length && !destinationFilters.countries.includes(record.country)) return false;
                if (destinationFilters.ports.length && !destinationFilters.ports.includes(record.port)) return false;
                if (!weekCodes.includes(record.weekCode)) return false;
                if (routeFilterText) {
                    const routeText = String(record.routeLabel || record.route || '').toLowerCase();
                    if (!routeText.includes(routeFilterText)) return false;
                }
                return true;
            });
            // 统一去重（使用 vendor 中的标准函数）
            if (typeof deduplicateSailingItems === 'function') {
                return deduplicateSailingItems(filtered);
            }
            return filtered;
        }

        // buildShipSignature 已从 vendor/market-analysis-utils.js 加载

        function buildDedupKey(record, groupLevel) {
            const safe = value => (value && value.trim() ? value.trim() : '未分配');
            const routeId = record.routeId && record.routeId.trim ? record.routeId.trim() : (record.routeId || '');
            const shipSignature = buildShipSignature(record);

            if (groupLevel >= 4) {
                return `port|${shipSignature}`;
            }

            if (groupLevel === 3) {
                return routeId ? `country|${routeId}` : `country|${shipSignature}`;
            }

            if (groupLevel === 2) {
                const country = safe(record.country || '');
                return routeId ? `countryLayer|${country}|${routeId}` : `countryLayer|${country}|${shipSignature}`;
            }

            const subArea = safe(record.subArea || '');
            return routeId ? `area|${subArea}|${routeId}` : `area|${subArea}|${shipSignature}`;
        }

        function groupRecords(records) {
            const groups = new Map();

            records.forEach(record => {
                const routeLabel = record.routeLabel || record.route || '未知航线';
                const routeKey = record.routeId || routeLabel;
                const routeRemark = record.routeRemark || '';
                const routePath = record.routePath || routePathMap[record.routeId] || '';

                // 使用routeId作为唯一key
                const key = routeKey;

                if (!groups.has(key)) {
                    groups.set(key, {
                        routeLabel,
                        routeId: record.routeId || '',
                        routeRemark,
                        routePath,
                        weeks: {}
                    });
                }

                const group = groups.get(key);
                if (!group.weeks[record.weekCode]) {
                    group.weeks[record.weekCode] = [];
                }

                const entries = group.weeks[record.weekCode];
                // 去重时只考虑船名航次+运力+日期，不考虑港口，这样多选港口时同一船名航次会合并显示
                const dedupKey = buildShipSignature(record);
                const exists = entries.some(item => item.dedupKey === dedupKey);
                if (exists) {
                    return;
                }
                entries.push({
                    capacity: record.capacity,
                    shipName: record.shipName,
                    shipDate: record.shipDate,
                    routeId: record.routeId || '',
                    dedupKey
                });
            });

            const sorted = Array.from(groups.values()).sort((a, b) => {
                return (a.routeLabel || '').localeCompare(b.routeLabel || '');
            });

            return {
                data: sorted,
                level: 0
            };
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // 检查 XLSX 是否已加载
            if (typeof XLSX === 'undefined') {
                showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                return;
            }

            try {
                const data = await readExcelFile(file);
                scheduleData = data;
                generatePivotTable(data);
                infoText.textContent = `已加载 ${data.length} 条船期数据`;
                infoBox.classList.remove('hidden');
                excelLoadState.schedule = true;
                tryRevealModules();
            } catch (error) {
                showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                debugError(error);
            }
        });

        btnAll.addEventListener('click', () => {
            currentView = 'all';
            btnAll.classList.add('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnCapacity.addEventListener('click', () => {
            currentView = 'capacity';
            btnAll.classList.remove('active');
            btnCapacity.classList.add('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnShips.addEventListener('click', () => {
            currentView = 'ships';
            btnAll.classList.remove('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.add('active');
            renderTable();
        });

        if (areaSelect) {
            setupMultiSelect(areaSelect);
            areaSelect.addEventListener('change', () => {
                destinationFilters.areas = getSelectedValues(areaSelect);
                if (!destinationFilters.areas.length) {
                    destinationFilters.subAreas = [];
                    destinationFilters.countries = [];
                    destinationFilters.ports = [];
                }
                updateDestinationFilterOptions();
                renderTable();
            });
        }

        if (subAreaSelect) {
            setupMultiSelect(subAreaSelect);
            subAreaSelect.addEventListener('change', () => {
                destinationFilters.subAreas = getSelectedValues(subAreaSelect);
                destinationFilters.countries = [];
                destinationFilters.ports = [];
                updateDestinationFilterOptions();
                renderTable();
            });
        }

        if (countrySelect) {
            setupMultiSelect(countrySelect);
            countrySelect.addEventListener('change', () => {
                destinationFilters.countries = getSelectedValues(countrySelect);
                destinationFilters.ports = [];
                updateDestinationFilterOptions();
                renderTable();
            });
        }

        if (portSelect) {
            setupMultiSelect(portSelect);
            portSelect.addEventListener('change', () => {
                destinationFilters.ports = getSelectedValues(portSelect);
                updateDestinationFilterOptions();
                renderTable();
            });
        }

        // 绑定"全部选择"和"清除选择"按钮事件
        // 运费走势模块
        const marketRegionSelectAll = document.getElementById('marketRegionSelectAll');
        const marketRegionClear = document.getElementById('marketRegionClear');
        const marketPortSelectAll = document.getElementById('marketPortSelectAll');
        const marketPortClear = document.getElementById('marketPortClear');
        
        if (marketRegionSelectAll && marketRegionSelect) {
            marketRegionSelectAll.addEventListener('click', () => selectAllOptions(marketRegionSelect));
        }
        if (marketRegionClear && marketRegionSelect) {
            marketRegionClear.addEventListener('click', () => clearSelectOptions(marketRegionSelect));
        }
        if (marketPortSelectAll && marketPortSelect) {
            marketPortSelectAll.addEventListener('click', () => selectAllOptions(marketPortSelect));
        }
        if (marketPortClear && marketPortSelect) {
            marketPortClear.addEventListener('click', () => clearSelectOptions(marketPortSelect));
        }
        
        // 航线运力分析模块
        const areaSelectAll = document.getElementById('areaSelectAll');
        const areaClearAll = document.getElementById('areaClearAll');
        const subAreaSelectAll = document.getElementById('subAreaSelectAll');
        const subAreaClearAll = document.getElementById('subAreaClearAll');
        const countrySelectAll = document.getElementById('countrySelectAll');
        const countryClearAll = document.getElementById('countryClearAll');
        const portSelectAll = document.getElementById('portSelectAll');
        const portClearAll = document.getElementById('portClearAll');
        
        if (areaSelectAll && areaSelect) {
            areaSelectAll.addEventListener('click', () => selectAllOptions(areaSelect));
        }
        if (areaClearAll && areaSelect) {
            areaClearAll.addEventListener('click', () => clearSelectOptions(areaSelect));
        }
        if (subAreaSelectAll && subAreaSelect) {
            subAreaSelectAll.addEventListener('click', () => selectAllOptions(subAreaSelect));
        }
        if (subAreaClearAll && subAreaSelect) {
            subAreaClearAll.addEventListener('click', () => clearSelectOptions(subAreaSelect));
        }
        if (countrySelectAll && countrySelect) {
            countrySelectAll.addEventListener('click', () => selectAllOptions(countrySelect));
        }
        if (countryClearAll && countrySelect) {
            countryClearAll.addEventListener('click', () => clearSelectOptions(countrySelect));
        }
        if (portSelectAll && portSelect) {
            portSelectAll.addEventListener('click', () => selectAllOptions(portSelect));
        }
        if (portClearAll && portSelect) {
            portClearAll.addEventListener('click', () => clearSelectOptions(portSelect));
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX 库未加载，请刷新页面重试'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 查找 schedule 工作表
                        const sheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('schedule')
                        ) || workbook.SheetNames[0];
                        
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // 将周别文本转换为YYYYWW格式（如：202547）
        // parseWeekText, getCurrentWeekCode, getWeekRange, getWeekNumber, getISOWeek, getWeekDateRange 已从 vendor/market-analysis-utils.js 加载


        function generatePivotTable(data) {
            if (!data || data.length === 0) {
                showError(ErrorType.DATA_VALIDATION, 'DATA_EMPTY');
                return;
            }

            const firstRow = data[0];
            const columnKeys = Object.keys(firstRow);

            const matchesKeyword = (key, keyword) => {
                if (!key) return false;
                const lowerKey = key.toLowerCase();
                return lowerKey.includes(keyword.toLowerCase()) || key.includes(keyword);
            };

            const findColumnKey = (keywords, fallbackIndex = null) => {
                const key = columnKeys.find(col =>
                    keywords.some(keyword => matchesKeyword(col, keyword))
                );
                if (key) return key;
                if (typeof fallbackIndex === 'number' && columnKeys[fallbackIndex]) {
                    return columnKeys[fallbackIndex];
                }
                return null;
            };

            const weekCol = findColumnKey(['周别', '周次', '周数', 'week'], 17);
            const capacityCol = findColumnKey(['运力', 'teu', '舱位'], 18);
            const shipNameCol = findColumnKey(['船名', '航次', 'vessel'], 11);
            const shipDateCol = findColumnKey(['开船', '船期', '离港', 'etd', '时间'], 12);
            const routeIdCol = findColumnKey(['航线id', '航线ID', 'route id', 'group_id', 'groupid'], 6);

            const routeCol =
                columnKeys.find(col => matchesKeyword(col, '共舱')) ||
                columnKeys.find(col => matchesKeyword(col, '船公司')) ||
                columnKeys.find(col => matchesKeyword(col, '航线') && !matchesKeyword(col, 'id')) ||
                columnKeys.find(col => matchesKeyword(col, 'route')) ||
                (columnKeys[9] || null);
            const routeRemarkCol = columnKeys[10] || null; // K列（索引10）
            const routePathCol = columnKeys[24] || null; // Y列（索引24）
            const areaCol = findColumnKey(['区域', '大区', 'region']);
            const subAreaCol = findColumnKey(['子区域', '次区域', 'sub'], null);
            const countryCol = findColumnKey(['国家地区', '国家/地区', '国家', 'country'], null);
            const portCol = findColumnKey(['港口', '目的港', 'pod'], 1);

            if (!weekCol || !capacityCol || !shipNameCol || !shipDateCol || !routeCol) {
                showError(ErrorType.FILE_PARSE, 'MISSING_COLUMNS', { columns: columnKeys.join(', ') });
                return;
            }

            // 固定显示当周+未来4周（共5周）
            const weekCodes = getWeekRange();
            weekColumns = weekCodes.map(code => {
                const year = code.substring(0, 4);
                const weekNo = parseInt(code.substring(4), 10);
                const dateRange = getWeekDateRange(code);
                return {
                    code,
                    label: `${year}/${String(weekNo).padStart(2, '0')}`,
                    range: dateRange.range
                };
            });

            processedRecords = [];
            destinationHierarchy = {};
            destinationFilters = { areas: [], subAreas: [], countries: [], ports: [] };
            routeFilterValue = '';
            routeLabelMap = {};

            data.forEach(row => {
                const weekText = String(row[weekCol] ?? '').trim();
                const weekCode = parseWeekText(weekText);
                if (!weekCode) {
                    return;
                }

                const area = normalizeDestinationValue(row[areaCol]);
                const subArea = normalizeDestinationValue(row[subAreaCol]);
                const country = normalizeDestinationValue(row[countryCol]);
                const port = normalizeDestinationValue(row[portCol]);
                let route = String(row[routeCol] ?? '').trim();
                const routeId = routeIdCol ? String(row[routeIdCol] ?? '').trim() : '';
                const routeRemark = routeRemarkCol ? String(row[routeRemarkCol] ?? '').trim() : '';
                const routePath = routePathCol ? String(row[routePathCol] ?? '').trim() : '';
                const capacity = parseFloat(row[capacityCol]) || 0;
                const shipName = String(row[shipNameCol] ?? '').trim();
                const shipDate = String(row[shipDateCol] ?? '').trim();

                if (!route) {
                    route = '未知航线';
                }

                if (routeId) {
                    if (route && route !== '未知航线') {
                        registerRouteLabel(routeId, route);
                    }
                    route = getRouteLabel(routeId, route);
                    // 存储路径信息
                    if (routePath) {
                        routePathMap[routeId] = routePath;
                    }
                }

                const record = {
                    area,
                    subArea,
                    country,
                    port,
                    route,
                    routeId,
                    routeRemark,
                    routePath,
                    weekCode,
                    capacity,
                    shipName,
                    shipDate
                };
                processedRecords.push(record);
                addToDestinationHierarchy(area, subArea, country, port);
            });

            processedRecords = processedRecords.map(record => ({
                ...record,
                routeLabel: getRouteLabel(record.routeId, record.route)
            }));
            if (processedRecords.length === 0) {
                showError(ErrorType.FILE_PARSE, 'NO_SCHEDULE_DATA');
                return;
            }

            // 筛选控件在 tryRevealModules() 中统一显示
            updateDestinationFilterOptions();
            renderTable();
            updateAiAnalysis(false);
        }

        function renderTable() {
            if (!processedRecords.length) {
                tableContainer.classList.add('hidden');
                updateChart(false, []);
                updateAiAnalysis(false);
                return;
            }

            // 固定显示当周+未来4周（共5周）
            const weekCodes = getWeekRange();
            weekColumns = weekCodes.map(code => {
                const year = code.substring(0, 4);
                const weekNo = parseInt(code.substring(4), 10);
                const dateRange = getWeekDateRange(code);
                return {
                    code,
                    label: `${year}/${String(weekNo).padStart(2, '0')}`,
                    range: dateRange.range
                };
            });

            const filteredRecords = getFilteredRecords();
            latestFilteredRecords = filteredRecords;
            const groupedResult = groupRecords(filteredRecords);
            const groupedData = groupedResult.data;
            groupedTableData = groupedData;
            const hasAreaSelected = destinationFilters.areas.length > 0;

            const safeRouteValue = (routeFilterValue || '').replace(/"/g, '&quot;');

            tableHead.innerHTML = `
                <tr>
                    <th class="filter-header" style="width: 200px;">航线备注</th>
                    <th class="filter-header">
                        共舱船公司
                        <input type="text" class="filter-input" id="routeFilter" placeholder="筛选共舱船公司..." value="${safeRouteValue}" autocomplete="off">
                    </th>
                    ${weekColumns.map(week => `
                        <th class="week-header week-cell">
                            <div>${week.label}</div>
                            ${week.range ? `<div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">(${week.range})</div>` : ''}
                        </th>
                    `).join('')}
                </tr>
            `;

            const routeFilter = document.getElementById('routeFilter');
            if (routeFilter) {
                let composing = false;
                const newRouteFilter = routeFilter.cloneNode(true);
                routeFilter.parentNode.replaceChild(newRouteFilter, routeFilter);
                newRouteFilter.addEventListener('compositionstart', function() {
                    composing = true;
                });
                newRouteFilter.addEventListener('compositionend', function() {
                    composing = false;
                    routeFilterValue = this.value;
                    setTimeout(() => {
                        renderTable();
                    }, 0);
                });
                newRouteFilter.addEventListener('input', function() {
                    if (!composing) {
                        routeFilterValue = this.value;
                        clearTimeout(newRouteFilter._inputTimeout);
                        newRouteFilter._inputTimeout = setTimeout(() => {
                            renderTable();
                        }, 300);
                    }
                });
            }

            tableBody.innerHTML = '';
            groupedData.forEach(item => {
                const row = document.createElement('tr');
                const routePath = item.routePath || routePathMap[item.routeId] || '';
                const routePathAttr = routePath ? `data-tooltip="${routePath.replace(/"/g, '&quot;')}"` : '';
                const routeCellClass = routePath ? 'hover-cell' : '';
                const cells = [
                    `<td>${item.routeRemark || '—'}</td>`,
                    `<td class="${routeCellClass}" ${routePathAttr}>${item.routeLabel || '未知航线'}</td>`
                ];

                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    
                    // 计算该周的运力和派船数
                    const totalCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    const shipCount = ships.length;
                    
                    // 构建tooltip内容（船名航次、运力和开船日期）
                    let tooltipData = '';
                    if (ships.length > 0) {
                        const shipDetails = ships.map(ship => {
                            const name = ship.shipName || '未知';
                            const capacity = ship.capacity || 0;
                            let date = ship.shipDate || '未知';
                            
                            // 格式化日期为 YYYY/MM/DD
                            // 使用统一的日期解析和格式化函数
                            if (date && date !== '未知') {
                                date = formatDateToYYYYMMDD(date);
                            }
                            
                            // 格式：船名航次 运力TEU (日期) - 确保一行显示
                            const capacityStr = capacity > 0 ? `${capacity.toLocaleString()} TEU` : '0 TEU';
                            return `${name} ${capacityStr} (${date})`;
                        }).join('\n');
                        tooltipData = shipDetails;
                    }
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${shipCount}`;
                    } else if (currentView === 'capacity') {
                        cellContent = totalCapacity.toLocaleString() + ' TEU';
                    } else if (currentView === 'ships') {
                        cellContent = shipCount.toString();
                    }
                    
                    // 如果有数据，添加tooltip和悬停样式
                    const cellClass = ships.length > 0 ? 'number-cell hover-cell' : 'number-cell';
                    const tooltipAttr = tooltipData ? `data-tooltip="${tooltipData.replace(/"/g, '&quot;')}"` : '';
                    cells.push(`<td class="${cellClass}" ${tooltipAttr}>${cellContent}</td>`);
                });

                row.innerHTML = cells.join('');
                tableBody.appendChild(row);
            });
            
            const hasDestinationSelection = Boolean(
                destinationFilters.areas.length ||
                destinationFilters.subAreas.length ||
                destinationFilters.countries.length ||
                destinationFilters.ports.length ||
                routeFilterValue.trim()
            );
            const hasAreaSelection = destinationFilters.areas.length > 0;

            if (hasDestinationSelection && groupedData.length > 0) {
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'summary-row';
                const summaryCells = [
                    '<td><strong>合计</strong></td>',
                    '<td></td>'
                ];

                let totalCapacityByWeek = {};
                let totalShipsByWeek = {};
                
                // 计算每周的合计
                groupedData.forEach(item => {
                    weekColumns.forEach((week) => {
                        const weekCode = week.code;
                        const ships = item.weeks[weekCode] || [];
                        const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                        const weekShips = ships.length;
                        
                        if (!totalCapacityByWeek[weekCode]) {
                            totalCapacityByWeek[weekCode] = 0;
                            totalShipsByWeek[weekCode] = 0;
                        }
                        totalCapacityByWeek[weekCode] += weekCapacity;
                        totalShipsByWeek[weekCode] += weekShips;
                    });
                });
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const totalCapacity = totalCapacityByWeek[weekCode] || 0;
                    const totalShips = totalShipsByWeek[weekCode] || 0;
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${totalShips}`;
                    } else if (currentView === 'capacity') {
                        cellContent = `${totalCapacity.toLocaleString()} TEU`;
                    } else if (currentView === 'ships') {
                        cellContent = `${totalShips}`;
                    }
                    
                    summaryCells.push(`<td class="number-cell"><strong>${cellContent}</strong></td>`);
                });
                
                summaryRow.innerHTML = summaryCells.join('');
                tableBody.appendChild(summaryRow);
            }

            // 添加tooltip事件监听（包括周别单元格和共舱船公司单元格）
            const hoverCells = tableBody.querySelectorAll('.hover-cell');
            hoverCells.forEach(cell => {
                const tooltipText = cell.getAttribute('data-tooltip');
                if (!tooltipText) return;
                
                let tooltip = null;
                
                cell.addEventListener('mouseenter', (e) => {
                    tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.style.display = 'block';
                    // 对于路径信息，直接显示完整文本
                    const displayText = tooltipText;
                    const span = document.createElement('span');
                    span.className = 'tooltip-line';
                    span.textContent = displayText;
                    span.style.whiteSpace = 'pre-wrap';
                    tooltip.appendChild(span);
                    document.body.appendChild(tooltip);
                    
                    // 使用鼠标位置来定位tooltip，这样滚动时也能正确显示
                    const updateTooltipPosition = (event) => {
                        if (!tooltip || !tooltip.parentNode) return;
                        
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;
                        // 使用 getBoundingClientRect 获取更准确的尺寸
                        const rect = tooltip.getBoundingClientRect();
                        const tooltipWidth = rect.width || tooltip.offsetWidth;
                        const tooltipHeight = rect.height || tooltip.offsetHeight;
                        const padding = 10;
                        
                        // 默认显示在鼠标右下方
                        let tooltipX = mouseX + padding;
                        let tooltipY = mouseY + padding;
                        
                        // 如果右侧空间不够，显示在左侧
                        if (tooltipX + tooltipWidth > window.innerWidth) {
                            tooltipX = mouseX - tooltipWidth - padding;
                        }
                        
                        // 如果左侧也不够，居中显示
                        if (tooltipX < 0) {
                            tooltipX = (window.innerWidth - tooltipWidth) / 2;
                        }
                        
                        // 如果下方空间不够，显示在上方
                        if (tooltipY + tooltipHeight > window.innerHeight) {
                            tooltipY = mouseY - tooltipHeight - padding;
                        }
                        
                        // 如果上方也不够，显示在鼠标位置
                        if (tooltipY < 0) {
                            tooltipY = mouseY + padding;
                        }
                        
                        tooltip.style.left = tooltipX + 'px';
                        tooltip.style.top = tooltipY + 'px';
                    };
                    
                    // 初始定位 - 使用 requestAnimationFrame 确保 DOM 已更新
                    requestAnimationFrame(() => {
                        updateTooltipPosition(e);
                    });
                    
                    // 鼠标移动时更新位置
                    cell.addEventListener('mousemove', updateTooltipPosition);
                    cell._tooltipMoveHandler = updateTooltipPosition;
                });
                
                cell.addEventListener('mouseleave', () => {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                    // 移除mousemove事件监听
                    if (cell._tooltipMoveHandler) {
                        cell.removeEventListener('mousemove', cell._tooltipMoveHandler);
                        cell._tooltipMoveHandler = null;
                    }
                });
            });

            tableContainer.classList.remove('hidden');
            
            // 更新图表
            updateChart(hasAreaSelection, groupedData);
            
            // 更新AI分析区域
            updateAiAnalysis(hasAreaSelection);
        }
        
        function updateChart(hasAreaSelection, groupedData) {
            const chartContainer = document.getElementById('chartContainer');
            const chartWrapper = document.getElementById('chartWrapper');
            const emptyChartMessage = document.getElementById('emptyChartMessage');
            
            chartContainer.classList.remove('hidden');
            
            if (!hasAreaSelection || groupedData.length === 0) {
                chartWrapper.classList.add('hidden');
                emptyChartMessage.classList.remove('hidden');
                if (capacityChart) {
                    capacityChart.destroy();
                    capacityChart = null;
                }
                return;
            }
            
            emptyChartMessage.classList.add('hidden');
            chartWrapper.classList.remove('hidden');
            
            const weekCodes = weekColumns.map(week => week.code);
            const weekLabels = weekColumns.map(week => {
                const range = week.range ? ` (${week.range})` : '';
                return `${week.label}${range}`;
            });
            
            // 准备数据
            const shipData = []; // 每周的总派船数（用于折线图）
            const datasets = [];
            const podRoutePairs = [];
            
            // 收集所有航线备注+共舱船公司组合
            groupedData.forEach(item => {
                const routeLabel = item.routeLabel || '未知航线';
                const routeRemark = item.routeRemark || '—';
                podRoutePairs.push({
                    label: `${routeRemark} - ${routeLabel}`,
                    routeLabel: routeLabel,
                    routeId: item.routeId || '',
                    routeRemark: routeRemark
                });
            });
            
            // 为每个目的港+航线组合创建运力数据集
            podRoutePairs.forEach((pair, index) => {
                const item = groupedData[index];
                const capacityValues = [];
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    capacityValues.push(weekCapacity);
                });
                
                // 生成颜色
                const hue = (index * 137.508) % 360; // 使用黄金角度分布颜色
                const color = `hsl(${hue}, 70%, 50%)`;
                
                datasets.push({
                    label: pair.label,
                    data: capacityValues,
                    type: 'bar',
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1
                });
            });
            
            // 计算每周的总派船数（考虑周别合并）
            weekCodes.forEach((weekCode, weekIndex) => {
                let totalShips = 0;
                groupedData.forEach(item => {
                    let ships = item.weeks[weekCode] || [];
                    
                    // 检查是否需要与下一个周别合并
                    if (weekIndex < weekCodes.length - 1) {
                        const nextWeekCode = weekCodes[weekIndex + 1];
                        if (typeof shouldMergeWeeks === 'function' && shouldMergeWeeks(weekCode, nextWeekCode)) {
                            // 合并两个周别的数据
                            const nextWeekShips = item.weeks[nextWeekCode] || [];
                            ships = [...ships, ...nextWeekShips];
                        }
                    }
                    
                    totalShips += ships.length;
                });
                shipData.push(totalShips);
            });
            
            // 添加派船折线图数据集
            datasets.push({
                label: '派船总数',
                data: shipData,
                type: 'line',
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                yAxisID: 'y1'
            });
            
            // 销毁旧图表
            if (capacityChart) {
                capacityChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('trendChart').getContext('2d');
            capacityChart = new Chart(ctx, {
                data: {
                    labels: weekLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '运力与派船趋势分析',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '周别'
                            }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '运力 (TEU)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '派船数'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // AI分析相关功能（使用统一的工具模块）
        const aiProviders = createAiProviders('', {
            deepseek: { maxTokens: 8000 },
            kimi: { maxTokens: 8000 },
            qwen: { maxTokens: 8000 }
        }); // 市场观察工具使用默认前缀，增加输出长度限制
        // 提示词已从共享文件 vendor/ai-prompts.js 加载
        // baseSystemPrompt 和 aiInstructionTemplate 现在从外部文件引用
        let activeAiProvider = 'deepseek';
        let setActiveAiPanelBound = null;

        // 初始化 AI 模块
        // 注意：initAiModule 返回的函数内部会调用 ai-utils.js 中的 setActiveAiPanel
        // 我们直接使用返回的函数，并创建一个包装函数来更新本地状态
        setActiveAiPanelBound = initAiModule(aiProviders);

        // 包装函数，用于更新本地 activeAiProvider 状态
        // 现在可以安全地调用 setActiveAiPanelBound，因为它内部不再依赖全局的 setActiveAiPanel
        function setActiveAiPanel(providerId = 'deepseek') {
            const result = setActiveAiPanelBound(providerId);
            if (result) {
                activeAiProvider = result;
            }
        }

        function loadAiConfigs() {
            loadAiConfigsFromStorage(aiProviders);
        }

        function getAiConfig(providerId = 'deepseek') {
            return getAiConfigFromInputs(providerId, aiProviders);
        }

        function saveAiConfig(providerId = 'deepseek') {
            saveAiConfigToStorage(providerId, aiProviders, (providerName) => {
                // 使用统一的错误处理模块
                const configSavedMsg = typeof getErrorMessage === 'function' 
                    ? getErrorMessage(ErrorType.USER_ACTION, 'CONFIG_SAVED', { provider: providerName })
                    : `${providerName} API 配置已保存`;
                showSuccess(configSavedMsg);
            });
        }

        // fetchBunkerData, extractBunkerTables, parseBunkerTable, updateBunkerStatus, describeBunkerLine 已从 vendor/market-analysis-utils.js 加载

        // fetchWciData, parseWciText, renderWciStatus 已从 vendor/market-analysis-utils.js 加载

        const wciCodeMap = {
            'WCI-COMPOSITE': '全球综合',
            'WCI-SHA-RTM': '上海 → 鹿特丹',
            'WCI-RTM-SHA': '鹿特丹 → 上海',
            'WCI-SHA-GOA': '上海 → 热那亚',
            'WCI-SHA-LAX': '上海 → 洛杉矶',
            'WCI-LAX-SHA': '洛杉矶 → 上海',
            'WCI-SHA-NYC': '上海 → 纽约',
            'WCI-NYC-RTM': '纽约 → 鹿特丹',
            'WCI-RTM-NYC': '鹿特丹 → 纽约'
        };

        const fbxCodeMap = {
            FBX: 'FBX（Freightos Baltic Index 全球综合）',
            FBX01: 'FBX01 中国/东亚 → 北美西海岸',
            FBX02: 'FBX02 北美西海岸 → 中国/东亚',
            FBX03: 'FBX03 中国/东亚 → 北美东海岸',
            FBX04: 'FBX04 北美东海岸 → 中国/东亚',
            FBX11: 'FBX11 中国/东亚 → 北欧',
            FBX12: 'FBX12 北欧 → 中国/东亚',
            FBX13: 'FBX13 中国/东亚 → 地中海',
            FBX14: 'FBX14 地中海 → 中国/东亚',
            FBX21: 'FBX21 北美东海岸 → 北欧',
            FBX22: 'FBX22 北欧 → 北美东海岸',
            FBX24: 'FBX24 欧洲 → 南美东海岸',
            FBX26: 'FBX26 欧洲 → 南美西海岸'
        };

        // fetchFbxData, parseFbxText, renderFbxStatus 已从 vendor/market-analysis-utils.js 加载

        const cachedWci = loadCachedData(CACHE_KEYS.wci);
        if (cachedWci) {
            wciData = cachedWci;
            renderWciStatus();
        }
        const cachedFbx = loadCachedData(CACHE_KEYS.fbx);
        if (cachedFbx) {
            fbxData = cachedFbx;
            renderFbxStatus();
        }

        // fetchTextContent 已从 vendor/market-analysis-utils.js 加载

        /**
         * 更新AI分析模块可见性（默认显示，类似 Monitor-Sailing-Schedule）
         * @param {boolean} hasAreaSelection - 是否有区域选择
         */
        function updateAiAnalysis(hasAreaSelection) {
            const aiAnalysisContainer = document.getElementById('aiAnalysisContainer');
            const emptyAiMessage = document.getElementById('emptyAiMessage');
            const aiConfigSection = document.getElementById('aiConfigSection');
            
            if (!aiAnalysisContainer) return;
            
            // AI 模块始终显示（默认显示）
            aiAnalysisContainer.style.display = 'block';
            
            // 根据数据状态显示/隐藏配置区域
            if (!hasAreaSelection || !latestFilteredRecords || latestFilteredRecords.length === 0) {
                if (emptyAiMessage) emptyAiMessage.style.display = 'block';
                if (aiConfigSection) aiConfigSection.style.display = 'none';
                return;
            }
            
            if (emptyAiMessage) emptyAiMessage.style.display = 'none';
            if (aiConfigSection) aiConfigSection.style.display = 'block';
            loadAiConfigs();
            setActiveAiPanel(activeAiProvider);
        }

        async function runAiAnalysis(providerId = 'deepseek') {
            await executeAiAnalysis(
                providerId,
                aiProviders,
                buildAiPrompt,
                baseSystemPrompt,
                {
                    beforeAnalysis: async () => {
                        // 分析前获取数据
                        await Promise.allSettled([
                            fetchBunkerData(false),
                            fetchWciData(false),
                            fetchFbxData(false)
                        ]);
                    }
                }
            );
        }

        function buildAiPrompt() {
            if (!destinationFilters.areas.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_AREA_SELECTION');
                return null;
            }
            const filteredRecords = latestFilteredRecords;
            if (!filteredRecords.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_DATA');
                return null;
            }
            const analysisGroups = groupedTableData.length ? groupedTableData : groupRecords(filteredRecords).data;
            if (!analysisGroups.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_ROUTE_DATA');
                return null;
            }

            // 使用公共函数准备分析数据
            const prepared = prepareAnalysisData(analysisGroups, weekColumns, showError, ErrorType);
            if (!prepared) return null;
            const { analysisData, weeklySummary, analysisWeekCodes, analysisWeekLabels } = prepared;

            // 构建目的地摘要（365-04格式）
            const destinationSummary = [
                destinationFilters.areas.length ? destinationFilters.areas.join('、') : '全部区域',
                destinationFilters.subAreas.length ? destinationFilters.subAreas.join('、') : '全部子区域',
                destinationFilters.countries.length ? destinationFilters.countries.join('、') : '全部国家/地区',
                destinationFilters.ports.length ? destinationFilters.ports.join('、') : '全部港口'
            ].join(' / ');

            // 使用公共函数构建提示词
            let prompt = buildDataOverview(destinationSummary, analysisData.length, analysisWeekCodes, analysisWeekLabels, weeklySummary);
            prompt += buildDetailedData365(analysisData, analysisWeekCodes, analysisWeekLabels);
            prompt += buildBookingDataSection(getBookingData());

            if (
                typeof marketData !== 'undefined' &&
                Array.isArray(marketData) &&
                marketData.length > 0 &&
                typeof marketSelectedPorts !== 'undefined' &&
                marketSelectedPorts.length > 0
            ) {
                prompt += `\n【运费走势图模块数据（网页顶部）】
以下数据来自运费走势图模块，展示历史价格趋势，用于综合判断市场方向：
`;
                const { portCol, dateCol } = marketColumnConfig;
                const startValue = marketStartDate?.value;
                const endValue = marketEndDate?.value;
                const startDateObj = startValue ? new Date(startValue + 'T00:00:00') : null;
                const endDateObj = endValue ? new Date(endValue + 'T23:59:59') : null;

                marketSelectedPorts.forEach(port => {
                    let rows = marketData.filter(row => String(row[portCol] || '').trim() === port);
                    if (dateCol && (startDateObj || endDateObj)) {
                        rows = rows.filter(row => {
                            const rowDate = marketParseDate(row[dateCol]);
                            if (!(rowDate instanceof Date) || isNaN(rowDate)) return false;
                            const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
                            if (startDateObj && rowDateOnly < startDateObj) return false;
                            if (endDateObj && rowDateOnly > endDateObj) return false;
                            return true;
                        });
                    }
                    if (rows.length === 0) return;

                    rows.sort((a, b) => {
                        const dateA = marketParseDate(a[dateCol]);
                        const dateB = marketParseDate(b[dateCol]);
                        if (dateA && dateB) return dateA - dateB;
                        return 0;
                    });

                    const prices = rows.map(row => {
                        const date = dateCol ? marketParseDate(row[dateCol]) : null;
                        const dateStr = date ? `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}` : (row[dateCol] || '');
                        const gp20 = row['20GP'] || row['20gp'] || row['GP20'];
                        const gp40 = row['40GP'] || row['40gp'] || row['GP40'];
                        return { date: dateStr, gp20: gp20 ? parseFloat(gp20) : null, gp40: gp40 ? parseFloat(gp40) : null };
                    }).filter(p => p.gp20 !== null || p.gp40 !== null);

                    if (prices.length > 0) {
                        const recentPrices = prices.slice(-8);
                        const firstPrice = recentPrices[0];
                        const lastPrice = recentPrices[recentPrices.length - 1];
                        const gp20Trend = firstPrice.gp20 && lastPrice.gp20 ? (lastPrice.gp20 > firstPrice.gp20 ? '上涨' : lastPrice.gp20 < firstPrice.gp20 ? '下跌' : '持平') : '数据不足';
                        const gp40Trend = firstPrice.gp40 && lastPrice.gp40 ? (lastPrice.gp40 > firstPrice.gp40 ? '上涨' : lastPrice.gp40 < firstPrice.gp40 ? '下跌' : '持平') : '数据不足';

                        prompt += `\n港口：${port}
  - 数据点数量：${prices.length}个
  - 20GP 趋势：${gp20Trend}（${firstPrice.gp20 ? firstPrice.gp20.toLocaleString() : 'N/A'} → ${lastPrice.gp20 ? lastPrice.gp20.toLocaleString() : 'N/A'}）
  - 40GP 趋势：${gp40Trend}（${firstPrice.gp40 ? firstPrice.gp40.toLocaleString() : 'N/A'} → ${lastPrice.gp40 ? lastPrice.gp40.toLocaleString() : 'N/A'}）
  - 最近价格：20GP ${lastPrice.gp20 ? lastPrice.gp20.toLocaleString() : 'N/A'} USD, 40GP ${lastPrice.gp40 ? lastPrice.gp40.toLocaleString() : 'N/A'} USD（${lastPrice.date}）
`;
                    }
                });
                prompt += `\n注：以上运费走势图数据需与用户填写的现行报价、极端报价以及 SCFI/WCI/FBX 指数进行交叉验证，判断市场方向的一致性。若趋势不一致，需解释成因（如指数滞后、区域结构差异）。\n`;
            }

            // 使用公共函数构建提示词（继续）
            prompt += buildMarketReportsSection(marketReports);
            prompt += buildBunkerDataSection(bunkerData);
            prompt += buildWciDataSection(wciData);
            prompt += buildFbxDataSection(fbxData);
            // 添加 SCFI 数据（从市场报告中提取，替代之前的 CCFI）
            prompt += buildScfiDataSection(marketReports);

            prompt += aiInstructionTemplate;
            return prompt;
        }


        function getBookingData() {
            const tbody = document.getElementById('bookingDataBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const data = [];
            
            rows.forEach(row => {
                const remarkInput = row.querySelector('.booking-remark');
                const descInput = row.querySelector('.booking-desc');
                const remark = remarkInput ? remarkInput.value.trim() : '';
                const description = descInput ? descInput.value.trim() : '';
                
                if (remark || description) {
                    data.push({
                        remark,
                        description
                    });
                }
            });
            
            return data;
        }

        /**
         * 导出整页 PDF（使用 vendor/pdf-utils.js）
         */
        async function exportPageToPdf() {
            const exportBtn = document.getElementById('exportPdfBtn');
            if (!exportBtn) return;
            
            try {
                // 生成文件名：运费走势及航线运力分析_年月日.pdf
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const fileName = `运费走势及航线运力分析_${year}${month}${day}`;
                
                // 使用 vendor/pdf-utils.js 中的 exportToPdf 函数
                await exportToPdf('.container', {
                    fileName: fileName,
                    onStart: () => {
                        exportBtn.disabled = true;
                        exportBtn.textContent = '正在导出...';
                    },
                    onComplete: () => {
                        exportBtn.textContent = '导出整页 PDF';
                        exportBtn.disabled = false;
                    },
                    onError: (error) => {
                        debugError('导出PDF失败:', error);
                        showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                            message: error.message || String(error) 
                        }, error);
                        exportBtn.textContent = '导出整页 PDF';
                        exportBtn.disabled = false;
                    }
                });
            } catch (error) {
                debugError('导出PDF失败:', error);
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: error.message || String(error) 
                }, error);
                if (exportBtn) {
                    exportBtn.textContent = '导出整页 PDF';
                    exportBtn.disabled = false;
                }
            }
        }

        document.getElementById('exportPdfBtn')?.addEventListener('click', exportPageToPdf);
        window.addEventListener('load', () => {
            // 页面加载时显示 AI 模块（默认显示）
            updateAiAnalysis(false);
            
            Promise.allSettled([
                fetchBunkerData(false),
                fetchWciData(false),
                fetchFbxData(false)
            ]);
        });

        // 筛选功能在renderTable中已实现
    </script>
</body>
</html>
