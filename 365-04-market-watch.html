<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Watch · 市场观察</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/auth-gist.js"></script>
    <script src="vendor/filter-utils.js"></script>
    <script src="vendor/excel-reader-utils.js"></script>
    <script src="vendor/ai-config.js"></script>
    <script src="vendor/ai-prompts.js"></script>
    <script src="vendor/ai-utils.js"></script>
    <script src="vendor/market-data-fetchers.js"></script>
    <script src="vendor/pdf-processing-utils.js"></script>
    <script src="vendor/week-processing-utils.js"></script>
    <script src="vendor/data-normalization-utils.js"></script>
    <script src="vendor/market-analysis-utils.js"></script>
    <script src="vendor/template-utils.js"></script>
    <script src="vendor/port-sort-utils.js"></script>
    <script src="vendor/week-utils.js"></script>
    <script src="vendor/week-definition-parser.js"></script>
    <!-- PDF导出库 -->
    <script src="vendor/html2canvas.min.js"></script>
    <script src="vendor/jspdf.umd.min.js"></script>
</head>
<body data-page="365-04-market-watch.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片，沿用 dashboard 风格 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>Market Watch · 市场观察</h2>
                            <p>一份 Excel 与周报即可联动运价趋势、航线供给与 AI 决策，轻松完成跨板块洞察</p>
                </div>
                        <div class="section-intro-actions">
                            <button type="button" class="tool-link" id="exportPdfBtn" aria-label="导出PDF">导出PDF</button>
                            <a href="dashboard.html?tab=tools365" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="365-04-market-watch-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                </div>
                </div>
        </div>

                <!-- 文件上传和数据状态区域 - 两行布局 -->
                <div style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 0;">
                    <!-- 第一行：载入 Excel 和 Excel 数据状态 -->
                    <div class="grid-2-col" style="margin-bottom: 0;">
                        <!-- 左侧：载入 Excel -->
                        <div class="card-white">
                            <label for="fileInput" class="file-upload-label" aria-label="选择Excel文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradExcel)" />
                                    <!-- Excel表格图标 -->
                                    <rect x="8" y="8" width="20" height="20" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="14" x2="28" y2="14" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="20" x2="28" y2="20" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="14" y1="8" x2="14" y2="28" stroke="#fff" stroke-width="1.5"/>
                                    <!-- 向下箭头 -->
                                    <path d="M18 22L22 26L14 26Z" fill="#fff"/>
                                    <defs>
                                        <linearGradient id="gradExcel" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#0071e3" />
                                            <stop offset="1" stop-color="#54a4ff" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入 Excel</div>
                                    <div class="file-upload-desc">支持 .xlsx / .xls，需同时包含 market 与 schedule 工作表</div>
    </div>
                                <input type="file" id="fileInput" class="file-upload-input" accept=".xlsx,.xls" aria-label="选择Excel文件" title="选择Excel文件：同一文件需同时包含 market 与 schedule 工作表">
                        </label>
        </div>

                        <!-- 右侧：Excel 数据状态 -->
                        <div class="card-white">
                            <div class="data-status-container">
                                <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradStatus)" />
                                    <!-- 数据状态图标：剪贴板 + 勾 -->
                                    <rect x="11" y="10" width="14" height="16" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <rect x="15" y="8" width="6" height="4" rx="1" fill="#fff"/>
                                    <path d="M14 18L17 21L23 15" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <defs>
                                        <linearGradient id="gradStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#FF8A00" />
                                            <stop offset="1" stop-color="#FFB347" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="data-status-content">
                                    <div class="data-status-title">数据状态</div>
                                    <div id="excelStatus" class="data-status-text" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">尚未载入数据</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二行：载入报告 和 报告状态 -->
                    <div class="grid-2-col" style="margin-bottom: 0;">
                        <!-- 左侧：载入市场周报 -->
                        <div class="card-white">
                            <label for="marketReportInput" class="file-upload-label" aria-label="选择市场周报PDF文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradPdf)" />
                                    <!-- PDF图标 -->
                                    <rect x="10" y="9" width="16" height="18" rx="1" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M10 9L10 15L16 15" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="13" y1="20" x2="23" y2="20" stroke="#fff" stroke-width="1.2"/>
                                    <line x1="13" y1="23" x2="23" y2="23" stroke="#fff" stroke-width="1.2"/>
                                    <defs>
                                        <linearGradient id="gradPdf" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#dc3545" />
                                            <stop offset="1" stop-color="#ff6b7a" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入市场周报</div>
                                    <div class="file-upload-desc">支持多份 PDF（Alphaliner、Linerlytica 等）</div>
                                </div>
                                <input type="file" id="marketReportInput" class="file-upload-input" accept=".pdf" multiple aria-label="选择市场周报PDF文件" title="载入市场周报：支持一次选择多份 PDF（如 Alphaliner_Newsletter、Linerlytica Weekly 等），用于辅助 AI 分析">
                    </label>
                </div>
                        
                        <!-- 右侧：报告状态 -->
                        <div class="card-white">
                            <div class="data-status-container">
                                <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradReportStatus)" />
                                    <!-- 报告状态图标：文档 + 勾 -->
                                    <rect x="10" y="9" width="16" height="18" rx="1" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M10 9L10 15L16 15" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M14 20L17 23L23 17" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <defs>
                                        <linearGradient id="gradReportStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#28a745" />
                                            <stop offset="1" stop-color="#5cb85c" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="data-status-content">
                                    <div class="data-status-title">报告状态</div>
                                    <div id="reportStatus" class="data-status-text" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">尚未载入报告</div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <section id="marketModule" class="feature-section" style="margin-top: 20px !important;">
                <div class="module-header">
                    <span class="module-badge">MODULE 01</span>
                    <div>
                        <h2 class="section-title">运费走势图 <span>RATE TRENDS CHART</span></h2>
                        <p class="module-desc">多港口报价、区间提示与时段筛选，一屏掌握市场温度</p>
                    </div>
                </div>
                <div class="card-white module-card hidden" data-module="market" style="margin-top: 20px;">
                    <div class="controls">
                        <div class="filter-controls hidden" id="marketFilterControls" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <!-- 起运港筛选 -->
                            <div class="filter-group">
                                <label for="marketOriginPortSelect">起运港</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="marketOriginPortSearch" class="filter-search" placeholder="搜索起运港..." autocomplete="off">
                                <select id="marketOriginPortSelect" multiple size="6" class="multi-select">
                                    <option value="">全部起运港</option>
                                </select>
                                <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="marketOriginPortSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="marketOriginPortClear">清除选择</button>
                                </div>
                            </div>
                            <!-- 区域筛选 -->
                            <div class="filter-group">
                                <label for="marketRegionSelect">区域</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="marketRegionSearch" class="filter-search" placeholder="搜索区域..." autocomplete="off">
                                <select id="marketRegionSelect" multiple size="6" class="multi-select">
                                    <option value="">全部区域</option>
                                </select>
                                <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="marketRegionSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="marketRegionClear">清除选择</button>
                                </div>
                            </div>
                            <!-- 目的港筛选 -->
                            <div class="filter-group">
                                <label for="marketPortSelect">目的港</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="marketPortSearch" class="filter-search" placeholder="搜索目的港..." autocomplete="off">
                                <select id="marketPortSelect" multiple size="6" class="multi-select" disabled>
                                    <option value="">请先加载数据</option>
                                </select>
                                <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="marketPortSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="marketPortClear">清除选择</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="marketInfoBox" class="info-box hidden">
                        <p id="marketInfoText"></p>
                    </div>
                    <div class="chart-container hidden" id="marketChartContainer">
                        <div class="chart-header">
                            <h3 style="color:#495057;">运费走势图</h3>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="marketTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="capacityModule" class="feature-section" style="margin-top: 0 !important; padding-top: 20px !important;">
                <div class="module-header">
                    <span class="module-badge">MODULE 02</span>
                    <div>
                        <h2 class="section-title">航线运力分析 <span>SAILING SCHEDULE PULSE</span></h2>
                        <p class="module-desc">港口筛选联动运力、派船与趋势，精准锁定当周+未来三周供给</p>
                    </div>
                </div>
                <div class="card-white module-card hidden" data-module="capacity" style="margin-top: 20px;">
                    <div class="controls">
                        <div class="view-toggle hidden" id="viewToggle">
                            <label>显示模式：</label>
                            <button id="btnAll" class="active">全部</button>
                            <button id="btnCapacity">运力</button>
                            <button id="btnShips">派船</button>
                        </div>
                    </div>
                    <div id="destinationFilters" class="destination-filters hidden">
                        <div class="filter-row">
                            <!-- 起运港选择区域 -->
                        <div class="filter-group">
                                <label for="originPortSelect">起运港</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="originPortSearch" class="filter-search" placeholder="搜索起运港..." autocomplete="off">
                                <select id="originPortSelect" multiple size="6" class="multi-select">
                                    <option value="">全部起运港</option>
                            </select>
                            <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="originPortSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="originPortClearAll">清除选择</button>
                            </div>
                        </div>
                            <!-- 目的港选择区域 -->
                        <div class="filter-group">
                                <label for="destPortSelect">目的港</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="destPortSearch" class="filter-search" placeholder="搜索目的港..." autocomplete="off">
                                <select id="destPortSelect" multiple size="6" class="multi-select">
                                    <option value="">全部目的港</option>
                            </select>
                            <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="destPortSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="destPortClearAll">清除选择</button>
                            </div>
                        </div>
                            <!-- 共舱船公司选择区域 -->
                        <div class="filter-group">
                                <label for="routeSelect">共舱船公司</label>
                                <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                <input type="text" id="routeSearch" class="filter-search" placeholder="搜索共舱船公司..." autocomplete="off">
                                <select id="routeSelect" multiple size="6" class="multi-select">
                                    <option value="">全部共舱船公司</option>
                            </select>
                            <div class="filter-actions">
                                    <button type="button" class="filter-btn btn-sweep-blue" id="routeSelectAll">全部选择</button>
                                    <button type="button" class="filter-btn btn-sweep-blue" id="routeClearAll">清除选择</button>
                            </div>
                        </div>
                        </div>
                    </div>
                    <div id="infoBox" class="info-box hidden">
                        <p id="infoText"></p>
                    </div>
                    <div id="tableContainer" class="table-container hidden">
                        <table id="pivotTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div id="chartContainer" class="chart-container hidden">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                            <h3 style="color:#1f2d3d; font-size:20px; letter-spacing:0.5px;">运力与派船趋势图</h3>
                            <span style="color:#6c757d; font-size:13px;">高度 ×2 展示，便于对比多航线</span>
                        </div>
                        <div id="emptyChartMessage" class="empty-chart-message hidden">
                            请选择区域（或更细分的层级）以查看图表
                        </div>
                        <div class="chart-wrapper hidden" id="chartWrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="aiModule" class="feature-section">
                <div class="module-header">
                    <span class="module-badge">MODULE 03</span>
                    <div>
                        <h2 class="section-title">AI 趋势分析 <span>AI TREND ANALYSIS</span></h2>
                        <p class="module-desc">DeepSeek × KIMI × 通义千问 三模型交叉验证航线策略、供需与价格建议</p>
                    </div>
                </div>
                <div class="card-white module-card hidden" data-module="ai" style="margin-top: 20px;">
                    <div id="aiAnalysisContainer" class="ai-analysis-container">
                        <div class="ai-header">
                            <h3>AI 船期趋势分析</h3>
                            <p>同一份筛选数据可由多模型并行分析，快速对比观点并交叉验证结论</p>
                        </div>
                        <div id="emptyAiMessage" class="empty-chart-message" style="display: none;">
                            请先加载数据文件并选择筛选条件以启用 AI 分析
                        </div>
                        <div id="aiConfigSection" style="display: none;">
                            <!-- 其他影响因素表格 - 使用公共模板（vendor/template-utils.js） -->
                            <div id="bookingDataTableContainer"></div>
                            <!-- 市场数据信息块 - 使用公共模板（vendor/template-utils.js） -->
                            <div id="marketDataInfoBlocksContainer"></div>
                            <!-- AI 配置面板 - 使用公共模板（vendor/template-utils.js） -->
                            <div id="aiConfigPanelsContainer"></div>
                            </div>
    </div>
            </section>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">Market Watch · 市场观察使用声明</h2>
                    <p class="usage-statement-text">资料整合自用户 Excel、用户载入市场周报、Ship & Bunker、上海航运交易所、Drewry、Freightos 等公开渠道，仅供内部研判，不构成对外报价或投资建议。</p>
                    <p class="usage-statement-text">AI 服务由 DeepSeek / KIMI / 通义千问 API 驱动，所有调用费用与合规责任由使用者自担，涉及客户或敏感数据时请先完成脱敏处理。</p>
    </div>
    </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/sidebar-loader.js"></script>
    <script>
        init001ToolPage('365-04-market-watch.html', 'tools365');
    </script>
    <script>

        if (typeof addErrorMessage === 'function') {
            addErrorMessage(ErrorType.DATA_VALIDATION, 'NO_EXCEL_LOADED', '请先加载并解析 Excel 文件');
        }

        // 运费走势图模块逻辑
        let marketData = [];
        let marketChart = null;
        let marketRegions = [];
        let marketOriginPorts = [];
        let marketRegionPortMap = {}; // 区域 -> [port, portDisplay] 数组
        let marketOriginPortMap = {}; // 起运港 -> {regions: Set, ports: Set}
        let marketOriginPortDisplayMap = {}; // 起运港原始名 -> 格式化显示名
        let marketPortsListMap = null; // 港口列表映射 {code: {name, code, region}, name: {name, code, region}}
        let marketColumnConfig = {
            originPortCol: null,
            portCol: null,
            dateCol: null,
            portCodeCol: null,
            regionCol: null
        };
        let marketSelectedOriginPorts = [];
        let marketSelectedRegions = [];
        let marketSelectedPorts = [];
        let marketSelectorsInitialized = false;
        let marketOriginPortSearchValue = '';
        let marketRegionSearchValue = '';
        let marketPortSearchValue = '';

        // 自定义区域顺序（用于市场运价与运力区域）
        const CUSTOM_REGION_ORDER = ['北美洲', '拉丁美洲', '欧洲', '中东红海印巴', '澳洲', '非洲', '东南亚'];

        let pdfJsReady = false;
        let pdfJsLoadingPromise = null;

        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'vendor/pdf.worker.min.js';
            } catch (e) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            pdfJsReady = true;
        }

        const loadedScripts = new Set();
        const loadedWorkers = new Map();

        let marketReports = [];
        let bunkerData = null;
        let wciData = null;
        let fbxData = null;
        let scheduleData = [];
        let processedRecords = [];
        const excelLoadState = { market: false, schedule: false };
        let modulesVisible = false;

        const fileInput = document.getElementById('fileInput');
        const marketOriginPortSelect = document.getElementById('marketOriginPortSelect');
        const marketOriginPortSearch = document.getElementById('marketOriginPortSearch');
        const marketRegionSelect = document.getElementById('marketRegionSelect');
        const marketRegionSearch = document.getElementById('marketRegionSearch');
        const marketPortSelect = document.getElementById('marketPortSelect');
        const marketPortSearch = document.getElementById('marketPortSearch');
        const marketFilterControls = document.getElementById('marketFilterControls');

        /**
         * 加载并解析港口列表文件
         * @returns {Promise<Map>} 返回港口映射 {code: {name, code, region, chineseName}, name: {name, code, region, chineseName}}
         */
        async function loadMarketPortsList() {
            if (marketPortsListMap) return marketPortsListMap; // 已加载则直接返回
            
            try {
                const response = await fetch('data/Material-parsed_ports_list.txt');
                const text = await response.text();
                const portMap = new Map();
                
                // 解析每一行，格式：港口名, [标准化名称|代码|地区], 其他信息（可能包含中文名）
                const lines = text.split('\n');
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed) continue;
                    
                    // 匹配格式：港口名, [标准化名称|代码|地区], 其他信息
                    const match = trimmed.match(/^([^,]+),\s*\[([^\|]+)\|([^\|]+)\|([^\]]+)\](?:,\s*(.+))?/);
                    if (match) {
                        const originalName = match[1].trim(); // 原始名称（可能是英文）
                        const standardizedName = match[2].trim();
                        const code = match[3].trim().toUpperCase();
                        const region = match[4].trim();
                        const extraInfo = match[5] ? match[5].trim() : ''; // 其他信息，可能包含中文名
                        
                        // 从其他信息中提取中文名（通常在最后）
                        let chineseName = '';
                        if (extraInfo) {
                            // 尝试提取中文部分（通常是最后的中文字符串）
                            const chineseMatch = extraInfo.match(/[\u4e00-\u9fa5]+$/);
                            if (chineseMatch) {
                                chineseName = chineseMatch[0];
                            }
                        }
                        
                        const portInfo = {
                            name: standardizedName,
                            code: code,
                            region: region,
                            chineseName: chineseName,
                            originalName: originalName
                        };
                        
                        // 存储：代码 -> 港口信息
                        portMap.set(code, portInfo);
                        // 存储：标准化名称（大写） -> 港口信息
                        portMap.set(standardizedName.toUpperCase(), portInfo);
                        // 存储：原始名称（大写） -> 港口信息
                        portMap.set(originalName.toUpperCase(), portInfo);
                        // 存储：中文名 -> 港口信息
                        if (chineseName) {
                            portMap.set(chineseName, portInfo);
                        }
                    }
                }
                
                marketPortsListMap = portMap;
                debugLog(`✅ 已加载港口列表（包含代码、名称和中文名映射）`, '#0a7d33');
                return portMap;
            } catch (e) {
                debugWarn(`⚠️ 加载港口列表失败: ${e.message}，将使用原始起运港名称`, '#b36b00');
                return new Map();
            }
        }

        /**
         * 格式化标准化港口名称（将最后一个空格替换为逗号+空格）
         * 例如：QINGDAO SHANDONG -> QINGDAO, SHANDONG
         * @param {string} standardizedName - 标准化名称
         * @returns {string} 格式化后的名称
         */
        function formatStandardizedName(standardizedName) {
            if (!standardizedName) return standardizedName;
            // 查找最后一个空格的位置
            const lastSpaceIndex = standardizedName.lastIndexOf(' ');
            if (lastSpaceIndex > 0 && lastSpaceIndex < standardizedName.length - 1) {
                // 将最后一个空格替换为 ", "
                return standardizedName.substring(0, lastSpaceIndex) + ', ' + standardizedName.substring(lastSpaceIndex + 1);
            }
            return standardizedName;
        }

        /**
         * 根据起运港名称或代码查找标准化格式
         * @param {string} originPort - 起运港名称或代码（可能是中文、英文或代码）
         * @returns {string} 格式化后的显示名称 [标准化名称, 州/省|代码|区域]，如果找不到则返回原值
         */
        function getFormattedOriginPortName(originPort) {
            if (!originPort || !marketPortsListMap) return originPort;
            
            const portTrimmed = originPort.trim();
            const portUpper = portTrimmed.toUpperCase();
            
            // 1. 先尝试直接匹配（代码、标准化名称、原始名称、中文名）
            let portInfo = marketPortsListMap.get(portUpper) || marketPortsListMap.get(portTrimmed);
            
            // 2. 如果找不到，尝试精确匹配（不区分大小写）
            if (!portInfo) {
                for (const [key, info] of marketPortsListMap.entries()) {
                    if (key.toUpperCase() === portUpper || 
                        info.name.toUpperCase() === portUpper ||
                        info.originalName.toUpperCase() === portUpper ||
                        info.chineseName === portTrimmed) {
                        portInfo = info;
                        break;
                    }
                }
            }
            
            // 3. 如果还是找不到，尝试部分匹配
            if (!portInfo) {
                for (const [key, info] of marketPortsListMap.entries()) {
                    const nameUpper = info.name.toUpperCase();
                    const originalUpper = info.originalName.toUpperCase();
                    const chinese = info.chineseName;
                    
                    if (nameUpper.includes(portUpper) || 
                        portUpper.includes(nameUpper) ||
                        originalUpper.includes(portUpper) ||
                        portUpper.includes(originalUpper) ||
                        (chinese && (chinese.includes(portTrimmed) || portTrimmed.includes(chinese)))) {
                        portInfo = info;
                        break;
                    }
                }
            }
            
            if (portInfo) {
                // 格式化标准化名称（将最后一个空格替换为逗号+空格）
                const formattedName = formatStandardizedName(portInfo.name);
                return `[${formattedName}|${portInfo.code}|${portInfo.region}]`;
            }
            
            return originPort; // 如果找不到，返回原值
        }
        const marketChartContainer = document.getElementById('marketChartContainer');
        const marketInfoBox = document.getElementById('marketInfoBox');
        const marketInfoText = document.getElementById('marketInfoText');
        const marketReportInput = document.getElementById('marketReportInput');
        const excelStatusEl = document.getElementById('excelStatus');
        const reportStatusEl = document.getElementById('reportStatus');
        let bunkerStatusEl = null;
        let bunkerUpdatedEl = null;
        let wciStatusEl = null;
        let wciUpdatedEl = null;
        let fbxStatusEl = null;
        let fbxUpdatedEl = null;

        async function loadExcelFile() {
            await window.loadDefaultExcelFile('365-04-market-watch', async (file) => {
                // 直接调用处理函数（模拟文件选择）
                if (typeof XLSX === 'undefined') {
                    showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                    return;
                }

                try {
                    // 先加载 market 数据
                    const marketDataResult = await readMarketExcelFile(file);
                    if (marketDataResult && marketDataResult.length) {
                        // 处理 market 数据（完全复制手动加载的逻辑）
                        const firstRow = marketDataResult[0] || {};
                        const columnKeys = Object.keys(firstRow);
                        const findColumn = (keywords, fallbackIndex = null) => {
                            const key = columnKeys.find(col =>
                                keywords.some(word => (col || '').toString().toLowerCase().includes(word.toLowerCase()))
                            );
                            if (key) return key;
                            if (typeof fallbackIndex === 'number' && columnKeys[fallbackIndex]) {
                                return columnKeys[fallbackIndex];
                            }
                            return null;
                        };
                        // 先加载港口列表
                        await loadMarketPortsList();
                        
                        const originPortCol = findColumn(['起运港', 'origin', 'pol', '起运'], 1); // B列（索引1）
                        const regionCol = findColumn(['区域', 'region', '地区', 'area'], 8); // I列（索引8）
                        const portCol = findColumn(['港口', 'port', '目的港', '目的'], 2); // C列（索引2）
                        const portCodeCol = findColumn(['港口代码', 'port code', 'code', '代码'], 9); // J列（索引9）
                        const dateCol = findColumn(['日期', 'date', '时间', 'time'], 0);
                        if (regionCol && portCol) {
                            marketColumnConfig = { originPortCol, portCol, dateCol, portCodeCol, regionCol };
                            marketRegionPortMap = {};
                            marketOriginPortMap = {};
                            marketOriginPortDisplayMap = {};
                            const originPortSet = new Set();

                            marketDataResult.forEach(row => {
                                // 读取原始港口名称
                                const originPortRaw = originPortCol ? String(row[originPortCol] || '').trim() : '';
                                const region = String(row[regionCol] || '').trim();
                                const portRaw = String(row[portCol] || '').trim();
                                const portCode = portCodeCol ? String(row[portCodeCol] || '').trim() : '';
                                if (!region || !portRaw) return;
                                
                                // 使用原始港口名称（保持 Excel 中的原始值，不进行标准化）
                                const port = portRaw;
                                const portDisplay = portCode 
                                    ? `[${portRaw}|${portCode}|${region}]`
                                    : `[${portRaw}||${region}]`;
                                
                                // 使用原始起运港名称（保持 Excel 中的原始值，不进行标准化）
                                const originPort = originPortRaw;
                                
                                // 区域-港口映射
                                if (!marketRegionPortMap[region]) {
                                    marketRegionPortMap[region] = new Map();
                                }
                                marketRegionPortMap[region].set(port, portDisplay);
                                
                                // 起运港映射（如果有起运港数据）
                                if (originPort) {
                                    originPortSet.add(originPort);
                                    if (!marketOriginPortMap[originPort]) {
                                        marketOriginPortMap[originPort] = {
                                            regions: new Set(),
                                            ports: new Set()
                                        };
                                    }
                                    marketOriginPortMap[originPort].regions.add(region);
                                    marketOriginPortMap[originPort].ports.add(port);
                                    
                                    // 格式化起运港显示名称（使用标准化格式）
                                    if (!marketOriginPortDisplayMap[originPort]) {
                                        // 如果已经是标准化格式，直接使用；否则使用格式化函数
                                        if (originPort.startsWith('[') && originPort.includes('|')) {
                                            marketOriginPortDisplayMap[originPort] = originPort;
                                        } else {
                                            marketOriginPortDisplayMap[originPort] = getFormattedOriginPortName(originPort);
                                        }
                                    }
                                }
                            });
                            
                            // 提取所有起运港，使用 portSortUtils 排序（按 Material-parsed_ports_list.txt 顺序）
                            // 并确保显示标准化格式：[英文名|代码|区域]
                            if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                                try {
                                    // 确保港口映射已加载
                                    if (!window.portSortUtils.portsMappingLoaded) {
                                        await window.portSortUtils.loadPortsMapping();
                                    }
                                    // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                                    marketOriginPorts = window.portSortUtils.sortPortsByDataAndRegion(Array.from(originPortSet));
                                } catch (error) {
                                    console.warn('portSortUtils.sortPortsByDataAndRegion 失败，使用降级方案:', error);
                                    marketOriginPorts = Array.from(originPortSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                                }
                            } else {
                                marketOriginPorts = Array.from(originPortSet).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                            }

                            const allRegions = Object.keys(marketRegionPortMap);
                            // 处理区域名称变体（如"中东印巴红海" -> "中东红海印巴"）
                            const normalizeAreaName = (areaName) => {
                                if (!areaName) return areaName;
                                // 如果包含"中东"、"印巴"、"红海"这些关键词，统一映射到"中东红海印巴"
                                if (areaName.includes('中东') && (areaName.includes('印巴') || areaName.includes('红海'))) {
                                    return '中东红海印巴';
                                }
                                return areaName;
                            };
                            
                            if (typeof sortAreasByStandardOrder === 'function') {
                                marketRegions = sortAreasByStandardOrder(allRegions);
                            } else if (typeof STANDARD_AREA_ORDER !== 'undefined') {
                                // 如果 sortAreasByStandardOrder 不可用，手动排序
                                const areaOrderMap = new Map();
                                STANDARD_AREA_ORDER.forEach((area, index) => {
                                    areaOrderMap.set(area, index);
                                });
                                // 创建新数组进行排序，不修改原数组
                                marketRegions = [...allRegions].sort((a, b) => {
                                    const normalizedA = normalizeAreaName(a);
                                    const normalizedB = normalizeAreaName(b);
                                    const indexA = areaOrderMap.has(normalizedA) ? areaOrderMap.get(normalizedA) : Infinity;
                                    const indexB = areaOrderMap.has(normalizedB) ? areaOrderMap.get(normalizedB) : Infinity;
                                    if (indexA !== Infinity && indexB !== Infinity) {
                                        return indexA - indexB;
                                    }
                                    if (indexA !== Infinity) return -1;
                                    if (indexB !== Infinity) return 1;
                                    return a.localeCompare(b, 'zh-Hans-CN');
                                });
                            } else {
                                marketRegions = [...allRegions].sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                            }
                            const totalPorts = marketRegions.reduce((sum, region) => sum + marketRegionPortMap[region].size, 0);
                            // 将Map转换为数组，保持port -> portDisplay的映射关系
                            // 使用统一的排序函数（按区域顺序和代码顺序排序）
                            if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                                try {
                                    // 确保港口映射已加载
                                    if (!window.portSortUtils.portsMappingLoaded) {
                                        await window.portSortUtils.loadPortsMapping();
                                    }
                                    marketRegions.forEach(region => {
                                        const portMap = marketRegionPortMap[region];
                                        // 提取港口名称列表并排序
                                        const portNames = Array.from(portMap.keys());
                                        // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                                        const sortedPortNames = window.portSortUtils.sortPortsByDataAndRegion(portNames);
                                        // 重新构建 portArray，保持 port -> portDisplay 的映射关系
                                        const portArray = sortedPortNames.map(portName => {
                                            // 如果排序后的名称是标准化格式，使用它；否则使用原始映射
                                            const display = portName.startsWith('[') && portName.includes('|')
                                                ? portName
                                                : (portMap.get(portName) || portName);
                                            return [portName, display];
                                        });
                                        marketRegionPortMap[region] = portArray; // 存储为 [port, portDisplay] 的数组
                                    });
                                } catch (error) {
                                    console.warn('portSortUtils.sortPortNames 失败，使用降级方案:', error);
                                    marketRegions.forEach(region => {
                                        const portMap = marketRegionPortMap[region];
                                        const portArray = Array.from(portMap.entries()).sort((a, b) => {
                                            return a[0].localeCompare(b[0], 'zh-Hans-CN');
                                        });
                                        marketRegionPortMap[region] = portArray;
                                    });
                                }
                            } else {
                                marketRegions.forEach(region => {
                                    const portMap = marketRegionPortMap[region];
                                    const portArray = Array.from(portMap.entries()).sort((a, b) => {
                                        return a[0].localeCompare(b[0], 'zh-Hans-CN');
                                    });
                                    marketRegionPortMap[region] = portArray;
                                });
                            }

                            initMarketSelectors();
                            marketSelectedOriginPorts = [];
                            marketSelectedRegions = [];
                            marketSelectedPorts = [];
                            await updateMarketFilterOptions();

                            marketData = marketDataResult;
                            excelLoadState.market = true;
                            
                            // 显示信息
                            marketInfoBox?.classList.remove('hidden');
                            if (marketInfoText) {
                                marketInfoText.textContent = `已加载 ${marketDataResult.length} 条数据，共 ${marketRegions.length} 个区域，${totalPorts} 个港口`;
                            }
                        }
                    }
                    
                    // 再加载 schedule 数据
                    const scheduleDataResult = await readExcelFile(file);
                    if (scheduleDataResult && scheduleDataResult.length) {
                        scheduleData = scheduleDataResult;
                        await generatePivotTable(scheduleData);
                        const infoText = document.getElementById('infoText');
                        const infoBox = document.getElementById('infoBox');
                        if (infoText) infoText.textContent = `已加载 ${scheduleData.length} 条船期数据`;
                        if (infoBox) infoBox.classList.remove('hidden');
                        excelLoadState.schedule = true;
                        tryRevealModules();
                    }
                    
                    // 更新数据状态显示
                    updateDataStatus();
                } catch (error) {
                    showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                    debugError(error);
                    // 更新状态显示错误信息
                    if (excelStatusEl) {
                        excelStatusEl.textContent = '文件加载失败，请检查文件格式';
                    }
                }
            });
        }
        
        /**
         * 更新数据状态显示
         */
        function updateDataStatus() {
            const marketRecordCount = marketData ? marketData.length : 0;
            const scheduleRecordCount = scheduleData ? scheduleData.length : 0;
            if (excelStatusEl) {
                if (excelLoadState.market && excelLoadState.schedule) {
                    excelStatusEl.innerHTML = `<span>已载入 1 份表格</span><span style="color: #6c757d;">market: ${marketRecordCount.toLocaleString()} 条，schedule: ${scheduleRecordCount.toLocaleString()} 条</span>`;
                } else if (excelLoadState.market) {
                    excelStatusEl.innerHTML = `<span>已载入 1 份表格</span><span style="color: #6c757d;">market: ${marketRecordCount.toLocaleString()} 条</span>`;
                } else if (excelLoadState.schedule) {
                    excelStatusEl.innerHTML = `<span>已载入 1 份表格</span><span style="color: #6c757d;">schedule: ${scheduleRecordCount.toLocaleString()} 条</span>`;
                } else {
                    excelStatusEl.textContent = '尚未载入数据';
                }
            }
            
            const marketReportCount = marketReports ? marketReports.length : 0;
            if (reportStatusEl) {
                if (marketReportCount > 0) {
                    const totalChars = marketReports.reduce((sum, report) => sum + (report.textLength || 0), 0);
                    reportStatusEl.innerHTML = `<span>已载入 ${marketReportCount} 份报告</span><span style="color: #6c757d;">总字数: ${totalChars.toLocaleString()}</span>`;
                } else {
                    reportStatusEl.textContent = '尚未载入报告';
                }
            }
        }
        
        async function loadMarketReports() {
            await window.loadDefaultMarketReports(async (file) => {
                await handleMarketReportFile(file);
                // 检查是否提取到 SCFI 数据
                const latestReport = marketReports[marketReports.length - 1];
                if (latestReport) {
                    if (latestReport.scfiData) {
                        scfiData = latestReport.scfiData;
                        renderScfiTable(latestReport.scfiData, file.name);
                    } else {
                        // 尝试手动提取
                        try {
                            const fullText = latestReport.text;
                            if (fullText) {
                                const extractedScfi = parseScfiTable(fullText);
                                if (extractedScfi) {
                                    scfiData = extractedScfi;
                                    renderScfiTable(extractedScfi, file.name);
                                }
                            }
                        } catch (e) {
                            // 忽略提取错误
                        }
                    }
                }
            });
            
            // 更新数据状态显示
            updateDataStatus();
        }

        // 等待 XLSX 和 PDF.js 库加载完成后自动加载文件
        if (typeof window.ensureXlsx === 'function') {
            window.ensureXlsx().then(async () => {
                await loadExcelFile();
                // 等待 PDF.js 加载完成后再加载市场周报
                if (typeof window.ensurePdfJsLoaded === 'function') {
                    await window.ensurePdfJsLoaded();
                }
                // 延迟一下，确保 PDF.js 完全初始化
                setTimeout(() => {
                    loadMarketReports();
                }, 500);
            });
        } else {
            setTimeout(async () => {
                if (typeof XLSX !== 'undefined') {
                    await loadExcelFile();
                    if (typeof window.ensurePdfJsLoaded === 'function') {
                        await window.ensurePdfJsLoaded();
                    }
                    setTimeout(() => {
                        loadMarketReports();
                    }, 500);
                }
            }, 1000);
        }

        function tryRevealModules() {
            if (modulesVisible) return;
            if (excelLoadState.market && excelLoadState.schedule) {
                // 只显示筛选控件，模块标题始终显示
                const marketFilterControls = document.getElementById('marketFilterControls');
                if (marketFilterControls) marketFilterControls.classList.remove('hidden');
                
                const destinationFiltersPanel = document.getElementById('destinationFilters');
                if (destinationFiltersPanel) destinationFiltersPanel.classList.remove('hidden');
                
                const viewToggle = document.getElementById('viewToggle');
                if (viewToggle) viewToggle.classList.remove('hidden');

                document.querySelectorAll('.module-card').forEach(card => {
                    card.classList.remove('hidden');
                });
                
                modulesVisible = true;
            }
        }

        // 按钮事件绑定已移至 initMarketAnalysisPage 函数中（模板生成后）

        // 注册 SCFI 数据提取回调
        window.onScfiDataExtracted = (data, fileName) => {
            scfiData = data;
            renderScfiTable(data, fileName);
        };

        if (marketReportInput) {
            marketReportInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                for (const file of files) {
                    try {
                        await handleMarketReportFile(file);
                        // 检查是否提取到 SCFI 数据
                        const latestReport = marketReports[marketReports.length - 1];
                        if (latestReport) {
                            debugLog('市场报告解析完成:', {
                                name: latestReport.name,
                                hasScfiData: !!latestReport.scfiData,
                                scfiData: latestReport.scfiData
                            });
                            if (latestReport.scfiData) {
                                scfiData = latestReport.scfiData;
                                renderScfiTable(latestReport.scfiData, file.name);
                            } else {
                                debugWarn('未找到 SCFI 数据，尝试手动提取...');
                                // 如果自动提取失败，尝试手动从全文提取
                                try {
                                    const fullText = latestReport.text;
                                    if (fullText) {
                                        const extractedScfi = parseScfiTable(fullText);
                                        if (extractedScfi) {
                                            debugLog('手动提取 SCFI 数据成功:', extractedScfi);
                                            scfiData = extractedScfi;
                                            latestReport.scfiData = extractedScfi;
                                            renderScfiTable(extractedScfi, file.name);
                                        } else {
                                            debugWarn('手动提取也失败，文本内容:', fullText.substring(0, 500));
                                        }
                                    }
                                } catch (extractError) {
                                    debugError('手动提取 SCFI 失败:', extractError);
                                }
                            }
                        }
                    } catch (error) {
                        debugError('解析PDF失败:', error);
                        showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', { message: error.message || String(error) }, error);
                    }
                }
                marketReportInput.value = '';
                
                // 更新数据状态显示
                updateDataStatus();
            });
        }

        /**
         * 渲染 SCFI 表格
         * @param {Object} data - SCFI 数据
         * @param {string} source - 数据来源文件名
         */
        function renderScfiTable(data, source) {
            const container = document.getElementById('scfiTableContainer');
            const sourceEl = document.getElementById('scfiSource');
            const infoContainer = document.getElementById('scfiInfoContainer');
            
            if (!container || !infoContainer) {
                debugWarn('SCFI 表格容器未找到');
                return;
            }
            
            debugLog('渲染 SCFI 表格，数据:', data);
            
            if (!data || (!data.index && (!data.routes || data.routes.length === 0))) {
                debugWarn('SCFI 数据为空，隐藏表格');
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            let html = '<table class="scfi-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; table-layout: fixed;">';
            
            // 表头
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; text-align: left; border: 1px solid #ddd; width: 15%;">航线</th>';
            html += '<th style="padding: 8px; text-align: center; border: 1px solid #ddd; width: 5%;">单位</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">当期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上期对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上月对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上季度对比%</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年指数</th>';
            html += '<th style="padding: 8px; text-align: right; border: 1px solid #ddd; width: 8%;">上年对比%</th>';
            html += '</tr>';
            
            // SCFI 综合指数行（作为第一行数据，在表头下面）
            if (data.index) {
                const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                const formatPercent = (val) => {
                    if (val === null || val === undefined) return '—';
                    const sign = val >= 0 ? '+' : '';
                    return sign + val.toFixed(1) + '%';
                };
                
                html += '<tr style="background: #f9f9f9; font-weight: bold;">';
                html += '<td style="padding: 8px; border: 1px solid #ddd;">SCFI 综合指数</td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">—</td>'; // 单位列
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.index) + '</td>';
                // 上期指数 = 1周指数 (indexWeek1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexWeek1) + '</td>';
                // 上期对比% = 1周变化% (indexWeek1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexWeek1Change) + '</td>';
                // 上月指数 = 1个月指数 (indexMonth1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexMonth1) + '</td>';
                // 上月对比% = 1个月变化% (indexMonth1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexMonth1Change) + '</td>';
                // 上季度指数 = 3个月指数 (indexQuarter3)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexQuarter3) + '</td>';
                // 上季度对比% = 3个月变化% (indexQuarter3Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexQuarter3Change) + '</td>';
                // 上年指数 = 1年指数 (indexYear1)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatValue(data.indexYear1) + '</td>';
                // 上年对比% = 1年变化% (indexYear1Change)
                html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + formatPercent(data.indexYear1Change) + '</td>';
                html += '</tr>';
            }
            
            if (data.routes && data.routes.length > 0) {
                // 数据行
                data.routes.forEach(route => {
                    const formatValue = (val) => typeof val === 'number' ? val.toLocaleString() : '—';
                    const formatPercent = (val) => {
                        if (val === null || val === undefined) return '—';
                        const sign = val >= 0 ? '+' : '';
                        return sign + val.toFixed(1) + '%';
                    };
                    
                    // 检查是否是India/East Africa/Central America，这些航线没有上年数据
                    const routeNameLower = (route.name || '').toLowerCase();
                    const hasNoYearData = routeNameLower.includes('india') || 
                                         routeNameLower.includes('nhava sheva') ||
                                         routeNameLower.includes('east africa') ||
                                         routeNameLower.includes('mombasa') ||
                                         routeNameLower.includes('central america') ||
                                         routeNameLower.includes('manzanillo');
                    
                    html += '<tr>';
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd;">${route.name}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">${route.unit || '—'}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.current)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.week1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.week1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.month1Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.month1Change)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.quarter3Price)}</td>`;
                    html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.quarter3Change)}</td>`;
                    // 如果是India/East Africa/Central America，上年数据显示为"—"
                    if (hasNoYearData) {
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                        html += '<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">—</td>';
                    } else {
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatValue(route.year1Price)}</td>`;
                        html += `<td style="padding: 6px 8px; border: 1px solid #ddd; text-align: right;">${formatPercent(route.year1Change)}</td>`;
                    }
                    html += '</tr>';
                });
            }
            
            html += '</table>';
            container.innerHTML = html;
            
            if (sourceEl) {
                sourceEl.textContent = `数据来源：${source}`;
            }
        }

        function initMarketSelectors() {
            if (marketSelectorsInitialized) return;
            
            // 起运港选择器
            if (marketOriginPortSelect) {
                setupMultiSelect(marketOriginPortSelect);
                marketOriginPortSelect.addEventListener('change', () => {
                    marketSelectedOriginPorts = getSelectedValues(marketOriginPortSelect);
                    // 级联更新：根据选择的起运港更新区域和港口选项
                    updateMarketFilterOptions();
                    updateMarketChartFromSelection(false);
                });
            }
            if (marketOriginPortSearch) {
                // 使用防抖优化搜索性能
                if (typeof window.addDebouncedSearch === 'function') {
                    window.addDebouncedSearch(marketOriginPortSearch, (e) => {
                        marketOriginPortSearchValue = e.target.value;
                        updateMarketFilterOptions();
                    }, 300);
                } else {
                    marketOriginPortSearch.addEventListener('input', (e) => {
                        marketOriginPortSearchValue = e.target.value;
                        updateMarketFilterOptions();
                    });
                }
            }
            
            // 区域选择器
            if (marketRegionSelect) {
                setupMultiSelect(marketRegionSelect);
                marketRegionSelect.addEventListener('change', () => {
                    marketSelectedRegions = getSelectedValues(marketRegionSelect);
                    // 级联更新：根据选择的区域更新起运港和港口选项
                    updateMarketFilterOptions();
                    updateMarketChartFromSelection(false);
                });
            }
            if (marketRegionSearch) {
                // 使用防抖优化搜索性能
                if (typeof window.addDebouncedSearch === 'function') {
                    window.addDebouncedSearch(marketRegionSearch, (e) => {
                        marketRegionSearchValue = e.target.value;
                        updateMarketFilterOptions();
                    }, 300);
                } else {
                    marketRegionSearch.addEventListener('input', (e) => {
                        marketRegionSearchValue = e.target.value;
                        updateMarketFilterOptions();
                    });
                }
            }

            // 港口选择器
            if (marketPortSelect) {
                setupMultiSelect(marketPortSelect);
                marketPortSelect.addEventListener('change', () => {
                    marketSelectedPorts = getSelectedValues(marketPortSelect);
                    // 只更新图表，不更新筛选器选项（保留完整的港口列表供用户多选）
                    updateMarketChartFromSelection(true);
                });
            }
            if (marketPortSearch) {
                // 使用防抖优化搜索性能
                if (typeof window.addDebouncedSearch === 'function') {
                    window.addDebouncedSearch(marketPortSearch, (e) => {
                        marketPortSearchValue = e.target.value;
                        updateMarketFilterOptions();
                    }, 300);
                } else {
                    marketPortSearch.addEventListener('input', (e) => {
                        marketPortSearchValue = e.target.value;
                        updateMarketFilterOptions();
                    });
                }
            }

            marketSelectorsInitialized = true;
        }

        /**
         * 根据当前选择筛选数据
         * @param {boolean} includePortFilter - 是否根据已选择的目的港进行过滤（默认 true）
         * @returns {Array} 筛选后的数据
         */
        function filterMarketDataBySelections(includePortFilter = true) {
            let filteredData = marketData;
            
            // 如果已选择起运港，先按起运港过滤
            if (marketSelectedOriginPorts.length > 0 && marketColumnConfig.originPortCol) {
                filteredData = filteredData.filter(row => {
                    const originPort = String(row[marketColumnConfig.originPortCol] || '').trim();
                    return marketSelectedOriginPorts.includes(originPort);
                });
            }
            
            // 如果已选择区域，再按区域过滤
            if (marketSelectedRegions.length > 0) {
                filteredData = filteredData.filter(row => {
                    const region = String(row[marketColumnConfig.regionCol] || '').trim();
                    return marketSelectedRegions.includes(region);
                });
            }
            
            // 如果已选择港口，再按港口过滤（仅在 includePortFilter 为 true 时）
            if (includePortFilter && marketSelectedPorts.length > 0) {
                filteredData = filteredData.filter(row => {
                    const port = String(row[marketColumnConfig.portCol] || '').trim();
                    return marketSelectedPorts.includes(port);
                });
            }
            
            return filteredData;
        }

        /**
         * 从筛选后的数据中提取可用的选项
         * @param {Array} filteredData - 筛选后的数据
         * @returns {Object} 包含可用选项的对象
         */
        function extractAvailableOptions(filteredData) {
            const availableOriginPorts = new Set();
            const availableRegions = new Set();
            const portMap = new Map(); // 存储 port -> portDisplay 的映射
            
            filteredData.forEach(row => {
                const originPort = marketColumnConfig.originPortCol ? String(row[marketColumnConfig.originPortCol] || '').trim() : '';
                const region = String(row[marketColumnConfig.regionCol] || '').trim();
                const port = String(row[marketColumnConfig.portCol] || '').trim();
                const portCode = marketColumnConfig.portCodeCol ? String(row[marketColumnConfig.portCodeCol] || '').trim() : '';
                
                if (originPort) availableOriginPorts.add(originPort);
                if (region) availableRegions.add(region);
                if (port && region) {
                    const portDisplay = portCode 
                        ? `[${port}|${portCode}|${region}]`
                        : `[${port}||${region}]`;
                    if (!portMap.has(port)) {
                        portMap.set(port, portDisplay);
                    }
                }
            });
            
            return { availableOriginPorts, availableRegions, portMap };
        }

        /**
         * 更新起运港选择器
         * @param {Set} availableOriginPorts - 可用的起运港集合
         */
        async function updateOriginPortSelect(availableOriginPorts) {
            if (!marketOriginPortSelect) return;
            
            // 使用统一的排序函数（按区域顺序和代码顺序排序）
            let allOriginPorts;
            if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                try {
                    // 确保港口映射已加载
                    if (!window.portSortUtils.portsMappingLoaded) {
                        await window.portSortUtils.loadPortsMapping();
                    }
                    // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                    allOriginPorts = window.portSortUtils.sortPortsByDataAndRegion(Array.from(availableOriginPorts));
                    // 更新显示映射（如果港口已被标准化）
                    allOriginPorts.forEach(port => {
                        if (port.startsWith('[') && port.includes('|')) {
                            // 提取代码用于查找原始名称
                            const codeMatch = port.match(/\|([A-Z0-9]+)\|/);
                            if (codeMatch && codeMatch[1]) {
                                const code = codeMatch[1];
                                // 查找原始名称（从 availableOriginPorts 中）
                                const originalPort = Array.from(availableOriginPorts).find(p => {
                                    // 如果原始名称已经是标准化格式，提取代码比较
                                    if (p.startsWith('[') && p.includes('|')) {
                                        const pCodeMatch = p.match(/\|([A-Z0-9]+)\|/);
                                        return pCodeMatch && pCodeMatch[1] === code;
                                    }
                                    // 否则尝试通过 portSortUtils 获取代码
                                    const pCode = window.portSortUtils.getCodeByPortName(p);
                                    return pCode === code;
                                });
                                if (originalPort && originalPort !== port) {
                                    marketOriginPortDisplayMap[originalPort] = port;
                                }
                                marketOriginPortDisplayMap[port] = port;
                            }
                        }
                    });
                } catch (error) {
                    console.warn('portSortUtils.sortPortNames 失败，使用降级方案:', error);
                    allOriginPorts = Array.from(availableOriginPorts).sort((a, b) => {
                        const displayA = marketOriginPortDisplayMap[a] || a;
                        const displayB = marketOriginPortDisplayMap[b] || b;
                        return displayA.localeCompare(displayB, 'zh-Hans-CN');
                    });
                }
            } else {
                allOriginPorts = Array.from(availableOriginPorts).sort((a, b) => {
                    const displayA = marketOriginPortDisplayMap[a] || a;
                    const displayB = marketOriginPortDisplayMap[b] || b;
                    return displayA.localeCompare(displayB, 'zh-Hans-CN');
                });
            }
            
            // 根据搜索值过滤
            const filteredOriginPorts = marketOriginPortSearchValue.trim()
                ? allOriginPorts.filter(port => {
                    const displayName = marketOriginPortDisplayMap[port] || port;
                    return displayName.toLowerCase().includes(marketOriginPortSearchValue.toLowerCase()) ||
                           port.toLowerCase().includes(marketOriginPortSearchValue.toLowerCase());
                })
                : allOriginPorts;
            
            // 保留已选择的选项
            marketSelectedOriginPorts = marketSelectedOriginPorts.filter(port => filteredOriginPorts.includes(port));
            const selectedSet = new Set(marketSelectedOriginPorts);
            
            marketOriginPortSelect.innerHTML = '';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = filteredOriginPorts.length ? '全部起运港' : '请先加载数据';
            if (!selectedSet.size) {
                placeholderOption.selected = true;
            }
            marketOriginPortSelect.appendChild(placeholderOption);
            
            filteredOriginPorts.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = marketOriginPortDisplayMap[port] || port;
                if (selectedSet.has(port)) {
                    option.selected = true;
                }
                marketOriginPortSelect.appendChild(option);
            });
        }

        /**
         * 更新区域选择器
         * @param {Set} availableRegions - 可用的区域集合
         */
        function updateRegionSelect(availableRegions) {
            if (!marketRegionSelect) return;
            
            const allRegions = Array.from(availableRegions).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            const filteredRegions = marketRegionSearchValue.trim()
                ? allRegions.filter(region => region.toLowerCase().includes(marketRegionSearchValue.toLowerCase()))
                : allRegions;
            
            // 保留已选择的选项
            marketSelectedRegions = marketSelectedRegions.filter(region => filteredRegions.includes(region));
            
            populateSelect(marketRegionSelect, filteredRegions, '全部区域', marketSelectedRegions, false);
        }

        /**
         * 更新港口选择器
         * @param {Map} portMap - 港口映射表
         */
        async function updatePortSelect(portMap) {
            if (!marketPortSelect) return;
            
            const allPorts = Array.from(portMap.keys());
            let uniquePorts;
            
            // 使用统一的排序函数（按区域顺序和代码顺序排序）
            if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                try {
                    // 确保港口映射已加载
                    if (!window.portSortUtils.portsMappingLoaded) {
                        await window.portSortUtils.loadPortsMapping();
                    }
                    // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                    uniquePorts = window.portSortUtils.sortPortsByDataAndRegion(allPorts);
                } catch (error) {
                    console.warn('portSortUtils.sortPortNames 失败，使用降级方案:', error);
                    // 降级方案：使用 sortPortsByStandardOrder 或简单排序
                    uniquePorts = (typeof sortPortsByStandardOrder === 'function')
                        ? sortPortsByStandardOrder(allPorts)
                        : allPorts.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                }
            } else {
                // 降级方案：使用 sortPortsByStandardOrder 或简单排序
                uniquePorts = (typeof sortPortsByStandardOrder === 'function')
                    ? sortPortsByStandardOrder(allPorts)
                    : allPorts.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            }
            
            const filteredPorts = marketPortSearchValue.trim()
                ? uniquePorts.filter(port => {
                    const portDisplay = portMap.get(port) || port;
                    return portDisplay.toLowerCase().includes(marketPortSearchValue.toLowerCase()) ||
                           port.toLowerCase().includes(marketPortSearchValue.toLowerCase());
                })
                : uniquePorts;
            
            // 保留已选择的选项（即使它们不在当前过滤后的列表中，也要保留，允许用户多选）
            // 只过滤掉那些确实不在 portMap 中的选项
            marketSelectedPorts = marketSelectedPorts.filter(port => portMap.has(port));
            const selectedSet = new Set(marketSelectedPorts);
            
            // 合并已选择的港口和过滤后的港口列表，确保已选择的港口始终显示
            const allPortsToShow = new Set([...marketSelectedPorts, ...filteredPorts]);
            const sortedPortsToShow = Array.from(allPortsToShow);
            
            // 对要显示的港口进行排序
            let finalPortsToShow;
            if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                try {
                    if (!window.portSortUtils.portsMappingLoaded) {
                        await window.portSortUtils.loadPortsMapping();
                    }
                    finalPortsToShow = window.portSortUtils.sortPortsByDataAndRegion(sortedPortsToShow);
                } catch (error) {
                    finalPortsToShow = sortedPortsToShow.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                }
            } else {
                finalPortsToShow = sortedPortsToShow.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            }
            
            marketPortSelect.innerHTML = '';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = finalPortsToShow.length ? '全部目的港' : '请先选择起运港或区域';
            // 不要自动选中 placeholder，让用户可以选择多个港口
            placeholderOption.selected = false;
            marketPortSelect.appendChild(placeholderOption);
            
            finalPortsToShow.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = portMap.get(port) || port;
                if (selectedSet.has(port)) {
                    option.selected = true;
                }
                marketPortSelect.appendChild(option);
            });
            
            marketPortSelect.disabled = finalPortsToShow.length === 0;
        }

        /**
         * 更新所有筛选器选项（级联筛选）
         */
        async function updateMarketFilterOptions() {
            // 根据当前已选择的筛选条件，计算可用的选项
            // 注意：对于目的港，不根据已选择的目的港进行过滤，保留完整的港口列表供用户多选
            const filteredDataForOriginAndRegion = filterMarketDataBySelections(false); // 不根据目的港过滤
            
            // 从过滤后的数据中提取可用的选项（起运港和区域）
            const { availableOriginPorts, availableRegions } = extractAvailableOptions(filteredDataForOriginAndRegion);
            
            // 对于目的港，从所有数据中提取（根据起运港和区域过滤，但不根据已选择的目的港过滤）
            const allPortData = filterMarketDataBySelections(false);
            const { portMap } = extractAvailableOptions(allPortData);
            
            // 更新各个选择器（注意：updateOriginPortSelect 和 updatePortSelect 现在是异步的）
            await updateOriginPortSelect(availableOriginPorts);
            updateRegionSelect(availableRegions);
            await updatePortSelect(portMap);
        }

        function updateMarketChartFromSelection(showAlertIfEmpty) {
            if (!marketSelectedPorts.length) {
                if (showAlertIfEmpty) {
                    marketInfoText && (marketInfoText.textContent = '请选择至少一个港口以生成走势图');
                }
                if (marketChart) {
                    marketChart.destroy();
                    marketChart = null;
                }
                marketChartContainer?.classList.add('hidden');
                return;
            }
            updateMarketChart(marketSelectedPorts);
        }

        fileInput?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (typeof XLSX === 'undefined') {
                showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                return;
            }

            try {
                const data = await readMarketExcelFile(file);
                if (!data.length) {
                    showError(ErrorType.FILE_LOAD, 'FILE_EMPTY');
                    return;
                }

                marketData = data;
                const firstRow = data[0] || {};
                const columnKeys = Object.keys(firstRow);

                const findColumn = (keywords, fallbackIndex = null) => {
                    const key = columnKeys.find(col =>
                        keywords.some(word => (col || '').toString().toLowerCase().includes(word.toLowerCase()))
                    );
                    if (key) return key;
                    if (typeof fallbackIndex === 'number' && columnKeys[fallbackIndex]) {
                        return columnKeys[fallbackIndex];
                    }
                    return null;
                };

                // 先加载港口列表
                await loadMarketPortsList();
                
                const originPortCol = findColumn(['起运港', 'origin', 'pol', '起运'], 1); // B列（索引1）
                const regionCol = findColumn(['区域', 'region', '地区', 'area'], 8); // I列（索引8）
                const portCol = findColumn(['港口', 'port', '目的港', '目的'], 2); // C列（索引2）
                const portCodeCol = findColumn(['港口代码', 'port code', 'code', '代码'], 9); // J列（索引9）
                const dateCol = findColumn(['日期', 'date', '时间', 'time'], 0);

                if (!regionCol || !portCol) {
                    showError(ErrorType.FILE_PARSE, 'MISSING_REGION_PORT', { columns: columnKeys.join(', ') });
                    return;
                }

                marketColumnConfig = { originPortCol, portCol, dateCol, portCodeCol, regionCol };
                marketRegionPortMap = {};
                marketOriginPortMap = {};
                marketOriginPortDisplayMap = {};
                const originPortSet = new Set();

                data.forEach(row => {
                    // 读取原始港口名称
                    const originPortRaw = originPortCol ? String(row[originPortCol] || '').trim() : '';
                    const region = String(row[regionCol] || '').trim();
                    const portRaw = String(row[portCol] || '').trim();
                    const portCode = portCodeCol ? String(row[portCodeCol] || '').trim() : '';
                    if (!region || !portRaw) return;
                    
                    // 使用原始港口名称（保持 Excel 中的原始值，不进行标准化）
                    const port = portRaw;
                    const portDisplay = portCode 
                        ? `[${portRaw}|${portCode}|${region}]`
                        : `[${portRaw}||${region}]`;
                    
                    // 使用原始起运港名称（保持 Excel 中的原始值，不进行标准化）
                    const originPort = originPortRaw;
                    
                    // 区域-港口映射
                    if (!marketRegionPortMap[region]) {
                        marketRegionPortMap[region] = new Map();
                    }
                    marketRegionPortMap[region].set(port, portDisplay);
                    
                    // 起运港映射（如果有起运港数据）
                    if (originPort) {
                        originPortSet.add(originPort);
                        if (!marketOriginPortMap[originPort]) {
                            marketOriginPortMap[originPort] = {
                                regions: new Set(),
                                ports: new Set()
                            };
                        }
                        marketOriginPortMap[originPort].regions.add(region);
                        marketOriginPortMap[originPort].ports.add(port);
                        
                        // 格式化起运港显示名称
                        if (!marketOriginPortDisplayMap[originPort]) {
                            marketOriginPortDisplayMap[originPort] = getFormattedOriginPortName(originPort);
                        }
                    }
                });
                
                // 提取所有起运港，使用 portSortUtils 排序（按 Material-parsed_ports_list.txt 顺序）
                if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                    try {
                        // 确保港口映射已加载
                        if (!window.portSortUtils.portsMappingLoaded) {
                            await window.portSortUtils.loadPortsMapping();
                        }
                        // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                        marketOriginPorts = window.portSortUtils.sortPortsByDataAndRegion(Array.from(originPortSet));
                    } catch (error) {
                        console.warn('portSortUtils.sortPortsByDataAndRegion 失败，使用降级方案:', error);
                        marketOriginPorts = Array.from(originPortSet).sort((a, b) => {
                            const displayA = marketOriginPortDisplayMap[a] || a;
                            const displayB = marketOriginPortDisplayMap[b] || b;
                            return displayA.localeCompare(displayB, 'zh-Hans-CN');
                        });
                    }
                } else {
                    marketOriginPorts = Array.from(originPortSet).sort((a, b) => {
                        const displayA = marketOriginPortDisplayMap[a] || a;
                        const displayB = marketOriginPortDisplayMap[b] || b;
                        return displayA.localeCompare(displayB, 'zh-Hans-CN');
                    });
                }

                const allRegions = Object.keys(marketRegionPortMap);
                // 处理区域名称变体（如"中东印巴红海" -> "中东红海印巴"）
                const normalizeAreaName = (areaName) => {
                    if (!areaName) return areaName;
                    // 如果包含"中东"、"印巴"、"红海"这些关键词，统一映射到"中东红海印巴"
                    if (areaName.includes('中东') && (areaName.includes('印巴') || areaName.includes('红海'))) {
                        return '中东红海印巴';
                    }
                    return areaName;
                };
                
                if (typeof sortAreasByStandardOrder === 'function') {
                    marketRegions = sortAreasByStandardOrder(allRegions);
                } else if (typeof STANDARD_AREA_ORDER !== 'undefined') {
                    // 如果 sortAreasByStandardOrder 不可用，手动排序
                    const areaOrderMap = new Map();
                    STANDARD_AREA_ORDER.forEach((area, index) => {
                        areaOrderMap.set(area, index);
                    });
                    // 创建新数组进行排序，不修改原数组
                    marketRegions = [...allRegions].sort((a, b) => {
                        const normalizedA = normalizeAreaName(a);
                        const normalizedB = normalizeAreaName(b);
                        const indexA = areaOrderMap.has(normalizedA) ? areaOrderMap.get(normalizedA) : Infinity;
                        const indexB = areaOrderMap.has(normalizedB) ? areaOrderMap.get(normalizedB) : Infinity;
                        if (indexA !== Infinity && indexB !== Infinity) {
                            return indexA - indexB;
                        }
                        if (indexA !== Infinity) return -1;
                        if (indexB !== Infinity) return 1;
                        return a.localeCompare(b, 'zh-Hans-CN');
                    });
                } else {
                    marketRegions = [...allRegions].sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                }
                const totalPorts = marketRegions.reduce((sum, region) => sum + marketRegionPortMap[region].size, 0);
                // 将Map转换为数组，保持port -> portDisplay的映射关系
                // 使用 portSortUtils 对每个区域的港口进行排序（按 Material-parsed_ports_list.txt 顺序）
                if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                    try {
                        // 确保港口映射已加载
                        if (!window.portSortUtils.portsMappingLoaded) {
                            await window.portSortUtils.loadPortsMapping();
                        }
                        
                        marketRegions.forEach(region => {
                            const portMap = marketRegionPortMap[region];
                            // 提取港口名称列表并排序
                            const portNames = Array.from(portMap.keys());
                            // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                            const sortedPortNames = window.portSortUtils.sortPortsByDataAndRegion(portNames);
                            // 重新构建 portArray，保持 port -> portDisplay 的映射关系
                            const portArray = sortedPortNames.map(portName => {
                                // 如果排序后的名称是标准化格式，使用它；否则使用原始映射
                                const display = portName.startsWith('[') && portName.includes('|')
                                    ? portName
                                    : (portMap.get(portName) || portName);
                                return [portName, display];
                            });
                            marketRegionPortMap[region] = portArray; // 存储为 [port, portDisplay] 的数组
                        });
                    } catch (error) {
                        console.warn('portSortUtils.sortPortNames 失败，使用降级方案:', error);
                        marketRegions.forEach(region => {
                            const portMap = marketRegionPortMap[region];
                            const portArray = Array.from(portMap.entries()).sort((a, b) => {
                                return a[0].localeCompare(b[0], 'zh-Hans-CN');
                            });
                            marketRegionPortMap[region] = portArray;
                        });
                    }
                } else {
                    marketRegions.forEach(region => {
                        const portMap = marketRegionPortMap[region];
                        const portArray = Array.from(portMap.entries()).sort((a, b) => {
                            return a[0].localeCompare(b[0], 'zh-Hans-CN');
                        });
                        marketRegionPortMap[region] = portArray;
                    });
                }

                initMarketSelectors();
                marketSelectedOriginPorts = [];
                marketSelectedRegions = [];
                marketSelectedPorts = [];
                await updateMarketFilterOptions();

                marketInfoBox?.classList.remove('hidden');
                if (marketInfoText) {
                    marketInfoText.textContent = `已加载 ${data.length} 条数据，共 ${marketRegions.length} 个区域，${totalPorts} 个港口`;
                }

                marketChartContainer?.classList.add('hidden');
                excelLoadState.market = true;
                tryRevealModules();
                
                // 更新数据状态显示
                updateDataStatus();
                } catch (error) {
                    showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                    debugError(error);
                    // 更新状态显示错误信息
                    if (excelStatusEl) {
                        excelStatusEl.textContent = '文件加载失败，请检查文件格式';
                    }
                }
        });


        async function readMarketExcelFile(file) {
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX 库未加载，请刷新页面重试'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // 修复：使用 cellDates: false 避免栈溢出，日期由 marketParseDate 手动解析
                        const workbook = XLSX.read(data, { type: 'array', cellDates: false, cellNF: false });
                        const sheetName = workbook.SheetNames.find(name =>
                            name.toLowerCase().includes('market')
                        ) || workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function marketParseDate(value) {
            if (value === null || value === undefined) return null;
            // 如果是数字（Excel 序列号）走通用解析
            if (typeof value === 'number') {
                const d = parseDateValue(value);
                return d instanceof Date && !isNaN(d) ? d : null;
            }
            const s = String(value).trim();
            if (!s) return null;
            // 1) yyyy/mm/dd 或 yyyy-m-d
            let m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            if (m) {
                let y = +m[1], mo = +m[2], d = +m[3];
                // 如果写成 2025/5/11 但实际应为 2025/11/5（mo>12 情况），尝试交换
                if (mo > 12 && d <= 12) {
                    [mo, d] = [d, mo];
                }
                const dt = new Date(y, mo - 1, d);
                return dt instanceof Date && !isNaN(dt) ? dt : null;
            }
            // 2) dd/mm/yyyy 或 d-m-yyyy
            m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
            if (m) {
                let d = +m[1], mo = +m[2], y = +m[3];
                // 如果写成 5/11/2025 但实际应为 11/5/2025（mo>12 情况），尝试交换
                if (mo > 12 && d <= 12) {
                    [d, mo] = [mo, d];
                }
                const dt = new Date(y, mo - 1, d);
                return dt instanceof Date && !isNaN(dt) ? dt : null;
            }
            // 其他格式，尝试通用解析
            const dt = new Date(s);
            return dt instanceof Date && !isNaN(dt) ? dt : null;
        }

        function formatDateLabel(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        }

        /**
         * 获取格式化后的港口显示名称
         * @param {string} port - 原始港口名（C列）
         * @returns {string} 格式化后的显示名称 [港口英文|港口代码|区域]
         */
        function getFormattedPortName(port) {
            if (!port) return port;
            // 在所有区域中查找该港口
            for (const region of marketRegions) {
                const regionPorts = marketRegionPortMap[region] || [];
                // regionPorts 是 [port, portDisplay] 的数组
                for (const [portName, portDisplay] of regionPorts) {
                    if (portName === port) {
                        return portDisplay;
                    }
                }
            }
            return port; // 如果找不到，返回原始名称
        }

        function updateMarketChart(ports) {
            if (!marketData.length || !marketColumnConfig.portCol) {
                showError(ErrorType.DATA_VALIDATION, 'NO_EXCEL_LOADED');
                return;
            }

            const selectedPorts = Array.isArray(ports) ? ports.filter(Boolean) : [ports].filter(Boolean);
            if (!selectedPorts.length) {
                marketChartContainer?.classList.add('hidden');
                return;
            }

            const { portCol, dateCol } = marketColumnConfig;
            const labelMeta = new Map(); // label -> { ts, index }
            let rowIndex = 0;
            const seriesData = selectedPorts.map(port => ({
                port, // 原始港口名，用于数据匹配
                portDisplay: getFormattedPortName(port), // 格式化后的显示名称
                values: new Map() // label -> {gp20, gp40}
            }));

            // 单次遍历，按 Excel 原始行顺序收集
            marketData.forEach(row => {
                const portVal = String(row[portCol] || '').trim();
                if (!selectedPorts.includes(portVal)) return;

                const rawDate = dateCol ? row[dateCol] : '';
                const parsedDate = dateCol ? marketParseDate(rawDate) : null;
                let label = (rawDate ?? '').toString().trim();
                let ts = null;
                if (parsedDate instanceof Date && !isNaN(parsedDate)) {
                    label = formatDateLabel(parsedDate) || label;
                    ts = parsedDate.getTime();
                }
                if (!label) return;

                if (!labelMeta.has(label)) {
                    labelMeta.set(label, { ts, index: rowIndex });
                } else {
                    const meta = labelMeta.get(label);
                    if (ts !== null && (meta.ts === null || ts < meta.ts)) {
                        meta.ts = ts;
                        labelMeta.set(label, meta);
                    }
                }

                const gp20 = row['20GP'] || row['20gp'] || row['GP20'];
                const gp40 = row['40GP'] || row['40gp'] || row['GP40'];
                const targetSeries = seriesData.find(s => s.port === portVal);
                if (targetSeries) {
                    targetSeries.values.set(label, {
                        gp20: gp20 ? parseFloat(gp20) : null,
                        gp40: gp40 ? parseFloat(gp40) : null
                    });
                }

                rowIndex++;
            });

            if (!seriesData.length) {
                marketInfoText && (marketInfoText.textContent = '所选港口在当前时间范围内暂无数据');
                if (marketChart) {
                    marketChart.destroy();
                    marketChart = null;
                }
                marketChartContainer?.classList.add('hidden');
                return;
            }

            const sortedLabels = Array.from(labelMeta.entries())
                .sort((a, b) => {
                    const aKey = a[1].ts !== null ? a[1].ts : Number.MAX_SAFE_INTEGER;
                    const bKey = b[1].ts !== null ? b[1].ts : Number.MAX_SAFE_INTEGER;
                    if (aKey !== bKey) return aKey - bKey;
                    return a[1].index - b[1].index;
                })
                .map(entry => entry[0]);

            if (!sortedLabels.length) {
                marketInfoText && (marketInfoText.textContent = '当前筛选下缺少有效日期');
                marketChartContainer?.classList.add('hidden');
                return;
            }

            const palettes = [
                '#667eea',
                '#ff6b6b',
                '#20c997',
                '#f9a826',
                '#845ef7',
                '#17a2b8',
                '#ff9f43',
                '#6f42c1'
            ];

            const datasets = [];

            seriesData.forEach((series, index) => {
                const color = palettes[index % palettes.length];
                const gp20Values = [];
                const gp40Values = [];

                sortedLabels.forEach(label => {
                    const record = series.values.get(label);
                    gp20Values.push(record?.gp20 ?? null);
                    gp40Values.push(record?.gp40 ?? null);
                });

                datasets.push({
                    label: `${series.portDisplay} - 20GP`,
                    data: gp20Values,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    spanGaps: true
                });

                datasets.push({
                    label: `${series.portDisplay} - 40GP`,
                    data: gp40Values,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderDash: [6, 4],
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    spanGaps: true
                });
            });

            if (marketChart) {
                marketChart.destroy();
            }

            const ctx = document.getElementById('marketTrendChart').getContext('2d');
            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedLabels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback(value) {
                                    return '$' + value;
                                }
                            },
                            title: {
                                display: true,
                                text: '价格 (USD)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            marketChartContainer?.classList.remove('hidden');

            if (marketInfoText) {
                const labelCount = sortedLabels.length;
                // 使用格式化后的港口名称显示
                const formattedPortNames = seriesData.map(s => s.portDisplay);
                let infoText = `已选择 ${seriesData.length} 个港口（${formattedPortNames.join('、')}），共 ${labelCount} 个时间节点`;
                
                // 计算每个港口的价格范围
                const priceRanges = [];
                seriesData.forEach(series => {
                    const gp20Prices = [];
                    const gp40Prices = [];
                    
                    sortedLabels.forEach(label => {
                        const record = series.values.get(label);
                        if (record?.gp20 !== null && record?.gp20 !== undefined) {
                            gp20Prices.push(record.gp20);
                        }
                        if (record?.gp40 !== null && record?.gp40 !== undefined) {
                            gp40Prices.push(record.gp40);
                        }
                    });
                    
                    if (gp20Prices.length > 0 || gp40Prices.length > 0) {
                        const gp20Min = gp20Prices.length > 0 ? Math.min(...gp20Prices) : null;
                        const gp20Max = gp20Prices.length > 0 ? Math.max(...gp20Prices) : null;
                        const gp40Min = gp40Prices.length > 0 ? Math.min(...gp40Prices) : null;
                        const gp40Max = gp40Prices.length > 0 ? Math.max(...gp40Prices) : null;
                        
                        let rangeText = `${series.portDisplay}：`;
                        const parts = [];
                        if (gp20Min !== null && gp20Max !== null) {
                            parts.push(`20GP ${gp20Min.toLocaleString()} ~ ${gp20Max.toLocaleString()}`);
                        }
                        if (gp40Min !== null && gp40Max !== null) {
                            parts.push(`40GP ${gp40Min.toLocaleString()} ~ ${gp40Max.toLocaleString()}`);
                        }
                        if (parts.length > 0) {
                            rangeText += parts.join('，');
                            priceRanges.push(rangeText);
                        }
                    }
                });
                
                if (priceRanges.length > 0) {
                    infoText += '\n' + priceRanges.join('\n');
                }
                
                marketInfoText.textContent = infoText;
            }
        }
    </script>

    <script>
        // 缓存键定义（需要在所有使用之前定义）
        const CACHE_KEYS = {
            wci: 'wciDataCache',
            fbx: 'fbxDataCache'
        };
        
        let groupedTableData = [];
        let latestFilteredRecords = [];
        let destinationFilters = {
            originPorts: [],
            destPorts: [],
            routes: []
        };
        let originPortSearchValue = '';
        let destPortSearchValue = '';
        let routeSearchValue = '';
        let currentView = 'all';
        let weekColumns = [];
        let capacityChart = null;
        let routePathMap = {};
        let weekDefinitionMap = {};

        const infoBox = document.getElementById('infoBox');
        const infoText = document.getElementById('infoText');
        const tableContainer = document.getElementById('tableContainer');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const viewToggle = document.getElementById('viewToggle');
        const btnAll = document.getElementById('btnAll');
        const btnCapacity = document.getElementById('btnCapacity');
        const btnShips = document.getElementById('btnShips');
        const destinationFiltersPanel = document.getElementById('destinationFilters');
        const originPortSelect = document.getElementById('originPortSelect');
        const originPortSearch = document.getElementById('originPortSearch');
        const destPortSelect = document.getElementById('destPortSelect');
        const destPortSearch = document.getElementById('destPortSearch');
        const routeSelect = document.getElementById('routeSelect');
        const routeSearch = document.getElementById('routeSearch');

        /**
         * 获取多选下拉框的选中值
         */
        function getSelectedValues(selectElement) {
            if (!selectElement) return [];
            return Array.from(selectElement.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');
        }

        /**
         * 设置多选下拉框（支持点击切换选择，不需要 Control 键）
         */
        function setupMultiSelect(selectElement) {
            if (!selectElement) return;
            selectElement.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const option = e.target;
                if (option.tagName === 'OPTION') {
                    option.selected = !option.selected;
                    selectElement.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }

        /**
         * 填充下拉选择框（本地实现，不进行排序，保持传入的顺序）
         * @param {HTMLSelectElement} selectElement - 选择框元素
         * @param {string[]} options - 选项数组（已经排序好的）
         * @param {string} defaultLabel - 默认标签
         * @param {string[]} selectedValues - 已选中的值
         * @param {boolean} disabled - 是否禁用
         */
        function populateSelectLocal(selectElement, options, defaultLabel, selectedValues, disabled) {
            if (!selectElement) return;
            
            selectElement.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultLabel;
            selectElement.appendChild(defaultOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                if (selectedValues && selectedValues.includes(option)) {
                    optionElement.selected = true;
                }
                selectElement.appendChild(optionElement);
            });
            
            selectElement.disabled = !!disabled;
        }

        async function updateDestinationFilterOptions() {
            // 保留完整的港口列表，允许用户多选多个港口来覆盖所有航线
            // 从所有原始记录中提取完整的港口列表（不进行过滤）
            let allOriginPortOptions = [...new Set(processedRecords.map(r => r.originPort).filter(Boolean))];
            let allDestPortOptions = [...new Set(processedRecords.map(r => r.destPort).filter(Boolean))];
            
            // 对于共舱船公司，可以根据已选择的港口进行过滤（可选）
            let filteredRecords = processedRecords;
            if (destinationFilters.originPorts.length > 0 || destinationFilters.destPorts.length > 0) {
                filteredRecords = filteredRecords.filter(record => {
                    if (destinationFilters.originPorts.length > 0 && !destinationFilters.originPorts.includes(record.originPort)) {
                        return false;
                    }
                    if (destinationFilters.destPorts.length > 0 && !destinationFilters.destPorts.includes(record.destPort)) {
                        return false;
                    }
                    return true;
                });
            }
            
            // 从过滤后的记录中提取共舱船公司选项
            const allRouteOptions = [...new Set(filteredRecords.map(r => r.route || r.routeLabel).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            
            // 使用统一的排序函数（按区域顺序和代码顺序排序）
            if (typeof window !== 'undefined' && typeof window.portSortUtils !== 'undefined') {
                try {
                    // 确保港口映射已加载
                    if (!window.portSortUtils.portsMappingLoaded) {
                        await window.portSortUtils.loadPortsMapping();
                    }
                    // 使用新的统一排序函数（按区域顺序和代码顺序排序）
                    allOriginPortOptions = window.portSortUtils.sortPortsByDataAndRegion(allOriginPortOptions);
                    allDestPortOptions = window.portSortUtils.sortPortsByDataAndRegion(allDestPortOptions);
                } catch (error) {
                    console.warn('portSortUtils.sortPortsByDataAndRegion 失败，使用降级方案:', error);
                    // 降级方案：简单排序
                    allOriginPortOptions = allOriginPortOptions.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                    allDestPortOptions = allDestPortOptions.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                }
            } else {
                // 降级方案：简单排序
                allOriginPortOptions = allOriginPortOptions.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                allDestPortOptions = allDestPortOptions.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            }

            // 根据搜索值过滤选项
            const filteredOriginPortOptions = originPortSearchValue.trim()
                ? allOriginPortOptions.filter(port => port.toLowerCase().includes(originPortSearchValue.toLowerCase()))
                : allOriginPortOptions;
            const filteredDestPortOptions = destPortSearchValue.trim()
                ? allDestPortOptions.filter(port => port.toLowerCase().includes(destPortSearchValue.toLowerCase()))
                : allDestPortOptions;
            const filteredRouteOptions = routeSearchValue.trim()
                ? allRouteOptions.filter(route => route.toLowerCase().includes(routeSearchValue.toLowerCase()))
                : allRouteOptions;

            // 保留已选择的选项（即使它们不在当前可用选项中）
            destinationFilters.originPorts = destinationFilters.originPorts.filter(value => filteredOriginPortOptions.includes(value));
            destinationFilters.destPorts = destinationFilters.destPorts.filter(value => filteredDestPortOptions.includes(value));
            destinationFilters.routes = destinationFilters.routes.filter(value => filteredRouteOptions.includes(value));

            // 使用本地 populateSelect 函数，保持排序后的顺序（不重新排序）
            populateSelectLocal(originPortSelect, filteredOriginPortOptions, '全部起运港', destinationFilters.originPorts, false);
            populateSelectLocal(destPortSelect, filteredDestPortOptions, '全部目的港', destinationFilters.destPorts, false);
            populateSelectLocal(routeSelect, filteredRouteOptions, '全部共舱船公司', destinationFilters.routes, false);
        }


        function getFilteredRecords() {
            const weekCodes = weekColumns.length > 0 ? weekColumns.map(w => w.code) : [];
            const filtered = processedRecords.filter(record => {
                if (destinationFilters.originPorts.length && !destinationFilters.originPorts.includes(record.originPort)) return false;
                if (destinationFilters.destPorts.length && !destinationFilters.destPorts.includes(record.destPort)) return false;
                if (destinationFilters.routes.length && !destinationFilters.routes.includes(record.route) && !destinationFilters.routes.includes(record.routeLabel)) return false;
                if (weekCodes.length > 0 && !weekCodes.includes(record.weekCode)) return false;
                return true;
            });
            if (typeof deduplicateSailingItems === 'function') {
                return deduplicateSailingItems(filtered);
            }
            return filtered;
        }

        /**
         * HTML 转义函数（防止 XSS）
         * @param {string} text - 要转义的文本
         * @returns {string} - 转义后的文本
         */
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function groupRecords(records) {
            const groups = new Map();

            records.forEach(record => {
                const routeLabel = record.routeLabel || record.route || '未知航线';
                const routeKey = record.routeId || routeLabel;
                const routeRemark = record.routeRemark || '';
                const routePath = record.routePath || routePathMap[record.routeId] || '';

                const key = routeKey;

                if (!groups.has(key)) {
                    groups.set(key, {
                        routeLabel,
                        route: record.route || routeLabel,
                        routeId: record.routeId || '',
                        routeRemark,
                        routePath,
                        port: '',
                        weeks: {}
                    });
                }

                const group = groups.get(key);
                if (!group.weeks[record.weekCode]) {
                    group.weeks[record.weekCode] = [];
                }

                const entries = group.weeks[record.weekCode];
                const dedupKey = buildShipSignature(record);
                const exists = entries.some(item => item.dedupKey === dedupKey);
                if (exists) {
                    return;
                }
                entries.push({
                    capacity: record.capacity,
                    shipName: record.shipName,
                    shipDate: record.shipDate,
                    routeId: record.routeId || '',
                    dedupKey
                });
            });

            const sorted = Array.from(groups.values()).sort((a, b) => {
                return (a.routeLabel || '').localeCompare(b.routeLabel || '');
            });

            return {
                data: sorted,
                level: 0
            };
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (typeof XLSX === 'undefined') {
                showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                return;
            }

            try {
                const data = await readExcelFile(file);
                scheduleData = data;
                await generatePivotTable(data);
                infoText.textContent = `已加载 ${data.length} 条船期数据`;
                infoBox.classList.remove('hidden');
                excelLoadState.schedule = true;
                tryRevealModules();
                
                // 更新数据状态显示
                updateDataStatus();
            } catch (error) {
                showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
                debugError(error);
                // 更新状态显示错误信息
                if (excelStatusEl) {
                    excelStatusEl.textContent = '文件加载失败，请检查文件格式';
                }
            }
        });

        btnAll.addEventListener('click', () => {
            currentView = 'all';
            btnAll.classList.add('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnCapacity.addEventListener('click', () => {
            currentView = 'capacity';
            btnAll.classList.remove('active');
            btnCapacity.classList.add('active');
            btnShips.classList.remove('active');
            renderTable();
        });

        btnShips.addEventListener('click', () => {
            currentView = 'ships';
            btnAll.classList.remove('active');
            btnCapacity.classList.remove('active');
            btnShips.classList.add('active');
            renderTable();
        });


        if (originPortSelect) {
            setupMultiSelect(originPortSelect);
            originPortSelect.addEventListener('change', async () => {
                destinationFilters.originPorts = getSelectedValues(originPortSelect);
                // 级联更新：根据选择的起运港更新目的港和共舱船公司选项
                await updateDestinationFilterOptions();
                renderTable();
            });
        }
        if (originPortSearch) {
            originPortSearch.addEventListener('input', async (e) => {
                originPortSearchValue = e.target.value;
                await updateDestinationFilterOptions();
            });
        }

        if (destPortSelect) {
            setupMultiSelect(destPortSelect);
            destPortSelect.addEventListener('change', async () => {
                destinationFilters.destPorts = getSelectedValues(destPortSelect);
                // 级联更新：根据选择的目的港更新起运港和共舱船公司选项
                await updateDestinationFilterOptions();
                renderTable();
            });
        }
        if (destPortSearch) {
            destPortSearch.addEventListener('input', async (e) => {
                destPortSearchValue = e.target.value;
                await updateDestinationFilterOptions();
            });
        }

        if (routeSelect) {
            setupMultiSelect(routeSelect);
            routeSelect.addEventListener('change', async () => {
                destinationFilters.routes = getSelectedValues(routeSelect);
                // 级联更新：根据选择的共舱船公司更新起运港和目的港选项
                await updateDestinationFilterOptions();
                renderTable();
            });
        }
        if (routeSearch) {
            routeSearch.addEventListener('input', async (e) => {
                routeSearchValue = e.target.value;
                await updateDestinationFilterOptions();
            });
        }

        const marketOriginPortSelectAll = document.getElementById('marketOriginPortSelectAll');
        const marketOriginPortClear = document.getElementById('marketOriginPortClear');
        const marketRegionSelectAll = document.getElementById('marketRegionSelectAll');
        const marketRegionClear = document.getElementById('marketRegionClear');
        const marketPortSelectAll = document.getElementById('marketPortSelectAll');
        const marketPortClear = document.getElementById('marketPortClear');
        
        if (marketOriginPortSelectAll && marketOriginPortSelect) {
            marketOriginPortSelectAll.addEventListener('click', () => {
                selectAllOptions(marketOriginPortSelect);
                marketSelectedOriginPorts = getSelectedValues(marketOriginPortSelect);
                updateMarketFilterOptions();
            });
        }
        if (marketOriginPortClear && marketOriginPortSelect) {
            marketOriginPortClear.addEventListener('click', () => {
                clearSelectOptions(marketOriginPortSelect);
                marketSelectedOriginPorts = [];
                updateMarketFilterOptions();
                updateMarketChartFromSelection(false);
            });
        }
        if (marketRegionSelectAll && marketRegionSelect) {
            marketRegionSelectAll.addEventListener('click', () => {
                selectAllOptions(marketRegionSelect);
                marketSelectedRegions = getSelectedValues(marketRegionSelect);
                updateMarketFilterOptions();
            });
        }
        if (marketRegionClear && marketRegionSelect) {
            marketRegionClear.addEventListener('click', () => {
                clearSelectOptions(marketRegionSelect);
                marketSelectedRegions = [];
                updateMarketFilterOptions();
                updateMarketChartFromSelection(false);
            });
        }
        if (marketPortSelectAll && marketPortSelect) {
            marketPortSelectAll.addEventListener('click', () => {
                selectAllOptions(marketPortSelect);
                marketSelectedPorts = getSelectedValues(marketPortSelect);
                updateMarketFilterOptions();
            });
        }
        if (marketPortClear && marketPortSelect) {
            marketPortClear.addEventListener('click', () => {
                clearSelectOptions(marketPortSelect);
                marketSelectedPorts = [];
                updateMarketFilterOptions();
                updateMarketChartFromSelection(true);
            });
        }
        const originPortSelectAll = document.getElementById('originPortSelectAll');
        const originPortClearAll = document.getElementById('originPortClearAll');
        const destPortSelectAll = document.getElementById('destPortSelectAll');
        const destPortClearAll = document.getElementById('destPortClearAll');
        const routeSelectAll = document.getElementById('routeSelectAll');
        const routeClearAll = document.getElementById('routeClearAll');

        if (originPortSelectAll && originPortSelect) {
            originPortSelectAll.addEventListener('click', () => selectAllOptions(originPortSelect));
        }
        if (originPortClearAll && originPortSelect) {
            originPortClearAll.addEventListener('click', () => clearSelectOptions(originPortSelect));
        }
        if (destPortSelectAll && destPortSelect) {
            destPortSelectAll.addEventListener('click', () => selectAllOptions(destPortSelect));
        }
        if (destPortClearAll && destPortSelect) {
            destPortClearAll.addEventListener('click', () => clearSelectOptions(destPortSelect));
        }
        if (routeSelectAll && routeSelect) {
            routeSelectAll.addEventListener('click', () => selectAllOptions(routeSelect));
        }
        if (routeClearAll && routeSelect) {
            routeClearAll.addEventListener('click', () => clearSelectOptions(routeSelect));
        }

        async function readExcelFile(file) {
            // 使用统一的 Excel 读取函数（支持 week 工作表解析）
            if (typeof window.readExcelFileWithWeek === 'function') {
                try {
                    const jsonData = await window.readExcelFileWithWeek(file, {
                        weekConfig: {
                            weekTextColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.WEEK_TEXT,
                            dateRangeColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.DATE_RANGE
                        },
                        onWeekParsed: (parsedWeekMap) => {
                            weekDefinitionMap = parsedWeekMap || {};
                        }
                    });
                    return jsonData;
                } catch (error) {
                    // 如果新函数失败，降级到原始实现
                    debugWarn('readExcelFileWithWeek 失败，使用降级方案:', error);
                }
            }
            
            // 降级方案：使用原始实现
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX 库未加载，请刷新页面重试'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: false, cellNF: false });
                        
                        // 查找并解析 week 工作表
                        const weekSheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase() === 'week' || name.toLowerCase().includes('week')
                        );
                        if (weekSheetName) {
                            const weekWorksheet = workbook.Sheets[weekSheetName];
                            const weekData = XLSX.utils.sheet_to_json(weekWorksheet, { header: 1, defval: null, raw: true });
                            if (typeof window.parseWeekDefinitions === 'function') {
                                weekDefinitionMap = window.parseWeekDefinitions(weekData, {
                                    weekTextColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.WEEK_TEXT,
                                    dateRangeColumn: APP_CONFIG.WEEK_SHEET_COLUMNS.DATE_RANGE
                                });
                            } else {
                                debugError('parseWeekDefinitions 函数未加载，请检查 week-definition-parser.js 是否已加载');
                                weekDefinitionMap = {};
                            }
                        } else {
                            debugError('未找到week工作表！工作表列表:', workbook.SheetNames);
                            weekDefinitionMap = {};
                        }
                        
                        // 查找 schedule 工作表
                        const sheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('schedule')
                        ) || workbook.SheetNames[0];
                        
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            raw: true, 
                            defval: null
                        });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // ==================== 常量配置 ====================
        /**
         * 应用配置常量
         */
        const APP_CONFIG = {
            // 文件大小限制（字节）
            FILE_SIZE_LIMITS: {
                EXCEL: 50 * 1024 * 1024,
                PDF: 20 * 1024 * 1024
            },
            // 周别配置
            WEEK_COUNT: 4,
            WEEK_SHEET_COLUMNS: {
                WEEK_TEXT: 3,
                DATE_RANGE: 0
            }
        };
        
        const FILE_SIZE_LIMITS = APP_CONFIG.FILE_SIZE_LIMITS;

        /**
         * 从weekDefinitionMap获取周别代码（当周+未来3周，共4周）
         * @param {Object} weekDefinitionMap - 周别定义映射表
         * @returns {string[]} - 周别代码数组
         */
        function getWeekCodesFromDefinition(weekDefinitionMap) {
            if (Object.keys(weekDefinitionMap).length > 0) {
                const allWeekCodes = Object.keys(weekDefinitionMap).sort();
                
                if (typeof window === 'undefined' || !window.getCurrentWeekCode) {
                    debugError('getCurrentWeekCode 函数未找到，请检查 week-utils.js 是否已加载');
                    return [];
                }
                const currentWeekCode = window.getCurrentWeekCode();
                const currentIndex = allWeekCodes.indexOf(currentWeekCode);
                
                let selectedWeekCodes = [];
                if (currentIndex >= 0) {
                    selectedWeekCodes = allWeekCodes.slice(currentIndex, currentIndex + APP_CONFIG.WEEK_COUNT).filter(Boolean);
                } else {
                    debugWarn(`当前周别 ${currentWeekCode} 不在weekDefinitionMap中，使用前${APP_CONFIG.WEEK_COUNT}周`);
                    selectedWeekCodes = allWeekCodes.slice(0, APP_CONFIG.WEEK_COUNT).filter(Boolean);
                }
                
                return selectedWeekCodes;
            }
            
            const currentWeekCode = (typeof window !== 'undefined' && window.getCurrentWeekCode) 
                ? window.getCurrentWeekCode() 
                : getCurrentWeekCode();
            const defaultWeeks = [];
            for (let i = 0; i < APP_CONFIG.WEEK_COUNT; i++) {
                const year = parseInt(currentWeekCode.substring(0, 4), 10);
                const week = parseInt(currentWeekCode.substring(4), 10) + i;
                let finalYear = year;
                let finalWeek = week;
                if (week > 52) {
                    finalYear = year + 1;
                    finalWeek = week - 52;
                }
                defaultWeeks.push(`${finalYear}${String(finalWeek).padStart(2, '0')}`);
            }
            return defaultWeeks;
        }

        /**
         * 构建周列数据（从weekDefinitionMap获取日期范围）
         * @param {string[]} weekCodes - 周别代码数组
         * @param {Object} weekDefinitionMap - 周别定义映射表
         * @returns {Array} - 周列数据数组
         */
        function buildWeekColumns(weekCodes, weekDefinitionMap) {
            if (!Array.isArray(weekCodes) || weekCodes.length === 0) {
                debugError('weekCodes为空');
                return [];
            }
            
            return weekCodes.map(code => {
                const year = code.substring(0, 4);
                const weekNo = parseInt(code.substring(4), 10);
                
                const weekDef = weekDefinitionMap[code];
                if (!weekDef || !weekDef.range) {
                    debugError(`周别 ${code} 未在weekDefinitionMap中找到日期范围！`);
                    return {
                        code,
                        label: `${year}/${String(weekNo).padStart(2, '0')}`,
                        range: '[未找到日期范围]'
                    };
                }
                
                return {
                    code,
                    label: `${year}/${String(weekNo).padStart(2, '0')}`,
                    range: weekDef.range
                };
            });
        }

        async function generatePivotTable(data) {
            if (!data || data.length === 0) {
                showError(ErrorType.DATA_VALIDATION, 'DATA_EMPTY');
                return;
            }

            const firstRow = data[0];
            const columnKeys = Object.keys(firstRow);

            const matchesKeyword = (key, keyword) => {
                if (!key) return false;
                const lowerKey = key.toLowerCase();
                return lowerKey.includes(keyword.toLowerCase()) || key.includes(keyword);
            };

            const findColumnKey = (keywords, fallbackIndex = null) => {
                const key = columnKeys.find(col =>
                    keywords.some(keyword => matchesKeyword(col, keyword))
                );
                if (key) return key;
                if (typeof fallbackIndex === 'number' && columnKeys[fallbackIndex]) {
                    return columnKeys[fallbackIndex];
                }
                return null;
            };

            const weekCol = findColumnKey(['周别', '周次', '周数', 'week'], 17);
            const capacityCol = findColumnKey(['运力', 'teu', '舱位'], 18);
            const shipNameCol = findColumnKey(['船名', '航次', 'vessel'], 11);
            const shipDateCol = findColumnKey(['开船', '船期', '离港', 'etd', '时间'], 12);
            const routeIdCol = findColumnKey(['航线id', '航线ID', 'route id', 'group_id', 'groupid'], 6);

            const originPortCol = findColumnKey(['起运港', 'pol', 'origin'], 0); // A列（索引0）
            const destPortCol = findColumnKey(['目的港', 'pod', 'destination'], 1); // B列（索引1）
            const routeCol =
                columnKeys.find(col => matchesKeyword(col, '共舱')) ||
                columnKeys.find(col => matchesKeyword(col, '船公司')) ||
                columnKeys.find(col => matchesKeyword(col, 'route')) ||
                (columnKeys[9] || null); // J列（索引9）
            const routeRemarkCol = columnKeys[10] || null; // K列（索引10）
            const routePathCol = columnKeys[24] || null; // Y列（索引24）

            if (!weekCol || !capacityCol || !shipNameCol || !shipDateCol || !routeCol || !originPortCol || !destPortCol) {
                showError(ErrorType.FILE_PARSE, 'MISSING_COLUMNS', { columns: columnKeys.join(', ') });
                return;
            }

            const weekCodes = getWeekCodesFromDefinition(weekDefinitionMap);
            weekColumns = buildWeekColumns(weekCodes, weekDefinitionMap);

            processedRecords = [];
            destinationFilters = { 
                originPorts: [],
                destPorts: [],
                routes: []
            };
            originPortSearchValue = '';
            destPortSearchValue = '';
            routeSearchValue = '';

            data.forEach(row => {
                const weekText = String(row[weekCol] ?? '').trim();
                const weekCode = parseWeekText(weekText);
                if (!weekCode) {
                    return;
                }

                // 读取原始港口名称
                const originPortRaw = originPortCol ? String(row[originPortCol] ?? '').trim() : '';
                const destPortRaw = destPortCol ? String(row[destPortCol] ?? '').trim() : '';
                
                // 使用原始港口名称（保持 Excel 中的原始值，不进行标准化）
                const originPort = originPortRaw;
                const destPort = destPortRaw;
                
                let route = String(row[routeCol] ?? '').trim();
                const routeId = routeIdCol ? String(row[routeIdCol] ?? '').trim() : '';
                const routeRemark = routeRemarkCol ? String(row[routeRemarkCol] ?? '').trim() : '';
                const routePath = routePathCol ? String(row[routePathCol] ?? '').trim() : '';
                const capacity = parseFloat(row[capacityCol]) || 0;
                const shipName = String(row[shipNameCol] ?? '').trim();
                const shipDate = String(row[shipDateCol] ?? '').trim();

                if (!route) {
                    route = '未知航线';
                }

                if (routeId) {
                    if (route && route !== '未知航线') {
                        registerRouteLabel(routeId, route);
                    }
                    route = getRouteLabel(routeId, route);
                    if (routePath) {
                        routePathMap[routeId] = routePath;
                    }
                }

                const record = {
                    originPort,
                    destPort,
                    route,
                    routeId,
                    routeRemark,
                    routePath,
                    weekCode,
                    capacity,
                    shipName,
                    shipDate
                };
                processedRecords.push(record);
            });

            processedRecords = processedRecords.map(record => ({
                ...record,
                routeLabel: getRouteLabel(record.routeId, record.route)
            }));
            if (processedRecords.length === 0) {
                showError(ErrorType.FILE_PARSE, 'NO_SCHEDULE_DATA');
                return;
            }

            await updateDestinationFilterOptions();
            renderTable();
            updateAiAnalysis(false);
        }

        function renderTable() {
            if (!processedRecords.length) {
                tableContainer.classList.add('hidden');
                updateChart(false, []);
                updateAiAnalysis(false);
                return;
            }

            const weekCodes = getWeekCodesFromDefinition(weekDefinitionMap);
            weekColumns = buildWeekColumns(weekCodes, weekDefinitionMap);

            const filteredRecords = getFilteredRecords();
            latestFilteredRecords = filteredRecords;
            const groupedResult = groupRecords(filteredRecords);
            const groupedData = groupedResult.data;
            groupedTableData = groupedData;

            const routeRemarkWidth = '10%';
            const routeLabelWidth = '40%';
            const weekCount = weekColumns.length;
            const weekColumnWidth = weekCount > 0 ? `${50 / weekCount}%` : '0%';
            
            const headerCells = weekColumns.map(week => {
                const rangeHtml = week.range ? `<div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">(${escapeHtml(week.range)})</div>` : '';
                return `<th class="table-header week-cell" style="width: ${weekColumnWidth};">
                    <div>${escapeHtml(week.label)}</div>
                    ${rangeHtml}
                </th>`;
            }).join('');
            
            tableHead.innerHTML = `
                <tr>
                    <th class="table-header" style="width: ${routeRemarkWidth};">航线备注</th>
                    <th class="table-header" style="width: ${routeLabelWidth};">共舱船公司</th>
                    ${headerCells}
                </tr>
            `;

            tableBody.innerHTML = '';
            groupedData.forEach(item => {
                const row = document.createElement('tr');
                const routePath = item.routePath || routePathMap[item.routeId] || '';
                const routePathAttr = routePath ? `data-tooltip="${routePath.replace(/"/g, '&quot;')}"` : '';
                const routeCellClass = routePath ? 'hover-cell' : '';
                const cells = [
                    `<td>${item.routeRemark || '—'}</td>`,
                    `<td class="${routeCellClass}" ${routePathAttr}>${item.routeLabel || '未知航线'}</td>`
                ];

                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    
                    // 计算该周的运力和派船数
                    const totalCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    const shipCount = ships.length;
                    
                    // 构建tooltip内容（船名航次、运力和开船日期）
                    let tooltipData = '';
                    if (ships.length > 0) {
                        const shipDetails = ships.map(ship => {
                            const name = ship.shipName || '未知';
                            const capacity = ship.capacity || 0;
                            let date = ship.shipDate || '未知';
                            
                            if (date && date !== '未知') {
                                if (typeof window !== 'undefined' && typeof window.formatDateToYYYYMMDD === 'function') {
                                    date = window.formatDateToYYYYMMDD(date);
                                } else if (typeof formatDateToYYYYMMDD === 'function') {
                                    date = formatDateToYYYYMMDD(date);
                                }
                            }
                            
                            // 格式：船名航次 运力TEU (日期) - 确保一行显示
                            const capacityStr = capacity > 0 ? `${capacity.toLocaleString()} TEU` : '0 TEU';
                            return `${name} ${capacityStr} (${date})`;
                        }).join('\n');
                        tooltipData = shipDetails;
                    }
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${shipCount}`;
                    } else if (currentView === 'capacity') {
                        cellContent = totalCapacity.toLocaleString() + ' TEU';
                    } else if (currentView === 'ships') {
                        cellContent = shipCount.toString();
                    }
                    
                    const cellClass = ships.length > 0 ? 'number-cell hover-cell' : 'number-cell';
                    const tooltipAttr = tooltipData ? `data-tooltip="${tooltipData.replace(/"/g, '&quot;')}"` : '';
                    cells.push(`<td class="${cellClass}" ${tooltipAttr}>${cellContent}</td>`);
                });

                row.innerHTML = cells.join('');
                tableBody.appendChild(row);
            });
            
                const hasDestinationSelection = Boolean(
                destinationFilters.originPorts.length ||
                destinationFilters.destPorts.length ||
                destinationFilters.routes.length
            );

            if (hasDestinationSelection && groupedData.length > 0) {
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'summary-row';
                const summaryCells = [
                    '<td><strong>合计</strong></td>',
                    '<td></td>'
                ];

                let totalCapacityByWeek = {};
                let totalShipsByWeek = {};
                
                // 计算每周的合计
                groupedData.forEach(item => {
                    weekColumns.forEach((week) => {
                        const weekCode = week.code;
                        const ships = item.weeks[weekCode] || [];
                        const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                        const weekShips = ships.length;
                        
                        if (!totalCapacityByWeek[weekCode]) {
                            totalCapacityByWeek[weekCode] = 0;
                            totalShipsByWeek[weekCode] = 0;
                        }
                        totalCapacityByWeek[weekCode] += weekCapacity;
                        totalShipsByWeek[weekCode] += weekShips;
                    });
                });
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const totalCapacity = totalCapacityByWeek[weekCode] || 0;
                    const totalShips = totalShipsByWeek[weekCode] || 0;
                    
                    let cellContent = '';
                    if (currentView === 'all') {
                        cellContent = `运力: ${totalCapacity.toLocaleString()} TEU<br>派船: ${totalShips}`;
                    } else if (currentView === 'capacity') {
                        cellContent = `${totalCapacity.toLocaleString()} TEU`;
                    } else if (currentView === 'ships') {
                        cellContent = `${totalShips}`;
                    }
                    
                    summaryCells.push(`<td class="number-cell"><strong>${cellContent}</strong></td>`);
                });
                
                summaryRow.innerHTML = summaryCells.join('');
                tableBody.appendChild(summaryRow);
            }

            const hoverCells = tableBody.querySelectorAll('.hover-cell');
            hoverCells.forEach(cell => {
                const tooltipText = cell.getAttribute('data-tooltip');
                if (!tooltipText) return;
                
                let tooltip = null;
                
                cell.addEventListener('mouseenter', (e) => {
                    tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.style.display = 'block';
                    // 对于路径信息，直接显示完整文本
                    const displayText = tooltipText;
                    const span = document.createElement('span');
                    span.className = 'tooltip-line';
                    span.textContent = displayText;
                    span.style.whiteSpace = 'pre-wrap';
                    tooltip.appendChild(span);
                    document.body.appendChild(tooltip);
                    
                    const updateTooltipPosition = (event) => {
                        if (!tooltip || !tooltip.parentNode) return;
                        
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;
                        const rect = tooltip.getBoundingClientRect();
                        const tooltipWidth = rect.width || tooltip.offsetWidth;
                        const tooltipHeight = rect.height || tooltip.offsetHeight;
                        const padding = 10;
                        
                        let tooltipX = mouseX + padding;
                        let tooltipY = mouseY + padding;
                        
                        if (tooltipX + tooltipWidth > window.innerWidth) {
                            tooltipX = mouseX - tooltipWidth - padding;
                        }
                        
                        if (tooltipX < 0) {
                            tooltipX = (window.innerWidth - tooltipWidth) / 2;
                        }
                        
                        if (tooltipY + tooltipHeight > window.innerHeight) {
                            tooltipY = mouseY - tooltipHeight - padding;
                        }
                        
                        if (tooltipY < 0) {
                            tooltipY = mouseY + padding;
                        }
                        
                        tooltip.style.left = tooltipX + 'px';
                        tooltip.style.top = tooltipY + 'px';
                    };
                    
                    requestAnimationFrame(() => {
                        updateTooltipPosition(e);
                    });
                    
                    cell.addEventListener('mousemove', updateTooltipPosition);
                    cell._tooltipMoveHandler = updateTooltipPosition;
                });
                
                cell.addEventListener('mouseleave', () => {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                    if (cell._tooltipMoveHandler) {
                        cell.removeEventListener('mousemove', cell._tooltipMoveHandler);
                        cell._tooltipMoveHandler = null;
                    }
                });
            });

            tableContainer.classList.remove('hidden');
            
            const hasPortSelection = destinationFilters.originPorts.length > 0 || destinationFilters.destPorts.length > 0 || destinationFilters.routes.length > 0;
            updateChart(hasPortSelection, groupedData);
            updateAiAnalysis(hasPortSelection);
        }
        
        function updateChart(hasPortSelection, groupedData) {
            const chartContainer = document.getElementById('chartContainer');
            const chartWrapper = document.getElementById('chartWrapper');
            const emptyChartMessage = document.getElementById('emptyChartMessage');
            
            chartContainer.classList.remove('hidden');
            
            if (!hasPortSelection || groupedData.length === 0) {
                chartWrapper.classList.add('hidden');
                emptyChartMessage.classList.remove('hidden');
                if (capacityChart) {
                    capacityChart.destroy();
                    capacityChart = null;
                }
                return;
            }
            
            emptyChartMessage.classList.add('hidden');
            chartWrapper.classList.remove('hidden');
            
            const weekCodes = weekColumns.map(week => week.code);
            const weekLabels = weekColumns.map(week => {
                const range = week.range ? ` (${week.range})` : '';
                return `${week.label}${range}`;
            });
            
            const shipData = [];
            const datasets = [];
            const podRoutePairs = [];
            
            groupedData.forEach(item => {
                const routeLabel = item.routeLabel || '未知航线';
                const routeRemark = item.routeRemark || '—';
                podRoutePairs.push({
                    label: `${routeRemark} - ${routeLabel}`,
                    routeLabel: routeLabel,
                    routeId: item.routeId || '',
                    routeRemark: routeRemark
                });
            });
            
            podRoutePairs.forEach((pair, index) => {
                const item = groupedData[index];
                const capacityValues = [];
                
                weekColumns.forEach((week) => {
                    const weekCode = week.code;
                    const ships = item.weeks[weekCode] || [];
                    const weekCapacity = ships.reduce((sum, ship) => sum + (ship.capacity || 0), 0);
                    capacityValues.push(weekCapacity);
                });
                
                const hue = (index * 137.508) % 360;
                const color = `hsl(${hue}, 70%, 50%)`;
                
                datasets.push({
                    label: pair.label,
                    data: capacityValues,
                    type: 'bar',
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1,
                    order: 1
                });
            });
            
            weekColumns.forEach((week) => {
                const weekCode = week.code;
                let totalShips = 0;
                groupedData.forEach(item => {
                    const ships = item.weeks[weekCode] || [];
                    totalShips += ships.length;
                });
                shipData.push(totalShips);
            });
            
            datasets.push({
                label: '派船总数',
                data: shipData,
                type: 'line',
                borderColor: '#FF8A00',
                backgroundColor: 'rgba(255, 138, 0, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#FF8A00',
                pointBorderColor: '#FFFFFF',
                pointBorderWidth: 2,
                yAxisID: 'y1',
                order: 0
            });
            
            if (capacityChart) {
                capacityChart.destroy();
            }
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            capacityChart = new Chart(ctx, {
                data: {
                    labels: weekLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '运力与派船趋势分析',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '周别'
                            }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '运力 (TEU)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '派船数'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            stacked: false
                        }
                    }
                }
            });
        }

        const aiProviders = createAiProviders('', {
            deepseek: { maxTokens: 8000 },
            kimi: { maxTokens: 8000 },
            qwen: { maxTokens: 8000 }
        });
        let activeAiProvider = 'deepseek';
        let setActiveAiPanelBound = null;
        function setActiveAiPanel(providerId = 'deepseek') {
            if (setActiveAiPanelBound) {
                const result = setActiveAiPanelBound(providerId);
                if (result) {
                    activeAiProvider = result;
                }
            } else {
                if (!aiProviders[providerId]) return;
                activeAiProvider = providerId;
                const aiTabButtons = document.querySelectorAll('.ai-tab-btn');
                const aiPanels = document.querySelectorAll('.ai-panel');
                aiTabButtons.forEach(btn => {
                    if (btn.dataset.provider === providerId) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                aiPanels.forEach(panel => {
                    if (panel.dataset.provider === providerId) {
                        panel.classList.add('active');
                    } else {
                        panel.classList.remove('active');
                    }
                });
            }
        }

        function loadAiConfigs() {
            loadAiConfigsFromStorage(aiProviders);
        }

        function getAiConfig(providerId = 'deepseek') {
            return getAiConfigFromInputs(providerId, aiProviders);
        }

        function saveAiConfig(providerId = 'deepseek') {
            saveAiConfigToStorage(providerId, aiProviders, (providerName) => {
                const configSavedMsg = typeof getErrorMessage === 'function' 
                    ? getErrorMessage(ErrorType.USER_ACTION, 'CONFIG_SAVED', { provider: providerName })
                    : `${providerName} API 配置已保存`;
                showSuccess(configSavedMsg);
            });
        }
        
        window.saveAiConfig = saveAiConfig;

        const wciCodeMap = {
            'WCI-COMPOSITE': '全球综合',
            'WCI-SHA-RTM': '上海 → 鹿特丹',
            'WCI-RTM-SHA': '鹿特丹 → 上海',
            'WCI-SHA-GOA': '上海 → 热那亚',
            'WCI-SHA-LAX': '上海 → 洛杉矶',
            'WCI-LAX-SHA': '洛杉矶 → 上海',
            'WCI-SHA-NYC': '上海 → 纽约',
            'WCI-NYC-RTM': '纽约 → 鹿特丹',
            'WCI-RTM-NYC': '鹿特丹 → 纽约'
        };

        const fbxCodeMap = {
            FBX: 'FBX（Freightos Baltic Index 全球综合）',
            FBX01: 'FBX01 中国/东亚 → 北美西海岸',
            FBX02: 'FBX02 北美西海岸 → 中国/东亚',
            FBX03: 'FBX03 中国/东亚 → 北美东海岸',
            FBX04: 'FBX04 北美东海岸 → 中国/东亚',
            FBX11: 'FBX11 中国/东亚 → 北欧',
            FBX12: 'FBX12 北欧 → 中国/东亚',
            FBX13: 'FBX13 中国/东亚 → 地中海',
            FBX14: 'FBX14 地中海 → 中国/东亚',
            FBX21: 'FBX21 北美东海岸 → 北欧',
            FBX22: 'FBX22 北欧 → 北美东海岸',
            FBX24: 'FBX24 欧洲 → 南美东海岸',
            FBX26: 'FBX26 欧洲 → 南美西海岸'
        };

        const cachedWci = loadCachedData(CACHE_KEYS.wci);
        if (cachedWci) {
            wciData = cachedWci;
            renderWciStatus();
        }
        const cachedFbx = loadCachedData(CACHE_KEYS.fbx);
        if (cachedFbx) {
            fbxData = cachedFbx;
            renderFbxStatus();
        }

        /**
         * 更新AI分析模块可见性
         * @param {boolean} hasPortSelection - 是否有港口或共舱船公司选择
         */
        function updateAiAnalysis(hasPortSelection) {
            const aiAnalysisContainer = document.getElementById('aiAnalysisContainer');
            const emptyAiMessage = document.getElementById('emptyAiMessage');
            const aiConfigSection = document.getElementById('aiConfigSection');
            
            if (!aiAnalysisContainer) return;
            
            aiAnalysisContainer.style.display = 'block';
            
            if (!hasPortSelection || !latestFilteredRecords || latestFilteredRecords.length === 0) {
                if (emptyAiMessage) emptyAiMessage.style.display = 'block';
                if (aiConfigSection) aiConfigSection.style.display = 'none';
                return;
            }
            
            if (emptyAiMessage) emptyAiMessage.style.display = 'none';
            if (aiConfigSection) aiConfigSection.style.display = 'block';
            loadAiConfigs();
            setActiveAiPanel(activeAiProvider);
        }

        async function runAiAnalysis(providerId = 'deepseek') {
            await executeAiAnalysis(
                providerId,
                aiProviders,
                buildAiPrompt,
                baseSystemPrompt,
                {
                    beforeAnalysis: async () => {
                        // 分析前获取数据
                        await Promise.allSettled([
                            fetchBunkerData(false),
                            fetchWciData(false),
                            fetchFbxData(false)
                        ]);
                    }
                }
            );
        }
        
        window.runAiAnalysis = runAiAnalysis;

        function buildAiPrompt() {
            if (!Array.isArray(latestFilteredRecords)) {
                showError(ErrorType.DATA_VALIDATION, 'NO_DATA', { message: 'latestFilteredRecords is not an array' });
                return null;
            }
            
            const filteredRecords = latestFilteredRecords;
            if (!filteredRecords.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_DATA');
                return null;
            }
            
            const analysisGroups = groupedTableData.length ? groupedTableData : groupRecords(filteredRecords).data;
            if (!analysisGroups.length) {
                showError(ErrorType.DATA_VALIDATION, 'NO_ROUTE_DATA');
                return null;
            }

            const prepared = prepareAnalysisData(analysisGroups, weekColumns, showError, ErrorType);
            if (!prepared) return null;
            const { analysisData, weeklySummary, analysisWeekCodes, analysisWeekLabels } = prepared;

            const originPortSummary = destinationFilters.originPorts.length
                ? destinationFilters.originPorts.join('、')
                : '全部起运港';
            const destPortSummary = destinationFilters.destPorts.length
                ? destinationFilters.destPorts.join('、')
                : '全部目的港';
            const destinationSummary = `${originPortSummary} / ${destPortSummary}`;

            let prompt = buildDataOverview(destinationSummary, analysisData.length, analysisWeekCodes, analysisWeekLabels, weeklySummary);
            prompt += buildDetailedData001(analysisData, analysisWeekCodes, analysisWeekLabels);
            prompt += buildBookingDataSection(getBookingDataLocal());
            
            if (
                typeof marketData !== 'undefined' &&
                Array.isArray(marketData) &&
                marketData.length > 0 &&
                typeof marketSelectedPorts !== 'undefined' &&
                marketSelectedPorts &&
                marketSelectedPorts.length > 0
            ) {
                prompt += `\n【运费走势图模块数据（网页顶部）】
以下数据来自运费走势图模块，展示历史价格趋势，用于综合判断市场方向：
`;
                const { portCol, dateCol } = marketColumnConfig;

                marketSelectedPorts.forEach(port => {
                    const rows = marketData.filter(row => String(row[portCol] || '').trim() === port);
                    if (rows.length === 0) return;

                    rows.sort((a, b) => {
                        const dateA = marketParseDate(a[dateCol]);
                        const dateB = marketParseDate(b[dateCol]);
                        if (dateA && dateB) return dateA - dateB;
                        return 0;
                    });

                    const prices = rows.map(row => {
                        const date = dateCol ? marketParseDate(row[dateCol]) : null;
                        const dateStr = date ? `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}` : (row[dateCol] || '');
                        const gp20 = row['20GP'] || row['20gp'] || row['GP20'];
                        const gp40 = row['40GP'] || row['40gp'] || row['GP40'];
                        return { date: dateStr, gp20: gp20 ? parseFloat(gp20) : null, gp40: gp40 ? parseFloat(gp40) : null };
                    }).filter(p => p.gp20 !== null || p.gp40 !== null);

                    if (prices.length > 0) {
                        const recentPrices = prices.slice(-8);
                        const firstPrice = recentPrices[0];
                        const lastPrice = recentPrices[recentPrices.length - 1];
                        const gp20Trend = firstPrice.gp20 && lastPrice.gp20 ? (lastPrice.gp20 > firstPrice.gp20 ? '上涨' : lastPrice.gp20 < firstPrice.gp20 ? '下跌' : '持平') : '数据不足';
                        const gp40Trend = firstPrice.gp40 && lastPrice.gp40 ? (lastPrice.gp40 > firstPrice.gp40 ? '上涨' : lastPrice.gp40 < firstPrice.gp40 ? '下跌' : '持平') : '数据不足';

                        // 使用格式化后的港口名称显示
                        const portDisplay = getFormattedPortName(port);
                        prompt += `\n港口：${portDisplay}
  - 数据点数量：${prices.length}个
  - 20GP 趋势：${gp20Trend}（${firstPrice.gp20 ? firstPrice.gp20.toLocaleString() : 'N/A'} → ${lastPrice.gp20 ? lastPrice.gp20.toLocaleString() : 'N/A'}）
  - 40GP 趋势：${gp40Trend}（${firstPrice.gp40 ? firstPrice.gp40.toLocaleString() : 'N/A'} → ${lastPrice.gp40 ? lastPrice.gp40.toLocaleString() : 'N/A'}）
  - 最近价格：20GP ${lastPrice.gp20 ? lastPrice.gp20.toLocaleString() : 'N/A'} USD, 40GP ${lastPrice.gp40 ? lastPrice.gp40.toLocaleString() : 'N/A'} USD（${lastPrice.date}）
`;
                    }
                });
                prompt += `\n注：以上运费走势图数据需与用户填写的现行报价、极端报价以及 SCFI/WCI/FBX 指数进行交叉验证，判断市场方向的一致性。若趋势不一致，需解释成因（如指数滞后、区域结构差异）。\n`;
            }

            prompt += buildMarketReportsSection(marketReports);
            prompt += buildBunkerDataSection(bunkerData);
            prompt += buildWciDataSection(wciData);
            prompt += buildFbxDataSection(fbxData);
            prompt += buildScfiDataSection(marketReports);

            prompt += aiInstructionTemplate;
            return prompt;
        }


        function getBookingDataLocal() {
            return window.getBookingData ? window.getBookingData('bookingDataBody') : [];
        }

        /**
         * 显示模块选择对话框
         */
        function showModuleSelectionDialog() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'module-selection-overlay';

                const dialog = document.createElement('div');
                dialog.className = 'module-selection-dialog';

                dialog.innerHTML = `
                    <h2>选择要导出的模块</h2>
                    <div class="module-selection-options">
                        <label class="module-selection-label">
                            <input type="radio" name="moduleSelect" value="marketModule">
                            <div class="module-selection-content">
                                <div class="module-selection-title">Module 01 · 运费走势图</div>
                                <div class="module-selection-desc">包含区域筛选、港口筛选和运费趋势图表</div>
                            </div>
                        </label>
                        <label class="module-selection-label">
                            <input type="radio" name="moduleSelect" value="capacityModule">
                            <div class="module-selection-content">
                                <div class="module-selection-title">Module 02 · 航线运力分析</div>
                                <div class="module-selection-desc">包含港口筛选、运力表格和趋势图表</div>
                            </div>
                        </label>
                        <label class="module-selection-label">
                            <input type="radio" name="moduleSelect" value="aiModule">
                            <div class="module-selection-content">
                                <div class="module-selection-title">Module 03 · AI 趋势分析</div>
                                <div class="module-selection-desc">包含AI分析结果和配置信息</div>
                            </div>
                        </label>
                        <label class="module-selection-label">
                            <input type="radio" name="moduleSelect" value="all">
                            <div class="module-selection-content">
                                <div class="module-selection-title">Market Watch · 市场观察 全部导出</div>
                                <div class="module-selection-desc">导出 Module 01、Module 02 和 Module 03 三个模块</div>
                            </div>
                        </label>
                    </div>
                    <div class="module-selection-actions">
                        <button id="cancelExportBtn" class="btn-sweep-orange">取消</button>
                        <button id="confirmExportBtn" class="btn-sweep-blue">导出</button>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                const labels = dialog.querySelectorAll('.module-selection-label');
                const radios = dialog.querySelectorAll('input[type="radio"][name="moduleSelect"]');
                
                const updateLabelStyles = () => {
                    labels.forEach((label, index) => {
                        const radio = label.querySelector('input[type="radio"]');
                        if (radio && radio.checked) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                    });
                };

                radios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        updateLabelStyles();
                    });
                });
                
                labels.forEach(label => {
                    label.addEventListener('click', (e) => {
                        const radio = label.querySelector('input[type="radio"]');
                        if (radio && e.target !== radio) {
                            // 如果点击的不是radio本身，手动选中它
                            radio.checked = true;
                            // 手动触发change事件，确保其他radio取消选中并更新样式
                            radio.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                });

                // 确认按钮
                const confirmBtn = dialog.querySelector('#confirmExportBtn');
                confirmBtn.addEventListener('click', () => {
                    const selected = dialog.querySelector('input[name="moduleSelect"]:checked');
                    if (selected) {
                        document.body.removeChild(overlay);
                        resolve(selected.value);
                    } else {
                        // 提示选择模块
                        if (typeof showError === 'function' && typeof ErrorType !== 'undefined') {
                            showError(ErrorType.USER_ACTION, 'MODULE_NOT_SELECTED', { 
                                message: '请选择一个要导出的模块' 
                            });
                        } else {
                            alert('请选择一个要导出的模块');
                        }
                    }
                });

                // 取消按钮
                const cancelBtn = dialog.querySelector('#cancelExportBtn');
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(null);
                });

                // 点击遮罩关闭
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve(null);
                    }
                });

                // 默认选中第一个模块
                const firstRadio = dialog.querySelector('input[type="radio"][value="marketModule"]');
                if (firstRadio) {
                    firstRadio.checked = true;
                    // 触发change事件，确保样式更新
                    firstRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    updateLabelStyles();
                }
            });
        }

        /**
         * 导出指定模块为 PDF
         * @param {string} moduleId - 模块ID ('marketModule', 'capacityModule' 或 'aiModule')
         */
        async function exportModuleToPdf(moduleId) {
            // 获取模块名称
            const moduleNames = {
                'marketModule': 'Module01-运费走势图',
                'capacityModule': 'Module02-航线运力分析',
                'aiModule': 'Module03-AI趋势分析'
            };
            const moduleName = moduleNames[moduleId] || '模块';

            // 生成文件名
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fileName = `市场观察报告_${moduleName}_${year}${month}${day}`;

            // 获取要导出的模块元素
            const moduleSection = document.getElementById(moduleId);
            if (!moduleSection) {
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: `找不到模块: ${moduleId}` 
                });
                return;
            }

            // 确定图表 canvas ID
            let chartCanvasId = null;
            if (moduleId === 'marketModule') {
                chartCanvasId = 'marketTrendChart';
            } else if (moduleId === 'capacityModule') {
                chartCanvasId = 'trendChart';
            }

            // 直接使用公共导出函数
            if (typeof window.exportToPdfCommon !== 'function') {
                debugError('exportToPdfCommon 函数未找到，请确保 vendor/pdf-utils.js 已加载');
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: 'PDF 导出功能所需的工具函数未找到，请刷新页面重试' 
                });
                return;
            }

            await window.exportToPdfCommon({
                fileName,
                elements: moduleSection,
                chartCanvasId: chartCanvasId
            });
        }

        /**
         * 导出全部模块为 PDF（Module 01 + Module 02 + Module 03）
         */
        async function exportAllModulesToPdf() {
            // 生成文件名
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fileName = `市场观察报告_全部模块_${year}${month}${day}`;

            // 获取三个模块
            const marketModule = document.getElementById('marketModule');
            const capacityModule = document.getElementById('capacityModule');
            const aiModule = document.getElementById('aiModule');

            if (!marketModule || !capacityModule || !aiModule) {
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: '找不到要导出的模块' 
                });
                return;
            }

            // 直接使用公共导出函数
            if (typeof window.exportToPdfCommon !== 'function') {
                debugError('exportToPdfCommon 函数未找到，请确保 vendor/pdf-utils.js 已加载');
                showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: 'PDF 导出功能所需的工具函数未找到，请刷新页面重试' 
                });
                return;
            }

            await window.exportToPdfCommon({
                fileName,
                elements: [marketModule, capacityModule, aiModule],
                chartCanvasIds: ['marketTrendChart', 'trendChart'] // 两个图表都要处理
            });
        }

        /**
         * 导出PDF主函数（带模块选择对话框）
         */
        async function exportPageToPdf() {
            const selectedModule = await showModuleSelectionDialog();
            if (selectedModule) {
                if (selectedModule === 'all') {
                    await exportAllModulesToPdf();
                } else {
                    await exportModuleToPdf(selectedModule);
                }
            }
        }

        document.getElementById('exportPdfBtn')?.addEventListener('click', exportPageToPdf);
        window.addEventListener('load', () => {
            // 预加载PDF导出库（在后台加载，不阻塞页面）
            if (typeof window.loadPdfLibraries === 'function') {
                window.loadPdfLibraries().catch(error => {
                    debugWarn('PDF库预加载失败（不影响使用，导出时会重试）:', error);
                });
            }
            if (typeof window.generateMarketDataInfoBlocks === 'function') {
                const marketDataContainer = document.getElementById('marketDataInfoBlocksContainer');
                if (marketDataContainer) {
                    marketDataContainer.innerHTML = window.generateMarketDataInfoBlocks();
                    }
            }
            
            // 重新获取状态元素引用（模板生成后）
            bunkerStatusEl = document.getElementById('bunkerStatus');
            bunkerUpdatedEl = document.getElementById('bunkerUpdated');
            wciStatusEl = document.getElementById('wciStatus');
            wciUpdatedEl = document.getElementById('wciUpdated');
            fbxStatusEl = document.getElementById('fbxStatus');
            fbxUpdatedEl = document.getElementById('fbxUpdated');
            
            if (typeof window.initMarketAnalysisPage === 'function') {
                window.initMarketAnalysisPage({
                    updateAiAnalysis,
                    fetchBunkerData,
                    fetchWciData,
                    fetchFbxData,
                    bunkerStatusEl,
                    bunkerUpdatedEl,
                    wciStatusEl,
                    fbxStatusEl
                });
                
                if (typeof window.initAiModule === 'function') {
                    setActiveAiPanelBound = window.initAiModule(aiProviders);
                    // 设置默认激活的提供商
                    if (setActiveAiPanelBound) {
                        setActiveAiPanelBound(activeAiProvider);
                    }
                }
            } else {
                if (typeof window.generateBookingDataTable === 'function') {
                    const container = document.getElementById('bookingDataTableContainer');
                    if (container) {
                        container.innerHTML = window.generateBookingDataTable();
                    }
                }
                if (typeof window.generateAiConfigPanels === 'function') {
                    const aiContainer = document.getElementById('aiConfigPanelsContainer');
                    if (aiContainer) {
                        aiContainer.innerHTML = window.generateAiConfigPanels();
                    }
                }
                
                if (typeof window.initAiModule === 'function') {
                    setActiveAiPanelBound = window.initAiModule(aiProviders);
                    if (setActiveAiPanelBound) {
                        setActiveAiPanelBound(activeAiProvider);
                    }
                }
                
                updateAiAnalysis(false);
            Promise.allSettled([
                fetchBunkerData(false),
                fetchWciData(false),
                fetchFbxData(false)
            ]);
            }
        });

    </script>
</body>
</html>
