<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin · 健身记录面板</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/auth-gist.js"></script>
  </head>
  <body data-page="Admin-Workouts.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>Admin · 健身记录面板</h2>
                            <p>可视化您的苹果健身记录数据，追踪运动距离和时间趋势</p>
                        </div>
                        <div class="section-intro-actions">
                            <button type="button" class="tool-link" id="exportPdfBtn" aria-label="导出PDF">导出PDF</button>
                            <a href="dashboard.html?tab=admin" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="Admin-Workouts-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 文件上传和数据状态区域 -->
                <div class="grid-2-col" style="margin-bottom: 0;">
                    <!-- 左侧：载入 CSV -->
                    <div class="card-white">
                        <label for="fileInput" class="file-upload-label" aria-label="选择CSV文件上传">
                            <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradCsv)" />
                                <!-- CSV图标 -->
                                <rect x="8" y="8" width="20" height="20" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                <line x1="8" y1="14" x2="28" y2="14" stroke="#fff" stroke-width="1.5"/>
                                <line x1="8" y1="20" x2="28" y2="20" stroke="#fff" stroke-width="1.5"/>
                                <line x1="8" y1="26" x2="20" y2="26" stroke="#fff" stroke-width="1.5"/>
                                <!-- 向下箭头 -->
                                <path d="M18 22L22 26L14 26Z" fill="#fff"/>
                                <defs>
                                    <linearGradient id="gradCsv" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#0071e3" />
                                        <stop offset="1" stop-color="#54a4ff" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="file-upload-content">
                                <div class="file-upload-title">载入 CSV</div>
                                <div class="file-upload-desc">支持 .csv，数据仅在本地浏览器解析</div>
                            </div>
                            <input type="file" id="fileInput" class="file-upload-input" accept=".csv" aria-label="选择CSV文件" title="选择CSV文件：支持苹果健身记录导出的 CSV 格式">
                        </label>
                    </div>
                    
                    <!-- 右侧：数据状态 -->
                    <div class="card-white">
                        <div class="data-status-container">
                            <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradStatus)" />
                                <!-- 数据状态图标：剪贴板 + 勾 -->
                                <rect x="11" y="10" width="14" height="16" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                <rect x="15" y="8" width="6" height="4" rx="1" fill="#fff"/>
                                <path d="M14 18L17 21L23 15" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                <defs>
                                    <linearGradient id="gradStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#FF8A00" />
                                        <stop offset="1" stop-color="#FFB347" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="data-status-content">
                                <div class="data-status-title">数据状态</div>
                                <div id="statusInfo" class="data-status-text" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">尚未载入数据</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 健身记录趋势图表 -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">图表分析</span>
                        <div>
                            <h2 class="section-title">健身记录趋势 <span>WORKOUT TREND</span></h2>
                            <p class="module-desc">可视化运动距离和时间趋势，支持日/月/年视图切换</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" id="chartSection">
                        <div class="view-controls">
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: var(--color-text-primary);">健身记录趋势</h3>
                            </div>
                            <button class="view-btn" data-view="day">日视图</button>
                            <button class="view-btn active" data-view="month">月视图</button>
                            <button class="view-btn" data-view="year">年视图</button>
                        </div>

                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>

                        <div class="legend-container" id="legendContainer"></div>
                    </div>
                </section>

                <!-- 深度分析 -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">深度分析</span>
                        <div>
                            <h2 class="section-title">运动数据分析 <span>DETAILED ANALYSIS</span></h2>
                            <p class="module-desc">平均速度、每周统计、运动频率和强度分析</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" id="analysisSection">
                        <div class="view-controls">
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: var(--color-text-primary);">深度分析</h3>
                            </div>
                        </div>

                        <!-- 分析选项卡 -->
                        <div class="controls" style="margin-bottom: 20px; border-bottom: 2px solid var(--color-border); padding-bottom: 12px;">
                            <button class="view-btn analysis-tab active" data-analysis="speed">平均速度</button>
                            <button class="view-btn analysis-tab" data-analysis="week">每周统计</button>
                            <button class="view-btn analysis-tab" data-analysis="frequency">运动频率</button>
                            <button class="view-btn analysis-tab" data-analysis="intensity">强度分析</button>
                        </div>

                        <!-- 平均速度分析 -->
                        <div class="analysis-panel" id="speedAnalysis" style="display: block;">
                            <h4 style="margin-bottom: 15px; color: var(--color-text-primary);">平均速度趋势（米/秒）</h4>
                            <div class="chart-container" style="height: 600px;">
                                <canvas id="speedChart"></canvas>
                            </div>
                        </div>

                        <!-- 每周统计分析 -->
                        <div class="analysis-panel" id="weekAnalysis" style="display: none;">
                            <h4 style="margin-bottom: 15px; color: var(--color-text-primary);">每周统计（距离、时间、平均速度）</h4>
                            <div class="chart-container" style="height: 600px;">
                                <canvas id="weekChart"></canvas>
                            </div>
                        </div>

                        <!-- 运动频率分析 -->
                        <div class="analysis-panel" id="frequencyAnalysis" style="display: none;">
                            <h4 style="margin-bottom: 15px; color: var(--color-text-primary);">运动频率（每周运动天数）</h4>
                            <div class="chart-container" style="height: 600px;">
                                <canvas id="frequencyChart"></canvas>
                            </div>
                        </div>

                        <!-- 强度分析 -->
                        <div class="analysis-panel" id="intensityAnalysis" style="display: none;">
                            <h4 style="margin-bottom: 15px; color: var(--color-text-primary);">运动强度分析（心率区间分布）</h4>
                            <div class="chart-container" style="height: 600px;">
                                <canvas id="intensityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">Admin · 健身记录面板使用声明</h2>
                    <p class="usage-statement-text">本工具用于可视化您的苹果健身记录数据，解析结果仅供个人使用，帮助您追踪运动距离和时间趋势。</p>
                    <p class="usage-statement-text">所有数据仅在本地浏览器解析，不会上传至任何服务器，请放心使用。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/sidebar-loader.js"></script>
    <script>
        init001ToolPage('Admin-Workouts.html', 'admin');
    </script>
    <script>
      (function() {
        'use strict';

        // 错误处理已统一到 vendor/error-handler.js
        // ErrorType 和 showError 函数已从 error-handler.js 加载

        const fileInput = document.getElementById('fileInput');
        const statusInfo = document.getElementById('statusInfo');
        const chartSection = document.getElementById('chartSection');
        const analysisSection = document.getElementById('analysisSection');
        const legendContainer = document.getElementById('legendContainer');
        const viewButtons = document.querySelectorAll('.view-btn[data-view]');
        const analysisTabs = document.querySelectorAll('.analysis-tab');

        let workoutData = [];
        let workoutChart = null;
        let speedChart = null;
        let weekChart = null;
        let frequencyChart = null;
        let intensityChart = null;
        let currentView = 'month'; // 'day', 'month', 'year' - 默认月视图
        let currentAnalysis = 'speed'; // 'speed', 'week', 'frequency', 'intensity'

        /**
         * 从日期字符串中提取 YYYY-MM-DD 格式的日期
         * @param {string} dateStr - 日期字符串，格式如 "2022-12-07 14:11:52 - 2022-12-07 14:25:17"
         * @returns {string} YYYY-MM-DD 格式的日期
         */
        function extractDate(dateStr) {
          if (!dateStr) return '';
          // 提取前面的日期部分（YYYY-MM-DD）
          const match = String(dateStr).match(/^(\d{4}-\d{2}-\d{2})/);
          return match ? match[1] : '';
        }

        /**
         * 将秒数转换为分:秒格式
         * @param {number} seconds - 秒数
         * @returns {string} 分:秒格式，如 "12:34"
         */
        function formatDuration(seconds) {
          if (!seconds || isNaN(seconds)) return '0:00';
          const totalSeconds = Math.round(Number(seconds));
          const mins = Math.floor(totalSeconds / 60);
          const secs = totalSeconds % 60;
          return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        /**
         * 将分:秒格式转换为秒数（用于图表显示）
         * @param {string} durationStr - 分:秒格式，如 "12:34"
         * @returns {number} 总秒数
         */
        function parseDurationToSeconds(durationStr) {
          if (!durationStr) return 0;
          const parts = String(durationStr).split(':');
          if (parts.length !== 2) return 0;
          const mins = parseInt(parts[0], 10) || 0;
          const secs = parseInt(parts[1], 10) || 0;
          return mins * 60 + secs;
        }

        /**
         * 解析 CSV 行（处理引号和逗号）
         * @param {string} line - CSV 行文本
         * @returns {Array} 解析后的值数组
         */
        function parseCSVLine(line) {
          const values = [];
          let current = '';
          let inQuotes = false;
          
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            
            if (char === '"') {
              if (inQuotes && nextChar === '"') {
                // 转义的引号
                current += '"';
                i++; // 跳过下一个引号
              } else {
                // 切换引号状态
                inQuotes = !inQuotes;
              }
            } else if (char === ',' && !inQuotes) {
              // 字段分隔符
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          
          // 添加最后一个字段
          values.push(current.trim());
          
          return values;
        }

        /**
         * 解析 CSV 文件
         * @param {string} csvText - CSV 文本内容
         * @returns {Array} 解析后的数据数组
         */
        function parseCSV(csvText) {
          const lines = csvText.split(/\r?\n/).filter(line => line.trim());
          if (lines.length < 2) {
            throw new Error('CSV 文件格式不正确，至少需要标题行和一行数据');
          }

          // 解析标题行
          const headers = parseCSVLine(lines[0]);
          const dateIndex = headers.findIndex(h => h.toLowerCase().includes('date'));
          // Distance列：查找包含"distance"和"km"的列
          let distanceIndex = headers.findIndex(h => {
            const lower = h.toLowerCase();
            return lower.includes('distance') && lower.includes('km');
          });
          // 如果找不到，尝试只包含"distance"的列
          if (distanceIndex === -1) {
            distanceIndex = headers.findIndex(h => h.toLowerCase().includes('distance'));
          }
          // Duration列：查找包含"duration"和"s"的列
          let durationIndex = headers.findIndex(h => {
            const lower = h.toLowerCase();
            return lower.includes('duration') && lower.includes('s');
          });
          // 如果找不到，尝试只包含"duration"的列
          if (durationIndex === -1) {
            durationIndex = headers.findIndex(h => h.toLowerCase().includes('duration'));
          }

          // 心率区间列（M列，索引12，或查找包含"Heart rate zone"的列）
          const heartRateZoneIndices = {
            'A': -1, // Easy (<115bpm)(%)
            'B': -1, // Fat Burn (115-135bpm)(%)
            'C': -1, // Moderate Training (135-155bpm)(%)
            'D': -1, // Hard Training (155-175bpm)(%)
            'E': -1  // Extreme Training (>175bpm)(%)
          };

          // 查找心率区间列（精确匹配列名模式）
          headers.forEach((header, index) => {
            const lower = header.toLowerCase();
            if (lower.includes('heart rate zone')) {
              // A Easy (<115bpm)(%)
              if ((lower.includes('a') || lower.includes('easy')) && (lower.includes('<115') || lower.includes('115bpm'))) {
                heartRateZoneIndices['A'] = index;
              }
              // B Fat Burn (115-135bpm)(%)
              else if ((lower.includes('b') || lower.includes('fat burn')) && (lower.includes('115') && lower.includes('135'))) {
                heartRateZoneIndices['B'] = index;
              }
              // C Moderate Training (135-155bpm)(%)
              else if ((lower.includes('c') || lower.includes('moderate')) && (lower.includes('135') && lower.includes('155'))) {
                heartRateZoneIndices['C'] = index;
              }
              // D Hard Training (155-175bpm)(%)
              else if ((lower.includes('d') || lower.includes('hard')) && (lower.includes('155') && lower.includes('175'))) {
                heartRateZoneIndices['D'] = index;
              }
              // E Extreme Training (>175bpm)(%)
              else if ((lower.includes('e') || lower.includes('extreme')) && (lower.includes('>175') || lower.includes('175bpm'))) {
                heartRateZoneIndices['E'] = index;
              }
            }
          });

          // 如果通过关键词找不到，尝试使用M列（索引12）及后续列
          // 假设M列（索引12）开始是心率区间数据，按顺序A、B、C、D、E
          if (heartRateZoneIndices['A'] === -1 && headers.length > 16) {
            // M列是索引12，假设从M列开始是心率区间
            heartRateZoneIndices['A'] = 12;
            heartRateZoneIndices['B'] = 13;
            heartRateZoneIndices['C'] = 14;
            heartRateZoneIndices['D'] = 15;
            heartRateZoneIndices['E'] = 16;
          }

          if (dateIndex === -1 || distanceIndex === -1 || durationIndex === -1) {
            throw new Error(`CSV 文件缺少必要的列：Date(${dateIndex}), Distance(${distanceIndex}), Duration(${durationIndex})`);
          }

          // 解析数据行
          const data = [];
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const values = parseCSVLine(line);

            if (values.length < Math.max(dateIndex, distanceIndex, durationIndex) + 1) {
              continue; // 跳过不完整的行
            }

            const dateStr = extractDate(values[dateIndex] || '');
            if (!dateStr) continue; // 跳过没有有效日期的行

            const distanceKm = parseFloat(values[distanceIndex] || '0') || 0;
            const distanceM = Math.round(distanceKm * 1000); // 转换为米

            const durationSeconds = parseFloat(values[durationIndex] || '0') || 0;
            const durationFormatted = formatDuration(durationSeconds);

            // 解析日期
            const dateParts = dateStr.split('-');
            const date = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));

            if (isNaN(date.getTime())) {
              continue; // 跳过无效日期
            }

            // 解析心率区间占比
            const heartRateZones = {
              'A': 0, // Easy (<115bpm)(%)
              'B': 0, // Fat Burn (115-135bpm)(%)
              'C': 0, // Moderate Training (135-155bpm)(%)
              'D': 0, // Hard Training (155-175bpm)(%)
              'E': 0  // Extreme Training (>175bpm)(%)
            };

            // 读取心率区间数据
            Object.keys(heartRateZones).forEach(zone => {
              const index = heartRateZoneIndices[zone];
              if (index !== -1 && index < values.length) {
                const value = parseFloat(values[index] || '0') || 0;
                heartRateZones[zone] = value;
              }
            });

            data.push({
              date: date,
              dateStr: dateStr,
              distance: distanceM, // 米
              duration: durationSeconds, // 秒（用于计算）
              durationFormatted: durationFormatted, // 分:秒格式（用于显示）
              heartRateZones: heartRateZones // 心率区间占比
            });
          }

          // 按日期排序
          data.sort((a, b) => a.date.getTime() - b.date.getTime());

          return data;
        }

        /**
         * 按视图类型聚合数据
         * @param {Array} data - 原始数据
         * @param {string} viewType - 视图类型：'day', 'month', 'year'
         * @returns {Array} 聚合后的数据
         */
        function aggregateData(data, viewType) {
          if (viewType === 'day') {
            // 日视图：按日期聚合（同一天的数据累加）
            const dayMap = new Map();
            data.forEach(item => {
              const key = item.dateStr;
              if (!dayMap.has(key)) {
                dayMap.set(key, {
                  date: item.date,
                  dateStr: item.dateStr,
                  label: item.dateStr,
                  distance: 0,
                  duration: 0,
                  heartRateZones: { 'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0 },
                  heartRateCount: 0 // 记录有心率数据的记录数
                });
              }
              const entry = dayMap.get(key);
              entry.distance += item.distance;
              entry.duration += item.duration;
              if (item.heartRateZones) {
                Object.keys(item.heartRateZones).forEach(zone => {
                  entry.heartRateZones[zone] += item.heartRateZones[zone] || 0;
                });
                entry.heartRateCount++;
              }
            });
            return Array.from(dayMap.values()).map(item => ({
              ...item,
              durationFormatted: formatDuration(item.duration),
              // 计算平均心率区间占比
              avgHeartRateZones: item.heartRateCount > 0 ? {
                'A': item.heartRateZones['A'] / item.heartRateCount,
                'B': item.heartRateZones['B'] / item.heartRateCount,
                'C': item.heartRateZones['C'] / item.heartRateCount,
                'D': item.heartRateZones['D'] / item.heartRateCount,
                'E': item.heartRateZones['E'] / item.heartRateCount
              } : null
            }));
          } else if (viewType === 'month') {
            // 月视图：按年月聚合
            const monthMap = new Map();
            data.forEach(item => {
              const year = item.date.getFullYear();
              const month = item.date.getMonth() + 1;
              const key = `${year}-${String(month).padStart(2, '0')}`;
              const label = `${year}/${String(month).padStart(2, '0')}`;
              
              if (!monthMap.has(key)) {
                monthMap.set(key, {
                  date: new Date(year, month - 1, 1),
                  dateStr: key,
                  label: label,
                  distance: 0,
                  duration: 0,
                  heartRateZones: { 'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0 },
                  heartRateCount: 0
                });
              }
              const entry = monthMap.get(key);
              entry.distance += item.distance;
              entry.duration += item.duration;
              if (item.heartRateZones) {
                Object.keys(item.heartRateZones).forEach(zone => {
                  entry.heartRateZones[zone] += item.heartRateZones[zone] || 0;
                });
                entry.heartRateCount++;
              }
            });
            return Array.from(monthMap.values())
              .sort((a, b) => a.date.getTime() - b.date.getTime())
              .map(item => ({
                ...item,
                durationFormatted: formatDuration(item.duration),
                avgHeartRateZones: item.heartRateCount > 0 ? {
                  'A': item.heartRateZones['A'] / item.heartRateCount,
                  'B': item.heartRateZones['B'] / item.heartRateCount,
                  'C': item.heartRateZones['C'] / item.heartRateCount,
                  'D': item.heartRateZones['D'] / item.heartRateCount,
                  'E': item.heartRateZones['E'] / item.heartRateCount
                } : null
              }));
          } else if (viewType === 'year') {
            // 年视图：按年聚合
            const yearMap = new Map();
            data.forEach(item => {
              const year = item.date.getFullYear();
              const key = String(year);
              
              if (!yearMap.has(key)) {
                yearMap.set(key, {
                  date: new Date(year, 0, 1),
                  dateStr: key,
                  label: key,
                  distance: 0,
                  duration: 0,
                  heartRateZones: { 'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0 },
                  heartRateCount: 0
                });
              }
              const entry = yearMap.get(key);
              entry.distance += item.distance;
              entry.duration += item.duration;
              if (item.heartRateZones) {
                Object.keys(item.heartRateZones).forEach(zone => {
                  entry.heartRateZones[zone] += item.heartRateZones[zone] || 0;
                });
                entry.heartRateCount++;
              }
            });
            return Array.from(yearMap.values())
              .sort((a, b) => a.date.getTime() - b.date.getTime())
              .map(item => ({
                ...item,
                durationFormatted: formatDuration(item.duration),
                avgHeartRateZones: item.heartRateCount > 0 ? {
                  'A': item.heartRateZones['A'] / item.heartRateCount,
                  'B': item.heartRateZones['B'] / item.heartRateCount,
                  'C': item.heartRateZones['C'] / item.heartRateCount,
                  'D': item.heartRateZones['D'] / item.heartRateCount,
                  'E': item.heartRateZones['E'] / item.heartRateCount
                } : null
              }));
          }
          return [];
        }

        /**
         * 更新图表
         */
        function updateChart() {
          if (!workoutData.length) return;

          const aggregatedData = aggregateData(workoutData, currentView);
          if (!aggregatedData.length) return;

          const labels = aggregatedData.map(item => item.label);
          const distanceData = aggregatedData.map(item => item.distance);
          const durationData = aggregatedData.map(item => item.duration); // 使用秒数用于图表

          // 销毁旧图表
          if (workoutChart) {
            workoutChart.destroy();
          }

          // 创建新图表（混合图表：柱状图+曲线图）
          const ctx = document.getElementById('trendChart').getContext('2d');
          workoutChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                {
                  label: '距离（米）',
                  data: distanceData,
                  type: 'bar',
                  backgroundColor: 'rgba(62, 98, 173, 0.6)',
                  borderColor: '#3E62AD',
                  borderWidth: 2,
                  yAxisID: 'y',
                  order: 2 // 柱状图在后面
                },
                {
                  label: '训练时间',
                  data: durationData,
                  type: 'line',
                  borderColor: '#FF8A00',
                  backgroundColor: 'rgba(255, 138, 0, 0.1)',
                  borderWidth: 3,
                  fill: false,
                  tension: 0.4,
                  yAxisID: 'y1',
                  order: 1, // 曲线图在前面
                  pointRadius: 4,
                  pointHoverRadius: 6
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false
              },
              plugins: {
                legend: {
                  display: false // 使用自定义图例
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    label: function(context) {
                      const datasetLabel = context.dataset.label || '';
                      const value = context.parsed.y;
                      if (datasetLabel.includes('距离')) {
                        return `${datasetLabel}: ${value.toLocaleString()} 米`;
                      } else if (datasetLabel.includes('时间')) {
                        const formatted = formatDuration(value);
                        return `${datasetLabel}: ${formatted} (${value} 秒)`;
                      }
                      return `${datasetLabel}: ${value}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: currentView === 'day' ? '日期' : currentView === 'month' ? '月份' : '年份'
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45
                  }
                },
                y: {
                  type: 'linear',
                  position: 'left',
                  title: {
                    display: true,
                    text: '距离（米）'
                  },
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + ' 米';
                    }
                  }
                },
                y1: {
                  type: 'linear',
                  position: 'right',
                  title: {
                    display: true,
                    text: '训练时间（秒）'
                  },
                  beginAtZero: true,
                  grid: {
                    drawOnChartArea: false
                  },
                  ticks: {
                    callback: function(value) {
                      return formatDuration(value);
                    }
                  }
                }
              }
            }
          });

          // 更新图例
          updateLegend();
        }

        /**
         * 更新图例
         */
        function updateLegend() {
          legendContainer.innerHTML = '';
          
          const legends = [
            { label: '距离（米）', color: '#3E62AD' },
            { label: '训练时间', color: '#FF8A00' }
          ];

          legends.forEach(legend => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `
              <div class="legend-color" style="background-color: ${legend.color};"></div>
              <span>${legend.label}</span>
            `;
            legendContainer.appendChild(legendItem);
          });
        }

        /**
         * 获取周数（ISO周）
         */
        function getWeekNumber(date) {
          const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
          const dayNum = d.getUTCDay() || 7;
          d.setUTCDate(d.getUTCDate() + 4 - dayNum);
          const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
          return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        /**
         * 按周聚合数据
         */
        function aggregateByWeek(data) {
          const weekMap = new Map();
          
          data.forEach(item => {
            const year = item.date.getFullYear();
            const week = getWeekNumber(item.date);
            const key = `${year}-W${String(week).padStart(2, '0')}`;
            const label = `${year}年第${week}周`;
            
            if (!weekMap.has(key)) {
              weekMap.set(key, {
                year: year,
                week: week,
                label: label,
                date: item.date,
                distance: 0,
                duration: 0,
                count: 0 // 记录该周的运动次数
              });
            }
            
            const entry = weekMap.get(key);
            entry.distance += item.distance;
            entry.duration += item.duration;
            entry.count += 1;
          });
          
          return Array.from(weekMap.values())
            .sort((a, b) => {
              if (a.year !== b.year) return a.year - b.year;
              return a.week - b.week;
            })
            .map(item => ({
              ...item,
              avgSpeed: item.duration > 0 ? (item.distance / item.duration) : 0, // 米/秒
              durationFormatted: formatDuration(item.duration)
            }));
        }

        /**
         * 更新所有分析图表
         */
        function updateAnalysisCharts() {
          if (!workoutData.length || typeof Chart === 'undefined') return;
          
          switch (currentAnalysis) {
            case 'speed':
              updateSpeedChart();
              break;
            case 'week':
              updateWeekChart();
              break;
            case 'frequency':
              updateFrequencyChart();
              break;
            case 'intensity':
              updateIntensityChart();
              break;
          }
        }

        /**
         * 更新平均速度趋势图
         */
        function updateSpeedChart() {
          const aggregatedData = aggregateData(workoutData, currentView);
          if (!aggregatedData.length) return;

          const labels = aggregatedData.map(item => item.label);
          const speedData = aggregatedData.map(item => {
            // 计算平均速度：米/秒
            return item.duration > 0 ? (item.distance / item.duration) : 0;
          });

          if (speedChart) {
            speedChart.destroy();
          }

          const ctx = document.getElementById('speedChart').getContext('2d');
          speedChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: '平均速度（米/秒）',
                data: speedData,
                borderColor: '#3E62AD',
                backgroundColor: 'rgba(62, 98, 173, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    label: function(context) {
                      const value = context.parsed.y;
                      const kmh = (value * 3.6).toFixed(2); // 转换为公里/小时
                      return `平均速度: ${value.toFixed(2)} 米/秒 (${kmh} 公里/小时)`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: currentView === 'day' ? '日期' : currentView === 'month' ? '月份' : '年份'
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: '平均速度（米/秒）'
                  },
                  beginAtZero: false,
                  ticks: {
                    callback: function(value) {
                      return value.toFixed(2) + ' m/s';
                    }
                  }
                }
              }
            }
          });
        }

        /**
         * 更新每周统计图
         */
        function updateWeekChart() {
          const weekData = aggregateByWeek(workoutData);
          if (!weekData.length) return;

          const labels = weekData.map(item => item.label);
          const distanceData = weekData.map(item => item.distance);
          const durationData = weekData.map(item => item.duration);
          const speedData = weekData.map(item => item.avgSpeed * 3.6); // 转换为公里/小时

          if (weekChart) {
            weekChart.destroy();
          }

          const ctx = document.getElementById('weekChart').getContext('2d');
          weekChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                {
                  label: '距离（米）',
                  data: distanceData,
                  type: 'bar',
                  backgroundColor: 'rgba(62, 98, 173, 0.6)',
                  borderColor: '#3E62AD',
                  borderWidth: 2,
                  yAxisID: 'y',
                  order: 3
                },
                {
                  label: '训练时间',
                  data: durationData,
                  type: 'line',
                  borderColor: '#FF8A00',
                  backgroundColor: 'rgba(255, 138, 0, 0.1)',
                  borderWidth: 3,
                  fill: false,
                  tension: 0.4,
                  yAxisID: 'y1',
                  order: 2,
                  pointRadius: 4
                },
                {
                  label: '平均速度（公里/小时）',
                  data: speedData,
                  type: 'line',
                  borderColor: '#3E62AD',
                  backgroundColor: 'rgba(62, 98, 173, 0.1)',
                  borderWidth: 3,
                  fill: false,
                  tension: 0.4,
                  yAxisID: 'y1', // 使用y1轴，但通过tooltip显示不同单位
                  order: 1,
                  pointRadius: 4
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    label: function(context) {
                      const datasetLabel = context.dataset.label || '';
                      const value = context.parsed.y;
                      if (datasetLabel.includes('距离')) {
                        return `${datasetLabel}: ${value.toLocaleString()} 米`;
                      } else if (datasetLabel.includes('时间')) {
                        return `${datasetLabel}: ${formatDuration(value)}`;
                      } else if (datasetLabel.includes('速度')) {
                        return `${datasetLabel}: ${value.toFixed(2)} 公里/小时`;
                      }
                      return `${datasetLabel}: ${value}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: '周数'
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45
                  }
                },
                y: {
                  type: 'linear',
                  position: 'left',
                  title: {
                    display: true,
                    text: '距离（米）'
                  },
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + ' 米';
                    }
                  }
                },
                y1: {
                  type: 'linear',
                  position: 'right',
                  title: {
                    display: true,
                    text: '时间/速度'
                  },
                  beginAtZero: true,
                  grid: {
                    drawOnChartArea: false
                  },
                  ticks: {
                    callback: function(value, index, ticks) {
                      // 根据数据范围判断是时间还是速度
                      const maxValue = Math.max(...durationData, ...speedData);
                      if (maxValue > 1000) {
                        // 应该是时间（秒）
                        return formatDuration(value);
                      } else {
                        // 应该是速度（公里/小时）
                        return value.toFixed(1) + ' km/h';
                      }
                    }
                  }
                }
              }
            }
          });
        }

        /**
         * 更新运动频率图（每周运动天数）
         */
        function updateFrequencyChart() {
          const weekData = aggregateByWeek(workoutData);
          if (!weekData.length) return;

          const labels = weekData.map(item => item.label);
          const frequencyData = weekData.map(item => item.count); // 每周运动次数

          if (frequencyChart) {
            frequencyChart.destroy();
          }

          const ctx = document.getElementById('frequencyChart').getContext('2d');
          frequencyChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: '每周运动次数',
                data: frequencyData,
                backgroundColor: 'rgba(255, 138, 0, 0.6)',
                borderColor: '#FF8A00',
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    label: function(context) {
                      return `运动次数: ${context.parsed.y} 次`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: '周数'
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: '运动次数'
                  },
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                    callback: function(value) {
                      return value + ' 次';
                    }
                  }
                }
              }
            }
          });
        }

        /**
         * 更新强度分析图（心率区间分布）
         */
        function updateIntensityChart() {
          if (!workoutData.length) return;

          // 聚合心率区间数据
          const aggregatedData = aggregateData(workoutData, currentView);
          if (!aggregatedData.length) return;

          // 累加所有记录的心率区间占比
          const heartRateZonesTotal = {
            'A': 0, // Easy (<115bpm)(%)
            'B': 0, // Fat Burn (115-135bpm)(%)
            'C': 0, // Moderate Training (135-155bpm)(%)
            'D': 0, // Hard Training (155-175bpm)(%)
            'E': 0  // Extreme Training (>175bpm)(%)
          };

          let validRecords = 0;
          workoutData.forEach(item => {
            if (item.heartRateZones) {
              Object.keys(heartRateZonesTotal).forEach(zone => {
                if (item.heartRateZones[zone] !== undefined) {
                  heartRateZonesTotal[zone] += item.heartRateZones[zone];
                }
              });
              validRecords++;
            }
          });

          // 如果没有心率数据，显示提示
          if (validRecords === 0) {
            const ctx = document.getElementById('intensityChart').getContext('2d');
            if (intensityChart) {
              intensityChart.destroy();
            }
            // 创建一个空图表显示提示信息
            intensityChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ['无心率数据'],
                datasets: [{
                  data: [1],
                  backgroundColor: ['#e9ecef']
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    enabled: false
                  }
                }
              }
            });
            return;
          }

          // 计算平均占比
          const heartRateZonesAvg = {};
          Object.keys(heartRateZonesTotal).forEach(zone => {
            heartRateZonesAvg[zone] = validRecords > 0 ? (heartRateZonesTotal[zone] / validRecords) : 0;
          });

          // 定义心率区间
          const heartRateZones = [
            { 
              label: 'A Easy (<115bpm)', 
              value: heartRateZonesAvg['A'], 
              color: '#86868B' 
            },
            { 
              label: 'B Fat Burn (115-135bpm)', 
              value: heartRateZonesAvg['B'], 
              color: '#5AC8FA' 
            },
            { 
              label: 'C Moderate Training (135-155bpm)', 
              value: heartRateZonesAvg['C'], 
              color: '#3E62AD' 
            },
            { 
              label: 'D Hard Training (155-175bpm)', 
              value: heartRateZonesAvg['D'], 
              color: '#FF8A00' 
            },
            { 
              label: 'E Extreme Training (>175bpm)', 
              value: heartRateZonesAvg['E'], 
              color: '#FF6B00' 
            }
          ];

          const zoneLabels = heartRateZones.map(z => z.label);
          const zoneValues = heartRateZones.map(z => z.value);
          const zoneColors = heartRateZones.map(z => z.color);

          if (intensityChart) {
            intensityChart.destroy();
          }

          const ctx = document.getElementById('intensityChart').getContext('2d');
          intensityChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: zoneLabels,
              datasets: [{
                data: zoneValues,
                backgroundColor: zoneColors,
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'right'
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const value = context.parsed;
                      const total = zoneValues.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${context.label}: ${value.toFixed(1)}% (占比 ${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
        }

        /**
         * 处理文件载入
         */
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          try {
            statusInfo.textContent = '解析中...';
            const statusDetail = document.getElementById('status-detail');
            if (statusDetail) statusDetail.style.display = 'none';
            
            const text = await file.text();
            const data = parseCSV(text);
            
            if (!data.length) {
              showError(ErrorType.FILE_LOAD, 'FILE_EMPTY');
              statusInfo.textContent = '文件为空';
              if (statusDetail) {
                statusDetail.textContent = '文件中没有有效数据';
                statusDetail.style.display = 'block';
              }
              return;
            }

            workoutData = data;
            statusInfo.textContent = `已加载 ${data.length} 条记录`;
            if (statusDetail) statusDetail.style.display = 'none';
            chartSection.classList.remove('hidden');
            analysisSection.classList.remove('hidden');
            updateChart();
            updateAnalysisCharts();
          } catch (error) {
            showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
            statusInfo.textContent = '解析失败';
            const statusDetail = document.getElementById('status-detail');
            if (statusDetail) {
              statusDetail.textContent = error.message || '文件读取失败';
              statusDetail.style.display = 'block';
            }
            debugError('读取文件失败:', error);
          }
        });

        /**
         * 视图切换
         */
        viewButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const view = btn.dataset.view;
            if (view === currentView) return;

            currentView = view;
            viewButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChart();
            updateAnalysisCharts(); // 更新分析图表
          });
        });

        /**
         * 分析选项卡切换
         */
        analysisTabs.forEach(btn => {
          btn.addEventListener('click', () => {
            const analysis = btn.dataset.analysis;
            if (analysis === currentAnalysis) return;

            currentAnalysis = analysis;
            analysisTabs.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // 隐藏所有分析面板
            document.querySelectorAll('.analysis-panel').forEach(panel => {
              panel.style.display = 'none';
            });
            
            // 显示当前分析面板
            const targetPanel = document.getElementById(analysis + 'Analysis');
            if (targetPanel) {
              targetPanel.style.display = 'block';
              updateAnalysisCharts();
            }
          });
        });

        /**
         * 导出整页 PDF（使用 vendor/pdf-utils.js）
         */
        async function exportPageToPdf() {
          const exportBtn = document.getElementById('exportPdfBtn');
          if (!exportBtn) return;
          
          // 在函数作用域顶部定义变量，确保catch块也能访问
          let chartMappings = [];
          let originalDisplayStates = {
            analysisSection: null,
            analysisPanels: []
          };
          let wrapper = null;
          
          try {
            exportBtn.disabled = true;
            exportBtn.textContent = '正在导出...';
            
            // 生成文件名：健身记录报告_年月日.pdf
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fileName = `健身记录报告_${year}${month}${day}`;
            
            // 等待一小段时间确保图表完全渲染
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 保存原始显示状态
            originalDisplayStates = {
              analysisSection: null,
              analysisPanels: []
            };
            
            // 只显示当前选中的分析面板
            const analysisSection = document.getElementById('analysisSection');
            if (analysisSection) {
              // 移除hidden类并设置display
              originalDisplayStates.analysisSection = {
                display: analysisSection.style.display,
                className: analysisSection.className
              };
              analysisSection.classList.remove('hidden');
              analysisSection.style.display = 'block';
              
              // 只显示当前选中的分析面板，隐藏其他面板
              const analysisPanels = analysisSection.querySelectorAll('.analysis-panel');
              analysisPanels.forEach(panel => {
                const panelId = panel.id;
                const isCurrentPanel = (
                  (currentAnalysis === 'speed' && panelId === 'speedAnalysis') ||
                  (currentAnalysis === 'week' && panelId === 'weekAnalysis') ||
                  (currentAnalysis === 'frequency' && panelId === 'frequencyAnalysis') ||
                  (currentAnalysis === 'intensity' && panelId === 'intensityAnalysis')
                );
                
                originalDisplayStates.analysisPanels.push({
                  element: panel,
                  display: panel.style.display
                });
                
                // 只显示当前选中的面板
                panel.style.display = isCurrentPanel ? 'block' : 'none';
              });
            }
            
            // 确保chartSection也是可见的
            const chartSection = document.getElementById('chartSection');
            if (chartSection && chartSection.classList.contains('hidden')) {
              chartSection.classList.remove('hidden');
              chartSection.style.display = 'block';
            }
            
            // 等待图表重新渲染
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // 转换所有图表为图片
            chartMappings = [];
            
            // 辅助函数：转换图表为图片
            function convertChartToImage(chart, canvasId) {
              if (!chart || !chart.canvas) return null;
              
              try {
                const originalCanvas = chart.canvas;
                const chartImage = chart.toBase64Image('image/png', 1.0);
                const chartImgElement = document.createElement('img');
                chartImgElement.src = chartImage;
                chartImgElement.alt = canvasId;
                chartImgElement.style.width = originalCanvas.offsetWidth + 'px';
                chartImgElement.style.height = originalCanvas.offsetHeight + 'px';
                chartImgElement.style.display = 'block';
                chartImgElement.style.visibility = 'visible';
                chartImgElement.style.opacity = '1';
                chartImgElement.style.position = 'relative';
                chartImgElement.style.margin = '0';
                chartImgElement.style.padding = '0';
                chartImgElement.id = canvasId + '_img';
                chartImgElement.setAttribute('data-chart-id', canvasId);
                
                // 插入到canvas之前
                originalCanvas.parentNode.insertBefore(chartImgElement, originalCanvas);
                originalCanvas.style.display = 'none';
                originalCanvas.style.visibility = 'hidden';
                
                return { originalCanvas, chartImgElement, canvasId };
              } catch (error) {
                debugError(`转换${canvasId}为图片失败:`, error);
                return null;
              }
            }
            
            // 主趋势图
            const mainChartMapping = convertChartToImage(workoutChart, 'trendChart');
            if (mainChartMapping) {
              chartMappings.push(mainChartMapping);
            }
            
            // 只转换当前选中的深度分析图表
            const analysisChartMap = {
              'speed': { chart: speedChart, canvasId: 'speedChart' },
              'week': { chart: weekChart, canvasId: 'weekChart' },
              'frequency': { chart: frequencyChart, canvasId: 'frequencyChart' },
              'intensity': { chart: intensityChart, canvasId: 'intensityChart' }
            };
            
            // 只转换当前选中的分析图表
            const currentAnalysisChart = analysisChartMap[currentAnalysis];
            if (currentAnalysisChart) {
              const mapping = convertChartToImage(currentAnalysisChart.chart, currentAnalysisChart.canvasId);
              if (mapping) {
                chartMappings.push(mapping);
              }
            }
            
            // 等待所有图片加载完成
            await Promise.all(chartMappings.map(({ chartImgElement }) => {
              return new Promise((resolve) => {
                if (chartImgElement.complete && chartImgElement.naturalWidth > 0) {
                  resolve();
                } else {
                  chartImgElement.onload = () => {
                    if (chartImgElement.naturalWidth > 0) {
                      resolve();
                    }
                  };
                  chartImgElement.onerror = resolve; // 即使失败也继续
                  setTimeout(resolve, 2000); // 增加超时时间到2秒
                }
              });
            }));
            
            // 额外等待一段时间，确保DOM完全更新
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 验证所有图片都已加载
            for (const { chartImgElement, canvasId } of chartMappings) {
              if (chartImgElement && chartImgElement.naturalWidth === 0) {
                debugError(`警告: ${canvasId} 图片可能未完全加载`, chartImgElement);
              }
            }
            
            // 创建一个包装器包含container和footer
            wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '100%';
            wrapper.style.backgroundColor = '#ffffff';
            
            const container = document.querySelector('.container');
            const footer = document.querySelector('.page-footer');
            
            if (container) {
              // 使用深度克隆，确保包含所有图片元素
              const clonedContainer = container.cloneNode(true);
              
              // 在克隆中隐藏未选中的分析面板
              const clonedAnalysisSection = clonedContainer.querySelector('#analysisSection');
              if (clonedAnalysisSection) {
                const clonedAnalysisPanels = clonedAnalysisSection.querySelectorAll('.analysis-panel');
                clonedAnalysisPanels.forEach(panel => {
                  const panelId = panel.id;
                  const isCurrentPanel = (
                    (currentAnalysis === 'speed' && panelId === 'speedAnalysis') ||
                    (currentAnalysis === 'week' && panelId === 'weekAnalysis') ||
                    (currentAnalysis === 'frequency' && panelId === 'frequencyAnalysis') ||
                    (currentAnalysis === 'intensity' && panelId === 'intensityAnalysis')
                  );
                  
                  // 隐藏未选中的面板
                  if (!isCurrentPanel) {
                    panel.style.display = 'none';
                    panel.style.visibility = 'hidden';
                    // 移除未选中面板的内容，节省空间
                    const panelContent = panel.querySelector('.chart-container');
                    if (panelContent) {
                      panelContent.innerHTML = '';
                    }
                  }
                });
              }
              
              // 确保克隆后的图片元素也正确显示（只处理当前选中的图表）
              const currentCanvasId = analysisChartMap[currentAnalysis]?.canvasId;
              if (currentCanvasId) {
                const clonedImages = clonedContainer.querySelectorAll(
                  `img[data-chart-id="${currentCanvasId}"], img[id="${currentCanvasId}_img"]`
                );
                clonedImages.forEach(img => {
                  img.style.display = 'block';
                  img.style.visibility = 'visible';
                  img.style.opacity = '1';
                  img.style.position = 'relative';
                  img.style.margin = '0';
                  img.style.padding = '0';
                  // 确保图片有明确的宽高
                  if (!img.style.width || img.style.width === '0px') {
                    img.style.width = '100%';
                  }
                  if (!img.style.height || img.style.height === '0px') {
                    img.style.height = 'auto';
                  }
                });
              }
              
              // 隐藏未选中图表的图片
              Object.keys(analysisChartMap).forEach(analysisType => {
                if (analysisType !== currentAnalysis) {
                  const canvasId = analysisChartMap[analysisType].canvasId;
                  const unselectedImages = clonedContainer.querySelectorAll(
                    `img[data-chart-id="${canvasId}"], img[id="${canvasId}_img"]`
                  );
                  unselectedImages.forEach(img => {
                    img.style.display = 'none';
                    img.style.visibility = 'hidden';
                  });
                }
              });
              
              // 确保所有隐藏的canvas在克隆中也被隐藏
              const clonedCanvases = clonedContainer.querySelectorAll('canvas');
              clonedCanvases.forEach(canvas => {
                // 如果对应的图片存在，隐藏canvas
                const chartId = canvas.id;
                const hasImage = clonedContainer.querySelector(`img[data-chart-id="${chartId}"], img[id="${chartId}_img"]`);
                if (hasImage) {
                  canvas.style.display = 'none';
                  canvas.style.visibility = 'hidden';
                }
              });
              
              wrapper.appendChild(clonedContainer);
            }
            if (footer) {
              wrapper.appendChild(footer.cloneNode(true));
            }
            
            // 临时添加到body（可见位置）
            wrapper.style.position = 'absolute';
            wrapper.style.top = '0';
            wrapper.style.left = '0';
            wrapper.style.zIndex = '9999';
            wrapper.style.visibility = 'visible';
            wrapper.style.opacity = '1';
            document.body.appendChild(wrapper);
            
            // 再次等待，确保wrapper中的内容完全渲染
            await new Promise(resolve => setTimeout(resolve, 300));
            
            try {
              await exportToPdf(wrapper, {
                fileName: fileName,
                onStart: () => {
                  // 已在外部设置
                },
                onComplete: () => {
                  exportBtn.textContent = '导出PDF';
                  exportBtn.disabled = false;
                },
                onError: (error) => {
                  debugError('导出PDF失败:', error);
                  showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
                    message: error.message || String(error) 
                  }, error);
                  exportBtn.textContent = '导出PDF';
                  exportBtn.disabled = false;
                }
              });
            } finally {
              // 恢复所有原始canvas
              chartMappings.forEach(({ originalCanvas, chartImgElement }) => {
                if (chartImgElement && originalCanvas) {
                  // 移除图片元素
                  if (chartImgElement.parentNode) {
                chartImgElement.remove();
                  }
                  // 恢复canvas显示
                originalCanvas.style.display = '';
                  originalCanvas.style.visibility = '';
                  // 确保canvas可见
                  if (originalCanvas.parentNode) {
                    originalCanvas.parentNode.style.display = '';
                    originalCanvas.parentNode.style.visibility = '';
                  }
                }
              });
              
              // 确保所有图表canvas都可见（包括未转换的）
              const allCharts = [
                { chart: workoutChart, canvasId: 'trendChart' },
                { chart: speedChart, canvasId: 'speedChart' },
                { chart: weekChart, canvasId: 'weekChart' },
                { chart: frequencyChart, canvasId: 'frequencyChart' },
                { chart: intensityChart, canvasId: 'intensityChart' }
              ];
              
              allCharts.forEach(({ chart, canvasId }) => {
                if (chart && chart.canvas) {
                  const canvas = chart.canvas;
                  canvas.style.display = '';
                  canvas.style.visibility = '';
                  // 确保canvas的父容器也可见
                  if (canvas.parentNode) {
                    canvas.parentNode.style.display = '';
                    canvas.parentNode.style.visibility = '';
                  }
                  // 移除可能残留的图片元素
                  const existingImg = document.querySelector(`img[data-chart-id="${canvasId}"], img[id="${canvasId}_img"]`);
                  if (existingImg && existingImg.parentNode) {
                    existingImg.remove();
                  }
                }
              });
              
              // 恢复原始显示状态
              if (analysisSection && originalDisplayStates.analysisSection) {
                if (originalDisplayStates.analysisSection.className) {
                  analysisSection.className = originalDisplayStates.analysisSection.className;
                }
                analysisSection.style.display = originalDisplayStates.analysisSection.display || '';
                originalDisplayStates.analysisPanels.forEach(({ element, display }) => {
                  element.style.display = display;
                });
              }
              
              // 确保chartSection可见
              if (chartSection) {
                chartSection.style.display = '';
                chartSection.style.visibility = '';
                const chartContainer = chartSection.querySelector('.chart-container');
                if (chartContainer) {
                  chartContainer.style.display = '';
                  chartContainer.style.visibility = '';
                }
              }
              
              // 清理包装器
              if (wrapper && wrapper.parentNode) {
                wrapper.parentNode.removeChild(wrapper);
              }
            }
          } catch (error) {
            debugError('导出PDF失败:', error);
            
            // 确保在出错时也恢复所有图表
            try {
              // 恢复所有原始canvas
              if (typeof chartMappings !== 'undefined') {
                chartMappings.forEach(({ originalCanvas, chartImgElement }) => {
                  if (chartImgElement && originalCanvas) {
                    if (chartImgElement.parentNode) {
                      chartImgElement.remove();
                    }
                    originalCanvas.style.display = '';
                    originalCanvas.style.visibility = '';
                  }
                });
              }
              
              // 确保所有图表canvas都可见
              const allCharts = [
                { chart: workoutChart, canvasId: 'trendChart' },
                { chart: speedChart, canvasId: 'speedChart' },
                { chart: weekChart, canvasId: 'weekChart' },
                { chart: frequencyChart, canvasId: 'frequencyChart' },
                { chart: intensityChart, canvasId: 'intensityChart' }
              ];
              
              allCharts.forEach(({ chart, canvasId }) => {
                if (chart && chart.canvas) {
                  const canvas = chart.canvas;
                  canvas.style.display = '';
                  canvas.style.visibility = '';
                  const existingImg = document.querySelector(`img[data-chart-id="${canvasId}"], img[id="${canvasId}_img"]`);
                  if (existingImg && existingImg.parentNode) {
                    existingImg.remove();
                  }
                }
              });
              
              // 恢复原始显示状态
              if (typeof originalDisplayStates !== 'undefined' && originalDisplayStates.analysisSection) {
                const analysisSection = document.getElementById('analysisSection');
                if (analysisSection) {
                  if (originalDisplayStates.analysisSection.className) {
                    analysisSection.className = originalDisplayStates.analysisSection.className;
                  }
                  analysisSection.style.display = originalDisplayStates.analysisSection.display || '';
                  originalDisplayStates.analysisPanels.forEach(({ element, display }) => {
                    element.style.display = display;
                  });
                }
              }
              
              // 确保chartSection可见
              const chartSection = document.getElementById('chartSection');
              if (chartSection) {
                chartSection.style.display = '';
                chartSection.style.visibility = '';
              }
            } catch (recoveryError) {
              debugError('恢复图表显示失败:', recoveryError);
            }
            
            showError(ErrorType.SYSTEM_ERROR, 'PDF_EXPORT_FAILED', { 
              message: error.message || String(error) 
            }, error);
            if (exportBtn) {
              exportBtn.textContent = '导出PDF';
              exportBtn.disabled = false;
            }
          }
        }

        document.getElementById('exportPdfBtn')?.addEventListener('click', exportPageToPdf);

        // 自动加载 Admin-Workouts.csv 文件
        async function loadDefaultCsvFile() {
          // 检查是否在本地文件系统（file://协议），如果是则跳过自动加载
          if (window.location.protocol === 'file:') {
            console.log('本地文件系统环境，跳过自动加载，请手动选择文件');
            return;
          }

          try {
            // 从 index.json 读取文件路径配置
            let csvFileName = null;
            try {
              const configResponse = await fetch('Data/index.json');
              if (configResponse.ok) {
                const config = await configResponse.json();
                if (config.files && config.files['Admin-Workouts']) {
                  csvFileName = config.files['Admin-Workouts'];
                }
              }
            } catch (e) {
              console.log('无法读取配置文件，请手动选择文件');
              return;
            }

            if (!csvFileName) {
              console.log('配置文件中未找到文件路径，请手动选择文件');
              return;
            }

            const response = await fetch(`Data/${csvFileName}`);
            if (!response.ok) {
              console.log('默认 CSV 文件不存在，等待用户手动选择');
              return;
            }
            const blob = await response.blob();
            const file = new File([blob], csvFileName, { type: 'text/csv' });
            
            // 模拟文件选择事件，触发文件处理
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            // 触发 change 事件
            const changeEvent = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(changeEvent);
          } catch (error) {
            // 如果是CORS错误，静默处理（本地文件系统环境）
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
              console.log('本地文件系统环境，无法自动加载，请手动选择文件');
            } else {
              console.log('自动加载 CSV 文件失败，等待用户手动选择:', error);
            }
          }
        }

        // 页面加载完成后尝试自动加载文件
        window.addEventListener('DOMContentLoaded', async () => {
          // 等待一小段时间，确保页面完全加载
          setTimeout(() => {
            loadDefaultCsvFile();
          }, 500);
        });
      })();
    </script>
  </body>
</html>

