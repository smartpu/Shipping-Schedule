<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor Â· è®¿å®¢ç»Ÿè®¡</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/monitor-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <style>
      /* é¡µé¢ç‰¹å®šæ ·å¼ï¼ˆä¿ç•™ä¸å…¬å…±æ ·å¼ä¸åŒçš„éƒ¨åˆ†ï¼‰ */
      /* æ³¨æ„ï¼šè®¿å®¢ç»Ÿè®¡æ ·å¼å·²ç§»è‡³ vendor/monitor-styles.css */
    </style>
  </head>
  <body data-page="Monitor-Access-Log.html">
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <h2>ğŸ” è®¿é—®éªŒè¯</h2>
        <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
        <form id="authForm">
          <div class="auth-form-group">
            <label for="userName">å§“å *</label>
            <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
            <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
          </div>
          <div class="auth-form-group">
            <label for="userPhone">æ‰‹æœºå· *</label>
            <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
            <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
          </div>
          <div class="auth-form-group">
            <label for="userEmail">é‚®ç®± *</label>
            <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
            <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
          </div>
          <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
        </form>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <a href="index.html?tab=monitor" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
        <a href="Monitor-Access-Log-README.html" class="readme-btn">ä½¿ç”¨è¯´æ˜ â†’</a>
        <h1>Monitor Â· è®¿å®¢ç»Ÿè®¡</h1>
        <p>åˆ†æè®¿é—®æ—¥å¿—ï¼Œç»Ÿè®¡ç”¨æˆ·è®¿é—®è¡Œä¸ºå’Œé¡µé¢è®¿é—®çƒ­åº¦</p>
      </div>

      <div class="content">
        <section class="panel">
          <div class="upload-area">
            <label class="upload-card" for="fileInput">
              <svg
                width="36"
                height="36"
                viewBox="0 0 36 36"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <rect
                  x="4"
                  y="4"
                  width="28"
                  height="28"
                  rx="8"
                  fill="url(#grad)"
                ></rect>
                <path
                  d="M18 11v14M11 18h14"
                  stroke="#fff"
                  stroke-width="2.2"
                  stroke-linecap="round"
                ></path>
                <defs>
                  <linearGradient
                    id="grad"
                    x1="4"
                    y1="4"
                    x2="32"
                    y2="32"
                    gradientUnits="userSpaceOnUse"
                  >
                    <stop stop-color="#0071e3" />
                    <stop offset="1" stop-color="#54a4ff" />
                  </linearGradient>
                </defs>
              </svg>
              <span>
                <strong>è½½å…¥è®¿é—®æ—¥å¿—</strong><br />
                <small>æ”¯æŒ .jsonï¼Œæ•°æ®ä»…åœ¨æœ¬åœ°æµè§ˆå™¨è§£æ</small>
              </span>
              <input id="fileInput" type="file" accept=".json" />
            </label>
            <div class="status-card">
              <span class="status-label">æ•°æ®çŠ¶æ€</span>
              <span class="status-value" id="statusInfo">å°šæœªè½½å…¥æ•°æ®</span>
            </div>
          </div>
        </section>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <section class="panel hidden" id="statsSection">
          <h2>ç»Ÿè®¡æ¦‚è§ˆ</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>æ€»è®¿é—®æ¬¡æ•°</h3>
              <p class="stat-value" id="totalVisits">0</p>
            </div>
            <div class="stat-card">
              <h3>ç‹¬ç«‹è®¿å®¢</h3>
              <p class="stat-value" id="uniqueUsers">0</p>
            </div>
            <div class="stat-card">
              <h3>è®¿é—®é¡µé¢æ•°</h3>
              <p class="stat-value" id="uniquePages">0</p>
            </div>
            <div class="stat-card">
              <h3>å¹³å‡è®¿é—®æ¬¡æ•°</h3>
              <p class="stat-value" id="avgVisits">0</p>
            </div>
          </div>
        </section>

        <!-- ç”¨æˆ·è®¿é—®æ’å -->
        <section class="panel hidden" id="userRankingSection">
          <div class="ranking-section">
            <h2>ğŸ‘¤ ç”¨æˆ·è®¿é—®æ’å</h2>
            <table class="ranking-table">
              <thead>
                <tr>
                  <th class="rank">æ’å</th>
                  <th>å§“å</th>
                  <th>æ‰‹æœºå·</th>
                  <th>é‚®ç®±</th>
                  <th class="count">è®¿é—®æ¬¡æ•°</th>
                  <th>æœ€åè®¿é—®</th>
                </tr>
              </thead>
              <tbody id="userRankingBody">
              </tbody>
            </table>
          </div>
        </section>

        <!-- é¡µé¢è®¿é—®æ’å -->
        <section class="panel hidden" id="pageRankingSection">
          <div class="ranking-section">
            <h2>ğŸ“„ é¡µé¢è®¿é—®æ’å</h2>
            <table class="ranking-table">
              <thead>
                <tr>
                  <th class="rank">æ’å</th>
                  <th>é¡µé¢</th>
                  <th class="count">è®¿é—®æ¬¡æ•°</th>
                  <th>ç‹¬ç«‹è®¿å®¢</th>
                  <th>è®¿é—®å æ¯”</th>
                </tr>
              </thead>
              <tbody id="pageRankingBody">
              </tbody>
            </table>
          </div>
        </section>

        <!-- è®¿é—®æ—¶é—´åˆ†æ -->
        <section class="panel hidden" id="timeAnalysisSection">
          <div class="ranking-section">
            <h2>â° è®¿é—®æ—¶é—´åˆ†æ</h2>
            <div class="time-filter">
              <button class="time-filter-btn" data-period="hour">æŒ‰å°æ—¶</button>
              <button class="time-filter-btn active" data-period="day">æŒ‰æ—¥æœŸ</button>
              <button class="time-filter-btn" data-period="week">æŒ‰å‘¨</button>
              <button class="time-filter-btn" data-period="month">æŒ‰æœˆ</button>
            </div>
            <div class="time-chart-container">
              <canvas id="timeChart"></canvas>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="page-footer">
      <h2>Monitor Â· è®¿å®¢ç»Ÿè®¡ä½¿ç”¨å£°æ˜</h2>
      <p>è®¿é—®æ—¥å¿—æ•°æ®ä»…ç”¨äºå†…éƒ¨ç»Ÿè®¡åˆ†æï¼Œæ‰€æœ‰æ•°æ®ä»…åœ¨æœ¬åœ°æµè§ˆå™¨è§£æï¼Œä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨ã€‚</p>
      <p>ç»Ÿè®¡æ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•å•†ä¸šå†³ç­–ä¾æ®ã€‚</p>
    </div>

    <!-- ä½¿ç”¨ Gist å­˜å‚¨ç³»ç»Ÿï¼ˆç”¨æˆ·ç™½åå• + è®¿é—®è®°å½•ï¼‰ -->
    <script src="vendor/auth-gist.js"></script>
    <script>
      // ==================== è°ƒè¯•æ¨¡å¼ ====================
      // è°ƒè¯•å‡½æ•°å·²ç»Ÿä¸€åˆ° vendor/debug-utils.js
      // ä½¿ç”¨ï¼šdebugLog(), debugWarn(), debugError()

      // ==================== é”™è¯¯å¤„ç† ====================
      // é”™è¯¯å¤„ç†å·²ç»Ÿä¸€åˆ° vendor/error-handler.js
      // ä½¿ç”¨ï¼šshowError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED')
      // ErrorType å’Œ showError å‡½æ•°å·²ä» error-handler.js åŠ è½½

      let accessLogs = [];
      let timeChart = null;
      let currentTimePeriod = 'day';

      const fileInput = document.getElementById('fileInput');
      const statusInfo = document.getElementById('statusInfo');
      const statsSection = document.getElementById('statsSection');
      const userRankingSection = document.getElementById('userRankingSection');
      const pageRankingSection = document.getElementById('pageRankingSection');
      const timeAnalysisSection = document.getElementById('timeAnalysisSection');
      const userRankingBody = document.getElementById('userRankingBody');
      const pageRankingBody = document.getElementById('pageRankingBody');
      const timeFilterBtns = document.querySelectorAll('.time-filter-btn');

      // è‡ªåŠ¨åŠ è½½ access-logs.json æ–‡ä»¶
      async function autoLoadJsonFile() {
        // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆfile://åè®®ï¼‰ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡è‡ªåŠ¨åŠ è½½
        if (window.location.protocol === 'file:') {
          console.log('æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç¯å¢ƒï¼Œè·³è¿‡è‡ªåŠ¨åŠ è½½ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶');
          return;
        }

        try {
          // ä» index.json è¯»å–æ–‡ä»¶è·¯å¾„é…ç½®
          let jsonFileName = null;
          try {
            const configResponse = await fetch('Data/index.json');
            if (configResponse.ok) {
              const config = await configResponse.json();
              if (config.files && config.files['Monitor-Access-Log']) {
                jsonFileName = config.files['Monitor-Access-Log'];
              }
            }
          } catch (e) {
            console.log('æ— æ³•è¯»å–é…ç½®æ–‡ä»¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶');
            return;
          }

          if (!jsonFileName) {
            console.log('é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°æ–‡ä»¶è·¯å¾„ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶');
            return;
          }

          const response = await fetch(`Data/${jsonFileName}`);
          if (!response.ok) {
            console.log('é»˜è®¤ JSON æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©');
            return;
          }
          const blob = await response.blob();
          const file = new File([blob], jsonFileName, { type: 'application/json' });
          
          // æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼Œè§¦å‘æ–‡ä»¶å¤„ç†
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;
          
          // è§¦å‘ change äº‹ä»¶
          const changeEvent = new Event('change', { bubbles: true });
          fileInput.dispatchEvent(changeEvent);
        } catch (error) {
          // å¦‚æœæ˜¯CORSé”™è¯¯ï¼Œé™é»˜å¤„ç†ï¼ˆæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç¯å¢ƒï¼‰
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            console.log('æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç¯å¢ƒï¼Œæ— æ³•è‡ªåŠ¨åŠ è½½ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶');
          } else {
            console.log('è‡ªåŠ¨åŠ è½½ JSON æ–‡ä»¶å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©:', error);
          }
        }
      }

      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      fileInput.addEventListener('change', async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;

        try {
          statusInfo.textContent = 'æ­£åœ¨è¯»å–æ–‡ä»¶...';
          const text = await file.text();
          const data = JSON.parse(text);
          
          if (!Array.isArray(data)) {
            throw new Error('è®¿é—®æ—¥å¿—æ ¼å¼é”™è¯¯ï¼šåº”ä¸ºæ•°ç»„æ ¼å¼');
          }

          accessLogs = data;
          processData();
          statusInfo.textContent = `å·²åŠ è½½ ${data.length} æ¡è®¿é—®è®°å½•`;
        } catch (error) {
          showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
          statusInfo.textContent = 'è¯»å–å¤±è´¥';
        }
      });

      // å¤„ç†æ•°æ®
      function processData() {
        if (!accessLogs.length) return;

        // æ˜¾ç¤ºæ‰€æœ‰ç»Ÿè®¡åŒºåŸŸ
        statsSection.classList.remove('hidden');
        userRankingSection.classList.remove('hidden');
        pageRankingSection.classList.remove('hidden');
        timeAnalysisSection.classList.remove('hidden');

        // åŒæ­¥æŒ‰é’®çŠ¶æ€å’Œå˜é‡çŠ¶æ€
        timeFilterBtns.forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.period === currentTimePeriod) {
            btn.classList.add('active');
          }
        });

        // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
        updateStatsOverview();

        // æ›´æ–°ç”¨æˆ·æ’å
        updateUserRanking();

        // æ›´æ–°é¡µé¢æ’å
        updatePageRanking();

        // æ›´æ–°æ—¶é—´åˆ†æå›¾è¡¨
        updateTimeChart();
      }

      // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
      function updateStatsOverview() {
        const totalVisits = accessLogs.length;
        const uniqueUsers = new Set(accessLogs.map(log => `${log.name}|${log.phone}|${log.email}`)).size;
        const uniquePages = new Set(accessLogs.map(log => log.page)).size;
        const avgVisits = uniqueUsers > 0 ? (totalVisits / uniqueUsers).toFixed(1) : 0;

        document.getElementById('totalVisits').textContent = totalVisits.toLocaleString();
        document.getElementById('uniqueUsers').textContent = uniqueUsers.toLocaleString();
        document.getElementById('uniquePages').textContent = uniquePages.toLocaleString();
        document.getElementById('avgVisits').textContent = avgVisits;
      }

      // æ›´æ–°ç”¨æˆ·æ’å
      function updateUserRanking() {
        // æŒ‰ç”¨æˆ·ç»Ÿè®¡è®¿é—®æ¬¡æ•°ï¼ŒåŒæ—¶ä¿å­˜è®¿é—®å†å²
        const userStats = new Map();
        
        accessLogs.forEach(log => {
          const userKey = `${log.name}|${log.phone}|${log.email}`;
          if (!userStats.has(userKey)) {
            userStats.set(userKey, {
              name: log.name,
              phone: log.phone,
              email: log.email,
              count: 0,
              lastVisit: log.timestamp,
              visitHistory: [] // ä¿å­˜è®¿é—®å†å²
            });
          }
          const stats = userStats.get(userKey);
          stats.count++;
          // æ·»åŠ è®¿é—®å†å²è®°å½•
          stats.visitHistory.push({
            page: log.page,
            timestamp: log.timestamp
          });
          if (log.timestamp > stats.lastVisit) {
            stats.lastVisit = log.timestamp;
          }
        });

        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼Œåªå–å‰20ä¸ª
        const userArray = Array.from(userStats.values())
          .sort((a, b) => b.count - a.count)
          .slice(0, 20);

        // æ¸²æŸ“è¡¨æ ¼
        userRankingBody.innerHTML = '';
        userArray.forEach((user, index) => {
          const row = document.createElement('tr');
          const lastVisitDate = new Date(user.lastVisit);
          const lastVisitStr = lastVisitDate.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });

          row.innerHTML = `
            <td class="rank">${index + 1}</td>
            <td>${user.name || 'â€”'}</td>
            <td>${user.phone || 'â€”'}</td>
            <td>${user.email || 'â€”'}</td>
            <td class="count">${user.count.toLocaleString()}</td>
            <td>${lastVisitStr}</td>
          `;
          
          // æ·»åŠ æ‚¬åœæ•ˆæœï¼šæ˜¾ç¤ºè¯¥ç”¨æˆ·çš„æœ€è¿‘10æ¬¡è®¿é—®é¡µé¢åŠæ—¶é—´
          attachUserTooltip(row, user);
          
          userRankingBody.appendChild(row);
        });
      }
      
      // ä¸ºç”¨æˆ·æ’åè¡Œæ·»åŠ æ‚¬åœæç¤º
      function attachUserTooltip(row, user) {
        // è·å–æœ€è¿‘10æ¬¡è®¿é—®ï¼ŒæŒ‰æ—¶é—´å€’åº
        const recentVisits = user.visitHistory
          .sort((a, b) => b.timestamp - a.timestamp)
          .slice(0, 10);
        
        if (recentVisits.length === 0) return;
        
        // åˆ›å»º tooltip å…ƒç´ 
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.style.display = 'none';
        
        // æ„å»º tooltip å†…å®¹
        let tooltipHTML = '<div style="font-weight: 600; margin-bottom: 12px; color: #667eea; font-size: 14px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">æœ€è¿‘è®¿é—®è®°å½•</div>';
        recentVisits.forEach((visit, idx) => {
          const visitDate = new Date(visit.timestamp);
          const visitStr = visitDate.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          tooltipHTML += `
            <div class="tooltip-line" style="margin-bottom: 4px; grid-template-columns: 30px 1fr 50px auto;">
              <span class="tooltip-label" style="min-width: 30px; grid-column: 1;">${idx + 1}.</span>
              <span class="tooltip-value" style="grid-column: 2; word-break: break-all; padding-right: 12px;">${visit.page}</span>
              <span class="tooltip-label" style="grid-column: 3; min-width: 50px;">æ—¶é—´ï¼š</span>
              <span class="tooltip-value" style="grid-column: 4;">${visitStr}</span>
            </div>
          `;
        });
        tooltip.innerHTML = tooltipHTML;
        document.body.appendChild(tooltip);
        
        // å®šä½ tooltip çš„å‡½æ•°
        const positionTooltip = (e) => {
          const rect = tooltip.getBoundingClientRect();
          const padding = 15;
          let left = e.clientX + padding;
          let top = e.clientY + padding;
          
          // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨å·¦ä¾§
          if (left + rect.width > window.innerWidth) {
            left = e.clientX - rect.width - padding;
          }
          
          // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸Šæ–¹
          if (top + rect.height > window.innerHeight) {
            top = e.clientY - rect.height - padding;
          }
          
          // ç¡®ä¿ä¸è¶…å‡ºè§†çª—
          if (left < 0) left = padding;
          if (top < 0) top = padding;
          
          tooltip.style.left = left + 'px';
          tooltip.style.top = top + 'px';
        };
        
        let tooltipTimeout;
        row.addEventListener('mouseenter', (e) => {
          clearTimeout(tooltipTimeout);
          tooltip.style.display = 'block';
          positionTooltip(e);
        });
        
        row.addEventListener('mouseleave', () => {
          tooltipTimeout = setTimeout(() => {
            tooltip.style.display = 'none';
          }, 100);
        });
        
        row.addEventListener('mousemove', (e) => {
          clearTimeout(tooltipTimeout);
          if (tooltip.style.display === 'block') {
            positionTooltip(e);
          }
        });
      }

      // æ›´æ–°é¡µé¢æ’å
      function updatePageRanking() {
        // æŒ‰é¡µé¢ç»Ÿè®¡è®¿é—®æ¬¡æ•°å’Œç‹¬ç«‹è®¿å®¢ï¼ŒåŒæ—¶ä¿å­˜è®¿é—®å†å²
        const pageStats = new Map();
        
        accessLogs.forEach(log => {
          if (!pageStats.has(log.page)) {
            pageStats.set(log.page, {
              page: log.page,
              count: 0,
              uniqueUsers: new Set(),
              visitHistory: [] // ä¿å­˜è®¿é—®å†å²
            });
          }
          const stats = pageStats.get(log.page);
          stats.count++;
          stats.uniqueUsers.add(`${log.name}|${log.phone}|${log.email}`);
          // æ·»åŠ è®¿é—®å†å²è®°å½•
          stats.visitHistory.push({
            userName: log.name,
            userPhone: log.phone,
            userEmail: log.email,
            timestamp: log.timestamp
          });
        });

        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼Œåªå–å‰20ä¸ª
        const pageArray = Array.from(pageStats.values())
          .map(stats => ({
            page: stats.page,
            count: stats.count,
            uniqueUsers: stats.uniqueUsers.size,
            visitHistory: stats.visitHistory
          }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 20);

        const totalVisits = accessLogs.length;

        // æ¸²æŸ“è¡¨æ ¼
        pageRankingBody.innerHTML = '';
        pageArray.forEach((page, index) => {
          const row = document.createElement('tr');
          const percentage = ((page.count / totalVisits) * 100).toFixed(1);

          row.innerHTML = `
            <td class="rank">${index + 1}</td>
            <td>${page.page}</td>
            <td class="count">${page.count.toLocaleString()}</td>
            <td>${page.uniqueUsers.toLocaleString()}</td>
            <td>${percentage}%</td>
          `;
          
          // æ·»åŠ æ‚¬åœæ•ˆæœï¼šæ˜¾ç¤ºè¯¥é¡µé¢çš„æœ€è¿‘10ä¸ªè®¿é—®ç”¨æˆ·åŠæ—¶é—´
          attachPageTooltip(row, page);
          
          pageRankingBody.appendChild(row);
        });
      }
      
      // ä¸ºé¡µé¢æ’åè¡Œæ·»åŠ æ‚¬åœæç¤º
      function attachPageTooltip(row, page) {
        // è·å–æœ€è¿‘10æ¬¡è®¿é—®ï¼ŒæŒ‰æ—¶é—´å€’åº
        const recentVisits = page.visitHistory
          .sort((a, b) => b.timestamp - a.timestamp)
          .slice(0, 10);
        
        if (recentVisits.length === 0) return;
        
        // åˆ›å»º tooltip å…ƒç´ 
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.style.display = 'none';
        
        // æ„å»º tooltip å†…å®¹
        let tooltipHTML = '<div style="font-weight: 600; margin-bottom: 12px; color: #667eea; font-size: 14px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">æœ€è¿‘è®¿é—®ç”¨æˆ·</div>';
        recentVisits.forEach((visit, idx) => {
          const visitDate = new Date(visit.timestamp);
          const visitStr = visitDate.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          const userName = visit.userName || 'â€”';
          tooltipHTML += `
            <div class="tooltip-line" style="margin-bottom: 4px; grid-template-columns: 30px 1fr 50px auto;">
              <span class="tooltip-label" style="min-width: 30px; grid-column: 1;">${idx + 1}.</span>
              <span class="tooltip-value" style="grid-column: 2; padding-right: 12px;">${userName}</span>
              <span class="tooltip-label" style="grid-column: 3; min-width: 50px;">æ—¶é—´ï¼š</span>
              <span class="tooltip-value" style="grid-column: 4;">${visitStr}</span>
            </div>
          `;
        });
        tooltip.innerHTML = tooltipHTML;
        document.body.appendChild(tooltip);
        
        // å®šä½ tooltip çš„å‡½æ•°
        const positionTooltip = (e) => {
          const rect = tooltip.getBoundingClientRect();
          const padding = 15;
          let left = e.clientX + padding;
          let top = e.clientY + padding;
          
          // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨å·¦ä¾§
          if (left + rect.width > window.innerWidth) {
            left = e.clientX - rect.width - padding;
          }
          
          // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸Šæ–¹
          if (top + rect.height > window.innerHeight) {
            top = e.clientY - rect.height - padding;
          }
          
          // ç¡®ä¿ä¸è¶…å‡ºè§†çª—
          if (left < 0) left = padding;
          if (top < 0) top = padding;
          
          tooltip.style.left = left + 'px';
          tooltip.style.top = top + 'px';
        };
        
        let tooltipTimeout;
        row.addEventListener('mouseenter', (e) => {
          clearTimeout(tooltipTimeout);
          tooltip.style.display = 'block';
          positionTooltip(e);
        });
        
        row.addEventListener('mouseleave', () => {
          tooltipTimeout = setTimeout(() => {
            tooltip.style.display = 'none';
          }, 100);
        });
        
        row.addEventListener('mousemove', (e) => {
          clearTimeout(tooltipTimeout);
          if (tooltip.style.display === 'block') {
            positionTooltip(e);
          }
        });
      }

      // æ›´æ–°æ—¶é—´åˆ†æå›¾è¡¨
      function updateTimeChart() {
        if (typeof Chart === 'undefined') {
          console.warn('Chart.js æœªåŠ è½½ï¼Œæ— æ³•æ˜¾ç¤ºæ—¶é—´åˆ†æå›¾è¡¨');
          return;
        }

        const ctx = document.getElementById('timeChart');
        if (!ctx) return;

        // é”€æ¯æ—§å›¾è¡¨
        if (timeChart) {
          timeChart.destroy();
        }

        // æ ¹æ®æ—¶é—´å‘¨æœŸåˆ†ç»„æ•°æ®
        const timeData = groupByTimePeriod(currentTimePeriod);
        const labels = Object.keys(timeData).sort();
        const data = labels.map(label => timeData[label]);

        // åˆ›å»ºæ–°å›¾è¡¨
        timeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'è®¿é—®æ¬¡æ•°',
              data: data,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      // æŒ‰æ—¶é—´å‘¨æœŸåˆ†ç»„æ•°æ®
      function groupByTimePeriod(period) {
        const groups = {};

        accessLogs.forEach(log => {
          const date = new Date(log.timestamp);
          let key = '';

          switch (period) {
            case 'hour':
              key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:00`;
              break;
            case 'day':
              key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
              break;
            case 'week':
              const weekStart = new Date(date);
              weekStart.setDate(date.getDate() - date.getDay());
              key = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`;
              break;
            case 'month':
              key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
              break;
          }

          if (!groups[key]) {
            groups[key] = 0;
          }
          groups[key]++;
        });

        return groups;
      }

      // æ—¶é—´å‘¨æœŸç­›é€‰æŒ‰é’®äº‹ä»¶
      timeFilterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          timeFilterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTimePeriod = btn.dataset.period;
          updateTimeChart();
        });
      });

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('DOMContentLoaded', async () => {
        // ç¡®ä¿ Chart.js å·²åŠ è½½
        if (typeof ensureChartJs === 'function') {
          await ensureChartJs();
        }
        
        // å°è¯•è‡ªåŠ¨åŠ è½½è®¿é—®æ—¥å¿—æ–‡ä»¶
        setTimeout(() => {
          autoLoadJsonFile();
        }, 500);
      });
    </script>
  </body>
</html>
