<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor · 订舱汇总分析</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/filter-utils.js"></script>
    <script src="vendor/excel-reader-utils.js"></script>
    <script src="vendor/toast.js"></script>
    <script src="vendor/week-utils.js"></script>
    <script src="vendor/week-processing-utils.js"></script>
    <!-- XLSX库 -->
    <script src="vendor/xlsx.full.min.js"></script>
    <!-- Chart.js库 -->
    <script src="vendor/chart.umd.min.js"></script>
    <!-- 引入访问日志记录 -->
    <script src="vendor/auth-gist.js"></script>
    <!-- 引入导航栏公共组件 -->
    <script src="vendor/sidebar-loader.js"></script>
</head>
<body data-page="Monitor-Booking-Summary.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器 -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>Monitor · 订舱汇总分析</h2>
                            <p>基于订舱汇总数据，提供 Sales、Account、船名航次等多个维度的数据分析</p>
                        </div>
                        <div class="section-intro-actions">
                            <a href="dashboard.html?tab=monitor" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="Monitor-Booking-Summary-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 文件上传和数据状态区域 -->
                <div style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 0;">
                    <div class="grid-2-col" style="margin-bottom: 0;">
                        <!-- 左侧：载入 Excel -->
                        <div class="card-white">
                            <label for="excelFile" class="file-upload-label" aria-label="选择Excel文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradExcel)" />
                                    <rect x="8" y="8" width="20" height="20" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="14" x2="28" y2="14" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="20" x2="28" y2="20" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="14" y1="8" x2="14" y2="28" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M18 22L22 26L14 26Z" fill="#fff"/>
                                    <defs>
                                        <linearGradient id="gradExcel" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#0071e3" />
                                            <stop offset="1" stop-color="#54a4ff" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入 Excel</div>
                                    <div class="file-upload-desc">支持 .xlsx / .xls，需包含 Data 工作表</div>
                                </div>
                                <input type="file" id="excelFile" class="file-upload-input" accept=".xlsx,.xls" aria-label="选择Excel文件">
                            </label>
                        </div>
                        
                        <!-- 右侧：Excel 数据状态 -->
                        <div class="card-white">
                            <div class="data-status-container">
                                <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradStatus)" />
                                    <rect x="11" y="10" width="14" height="16" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <rect x="15" y="8" width="6" height="4" rx="1" fill="#fff"/>
                                    <path d="M14 18L17 21L23 15" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <defs>
                                        <linearGradient id="gradStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#FF8A00" />
                                            <stop offset="1" stop-color="#FFB347" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="data-status-content">
                                    <div class="data-status-title">数据状态</div>
                                    <div id="statusValue" class="data-status-text">尚未载入数据</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 筛选器区域 -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">筛选条件</span>
                        <div style="flex: 1;">
                            <h2 class="section-title">数据筛选 <span>DATA FILTER</span></h2>
                            <p class="module-desc">支持多维度筛选，默认显示当周+未来3周数据</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" id="filtersContainer">
                        <!-- 时间范围选择 -->
                        <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 15px; font-weight: 600; color: #495057;">时间范围选择（基于开船日期 AD列）</label>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div style="flex: 1; display: flex; gap: 20px; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <label for="startDate" style="white-space: nowrap; min-width: 70px; font-weight: 500;">开始日期：</label>
                                        <input type="date" id="startDate" style="flex: 1; padding: 10px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; background-color: white;">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <label for="endDate" style="white-space: nowrap; min-width: 70px; font-weight: 500;">结束日期：</label>
                                        <input type="date" id="endDate" style="flex: 1; padding: 10px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; background-color: white;">
                                    </div>
                                </div>
                                <div style="flex: 1; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                    <button type="button" id="resetDateRangeDefault" class="filter-btn btn-sweep-blue" style="padding: 10px 16px; font-size: 14px; font-weight: 500; border-radius: 6px; white-space: nowrap; flex: 1; min-width: 120px; max-width: 150px;">当周+未来3周</button>
                                </div>
                            </div>
                        </div>

                        <!-- 筛选器行 -->
                        <div class="destination-filters">
                            <!-- 一行：8个筛选器 -->
                            <div class="filter-row" style="grid-template-columns: repeat(8, 1fr); gap: 15px;">
                                <!-- Dept 筛选 -->
                                <div class="filter-group">
                                    <label for="deptFilter">Dept</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="deptSearch" class="filter-search" placeholder="搜索 Dept..." autocomplete="off">
                                    <select id="deptFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 Dept</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="dept" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="dept" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>

                                <!-- Trade 筛选 -->
                                <div class="filter-group">
                                    <label for="tradeFilter">Trade</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="tradeSearch" class="filter-search" placeholder="搜索 Trade..." autocomplete="off">
                                    <select id="tradeFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 Trade</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="trade" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="trade" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>

                                <!-- EXP LINE 筛选 -->
                                <div class="filter-group">
                                    <label for="expLineFilter">EXP LINE</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="expLineSearch" class="filter-search" placeholder="搜索 EXP LINE..." autocomplete="off">
                                    <select id="expLineFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 EXP LINE</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="expLine" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="expLine" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>

                                <!-- TYPE 筛选 -->
                                <div class="filter-group">
                                    <label for="typeFilter">TYPE</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="typeSearch" class="filter-search" placeholder="搜索 TYPE..." autocomplete="off">
                                    <select id="typeFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 TYPE</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="type" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="type" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>

                                <!-- DRY/REEFER/SPECIAL 筛选 -->
                                <div class="filter-group">
                                    <label for="containerTypeFilter">DRY/REEFER/SPECIAL</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="containerTypeSearch" class="filter-search" placeholder="搜索 DRY/REEFER/SPECIAL..." autocomplete="off">
                                    <select id="containerTypeFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 DRY/REEFER/SPECIAL</option>
                                        <option value="DRY">DRY</option>
                                        <option value="REEFER">REEFER</option>
                                        <option value="SPECIAL">SPECIAL</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="containerType" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="containerType" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>

                                <!-- Commodity Item 筛选 -->
                                <div class="filter-group">
                                    <label for="commodityFilter">Commodity Item</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="commoditySearch" class="filter-search" placeholder="搜索 Commodity Item..." autocomplete="off">
                                    <select id="commodityFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 Commodity Item</option>
                                        <option value="Live Reefer">Live Reefer</option>
                                        <option value="NOR">NOR</option>
                                        <option value="Non Reefer">Non Reefer</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="commodity" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="commodity" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>

                                <!-- AREA 筛选 -->
                                <div class="filter-group">
                                    <label for="areaFilter">AREA</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="areaSearch" class="filter-search" placeholder="搜索 AREA..." autocomplete="off">
                                    <select id="areaFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 AREA</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="area" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="area" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>

                                <!-- DLY 筛选 -->
                                <div class="filter-group">
                                    <label for="dlyFilter">DLY</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="dlySearch" class="filter-search" placeholder="搜索 DLY..." autocomplete="off">
                                    <select id="dlyFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 DLY</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="dly" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="dly" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 分析维度选择 -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">分析维度</span>
                        <div style="flex: 1;">
                            <h2 class="section-title">维度选择 <span>DIMENSION</span></h2>
                            <p class="module-desc">选择要查看的分析维度</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" id="dimensionContainer">
                        <!-- 第一行：Sales 和 Account 维度 -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                            <button type="button" class="dimension-btn active" data-dimension="sales-dept" style="padding: 15px; border: 2px solid #3E62AD; border-radius: 8px; background: #3E62AD; color: white; font-weight: 600; cursor: pointer;">
                                Sales + Dept
                            </button>
                            <button type="button" class="dimension-btn" data-dimension="sales-week" style="padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 600; cursor: pointer;">
                                Sales + Week
                            </button>
                            <button type="button" class="dimension-btn" data-dimension="account-dept" style="padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 600; cursor: pointer;">
                                Account + Dept
                            </button>
                            <button type="button" class="dimension-btn" data-dimension="account-week" style="padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 600; cursor: pointer;">
                                Account + Week
                            </button>
                        </div>
                        <!-- 第二行：VSL/VOY 维度 -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                            <button type="button" class="dimension-btn" data-dimension="vessel-dept" style="padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 600; cursor: pointer;">
                                VSL/VOY + Dept
                            </button>
                            <button type="button" class="dimension-btn" data-dimension="vessel-week" style="padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 600; cursor: pointer;">
                                VSL/VOY + Week
                            </button>
                            <button type="button" class="dimension-btn" data-dimension="vessel-gps" style="padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 600; cursor: pointer;">
                                VSL/VOY + GPS
                            </button>
                            <button type="button" class="dimension-btn" data-dimension="vessel-limit" style="padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #495057; font-weight: 600; cursor: pointer;">
                                VSL/VOY + Limit
                            </button>
                        </div>
                    </div>
                </section>

                <!-- 分析结果区域 -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">分析结果</span>
                        <div style="flex: 1;">
                            <h2 class="section-title">数据汇总 <span>ANALYSIS RESULT</span></h2>
                            <p class="module-desc" id="dimensionDesc">请选择分析维度查看数据</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" id="resultContainer">
                        <!-- 统计面板 -->
                        <div class="stats-panel" id="statsPanel" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">TTL TEU</div>
                                <div class="stat-value" id="statTotalTeu">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">TTL TONS</div>
                                <div class="stat-value" id="statTotalTons">0.00</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">AVG GPS</div>
                                <div class="stat-value" id="statAvgGps">0.00</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">TONS/TEU</div>
                                <div class="stat-value" id="statTonsPerTeu">0.0000</div>
                            </div>
                        </div>
                        
                        <!-- 视图切换选项卡 -->
                        <!-- 表格视图 -->
                        <div id="tableView" class="view-content" style="margin-top: 0;">
                            <div id="analysisTable" style="overflow-x: auto; margin-top: 0;">
                                <!-- 分析结果表格将在这里动态生成 -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">Monitor · 订舱汇总分析使用声明</h2>
                    <p class="usage-statement-text">资料整合自用户 Excel 数据，解析结果仅供内部研判使用。</p>
                    <p class="usage-statement-text">所有数据仅在本地浏览器解析，不会上传至任何服务器，请放心使用。</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        /**
         * Monitor-MSQ1D890 多维度分析工具
         * 基于 Monitor-MSQ1D890.xlsx 的 Data sheet 进行多维度数据分析
         */

        // 应用配置
        const APP_CONFIG = {
            DEFAULT_WEEK_COUNT: 4, // 默认当周+未来3周（共4周）
            SHEET_NAME: 'Data' // 目标工作表名称
        };

        // 全局数据存储
        let rawData = []; // 原始数据
        let filteredData = []; // 筛选后的数据
        let currentDimension = 'sales-dept'; // 当前选择的维度
        let allocationData = {}; // Allocation数据：{trade|expLine: allocation}
        let userAllocationData = {}; // 用户编辑的Allocation数据：{trade|expLine: allocation}
        let limitData = {}; // Limit数据：{trade|svc|sqsc: limit}，从2025表的A到I列读取
        
        // localStorage 键名
        const STORAGE_KEY_USER_ALLOCATION = 'monitor_booking_user_allocation';
        
        /**
         * 从localStorage加载用户修改的Allocation数据
         */
        function loadUserAllocationData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_USER_ALLOCATION);
                if (saved) {
                    userAllocationData = JSON.parse(saved);
                    debugLog(`[Allocation持久化] 从localStorage恢复 ${Object.keys(userAllocationData).length} 条用户修改的数据`);
                } else {
                    userAllocationData = {};
                    debugLog('[Allocation持久化] localStorage中没有保存的用户修改数据');
                }
            } catch (error) {
                console.warn('[Allocation持久化] 加载用户修改数据失败:', error);
                userAllocationData = {};
            }
        }
        
        /**
         * 保存用户修改的Allocation数据到localStorage
         */
        function saveUserAllocationData() {
            try {
                localStorage.setItem(STORAGE_KEY_USER_ALLOCATION, JSON.stringify(userAllocationData));
                debugLog(`[Allocation持久化] 保存 ${Object.keys(userAllocationData).length} 条用户修改的数据到localStorage`);
            } catch (error) {
                console.warn('[Allocation持久化] 保存用户修改数据失败:', error);
            }
        }

        // 列映射（Excel列名到数据键的映射）
        const COLUMN_MAP = {
            BLNO: 'A', // A列 BLNO
            SQ_SC: 'C', // C列 SQ/SC
            SQ_SC_NAME: 'D', // D列 SQ/SC Name
            SALES_ID: 'E', // E列 SalesID
            VESSEL: 'G', // G列 船名
            VOYAGE: 'H', // H列 航次
            COL_I: 'I', // I列（4P的一部分）
            COL_J: 'J', // J列（4P的一部分）
            COL_K: 'K', // K列 POD（同时也是4P的一部分）
            COL_L: 'L', // L列 DLY（同时也是4P的一部分）
            POD: 'K', // K列 POD
            DLY: 'L', // L列 DLY
            N: 'N', // N列（柜型开始列）
            X: 'X', // X列 TEU
            Y: 'Y', // Y列 TONS（需要/1000）
            Z: 'Z', // Z列 GPS
            TRADE: 'AA', // AA列 Trade
            DEPT: 'AB', // AB列 Dept
            EXP_LINE: 'AC', // AC列 EXP LINE
            SAIL_DATE: 'AD', // AD列 开船日期
            WEEK: 'AE', // AE列 周别
            TYPE: 'AF', // AF列 TYPE
            DRY: 'AG', // AG列 DRY
            REEFER: 'AH', // AH列 REEFER
            SPECIAL: 'AI', // AI列 SPECIAL
            AREA: 'AK', // AK列 AREA
            COMMODITY: null // 品名列（需要从其他地方获取，暂时设为null）
        };

        /**
         * 初始化应用
         */
        function initApp() {
            // 初始化侧边栏
            if (window.SidebarLoader) {
                window.SidebarLoader.load('#sidebar-placeholder', {
                    currentPage: 'Monitor-MSQ1D890.html',
                    currentSection: 'monitor'
                });
            } else if (typeof window.loadSidebar === 'function') {
                window.loadSidebar();
            }

            // 页面加载时，从localStorage恢复用户修改的Allocation数据
            loadUserAllocationData();

            // 初始化搜索功能

            // 清除旧缓存（启动时自动清理）
            if (typeof CacheManager !== 'undefined') {
                CacheManager.clearOldCache();
            }

            // 初始化文件上传
            initFileUpload();

            // 初始化筛选器
            initFilters();

            // 初始化维度选择
            initDimensionSelection();

            // 初始化日期范围（默认当周+未来3周）
            initDateRange();

            debugLog('[Monitor-MSQ1D890] 应用初始化完成');
        }

        /**
         * 初始化文件上传
         */
        function initFileUpload() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput) return;

            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    // 检查缓存
                    if (typeof CacheManager !== 'undefined') {
                        const cacheKey = CacheManager.getCacheKey(file.name, file.lastModified);
                        const cachedData = CacheManager.load(cacheKey);
                        
                        if (cachedData) {
                            // 使用缓存数据
                            rawData = cachedData;
                            updateDataStatus(rawData.length);
                            initFilterOptions();
                            applyFilters();
                            
                            // 显示缓存提示
                            const statusEl = document.getElementById('statusValue');
                            if (statusEl) {
                                statusEl.innerHTML = `
                                    <span>已从缓存加载 ${rawData.length.toLocaleString()} 条记录</span>
                                    <span style="color: #6c757d; margin-left: 10px;">(缓存数据)</span>
                                `;
                            }
                            
                            // 显示筛选器和分析区域
                            document.getElementById('filtersContainer')?.classList.remove('hidden');
                            document.getElementById('dimensionContainer')?.classList.remove('hidden');
                            document.getElementById('resultContainer')?.classList.remove('hidden');
                            
                            return;
                        }
                    }

                    // 显示解析中状态和进度条
                    const statusEl = document.getElementById('statusValue');
                    if (statusEl) {
                        statusEl.innerHTML = `
                            <span>解析中...</span>
                            <div style="width: 100%; height: 4px; background: #e9ecef; border-radius: 2px; margin-top: 8px; overflow: hidden;">
                                <div id="parseProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #0071e3, #54a4ff); transition: width 0.3s;"></div>
                            </div>
                        `;
                    }

                    // 读取Excel文件 - 使用header: 1模式以便通过列索引访问
                    const arrayBuffer = await file.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: false, cellNF: false, raw: true });
                    
                    // 查找Data工作表
                    let sheetName = APP_CONFIG.SHEET_NAME;
                    if (!workbook.SheetNames.includes(sheetName)) {
                        sheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('data')
                        ) || workbook.SheetNames[0];
                    }
                    
                    if (!sheetName) {
                        throw new Error('未找到Data工作表');
                    }
                    
                    const worksheet = workbook.Sheets[sheetName];
                    if (!worksheet) {
                        throw new Error(`工作表 "${sheetName}" 不存在`);
                    }
                    
                    // 使用header: 1获取二维数组，然后转换为对象数组（使用列索引作为键）
                    const matrix = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null, raw: true });
                    
                    if (matrix.length === 0) {
                        throw new Error('Data工作表为空');
                    }
                    
                    // 将二维数组转换为对象数组，使用列索引作为键（A=0, B=1, ...）
                    rawData = [];
                    const totalRows = matrix.length - 1; // 跳过第一行
                    const progressBar = document.getElementById('parseProgress');
                    
                    for (let i = 1; i < matrix.length; i++) { // 跳过第一行（如果有标题行）
                        // 更新进度
                        if (progressBar && i % 100 === 0) {
                            const progress = (i / totalRows * 100).toFixed(0);
                            progressBar.style.width = progress + '%';
                            // 使用 requestAnimationFrame 避免阻塞
                            await new Promise(resolve => requestAnimationFrame(resolve));
                        }
                        
                        const row = matrix[i];
                        if (!row || row.length === 0) continue;
                        
                        const rowObj = {};
                        // 将数组索引映射到列字母（0=A, 1=B, ..., 25=Z, 26=AA, ...）
                        for (let j = 0; j < row.length; j++) {
                            const columnLetter = indexToExcelColumn(j);
                            rowObj[columnLetter] = row[j];
                        }
                        rawData.push(rowObj);
                    }
                    
                    // 完成进度
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }
                    
                    debugLog(`[Monitor-MSQ1D890] 成功读取 ${rawData.length} 条数据`);

                    // 更新状态
                    updateDataStatus(rawData.length);

                    // 初始化筛选器选项
                    initFilterOptions();

                    // 显示筛选器和分析区域
                    document.getElementById('filtersContainer')?.classList.remove('hidden');
                    document.getElementById('dimensionContainer')?.classList.remove('hidden');
                    document.getElementById('resultContainer')?.classList.remove('hidden');

                    // 在读取Excel前，先从localStorage恢复用户修改的数据
                    loadUserAllocationData();
                    
                    // 读取年份表（2025/2026/2027等）的K到N列，获取Allocation数据
                    try {
                        // 查找年份工作表（2025、2026、2027等），优先查找最新年份
                        const currentYear = new Date().getFullYear();
                        const yearPatterns = [];
                        // 生成未来5年到过去2年的年份列表，优先最新年份
                        for (let year = currentYear + 5; year >= currentYear - 2; year--) {
                            yearPatterns.push(String(year));
                        }
                        
                        let sheetYearName = null;
                        let foundYear = null;
                        
                        // 先尝试精确匹配年份
                        for (const year of yearPatterns) {
                            sheetYearName = workbook.SheetNames.find(name => {
                                const trimmedName = String(name).trim();
                                return trimmedName === year;
                            });
                            if (sheetYearName) {
                                foundYear = year;
                                break;
                            }
                        }
                        
                        // 如果精确匹配失败，尝试包含年份的匹配
                        if (!sheetYearName) {
                            for (const year of yearPatterns) {
                                sheetYearName = workbook.SheetNames.find(name => {
                                    const trimmedName = String(name).trim();
                                    return trimmedName.includes(year);
                                });
                                if (sheetYearName) {
                                    foundYear = year;
                                    break;
                                }
                            }
                        }
                        
                        if (sheetYearName) {
                            debugLog(`[Allocation导入] 找到工作表: ${sheetYearName} (年份: ${foundYear})`);
                            const sheetYear = workbook.Sheets[sheetYearName];
                            const sheetYearMatrix = XLSX.utils.sheet_to_json(sheetYear, { header: 1, defval: null, raw: true });
                            
                            debugLog(`[Allocation导入] ${foundYear}表总行数: ${sheetYearMatrix.length}`);
                            
                            // 查找表头行（包含Trade, Service, Allocation等列名）
                            let headerRow = -1;
                            // 直接使用K到N列：K=10(Trade), L=11(Service), M=12(T+S), N=13(Allocation)
                            const tradeColIndex = 10;  // K列
                            const serviceColIndex = 11; // L列
                            const allocationColIndex = 13; // N列
                            
                            // 查找表头行
                            for (let i = 0; i < Math.min(20, sheetYearMatrix.length); i++) {
                                const row = sheetYearMatrix[i];
                                if (!row || row.length === 0) continue;
                                
                                // 查找包含"Trade"、"Service"、"Allocation"的行作为表头
                                const rowStr = row.map(cell => String(cell || '').toLowerCase()).join('|');
                                if (rowStr.includes('trade') && rowStr.includes('service') && rowStr.includes('allocation')) {
                                    headerRow = i;
                                    break;
                                }
                            }
                            
                            // 如果没找到表头，尝试查找年份标题行
                            if (headerRow === -1 && foundYear) {
                                for (let i = 0; i < Math.min(20, sheetYearMatrix.length); i++) {
                                    const row = sheetYearMatrix[i];
                                    if (row && row.length > 0) {
                                        const firstCell = String(row[0] || '').trim();
                                        if (firstCell === foundYear || firstCell.includes(foundYear)) {
                                            headerRow = i;
                                            break;
                                        }
                                    }
                                }
                            }
                            
                            // 如果还是没找到，假设第一行是表头
                            if (headerRow === -1) {
                                headerRow = 0;
                            }
                            
                            debugLog(`[Allocation导入] 表头行: ${headerRow}, Trade列(K=10): ${tradeColIndex}, Service列(L=11): ${serviceColIndex}, Allocation列(N=13): ${allocationColIndex}`);
                            
                            // 从表头行的下一行开始读取数据
                            const dataStartRow = headerRow + 1;
                            
                            // 保留用户已修改的数据，只更新未修改的记录
                            // 先备份用户修改的数据
                            const backupUserData = { ...userAllocationData };
                            
                            // 清空allocationData，重新从Excel读取
                            allocationData = {};
                            let allocationCount = 0;
                            let skippedUserModified = 0;
                            
                            for (let i = dataStartRow; i < sheetYearMatrix.length; i++) {
                                const row = sheetYearMatrix[i];
                                if (!row || row.length === 0) continue;
                                
                                // 读取K到N列的数据，统一转大写和trim，确保匹配
                                const trade = row[tradeColIndex] ? String(row[tradeColIndex]).trim().toUpperCase() : '';
                                const service = row[serviceColIndex] ? String(row[serviceColIndex]).trim().toUpperCase() : '';
                                const allocation = row[allocationColIndex] !== null && row[allocationColIndex] !== undefined 
                                    ? Number(row[allocationColIndex]) : null;
                                
                                // 允许service为空的情况（只匹配trade）
                                if (trade && allocation !== null && !isNaN(allocation) && allocation > 0) {
                                    // 使用 trade|service 作为key（service对应主表的EXP LINE）
                                    // 如果service为空，使用trade作为key的一部分
                                    const key = service ? `${trade}|${service}` : `${trade}|`;
                                    
                                    // 如果用户已经修改过这个key的数据，保留用户的修改，不覆盖
                                    if (backupUserData[key] !== undefined && backupUserData[key] !== null) {
                                        // 用户已修改，保留用户数据，不更新allocationData
                                        skippedUserModified++;
                                    } else {
                                        // 用户未修改，使用Excel中的数据
                                        allocationData[key] = allocation;
                                        allocationCount++;
                                        
                                        // 记录前10条数据用于调试
                                        if (allocationCount <= 10) {
                                            debugLog(`[Allocation导入] 数据${allocationCount}: trade="${trade}", service="${service}", key="${key}", allocation=${allocation}`);
                                        }
                                    }
                                }
                            }
                            
                            // 恢复用户修改的数据到userAllocationData
                            userAllocationData = backupUserData;
                            
                            debugLog(`[Allocation导入] 成功读取 ${allocationCount} 条Allocation数据（跳过 ${skippedUserModified} 条用户已修改的数据）`);
                            
                            // 同时读取Limit数据（A到I列：A列trade, B列SVC, E列SQ/SC, I列Limit）
                            limitData = {};
                            let limitCount = 0;
                            const tradeLimitColIndex = 0;  // A列
                            const svcLimitColIndex = 1;    // B列
                            const sqScLimitColIndex = 4;   // E列
                            const limitValueColIndex = 8;  // I列
                            
                            for (let i = dataStartRow; i < sheetYearMatrix.length; i++) {
                                const row = sheetYearMatrix[i];
                                if (!row || row.length === 0) continue;
                                
                                const trade = row[tradeLimitColIndex] ? String(row[tradeLimitColIndex]).trim().toUpperCase() : '';
                                const svc = row[svcLimitColIndex] ? String(row[svcLimitColIndex]).trim().toUpperCase() : '';
                                const sqSc = row[sqScLimitColIndex] ? String(row[sqScLimitColIndex]).trim().toUpperCase() : '';
                                const limit = row[limitValueColIndex] !== null && row[limitValueColIndex] !== undefined 
                                    ? Number(row[limitValueColIndex]) : null;
                                
                                if (trade && svc && sqSc && limit !== null && !isNaN(limit) && limit > 0) {
                                    const limitKey = `${trade}|${svc}|${sqSc}`;
                                    limitData[limitKey] = limit;
                                    limitCount++;
                                    
                                    if (limitCount <= 5) {
                                        debugLog(`[Limit导入] 数据${limitCount}: trade="${trade}", svc="${svc}", sqSc="${sqSc}", key="${limitKey}", limit=${limit}`);
                                    }
                                }
                            }
                            
                            debugLog(`[Limit导入] 成功读取 ${limitCount} 条Limit数据`);
                            
                            debugLog('[Allocation导入] 所有key列表（前10个）:', Object.keys(allocationData).slice(0, 10));
                            
                            // 检查用户提到的几个key是否存在
                            const testKeys = ['APG|AMA', 'FE|CIX8', 'ISC|CIX8'];
                            testKeys.forEach(testKey => {
                                if (allocationData[testKey] !== undefined) {
                                    debugLog(`[Allocation导入] ✓ 找到key "${testKey}": ${allocationData[testKey]}`);
                                } else {
                                    debugLog(`[Allocation导入] ✗ 未找到key "${testKey}"`);
                                }
                            });
                        } else {
                            console.warn('[Allocation导入] 未找到年份工作表（2025/2026/2027等），所有Sheet名称:', workbook.SheetNames);
                            // 如果没找到年份表，保留现有的allocationData和userAllocationData
                            debugLog('[Allocation导入] 保留现有Allocation数据');
                        }
                    } catch (error) {
                        console.error('读取sheet10 Allocation数据失败:', error);
                        allocationData = {};
                    }

                    // 应用默认筛选
                    applyFilters();
                } catch (error) {
                    debugError('[Monitor-MSQ1D890] 读取Excel文件失败:', error);
                    updateDataStatus(0);
                    alert(`读取失败: ${error.message}`);
                }
            });
        }

        /**
         * 更新数据状态显示
         */
        function updateDataStatus(count) {
            const statusEl = document.getElementById('statusValue');
            if (statusEl) {
                if (count > 0) {
                    const filteredCount = filteredData ? filteredData.length : 0;
                    statusEl.innerHTML = `
                        <span>已载入 ${count.toLocaleString()} 条记录</span>
                        <span style="color: #6c757d;">筛选后：${filteredCount.toLocaleString()} 条</span>
                    `;
                } else {
                    statusEl.textContent = '尚未载入数据';
                }
            }
        }

        /**
         * 初始化日期范围（默认当周+未来3周）
         */
        function initDateRange() {
            // 计算当周+未来3周的日期范围
            const today = new Date();
            const currentWeekStart = getWeekStart(today); // 当周周日
            const future3WeeksEnd = new Date(currentWeekStart);
            future3WeeksEnd.setDate(currentWeekStart.getDate() + (APP_CONFIG.DEFAULT_WEEK_COUNT * 7) - 1); // 未来3周的周六

            // 设置日期输入框
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput && endDateInput) {
                startDateInput.value = formatDateForInput(currentWeekStart);
                endDateInput.value = formatDateForInput(future3WeeksEnd);
            }

            // 绑定重置按钮
            const resetBtn = document.getElementById('resetDateRangeDefault');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (startDateInput && endDateInput) {
                        startDateInput.value = formatDateForInput(currentWeekStart);
                        endDateInput.value = formatDateForInput(future3WeeksEnd);
                        applyFilters();
                    }
                });
            }
        }

        /**
         * 获取当周周日（周从周日开始）
         */
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0=周日, 1=周一, ..., 6=周六
            const diff = d.getDate() - day; // 减去天数差，得到周日
            return new Date(d.setDate(diff));
        }

        /**
         * 格式化日期为 input[type="date"] 格式 (YYYY-MM-DD)
         */
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * 初始化筛选器选项
         */
        function initFilterOptions() {
            if (rawData.length === 0) return;

            // 获取所有唯一值
            const deptSet = new Set();
            const tradeSet = new Set();
            const expLineSet = new Set();
            const typeSet = new Set();
            const areaSet = new Set();
            const dlySet = new Set();

            rawData.forEach(row => {
                // 获取列值（需要根据实际Excel列名调整）
                const dept = getColumnValue(row, COLUMN_MAP.DEPT);
                const trade = getColumnValue(row, COLUMN_MAP.TRADE);
                const expLine = getColumnValue(row, COLUMN_MAP.EXP_LINE);
                const type = getColumnValue(row, COLUMN_MAP.TYPE) || 'FAK'; // 空白标记为FAK
                const area = getColumnValue(row, COLUMN_MAP.AREA);
                const dly = getColumnValue(row, COLUMN_MAP.DLY);

                if (dept) deptSet.add(dept);
                if (trade) tradeSet.add(trade);
                if (expLine) expLineSet.add(expLine);
                if (type) typeSet.add(type);
                if (area) areaSet.add(area);
                if (dly) dlySet.add(dly);
            });

            // 填充筛选器选项
            populateFilter('deptFilter', Array.from(deptSet).sort());
            populateFilter('tradeFilter', Array.from(tradeSet).sort());
            populateFilter('expLineFilter', Array.from(expLineSet).sort());
            populateFilter('typeFilter', Array.from(typeSet).sort());
            populateFilter('areaFilter', Array.from(areaSet).sort());
            populateFilter('dlyFilter', Array.from(dlySet).sort());

            // 默认全部选中"全部"选项
            selectAllOption('deptFilter');
            selectAllOption('tradeFilter');
            selectAllOption('expLineFilter');
            selectAllOption('typeFilter');
            selectAllOption('areaFilter');
            selectAllOption('dlyFilter');
            selectAllOption('containerTypeFilter');
            selectAllOption('commodityFilter');
        }

        /**
         * 填充筛选器选项
         */
        function populateFilter(filterId, values) {
            const filter = document.getElementById(filterId);
            if (!filter) return;

            // 保留第一个"全部"选项
            const firstOption = filter.querySelector('option[value=""]');
            filter.innerHTML = '';
            if (firstOption) {
                filter.appendChild(firstOption);
            }

            // 添加选项
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                filter.appendChild(option);
            });
        }

        /**
         * 全选筛选器选项
         */
        function selectAllOptions(filterId) {
            const filter = document.getElementById(filterId);
            if (!filter) return;
            Array.from(filter.options).forEach(opt => {
                if (opt.value !== '') {
                    opt.selected = true;
                }
            });
        }

        /**
         * 选中"全部"选项（用于 containerTypeFilter 和 commodityFilter）
         */
        function selectAllOption(filterId) {
            const filter = document.getElementById(filterId);
            if (!filter) return;
            const allOption = filter.querySelector('option[value=""]');
            if (allOption) {
                allOption.selected = true;
            } else {
                // 如果没有"全部"选项，则选中所有选项
                selectAllOptions(filterId);
            }
        }

        /**
         * 获取列值（根据Excel列名）
         * XLSX.utils.sheet_to_json 默认将第一行作为键名，如果第一行是数据，键名可能是列索引
         * 这里尝试多种方式获取列值
         */
        function getColumnValue(row, columnLetter) {
            if (!columnLetter || !row) return null;
            
            // Excel列名转索引：A=0, B=1, ..., Z=25, AA=26, AB=27, ...
            const columnIndex = excelColumnToIndex(columnLetter);
            if (columnIndex < 0) return null;
            
            // 方法1：尝试直接使用列索引作为键（XLSX可能使用这种方式）
            const keys = Object.keys(row);
            
            // 如果键名是数字字符串，直接使用索引
            if (keys[columnIndex] !== undefined) {
                const value = row[keys[columnIndex]];
                if (value !== undefined && value !== null && value !== '') {
                    return value;
                }
            }
            
            // 方法2：尝试使用列字母作为键（某些情况下XLSX会使用列字母）
            if (row[columnLetter] !== undefined) {
                return row[columnLetter];
            }
            
            // 方法3：尝试查找包含列索引的键
            const keyWithIndex = keys.find(key => {
                // 检查键名是否匹配列索引（如"__EMPTY_1"对应B列等）
                const match = key.match(/_(\d+)$/);
                if (match) {
                    return parseInt(match[1]) === columnIndex;
                }
                return false;
            });
            if (keyWithIndex) {
                return row[keyWithIndex];
            }
            
            return null;
        }

        /**
         * Excel列名转索引（A=0, B=1, ..., Z=25, AA=26, ...）
         */
        function excelColumnToIndex(columnLetter) {
            if (!columnLetter) return -1;
            let result = 0;
            const up = columnLetter.trim().toUpperCase();
            for (let i = 0; i < up.length; i++) {
                const charCode = up.charCodeAt(i);
                if (charCode < 65 || charCode > 90) return -1; // 不是A-Z
                result = result * 26 + (charCode - 64);
            }
            return result - 1;
        }

        /**
         * 索引转Excel列名（0=A, 1=B, ..., 25=Z, 26=AA, ...）
         */
        function indexToExcelColumn(index) {
            let result = '';
            index++; // Excel列从1开始（A=1, B=2, ...）
            while (index > 0) {
                index--;
                result = String.fromCharCode(65 + (index % 26)) + result;
                index = Math.floor(index / 26);
            }
            return result;
        }

        /**
         * 初始化筛选器
         */
        function initFilters() {
            // 绑定搜索功能
            const searchInputs = [
                { input: 'deptSearch', filter: 'deptFilter' },
                { input: 'tradeSearch', filter: 'tradeFilter' },
                { input: 'expLineSearch', filter: 'expLineFilter' },
                { input: 'typeSearch', filter: 'typeFilter' },
                { input: 'containerTypeSearch', filter: 'containerTypeFilter' },
                { input: 'commoditySearch', filter: 'commodityFilter' },
                { input: 'areaSearch', filter: 'areaFilter' },
                { input: 'dlySearch', filter: 'dlyFilter' }
            ];

            searchInputs.forEach(({ input, filter }) => {
                const inputEl = document.getElementById(input);
                const filterEl = document.getElementById(filter);
                if (inputEl && filterEl) {
                    inputEl.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        Array.from(filterEl.options).forEach(opt => {
                            const text = opt.textContent.toLowerCase();
                            opt.style.display = text.includes(searchTerm) ? '' : 'none';
                        });
                    });
                }
            });

            // 绑定全选/清除按钮
            document.querySelectorAll('[data-action="select-all"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterName = e.target.getAttribute('data-filter');
                    const filterId = `${filterName}Filter`;
                    const filter = document.getElementById(filterId);
                    if (filter) {
                        Array.from(filter.options).forEach(opt => {
                            if (opt.value !== '') opt.selected = true;
                        });
                        applyFilters();
                    }
                });
            });

            document.querySelectorAll('[data-action="clear-all"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterName = e.target.getAttribute('data-filter');
                    const filterId = `${filterName}Filter`;
                    const filter = document.getElementById(filterId);
                    if (filter) {
                        Array.from(filter.options).forEach(opt => opt.selected = false);
                        applyFilters();
                    }
                });
            });

            // 防抖函数 - 优化性能
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // 防抖版本的applyFilters
            const debouncedApplyFilters = debounce(() => {
                requestAnimationFrame(() => {
                    applyFilters();
                });
            }, 150);

            // 生成筛选器哈希值（用于缓存）
            function getFilterHash() {
                const filterIds = ['deptFilter', 'tradeFilter', 'expLineFilter', 'typeFilter', 
                                 'containerTypeFilter', 'commodityFilter', 'areaFilter', 'dlyFilter'];
                const startDate = document.getElementById('startDate')?.value || '';
                const endDate = document.getElementById('endDate')?.value || '';
                
                const filterValues = filterIds.map(id => {
                    const el = document.getElementById(id);
                    if (!el) return '';
                    return Array.from(el.selectedOptions).map(opt => opt.value).sort().join(',');
                });
                
                return `${startDate}|${endDate}|${filterValues.join('|')}`;
            }

            // 缓存变量
            let lastFilterHash = '';

            // 绑定筛选器变化事件（使用防抖优化）
            const filterIds = ['deptFilter', 'tradeFilter', 'expLineFilter', 'typeFilter', 
                              'containerTypeFilter', 'commodityFilter', 'areaFilter', 'dlyFilter'];
            filterIds.forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.addEventListener('change', debouncedApplyFilters);
                }
            });

            // 绑定日期变化事件（使用防抖优化）
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            if (startDate) startDate.addEventListener('change', debouncedApplyFilters);
            if (endDate) endDate.addEventListener('change', debouncedApplyFilters);
        }

        /**
         * 应用筛选器（优化版本 - 带缓存和性能优化）
         */
        function applyFilters() {
            if (rawData.length === 0) return;

            // 检查缓存（需要在initFilters中定义的getFilterHash和lastFilterHash）
            if (typeof getFilterHash === 'function') {
                const currentFilterHash = getFilterHash();
                if (typeof lastFilterHash !== 'undefined' && currentFilterHash === lastFilterHash && filteredData && filteredData.length > 0) {
                    debugLog('[Monitor-MSQ1D890] 使用缓存结果');
                    return;
                }
                if (typeof lastFilterHash !== 'undefined') {
                    lastFilterHash = currentFilterHash;
                }
            }

            // 使用 requestAnimationFrame 优化大数据量筛选
            requestAnimationFrame(() => {
                filteredData = rawData.filter(row => {
                    // 日期筛选
                    const sailDate = getColumnValue(row, COLUMN_MAP.SAIL_DATE);
                    if (!isDateInRange(sailDate)) return false;

                    // Dept筛选
                    if (!isFilterMatch(row, COLUMN_MAP.DEPT, 'deptFilter')) return false;

                    // Trade筛选
                    if (!isFilterMatch(row, COLUMN_MAP.TRADE, 'tradeFilter')) return false;

                    // EXP LINE筛选
                    if (!isFilterMatch(row, COLUMN_MAP.EXP_LINE, 'expLineFilter')) return false;

                    // TYPE筛选（空白标记为FAK）
                    const type = getColumnValue(row, COLUMN_MAP.TYPE) || 'FAK';
                    if (!isFilterMatchValue(type, 'typeFilter')) return false;

                    // DRY/REEFER/SPECIAL筛选
                    if (!isContainerTypeMatch(row)) return false;

                    // Commodity Item筛选
                    if (!isCommodityMatch(row)) return false;

                    // AREA筛选
                    if (!isFilterMatch(row, COLUMN_MAP.AREA, 'areaFilter')) return false;

                    // DLY筛选
                    if (!isFilterMatch(row, COLUMN_MAP.DLY, 'dlyFilter')) return false;

                    return true;
                });

                debugLog(`[Monitor-MSQ1D890] 筛选后数据: ${filteredData.length} 条`);

                // 更新数据状态显示（显示筛选后的数据条数）
                if (rawData.length > 0) {
                    updateDataStatus(rawData.length);
                }

                // 更新分析结果（使用 requestAnimationFrame 优化渲染）
                requestAnimationFrame(() => {
                    updateAnalysis();
                });
            });
        }

        /**
         * 检查日期是否在范围内
         */
        function isDateInRange(dateValue) {
            if (!dateValue) return false;

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (!startDateInput || !endDateInput) return true;

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            if (!startDate || !endDate) return true;

            // 解析日期值（可能是Excel序列号或字符串）
            let date = null;
            const parseExcelDateFunc = (typeof window !== 'undefined' && typeof window.parseExcelDateSerial === 'function')
                ? window.parseExcelDateSerial
                : (typeof parseExcelDateSerial === 'function' ? parseExcelDateSerial : null);
            const parseStringDateFunc = (typeof window !== 'undefined' && typeof window.parseStringDate === 'function')
                ? window.parseStringDate
                : (typeof parseStringDate === 'function' ? parseStringDate : null);
            
            if (typeof dateValue === 'number' && parseExcelDateFunc) {
                date = parseExcelDateFunc(dateValue);
            } else if (typeof dateValue === 'string' && parseStringDateFunc) {
                date = parseStringDateFunc(dateValue);
            }

            if (!date) return false;

            // 比较日期（只比较年月日）
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const startOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const endOnly = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

            return dateOnly >= startOnly && dateOnly <= endOnly;
        }

        /**
         * 性能优化：预先获取筛选器选中的值
         */
        function getFilterSelectedValues(filterId) {
            const filter = document.getElementById(filterId);
            if (!filter) return null;
            const selectedValues = Array.from(filter.selectedOptions).map(opt => opt.value);
            return {
                values: selectedValues,
                hasAll: selectedValues.includes(''),
                isEmpty: selectedValues.length === 0
            };
        }

        /**
         * 性能优化：使用缓存的筛选器值进行匹配
         */
        function isFilterMatchCached(value, filterCache) {
            if (!filterCache) return true;
            if (filterCache.isEmpty) return false;
            if (filterCache.hasAll) return true;
            return filterCache.values.includes(String(value || ''));
        }

        /**
         * 检查筛选器匹配（保留向后兼容）
         */
        function isFilterMatch(row, columnLetter, filterId) {
            const value = getColumnValue(row, columnLetter);
            return isFilterMatchValue(value, filterId);
        }

        /**
         * 检查筛选器值匹配（保留向后兼容）
         */
        function isFilterMatchValue(value, filterId) {
            const filterCache = getFilterSelectedValues(filterId);
            return isFilterMatchCached(value, filterCache);
        }

        /**
         * 性能优化：使用缓存的容器类型匹配
         */
        function isContainerTypeMatchCached(row, filterCache) {
            if (!filterCache) return true;
            if (filterCache.isEmpty) return false;
            if (filterCache.hasAll) return true;

            const dry = getColumnValue(row, COLUMN_MAP.DRY);
            const reefer = getColumnValue(row, COLUMN_MAP.REEFER);
            const special = getColumnValue(row, COLUMN_MAP.SPECIAL);

            // 检查是否有选中的类型且对应列不为0
            const hasDry = filterCache.values.includes('DRY') && (dry && Number(dry) !== 0);
            const hasReefer = filterCache.values.includes('REEFER') && (reefer && Number(reefer) !== 0);
            const hasSpecial = filterCache.values.includes('SPECIAL') && (special && Number(special) !== 0);

            return hasDry || hasReefer || hasSpecial;
        }

        /**
         * 检查容器类型匹配（DRY/REEFER/SPECIAL）（保留向后兼容）
         */
        function isContainerTypeMatch(row) {
            const filterCache = getFilterSelectedValues('containerTypeFilter');
            return isContainerTypeMatchCached(row, filterCache);
        }

        /**
         * 检查Commodity Item匹配
         * 规则：
         * 1. 如果品名是"Reefer - xxx"，归类为"Live Reefer"
         * 2. 如果有品名且AH列Reefer不为0，归类为"NOR"
         * 3. 其他归类为"Non Reefer"
         */
        function isCommodityMatch(row) {
            const filter = document.getElementById('commodityFilter');
            if (!filter) return true;

            const selectedCommodities = Array.from(filter.selectedOptions).map(opt => opt.value);
            if (selectedCommodities.length === 0) return false;
            if (selectedCommodities.includes('')) return true; // 选择了"全部"

            // 获取品名
            // 由于用户未明确指定品名列位置，我们尝试从所有列中查找品名
            // 优先查找包含"Reefer -"的内容，或者查找可能包含品名的列
            let commodityName = '';
            
            // 方法1：查找所有列，看是否有包含"Reefer -"的内容（冻柜品名特征）
            const keys = Object.keys(row);
            for (const key of keys) {
                const value = row[key];
                if (value && typeof value === 'string') {
                    const valueStr = value.toString().trim();
                    if (valueStr.toLowerCase().startsWith('reefer -')) {
                        commodityName = valueStr;
                        break;
                    }
                }
            }
            
            // 方法2：如果没找到"Reefer -"，尝试查找其他可能的品名列
            // 通常品名列可能在某个位置，这里先尝试查找非空字符串值作为品名
            if (!commodityName) {
                for (const key of keys) {
                    const value = row[key];
                    if (value && typeof value === 'string') {
                        const valueStr = value.toString().trim();
                        // 跳过一些明显不是品名的列（如日期、数字等）
                        if (valueStr.length > 0 && 
                            !valueStr.match(/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/) && // 不是日期格式
                            !valueStr.match(/^\d+$/) && // 不是纯数字
                            valueStr.length < 100) { // 长度合理
                            commodityName = valueStr;
                            break; // 找到第一个可能的品名就停止
                        }
                    }
                }
            }
            
            const reefer = getColumnValue(row, COLUMN_MAP.REEFER);

            // 判断Commodity Item类型
            let commodityType = 'Non Reefer';
            if (commodityName && commodityName.toString().toLowerCase().startsWith('reefer -')) {
                commodityType = 'Live Reefer';
            } else if (commodityName && reefer && Number(reefer) !== 0) {
                commodityType = 'NOR';
            }

            return selectedCommodities.includes(commodityType);
        }

        /**
         * 初始化维度选择
         */
        function initDimensionSelection() {
            const dimensionBtns = document.querySelectorAll('.dimension-btn');
            dimensionBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // 更新按钮状态
                    dimensionBtns.forEach(b => {
                        b.classList.remove('active');
                        b.style.border = '2px solid #dee2e6';
                        b.style.background = 'white';
                        b.style.color = '#495057';
                    });

                    e.target.classList.add('active');
                    e.target.style.border = '2px solid #3E62AD';
                    e.target.style.background = '#3E62AD';
                    e.target.style.color = 'white';

                    // 更新当前维度
                    currentDimension = e.target.getAttribute('data-dimension');

                    // 更新描述
                    const descEl = document.getElementById('dimensionDesc');
                    if (descEl) {
                        const descMap = {
                            'sales-dept': 'Sales + Dept维度：按SalesID分组，按Dept（AMS/EMS/IAS）分类汇总',
                            'sales-week': 'Sales + Week维度：按SalesID分组，按周别分类汇总',
                            'account-dept': 'Account + Dept维度：按Account分组，按Dept分类汇总',
                            'account-week': 'Account + Week维度：按Account分组，按周别分类汇总',
                            'vessel-dept': 'VSL/VOY + Dept维度：按ETD、EXP LINE、VSL/VOY分组，按Dept分类汇总',
                            'vessel-week': 'VSL/VOY + Week维度：按VSL/VOY分组，按周别分类汇总',
                            'vessel-gps': 'VSL/VOY + GPS维度：按ETD、航线、船名航次、Trade、POD分组，显示各柜型TEU和GPS，用于发现低价订舱',
                            'vessel-limit': 'VSL/VOY + Limit维度：按ETD、周、Trade、EXP LINE、VSL/VOY分组，显示TEU、占比、AVG GPS、TONS、TONS/TEU、Allocation、L/F'
                        };
                        descEl.textContent = descMap[currentDimension] || '';
                    }

                    // 更新分析结果
                    updateAnalysis();
                });
            });
        }

        /**
         * 更新分析结果
         */
        function updateAnalysis() {
            if (filteredData.length === 0) {
                document.getElementById('analysisTable').innerHTML = '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无数据</p>';
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无数据</p>';
                }
                updateStatsPanel(); // 更新统计面板
                return;
            }

            let result = '';
            switch (currentDimension) {
                case 'sales-dept':
                    result = generateSalesDeptAnalysis();
                    break;
                case 'sales-week':
                    result = generateSalesWeekAnalysis();
                    break;
                case 'account-dept':
                    result = generateAccountDeptAnalysis();
                    break;
                case 'account-week':
                    result = generateAccountWeekAnalysis();
                    break;
                case 'vessel-dept':
                    result = generateVesselDeptAnalysis();
                    break;
                case 'vessel-week':
                    result = generateVesselWeekAnalysis();
                    break;
                case 'vessel-gps':
                    result = generateVesselGpsAnalysis();
                    break;
                case 'vessel-limit':
                    result = generateVesselLimitAnalysis();
                    break;
                default:
                    result = '<p style="padding: 20px; text-align: center; color: #6c757d;">请选择分析维度</p>';
            }

            document.getElementById('analysisTable').innerHTML = result;
            
            // 更新统计面板
            updateStatsPanel();
            
        }

        /**
         * 获取N到X列的所有列名（柜型列）
         */
        function getContainerTypeColumns() {
            const columns = [];
            const nIndex = excelColumnToIndex('N');
            const xIndex = excelColumnToIndex('X');
            for (let i = nIndex; i <= xIndex; i++) {
                columns.push(indexToExcelColumn(i));
            }
            return columns;
        }

        /**
         * 生成Sales+Dept维度分析
         */
        function generateSalesDeptAnalysis() {
            // 按SalesID分组，按Dept分类
            const grouped = {};
            const deptList = ['AMS', 'EMS', 'IAS'];
            
            // 性能优化：单次遍历完成所有计算
            const salesTotalTeu = {};
            const deptTotalTeu = {};
            
            filteredData.forEach(row => {
                const salesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                const dept = getColumnValue(row, COLUMN_MAP.DEPT) || '';
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                // 计算每个SalesID的总TEU
                if (!salesTotalTeu[salesId]) {
                    salesTotalTeu[salesId] = 0;
                }
                salesTotalTeu[salesId] += teu;
                
                // 计算每个Dept的总TEU
                if (!deptTotalTeu[dept]) {
                    deptTotalTeu[dept] = 0;
                }
                deptTotalTeu[dept] += teu;
                
                // 分组数据
                if (!grouped[salesId]) {
                    grouped[salesId] = {
                        salesId,
                        depts: {}
                    };
                }
                
                if (!grouped[salesId].depts[dept]) {
                    grouped[salesId].depts[dept] = {
                        dept,
                        teu: 0,
                        tons: 0,
                        gps: [],
                        count: 0
                    };
                }
                
                grouped[salesId].depts[dept].teu += teu;
                grouped[salesId].depts[dept].tons += tons;
                if (gps > 0) {
                    grouped[salesId].depts[dept].gps.push(gps);
                }
                grouped[salesId].depts[dept].count++;
            });
            
            // 生成表格 - 每个Dept都有完整的列
            let html = '<table style="width: 100%; border-collapse: collapse; background: white;"><thead>';
            // 第一行表头 - 使用主题蓝色渐变，白色字体和白色框线
            html += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;">SalesID</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">AMS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">EMS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">IAS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">TOTAL</th>';
            html += '</tr>';
            // 第二行表头 - 使用主题蓝色，白色字体和白色框线
            html += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            // AMS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // EMS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // IAS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // TOTAL列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            html += '</tr></thead><tbody>';
            
            // 按总TEU降序排序
            const sortedSalesIds = Object.keys(grouped).sort((a, b) => {
                const aTotal = (grouped[a].depts['AMS']?.teu || 0) + (grouped[a].depts['EMS']?.teu || 0) + (grouped[a].depts['IAS']?.teu || 0);
                const bTotal = (grouped[b].depts['AMS']?.teu || 0) + (grouped[b].depts['EMS']?.teu || 0) + (grouped[b].depts['IAS']?.teu || 0);
                return bTotal - aTotal; // 降序
            });
            
            sortedSalesIds.forEach(salesId => {
                const item = grouped[salesId];
                const amsData = item.depts['AMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const emsData = item.depts['EMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const iasData = item.depts['IAS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                
                // 计算每个Dept的指标
                const amsAvgGps = amsData.gps.length > 0 ? (amsData.gps.reduce((a, b) => a + b, 0) / amsData.gps.length).toFixed(2) : '0.00';
                const amsTonsPerTeu = amsData.teu > 0 ? (amsData.tons / amsData.teu).toFixed(4) : '0.0000';
                const amsPercentage = deptTotalTeu['AMS'] > 0 ? ((amsData.teu / deptTotalTeu['AMS']) * 100).toFixed(2) + '%' : '0.00%';
                
                const emsAvgGps = emsData.gps.length > 0 ? (emsData.gps.reduce((a, b) => a + b, 0) / emsData.gps.length).toFixed(2) : '0.00';
                const emsTonsPerTeu = emsData.teu > 0 ? (emsData.tons / emsData.teu).toFixed(4) : '0.0000';
                const emsPercentage = deptTotalTeu['EMS'] > 0 ? ((emsData.teu / deptTotalTeu['EMS']) * 100).toFixed(2) + '%' : '0.00%';
                
                const iasAvgGps = iasData.gps.length > 0 ? (iasData.gps.reduce((a, b) => a + b, 0) / iasData.gps.length).toFixed(2) : '0.00';
                const iasTonsPerTeu = iasData.teu > 0 ? (iasData.tons / iasData.teu).toFixed(4) : '0.0000';
                const iasPercentage = deptTotalTeu['IAS'] > 0 ? ((iasData.teu / deptTotalTeu['IAS']) * 100).toFixed(2) + '%' : '0.00%';
                
                // 计算TOTAL
                const totalTeu = amsData.teu + emsData.teu + iasData.teu;
                const totalTons = amsData.tons + emsData.tons + iasData.tons;
                const allGps = [...amsData.gps, ...emsData.gps, ...iasData.gps];
                const totalAvgGps = allGps.length > 0 ? (allGps.reduce((a, b) => a + b, 0) / allGps.length).toFixed(2) : '0.00';
                const totalTonsPerTeu = totalTeu > 0 ? (totalTons / totalTeu).toFixed(4) : '0.0000';
                const totalDeptTeu = deptTotalTeu['AMS'] + deptTotalTeu['EMS'] + deptTotalTeu['IAS'];
                const totalPercentage = totalDeptTeu > 0 ? ((totalTeu / totalDeptTeu) * 100).toFixed(2) + '%' : '0.00%';
                
                html += `<tr class="sales-row" data-sales-id="${escapeHtml(salesId)}" style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="showSalesDetail('${escapeHtml(salesId)}')">`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">${escapeHtml(salesId)}</td>`;
                
                // AMS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsTonsPerTeu}</td>`;
                
                // EMS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsTonsPerTeu}</td>`;
                
                // IAS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasTonsPerTeu}</td>`;
                
                // TOTAL列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTonsPerTeu}</td>`;
                html += '</tr>';
            });
            
            // 合计行
            let totalAmsTeu = 0, totalAmsTons = 0, totalAmsGps = [];
            let totalEmsTeu = 0, totalEmsTons = 0, totalEmsGps = [];
            let totalIasTeu = 0, totalIasTons = 0, totalIasGps = [];
            
            sortedSalesIds.forEach(salesId => {
                const item = grouped[salesId];
                const amsData = item.depts['AMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const emsData = item.depts['EMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const iasData = item.depts['IAS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                
                totalAmsTeu += amsData.teu;
                totalAmsTons += amsData.tons;
                totalAmsGps.push(...amsData.gps);
                
                totalEmsTeu += emsData.teu;
                totalEmsTons += emsData.tons;
                totalEmsGps.push(...emsData.gps);
                
                totalIasTeu += iasData.teu;
                totalIasTons += iasData.tons;
                totalIasGps.push(...iasData.gps);
            });
            
            const totalAmsAvgGps = totalAmsGps.length > 0 ? (totalAmsGps.reduce((a, b) => a + b, 0) / totalAmsGps.length).toFixed(2) : '0.00';
            const totalAmsTonsPerTeu = totalAmsTeu > 0 ? (totalAmsTons / totalAmsTeu).toFixed(4) : '0.0000';
            const totalAmsPercentage = deptTotalTeu['AMS'] > 0 ? ((totalAmsTeu / deptTotalTeu['AMS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalEmsAvgGps = totalEmsGps.length > 0 ? (totalEmsGps.reduce((a, b) => a + b, 0) / totalEmsGps.length).toFixed(2) : '0.00';
            const totalEmsTonsPerTeu = totalEmsTeu > 0 ? (totalEmsTons / totalEmsTeu).toFixed(4) : '0.0000';
            const totalEmsPercentage = deptTotalTeu['EMS'] > 0 ? ((totalEmsTeu / deptTotalTeu['EMS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalIasAvgGps = totalIasGps.length > 0 ? (totalIasGps.reduce((a, b) => a + b, 0) / totalIasGps.length).toFixed(2) : '0.00';
            const totalIasTonsPerTeu = totalIasTeu > 0 ? (totalIasTons / totalIasTeu).toFixed(4) : '0.0000';
            const totalIasPercentage = deptTotalTeu['IAS'] > 0 ? ((totalIasTeu / deptTotalTeu['IAS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalTeu = totalAmsTeu + totalEmsTeu + totalIasTeu;
            const totalTons = totalAmsTons + totalEmsTons + totalIasTons;
            const allTotalGps = [...totalAmsGps, ...totalEmsGps, ...totalIasGps];
            const totalAvgGps = allTotalGps.length > 0 ? (allTotalGps.reduce((a, b) => a + b, 0) / allTotalGps.length).toFixed(2) : '0.00';
            const totalTonsPerTeu = totalTeu > 0 ? (totalTons / totalTeu).toFixed(4) : '0.0000';
            const totalDeptTeu = deptTotalTeu['AMS'] + deptTotalTeu['EMS'] + deptTotalTeu['IAS'];
            const totalPercentage = totalDeptTeu > 0 ? ((totalTeu / totalDeptTeu) * 100).toFixed(2) + '%' : '0.00%';
            
            html += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">合计</td>';
            
            // AMS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTonsPerTeu}</td>`;
            
            // EMS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTonsPerTeu}</td>`;
            
            // IAS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTonsPerTeu}</td>`;
            
            // TOTAL合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTonsPerTeu}</td>`;
            html += '</tr>';
            
            html += '</tbody></table>';
            return html;
        }

        /**
         * 获取列名对应的柜型名称（N~X列）
         */
        function getContainerTypeName(columnLetter) {
            // 根据列索引映射柜型名称
            const nIndex = excelColumnToIndex('N');
            const xIndex = excelColumnToIndex('X');
            const colIndex = excelColumnToIndex(columnLetter);
            
            // 常见的柜型列映射（可能需要根据实际Excel调整）
            const typeMap = {
                'N': '2SD', 'O': '2RS', 'P': '4SD', 'Q': '4SH', 'R': '5SH',
                'S': '4RH', 'T': '2FO', 'U': '2FC', 'V': '4FO', 'W': '4FC'
            };
            
            return typeMap[columnLetter] || columnLetter;
        }

        /**
         * 显示Sales详情
         */
        function showSalesDetail(salesId) {
            const salesData = filteredData.filter(row => {
                const id = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                return id === salesId;
            });
            
            if (salesData.length === 0) return;
            
            // 根据当前维度决定显示内容
            const isWeekView = currentDimension === 'sales-week';
            
            let tableHtml = '';
            
            if (isWeekView) {
                // Sales + Week 模式：显示4周的数据
                // 从数据中收集所有实际存在的周别代码（从AE列）
                const actualWeekCodes = new Set();
                salesData.forEach(row => {
                    const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                    if (weekValue) {
                        const weekCode = parseWeekValue(weekValue);
                        if (weekCode) {
                            actualWeekCodes.add(weekCode);
                        }
                    }
                });
                
                if (actualWeekCodes.size === 0) {
                    alert('该SalesID暂无周别数据');
                    return;
                }
                
                // 获取所有周别代码，按时间顺序排序（52, 53, 1, 2, 3...）
                const allWeekCodes = Array.from(actualWeekCodes);
                const sorted = sortWeekCodes(allWeekCodes);
                
                // 取前4个周别（当周+未来3周）
                const finalWeekCodes = sorted.slice(0, 4);
                
                // 计算每个周别的总TEU（用于计算占比）
                const weekTotalTeu = {};
                salesData.forEach(row => {
                    const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                    if (!weekValue) return;
                    
                    const weekCode = parseWeekValue(weekValue);
                    if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                    
                    const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                    if (!weekTotalTeu[weekCode]) {
                        weekTotalTeu[weekCode] = 0;
                    }
                    weekTotalTeu[weekCode] += teu;
                });
                
                // 按SQ/SC分组，然后按周别统计
                const sqScGroups = {};
                let totalSalesTeu = 0;
                let totalSalesTons = 0;
                const allSalesGps = [];
                
                salesData.forEach(row => {
                    const sqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                    const sqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                    const key = `${sqSc}|${sqScName}`;
                    const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                    
                    if (!weekValue) return;
                    const weekCode = parseWeekValue(weekValue);
                    if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                    
                    if (!sqScGroups[key]) {
                        sqScGroups[key] = {
                            sqSc,
                            sqScName,
                            weeks: {}
                        };
                    }
                    
                    if (!sqScGroups[key].weeks[weekCode]) {
                        sqScGroups[key].weeks[weekCode] = {
                            teu: 0,
                            tons: 0,
                            gps: []
                        };
                    }
                    
                    const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                    const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                    const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                    
                    sqScGroups[key].weeks[weekCode].teu += teu;
                    sqScGroups[key].weeks[weekCode].tons += tons;
                    if (gps > 0) {
                        sqScGroups[key].weeks[weekCode].gps.push(gps);
                    }
                    
                    totalSalesTeu += teu;
                    totalSalesTons += tons;
                    if (gps > 0) {
                        allSalesGps.push(gps);
                    }
                });
                
                const avgSalesGps = allSalesGps.length > 0 ? (allSalesGps.reduce((a, b) => a + b, 0) / allSalesGps.length).toFixed(2) : '0.00';
                const salesTonsPerTeu = totalSalesTeu > 0 ? (totalSalesTons / totalSalesTeu).toFixed(4) : '0.0000';
                
                // 生成表格 - 两行表头
                const otherColWidth = (88 / (2 + finalWeekCodes.length * 5)).toFixed(2) + '%';
                tableHtml = '<div class="detail-table-container"><table style="width: 100%; table-layout: fixed; border-collapse: collapse; background: white;"><thead>';
                // 第一行表头
                tableHtml += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: 12%; color: white;">SQ/SC NAME</th>`;
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: ${otherColWidth}; color: white;">SQ/SC</th>`;
                finalWeekCodes.forEach(weekCode => {
                    tableHtml += `<th style="padding: 12px; text-align: center; border: 1px solid white; color: white;" colspan="5">${weekCode}</th>`;
                });
                tableHtml += '</tr>';
                // 第二行表头
                tableHtml += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; color: white;"></th>`;
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; color: white;"></th>`;
                finalWeekCodes.forEach(() => {
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">TEU</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">占比</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">AVG GPS</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">TONS</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">TONS/TEU</th>';
                });
                tableHtml += '</tr></thead><tbody>';
                
                // 按总TEU降序排序
                const sortedKeys = Object.keys(sqScGroups).sort((a, b) => {
                    let aTotal = 0, bTotal = 0;
                    Object.values(sqScGroups[a].weeks).forEach(weekData => {
                        aTotal += weekData.teu || 0;
                    });
                    Object.values(sqScGroups[b].weeks).forEach(weekData => {
                        bTotal += weekData.teu || 0;
                    });
                    return bTotal - aTotal;
                });
                
                sortedKeys.forEach(key => {
                    const item = sqScGroups[key];
                    
                    // 为onclick准备筛选参数（Sales + Week模式）
                    const filterParams = {
                        salesId: salesId,
                        sqScName: item.sqScName,
                        sqSc: item.sqSc
                    };
                    // 注意：Week模式需要根据点击的行来确定weekCode，这里先不传weekCode，显示所有周的数据
                    // 使用data属性存储JSON，避免在onclick属性中的引号冲突
                    const jsonStr = JSON.stringify(filterParams);
                    const escapedJsonForAttr = jsonStr.replace(/"/g, '&quot;');
                    
                    tableHtml += `<tr style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" data-filter-params="${escapedJsonForAttr}" onclick="window.showBlDetail(this.getAttribute(&quot;data-filter-params&quot;))">`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.sqScName)}">${escapeHtml(item.sqScName)}</td>`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.sqSc)}</td>`;
                    
                    // 每个周别的列
                    finalWeekCodes.forEach(weekCode => {
                        const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [] };
                        const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                        const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                        const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                        
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.teu.toFixed(0)}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${percentage}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${avgGps}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.tons.toFixed(2)}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${tonsPerTeu}</td>`;
                    });
                    
                    tableHtml += '</tr>';
                });
                
                // 总计行
                tableHtml += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%;">总计</td>`;
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth};"></td>`;
                
                finalWeekCodes.forEach(weekCode => {
                    let weekTotalTeuSum = 0, weekTotalTonsSum = 0, weekAllGps = [];
                    Object.values(sqScGroups).forEach(item => {
                        const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [] };
                        weekTotalTeuSum += weekData.teu;
                        weekTotalTonsSum += weekData.tons;
                        weekAllGps.push(...weekData.gps);
                    });
                    const weekAvgGps = weekAllGps.length > 0 ? (weekAllGps.reduce((a, b) => a + b, 0) / weekAllGps.length).toFixed(2) : '0.00';
                    const weekTonsPerTeu = weekTotalTeuSum > 0 ? (weekTotalTonsSum / weekTotalTeuSum).toFixed(4) : '0.0000';
                    const weekPercentage = weekTotalTeu[weekCode] > 0 ? ((weekTotalTeuSum / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                    
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekTotalTeuSum.toFixed(0)}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekPercentage}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekAvgGps}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekTotalTonsSum.toFixed(2)}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekTonsPerTeu}</td>`;
                });
                
                tableHtml += '</tr>';
                tableHtml += '</tbody></table></div>';
            } else {
                // Sales + Dept 模式：显示柜型数据（原有逻辑）
                // 按SQ/SC分组
                const sqScGroups = {};
                let totalSalesTeu = 0;
                let totalSalesTons = 0;
                const allSalesGps = [];
                
                salesData.forEach(row => {
                    const sqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                    const sqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                    const key = `${sqSc}|${sqScName}`;
                    
                    if (!sqScGroups[key]) {
                        sqScGroups[key] = {
                            sqSc,
                            sqScName,
                            containerTypes: {},
                            teu: 0,
                            tons: 0,
                            gps: []
                        };
                    }
                    
                    // 统计N~X列各种柜型
                    const containerTypes = getContainerTypeColumns();
                    containerTypes.forEach(col => {
                        const value = Number(getColumnValue(row, col) || 0);
                        if (value > 0) {
                            const typeName = getContainerTypeName(col);
                            if (!sqScGroups[key].containerTypes[typeName]) {
                                sqScGroups[key].containerTypes[typeName] = 0;
                            }
                            sqScGroups[key].containerTypes[typeName] += value;
                        }
                    });
                    
                    const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                    const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                    const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                    
                    sqScGroups[key].teu += teu;
                    sqScGroups[key].tons += tons;
                    if (gps > 0) {
                        sqScGroups[key].gps.push(gps);
                    }
                    
                    totalSalesTeu += teu;
                    totalSalesTons += tons;
                    if (gps > 0) {
                        allSalesGps.push(gps);
                    }
                });
                
                const avgSalesGps = allSalesGps.length > 0 ? (allSalesGps.reduce((a, b) => a + b, 0) / allSalesGps.length).toFixed(2) : '0.00';
                const salesTonsPerTeu = totalSalesTeu > 0 ? (totalSalesTons / totalSalesTeu).toFixed(4) : '0.0000';
                
                // 生成表格内容
                // 生成表格 - SQ/SC NAME占12%，其他16列均分88%
                const otherColWidth = (88 / 16).toFixed(2) + '%';
                tableHtml = '<div class="detail-table-container"><table style="width: 100%; table-layout: fixed;">';
                tableHtml += '<thead><tr style="background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); color: white;">';
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: 12%; color: white;">SQ/SC NAME</th>`;
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: ${otherColWidth}; color: white;">SQ/SC</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2SD</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2RS</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4SD</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4SH</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">5SH</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4RH</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2FO</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2FC</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4FO</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4FC</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TTL TEU</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">百分比</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">GPS</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TONS</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TONS/TEU</th>`;
                tableHtml += '</tr></thead><tbody>';
            
            // 按总TEU降序排序
            const sortedKeys = Object.keys(sqScGroups).sort((a, b) => {
                return sqScGroups[b].teu - sqScGroups[a].teu; // 降序
            });
            
            // 先计算所有百分比，确保总和为 100%
            const percentages = [];
            let totalPercentage = 0;
            
            // 第一遍：计算所有百分比（保留两位小数）
            sortedKeys.forEach((key, index) => {
                const item = sqScGroups[key];
                let percentage = totalSalesTeu > 0 ? (item.teu / totalSalesTeu) * 100 : 0;
                
                // 除了最后一项，都四舍五入到两位小数
                if (index < sortedKeys.length - 1) {
                    percentage = Math.round(percentage * 100) / 100;
                    totalPercentage += percentage;
                    percentages.push(percentage);
                } else {
                    // 最后一项：调整百分比使总和为 100%
                    percentage = Math.round((100 - totalPercentage) * 100) / 100;
                    percentages.push(percentage);
                }
            });
            
            sortedKeys.forEach((key, index) => {
                const item = sqScGroups[key];
                const itemAvgGps = item.gps.length > 0 ? (item.gps.reduce((a, b) => a + b, 0) / item.gps.length).toFixed(2) : '0.00';
                const itemTonsPerTeu = item.teu > 0 ? (item.tons / item.teu).toFixed(4) : '0.0000';
                const itemPercentage = percentages[index].toFixed(2) + '%';
                
                // 为onclick准备筛选参数
                const filterParams = {
                    salesId: salesId,
                    sqScName: item.sqScName,
                    sqSc: item.sqSc
                };
                // 使用data属性存储JSON，避免在onclick属性中的引号冲突
                const jsonStr = JSON.stringify(filterParams);
                const escapedJsonForAttr = jsonStr.replace(/"/g, '&quot;');
                
                tableHtml += `<tr style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" data-filter-params="${escapedJsonForAttr}" onclick="window.showBlDetail(this.getAttribute(&quot;data-filter-params&quot;))">`;
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.sqScName)}">${escapeHtml(item.sqScName)}</td>`;
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.sqSc)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2SD'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2RS'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4SD'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4SH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['5SH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4RH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2FO'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2FC'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4FO'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4FC'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600; width: ${otherColWidth};">${item.teu.toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemPercentage}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemAvgGps}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${item.tons.toFixed(2)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemTonsPerTeu}</td>`;
                tableHtml += '</tr>';
            });
            
            // 总计行 - 统计所有柜型的合计
            const totalContainerTypes = {};
            const containerTypeNames = ['2SD', '2RS', '4SD', '4SH', '5SH', '4RH', '2FO', '2FC', '4FO', '4FC'];
            Object.values(sqScGroups).forEach(item => {
                containerTypeNames.forEach(typeName => {
                    if (!totalContainerTypes[typeName]) {
                        totalContainerTypes[typeName] = 0;
                    }
                    totalContainerTypes[typeName] += (item.containerTypes[typeName] || 0);
                });
            });
            
            // 重新计算 TONS/TEU（应该是 totalSalesTons / totalSalesTeu）
            const correctTonsPerTeu = totalSalesTeu > 0 ? (totalSalesTons / totalSalesTeu).toFixed(4) : '0.0000';
            
            // 总计行
            tableHtml += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%;">总计</td>`;
            tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth};"></td>`;
            // 各种柜型的合计
            containerTypeNames.forEach(typeName => {
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalContainerTypes[typeName].toFixed(0)}</td>`;
            });
            // TTL TEU、百分比、GPS、TONS、TONS/TEU
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalSalesTeu.toFixed(0)}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">100.00%</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${avgSalesGps}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalSalesTons.toFixed(2)}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${correctTonsPerTeu}</td>`;
            tableHtml += '</tr>';
            
            tableHtml += '</tbody></table></div>';
            }
            
            // 创建并显示弹窗 - 分离遮罩层和内容层
            const modal = document.createElement('div');
            modal.id = 'detailModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            // 添加点击外部关闭功能
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDetailModal();
                }
            });
            
            // 创建内容容器
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;';
            
            // 阻止内容区域的点击冒泡
            modalContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 添加标题和关闭按钮
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;';
            header.innerHTML = `
                <h3 style="margin: 0; color: #333;">SalesID: ${escapeHtml(salesId)} 详情</h3>
                <button id="closeDetailModalBtn" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;">关闭</button>
            `;
            
            // 绑定关闭按钮
            header.querySelector('#closeDetailModalBtn').addEventListener('click', closeDetailModal);
            header.querySelector('#closeDetailModalBtn').addEventListener('mouseover', function() {
                this.style.background = '#2D4A7D';
            });
            header.querySelector('#closeDetailModalBtn').addEventListener('mouseout', function() {
                this.style.background = '#3E62AD';
            });
            
            // 组装内容
            modalContent.appendChild(header);
            modalContent.insertAdjacentHTML('beforeend', tableHtml);
            
            // 组装弹窗
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        /**
         * 显示Account详情（SQ/SC NAME详情）
         */
        function showAccountDetail(sqScName) {
            const accountData = filteredData.filter(row => {
                const name = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                return name === sqScName;
            });
            
            if (accountData.length === 0) return;
            
            // 根据当前维度决定显示内容
            const isWeekView = currentDimension === 'account-week';
            
            let tableHtml = '';
            
            if (isWeekView) {
                // Account + Week 模式：显示4周的数据
                // 从数据中收集所有实际存在的周别代码（从AE列）
                const actualWeekCodes = new Set();
                accountData.forEach(row => {
                    const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                    if (weekValue) {
                        const weekCode = parseWeekValue(weekValue);
                        if (weekCode) {
                            actualWeekCodes.add(weekCode);
                        }
                    }
                });
                
                if (actualWeekCodes.size === 0) {
                    alert('该Account暂无周别数据');
                    return;
                }
                
                // 获取所有周别代码，按时间顺序排序（52, 53, 1, 2, 3...）
                const allWeekCodes = Array.from(actualWeekCodes);
                const sorted = sortWeekCodes(allWeekCodes);
                
                // 取前4个周别（当周+未来3周）
                const finalWeekCodes = sorted.slice(0, 4);
                
                // 计算每个周别的总TEU（用于计算占比）
                const weekTotalTeu = {};
                accountData.forEach(row => {
                    const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                    if (!weekValue) return;
                    
                    const weekCode = parseWeekValue(weekValue);
                    if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                    
                    const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                    if (!weekTotalTeu[weekCode]) {
                        weekTotalTeu[weekCode] = 0;
                    }
                    weekTotalTeu[weekCode] += teu;
                });
                
                // 按SalesID和SQ/SC分组，然后按周别统计
                const salesGroups = {};
                let totalAccountTeu = 0;
                let totalAccountTons = 0;
                const allAccountGps = [];
                
                accountData.forEach(row => {
                    const salesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                    const sqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                    const key = `${salesId}|${sqSc}`;
                    const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                    
                    if (!weekValue) return;
                    const weekCode = parseWeekValue(weekValue);
                    if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                    
                    if (!salesGroups[key]) {
                        salesGroups[key] = {
                            salesId,
                            sqSc,
                            weeks: {}
                        };
                    }
                    
                    if (!salesGroups[key].weeks[weekCode]) {
                        salesGroups[key].weeks[weekCode] = {
                            teu: 0,
                            tons: 0,
                            gps: []
                        };
                    }
                    
                    const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                    const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                    const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                    
                    salesGroups[key].weeks[weekCode].teu += teu;
                    salesGroups[key].weeks[weekCode].tons += tons;
                    if (gps > 0) {
                        salesGroups[key].weeks[weekCode].gps.push(gps);
                    }
                    
                    totalAccountTeu += teu;
                    totalAccountTons += tons;
                    if (gps > 0) {
                        allAccountGps.push(gps);
                    }
                });
                
                const avgAccountGps = allAccountGps.length > 0 ? (allAccountGps.reduce((a, b) => a + b, 0) / allAccountGps.length).toFixed(2) : '0.00';
                const accountTonsPerTeu = totalAccountTeu > 0 ? (totalAccountTons / totalAccountTeu).toFixed(4) : '0.0000';
                
                // 生成表格 - 两行表头
                const salesIdColWidth = '12%';
                const sqScColWidth = (88 / (1 + finalWeekCodes.length * 5)).toFixed(2) + '%';
                tableHtml = '<div class="detail-table-container"><table style="width: 100%; table-layout: fixed; border-collapse: collapse; background: white;"><thead>';
                // 第一行表头
                tableHtml += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: ${salesIdColWidth}; color: white;">SalesID</th>`;
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: ${sqScColWidth}; color: white;">SQ/SC</th>`;
                finalWeekCodes.forEach(weekCode => {
                    tableHtml += `<th style="padding: 12px; text-align: center; border: 1px solid white; color: white;" colspan="5">${weekCode}</th>`;
                });
                tableHtml += '</tr>';
                // 第二行表头
                tableHtml += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; color: white;"></th>`;
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; color: white;"></th>`;
                finalWeekCodes.forEach(() => {
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">TEU</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">占比</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">AVG GPS</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">TONS</th>';
                    tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white; color: white;">TONS/TEU</th>';
                });
                tableHtml += '</tr></thead><tbody>';
                
                // 按总TEU降序排序
                const sortedKeys = Object.keys(salesGroups).sort((a, b) => {
                    let aTotal = 0, bTotal = 0;
                    Object.values(salesGroups[a].weeks).forEach(weekData => {
                        aTotal += weekData.teu || 0;
                    });
                    Object.values(salesGroups[b].weeks).forEach(weekData => {
                        bTotal += weekData.teu || 0;
                    });
                    return bTotal - aTotal;
                });
                
                sortedKeys.forEach(key => {
                    const item = salesGroups[key];
                    
                    // 为onclick准备筛选参数（Account + Week模式）
                    const filterParams = {
                        sqScName: sqScName,
                        salesId: item.salesId,
                        sqSc: item.sqSc
                    };
                    // 注意：Week模式需要根据点击的行来确定weekCode，这里先不传weekCode，显示所有周的数据
                    // 使用data属性存储JSON，避免在onclick属性中的引号冲突
                    const jsonStr = JSON.stringify(filterParams);
                    const escapedJsonForAttr = jsonStr.replace(/"/g, '&quot;');
                    
                    tableHtml += `<tr style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" data-filter-params="${escapedJsonForAttr}" onclick="window.showBlDetail(this.getAttribute(&quot;data-filter-params&quot;))">`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${salesIdColWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.salesId)}">${escapeHtml(item.salesId)}</td>`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${sqScColWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.sqSc)}">${escapeHtml(item.sqSc)}</td>`;
                    
                    // 每个周别的列
                    finalWeekCodes.forEach(weekCode => {
                        const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [] };
                        const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                        const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                        const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                        
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.teu.toFixed(0)}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${percentage}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${avgGps}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.tons.toFixed(2)}</td>`;
                        tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${tonsPerTeu}</td>`;
                    });
                    
                    tableHtml += '</tr>';
                });
                
                // 总计行
                tableHtml += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${salesIdColWidth};">总计</td>`;
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${sqScColWidth};"></td>`;
                
                finalWeekCodes.forEach(weekCode => {
                    let weekTotalTeuSum = 0, weekTotalTonsSum = 0, weekAllGps = [];
                    Object.values(salesGroups).forEach(item => {
                        const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [] };
                        weekTotalTeuSum += weekData.teu;
                        weekTotalTonsSum += weekData.tons;
                        weekAllGps.push(...weekData.gps);
                    });
                    const weekAvgGps = weekAllGps.length > 0 ? (weekAllGps.reduce((a, b) => a + b, 0) / weekAllGps.length).toFixed(2) : '0.00';
                    const weekTonsPerTeu = weekTotalTeuSum > 0 ? (weekTotalTonsSum / weekTotalTeuSum).toFixed(4) : '0.0000';
                    const weekPercentage = weekTotalTeu[weekCode] > 0 ? ((weekTotalTeuSum / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                    
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekTotalTeuSum.toFixed(0)}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekPercentage}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekAvgGps}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekTotalTonsSum.toFixed(2)}</td>`;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekTonsPerTeu}</td>`;
                });
                
                tableHtml += '</tr>';
                tableHtml += '</tbody></table></div>';
            } else {
                // Account + Dept 模式：显示柜型数据（原有逻辑）
                // 按SalesID和SQ/SC分组
                const salesGroups = {};
                let totalAccountTeu = 0;
                let totalAccountTons = 0;
                const allAccountGps = [];
                
                accountData.forEach(row => {
                    const salesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                    const sqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                    const key = `${salesId}|${sqSc}`;
                    
                    if (!salesGroups[key]) {
                        salesGroups[key] = {
                            salesId,
                            sqSc,
                            containerTypes: {},
                            teu: 0,
                            tons: 0,
                            gps: []
                        };
                    }
                    
                    // 统计N~X列各种柜型
                    const containerTypes = getContainerTypeColumns();
                    containerTypes.forEach(col => {
                        const value = Number(getColumnValue(row, col) || 0);
                        if (value > 0) {
                            const typeName = getContainerTypeName(col);
                            if (!salesGroups[key].containerTypes[typeName]) {
                                salesGroups[key].containerTypes[typeName] = 0;
                            }
                            salesGroups[key].containerTypes[typeName] += value;
                        }
                    });
                    
                    const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                    const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                    const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                    
                    salesGroups[key].teu += teu;
                    salesGroups[key].tons += tons;
                    if (gps > 0) {
                        salesGroups[key].gps.push(gps);
                    }
                    
                    totalAccountTeu += teu;
                    totalAccountTons += tons;
                    if (gps > 0) {
                        allAccountGps.push(gps);
                    }
                });
                
                const avgAccountGps = allAccountGps.length > 0 ? (allAccountGps.reduce((a, b) => a + b, 0) / allAccountGps.length).toFixed(2) : '0.00';
                const accountTonsPerTeu = totalAccountTeu > 0 ? (totalAccountTons / totalAccountTeu).toFixed(4) : '0.0000';
                
                // 计算该SQ/SC NAME的总TEU（用于计算百分比）
                let allAccountTotalTeu = 0;
                filteredData.forEach(row => {
                    const name = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                    if (name === sqScName) {
                        const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                        allAccountTotalTeu += teu;
                    }
                });
                const accountPercentage = allAccountTotalTeu > 0 ? ((totalAccountTeu / allAccountTotalTeu) * 100).toFixed(2) + '%' : '0.00%';
                
                // 生成表格内容
                // 生成表格 - SalesID占12%，其他16列均分88%
                const otherColWidth = (88 / 16).toFixed(2) + '%';
                tableHtml = '<div class="detail-table-container"><table style="width: 100%; table-layout: fixed;">';
                tableHtml += '<thead><tr style="background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); color: white;">';
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: 12%; color: white;">SalesID</th>`;
                tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: ${otherColWidth}; color: white;">SQ/SC</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2SD</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2RS</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4SD</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4SH</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">5SH</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4RH</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2FO</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2FC</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4FO</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4FC</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TTL TEU</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">百分比</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">GPS</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TONS</th>`;
                tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TONS/TEU</th>`;
                tableHtml += '</tr></thead><tbody>';
            
            // 按总TEU降序排序
            const sortedKeys = Object.keys(salesGroups).sort((a, b) => {
                return salesGroups[b].teu - salesGroups[a].teu; // 降序
            });
            sortedKeys.forEach(key => {
                const item = salesGroups[key];
                const itemAvgGps = item.gps.length > 0 ? (item.gps.reduce((a, b) => a + b, 0) / item.gps.length).toFixed(2) : '0.00';
                const itemTonsPerTeu = item.teu > 0 ? (item.tons / item.teu).toFixed(4) : '0.0000';
                const itemPercentage = totalAccountTeu > 0 ? ((item.teu / totalAccountTeu) * 100).toFixed(2) + '%' : '0.00%';
                
                // 为onclick准备筛选参数（Account + Dept模式）
                const filterParams = {
                    sqScName: sqScName,
                    salesId: item.salesId,
                    sqSc: item.sqSc
                };
                // 使用data属性存储JSON，避免在onclick属性中的引号冲突
                const jsonStr = JSON.stringify(filterParams);
                const escapedJsonForAttr = jsonStr.replace(/"/g, '&quot;');
                
                tableHtml += `<tr style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" data-filter-params="${escapedJsonForAttr}" onclick="window.showBlDetail(this.getAttribute(&quot;data-filter-params&quot;))">`;
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.salesId)}">${escapeHtml(item.salesId)}</td>`;
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.sqSc)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2SD'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2RS'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4SD'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4SH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['5SH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4RH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2FO'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2FC'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4FO'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4FC'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600; width: ${otherColWidth};">${item.teu.toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemPercentage}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemAvgGps}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${item.tons.toFixed(2)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemTonsPerTeu}</td>`;
                tableHtml += '</tr>';
            });
            
            // 总计行 - 统计所有柜型的合计
            const totalContainerTypes = {};
            const containerTypeNames = ['2SD', '2RS', '4SD', '4SH', '5SH', '4RH', '2FO', '2FC', '4FO', '4FC'];
            Object.values(salesGroups).forEach(item => {
                containerTypeNames.forEach(typeName => {
                    if (!totalContainerTypes[typeName]) {
                        totalContainerTypes[typeName] = 0;
                    }
                    totalContainerTypes[typeName] += (item.containerTypes[typeName] || 0);
                });
            });
            
            // 重新计算 TONS/TEU（应该是 totalAccountTons / totalAccountTeu）
            const correctTonsPerTeu = totalAccountTeu > 0 ? (totalAccountTons / totalAccountTeu).toFixed(4) : '0.0000';
            
            // 总计行
            tableHtml += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%;">总计</td>`;
            tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth};"></td>`;
            // 各种柜型的合计
            containerTypeNames.forEach(typeName => {
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalContainerTypes[typeName].toFixed(0)}</td>`;
            });
            // TTL TEU、百分比、GPS、TONS、TONS/TEU
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalAccountTeu.toFixed(0)}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${accountPercentage}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${avgAccountGps}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalAccountTons.toFixed(2)}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${correctTonsPerTeu}</td>`;
            tableHtml += '</tr>';
            
            tableHtml += '</tbody></table></div>';
            }
            
            // 创建并显示弹窗
            const modal = document.createElement('div');
            modal.id = 'detailModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDetailModal();
                }
            });
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;';
            
            modalContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;';
            header.innerHTML = `
                <h3 style="margin: 0; color: #333;">SQ/SC NAME: ${escapeHtml(sqScName)} 详情</h3>
                <button id="closeDetailModalBtn" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;">关闭</button>
            `;
            
            header.querySelector('#closeDetailModalBtn').addEventListener('click', closeDetailModal);
            header.querySelector('#closeDetailModalBtn').addEventListener('mouseover', function() {
                this.style.background = '#2D4A7D';
            });
            header.querySelector('#closeDetailModalBtn').addEventListener('mouseout', function() {
                this.style.background = '#3E62AD';
            });
            
            modalContent.appendChild(header);
            modalContent.insertAdjacentHTML('beforeend', tableHtml);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        /**
         * 关闭详情弹窗
         */
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * 显示Vessel详情（船名航次详情）
         */
        function showVesselDetail(vessel, voyage) {
            const vesselData = filteredData.filter(row => {
                const v = getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定';
                const voy = getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定';
                return v === vessel && voy === voyage;
            });
            
            if (vesselData.length === 0) return;
            
            // 按Trade和POD分组
            const tradePodGroups = {};
            let totalVesselTeu = 0;
            let totalVesselTons = 0;
            const allVesselGps = [];
            
            vesselData.forEach(row => {
                const trade = getColumnValue(row, COLUMN_MAP.TRADE) || '未指定';
                const pod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                const key = `${trade}|${pod}`;
                
                if (!tradePodGroups[key]) {
                    tradePodGroups[key] = {
                        trade,
                        pod,
                        containerTypes: {},
                        teu: 0,
                        tons: 0,
                        gps: []
                    };
                }
                
                // 统计N~X列各种柜型
                const containerTypes = getContainerTypeColumns();
                containerTypes.forEach(col => {
                    const value = Number(getColumnValue(row, col) || 0);
                    if (value > 0) {
                        const typeName = getContainerTypeName(col);
                        if (!tradePodGroups[key].containerTypes[typeName]) {
                            tradePodGroups[key].containerTypes[typeName] = 0;
                        }
                        tradePodGroups[key].containerTypes[typeName] += value;
                    }
                });
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                tradePodGroups[key].teu += teu;
                tradePodGroups[key].tons += tons;
                if (gps > 0) {
                    tradePodGroups[key].gps.push(gps);
                }
                
                totalVesselTeu += teu;
                totalVesselTons += tons;
                if (gps > 0) {
                    allVesselGps.push(gps);
                }
            });
            
            const avgVesselGps = allVesselGps.length > 0 ? (allVesselGps.reduce((a, b) => a + b, 0) / allVesselGps.length).toFixed(2) : '0.00';
            const vesselTonsPerTeu = totalVesselTeu > 0 ? (totalVesselTons / totalVesselTeu).toFixed(4) : '0.0000';
            
            // 生成表格内容
            // 生成表格 - 船名航次占12%，其他16列均分88%
            const otherColWidth = (88 / 16).toFixed(2) + '%';
            let tableHtml = '<div class="detail-table-container"><table style="width: 100%; table-layout: fixed;">';
            tableHtml += '<thead><tr style="background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); color: white;">';
            tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: 12%; color: white;">VSL/VOY</th>`;
            tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: ${otherColWidth}; color: white;">Trade</th>`;
            tableHtml += `<th style="padding: 12px; text-align: left; border: 1px solid white; width: ${otherColWidth}; color: white;">POD</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2SD</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2RS</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4SD</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4SH</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">5SH</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4RH</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2FO</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">2FC</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4FO</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">4FC</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TTL TEU</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">百分比</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">GPS</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TONS</th>`;
            tableHtml += `<th style="padding: 12px; text-align: right; border: 1px solid white; width: ${otherColWidth}; color: white;">TONS/TEU</th>`;
            tableHtml += '</tr></thead><tbody>';
            
            // 按Trade升序排序，其次按POD升序排序
            const sortedKeys = Object.keys(tradePodGroups).sort((a, b) => {
                // 先按Trade升序排序
                const aTrade = String(tradePodGroups[a].trade || '');
                const bTrade = String(tradePodGroups[b].trade || '');
                const tradeDiff = aTrade.localeCompare(bTrade);
                if (tradeDiff !== 0) {
                    return tradeDiff;
                }
                // 如果Trade相同，按POD升序排序
                const aPod = String(tradePodGroups[a].pod || '');
                const bPod = String(tradePodGroups[b].pod || '');
                return aPod.localeCompare(bPod);
            });
            
            // 先计算所有百分比，确保总和为 100%
            const percentages = [];
            let totalPercentage = 0;
            
            // 第一遍：计算所有百分比（保留两位小数）
            sortedKeys.forEach((key, index) => {
                const item = tradePodGroups[key];
                let percentage = totalVesselTeu > 0 ? (item.teu / totalVesselTeu) * 100 : 0;
                
                // 除了最后一项，都四舍五入到两位小数
                if (index < sortedKeys.length - 1) {
                    percentage = Math.round(percentage * 100) / 100;
                    totalPercentage += percentage;
                    percentages.push(percentage);
                } else {
                    // 最后一项：调整百分比使总和为 100%
                    percentage = Math.round((100 - totalPercentage) * 100) / 100;
                    percentages.push(percentage);
                }
            });
            
            const vslVoy = `${vessel}/${voyage}`;
            sortedKeys.forEach((key, index) => {
                const item = tradePodGroups[key];
                const itemAvgGps = item.gps.length > 0 ? (item.gps.reduce((a, b) => a + b, 0) / item.gps.length).toFixed(2) : '0.00';
                const itemTonsPerTeu = item.teu > 0 ? (item.tons / item.teu).toFixed(4) : '0.0000';
                const itemPercentage = percentages[index].toFixed(2) + '%';
                
                // 为onclick准备筛选参数（VSL/VOY + Dept模式）
                const filterParams = {
                    vslVoy: vslVoy,
                    trade: item.trade,
                    pod: item.pod
                };
                // 使用data属性存储JSON，避免在onclick属性中的引号冲突
                const jsonStr = JSON.stringify(filterParams);
                const escapedJsonForAttr = jsonStr.replace(/"/g, '&quot;');
                
                tableHtml += `<tr style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" data-filter-params="${escapedJsonForAttr}" onclick="window.showBlDetail(this.getAttribute(&quot;data-filter-params&quot;))">`;
                // 第一行显示船名航次，其他行合并
                if (index === 0) {
                    tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" rowspan="${sortedKeys.length}" title="${escapeHtml(vslVoy)}">${escapeHtml(vslVoy)}</td>`;
                }
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.trade)}</td>`;
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.pod)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2SD'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2RS'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4SD'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4SH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['5SH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4RH'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2FO'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['2FC'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4FO'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${(item.containerTypes['4FC'] || 0).toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600; width: ${otherColWidth};">${item.teu.toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemPercentage}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemAvgGps}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${item.tons.toFixed(2)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${itemTonsPerTeu}</td>`;
                tableHtml += '</tr>';
            });
            
            // 总计行 - 统计所有柜型的合计
            const totalContainerTypes = {};
            const containerTypeNames = ['2SD', '2RS', '4SD', '4SH', '5SH', '4RH', '2FO', '2FC', '4FO', '4FC'];
            Object.values(tradePodGroups).forEach(item => {
                containerTypeNames.forEach(typeName => {
                    if (!totalContainerTypes[typeName]) {
                        totalContainerTypes[typeName] = 0;
                    }
                    totalContainerTypes[typeName] += (item.containerTypes[typeName] || 0);
                });
            });
            
            // 重新计算 TONS/TEU（应该是 totalVesselTons / totalVesselTeu）
            const correctTonsPerTeu = totalVesselTeu > 0 ? (totalVesselTons / totalVesselTeu).toFixed(4) : '0.0000';
            
            // 总计行
            tableHtml += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 12%;">总计</td>`;
            tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth};"></td>`;
            tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; width: ${otherColWidth};"></td>`;
            // 各种柜型的合计
            containerTypeNames.forEach(typeName => {
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalContainerTypes[typeName].toFixed(0)}</td>`;
            });
            // TTL TEU、百分比、GPS、TONS、TONS/TEU
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalVesselTeu.toFixed(0)}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">100.00%</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${avgVesselGps}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${totalVesselTons.toFixed(2)}</td>`;
            tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: ${otherColWidth};">${correctTonsPerTeu}</td>`;
            tableHtml += '</tr>';
            
            tableHtml += '</tbody></table></div>';
            
            // 创建并显示弹窗 - 分离遮罩层和内容层
            const modal = document.createElement('div');
            modal.id = 'detailModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            // 添加点击外部关闭功能
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDetailModal();
                }
            });
            
            // 创建内容容器
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;';
            
            // 阻止内容区域的点击冒泡
            modalContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 添加标题和关闭按钮
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;';
            header.innerHTML = `
                <h3 style="margin: 0; color: #333;">VSL/VOY: ${escapeHtml(vslVoy)} 详情</h3>
                <button id="closeDetailModalBtn" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;">关闭</button>
            `;
            
            // 绑定关闭按钮
            header.querySelector('#closeDetailModalBtn').addEventListener('click', closeDetailModal);
            header.querySelector('#closeDetailModalBtn').addEventListener('mouseover', function() {
                this.style.background = '#2D4A7D';
            });
            header.querySelector('#closeDetailModalBtn').addEventListener('mouseout', function() {
                this.style.background = '#3E62AD';
            });
            
            // 组装内容
            modalContent.appendChild(header);
            modalContent.insertAdjacentHTML('beforeend', tableHtml);
            
            // 组装弹窗
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        /**
         * 显示VSL/VOY + GPS详情（包含图表和筛选功能）
         */
        function showVesselGpsDetail(key) {
            // 解析key：ETD|EXP_LINE|VSL/VOY|Trade|POD
            debugLog('showVesselGpsDetail called with key:', key);
            if (!key) {
                console.error('showVesselGpsDetail: key is empty');
                alert('数据格式错误：key为空');
                return;
            }
            const parts = key.split('|');
            if (parts.length < 5) {
                console.error('showVesselGpsDetail: Invalid key format, parts:', parts, 'length:', parts.length);
                alert('数据格式错误：key格式不正确，parts数量：' + parts.length);
                return;
            }
            
            const [etd, expLine, vslVoy, trade, pod] = parts;
            debugLog('Parsed parts:', { etd, expLine, vslVoy, trade, pod });
            
            // 获取匹配的数据
            // 注意：etd可能是数字（Excel日期序列号），需要转换为字符串进行比较
            const etdStr = String(etd);
            const vesselGpsData = filteredData.filter(row => {
                const rowEtd = getColumnValue(row, COLUMN_MAP.SAIL_DATE);
                const rowEtdStr = rowEtd ? String(rowEtd) : '未指定';
                const rowExpLine = String(getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定');
                const rowVessel = String(getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定');
                const rowVoyage = String(getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定');
                const rowVslVoy = `${rowVessel}/${rowVoyage}`;
                const rowTrade = String(getColumnValue(row, COLUMN_MAP.TRADE) || '未指定');
                const rowPod = String(getColumnValue(row, COLUMN_MAP.POD) || '未指定');
                
                const match = rowEtdStr === etdStr && 
                             rowExpLine === String(expLine) && 
                             rowVslVoy === vslVoy && 
                             rowTrade === String(trade) && 
                             rowPod === String(pod);
                
                if (match) {
                    debugLog('Match found:', { rowEtdStr, rowExpLine, rowVslVoy, rowTrade, rowPod });
                }
                
                return match;
            });
            
            debugLog('Filtered vesselGpsData length:', vesselGpsData.length);
            if (vesselGpsData.length === 0) {
                alert('没有找到匹配的数据');
                return;
            }
            
            // 准备图表数据：按柜型分组，收集GPS值
            const containerTypeMap = {
                'N': '2SD', 'O': '2RS', 'P': '4SD', 'Q': '4SH', 'R': '5SH',
                'S': '4RH', 'T': '2FO', 'U': '2FC', 'V': '4FO', 'W': '4FC'
            };
            const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
            
            const chartData = {};
            let allGpsValues = [];
            
            vesselGpsData.forEach(row => {
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                containerTypes.forEach(col => {
                    const teu = Number(getColumnValue(row, col) || 0);
                    if (teu > 0) {
                        const typeName = containerTypeMap[col];
                        if (!chartData[typeName]) {
                            chartData[typeName] = { teu: 0, gpsValues: [] };
                        }
                        chartData[typeName].teu += teu;
                        if (gps > 0) {
                            for (let i = 0; i < teu; i++) {
                                chartData[typeName].gpsValues.push(gps);
                                allGpsValues.push(gps);
                            }
                        }
                    }
                });
            });
            
            // 计算平均GPS
            const avgGps = allGpsValues.length > 0 
                ? (allGpsValues.reduce((a, b) => a + b, 0) / allGpsValues.length)
                : 0;
            
            // 创建弹窗
            const modal = document.createElement('div');
            modal.id = 'detailModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDetailModal();
                }
            });
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;';
            modalContent.addEventListener('click', (e) => e.stopPropagation());
            
            // 标题栏
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;';
            header.innerHTML = `
                <h3 style="margin: 0; color: #333;">${escapeHtml(vslVoy)} - ${escapeHtml(trade)} - ${escapeHtml(pod)} GPS分析</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="gpsDetailApplyFilter" class="btn-sweep-blue" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">应用筛选</button>
                    <button id="gpsDetailViewBl" class="btn-sweep-orange" style="padding: 8px 16px; background: #FF8A00; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">查看详细BL资料</button>
                    <button id="closeDetailModalBtn" class="btn-sweep-blue" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">关闭</button>
                </div>
            `;
            header.querySelector('#closeDetailModalBtn').addEventListener('click', closeDetailModal);
            
            // 筛选器区域
            const filterSection = document.createElement('div');
            filterSection.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; flex-shrink: 0;';
            filterSection.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">柜型筛选（可多选）</label>
                        <select id="gpsDetailContainerFilter" multiple size="5" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                            <option value="">全部柜型</option>
                            ${containerTypes.map(col => `<option value="${containerTypeMap[col]}" selected>${containerTypeMap[col]}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">GPS区间筛选</label>
                        <select id="gpsDetailRangeFilter" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; height: calc(5 * 1.5em + 16px);">
                            <option value="all">全部GPS</option>
                            <option value="below-avg">低于平均GPS (${avgGps.toFixed(2)})</option>
                            <option value="below-90">低于平均GPS 90%</option>
                            <option value="below-80">低于平均GPS 80%</option>
                            <option value="below-70">低于平均GPS 70%</option>
                            <option value="below-60">低于平均GPS 60%</option>
                            <option value="below-50">低于平均GPS 50%</option>
                            <option value="below-40">低于平均GPS 40%</option>
                            <option value="below-30">低于平均GPS 30%</option>
                            <option value="below-20">低于平均GPS 20%</option>
                            <option value="below-10">低于平均GPS 10%</option>
                        </select>
                    </div>
                </div>
            `;
            
            // 图表区域
            const chartSection = document.createElement('div');
            chartSection.style.cssText = 'margin-bottom: 20px; flex-shrink: 0;';
            chartSection.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">GPS分布图（所有柜型）</h4>
                    <canvas id="gpsDetailChart" style="max-height: 400px;"></canvas>
                </div>
            `;
            
            // 数据表格区域
            const tableSection = document.createElement('div');
            tableSection.style.cssText = 'flex: 1; overflow: auto;';
            tableSection.id = 'gpsDetailTableSection';
            
            modalContent.appendChild(header);
            modalContent.appendChild(filterSection);
            modalContent.appendChild(chartSection);
            modalContent.appendChild(tableSection);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 初始化图表
            setTimeout(() => {
                const ctx = document.getElementById('gpsDetailChart');
                if (ctx && typeof Chart !== 'undefined') {
                    const chartDataArray = Object.keys(chartData).map(type => ({
                        type,
                        teu: chartData[type].teu,
                        avgGps: chartData[type].gpsValues.length > 0 
                            ? (chartData[type].gpsValues.reduce((a, b) => a + b, 0) / chartData[type].gpsValues.length)
                            : 0
                    }));
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartDataArray.map(d => d.type),
                            datasets: [{
                                label: '平均GPS',
                                data: chartDataArray.map(d => d.avgGps),
                                backgroundColor: '#3E62AD',
                                borderColor: '#2D4A7D',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `平均GPS: ${avgGps.toFixed(2)}`
                                },
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'GPS'
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
            
            // 应用筛选功能
            const applyFilterBtn = header.querySelector('#gpsDetailApplyFilter');
            const viewBlBtn = header.querySelector('#gpsDetailViewBl');
            const containerFilter = document.getElementById('gpsDetailContainerFilter');
            const rangeFilter = document.getElementById('gpsDetailRangeFilter');
            
            applyFilterBtn.addEventListener('click', () => {
                updateGpsDetailTable(vesselGpsData, containerFilter, rangeFilter, avgGps, containerTypeMap);
            });
            
            viewBlBtn.addEventListener('click', () => {
                showGpsDetailBlData(vesselGpsData, containerFilter, rangeFilter, avgGps, containerTypeMap, vslVoy, trade, pod);
            });
            
            // 初始加载表格
            updateGpsDetailTable(vesselGpsData, containerFilter, rangeFilter, avgGps, containerTypeMap);
        }
        
        /**
         * 更新GPS详情表格
         */
        function updateGpsDetailTable(vesselGpsData, containerFilter, rangeFilter, avgGps, containerTypeMap) {
            const tableSection = document.getElementById('gpsDetailTableSection');
            if (!tableSection) return;
            
            // 获取筛选条件
            const selectedTypes = Array.from(containerFilter.selectedOptions).map(opt => opt.value);
            const hasAllTypes = selectedTypes.includes('');
            const rangeValue = rangeFilter.value;
            
            // 筛选数据
            const filteredRows = vesselGpsData.filter(row => {
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                if (gps === 0) return false;
                
                // GPS区间筛选（单选下拉框）
                let gpsMatch = false;
                if (rangeValue === 'all') {
                    gpsMatch = true;
                } else if (rangeValue === 'below-avg') {
                    gpsMatch = gps < avgGps;
                } else if (rangeValue === 'below-90') {
                    gpsMatch = gps < avgGps * 0.9;
                } else if (rangeValue === 'below-80') {
                    gpsMatch = gps < avgGps * 0.8;
                } else if (rangeValue === 'below-70') {
                    gpsMatch = gps < avgGps * 0.7;
                } else if (rangeValue === 'below-60') {
                    gpsMatch = gps < avgGps * 0.6;
                } else if (rangeValue === 'below-50') {
                    gpsMatch = gps < avgGps * 0.5;
                } else if (rangeValue === 'below-40') {
                    gpsMatch = gps < avgGps * 0.4;
                } else if (rangeValue === 'below-30') {
                    gpsMatch = gps < avgGps * 0.3;
                } else if (rangeValue === 'below-20') {
                    gpsMatch = gps < avgGps * 0.2;
                } else if (rangeValue === 'below-10') {
                    gpsMatch = gps < avgGps * 0.1;
                }
                
                if (!gpsMatch) return false;
                
                // 柜型筛选
                if (!hasAllTypes) {
                    const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
                    let hasSelectedType = false;
                    containerTypes.forEach(col => {
                        const teu = Number(getColumnValue(row, col) || 0);
                        if (teu > 0) {
                            const typeName = containerTypeMap[col];
                            if (selectedTypes.includes(typeName)) {
                                hasSelectedType = true;
                            }
                        }
                    });
                    if (!hasSelectedType) return false;
                }
                
                return true;
            });
            
            // 生成表格
            const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
            let tableHtml = '<div class="detail-table-container"><table style="width: 100%; border-collapse: collapse;"><thead>';
            tableHtml += '<tr style="background: #3E62AD; color: white;">';
            tableHtml += '<th style="padding: 12px; text-align: left; border: 1px solid white;">POD</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">2SD</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">2RS</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">4SD</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">4SH</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">5SH</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">4RH</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">2FO</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">2FC</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">4FO</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">4FC</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">TTL TEU</th>';
            tableHtml += '<th style="padding: 12px; text-align: right; border: 1px solid white;">GPS</th>';
            tableHtml += '</tr></thead><tbody>';
            
            // 按POD分组
            const podGroups = {};
            filteredRows.forEach(row => {
                const pod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                if (!podGroups[pod]) {
                    podGroups[pod] = { containerTypes: {}, totalTeu: 0, gps: 0 };
                }
                
                containerTypes.forEach(col => {
                    const teu = Number(getColumnValue(row, col) || 0);
                    if (teu > 0) {
                        const typeName = containerTypeMap[col];
                        if (!podGroups[pod].containerTypes[typeName]) {
                            podGroups[pod].containerTypes[typeName] = 0;
                        }
                        podGroups[pod].containerTypes[typeName] += teu;
                        podGroups[pod].totalTeu += teu;
                    }
                });
                
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                if (gps > 0) {
                    podGroups[pod].gps = gps; // 使用该行的GPS值
                }
            });
            
            Object.keys(podGroups).sort().forEach(pod => {
                const group = podGroups[pod];
                tableHtml += '<tr>';
                tableHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">${escapeHtml(pod)}</td>`;
                containerTypes.forEach(col => {
                    const typeName = containerTypeMap[col];
                    const teu = group.containerTypes[typeName] || 0;
                    tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${teu.toFixed(0)}</td>`;
                });
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${group.totalTeu.toFixed(0)}</td>`;
                tableHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${group.gps.toFixed(2)}</td>`;
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table></div>';
            tableSection.innerHTML = tableHtml;
        }
        
        /**
         * 显示GPS详情BL资料
         */
        function showGpsDetailBlData(vesselGpsData, containerFilter, rangeFilter, avgGps, containerTypeMap, vslVoy, trade, pod) {
            // 获取筛选条件（与updateGpsDetailTable相同）
            const selectedTypes = Array.from(containerFilter.selectedOptions).map(opt => opt.value);
            const hasAllTypes = selectedTypes.includes('');
            const rangeValue = rangeFilter.value;
            
            // 筛选数据
            const filteredRows = vesselGpsData.filter(row => {
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                if (gps === 0) return false;
                
                // GPS区间筛选（单选下拉框）
                let gpsMatch = false;
                if (rangeValue === 'all') {
                    gpsMatch = true;
                } else if (rangeValue === 'below-avg') {
                    gpsMatch = gps < avgGps;
                } else if (rangeValue === 'below-90') {
                    gpsMatch = gps < avgGps * 0.9;
                } else if (rangeValue === 'below-80') {
                    gpsMatch = gps < avgGps * 0.8;
                } else if (rangeValue === 'below-70') {
                    gpsMatch = gps < avgGps * 0.7;
                } else if (rangeValue === 'below-60') {
                    gpsMatch = gps < avgGps * 0.6;
                } else if (rangeValue === 'below-50') {
                    gpsMatch = gps < avgGps * 0.5;
                } else if (rangeValue === 'below-40') {
                    gpsMatch = gps < avgGps * 0.4;
                } else if (rangeValue === 'below-30') {
                    gpsMatch = gps < avgGps * 0.3;
                } else if (rangeValue === 'below-20') {
                    gpsMatch = gps < avgGps * 0.2;
                } else if (rangeValue === 'below-10') {
                    gpsMatch = gps < avgGps * 0.1;
                }
                
                if (!gpsMatch) return false;
                
                if (!hasAllTypes) {
                    const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
                    let hasSelectedType = false;
                    containerTypes.forEach(col => {
                        const teu = Number(getColumnValue(row, col) || 0);
                        if (teu > 0) {
                            const typeName = containerTypeMap[col];
                            if (selectedTypes.includes(typeName)) {
                                hasSelectedType = true;
                            }
                        }
                    });
                    if (!hasSelectedType) return false;
                }
                
                return true;
            });
            
            if (filteredRows.length === 0) {
                alert('没有符合筛选条件的数据');
                return;
            }
            
            // 计算每个POD的平均GPS（使用未筛选的原始数据vesselGpsData）
            const podAvgGps = {};
            const podTypeAvgGps = {}; // {pod: {type: avgGps}}
            
            // 使用vesselGpsData（未筛选的原始数据）来计算平均值
            vesselGpsData.forEach(row => {
                const rowPod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                const totalTeu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                
                if (gps > 0 && totalTeu > 0) {
                    if (!podAvgGps[rowPod]) {
                        podAvgGps[rowPod] = { totalGps: 0, totalTeu: 0 };
                    }
                    podAvgGps[rowPod].totalGps += gps * totalTeu;
                    podAvgGps[rowPod].totalTeu += totalTeu;
                    
                    // 计算每个POD+柜型的平均GPS
                    const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
                    containerTypes.forEach(col => {
                        const teu = Number(getColumnValue(row, col) || 0);
                        if (teu > 0) {
                            const typeName = containerTypeMap[col];
                            const key = `${rowPod}|${typeName}`;
                            if (!podTypeAvgGps[key]) {
                                podTypeAvgGps[key] = { totalGps: 0, totalTeu: 0 };
                            }
                            podTypeAvgGps[key].totalGps += gps * teu;
                            podTypeAvgGps[key].totalTeu += teu;
                        }
                    });
                }
            });
            
            // 计算平均值
            Object.keys(podAvgGps).forEach(p => {
                if (podAvgGps[p].totalTeu > 0) {
                    podAvgGps[p] = podAvgGps[p].totalGps / podAvgGps[p].totalTeu;
                } else {
                    podAvgGps[p] = 0;
                }
            });
            
            Object.keys(podTypeAvgGps).forEach(key => {
                if (podTypeAvgGps[key].totalTeu > 0) {
                    podTypeAvgGps[key] = podTypeAvgGps[key].totalGps / podTypeAvgGps[key].totalTeu;
                } else {
                    podTypeAvgGps[key] = 0;
                }
            });
            
            // 按GPS升序排序
            filteredRows.sort((a, b) => {
                const gpsA = Number(getColumnValue(a, COLUMN_MAP.Z) || 0);
                const gpsB = Number(getColumnValue(b, COLUMN_MAP.Z) || 0);
                return gpsA - gpsB;
            });
            
            // 创建BL资料弹窗
            const blModal = document.createElement('div');
            blModal.id = 'blDetailModal';
            blModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center;';
            
            blModal.addEventListener('click', (e) => {
                if (e.target === blModal) {
                    blModal.remove();
                }
            });
            
            const blContent = document.createElement('div');
            blContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            blContent.addEventListener('click', (e) => e.stopPropagation());
            
            const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
            let blHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333;">详细BL资料 (${filteredRows.length} 条记录)</h3>
                    <button onclick="this.closest('#blDetailModal').remove()" class="btn-sweep-blue" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">关闭</button>
                </div>
                <div class="detail-table-container">
                <table style="width: 100%; border-collapse: collapse;">
                <thead>
                <tr style="background: #3E62AD; color: white;">
                    <th style="padding: 12px; border: 1px solid white;">BLNO</th>
                    <th style="padding: 12px; border: 1px solid white;">SalesID</th>
                    <th style="padding: 12px; border: 1px solid white;">SQ/SC</th>
                    <th style="padding: 12px; border: 1px solid white;">SQ/SC NAME</th>
                    ${containerTypes.map(col => `<th style="padding: 12px; text-align: right; border: 1px solid white;">${containerTypeMap[col]}</th>`).join('')}
                    <th style="padding: 12px; text-align: right; border: 1px solid white;">TTL TEU</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white;">GPS</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white;">vs Port</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white;">vs Type</th>
                </tr>
                </thead>
                <tbody>
            `;
            
            filteredRows.forEach(row => {
                const blno = getColumnValue(row, COLUMN_MAP.BLNO) || '未指定';
                const salesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                const sqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                const sqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                const rowPod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                const totalTeu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                
                // 计算vs Port（该票的GPS - 该POD的平均GPS，负数表示少了）
                const podAvg = podAvgGps[rowPod] || 0;
                const vsPort = podAvg > 0 ? (gps - podAvg).toFixed(2) : '-';
                
                // 计算vs Type（该票的GPS - 该POD+该柜型的平均GPS，负数表示少了）
                // 找到该票的主要柜型（TEU最大的）
                let mainType = '';
                let maxTeu = 0;
                containerTypes.forEach(col => {
                    const teu = Number(getColumnValue(row, col) || 0);
                    if (teu > maxTeu) {
                        maxTeu = teu;
                        mainType = containerTypeMap[col];
                    }
                });
                
                const typeKey = `${rowPod}|${mainType}`;
                const typeAvg = podTypeAvgGps[typeKey] || 0;
                const vsType = typeAvg > 0 ? (gps - typeAvg).toFixed(2) : '-';
                
                blHtml += '<tr>';
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(blno)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(salesId)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(sqSc)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(sqScName)}">${escapeHtml(sqScName)}</td>`;
                containerTypes.forEach(col => {
                    const teu = Number(getColumnValue(row, col) || 0);
                    blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${teu.toFixed(0)}</td>`;
                });
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${gps.toFixed(2)}</td>`;
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; color: ${vsPort !== '-' && parseFloat(vsPort) < 0 ? '#d32f2f' : '#4caf50'}; font-weight: 600;">${vsPort}</td>`;
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; color: ${vsType !== '-' && parseFloat(vsType) < 0 ? '#d32f2f' : '#4caf50'}; font-weight: 600;">${vsType}</td>`;
                blHtml += '</tr>';
            });
            
            blHtml += '</tbody></table></div>';
            blContent.innerHTML = blHtml;
            blModal.appendChild(blContent);
            document.body.appendChild(blModal);
        }

        // 将函数暴露到全局，以便onclick调用
        window.showSalesDetail = showSalesDetail;
        window.showAccountDetail = showAccountDetail;
        window.showVesselDetail = showVesselDetail;
        window.showVesselGpsDetail = showVesselGpsDetail;
        window.closeDetailModal = closeDetailModal;


        /**
         * 根据日期获取周别代码（YYYYWW格式）
         */
        function getWeekCodeFromDate(date) {
            if (!date || !(date instanceof Date)) return null;
            const year = date.getFullYear();
            // 使用week-utils.js中的getWeekNumber函数
            if (window.getWeekNumber) {
                const week = window.getWeekNumber(date);
                return `${year}${String(week).padStart(2, '0')}`;
            }
            // 如果getWeekNumber不可用，使用简化的ISO周计算
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${year}${String(week).padStart(2, '0')}`;
        }

        /**
         * 生成Sales+Week维度分析
         */
        /**
         * 排序周别代码，考虑跨年情况（52, 53, 1, 2, 3...）
         * 按照时间顺序排序，考虑跨年：如果当前是52周，则52, 53, 1, 2, 3...
         */
        function sortWeekCodes(weekCodes) {
            if (!weekCodes || weekCodes.length === 0) return [];
            
            // 解析周别代码为 {year, week, code, sortKey}
            const parsed = weekCodes.map(code => {
                if (!code || code.length !== 6) return null;
                const year = parseInt(code.substring(0, 4), 10);
                const week = parseInt(code.substring(4), 10);
                // 创建一个排序键：如果周数>=52，则认为是年末周，应该排在下一年第1周之前
                // 对于>=52的周，使用 (year-1) * 1000 + week + 100，这样52, 53会排在下一年的1, 2之前
                let sortKey;
                if (week >= 52) {
                    // 年末周：使用 (year-1) * 1000 + week + 100
                    // 例如：202452 -> (2024-1) * 1000 + 52 + 100 = 2023152
                    //       202501 -> 2025 * 1000 + 1 = 2025001
                    // 这样2023152 < 2025001，所以52周会排在1周之前
                    sortKey = (year - 1) * 1000 + week + 100;
                } else {
                    // 年初周：使用 year * 1000 + week
                    sortKey = year * 1000 + week;
                }
                return { year, week, code, sortKey };
            }).filter(item => item !== null);
            
            // 按sortKey排序
            parsed.sort((a, b) => {
                // 如果年份相同，按周数排序
                if (a.year === b.year) {
                    return a.week - b.week;
                }
                // 如果年份不同，需要特殊处理跨年情况
                // 如果a是上一年且周数>=52，b是下一年且周数<=3，则a应该在b之前
                if (a.year === b.year - 1 && a.week >= 52 && b.week <= 3) {
                    return -1;
                }
                if (b.year === a.year - 1 && b.week >= 52 && a.week <= 3) {
                    return 1;
                }
                // 其他情况按sortKey排序
                return a.sortKey - b.sortKey;
            });
            
            return parsed.map(item => item.code);
        }

        /**
         * 解析周别值，支持多种格式
         * 如果只有周数（如53, 1, 2），则根据当前日期推断年份
         */
        function parseWeekValue(weekValue) {
            if (!weekValue) return null;
            
            const text = String(weekValue).trim();
            
            // 先尝试使用parseWeekText解析（支持YYYYWW, YYYY/WW等格式）
            let weekCode = window.parseWeekText ? window.parseWeekText(text) : parseWeekText(text);
            if (weekCode) {
                return weekCode;
            }
            
            // 如果parseWeekText失败，尝试解析只有周数的情况（如 "53", "1", "2"）
            const weekOnlyMatch = text.match(/^(\d{1,2})$/);
            if (weekOnlyMatch) {
                const week = parseInt(weekOnlyMatch[1], 10);
                if (week >= 1 && week <= 53) {
                    // 获取当前周别代码
                    let currentYear, currentWeek;
                    if (window.getCurrentWeekCode) {
                        const currentWeekCode = window.getCurrentWeekCode();
                        if (currentWeekCode) {
                            currentYear = parseInt(currentWeekCode.substring(0, 4), 10);
                            currentWeek = parseInt(currentWeekCode.substring(4), 10);
                        }
                    }
                    
                    // 如果无法获取当前周，使用当前日期计算
                    if (!currentYear || !currentWeek) {
                        const now = new Date();
                        currentYear = now.getFullYear();
                        if (window.getWeekNumber) {
                            currentWeek = window.getWeekNumber(now);
                        } else {
                            // 简单估算：1月1日通常是上一年的53周或当年的1周
                            const month = now.getMonth() + 1;
                            const day = now.getDate();
                            if (month === 1 && day <= 7) {
                                // 1月前7天，可能是上一年的53周或当年的1周
                                currentWeek = 1; // 假设是当年的1周
                            } else {
                                // 其他情况，使用getWeekCodeFromDate
                                const tempCode = getWeekCodeFromDate(now);
                                if (tempCode) {
                                    currentYear = parseInt(tempCode.substring(0, 4), 10);
                                    currentWeek = parseInt(tempCode.substring(4), 10);
                                } else {
                                    currentWeek = 1;
                                }
                            }
                        }
                    }
                    
                    // 根据当前周数和输入的周数推断年份
                    // 如果当前是53周（2025年），输入的周数：
                    // - 53: 2025年53周
                    // - 1, 2, 3: 2026年1, 2, 3周
                    if (currentWeek >= 52) {
                        // 当前是年末周（52或53）
                        if (week >= 52) {
                            // 输入的也是年末周，使用当前年份
                            return `${currentYear}${String(week).padStart(2, '0')}`;
                        } else {
                            // 输入的是年初周（1, 2, 3），使用下一年
                            return `${currentYear + 1}${String(week).padStart(2, '0')}`;
                        }
                    } else if (currentWeek <= 3) {
                        // 当前是年初周（1, 2, 3）
                        if (week <= 3) {
                            // 输入的也是年初周，使用当前年份
                            return `${currentYear}${String(week).padStart(2, '0')}`;
                        } else {
                            // 输入的是年末周（52, 53），使用上一年
                            return `${currentYear - 1}${String(week).padStart(2, '0')}`;
                        }
                    } else {
                        // 当前是年中周，输入的周数应该和当前年份相同
                        return `${currentYear}${String(week).padStart(2, '0')}`;
                    }
                }
            }
            
            return null;
        }

        function generateSalesWeekAnalysis() {
            // 从数据中收集所有实际存在的周别代码（从AE列）
            const actualWeekCodes = new Set();
            filteredData.forEach(row => {
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                if (weekValue) {
                    // 解析周别代码（支持多种格式，包括只有周数的情况）
                    const weekCode = parseWeekValue(weekValue);
                    if (weekCode) {
                        actualWeekCodes.add(weekCode);
                    }
                }
            });
            
            if (actualWeekCodes.size === 0) {
                return '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无周别数据</p>';
            }
            
            // 获取所有周别代码，按时间顺序排序（52, 53, 1, 2, 3...）
            const allWeekCodes = Array.from(actualWeekCodes);
            const sorted = sortWeekCodes(allWeekCodes);
            
            // 取前4个周别（当周+未来3周）
            const finalWeekCodes = sorted.slice(0, 4);
            
            if (finalWeekCodes.length === 0) {
                return '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无周别数据</p>';
            }
            
            // 按SalesID分组，按周别分类
            const grouped = {};
            
            // 计算每个周别的总TEU（用于计算占比）
            const weekTotalTeu = {};
            filteredData.forEach(row => {
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                if (!weekValue) return;
                
                // 解析周别代码（使用新的parseWeekValue函数）
                const weekCode = parseWeekValue(weekValue);
                if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                if (!weekTotalTeu[weekCode]) {
                    weekTotalTeu[weekCode] = 0;
                }
                weekTotalTeu[weekCode] += teu;
            });
            
            filteredData.forEach(row => {
                const salesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                
                if (!weekValue) return;
                
                // 解析周别代码（使用新的parseWeekValue函数）
                const weekCode = parseWeekValue(weekValue);
                if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                
                if (!grouped[salesId]) {
                    grouped[salesId] = {
                        salesId,
                        weeks: {}
                    };
                }
                
                if (!grouped[salesId].weeks[weekCode]) {
                    grouped[salesId].weeks[weekCode] = {
                        weekCode,
                        teu: 0,
                        tons: 0,
                        gps: [],
                        count: 0
                    };
                }
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                grouped[salesId].weeks[weekCode].teu += teu;
                grouped[salesId].weeks[weekCode].tons += tons;
                if (gps > 0) {
                    grouped[salesId].weeks[weekCode].gps.push(gps);
                }
                grouped[salesId].weeks[weekCode].count++;
            });
            
            // 生成表格 - 每个周别都有完整的列（参考Sales+Dept的结构）
            let html = '<table style="width: 100%; border-collapse: collapse; background: white;"><thead>';
            // 第一行表头 - 使用主题蓝色渐变，白色字体和白色框线
            html += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;">SalesID</th>';
            
            // 为每个周别添加表头
            finalWeekCodes.forEach(weekCode => {
                html += `<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">${weekCode}</th>`;
            });
            html += '</tr>';
            
            // 第二行表头 - 使用主题蓝色，白色字体和白色框线
            html += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            
            // 为每个周别添加子表头
            finalWeekCodes.forEach(() => {
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            });
            html += '</tr></thead><tbody>';
            
            // 按总TEU降序排序
            const sortedSalesIds = Object.keys(grouped).sort((a, b) => {
                let aTotal = 0;
                let bTotal = 0;
                Object.values(grouped[a].weeks).forEach(weekData => {
                    aTotal += weekData.teu || 0;
                });
                Object.values(grouped[b].weeks).forEach(weekData => {
                    bTotal += weekData.teu || 0;
                });
                return bTotal - aTotal; // 降序
            });
            
            sortedSalesIds.forEach(salesId => {
                const item = grouped[salesId];
                
                html += `<tr class="sales-row" data-sales-id="${escapeHtml(salesId)}" style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="showSalesDetail('${escapeHtml(salesId)}')">`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">${escapeHtml(salesId)}</td>`;
                
                // 每个周别的列
                finalWeekCodes.forEach(weekCode => {
                    const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [], count: 0 };
                    const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                    const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                    const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                    
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.teu.toFixed(0)}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${percentage}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${avgGps}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.tons.toFixed(2)}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${tonsPerTeu}</td>`;
                });
                
                html += '</tr>';
            });
            
            // 合计行
            const totalWeekData = {};
            finalWeekCodes.forEach(weekCode => {
                totalWeekData[weekCode] = { teu: 0, tons: 0, gps: [] };
            });
            
            sortedSalesIds.forEach(salesId => {
                const item = grouped[salesId];
                finalWeekCodes.forEach(weekCode => {
                    const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [], count: 0 };
                    totalWeekData[weekCode].teu += weekData.teu;
                    totalWeekData[weekCode].tons += weekData.tons;
                    totalWeekData[weekCode].gps.push(...weekData.gps);
                });
            });
            
            html += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">合计</td>';
            
            finalWeekCodes.forEach(weekCode => {
                const weekData = totalWeekData[weekCode];
                const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${percentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${avgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${tonsPerTeu}</td>`;
            });
            
            html += '</tr>';
            
            html += '</tbody></table>';
            return html;
        }

        /**
         * 生成Account+Dept维度分析
         */
        /**
         * 生成Account+Dept维度分析
         */
        function generateAccountDeptAnalysis() {
            // 按SQ/SC NAME分组，按Dept分类
            const grouped = {};
            const deptList = ['AMS', 'EMS', 'IAS'];
            
            // 计算每个SQ/SC NAME的总TEU（用于计算占比）
            const accountTotalTeu = {};
            
            filteredData.forEach(row => {
                const sqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                const dept = getColumnValue(row, COLUMN_MAP.DEPT) || '';
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                
                if (!accountTotalTeu[sqScName]) {
                    accountTotalTeu[sqScName] = 0;
                }
                accountTotalTeu[sqScName] += teu;
            });
            
            // 计算每个Dept的总TEU（用于计算占比）
            const deptTotalTeu = {};
            filteredData.forEach(row => {
                const dept = getColumnValue(row, COLUMN_MAP.DEPT) || '';
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                if (!deptTotalTeu[dept]) {
                    deptTotalTeu[dept] = 0;
                }
                deptTotalTeu[dept] += teu;
            });
            
            filteredData.forEach(row => {
                const sqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                const dept = getColumnValue(row, COLUMN_MAP.DEPT) || '';
                
                if (!grouped[sqScName]) {
                    grouped[sqScName] = {
                        sqScName,
                        depts: {}
                    };
                }
                
                if (!grouped[sqScName].depts[dept]) {
                    grouped[sqScName].depts[dept] = {
                        dept,
                        teu: 0,
                        tons: 0,
                        gps: [],
                        count: 0
                    };
                }
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                grouped[sqScName].depts[dept].teu += teu;
                grouped[sqScName].depts[dept].tons += tons;
                if (gps > 0) {
                    grouped[sqScName].depts[dept].gps.push(gps);
                }
                grouped[sqScName].depts[dept].count++;
            });
            
            // 生成表格 - 每个Dept都有完整的列
            let html = '<table style="width: 100%; border-collapse: collapse; background: white;"><thead>';
            // 第一行表头 - 使用主题蓝色渐变，白色字体和白色框线
            html += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;">SQ/SC NAME</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">AMS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">EMS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">IAS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">TOTAL</th>';
            html += '</tr>';
            // 第二行表头 - 使用主题蓝色，白色字体和白色框线
            html += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            // AMS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // EMS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // IAS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // TOTAL列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            html += '</tr></thead><tbody>';
            
            // 按总TEU降序排序
            const sortedAccountNames = Object.keys(grouped).sort((a, b) => {
                const aTotal = (grouped[a].depts['AMS']?.teu || 0) + (grouped[a].depts['EMS']?.teu || 0) + (grouped[a].depts['IAS']?.teu || 0);
                const bTotal = (grouped[b].depts['AMS']?.teu || 0) + (grouped[b].depts['EMS']?.teu || 0) + (grouped[b].depts['IAS']?.teu || 0);
                return bTotal - aTotal; // 降序
            });
            
            sortedAccountNames.forEach(sqScName => {
                const item = grouped[sqScName];
                const amsData = item.depts['AMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const emsData = item.depts['EMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const iasData = item.depts['IAS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                
                // 计算每个Dept的指标
                const amsAvgGps = amsData.gps.length > 0 ? (amsData.gps.reduce((a, b) => a + b, 0) / amsData.gps.length).toFixed(2) : '0.00';
                const amsTonsPerTeu = amsData.teu > 0 ? (amsData.tons / amsData.teu).toFixed(4) : '0.0000';
                const amsPercentage = deptTotalTeu['AMS'] > 0 ? ((amsData.teu / deptTotalTeu['AMS']) * 100).toFixed(2) + '%' : '0.00%';
                
                const emsAvgGps = emsData.gps.length > 0 ? (emsData.gps.reduce((a, b) => a + b, 0) / emsData.gps.length).toFixed(2) : '0.00';
                const emsTonsPerTeu = emsData.teu > 0 ? (emsData.tons / emsData.teu).toFixed(4) : '0.0000';
                const emsPercentage = deptTotalTeu['EMS'] > 0 ? ((emsData.teu / deptTotalTeu['EMS']) * 100).toFixed(2) + '%' : '0.00%';
                
                const iasAvgGps = iasData.gps.length > 0 ? (iasData.gps.reduce((a, b) => a + b, 0) / iasData.gps.length).toFixed(2) : '0.00';
                const iasTonsPerTeu = iasData.teu > 0 ? (iasData.tons / iasData.teu).toFixed(4) : '0.0000';
                const iasPercentage = deptTotalTeu['IAS'] > 0 ? ((iasData.teu / deptTotalTeu['IAS']) * 100).toFixed(2) + '%' : '0.00%';
                
                // 计算TOTAL
                const totalTeu = amsData.teu + emsData.teu + iasData.teu;
                const totalTons = amsData.tons + emsData.tons + iasData.tons;
                const allGps = [...amsData.gps, ...emsData.gps, ...iasData.gps];
                const totalAvgGps = allGps.length > 0 ? (allGps.reduce((a, b) => a + b, 0) / allGps.length).toFixed(2) : '0.00';
                const totalTonsPerTeu = totalTeu > 0 ? (totalTons / totalTeu).toFixed(4) : '0.0000';
                const totalDeptTeu = deptTotalTeu['AMS'] + deptTotalTeu['EMS'] + deptTotalTeu['IAS'];
                const totalPercentage = totalDeptTeu > 0 ? ((totalTeu / totalDeptTeu) * 100).toFixed(2) + '%' : '0.00%';
                
                html += `<tr class="account-row" data-account-name="${escapeHtml(sqScName)}" style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="showAccountDetail('${escapeHtml(sqScName)}')">`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">${escapeHtml(sqScName)}</td>`;
                
                // AMS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsTonsPerTeu}</td>`;
                
                // EMS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsTonsPerTeu}</td>`;
                
                // IAS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasTonsPerTeu}</td>`;
                
                // TOTAL列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTonsPerTeu}</td>`;
                html += '</tr>';
            });
            
            // 合计行
            let totalAmsTeu = 0, totalAmsTons = 0, totalAmsGps = [];
            let totalEmsTeu = 0, totalEmsTons = 0, totalEmsGps = [];
            let totalIasTeu = 0, totalIasTons = 0, totalIasGps = [];
            
            sortedAccountNames.forEach(sqScName => {
                const item = grouped[sqScName];
                const amsData = item.depts['AMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const emsData = item.depts['EMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const iasData = item.depts['IAS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                
                totalAmsTeu += amsData.teu;
                totalAmsTons += amsData.tons;
                totalAmsGps.push(...amsData.gps);
                
                totalEmsTeu += emsData.teu;
                totalEmsTons += emsData.tons;
                totalEmsGps.push(...emsData.gps);
                
                totalIasTeu += iasData.teu;
                totalIasTons += iasData.tons;
                totalIasGps.push(...iasData.gps);
            });
            
            const totalAmsAvgGps = totalAmsGps.length > 0 ? (totalAmsGps.reduce((a, b) => a + b, 0) / totalAmsGps.length).toFixed(2) : '0.00';
            const totalAmsTonsPerTeu = totalAmsTeu > 0 ? (totalAmsTons / totalAmsTeu).toFixed(4) : '0.0000';
            const totalAmsPercentage = deptTotalTeu['AMS'] > 0 ? ((totalAmsTeu / deptTotalTeu['AMS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalEmsAvgGps = totalEmsGps.length > 0 ? (totalEmsGps.reduce((a, b) => a + b, 0) / totalEmsGps.length).toFixed(2) : '0.00';
            const totalEmsTonsPerTeu = totalEmsTeu > 0 ? (totalEmsTons / totalEmsTeu).toFixed(4) : '0.0000';
            const totalEmsPercentage = deptTotalTeu['EMS'] > 0 ? ((totalEmsTeu / deptTotalTeu['EMS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalIasAvgGps = totalIasGps.length > 0 ? (totalIasGps.reduce((a, b) => a + b, 0) / totalIasGps.length).toFixed(2) : '0.00';
            const totalIasTonsPerTeu = totalIasTeu > 0 ? (totalIasTons / totalIasTeu).toFixed(4) : '0.0000';
            const totalIasPercentage = deptTotalTeu['IAS'] > 0 ? ((totalIasTeu / deptTotalTeu['IAS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalTeu = totalAmsTeu + totalEmsTeu + totalIasTeu;
            const totalTons = totalAmsTons + totalEmsTons + totalIasTons;
            const allTotalGps = [...totalAmsGps, ...totalEmsGps, ...totalIasGps];
            const totalAvgGps = allTotalGps.length > 0 ? (allTotalGps.reduce((a, b) => a + b, 0) / allTotalGps.length).toFixed(2) : '0.00';
            const totalTonsPerTeu = totalTeu > 0 ? (totalTons / totalTeu).toFixed(4) : '0.0000';
            const totalDeptTeu = deptTotalTeu['AMS'] + deptTotalTeu['EMS'] + deptTotalTeu['IAS'];
            const totalPercentage = totalDeptTeu > 0 ? ((totalTeu / totalDeptTeu) * 100).toFixed(2) + '%' : '0.00%';
            
            html += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">合计</td>';
            
            // AMS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTonsPerTeu}</td>`;
            
            // EMS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTonsPerTeu}</td>`;
            
            // IAS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTonsPerTeu}</td>`;
            
            // TOTAL合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTonsPerTeu}</td>`;
            html += '</tr>';
            
            html += '</tbody></table>';
            return html;
        }

        /**
         * 生成Account+Week维度分析
         */
        function generateAccountWeekAnalysis() {
            // 从数据中收集所有实际存在的周别代码（从AE列）
            const actualWeekCodes = new Set();
            filteredData.forEach(row => {
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                if (weekValue) {
                    // 解析周别代码（支持多种格式，包括只有周数的情况）
                    const weekCode = parseWeekValue(weekValue);
                    if (weekCode) {
                        actualWeekCodes.add(weekCode);
                    }
                }
            });
            
            if (actualWeekCodes.size === 0) {
                return '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无周别数据</p>';
            }
            
            // 获取所有周别代码，按时间顺序排序（52, 53, 1, 2, 3...）
            const allWeekCodes = Array.from(actualWeekCodes);
            const sorted = sortWeekCodes(allWeekCodes);
            
            // 取前4个周别（当周+未来3周）
            const finalWeekCodes = sorted.slice(0, 4);
            
            if (finalWeekCodes.length === 0) {
                return '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无周别数据</p>';
            }
            
            // 按SQ/SC NAME分组，按周别分类
            const grouped = {};
            
            // 计算每个周别的总TEU（用于计算占比）
            const weekTotalTeu = {};
            filteredData.forEach(row => {
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                if (!weekValue) return;
                
                // 解析周别代码（使用新的parseWeekValue函数）
                const weekCode = parseWeekValue(weekValue);
                if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                if (!weekTotalTeu[weekCode]) {
                    weekTotalTeu[weekCode] = 0;
                }
                weekTotalTeu[weekCode] += teu;
            });
            
            filteredData.forEach(row => {
                const sqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                
                if (!weekValue) return;
                
                // 解析周别代码（使用新的parseWeekValue函数）
                const weekCode = parseWeekValue(weekValue);
                if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                
                if (!grouped[sqScName]) {
                    grouped[sqScName] = {
                        sqScName,
                        weeks: {}
                    };
                }
                
                if (!grouped[sqScName].weeks[weekCode]) {
                    grouped[sqScName].weeks[weekCode] = {
                        weekCode,
                        teu: 0,
                        tons: 0,
                        gps: [],
                        count: 0
                    };
                }
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                grouped[sqScName].weeks[weekCode].teu += teu;
                grouped[sqScName].weeks[weekCode].tons += tons;
                if (gps > 0) {
                    grouped[sqScName].weeks[weekCode].gps.push(gps);
                }
                grouped[sqScName].weeks[weekCode].count++;
            });
            
            // 生成表格 - 每个周别都有完整的列（参考Account+Dept的结构）
            let html = '<table style="width: 100%; border-collapse: collapse; background: white;"><thead>';
            // 第一行表头 - 使用主题蓝色渐变，白色字体和白色框线
            html += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;">SQ/SC NAME</th>';
            
            // 为每个周别添加表头
            finalWeekCodes.forEach(weekCode => {
                html += `<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">${weekCode}</th>`;
            });
            html += '</tr>';
            
            // 第二行表头 - 使用主题蓝色，白色字体和白色框线
            html += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            
            // 为每个周别添加子表头
            finalWeekCodes.forEach(() => {
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            });
            html += '</tr></thead><tbody>';
            
            // 按总TEU降序排序
            const sortedSqScNames = Object.keys(grouped).sort((a, b) => {
                let aTotal = 0;
                let bTotal = 0;
                Object.values(grouped[a].weeks).forEach(weekData => {
                    aTotal += weekData.teu || 0;
                });
                Object.values(grouped[b].weeks).forEach(weekData => {
                    bTotal += weekData.teu || 0;
                });
                return bTotal - aTotal; // 降序
            });
            
            sortedSqScNames.forEach(sqScName => {
                const item = grouped[sqScName];
                
                html += `<tr class="account-row" data-account-name="${escapeHtml(sqScName)}" style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="showAccountDetail('${escapeHtml(sqScName)}')">`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">${escapeHtml(sqScName)}</td>`;
                
                // 每个周别的列
                finalWeekCodes.forEach(weekCode => {
                    const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [], count: 0 };
                    const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                    const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                    const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                    
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.teu.toFixed(0)}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${percentage}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${avgGps}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.tons.toFixed(2)}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${tonsPerTeu}</td>`;
                });
                
                html += '</tr>';
            });
            
            // 合计行
            const totalWeekData = {};
            finalWeekCodes.forEach(weekCode => {
                totalWeekData[weekCode] = { teu: 0, tons: 0, gps: [] };
            });
            
            sortedSqScNames.forEach(sqScName => {
                const item = grouped[sqScName];
                finalWeekCodes.forEach(weekCode => {
                    const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [], count: 0 };
                    totalWeekData[weekCode].teu += weekData.teu;
                    totalWeekData[weekCode].tons += weekData.tons;
                    totalWeekData[weekCode].gps.push(...weekData.gps);
                });
            });
            
            html += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">合计</td>';
            
            finalWeekCodes.forEach(weekCode => {
                const weekData = totalWeekData[weekCode];
                const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${percentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${avgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${tonsPerTeu}</td>`;
            });
            
            html += '</tr>';
            
            html += '</tbody></table>';
            return html;
        }

        /**
         * 生成船名航次+Dept维度分析
         */
        function generateVesselDeptAnalysis() {
            // 按ETD(AD列)、EXP LINE(AC列)、VSL/VOY(G+H列)分组，按Dept分类
            const grouped = {};
            const deptList = ['AMS', 'EMS', 'IAS'];
            
            // 计算每个Dept的总TEU（用于计算占比）
            const deptTotalTeu = {};
            filteredData.forEach(row => {
                const dept = getColumnValue(row, COLUMN_MAP.DEPT) || '';
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                if (!deptTotalTeu[dept]) {
                    deptTotalTeu[dept] = 0;
                }
                deptTotalTeu[dept] += teu;
            });
            
            filteredData.forEach(row => {
                const etd = getColumnValue(row, COLUMN_MAP.SAIL_DATE) || '未指定';
                const expLine = getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定';
                const vessel = getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定';
                const voyage = getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定';
                const vslVoy = `${vessel}/${voyage}`;
                const dept = getColumnValue(row, COLUMN_MAP.DEPT) || '';
                
                // 使用 ETD + EXP_LINE + VSL/VOY 作为唯一键
                const key = `${etd}|${expLine}|${vslVoy}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        etd,
                        expLine,
                        vslVoy,
                        vessel,
                        voyage,
                        depts: {}
                    };
                }
                
                if (!grouped[key].depts[dept]) {
                    grouped[key].depts[dept] = {
                        dept,
                        teu: 0,
                        tons: 0,
                        gps: [],
                        count: 0
                    };
                }
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                grouped[key].depts[dept].teu += teu;
                grouped[key].depts[dept].tons += tons;
                if (gps > 0) {
                    grouped[key].depts[dept].gps.push(gps);
                }
                grouped[key].depts[dept].count++;
            });
            
            // 生成表格 - 每个Dept都有完整的列
            let html = '<table style="width: 100%; border-collapse: collapse; background: white; table-layout: fixed;"><thead>';
            // 第一行表头 - 使用主题蓝色渐变，白色字体和白色框线
            html += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">ETD</th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">EXP LINE</th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 8%;">VSL/VOY</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">AMS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">EMS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">IAS</th>';
            html += '<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">TOTAL</th>';
            html += '</tr>';
            // 第二行表头 - 使用主题蓝色，白色字体和白色框线
            html += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            // AMS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // EMS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // IAS列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            // TOTAL列
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
            html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            html += '</tr></thead><tbody>';
            
            // 按ETD时间升序排序，其次按EXP LINE升序排序
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                // 先按ETD升序排序
                let aEtdDate = null;
                let bEtdDate = null;
                
                // 尝试解析ETD为日期
                try {
                    if (grouped[a].etd && grouped[a].etd !== '未指定') {
                        aEtdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(grouped[a].etd) : null;
                        if (!aEtdDate && typeof grouped[a].etd === 'string') {
                            aEtdDate = new Date(grouped[a].etd);
                        }
                    }
                } catch (e) {
                    // 解析失败，使用字符串比较
                }
                
                try {
                    if (grouped[b].etd && grouped[b].etd !== '未指定') {
                        bEtdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(grouped[b].etd) : null;
                        if (!bEtdDate && typeof grouped[b].etd === 'string') {
                            bEtdDate = new Date(grouped[b].etd);
                        }
                    }
                } catch (e) {
                    // 解析失败，使用字符串比较
                }
                
                // 如果都能解析为日期，按日期比较
                if (aEtdDate && bEtdDate && !isNaN(aEtdDate.getTime()) && !isNaN(bEtdDate.getTime())) {
                    const dateDiff = aEtdDate.getTime() - bEtdDate.getTime();
                    if (dateDiff !== 0) {
                        return dateDiff; // 升序
                    }
                } else {
                    // 否则按字符串比较
                    const aEtd = String(grouped[a].etd || '');
                    const bEtd = String(grouped[b].etd || '');
                    const etdDiff = aEtd.localeCompare(bEtd);
                    if (etdDiff !== 0) {
                        return etdDiff;
                    }
                }
                
                // 如果ETD相同，按EXP LINE升序排序
                const aExpLine = String(grouped[a].expLine || '');
                const bExpLine = String(grouped[b].expLine || '');
                return aExpLine.localeCompare(bExpLine);
            });
            
            sortedKeys.forEach(key => {
                const item = grouped[key];
                const amsData = item.depts['AMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const emsData = item.depts['EMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const iasData = item.depts['IAS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                
                // 计算每个Dept的指标
                const amsAvgGps = amsData.gps.length > 0 ? (amsData.gps.reduce((a, b) => a + b, 0) / amsData.gps.length).toFixed(2) : '0.00';
                const amsTonsPerTeu = amsData.teu > 0 ? (amsData.tons / amsData.teu).toFixed(4) : '0.0000';
                const amsPercentage = deptTotalTeu['AMS'] > 0 ? ((amsData.teu / deptTotalTeu['AMS']) * 100).toFixed(2) + '%' : '0.00%';
                
                const emsAvgGps = emsData.gps.length > 0 ? (emsData.gps.reduce((a, b) => a + b, 0) / emsData.gps.length).toFixed(2) : '0.00';
                const emsTonsPerTeu = emsData.teu > 0 ? (emsData.tons / emsData.teu).toFixed(4) : '0.0000';
                const emsPercentage = deptTotalTeu['EMS'] > 0 ? ((emsData.teu / deptTotalTeu['EMS']) * 100).toFixed(2) + '%' : '0.00%';
                
                const iasAvgGps = iasData.gps.length > 0 ? (iasData.gps.reduce((a, b) => a + b, 0) / iasData.gps.length).toFixed(2) : '0.00';
                const iasTonsPerTeu = iasData.teu > 0 ? (iasData.tons / iasData.teu).toFixed(4) : '0.0000';
                const iasPercentage = deptTotalTeu['IAS'] > 0 ? ((iasData.teu / deptTotalTeu['IAS']) * 100).toFixed(2) + '%' : '0.00%';
                
                // 计算TOTAL
                const totalTeu = amsData.teu + emsData.teu + iasData.teu;
                const totalTons = amsData.tons + emsData.tons + iasData.tons;
                const allGps = [...amsData.gps, ...emsData.gps, ...iasData.gps];
                const totalAvgGps = allGps.length > 0 ? (allGps.reduce((a, b) => a + b, 0) / allGps.length).toFixed(2) : '0.00';
                const totalTonsPerTeu = totalTeu > 0 ? (totalTons / totalTeu).toFixed(4) : '0.0000';
                const totalDeptTeu = deptTotalTeu['AMS'] + deptTotalTeu['EMS'] + deptTotalTeu['IAS'];
                const totalPercentage = totalDeptTeu > 0 ? ((totalTeu / totalDeptTeu) * 100).toFixed(2) + '%' : '0.00%';
                
                // 格式化ETD日期
                let etdDisplay = item.etd;
                if (item.etd && item.etd !== '未指定') {
                    try {
                        const etdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(item.etd) : null;
                        if (etdDate) {
                            etdDisplay = formatDate(etdDate);
                        }
                    } catch (e) {
                        // 如果解析失败，使用原始值
                    }
                }
                
                html += `<tr class="vessel-row" data-vessel="${escapeHtml(item.vessel)}" data-voyage="${escapeHtml(item.voyage)}" style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="showVesselDetail('${escapeHtml(item.vessel)}', '${escapeHtml(item.voyage)}')">`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(etdDisplay)}">${escapeHtml(etdDisplay)}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.expLine)}">${escapeHtml(item.expLine)}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.vslVoy)}">${escapeHtml(item.vslVoy)}</td>`;
                
                // AMS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${amsTonsPerTeu}</td>`;
                
                // EMS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${emsTonsPerTeu}</td>`;
                
                // IAS列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${iasTonsPerTeu}</td>`;
                
                // TOTAL列
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalPercentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAvgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTonsPerTeu}</td>`;
                html += '</tr>';
            });
            
            // 合计行
            let totalAmsTeu = 0, totalAmsTons = 0, totalAmsGps = [];
            let totalEmsTeu = 0, totalEmsTons = 0, totalEmsGps = [];
            let totalIasTeu = 0, totalIasTons = 0, totalIasGps = [];
            
            sortedKeys.forEach(key => {
                const item = grouped[key];
                const amsData = item.depts['AMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const emsData = item.depts['EMS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                const iasData = item.depts['IAS'] || { teu: 0, tons: 0, gps: [], count: 0 };
                
                totalAmsTeu += amsData.teu;
                totalAmsTons += amsData.tons;
                totalAmsGps.push(...amsData.gps);
                
                totalEmsTeu += emsData.teu;
                totalEmsTons += emsData.tons;
                totalEmsGps.push(...emsData.gps);
                
                totalIasTeu += iasData.teu;
                totalIasTons += iasData.tons;
                totalIasGps.push(...iasData.gps);
            });
            
            const totalAmsAvgGps = totalAmsGps.length > 0 ? (totalAmsGps.reduce((a, b) => a + b, 0) / totalAmsGps.length).toFixed(2) : '0.00';
            const totalAmsTonsPerTeu = totalAmsTeu > 0 ? (totalAmsTons / totalAmsTeu).toFixed(4) : '0.0000';
            const totalAmsPercentage = deptTotalTeu['AMS'] > 0 ? ((totalAmsTeu / deptTotalTeu['AMS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalEmsAvgGps = totalEmsGps.length > 0 ? (totalEmsGps.reduce((a, b) => a + b, 0) / totalEmsGps.length).toFixed(2) : '0.00';
            const totalEmsTonsPerTeu = totalEmsTeu > 0 ? (totalEmsTons / totalEmsTeu).toFixed(4) : '0.0000';
            const totalEmsPercentage = deptTotalTeu['EMS'] > 0 ? ((totalEmsTeu / deptTotalTeu['EMS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalIasAvgGps = totalIasGps.length > 0 ? (totalIasGps.reduce((a, b) => a + b, 0) / totalIasGps.length).toFixed(2) : '0.00';
            const totalIasTonsPerTeu = totalIasTeu > 0 ? (totalIasTons / totalIasTeu).toFixed(4) : '0.0000';
            const totalIasPercentage = deptTotalTeu['IAS'] > 0 ? ((totalIasTeu / deptTotalTeu['IAS']) * 100).toFixed(2) + '%' : '0.00%';
            
            const totalTeu = totalAmsTeu + totalEmsTeu + totalIasTeu;
            const totalTons = totalAmsTons + totalEmsTons + totalIasTons;
            const allTotalGps = [...totalAmsGps, ...totalEmsGps, ...totalIasGps];
            const totalAvgGps = allTotalGps.length > 0 ? (allTotalGps.reduce((a, b) => a + b, 0) / allTotalGps.length).toFixed(2) : '0.00';
            const totalTonsPerTeu = totalTeu > 0 ? (totalTons / totalTeu).toFixed(4) : '0.0000';
            const totalDeptTeu = deptTotalTeu['AMS'] + deptTotalTeu['EMS'] + deptTotalTeu['IAS'];
            const totalPercentage = totalDeptTeu > 0 ? ((totalTeu / totalDeptTeu) * 100).toFixed(2) + '%' : '0.00%';
            
            html += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 5%;">合计</td>';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 5%;"></td>';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 8%;"></td>';
            
            // AMS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAmsTonsPerTeu}</td>`;
            
            // EMS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalEmsTonsPerTeu}</td>`;
            
            // IAS合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalIasTonsPerTeu}</td>`;
            
            // TOTAL合计
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalPercentage}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAvgGps}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTons.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTonsPerTeu}</td>`;
            html += '</tr>';
            
            html += '</tbody></table>';
            return html;
        }

        /**
         * 生成VSL/VOY + GPS维度分析
         */
        function generateVesselGpsAnalysis() {
            // 按ETD、EXP LINE、VSL/VOY、Trade、POD分组，显示各柜型TEU和GPS
            const grouped = {};
            
            // 柜型列映射
            const containerTypeMap = {
                'N': '2SD', 'O': '2RS', 'P': '4SD', 'Q': '4SH', 'R': '5SH',
                'S': '4RH', 'T': '2FO', 'U': '2FC', 'V': '4FO', 'W': '4FC'
            };
            const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
            
            filteredData.forEach(row => {
                const etd = getColumnValue(row, COLUMN_MAP.SAIL_DATE) || '未指定';
                const expLine = getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定';
                const vessel = getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定';
                const voyage = getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定';
                const vslVoy = `${vessel}/${voyage}`;
                const trade = getColumnValue(row, COLUMN_MAP.TRADE) || '未指定';
                const pod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                // 使用 ETD + EXP_LINE + VSL/VOY + Trade + POD 作为唯一键
                const key = `${etd}|${expLine}|${vslVoy}|${trade}|${pod}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        etd,
                        expLine,
                        vslVoy,
                        vessel,
                        voyage,
                        trade,
                        pod,
                        containerTypes: {},
                        totalTeu: 0,
                        gpsValues: []
                    };
                }
                
                // 统计各柜型TEU
                containerTypes.forEach(col => {
                    const teu = Number(getColumnValue(row, col) || 0);
                    if (teu > 0) {
                        const typeName = containerTypeMap[col];
                        if (!grouped[key].containerTypes[typeName]) {
                            grouped[key].containerTypes[typeName] = 0;
                        }
                        grouped[key].containerTypes[typeName] += teu;
                        grouped[key].totalTeu += teu;
                        
                        // 如果有GPS值，记录GPS（每个TEU对应一个GPS值）
                        if (gps > 0) {
                            for (let i = 0; i < teu; i++) {
                                grouped[key].gpsValues.push(gps);
                            }
                        }
                    }
                });
            });
            
            // 生成表格 - 两行表头
            const htmlParts = [];
            htmlParts.push('<table style="width: 100%; border-collapse: collapse; background: white; table-layout: fixed;"><thead>');
            // 第一行表头
            htmlParts.push('<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">ETD</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">航线</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 8%;">船名航次</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">Trade</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">POD</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">2SD</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">2RS</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">4SD</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">4SH</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">5SH</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">4RH</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">2FO</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">2FC</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">4FO</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">4FC</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">TTL TEU</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">GPS</th>');
            htmlParts.push('</tr>');
            // 第二行表头 - 蓝色整行遮挡，确保高度和其他维度一致
            htmlParts.push('<tr style="background: #3E62AD; border-bottom: 2px solid white;">');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('</tr></thead><tbody>');
            
            // 按ETD时间升序排序，其次按EXP LINE升序排序
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                // 先按ETD升序排序
                let aEtdDate = null;
                let bEtdDate = null;
                
                try {
                    if (grouped[a].etd && grouped[a].etd !== '未指定') {
                        aEtdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(grouped[a].etd) : null;
                        if (!aEtdDate && typeof grouped[a].etd === 'string') {
                            aEtdDate = new Date(grouped[a].etd);
                        }
                    }
                } catch (e) {}
                
                try {
                    if (grouped[b].etd && grouped[b].etd !== '未指定') {
                        bEtdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(grouped[b].etd) : null;
                        if (!bEtdDate && typeof grouped[b].etd === 'string') {
                            bEtdDate = new Date(grouped[b].etd);
                        }
                    }
                } catch (e) {}
                
                if (aEtdDate && bEtdDate && !isNaN(aEtdDate.getTime()) && !isNaN(bEtdDate.getTime())) {
                    const dateDiff = aEtdDate.getTime() - bEtdDate.getTime();
                    if (dateDiff !== 0) return dateDiff;
                } else {
                    const aEtd = String(grouped[a].etd || '');
                    const bEtd = String(grouped[b].etd || '');
                    const etdDiff = aEtd.localeCompare(bEtd);
                    if (etdDiff !== 0) return etdDiff;
                }
                
                // 如果ETD相同，按EXP LINE升序排序
                const aExpLine = String(grouped[a].expLine || '');
                const bExpLine = String(grouped[b].expLine || '');
                return aExpLine.localeCompare(bExpLine);
            });
            
            sortedKeys.forEach(key => {
                const item = grouped[key];
                
                // 格式化ETD日期
                let etdDisplay = item.etd;
                if (item.etd && item.etd !== '未指定') {
                    try {
                        const etdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(item.etd) : null;
                        if (etdDate) {
                            etdDisplay = formatDate(etdDate);
                        }
                    } catch (e) {}
                }
                
                // 计算平均GPS
                const avgGps = item.gpsValues.length > 0 
                    ? (item.gpsValues.reduce((a, b) => a + b, 0) / item.gpsValues.length).toFixed(2)
                    : '0.00';
                
                const rowParts = [];
                // 对key进行转义，但保留用于onclick的原始key（使用单引号包裹，并转义单引号和反斜杠）
                const escapedKeyForAttr = escapeHtml(key);
                // 对于onclick，需要转义单引号、反斜杠，但保留|字符用于split
                const escapedKeyForOnclick = key.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                rowParts.push(`<tr class="vessel-gps-row" data-key="${escapedKeyForAttr}" style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="window.showVesselGpsDetail('${escapedKeyForOnclick}')">`);
                rowParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(etdDisplay)}">${escapeHtml(etdDisplay)}</td>`);
                rowParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.expLine)}">${escapeHtml(item.expLine)}</td>`);
                rowParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.vslVoy)}">${escapeHtml(item.vslVoy)}</td>`);
                rowParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.trade)}">${escapeHtml(item.trade)}</td>`);
                rowParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.pod)}">${escapeHtml(item.pod)}</td>`);
                
                // 各柜型TEU
                containerTypes.forEach(col => {
                    const typeName = containerTypeMap[col];
                    const teu = item.containerTypes[typeName] || 0;
                    rowParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; width: 4%;">${teu.toFixed(0)}</td>`);
                });
                
                // TTL TEU 和 GPS
                rowParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600; width: 4%;">${item.totalTeu.toFixed(0)}</td>`);
                rowParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600; width: 4%;">${avgGps}</td>`);
                rowParts.push('</tr>');
                htmlParts.push(rowParts.join(''));
            });
            
            // 合计行
            let totalTeu = 0;
            let totalGpsValues = [];
            const totalContainerTypes = {};
            
            sortedKeys.forEach(key => {
                const item = grouped[key];
                totalTeu += item.totalTeu;
                totalGpsValues.push(...item.gpsValues);
                containerTypes.forEach(col => {
                    const typeName = containerTypeMap[col];
                    if (!totalContainerTypes[typeName]) {
                        totalContainerTypes[typeName] = 0;
                    }
                    totalContainerTypes[typeName] += item.containerTypes[typeName] || 0;
                });
            });
            
            const totalAvgGps = totalGpsValues.length > 0 
                ? (totalGpsValues.reduce((a, b) => a + b, 0) / totalGpsValues.length).toFixed(2)
                : '0.00';
            
            const totalRowParts = [];
            totalRowParts.push('<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">');
            totalRowParts.push('<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">合计</td>');
            totalRowParts.push('<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;"></td>');
            totalRowParts.push('<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;"></td>');
            totalRowParts.push('<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;"></td>');
            totalRowParts.push('<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;"></td>');
            
            containerTypes.forEach(col => {
                const typeName = containerTypeMap[col];
                const teu = totalContainerTypes[typeName] || 0;
                totalRowParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${teu.toFixed(0)}</td>`);
            });
            
            totalRowParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`);
            totalRowParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalAvgGps}</td>`);
            totalRowParts.push('</tr>');
            htmlParts.push(totalRowParts.join(''));
            htmlParts.push('</tbody></table>');
            
            return htmlParts.join('');
        }

        /**
         * 生成VSL/VOY + Limit维度分析
         * 第一列ETD，第二列周（AE列），第三列Trade（AA列），第四列EXP LINE，第五列VSL/VOY
         * 第六~十列：TEU、占比、AVG GPS、TONS、TONS/TEU
         * 第11列：Allocation（从sheet10的"2025"表读取，K列trade+L列service匹配，取N列allocation）
         * 第12列：L/F（TEU/Allocation，百分比）
         */
        function generateVesselLimitAnalysis() {
            // 按ETD、周、Trade、EXP LINE、VSL/VOY分组
            const grouped = {};
            
            // 计算总TEU（用于计算占比）
            let totalTeu = 0;
            filteredData.forEach(row => {
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                totalTeu += teu;
            });
            
            filteredData.forEach(row => {
                const etd = getColumnValue(row, COLUMN_MAP.SAIL_DATE) || '未指定';
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                const weekCode = weekValue ? parseWeekValue(weekValue) : '未指定';
                const trade = getColumnValue(row, COLUMN_MAP.TRADE) || '未指定';
                const expLine = getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定';
                const vessel = getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定';
                const voyage = getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定';
                const vslVoy = `${vessel}/${voyage}`;
                
                // 使用 ETD + 周 + Trade + EXP_LINE + VSL/VOY 作为唯一键
                const key = `${etd}|${weekCode}|${trade}|${expLine}|${vslVoy}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        etd,
                        weekCode,
                        trade,
                        expLine,
                        vslVoy,
                        teu: 0,
                        tons: 0,
                        gps: [],
                        count: 0
                    };
                }
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                grouped[key].teu += teu;
                grouped[key].tons += tons;
                if (gps > 0) {
                    grouped[key].gps.push(gps);
                }
                grouped[key].count++;
            });
            
            // 按ETD升序、EXP LINE升序、VSL/VOY升序、Trade升序排序
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const [etdA, weekA, tradeA, expLineA, vslVoyA] = a.split('|');
                const [etdB, weekB, tradeB, expLineB, vslVoyB] = b.split('|');
                
                // 先按ETD排序（升序）
                if (etdA !== etdB) {
                    // 尝试转换为日期比较
                    if (typeof window.parseExcelDateSerial === 'function') {
                        const dateA = window.parseExcelDateSerial(etdA);
                        const dateB = window.parseExcelDateSerial(etdB);
                        if (dateA && dateB) {
                            return dateA.getTime() - dateB.getTime();
                        }
                    }
                    return etdA.localeCompare(etdB);
                }
                // 再按EXP LINE排序（升序）
                if (expLineA !== expLineB) {
                    return expLineA.localeCompare(expLineB);
                }
                // 再按VSL/VOY排序（升序）
                if (vslVoyA !== vslVoyB) {
                    return vslVoyA.localeCompare(vslVoyB);
                }
                // 最后按Trade排序（升序）
                return tradeA.localeCompare(tradeB);
            });
            
            // 生成表格HTML - 两行表头结构（参考VSL/VOY + GPS）
            const htmlParts = [];
            htmlParts.push('<table style="width: 100%; border-collapse: collapse; background: white; table-layout: fixed;"><thead>');
            // 第一行表头
            htmlParts.push('<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">Week</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">ETD</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">EXP LINE</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 8%;">VSL/VOY</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">Trade</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">TEU</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">占比</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">AVG GPS</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">TONS</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">TONS/TEU</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">Allocation</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; width: 4%;">L/F</th>');
            htmlParts.push('</tr>');
            // 第二行表头 - 蓝色整行遮挡，确保高度和其他维度一致
            htmlParts.push('<tr style="background: #3E62AD; border-bottom: 2px solid white;">');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white; height: 40px;">&nbsp;</th>');
            htmlParts.push('</tr></thead><tbody>');
            
            sortedKeys.forEach(key => {
                const item = grouped[key];
                const avgGps = item.gps.length > 0 
                    ? (item.gps.reduce((a, b) => a + b, 0) / item.gps.length).toFixed(2)
                    : '0.00';
                const percentage = totalTeu > 0 ? ((item.teu / totalTeu) * 100).toFixed(2) : '0.00';
                const tonsPerTeu = item.teu > 0 ? (item.tons / item.teu).toFixed(2) : '0.00';
                
                // 格式化ETD显示
                let etdDisplay = item.etd;
                if (item.etd && typeof window.parseExcelDateSerial === 'function') {
                    const parsedDate = window.parseExcelDateSerial(item.etd);
                    if (parsedDate) {
                        etdDisplay = parsedDate.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    }
                }
                
                // 获取Allocation（优先使用用户编辑的数据，否则使用导入的数据）
                // 匹配逻辑：sheet10的K列(trade) + L列(service) 对应 主表的trade + EXP LINE
                // 构建key时，统一trim和转大写，确保匹配
                const tradeKey = String(item.trade || '').trim().toUpperCase();
                const expLineKey = String(item.expLine || '').trim().toUpperCase();
                const allocationKey = `${tradeKey}|${expLineKey}`;
                
                let allocation = userAllocationData[allocationKey];
                if (allocation === undefined || allocation === null) {
                    // 尝试精确匹配
                    allocation = allocationData[allocationKey];
                    
                    // 如果精确匹配失败，尝试不区分大小写匹配
                    if (allocation === undefined || allocation === null) {
                        const lowerKey = allocationKey.toLowerCase();
                        for (const [dataKey, dataValue] of Object.entries(allocationData)) {
                            if (dataKey.toLowerCase() === lowerKey) {
                                allocation = dataValue;
                                break;
                            }
                        }
                    }
                    
                    // 如果还是没找到，尝试只匹配trade（可能service为空或不同）
                    if (allocation === undefined || allocation === null) {
                        for (const [dataKey, dataValue] of Object.entries(allocationData)) {
                            const [dataTrade] = dataKey.split('|');
                            if (dataTrade && dataTrade.trim().toUpperCase() === tradeKey) {
                                // 如果trade匹配，使用这个值（可能service不同但trade相同）
                                allocation = dataValue;
                                break;
                            }
                        }
                    }
                    
                    if (allocation === undefined || allocation === null) {
                        allocation = 0;
                    }
                }
                
                // 调试信息（显示前10条和未匹配的记录）
                const rowIndex = sortedKeys.indexOf(key);
                if (rowIndex < 10 || allocation === 0) {
                    debugLog(`[Allocation匹配] 行${rowIndex + 1}: trade="${item.trade}", expLine="${item.expLine}", key="${allocationKey}", allocation=${allocation}`);
                }
                
                // 计算L/F（TEU/Allocation，百分比）
                const loadFactor = allocation > 0 ? ((item.teu / allocation) * 100).toFixed(2) : '0.00';
                
                // 为onclick准备key，需要转义单引号、反斜杠，但保留|字符用于split
                const escapedKeyForOnclick = key.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const escapedKeyForAttr = escapeHtml(key);
                
                htmlParts.push(`<tr style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="window.showVesselLimitDetail('${escapedKeyForOnclick}')">`);
                htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.weekCode)}</td>`);
                htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(etdDisplay)}">${escapeHtml(etdDisplay)}</td>`);
                htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.expLine)}</td>`);
                htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.vslVoy)}</td>`);
                htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.trade)}</td>`);
                htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${item.teu.toFixed(0)}</td>`);
                htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${percentage}%</td>`);
                htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${avgGps}</td>`);
                htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${item.tons.toFixed(2)}</td>`);
                htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${tonsPerTeu}</td>`);
                
                // Allocation列：可编辑
                const allocationId = `allocation-${key.replace(/[|]/g, '-')}`;
                htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;"><input type="number" id="${allocationId}" value="${allocation}" style="width: 100%; text-align: right; border: 1px solid #ccc; padding: 4px; border-radius: 4px;" data-key="${escapeHtml(allocationKey)}" onchange="window.updateAllocation('${escapeHtml(allocationKey)}', this.value)"></td>`);
                
                // L/F列：自动计算
                const loadFactorId = `loadfactor-${key.replace(/[|]/g, '-')}`;
                htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;" id="${loadFactorId}">${loadFactor}%</td>`);
                
                htmlParts.push('</tr>');
            });
            
            htmlParts.push('</tbody></table>');
            
            return htmlParts.join('');
        }

        /**
         * 更新Allocation值并重新计算L/F
         */
        window.updateAllocation = function(allocationKey, value) {
            const numValue = Number(value) || 0;
            
            // 如果值为0或空，删除用户修改（恢复为Excel标准值）
            if (numValue === 0 || !value || value === '') {
                delete userAllocationData[allocationKey];
            } else {
                userAllocationData[allocationKey] = numValue;
            }
            
            // 保存到localStorage
            saveUserAllocationData();
            
            // 找到所有相关的行，更新L/F
            // 使用CSS选择器转义特殊字符
            const escapedKey = allocationKey.replace(/[|]/g, '\\|').replace(/"/g, '\\"');
            const rows = document.querySelectorAll(`input[data-key="${escapedKey}"]`);
            rows.forEach(input => {
                const row = input.closest('tr');
                if (row) {
                    const teuCell = row.querySelector('td:nth-child(6)');
                    const loadFactorCell = row.querySelector('td:nth-child(12)');
                    if (teuCell && loadFactorCell) {
                        const teu = Number(teuCell.textContent.replace(/,/g, '')) || 0;
                        const loadFactor = numValue > 0 ? ((teu / numValue) * 100).toFixed(2) : '0.00';
                        loadFactorCell.textContent = loadFactor + '%';
                    }
                }
            });
        };

        /**
         * 显示VSL/VOY + Limit详细资料弹窗
         * key格式：ETD|Week|Trade|EXP_LINE|VSL/VOY
         */
        window.showVesselLimitDetail = function(key) {
            // 解析key
            if (!key) {
                alert('数据格式错误：key为空');
                return;
            }
            const parts = key.split('|');
            if (parts.length < 5) {
                alert('数据格式错误：key格式不正确');
                return;
            }
            
            const [etd, weekCode, trade, expLine, vslVoy] = parts;
            
            // 获取匹配的数据（该VSL/VOY + TRADE下的所有数据）
            const etdStr = String(etd);
            const detailData = filteredData.filter(row => {
                const rowEtd = getColumnValue(row, COLUMN_MAP.SAIL_DATE);
                const rowEtdStr = rowEtd ? String(rowEtd) : '未指定';
                const rowWeekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                const rowWeekCode = rowWeekValue ? parseWeekValue(rowWeekValue) : '未指定';
                const rowTrade = String(getColumnValue(row, COLUMN_MAP.TRADE) || '未指定');
                const rowExpLine = String(getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定');
                const rowVessel = String(getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定');
                const rowVoyage = String(getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定');
                const rowVslVoy = `${rowVessel}/${rowVoyage}`;
                
                return rowEtdStr === etdStr && 
                       rowWeekCode === weekCode &&
                       rowTrade === trade && 
                       rowExpLine === expLine && 
                       rowVslVoy === vslVoy;
            });
            
            if (detailData.length === 0) {
                alert('没有找到匹配的数据');
                return;
            }
            
            // 收集所有POD（用于目的港排除选项）
            const podSet = new Set();
            detailData.forEach(row => {
                const pod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                if (pod && pod !== '未指定') {
                    podSet.add(pod);
                }
            });
            const allPods = Array.from(podSet).sort();
            
            // 创建弹窗
            const modal = document.createElement('div');
            modal.id = 'vesselLimitDetailModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;';
            modalContent.addEventListener('click', (e) => e.stopPropagation());
            
            // 标题栏
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;';
            header.innerHTML = `
                <h3 style="margin: 0; color: #333;">${escapeHtml(vslVoy)} - ${escapeHtml(trade)} 详细资料</h3>
                <button class="btn-sweep-blue" onclick="this.closest('#vesselLimitDetailModal').remove()" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">关闭</button>
            `;
            
            // 目的港排除选项区域
            const podFilterSection = document.createElement('div');
            podFilterSection.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; flex-shrink: 0;';
            podFilterSection.innerHTML = `
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #495057;">目的港排除选项（可多选）</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                    ${allPods.map(pod => `
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" class="pod-exclude-checkbox" value="${escapeHtml(pod)}" style="margin-right: 8px;">
                            <span>${escapeHtml(pod)}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            
            // 数据表格区域
            const tableSection = document.createElement('div');
            tableSection.style.cssText = 'flex: 1; overflow: auto;';
            tableSection.id = 'vesselLimitDetailTableSection';
            
            modalContent.appendChild(header);
            modalContent.appendChild(podFilterSection);
            modalContent.appendChild(tableSection);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 生成详细表格
            function generateDetailTable(excludedPods = []) {
                // 筛选数据（排除选中的POD）
                const filteredDetailData = detailData.filter(row => {
                    const pod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                    return !excludedPods.includes(pod);
                });
                
                // 按EXP LINE、VSL/VOY、Trade、SQ/SC Name、SQ/SC、SalesID分组
                const grouped = {};
                
                filteredDetailData.forEach(row => {
                    const rowExpLine = getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定';
                    const rowVessel = getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定';
                    const rowVoyage = getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定';
                    const rowVslVoy = `${rowVessel}/${rowVoyage}`;
                    const rowTrade = getColumnValue(row, COLUMN_MAP.TRADE) || '未指定';
                    const rowSqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                    const rowSqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                    const rowSalesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                    
                    const detailKey = `${rowExpLine}|${rowVslVoy}|${rowTrade}|${rowSqScName}|${rowSqSc}|${rowSalesId}`;
                    
                    if (!grouped[detailKey]) {
                        grouped[detailKey] = {
                            expLine: rowExpLine,
                            vslVoy: rowVslVoy,
                            trade: rowTrade,
                            sqScName: rowSqScName,
                            sqSc: rowSqSc,
                            salesId: rowSalesId,
                            teu: 0
                        };
                    }
                    
                    const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                    grouped[detailKey].teu += teu;
                });
                
                // 计算每个item的Over值，用于排序
                const itemsWithOver = Object.keys(grouped).map(detailKey => {
                    const item = grouped[detailKey];
                    // 匹配Limit数据：A列trade + B列SVC + E列SQ/SC
                    const tradeKey = String(item.trade || '').trim().toUpperCase();
                    const svcKey = String(item.expLine || '').trim().toUpperCase();
                    const sqScKey = String(item.sqSc || '').trim().toUpperCase();
                    const limitKey = `${tradeKey}|${svcKey}|${sqScKey}`;
                    
                    let limit = limitData[limitKey];
                    if (limit === undefined || limit === null) {
                        limit = 0;
                    }
                    
                    // 计算Over（TEU - Limit）
                    const over = item.teu - limit;
                    
                    return {
                        key: detailKey,
                        item: item,
                        limit: limit,
                        over: over
                    };
                });
                
                // 按Over降序排序
                itemsWithOver.sort((a, b) => {
                    return b.over - a.over; // 降序：大的在前
                });
                
                // 生成表格HTML
                const htmlParts = [];
                htmlParts.push('<div style="border-radius: 8px; overflow: hidden; border: 1px solid #dee2e6;">');
                htmlParts.push('<table style="width: 100%; border-collapse: collapse; border-spacing: 0; table-layout: fixed;">');
                htmlParts.push('<thead>');
                htmlParts.push('<tr style="background: #3E62AD; color: white;">');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: left;">EXP LINE</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: left;">VSL/VOY</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: left;">Trade</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: left;">SQ/SC Name</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: left;">SQ/SC</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: left;">SalesID</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: right;">TEU合计</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: right;">Limit</th>');
                htmlParts.push('<th style="padding: 8px 12px; border: 1px solid white; text-align: right;">Over</th>');
                htmlParts.push('</tr>');
                htmlParts.push('</thead>');
                htmlParts.push('<tbody>');
                
                itemsWithOver.forEach(({ key, item, limit, over }) => {
                    const overBgColor = over > 15 ? '#ff9800' : 'transparent'; // 超过15则橙色背景
                    
                    // 为onclick准备key，需要转义单引号、反斜杠，但保留|字符用于split
                    const blDetailKey = `${item.expLine}|${item.vslVoy}|${item.trade}|${item.sqScName}|${item.sqSc}|${item.salesId}`;
                    const escapedBlKeyForOnclick = blDetailKey.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                    
                    htmlParts.push(`<tr style="cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="window.showVesselLimitBlDetail('${escapedBlKeyForOnclick}')">`);
                    htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.expLine)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.vslVoy)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.trade)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.sqScName)}">${escapeHtml(item.sqScName)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.sqSc)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(item.salesId)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${item.teu.toFixed(0)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${limit.toFixed(0)}</td>`);
                    htmlParts.push(`<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600; background-color: ${overBgColor};">${over.toFixed(0)}</td>`);
                    htmlParts.push('</tr>');
                });
                
                htmlParts.push('</tbody></table>');
                htmlParts.push('</div>');
                return htmlParts.join('');
            }
            
            // 初始生成表格
            tableSection.innerHTML = generateDetailTable([]);
            
            // 复选框change事件，自动应用筛选
            podFilterSection.querySelectorAll('.pod-exclude-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const excludedPods = Array.from(podFilterSection.querySelectorAll('.pod-exclude-checkbox:checked'))
                        .map(cb => cb.value);
                    tableSection.innerHTML = generateDetailTable(excludedPods);
                });
            });
        };

        /**
         * 通用BL详细资料弹窗函数
         * filterParams: 筛选条件对象，包含以下可选字段：
         *   - salesId: SalesID
         *   - sqScName: SQ/SC NAME
         *   - sqSc: SQ/SC
         *   - vslVoy: VSL/VOY (格式: "VESSEL/VOYAGE")
         *   - trade: Trade
         *   - pod: POD
         *   - weekCode: Week代码
         */
        window.showBlDetail = function(filterParams) {
            // 如果传入的是字符串（JSON），则解析它
            if (typeof filterParams === 'string') {
                try {
                    // 将HTML实体编码的双引号转换回普通双引号
                    filterParams = filterParams.replace(/&quot;/g, '"');
                    filterParams = JSON.parse(filterParams);
                } catch (e) {
                    alert('数据格式错误：无法解析筛选参数');
                    return;
                }
            }
            
            if (!filterParams || typeof filterParams !== 'object') {
                alert('数据格式错误：筛选参数无效');
                return;
            }
            
            // 从filteredData中筛选匹配的BL数据
            const blDetailData = filteredData.filter(row => {
                let match = true;
                
                if (filterParams.salesId !== undefined) {
                    const rowSalesId = String(getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定');
                    if (rowSalesId !== String(filterParams.salesId)) match = false;
                }
                
                if (filterParams.sqScName !== undefined && match) {
                    const rowSqScName = String(getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定');
                    if (rowSqScName !== String(filterParams.sqScName)) match = false;
                }
                
                if (filterParams.sqSc !== undefined && match) {
                    const rowSqSc = String(getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定');
                    if (rowSqSc !== String(filterParams.sqSc)) match = false;
                }
                
                if (filterParams.vslVoy !== undefined && match) {
                    const rowVessel = String(getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定');
                    const rowVoyage = String(getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定');
                    const rowVslVoy = `${rowVessel}/${rowVoyage}`;
                    if (rowVslVoy !== String(filterParams.vslVoy)) match = false;
                }
                
                if (filterParams.trade !== undefined && match) {
                    const rowTrade = String(getColumnValue(row, COLUMN_MAP.TRADE) || '未指定');
                    if (rowTrade !== String(filterParams.trade)) match = false;
                }
                
                if (filterParams.pod !== undefined && match) {
                    const rowPod = String(getColumnValue(row, COLUMN_MAP.POD) || '未指定');
                    if (rowPod !== String(filterParams.pod)) match = false;
                }
                
                if (filterParams.weekCode !== undefined && match) {
                    const rowWeekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                    const rowWeekCode = rowWeekValue ? parseWeekValue(rowWeekValue) : '未指定';
                    if (rowWeekCode !== String(filterParams.weekCode)) match = false;
                }
                
                return match;
            });
            
            if (blDetailData.length === 0) {
                alert('没有找到匹配的BL数据');
                return;
            }
            
            // 柜型列映射
            const containerTypeMap = {
                'N': '2SD', 'O': '2RS', 'P': '4SD', 'Q': '4SH', 'R': '5SH',
                'S': '4RH', 'T': '2FO', 'U': '2FC', 'V': '4FO', 'W': '4FC'
            };
            const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
            
            // 创建BL详细资料弹窗
            const blModal = document.createElement('div');
            blModal.id = 'blDetailModal-' + Date.now();
            blModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center;';
            
            blModal.addEventListener('click', (e) => {
                if (e.target === blModal) {
                    blModal.remove();
                }
            });
            
            const blContent = document.createElement('div');
            blContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            blContent.addEventListener('click', (e) => e.stopPropagation());
            
            // 标题栏
            const blHeader = document.createElement('div');
            blHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
            blHeader.innerHTML = `
                <h3 style="margin: 0; color: #333;">详细BL资料 (${blDetailData.length} 条记录)</h3>
                <button class="btn-sweep-blue" onclick="this.closest('[id^=\\'blDetailModal-\\']').remove()" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">关闭</button>
            `;
            
            // 生成表格
            let blHtml = `
                <div class="detail-table-container">
                <table style="width: 100%; border-collapse: collapse; border-spacing: 0; table-layout: fixed;">
                <thead>
                <tr style="background: #3E62AD; color: white;">
                    <th style="padding: 12px; border: 1px solid white; width: auto;">BLNO</th>
                    <th style="padding: 12px; border: 1px solid white; width: 200px;">POL/POD</th>
                    <th style="padding: 12px; border: 1px solid white; width: auto;">SalesID</th>
                    <th style="padding: 12px; border: 1px solid white; width: auto;">SQ/SC</th>
                    <th style="padding: 12px; border: 1px solid white; width: auto;">SQ/SC NAME</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2SD</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2RS</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4SD</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4SH</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">5SH</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4RH</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2FO</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2FC</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4FO</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4FC</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">TTL TEU</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">GPS</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">TON</th>
                </tr>
                </thead>
                <tbody>
            `;
            
            blDetailData.forEach((row, index) => {
                const blno = getColumnValue(row, COLUMN_MAP.BLNO) || '未指定';
                const colI = getColumnValue(row, COLUMN_MAP.COL_I) || ''; // I列 POL
                const colL = getColumnValue(row, COLUMN_MAP.COL_L) || ''; // L列 POD
                const polPod = [colI, colL].filter(v => v).join(' / '); // POL/POD：I列和L列组合
                const rowSalesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                const rowSqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                const rowSqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000; // TON (Y列/1000)
                
                let totalTeu = 0;
                const containerTeus = {};
                
                containerTypes.forEach(col => {
                    const teu = Number(getColumnValue(row, col) || 0);
                    const typeName = containerTypeMap[col];
                    containerTeus[typeName] = teu;
                    totalTeu += teu;
                });
                
                blHtml += '<tr>';
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(blno)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; white-space: normal; word-wrap: break-word;">${escapeHtml(polPod)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(rowSalesId)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(rowSqSc)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(rowSqScName)}">${escapeHtml(rowSqScName)}</td>`;
                
                containerTypes.forEach(col => {
                    const typeName = containerTypeMap[col];
                    const teu = containerTeus[typeName] || 0;
                    blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${teu.toFixed(0)}</td>`;
                });
                
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${gps.toFixed(2)}</td>`;
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${tons.toFixed(2)}</td>`;
                blHtml += '</tr>';
            });
            
            blHtml += '</tbody></table></div>';
            
            blContent.appendChild(blHeader);
            blContent.insertAdjacentHTML('beforeend', blHtml);
            blModal.appendChild(blContent);
            document.body.appendChild(blModal);
        };

        /**
         * 显示VSL/VOY + Limit详细BL资料弹窗
         * key格式：EXP_LINE|VSL/VOY|Trade|SQ/SC_NAME|SQ/SC|SalesID
         */
        window.showVesselLimitBlDetail = function(key) {
            // 解析key
            if (!key) {
                alert('数据格式错误：key为空');
                return;
            }
            const parts = key.split('|');
            if (parts.length < 6) {
                alert('数据格式错误：key格式不正确');
                return;
            }
            
            const [expLine, vslVoy, trade, sqScName, sqSc, salesId] = parts;
            
            // 获取匹配的BL数据（根据EXP LINE、VSL/VOY、Trade、SQ/SC Name、SQ/SC、SalesID筛选）
            // 同时需要考虑当前弹窗中已排除的POD
            const currentExcludedPods = [];
            const currentModal = document.getElementById('vesselLimitDetailModal');
            if (currentModal) {
                const checkboxes = currentModal.querySelectorAll('.pod-exclude-checkbox:checked');
                currentExcludedPods.push(...Array.from(checkboxes).map(cb => cb.value));
            }
            
            // 从filteredData中筛选匹配的BL数据
            const blDetailData = filteredData.filter(row => {
                const rowExpLine = String(getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定');
                const rowVessel = String(getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定');
                const rowVoyage = String(getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定');
                const rowVslVoy = `${rowVessel}/${rowVoyage}`;
                const rowTrade = String(getColumnValue(row, COLUMN_MAP.TRADE) || '未指定');
                const rowSqScName = String(getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定');
                const rowSqSc = String(getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定');
                const rowSalesId = String(getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定');
                const rowPod = getColumnValue(row, COLUMN_MAP.POD) || '未指定';
                
                // 匹配条件：EXP LINE、VSL/VOY、Trade、SQ/SC Name、SQ/SC、SalesID
                const match = rowExpLine === expLine && 
                             rowVslVoy === vslVoy && 
                             rowTrade === trade && 
                             rowSqScName === sqScName && 
                             rowSqSc === sqSc && 
                             rowSalesId === salesId &&
                             !currentExcludedPods.includes(rowPod);
                
                return match;
            });
            
            if (blDetailData.length === 0) {
                alert('没有找到匹配的BL数据');
                return;
            }
            
            // 柜型列映射
            const containerTypeMap = {
                'N': '2SD', 'O': '2RS', 'P': '4SD', 'Q': '4SH', 'R': '5SH',
                'S': '4RH', 'T': '2FO', 'U': '2FC', 'V': '4FO', 'W': '4FC'
            };
            const containerTypes = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'];
            
            // 创建BL详细资料弹窗
            const blModal = document.createElement('div');
            blModal.id = 'vesselLimitBlDetailModal';
            blModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center;';
            
            blModal.addEventListener('click', (e) => {
                if (e.target === blModal) {
                    blModal.remove();
                }
            });
            
            const blContent = document.createElement('div');
            blContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            blContent.addEventListener('click', (e) => e.stopPropagation());
            
            // 标题栏
            const blHeader = document.createElement('div');
            blHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
            blHeader.innerHTML = `
                <h3 style="margin: 0; color: #333;">超舱客户详细BL资料 (${blDetailData.length} 条记录)</h3>
                <button class="btn-sweep-blue" onclick="this.closest('#vesselLimitBlDetailModal').remove()" style="padding: 8px 16px; background: #3E62AD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">关闭</button>
            `;
            
            // 生成表格
            let blHtml = `
                <div class="detail-table-container">
                <table style="width: 100%; border-collapse: collapse; border-spacing: 0; table-layout: fixed;">
                <thead>
                <tr style="background: #3E62AD; color: white;">
                    <th style="padding: 12px; border: 1px solid white; width: auto;">BLNO</th>
                    <th style="padding: 12px; border: 1px solid white; width: 200px;">POL/POD</th>
                    <th style="padding: 12px; border: 1px solid white; width: auto;">SalesID</th>
                    <th style="padding: 12px; border: 1px solid white; width: auto;">SQ/SC</th>
                    <th style="padding: 12px; border: 1px solid white; width: auto;">SQ/SC NAME</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2SD</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2RS</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4SD</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4SH</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">5SH</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4RH</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2FO</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">2FC</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4FO</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">4FC</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">TTL TEU</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid white; width: auto;">GPS</th>
                </tr>
                </thead>
                <tbody>
            `;
            
            blDetailData.forEach((row, index) => {
                const blno = getColumnValue(row, COLUMN_MAP.BLNO) || '未指定';
                const colI = getColumnValue(row, COLUMN_MAP.COL_I) || ''; // I列 POL
                const colL = getColumnValue(row, COLUMN_MAP.COL_L) || ''; // L列 POD
                const polPod = [colI, colL].filter(v => v).join(' / '); // POL/POD：I列和L列组合
                const rowSalesId = getColumnValue(row, COLUMN_MAP.SALES_ID) || '未指定';
                const rowSqSc = getColumnValue(row, COLUMN_MAP.SQ_SC) || '未指定';
                const rowSqScName = getColumnValue(row, COLUMN_MAP.SQ_SC_NAME) || '未指定';
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                let totalTeu = 0;
                const containerTeus = {};
                
                containerTypes.forEach(col => {
                    const teu = Number(getColumnValue(row, col) || 0);
                    const typeName = containerTypeMap[col];
                    containerTeus[typeName] = teu;
                    totalTeu += teu;
                });
                
                blHtml += '<tr>';
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(blno)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; white-space: normal; word-wrap: break-word;">${escapeHtml(polPod)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(rowSalesId)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(rowSqSc)}</td>`;
                blHtml += `<td style="padding: 10px; border: 1px solid #dee2e6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(rowSqScName)}">${escapeHtml(rowSqScName)}</td>`;
                
                containerTypes.forEach(col => {
                    const typeName = containerTypeMap[col];
                    const teu = containerTeus[typeName] || 0;
                    blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${teu.toFixed(0)}</td>`;
                });
                
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${totalTeu.toFixed(0)}</td>`;
                blHtml += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${gps.toFixed(2)}</td>`;
                blHtml += '</tr>';
            });
            
            blHtml += '</tbody></table></div>';
            
            blContent.appendChild(blHeader);
            blContent.insertAdjacentHTML('beforeend', blHtml);
            blModal.appendChild(blContent);
            document.body.appendChild(blModal);
        };

        /**
         * 生成船名航次+Week维度分析
         */
        function generateVesselWeekAnalysis() {
            // 从数据中收集所有实际存在的周别代码（从AE列）
            const actualWeekCodes = new Set();
            filteredData.forEach(row => {
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                if (weekValue) {
                    // 解析周别代码（支持多种格式，包括只有周数的情况）
                    const weekCode = parseWeekValue(weekValue);
                    if (weekCode) {
                        actualWeekCodes.add(weekCode);
                    }
                }
            });
            
            if (actualWeekCodes.size === 0) {
                return '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无周别数据</p>';
            }
            
            // 获取所有周别代码，按时间顺序排序（52, 53, 1, 2, 3...）
            const allWeekCodes = Array.from(actualWeekCodes);
            const sorted = sortWeekCodes(allWeekCodes);
            
            // 取前4个周别（当周+未来3周）
            const finalWeekCodes = sorted.slice(0, 4);
            
            if (finalWeekCodes.length === 0) {
                return '<p style="padding: 20px; text-align: center; color: #6c757d;">暂无周别数据</p>';
            }
            
            // 按ETD(AD列)、EXP LINE(AC列)、VSL/VOY(G+H列)分组，按周别分类
            const grouped = {};
            
            // 计算每个周别的总TEU（用于计算占比）
            const weekTotalTeu = {};
            filteredData.forEach(row => {
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                if (!weekValue) return;
                
                // 解析周别代码（使用新的parseWeekValue函数）
                const weekCode = parseWeekValue(weekValue);
                if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                if (!weekTotalTeu[weekCode]) {
                    weekTotalTeu[weekCode] = 0;
                }
                weekTotalTeu[weekCode] += teu;
            });
            
            filteredData.forEach(row => {
                const etd = getColumnValue(row, COLUMN_MAP.SAIL_DATE) || '未指定';
                const expLine = getColumnValue(row, COLUMN_MAP.EXP_LINE) || '未指定';
                const vessel = getColumnValue(row, COLUMN_MAP.VESSEL) || '未指定';
                const voyage = getColumnValue(row, COLUMN_MAP.VOYAGE) || '未指定';
                const vslVoy = `${vessel}/${voyage}`;
                const weekValue = getColumnValue(row, COLUMN_MAP.WEEK);
                
                if (!weekValue) return;
                
                // 解析周别代码（使用新的parseWeekValue函数）
                const weekCode = parseWeekValue(weekValue);
                if (!weekCode || !finalWeekCodes.includes(weekCode)) return;
                
                // 使用 ETD + EXP_LINE + VSL/VOY 作为唯一键
                const key = `${etd}|${expLine}|${vslVoy}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        etd,
                        expLine,
                        vslVoy,
                        vessel,
                        voyage,
                        weeks: {}
                    };
                }
                
                if (!grouped[key].weeks[weekCode]) {
                    grouped[key].weeks[weekCode] = {
                        weekCode,
                        teu: 0,
                        tons: 0,
                        gps: [],
                        count: 0
                    };
                }
                
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);
                
                grouped[key].weeks[weekCode].teu += teu;
                grouped[key].weeks[weekCode].tons += tons;
                if (gps > 0) {
                    grouped[key].weeks[weekCode].gps.push(gps);
                }
                grouped[key].weeks[weekCode].count++;
            });
            
            // 生成表格 - 每个周别都有完整的列
            let html = '<table style="width: 100%; border-collapse: collapse; background: white; table-layout: fixed;"><thead>';
            // 第一行表头 - 使用主题蓝色渐变，白色字体和白色框线
            html += '<tr style="background: #3E62AD; color: white; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">ETD</th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 5%;">EXP LINE</th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white; width: 8%;">VSL/VOY</th>';
            
            // 为每个周别添加表头
            finalWeekCodes.forEach(weekCode => {
                html += `<th style="padding: 12px; text-align: center; border: 1px solid white; font-weight: 600; color: white;" colspan="5">${weekCode}</th>`;
            });
            html += '</tr>';
            
            // 第二行表头 - 使用主题蓝色，白色字体和白色框线
            html += '<tr style="background: #3E62AD; border-bottom: 2px solid white;">';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            html += '<th style="padding: 12px; text-align: left; border: 1px solid white; font-weight: 600; color: white;"></th>';
            
            // 为每个周别添加子表头
            finalWeekCodes.forEach(() => {
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TEU</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">占比</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">AVG GPS</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS</th>';
                html += '<th style="padding: 12px; text-align: right; border: 1px solid white; font-weight: 600; color: white;">TONS/TEU</th>';
            });
            html += '</tr></thead><tbody>';
            
            // 按ETD时间升序排序，其次按EXP LINE升序排序
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                // 先按ETD升序排序
                let aEtdDate = null;
                let bEtdDate = null;
                
                // 尝试解析ETD为日期
                try {
                    if (grouped[a].etd && grouped[a].etd !== '未指定') {
                        aEtdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(grouped[a].etd) : null;
                        if (!aEtdDate && typeof grouped[a].etd === 'string') {
                            aEtdDate = new Date(grouped[a].etd);
                        }
                    }
                } catch (e) {
                    // 解析失败，使用字符串比较
                }
                
                try {
                    if (grouped[b].etd && grouped[b].etd !== '未指定') {
                        bEtdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(grouped[b].etd) : null;
                        if (!bEtdDate && typeof grouped[b].etd === 'string') {
                            bEtdDate = new Date(grouped[b].etd);
                        }
                    }
                } catch (e) {
                    // 解析失败，使用字符串比较
                }
                
                // 如果都能解析为日期，按日期比较
                if (aEtdDate && bEtdDate && !isNaN(aEtdDate.getTime()) && !isNaN(bEtdDate.getTime())) {
                    const dateDiff = aEtdDate.getTime() - bEtdDate.getTime();
                    if (dateDiff !== 0) {
                        return dateDiff; // 升序
                    }
                } else {
                    // 否则按字符串比较
                    const aEtd = String(grouped[a].etd || '');
                    const bEtd = String(grouped[b].etd || '');
                    const etdDiff = aEtd.localeCompare(bEtd);
                    if (etdDiff !== 0) {
                        return etdDiff;
                    }
                }
                
                // 如果ETD相同，按EXP LINE升序排序
                const aExpLine = String(grouped[a].expLine || '');
                const bExpLine = String(grouped[b].expLine || '');
                return aExpLine.localeCompare(bExpLine);
            });
            
            sortedKeys.forEach(key => {
                const item = grouped[key];
                
                // 格式化ETD日期
                let etdDisplay = item.etd;
                if (item.etd && item.etd !== '未指定') {
                    try {
                        const etdDate = window.parseExcelDateSerial ? window.parseExcelDateSerial(item.etd) : null;
                        if (etdDate) {
                            etdDisplay = formatDate(etdDate);
                        }
                    } catch (e) {
                        // 如果解析失败，使用原始值
                    }
                }
                
                html += `<tr class="vessel-row" data-vessel="${escapeHtml(item.vessel)}" data-voyage="${escapeHtml(item.voyage)}" style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f7ff'" onmouseout="this.style.backgroundColor=''" onclick="showVesselDetail('${escapeHtml(item.vessel)}', '${escapeHtml(item.voyage)}')">`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(etdDisplay)}">${escapeHtml(etdDisplay)}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; width: 5%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.expLine)}">${escapeHtml(item.expLine)}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 8%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.vslVoy)}">${escapeHtml(item.vslVoy)}</td>`;
                
                // 每个周别的列
                finalWeekCodes.forEach(weekCode => {
                    const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [], count: 0 };
                    const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                    const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                    const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                    
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.teu.toFixed(0)}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${percentage}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${avgGps}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${weekData.tons.toFixed(2)}</td>`;
                    html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${tonsPerTeu}</td>`;
                });
                
                html += '</tr>';
            });
            
            // 合计行
            const totalWeekData = {};
            finalWeekCodes.forEach(weekCode => {
                totalWeekData[weekCode] = { teu: 0, tons: 0, gps: [] };
            });
            
            sortedKeys.forEach(key => {
                const item = grouped[key];
                finalWeekCodes.forEach(weekCode => {
                    const weekData = item.weeks[weekCode] || { teu: 0, tons: 0, gps: [], count: 0 };
                    totalWeekData[weekCode].teu += weekData.teu;
                    totalWeekData[weekCode].tons += weekData.tons;
                    totalWeekData[weekCode].gps.push(...weekData.gps);
                });
            });
            
            html += '<tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6;">';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 5%;">合计</td>';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 5%;"></td>';
            html += '<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; width: 8%;"></td>';
            
            finalWeekCodes.forEach(weekCode => {
                const weekData = totalWeekData[weekCode];
                const avgGps = weekData.gps.length > 0 ? (weekData.gps.reduce((a, b) => a + b, 0) / weekData.gps.length).toFixed(2) : '0.00';
                const tonsPerTeu = weekData.teu > 0 ? (weekData.tons / weekData.teu).toFixed(4) : '0.0000';
                const percentage = weekTotalTeu[weekCode] > 0 ? ((weekData.teu / weekTotalTeu[weekCode]) * 100).toFixed(2) + '%' : '0.00%';
                
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekData.teu.toFixed(0)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${percentage}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${avgGps}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${weekData.tons.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">${tonsPerTeu}</td>`;
            });
            
            html += '</tr>';
            
            html += '</tbody></table>';
            return html;
        }

        /**
         * 格式化日期显示
         */
        function formatDate(date) {
            if (!date) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * HTML转义
         */
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 已删除的功能：数据导出、搜索、图表视图（GPS图表仍在使用）

        /**
         * ==================== 第二阶段功能：数据统计面板 ====================
         */

        /**
         * 更新统计面板
         */
        function updateStatsPanel() {
            const totalTeuEl = document.getElementById('statTotalTeu');
            const totalTonsEl = document.getElementById('statTotalTons');
            const avgGpsEl = document.getElementById('statAvgGps');
            const tonsPerTeuEl = document.getElementById('statTonsPerTeu');

            if (!filteredData || filteredData.length === 0) {
                if (totalTeuEl) totalTeuEl.textContent = '0';
                if (totalTonsEl) totalTonsEl.textContent = '0.00';
                if (avgGpsEl) avgGpsEl.textContent = '0.00';
                if (tonsPerTeuEl) tonsPerTeuEl.textContent = '0.0000';
                return;
            }

            let totalTeu = 0;
            let totalTons = 0;
            const gpsValues = [];

            filteredData.forEach(row => {
                const teu = Number(getColumnValue(row, COLUMN_MAP.X) || 0);
                const tons = Number(getColumnValue(row, COLUMN_MAP.Y) || 0) / 1000;
                const gps = Number(getColumnValue(row, COLUMN_MAP.Z) || 0);

                totalTeu += teu;
                totalTons += tons;
                if (gps > 0) gpsValues.push(gps);
            });

            const avgGps = gpsValues.length > 0 
                ? (gpsValues.reduce((a, b) => a + b, 0) / gpsValues.length).toFixed(2)
                : '0.00';
            const tonsPerTeu = totalTeu > 0 
                ? (totalTons / totalTeu).toFixed(4)
                : '0.0000';

            // 更新DOM（带动画效果）
            if (totalTeuEl) animateValue('statTotalTeu', totalTeu.toLocaleString());
            if (totalTonsEl) {
                // TTL TONS需要千分位格式化
                const formattedTons = totalTons.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                animateValue('statTotalTons', formattedTons);
            }
            if (avgGpsEl) avgGpsEl.textContent = avgGps;
            if (tonsPerTeuEl) tonsPerTeuEl.textContent = tonsPerTeu;
        }

        /**
         * 数值动画效果
         */
        function animateValue(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const startValue = parseFloat(element.textContent.replace(/,/g, '')) || 0;
            const endValue = parseFloat(targetValue.replace(/,/g, '')) || 0;
            const duration = 500;
            const startTime = performance.now();

            // 判断是否是小数（用于TTL TONS）
            const isDecimal = targetValue.toString().includes('.');
            const decimalPlaces = isDecimal ? 2 : 0;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const currentValue = startValue + (endValue - startValue) * progress;
                
                if (isDecimal) {
                    element.textContent = currentValue.toLocaleString('en-US', { 
                        minimumFractionDigits: decimalPlaces, 
                        maximumFractionDigits: decimalPlaces 
                    });
                } else {
                    element.textContent = Math.floor(currentValue).toLocaleString();
                }
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    // 最终值使用原始格式（保持千分位）
                    if (isDecimal) {
                        element.textContent = targetValue;
                    } else {
                        element.textContent = typeof targetValue === 'string' ? targetValue : targetValue.toLocaleString();
                    }
                }
            }

            requestAnimationFrame(update);
        }

        /**
         * ==================== 第二阶段功能：数据缓存机制 ====================
         */

        /**
         * 缓存管理工具
         */
        const CacheManager = {
            PREFIX: 'msq1d890_',
            EXPIRY: 24 * 60 * 60 * 1000, // 24小时

            /**
             * 生成缓存键
             */
            getCacheKey(fileName, fileLastModified) {
                return `${this.PREFIX}data_${fileName}_${fileLastModified}`;
            },

            /**
             * 保存数据到缓存
             */
            save(key, data) {
                try {
                    const cacheData = {
                        data: data,
                        timestamp: Date.now(),
                        expiry: this.EXPIRY
                    };
                    localStorage.setItem(key, JSON.stringify(cacheData));
                    debugLog(`[Cache] 已缓存: ${key}`);
                } catch (e) {
                    debugError('[Cache] 保存失败:', e);
                    // localStorage可能已满，清除旧缓存
                    this.clearOldCache();
                    try {
                        const cacheData = {
                            data: data,
                            timestamp: Date.now(),
                            expiry: this.EXPIRY
                        };
                        localStorage.setItem(key, JSON.stringify(cacheData));
                    } catch (e2) {
                        debugError('[Cache] 重试保存仍失败:', e2);
                    }
                }
            },

            /**
             * 从缓存读取数据
             */
            load(key) {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;

                    const cacheData = JSON.parse(cached);
                    const now = Date.now();

                    // 检查是否过期
                    if (now - cacheData.timestamp > cacheData.expiry) {
                        localStorage.removeItem(key);
                        debugLog(`[Cache] 缓存已过期: ${key}`);
                        return null;
                    }

                    debugLog(`[Cache] 从缓存加载: ${key}`);
                    return cacheData.data;
                } catch (e) {
                    debugError('[Cache] 读取失败:', e);
                    return null;
                }
            },

            /**
             * 清除旧缓存（保留最近7天的）
             */
            clearOldCache() {
                const keys = Object.keys(localStorage);
                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                let clearedCount = 0;
                
                keys.forEach(key => {
                    if (key.startsWith(this.PREFIX)) {
                        try {
                            const cached = JSON.parse(localStorage.getItem(key));
                            if (cached.timestamp < sevenDaysAgo) {
                                localStorage.removeItem(key);
                                clearedCount++;
                            }
                        } catch (e) {
                            // 无效数据，直接删除
                            localStorage.removeItem(key);
                            clearedCount++;
                        }
                    }
                });
                
                if (clearedCount > 0) {
                    debugLog(`[Cache] 已清除 ${clearedCount} 个旧缓存`);
                }
            },

            /**
             * 清除所有相关缓存
             */
            clearAll() {
                const keys = Object.keys(localStorage);
                let clearedCount = 0;
                keys.forEach(key => {
                    if (key.startsWith(this.PREFIX)) {
                        localStorage.removeItem(key);
                        clearedCount++;
                    }
                });
                debugLog(`[Cache] 已清除所有缓存 (${clearedCount} 个)`);
            }
        };

        /**
         * ==================== 第二阶段功能：图表可视化 ====================
         */

        // 占位函数：已删除的图表功能（保留以防止引用错误）
        function initViewTabs() {}
        function updateCharts() {}
        function generateDeptCharts() {}
        function generateWeekCharts() {}
        function generateAdditionalCharts() {}
        function generateSqScTop10Chart() {}
        function generateTop10Chart() {}
        function generateTradeChart() {}
        function generateAreaChart() {}
        function generateCombinedChart() {}
        function generateStackedChart() {}
        function destroyCharts() {}

        /**
         * ==================== 第二阶段功能：数据统计面板 ====================
         */

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
