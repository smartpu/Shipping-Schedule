<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor · 每日订舱监控</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/filter-utils.js"></script>
    <script src="vendor/excel-reader-utils.js"></script>
    <script src="vendor/chart.umd.min.js"></script>
    <script src="vendor/toast.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <!-- PDF导出库 -->
    <script src="vendor/html2canvas.min.js"></script>
    <script src="vendor/jspdf.umd.min.js"></script>
    <!-- 引入访问日志记录 -->
    <script src="vendor/auth-gist.js"></script>
</head>
<body data-page="Monitor-Daily-Booking.html">
    <div class="dashboard-container">
        <!-- 左侧导航栏占位容器（将由sidebar-loader.js动态加载） -->
        <div id="sidebar-placeholder"></div>

        <!-- 右侧内容 -->
        <main class="dashboard-content">
            <div class="container">
                <!-- 顶部介绍卡片 -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>Monitor · 每日订舱监控</h2>
                            <p>基于每日订舱记录汇总表，提供最近1个月的订舱情况分析，支持Trade维度、Account维度和VSL/VOY维度三种模式</p>
                        </div>
                        <div class="section-intro-actions">
                            <button type="button" class="tool-link" id="exportExcelBtn" aria-label="导出Excel" style="display: none;">导出Excel</button>
                            <button type="button" class="tool-link" id="exportPdfBtn" aria-label="导出PDF" style="display: none;">导出PDF</button>
                            <a href="dashboard.html?tab=monitor" class="tool-link" aria-label="返回工具集首页">← 返回首页</a>
                            <a href="Monitor-Daily-Booking-README.html" class="tool-link secondary" aria-label="查看使用说明文档">使用说明 →</a>
                        </div>
                    </div>
                </div>

                <!-- 文件上传和数据状态区域 -->
                <div style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 0;">
                    <div class="grid-2-col" style="margin-bottom: 0;">
                        <!-- 左侧：载入 Excel -->
                        <div class="card-white">
                            <label for="excelFile" class="file-upload-label" aria-label="选择Excel文件上传">
                                <svg class="file-upload-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradExcel)" />
                                    <rect x="8" y="8" width="20" height="20" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="14" x2="28" y2="14" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="8" y1="20" x2="28" y2="20" stroke="#fff" stroke-width="1.5"/>
                                    <line x1="14" y1="8" x2="14" y2="28" stroke="#fff" stroke-width="1.5"/>
                                    <path d="M18 22L22 26L14 26Z" fill="#fff"/>
                                    <defs>
                                        <linearGradient id="gradExcel" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#0071e3" />
                                            <stop offset="1" stop-color="#54a4ff" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="file-upload-content">
                                    <div class="file-upload-title">载入 Excel</div>
                                    <div class="file-upload-desc">支持 .xlsx / .xls，需包含 Daily Booking 工作表</div>
                                </div>
                                <input type="file" id="excelFile" class="file-upload-input" accept=".xlsx,.xls" aria-label="选择Excel文件">
                            </label>
                        </div>
                        
                        <!-- 右侧：Excel 数据状态 -->
                        <div class="card-white">
                            <div class="data-status-container">
                                <svg class="data-status-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="28" height="28" rx="8" fill="url(#gradStatus)" />
                                    <rect x="11" y="10" width="14" height="16" rx="2" fill="none" stroke="#fff" stroke-width="1.5"/>
                                    <rect x="15" y="8" width="6" height="4" rx="1" fill="#fff"/>
                                    <path d="M14 18L17 21L23 15" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <defs>
                                        <linearGradient id="gradStatus" x1="4" y1="4" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#FF8A00" />
                                            <stop offset="1" stop-color="#FFB347" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="data-status-content">
                                    <div class="data-status-title">数据状态</div>
                                    <div id="statusValue" class="data-status-text">尚未载入数据</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 筛选器区域 -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">筛选条件</span>
                        <div style="flex: 1;">
                            <h2 class="section-title">数据筛选 <span>DATA FILTER</span></h2>
                            <p class="module-desc">支持时间范围、BKG Party、POD、FTB、Trade 多维度筛选</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; flex-shrink: 0;">
                            <button type="button" id="saveFilterPresetBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 20px; font-size: 14px; border-radius: 6px; white-space: nowrap; min-width: 120px;">保存筛选预设</button>
                            <button type="button" id="managePresetsBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 20px; font-size: 14px; border-radius: 6px; white-space: nowrap; min-width: 100px;">管理预设</button>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" id="filtersContainer">
                        <!-- 筛选器工具栏 -->
                        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <button type="button" id="refreshDataBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 16px; font-size: 14px; border-radius: 6px; display: none;">刷新数据</button>
                                <button type="button" id="saveSnapshotBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 16px; font-size: 14px; border-radius: 6px; display: none;">保存快照</button>
                                <button type="button" id="manageSnapshotsBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 16px; font-size: 14px; border-radius: 6px; display: none;">快照对比</button>
                            </div>
                        </div>

                        <!-- 筛选预设管理面板 -->
                        <div id="presetsPanel" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-bottom: 15px; color: #495057;">筛选预设管理</h4>
                            <div id="presetsList" style="margin-bottom: 15px;">
                                <!-- 预设列表将通过JavaScript动态生成 -->
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" id="closePresetsPanelBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 16px; font-size: 14px; border-radius: 6px;">关闭</button>
                            </div>
                        </div>

                        <!-- 快照管理面板 -->
                        <div id="snapshotsPanel" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-bottom: 15px; color: #495057;">数据快照管理</h4>
                            <div id="snapshotsList" style="margin-bottom: 15px;">
                                <!-- 快照列表将通过JavaScript动态生成 -->
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" id="closeSnapshotsPanelBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 16px; font-size: 14px; border-radius: 6px;">关闭</button>
                            </div>
                        </div>

                        <!-- 时间范围选择 -->
                        <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 15px; font-weight: 600; color: #495057;">时间范围选择</label>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <!-- 左侧：日期选择区域，占50% -->
                                <div style="flex: 1; display: flex; gap: 20px; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <label for="startDate" style="white-space: nowrap; min-width: 70px; font-weight: 500;">开始日期：</label>
                                        <input type="date" id="startDate" style="flex: 1; padding: 10px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; background-color: white;">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <label for="endDate" style="white-space: nowrap; min-width: 70px; font-weight: 500;">结束日期：</label>
                                        <input type="date" id="endDate" style="flex: 1; padding: 10px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; background-color: white;">
                                    </div>
                                </div>
                                <!-- 右侧：快捷按钮组，占50% -->
                                <div style="flex: 1; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                    <button type="button" id="resetDateRange1Week" class="filter-btn btn-sweep-blue" style="padding: 10px 16px; font-size: 14px; font-weight: 500; border-radius: 6px; white-space: nowrap; flex: 1; min-width: 100px; max-width: 120px;">最近1周</button>
                                    <button type="button" id="resetDateRange1Month" class="filter-btn btn-sweep-blue" style="padding: 10px 16px; font-size: 14px; font-weight: 500; border-radius: 6px; white-space: nowrap; flex: 1; min-width: 100px; max-width: 120px;">最近1个月</button>
                                    <button type="button" id="resetDateRange3Months" class="filter-btn btn-sweep-blue" style="padding: 10px 16px; font-size: 14px; font-weight: 500; border-radius: 6px; white-space: nowrap; flex: 1; min-width: 100px; max-width: 120px;">最近3个月</button>
                                </div>
                            </div>
                        </div>
                        <div class="destination-filters">
                            <div class="filter-row">
                                <!-- BKG Party 筛选 -->
                                <div class="filter-group">
                                    <label for="bkgPartyFilter">BKG Party</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="bkgPartySearch" class="filter-search" placeholder="搜索 BKG Party..." autocomplete="off">
                                    <select id="bkgPartyFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 BKG Party</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="bkgParty" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="bkgParty" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>
                                <!-- POD 筛选 -->
                                <div class="filter-group">
                                    <label for="podFilter">POD</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="podSearch" class="filter-search" placeholder="搜索 POD..." autocomplete="off">
                                    <select id="podFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 POD</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="pod" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="pod" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>
                                <!-- FTB 筛选 -->
                                <div class="filter-group">
                                    <label for="ftbFilter">FTB</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="ftbSearch" class="filter-search" placeholder="搜索 FTB..." autocomplete="off">
                                    <select id="ftbFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 FTB</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="ftb" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="ftb" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>
                                <!-- Trade 筛选 -->
                                <div class="filter-group">
                                    <label for="tradeFilter">Trade</label>
                                    <small class="multi-hint">可多选（Ctrl/点击切换）</small>
                                    <input type="text" id="tradeSearch" class="filter-search" placeholder="搜索 Trade..." autocomplete="off">
                                    <select id="tradeFilter" multiple size="6" class="multi-select">
                                        <option value="">全部 Trade</option>
                                    </select>
                                    <div class="filter-actions">
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="trade" data-action="select-all">全部选择</button>
                                        <button type="button" class="filter-btn btn-sweep-blue" data-filter="trade" data-action="clear-all">清除选择</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 数据摘要卡片 -->
                <section class="feature-section" id="summarySection" style="display: none;">
                    <div class="card-white module-card mt-20">
                        <h3 style="color: #495057; margin-bottom: 20px; font-size: 18px; font-weight: 600;">数据摘要</h3>
                        <div id="summaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <!-- 卡片将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </section>

                <!-- 模式切换和展示区域 -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">分析模式</span>
                        <div>
                            <h2 class="section-title">订舱分析 <span>BOOKING ANALYSIS</span></h2>
                            <p class="module-desc">支持 Trade 维度、Account 维度和 VSL/VOY 维度三种分析模式，支持数据对比和排名功能</p>
                        </div>
                    </div>
                    <div class="card-white module-card hidden mt-20" id="analysisContainer">
                        <!-- 模式切换和功能按钮 -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <div class="view-toggle">
                                <label>分析模式：</label>
                                <button id="mode1Btn" class="active">模式1：Trade维度</button>
                                <button id="mode2Btn">模式2：Account维度</button>
                                <button id="mode3Btn">模式3：VSL/VOY维度</button>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" id="toggleCompareBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 16px; font-size: 14px; border-radius: 6px;">数据对比</button>
                                <button type="button" id="toggleRankingBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 16px; font-size: 14px; border-radius: 6px;">排名视图</button>
                            </div>
                        </div>

                        <!-- 数据对比面板 -->
                        <div id="comparePanel" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-bottom: 15px; color: #495057;">时间段对比</h4>
                            <div style="display: flex; gap: 15px; align-items: center; width: 100%;">
                                <div style="display: flex; gap: 15px; width: 50%; flex-shrink: 0;">
                                    <label style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <span style="white-space: nowrap;">对比开始日期：</span>
                                        <input type="date" id="compareStartDate" style="padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 4px; flex: 1; min-width: 0;">
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <span style="white-space: nowrap;">对比结束日期：</span>
                                        <input type="date" id="compareEndDate" style="padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 4px; flex: 1; min-width: 0;">
                                    </label>
                                </div>
                                <button type="button" id="applyCompareBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 20px; font-size: 14px; border-radius: 6px; white-space: nowrap; width: 50%; flex-shrink: 0;">应用对比</button>
                            </div>
                            <div id="compareResults" style="margin-top: 20px;"></div>
                        </div>

                        <!-- 排名视图面板 -->
                        <div id="rankingPanel" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-bottom: 15px; color: #495057;">排名设置</h4>
                            <div style="display: flex; gap: 15px; align-items: center; width: 100%;">
                                <div style="display: flex; gap: 15px; align-items: center; width: 50%; flex-shrink: 0;">
                                    <label style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <span style="white-space: nowrap;">显示数量：</span>
                                        <select id="rankingCount" style="padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 4px; flex: 1; min-width: 0;">
                                            <option value="10">Top 10</option>
                                            <option value="20">Top 20</option>
                                            <option value="50">Top 50</option>
                                            <option value="0">全部</option>
                                        </select>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <span style="white-space: nowrap;">排序依据：</span>
                                        <select id="rankingBy" style="padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 4px; flex: 1; min-width: 0;">
                                            <option value="total-bl">总BL数</option>
                                            <option value="total-teu">总TEU</option>
                                            <option value="aclf-bl">A/C/F/L BL数</option>
                                            <option value="aclf-teu">A/C/F/L TEU</option>
                                        </select>
                                    </label>
                                </div>
                                <button type="button" id="applyRankingBtn" class="filter-btn btn-sweep-blue" style="padding: 8px 20px; font-size: 14px; border-radius: 6px; white-space: nowrap; width: 50%; flex-shrink: 0;">应用排名</button>
                            </div>
                        </div>

                        <!-- 模式1：Trade维度展示 -->
                        <div id="mode1Content" class="mode-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #495057; margin: 0;">Trade维度统计（按Trade和时间）</h3>
                                <div style="display: flex; align-items: center; gap: 8px; color: #6c757d; font-size: 13px;">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.7;">
                                        <path d="M8 1L10 6H15L11 9L13 14L8 11L3 14L5 9L1 6H6L8 1Z" fill="currentColor"/>
                                    </svg>
                                    <span>点击表格行查看详细记录</span>
                                </div>
                            </div>
                            <div id="mode1Charts" class="charts-container"></div>
                            <div id="mode1Table" class="table-container" style="margin-top: 20px;"></div>
                        </div>

                        <!-- 模式2：Account维度展示 -->
                        <div id="mode2Content" class="mode-content" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #495057; margin: 0;">Account维度统计（按BKG Party）</h3>
                                <div style="display: flex; align-items: center; gap: 8px; color: #6c757d; font-size: 13px;">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.7;">
                                        <path d="M8 1L10 6H15L11 9L13 14L8 11L3 14L5 9L1 6H6L8 1Z" fill="currentColor"/>
                                    </svg>
                                    <span>点击表格行查看详细记录</span>
                                </div>
                            </div>
                            <div id="mode2Charts" class="charts-container"></div>
                            <div id="mode2Table" class="table-container" style="margin-top: 20px;"></div>
                        </div>

                        <!-- 模式3：VSL/VOY维度展示 -->
                        <div id="mode3Content" class="mode-content" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #495057; margin: 0;">VSL/VOY维度统计（按船名航次）</h3>
                                <div style="display: flex; align-items: center; gap: 8px; color: #6c757d; font-size: 13px;">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.7;">
                                        <path d="M8 1L10 6H15L11 9L13 14L8 11L3 14L5 9L1 6H6L8 1Z" fill="currentColor"/>
                                    </svg>
                                    <span>点击表格行查看详细记录</span>
                                </div>
                            </div>
                            <div id="mode3Charts" class="charts-container"></div>
                            <div id="mode3Table" class="table-container" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </section>

                <!-- 空数据提示 -->
                <div id="emptyDataMessage" class="card-white module-card mt-20" style="display: none;">
                    <div style="text-align: center; padding: 60px 20px;">
                        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 20px; opacity: 0.5;">
                            <circle cx="40" cy="40" r="35" stroke="#dee2e6" stroke-width="2"/>
                            <path d="M25 40L35 50L55 30" stroke="#dee2e6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h3 style="color: #6c757d; margin-bottom: 12px; font-size: 20px; font-weight: 500;">暂无数据</h3>
                        <p style="color: #adb5bd; margin-bottom: 24px; font-size: 14px;">当前筛选条件下没有找到匹配的数据</p>
                        <button type="button" id="clearFiltersBtn" class="filter-btn btn-sweep-blue" style="padding: 12px 24px; font-size: 14px; border-radius: 6px;">
                            清除所有筛选条件
                        </button>
                    </div>
                </div>

                <!-- 使用声明 -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">Monitor · 每日订舱监控使用声明</h2>
                    <p class="usage-statement-text">资料整合自用户 Excel 数据，解析结果仅供内部研判使用。</p>
                    <p class="usage-statement-text">所有数据仅在本地浏览器解析，不会上传至任何服务器，请放心使用。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入导航栏公共组件 -->
    <script src="vendor/sidebar-loader.js"></script>
    <script>
        init001ToolPage('Monitor-Daily-Booking.html', 'monitor');
    </script>

    <script>
        (function() {
            'use strict';

            // 常量配置
            const CONFIG = {
                COLORS: {
                    PRIMARY: '#3E62AD',
                    PRIMARY_DARK: '#2D4A7D',
                    HOVER: '#f0f7ff',
                    BORDER: '#dee2e6',
                    BORDER_WHITE: 'white',
                    BACKGROUND_LIGHT: '#e9ecef'
                },
                STYLES: {
                    TABLE_HEADER: 'padding: 12px; border: 1px solid white; font-weight: 600; color: white;',
                    TABLE_CELL: 'padding: 12px; border: 1px solid #dee2e6;',
                    TABLE_ROW_HOVER: 'cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid #dee2e6;',
                    TABLE_CONTAINER: 'max-height: calc(90vh - 200px);'
                },
                RENDERING: {
                    BATCH_SIZE: 100,  // 分批渲染每批的行数
                    DEBOUNCE_DELAY: 100  // 防抖延迟（毫秒）
                }
            };

            // 状态管理
            const state = {
                rawData: [],
                filteredData: [],
                columns: {
                    date: null,      // A列 - 日期
                    status: null,    // C列 - 状态 (A/C/F/L/N/P/X)
                    vesselName: null, // D列 - 船名
                    voyage: null,    // E列 - 航次
                    bkgParty: null,  // F列 - BKG Party
                    contractNo: null, // H列 - 合约号
                    pod: null,       // K列 - POD
                    ftb: null,       // X列 - FTB
                    teu: null,       // Y列 - TEU
                    trade: null,     // Z列 - Trade
                    expLine: null,   // AA列 - EXP LINE
                    etd: null        // AB列 - ETD
                },
                currentMode: 1, // 1: Trade维度, 2: Account维度, 3: VSL/VOY维度
                filters: {
                    bkgParty: [],
                    pod: [],
                    ftb: [],
                    trade: []
                }
            };

            // DOM 元素
            const dom = {
                excelFile: document.getElementById('excelFile'),
                statusValue: document.getElementById('statusValue'),
                filtersContainer: document.getElementById('filtersContainer'),
                analysisContainer: document.getElementById('analysisContainer'),
                bkgPartyFilter: document.getElementById('bkgPartyFilter'),
                podFilter: document.getElementById('podFilter'),
                ftbFilter: document.getElementById('ftbFilter'),
                tradeFilter: document.getElementById('tradeFilter'),
                bkgPartySearch: document.getElementById('bkgPartySearch'),
                podSearch: document.getElementById('podSearch'),
                ftbSearch: document.getElementById('ftbSearch'),
                tradeSearch: document.getElementById('tradeSearch'),
                startDate: document.getElementById('startDate'),
                endDate: document.getElementById('endDate'),
                resetDateRange1Week: document.getElementById('resetDateRange1Week'),
                resetDateRange1Month: document.getElementById('resetDateRange1Month'),
                resetDateRange3Months: document.getElementById('resetDateRange3Months'),
                exportExcelBtn: document.getElementById('exportExcelBtn'),
                exportPdfBtn: document.getElementById('exportPdfBtn'),
                mode1Btn: document.getElementById('mode1Btn'),
                mode2Btn: document.getElementById('mode2Btn'),
                mode3Btn: document.getElementById('mode3Btn'),
                mode1Content: document.getElementById('mode1Content'),
                mode2Content: document.getElementById('mode2Content'),
                mode3Content: document.getElementById('mode3Content'),
                mode1Charts: document.getElementById('mode1Charts'),
                mode2Charts: document.getElementById('mode2Charts'),
                mode3Charts: document.getElementById('mode3Charts'),
                mode1Table: document.getElementById('mode1Table'),
                mode2Table: document.getElementById('mode2Table'),
                mode3Table: document.getElementById('mode3Table'),
                summarySection: document.getElementById('summarySection'),
                summaryCards: document.getElementById('summaryCards'),
                emptyDataMessage: document.getElementById('emptyDataMessage'),
                clearFiltersBtn: document.getElementById('clearFiltersBtn'),
                toggleCompareBtn: document.getElementById('toggleCompareBtn'),
                toggleRankingBtn: document.getElementById('toggleRankingBtn'),
                comparePanel: document.getElementById('comparePanel'),
                rankingPanel: document.getElementById('rankingPanel'),
                compareStartDate: document.getElementById('compareStartDate'),
                compareEndDate: document.getElementById('compareEndDate'),
                applyCompareBtn: document.getElementById('applyCompareBtn'),
                compareResults: document.getElementById('compareResults'),
                rankingCount: document.getElementById('rankingCount'),
                rankingBy: document.getElementById('rankingBy'),
                applyRankingBtn: document.getElementById('applyRankingBtn'),
                saveFilterPresetBtn: document.getElementById('saveFilterPresetBtn'),
                managePresetsBtn: document.getElementById('managePresetsBtn'),
                presetsPanel: document.getElementById('presetsPanel'),
                presetsList: document.getElementById('presetsList'),
                closePresetsPanelBtn: document.getElementById('closePresetsPanelBtn'),
                refreshDataBtn: document.getElementById('refreshDataBtn'),
                saveSnapshotBtn: document.getElementById('saveSnapshotBtn'),
                manageSnapshotsBtn: document.getElementById('manageSnapshotsBtn'),
                snapshotsPanel: document.getElementById('snapshotsPanel'),
                snapshotsList: document.getElementById('snapshotsList'),
                closeSnapshotsPanelBtn: document.getElementById('closeSnapshotsPanelBtn')
            };

            // 当前加载的文件引用（用于刷新）
            let currentFile = null;

            // 对比和排名状态
            const compareState = {
                enabled: false
            };

            const rankingState = {
                enabled: false,
                count: 10,
                by: 'total-bl'
            };

            // 排序状态
            const sortState = {
                mode1: { column: null, direction: null },
                mode2: { column: null, direction: null },
                mode3: { column: null, direction: null }
            };


            /**
             * 识别列索引
             */
            function identifyColumns(firstRow) {
                // 通过列索引识别：A=0, C=2, D=3, E=4, F=5, H=7, K=10, X=23, Y=24, Z=25, AA=26, AB=27
                state.columns.date = 0;      // A列
                state.columns.status = 2;    // C列
                state.columns.vesselName = 3; // D列
                state.columns.voyage = 4;    // E列
                state.columns.bkgParty = 5;  // F列
                state.columns.contractNo = 7; // H列
                state.columns.pod = 10;      // K列
                state.columns.ftb = 23;      // X列
                state.columns.teu = 24;      // Y列
                state.columns.trade = 25;    // Z列
                state.columns.expLine = 26;  // AA列
                state.columns.etd = 27;      // AB列
            }

            /**
             * 解析日期
             */
            function parseDate(value) {
                if (!value) return null;
                if (value instanceof Date) return value;
                if (typeof value === 'number') {
                    // Excel日期序列号
                    const excelEpoch = new Date(1899, 11, 30);
                    return new Date(excelEpoch.getTime() + value * 86400000);
                }
                const date = new Date(value);
                return isNaN(date.getTime()) ? null : date;
            }

            /**
             * 获取最近1个月的日期范围
             */
            function getLastMonthRange() {
                const end = new Date();
                const start = new Date();
                start.setMonth(start.getMonth() - 1);
                return { start, end };
            }

            /**
             * 格式化日期为 YYYY-MM-DD
             */
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            /**
             * 设置时间范围
             */
            function setDateRange(start, end) {
                dom.startDate.value = formatDate(start);
                dom.endDate.value = formatDate(end);
                applyFilters();
            }

            /**
             * 初始化时间范围选择器（默认最近1个月）
             */
            function initDateRange() {
                const { start, end } = getLastMonthRange();
                setDateRange(start, end);
            }

            /**
             * 获取最近N周的时间范围
             */
            function getLastNWeeksRange(weeks) {
                const end = new Date();
                const start = new Date();
                start.setDate(start.getDate() - (weeks * 7 - 1));
                return { start, end };
            }

            /**
             * 获取最近N个月的时间范围
             */
            function getLastNMonthsRange(months) {
                const end = new Date();
                const start = new Date();
                start.setMonth(start.getMonth() - months);
                return { start, end };
            }

            /**
             * 获取当前选择的时间范围
             */
            function getDateRange() {
                const start = dom.startDate.value ? new Date(dom.startDate.value) : null;
                const end = dom.endDate.value ? new Date(dom.endDate.value) : null;
                // 设置结束日期为当天的23:59:59
                if (end) {
                    end.setHours(23, 59, 59, 999);
                }
                return { start, end };
            }

            /**
             * 处理文件上传
             */
            async function handleFileUpload(event) {
                const file = event.target.files?.[0];
                if (!file) return;
                
                // 保存文件引用用于刷新
                currentFile = file;

                if (typeof window.XLSX === "undefined") {
                    dom.statusValue.textContent = "XLSX 库未加载";
                    if (typeof showError === 'function' && typeof ErrorType !== 'undefined') {
                        showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
                    }
                    return;
                }

                dom.statusValue.innerHTML = `
                    <span>解析中...</span>
                    <div style="width: 100%; height: 4px; background: #e9ecef; border-radius: 2px; margin-top: 8px; overflow: hidden;">
                        <div id="parseProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #0071e3, #54a4ff); transition: width 0.3s;"></div>
                    </div>
                `;

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { 
                        type: "array", 
                        cellDates: false,
                        cellNF: false,
                        raw: true
                    });

                    // 查找 Daily Booking 工作表
                    const sheetName = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('daily') && name.toLowerCase().includes('booking')
                    ) || workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('booking')
                    ) || workbook.SheetNames[0];

                    if (!sheetName) {
                        throw new Error('未找到 Daily Booking 工作表');
                    }

                    const worksheet = workbook.Sheets[sheetName];
                    
                    // 读取为矩阵格式（保留原始值）
                    const matrix = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1, 
                        defval: null,
                        raw: true
                    });

                    if (matrix.length === 0) {
                        throw new Error('Excel 文件为空');
                    }

                    // 识别列
                    identifyColumns(matrix[0]);

                    // 解析数据（跳过标题行）
                    const parsedData = [];
                    const totalRows = matrix.length - 1;
                    const progressBar = document.getElementById('parseProgress');
                    
                    for (let i = 1; i < matrix.length; i++) {
                        // 更新进度
                        if (progressBar && i % 100 === 0) {
                            const progress = (i / totalRows * 100).toFixed(0);
                            progressBar.style.width = progress + '%';
                            // 使用 requestAnimationFrame 避免阻塞
                            await new Promise(resolve => requestAnimationFrame(resolve));
                        }

                        const row = matrix[i];
                        const date = parseDate(row[state.columns.date]);
                        const status = String(row[state.columns.status] || '').trim().toUpperCase();
                        const vesselName = String(row[state.columns.vesselName] || '').trim();
                        const voyage = String(row[state.columns.voyage] || '').trim();
                        const bkgParty = String(row[state.columns.bkgParty] || '').trim();
                        const contractNo = String(row[state.columns.contractNo] || '').trim();
                        const pod = String(row[state.columns.pod] || '').trim();
                        const ftb = String(row[state.columns.ftb] || '').trim();
                        const teu = parseFloat(row[state.columns.teu]) || 0;
                        const trade = String(row[state.columns.trade] || '').trim();
                        const expLine = String(row[state.columns.expLine] || '').trim();
                        const etd = parseDate(row[state.columns.etd]);

                        // 只保留有效状态的数据
                        if (['A', 'C', 'F', 'L', 'N', 'P', 'X'].includes(status) && date) {
                            parsedData.push({
                                date,
                                status,
                                vesselName,
                                voyage,
                                bkgParty,
                                contractNo,
                                pod,
                                ftb,
                                teu,
                                trade,
                                expLine,
                                etd
                            });
                        }
                    }
                    
                    // 完成进度
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }

                    state.rawData = parsedData;
                    initDateRange();
                    populateFilters();
                    applyFilters();

                    dom.statusValue.innerHTML = `
                        <span>已载入 ${parsedData.length.toLocaleString()} 条记录</span>
                        <span style="color: #6c757d;">筛选后：${state.filteredData.length.toLocaleString()} 条</span>
                    `;
                    dom.filtersContainer.classList.remove('hidden');
                    dom.analysisContainer.classList.remove('hidden');
                    dom.exportExcelBtn.style.display = 'inline-block';
                    dom.exportPdfBtn.style.display = 'inline-block';
                    
                    // 恢复筛选条件
                    const savedFilters = loadFilters();
                    if (savedFilters) {
                        // 延迟恢复筛选器选项，确保选项已填充
                        setTimeout(() => {
                            if (savedFilters.bkgParty && savedFilters.bkgParty.length > 0) {
                                savedFilters.bkgParty.forEach(val => {
                                    const option = Array.from(dom.bkgPartyFilter.options).find(opt => opt.value === val);
                                    if (option) option.selected = true;
                                });
                            }
                            if (savedFilters.pod && savedFilters.pod.length > 0) {
                                savedFilters.pod.forEach(val => {
                                    const option = Array.from(dom.podFilter.options).find(opt => opt.value === val);
                                    if (option) option.selected = true;
                                });
                            }
                            if (savedFilters.ftb && savedFilters.ftb.length > 0) {
                                savedFilters.ftb.forEach(val => {
                                    const option = Array.from(dom.ftbFilter.options).find(opt => opt.value === val);
                                    if (option) option.selected = true;
                                });
                            }
                            if (savedFilters.trade && savedFilters.trade.length > 0) {
                                savedFilters.trade.forEach(val => {
                                    const option = Array.from(dom.tradeFilter.options).find(opt => opt.value === val);
                                    if (option) option.selected = true;
                                });
                            }
                            applyFilters();
                        }, 100);
                    } else {
                        updateAnalysis();
                    }
                } catch (error) {
                    console.error('解析文件失败:', error);
                    dom.statusValue.textContent = '解析失败: ' + (error.message || String(error));
                    if (typeof showError === 'function' && typeof ErrorType !== 'undefined') {
                        showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', { message: error.message || String(error) }, error);
                    }
                }
            }

            /**
             * 填充筛选器选项
             */
            function populateFilters() {
                const bkgParties = [...new Set(state.rawData.map(d => d.bkgParty).filter(Boolean))].sort();
                const pods = [...new Set(state.rawData.map(d => d.pod).filter(Boolean))].sort();
                const ftbs = [...new Set(state.rawData.map(d => d.ftb).filter(Boolean))].sort();
                const trades = [...new Set(state.rawData.map(d => d.trade).filter(Boolean))].sort();

                // 使用 filter-utils.js 的工具函数
                if (typeof window.updateSelectOptions === 'function') {
                    window.updateSelectOptions(dom.bkgPartyFilter, bkgParties, '全部 BKG Party');
                    window.updateSelectOptions(dom.podFilter, pods, '全部 POD');
                    window.updateSelectOptions(dom.ftbFilter, ftbs, '全部 FTB');
                    window.updateSelectOptions(dom.tradeFilter, trades, '全部 Trade');
                } else {
                    // 降级方案
                    updateSelectOptionsFallback(dom.bkgPartyFilter, bkgParties, '全部 BKG Party');
                    updateSelectOptionsFallback(dom.podFilter, pods, '全部 POD');
                    updateSelectOptionsFallback(dom.ftbFilter, ftbs, '全部 FTB');
                    updateSelectOptionsFallback(dom.tradeFilter, trades, '全部 Trade');
                }

                // 设置多选功能
                if (typeof window.setupMultiSelect === 'function') {
                    window.setupMultiSelect(dom.bkgPartyFilter);
                    window.setupMultiSelect(dom.podFilter);
                    window.setupMultiSelect(dom.ftbFilter);
                    window.setupMultiSelect(dom.tradeFilter);
                }
            }

            /**
             * 降级方案：更新下拉框选项
             */
            function updateSelectOptionsFallback(selectElement, options, defaultLabel) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = defaultLabel;
                selectElement.appendChild(defaultOption);
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    selectElement.appendChild(optionElement);
                });
            }

            /**
             * 更新数据摘要卡片
             */
            function updateSummaryCards() {
                if (!state.filteredData || state.filteredData.length === 0) {
                    dom.summarySection.style.display = 'none';
                    return;
                }

                const stats = calculateStats(state.filteredData);
                const totalBL = stats.total.bl;
                const totalTEU = stats.total.teu;

                dom.summaryCards.innerHTML = `
                    <div class="summary-card btn-sweep-blue" style="padding: 20px; background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); border-radius: 12px; color: white; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden;" 
                         onclick="applyStatusFilter([])" 
                         onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(62, 98, 173, 0.3)'" 
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; position: relative; z-index: 2;">总记录数</div>
                        <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px; position: relative; z-index: 2;">${totalBL.toLocaleString()}</div>
                        <div style="font-size: 12px; opacity: 0.8; position: relative; z-index: 2;">BL</div>
                    </div>
                    <div class="summary-card btn-sweep-blue" style="padding: 20px; background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); border-radius: 12px; color: white; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden;" 
                         onclick="applyStatusFilter([])" 
                         onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(62, 98, 173, 0.3)'" 
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; position: relative; z-index: 2;">总TEU</div>
                        <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px; position: relative; z-index: 2;">${totalTEU.toLocaleString('zh-CN', {maximumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; opacity: 0.8; position: relative; z-index: 2;">TEU</div>
                    </div>
                    <div class="summary-card btn-sweep-blue" style="padding: 20px; background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); border-radius: 12px; color: white; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden;" 
                         onclick="applyStatusFilter(['A','C','F','L'])" 
                         onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(62, 98, 173, 0.3)'" 
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; position: relative; z-index: 2;">A/C/F/L</div>
                        <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px; position: relative; z-index: 2;">${stats.aclf.blPercent}%</div>
                        <div style="font-size: 12px; opacity: 0.8; position: relative; z-index: 2;">${stats.aclf.bl} BL / ${stats.aclf.teu.toFixed(2)} TEU</div>
                    </div>
                    <div class="summary-card btn-sweep-blue" style="padding: 20px; background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); border-radius: 12px; color: white; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden;" 
                         onclick="applyStatusFilter(['N','P'])" 
                         onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(62, 98, 173, 0.3)'" 
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; position: relative; z-index: 2;">N/P</div>
                        <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px; position: relative; z-index: 2;">${stats.np.blPercent}%</div>
                        <div style="font-size: 12px; opacity: 0.8; position: relative; z-index: 2;">${stats.np.bl} BL / ${stats.np.teu.toFixed(2)} TEU</div>
                    </div>
                    <div class="summary-card btn-sweep-blue" style="padding: 20px; background: linear-gradient(135deg, #3E62AD 0%, #2D4A7D 100%); border-radius: 12px; color: white; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden;" 
                         onclick="applyStatusFilter(['X'])" 
                         onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(62, 98, 173, 0.3)'" 
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; position: relative; z-index: 2;">X</div>
                        <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px; position: relative; z-index: 2;">${stats.x.blPercent}%</div>
                        <div style="font-size: 12px; opacity: 0.8; position: relative; z-index: 2;">${stats.x.bl} BL / ${stats.x.teu.toFixed(2)} TEU</div>
                    </div>
                `;

                dom.summarySection.style.display = 'block';
            }

            /**
             * 应用状态筛选（用于摘要卡片点击）
             * 占位实现，待扩展
             */
            window.applyStatusFilter = function(statuses) {
                if (typeof window.Toast !== 'undefined') {
                    window.Toast.show('状态筛选功能开发中', 'info');
                }
            };

            /**
             * 保存筛选条件到localStorage
             */
            function saveFilters() {
                try {
                    const filters = {
                        startDate: dom.startDate.value,
                        endDate: dom.endDate.value,
                        bkgParty: state.filters.bkgParty,
                        pod: state.filters.pod,
                        ftb: state.filters.ftb,
                        trade: state.filters.trade,
                        mode: state.currentMode,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('monitor-daily-booking-filters', JSON.stringify(filters));
                } catch (e) {
                    console.warn('保存筛选条件失败:', e);
                }
            }

            /**
             * 从localStorage恢复筛选条件
             */
            function loadFilters() {
                try {
                    const saved = localStorage.getItem('monitor-daily-booking-filters');
                    if (!saved) return false;

                    const filters = JSON.parse(saved);
                    // 只恢复7天内的设置
                    if (Date.now() - filters.timestamp > 7 * 24 * 60 * 60 * 1000) {
                        localStorage.removeItem('monitor-daily-booking-filters');
                        return false;
                    }

                    // 恢复日期
                    if (filters.startDate) dom.startDate.value = filters.startDate;
                    if (filters.endDate) dom.endDate.value = filters.endDate;

                    // 恢复模式
                    if (filters.mode === 2) {
                        dom.mode2Btn.click();
                    }

                    // 恢复筛选器（需要在数据加载后）
                    return filters;
                } catch (e) {
                    console.warn('加载筛选条件失败:', e);
                    return false;
                }
            }

            /**
             * 应用筛选器
             */
            function applyFilters() {
                // 获取选中的筛选值
                const getSelected = (selectElement) => {
                    return Array.from(selectElement.selectedOptions)
                        .map(opt => opt.value)
                        .filter(val => val !== '');
                };

                state.filters.bkgParty = getSelected(dom.bkgPartyFilter);
                state.filters.pod = getSelected(dom.podFilter);
                state.filters.ftb = getSelected(dom.ftbFilter);
                state.filters.trade = getSelected(dom.tradeFilter);

                // 筛选数据
                state.filteredData = state.rawData.filter(item => {
                    if (state.filters.bkgParty.length > 0 && !state.filters.bkgParty.includes(item.bkgParty)) return false;
                    if (state.filters.pod.length > 0 && !state.filters.pod.includes(item.pod)) return false;
                    if (state.filters.ftb.length > 0 && !state.filters.ftb.includes(item.ftb)) return false;
                    if (state.filters.trade.length > 0 && !state.filters.trade.includes(item.trade)) return false;
                    return true;
                });

                // 按时间范围筛选
                const { start, end } = getDateRange();
                if (start && end) {
                    state.filteredData = state.filteredData.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate >= start && itemDate <= end;
                    });
                }

                updateAnalysis();
            }

            /**
             * 计算统计数据
             */
            function calculateStats(data) {
                const total = {
                    bl: data.length,
                    teu: data.reduce((sum, item) => sum + item.teu, 0)
                };

                // A/C/F/L 组合
                const aclf = data.filter(item => ['A', 'C', 'F', 'L'].includes(item.status));
                const aclfStats = {
                    bl: aclf.length,
                    teu: aclf.reduce((sum, item) => sum + item.teu, 0),
                    blPercent: total.bl > 0 ? (aclf.length / total.bl * 100).toFixed(2) : 0,
                    teuPercent: total.teu > 0 ? (aclf.reduce((sum, item) => sum + item.teu, 0) / total.teu * 100).toFixed(2) : 0
                };

                // N/P 组合
                const np = data.filter(item => ['N', 'P'].includes(item.status));
                const npStats = {
                    bl: np.length,
                    teu: np.reduce((sum, item) => sum + item.teu, 0),
                    blPercent: total.bl > 0 ? (np.length / total.bl * 100).toFixed(2) : 0,
                    teuPercent: total.teu > 0 ? (np.reduce((sum, item) => sum + item.teu, 0) / total.teu * 100).toFixed(2) : 0
                };

                // X
                const x = data.filter(item => item.status === 'X');
                const xStats = {
                    bl: x.length,
                    teu: x.reduce((sum, item) => sum + item.teu, 0),
                    blPercent: total.bl > 0 ? (x.length / total.bl * 100).toFixed(2) : 0,
                    teuPercent: total.teu > 0 ? (x.reduce((sum, item) => sum + item.teu, 0) / total.teu * 100).toFixed(2) : 0
                };

                return {
                    total,
                    aclf: aclfStats,
                    np: npStats,
                    x: xStats
                };
            }

            /**
             * 更新分析展示
             */
            function updateAnalysis() {
                // 更新数据摘要卡片
                updateSummaryCards();
                
                // 检查是否有数据
                if (!state.filteredData || state.filteredData.length === 0) {
                    dom.emptyDataMessage.style.display = 'block';
                    dom.analysisContainer.style.display = 'none';
                    return;
                }

                dom.emptyDataMessage.style.display = 'none';
                dom.analysisContainer.style.display = 'block';

                if (state.currentMode === 1) {
                    updateMode1();
                } else if (state.currentMode === 2) {
                    updateMode2();
                } else {
                    updateMode3();
                }
            }

            /**
             * 清除所有筛选条件
             */
            function clearAllFilters() {
                // 清除日期筛选
                initDateRange();
                
                // 清除所有下拉框选择
                [dom.bkgPartyFilter, dom.podFilter, dom.ftbFilter, dom.tradeFilter].forEach(select => {
                    Array.from(select.options).forEach(opt => opt.selected = false);
                });
                
                // 清除搜索框
                [dom.bkgPartySearch, dom.podSearch, dom.ftbSearch, dom.tradeSearch].forEach(input => {
                    input.value = '';
                });
                
                // 应用筛选
                applyFilters();
            }

            /**
             * 生成带排序按钮的表头（苹果风格）
             */
            function createSortableHeader(text, columnKey, mode) {
                const sortStateForMode = mode === 1 ? sortState.mode1 : (mode === 2 ? sortState.mode2 : sortState.mode3);
                const isActive = sortStateForMode.column === columnKey;
                const direction = isActive ? sortStateForMode.direction : null;
                
                // 蓝色主题的箭头SVG - 白色箭头
                const activeColor = '#ffffff';
                const inactiveColor = 'rgba(255, 255, 255, 0.5)';
                
                const upArrowSvg = (color, opacity = 1) => `<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block; opacity: ${opacity};">
                    <path d="M5 2L2 5H8L5 2Z" fill="${color}" stroke="none"/>
                </svg>`;
                
                const downArrowSvg = (color, opacity = 1) => `<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block; opacity: ${opacity};">
                    <path d="M5 8L8 5H2L5 8Z" fill="${color}" stroke="none"/>
                </svg>`;
                
                // 生成箭头HTML
                let arrowHtml = '';
                if (isActive) {
                    if (direction === 'asc') {
                        // 升序：上箭头激活（白色），下箭头半透明
                        arrowHtml = `<span style="display: inline-flex; flex-direction: column; align-items: center; gap: 4px; margin-left: 10px; vertical-align: middle; line-height: 1;">
                            ${upArrowSvg(activeColor, 1)}
                            ${downArrowSvg(inactiveColor, 0.5)}
                        </span>`;
                    } else {
                        // 降序：下箭头激活（白色），上箭头半透明
                        arrowHtml = `<span style="display: inline-flex; flex-direction: column; align-items: center; gap: 4px; margin-left: 10px; vertical-align: middle; line-height: 1;">
                            ${upArrowSvg(inactiveColor, 0.5)}
                            ${downArrowSvg(activeColor, 1)}
                        </span>`;
                    }
                } else {
                    // 未激活：两个箭头都是半透明白色
                    arrowHtml = `<span style="display: inline-flex; flex-direction: column; align-items: center; gap: 4px; margin-left: 10px; vertical-align: middle; line-height: 1;">
                        ${upArrowSvg(inactiveColor, 0.7)}
                        ${downArrowSvg(inactiveColor, 0.7)}
                    </span>`;
                }
                
                return `
                    <th style="${CONFIG.STYLES.TABLE_HEADER} cursor: pointer; user-select: none; position: sticky; top: 0;
                              background: ${CONFIG.COLORS.PRIMARY} !important; 
                              transition: background-color 0.15s ease;" 
                        data-column="${columnKey}" 
                        data-mode="${mode}"
                        onmouseover="this.style.background='${CONFIG.COLORS.PRIMARY_DARK}'"
                        onmouseout="this.style.background='${CONFIG.COLORS.PRIMARY}'"
                        onclick="handleSort('${columnKey}', ${mode})">
                        <span style="display: inline-flex; align-items: center; width: 100%; color: ${CONFIG.COLORS.BORDER_WHITE};">
                            <span style="font-weight: 600; color: ${CONFIG.COLORS.BORDER_WHITE}; font-size: 14px;">
                                ${text}
                            </span>
                            ${arrowHtml}
                        </span>
                    </th>
                `;
            }

            /**
             * 处理排序
             */
            window.handleSort = function(columnKey, mode) {
                const sortStateForMode = mode === 1 ? sortState.mode1 : (mode === 2 ? sortState.mode2 : sortState.mode3);
                if (sortStateForMode.column === columnKey) {
                    // 切换排序方向
                    sortStateForMode.direction = sortStateForMode.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    // 新列，默认升序
                    sortStateForMode.column = columnKey;
                    sortStateForMode.direction = 'asc';
                }
                updateAnalysis();
            };

            /**
             * 显示详细记录弹窗
             */
            window.showDetailModal = function(title, dataKey) {
                // 从全局存储中获取数据
                const data = window.detailModalDataStore && window.detailModalDataStore[dataKey];
                if (!data) {
                    console.error('详细数据未找到:', dataKey);
                    alert('无法加载详细数据，请刷新页面重试');
                    return;
                }

                // 判断是否为VSL/VOY维度（通过dataKey判断）
                const isVslVoyMode = dataKey && dataKey.includes('vslvoy');

                const modal = document.createElement('div');
                modal.id = 'detailModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                
                // 添加点击外部关闭功能
                const closeModal = () => {
                    const modalEl = document.getElementById('detailModal');
                    if (modalEl) {
                        modalEl.remove();
                    }
                };
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // 转义HTML特殊字符
                const escapeHtml = (text) => {
                    if (text === null || text === undefined) return '';
                    const div = document.createElement('div');
                    div.textContent = String(text);
                    return div.innerHTML;
                };

                // 计算单条记录的统计信息
                const calculateItemStats = (item) => {
                    const isAclf = ['A', 'C', 'F', 'L'].includes(item.status);
                    const isNp = ['N', 'P'].includes(item.status);
                    const isX = item.status === 'X';
                    
                    return {
                        total: { bl: 1, teu: item.teu || 0 },
                        aclf: { 
                            bl: isAclf ? 1 : 0, 
                            teu: isAclf ? (item.teu || 0) : 0,
                            blPercent: isAclf ? '100.00' : '0.00',
                            teuPercent: isAclf ? '100.00' : '0.00'
                        },
                        np: { 
                            bl: isNp ? 1 : 0, 
                            teu: isNp ? (item.teu || 0) : 0,
                            blPercent: isNp ? '100.00' : '0.00',
                            teuPercent: isNp ? '100.00' : '0.00'
                        },
                        x: { 
                            bl: isX ? 1 : 0, 
                            teu: isX ? (item.teu || 0) : 0,
                            blPercent: isX ? '100.00' : '0.00',
                            teuPercent: isX ? '100.00' : '0.00'
                        }
                    };
                };

                // 创建内容容器
                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 95%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;';
                
                // 阻止内容区域的点击冒泡
                modalContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // 添加标题和关闭按钮
                const header = document.createElement('div');
                header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;';
                header.innerHTML = `
                    <h3 style="margin: 0; color: #333;">${escapeHtml(title)}</h3>
                    <button id="closeDetailModalBtn" class="btn-sweep-blue" style="padding: 8px 16px; background: ${CONFIG.COLORS.PRIMARY}; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">关闭</button>
                `;
                
                // 绑定关闭按钮
                header.querySelector('#closeDetailModalBtn').addEventListener('click', closeModal);
                header.querySelector('#closeDetailModalBtn').addEventListener('mouseover', function() {
                    this.style.background = CONFIG.COLORS.PRIMARY_DARK;
                });
                header.querySelector('#closeDetailModalBtn').addEventListener('mouseout', function() {
                    this.style.background = CONFIG.COLORS.PRIMARY;
                });
                
                // 生成表格HTML
                const tableHtml = `
                    <div class="detail-table-container">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                ${isVslVoyMode ? `
                                <tr style="background: ${CONFIG.COLORS.PRIMARY}; color: ${CONFIG.COLORS.BORDER_WHITE}; border-bottom: 2px solid ${CONFIG.COLORS.BORDER_WHITE};">
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">订舱日期</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">BKG Party</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">合约号</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">POD</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">总量</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">A/C/F/L</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">A/C/F/L占比</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">N/P</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">N/P占比</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">X</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">X占比</th>
                                </tr>
                                ` : `
                                <tr style="background: ${CONFIG.COLORS.PRIMARY}; color: ${CONFIG.COLORS.BORDER_WHITE}; border-bottom: 2px solid ${CONFIG.COLORS.BORDER_WHITE};">
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">日期</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">状态</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">BKG Party</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">船名航次</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">合约号</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">POD</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">FTB</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">TEU</th>
                                    <th style="${CONFIG.STYLES.TABLE_HEADER}">Trade</th>
                                </tr>
                                `}
                            </thead>
                                    <tbody>
                                        ${isVslVoyMode ? (() => {
                                            // 按POD分组
                                            const podMap = {};
                                            data.forEach(item => {
                                                const pod = item.pod || '未分类';
                                                if (!podMap[pod]) {
                                                    podMap[pod] = [];
                                                }
                                                podMap[pod].push(item);
                                            });

                                            // 计算每个POD的统计
                                            const podStats = [];
                                            Object.entries(podMap).forEach(([pod, podData]) => {
                                                // 按日期排序
                                                podData.sort((a, b) => new Date(a.date) - new Date(b.date));
                                                const stats = calculateStats(podData);
                                                podStats.push({ pod, stats, data: podData });
                                            });

                                            // 按POD名称排序
                                            podStats.sort((a, b) => a.pod.localeCompare(b.pod));

                                            // 计算合计统计
                                            const totalStats = calculateStats(data);

                                            // 生成表格行
                                            let rows = '';
                                            podStats.forEach((podItem, podIdx) => {
                                                // 显示该POD的所有记录
                                                podItem.data.forEach((item, itemIdx) => {
                                                    const date = new Date(item.date);
                                                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                                    const itemStats = calculateItemStats(item);
                                                    const isLastItem = itemIdx === podItem.data.length - 1;
                                                    const isLastPod = podIdx === podStats.length - 1;
                                                    
                                                    rows += `
                                                        <tr style="border-bottom: 1px solid ${CONFIG.COLORS.BORDER}; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='${CONFIG.COLORS.HOVER}'" onmouseout="this.style.backgroundColor=''">
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; border-left: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">${escapeHtml(dateStr)}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">${escapeHtml(item.bkgParty)}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">${escapeHtml(item.contractNo || '-')}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">${escapeHtml(podItem.pod)}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">BL: ${itemStats.total.bl}<br>TEU: ${itemStats.total.teu.toFixed(2)}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">BL: ${itemStats.aclf.bl}<br>TEU: ${itemStats.aclf.teu.toFixed(2)}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">BL: ${itemStats.aclf.blPercent}%<br>TEU: ${itemStats.aclf.teuPercent}%</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">BL: ${itemStats.np.bl}<br>TEU: ${itemStats.np.teu.toFixed(2)}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">BL: ${itemStats.np.blPercent}%<br>TEU: ${itemStats.np.teuPercent}%</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">BL: ${itemStats.x.bl}<br>TEU: ${itemStats.x.teu.toFixed(2)}</td>
                                                            <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; border-right: none; ${isLastItem && isLastPod ? 'border-bottom: none;' : ''}">BL: ${itemStats.x.blPercent}%<br>TEU: ${itemStats.x.teuPercent}%</td>
                                                        </tr>
                                                    `;
                                                });

                                                // 显示该POD的汇总行
                                                rows += `
                                                    <tr style="background-color: #e9ecef; font-weight: 600;">
                                                        <td colspan="4" style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; border-left: none; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">${escapeHtml(podItem.pod)} 小计</td>
                                                        <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">BL: ${podItem.stats.total.bl}<br>TEU: ${podItem.stats.total.teu.toFixed(2)}</td>
                                                        <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">BL: ${podItem.stats.aclf.bl}<br>TEU: ${podItem.stats.aclf.teu.toFixed(2)}</td>
                                                        <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">BL: ${podItem.stats.aclf.blPercent}%<br>TEU: ${podItem.stats.aclf.teuPercent}%</td>
                                                        <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">BL: ${podItem.stats.np.bl}<br>TEU: ${podItem.stats.np.teu.toFixed(2)}</td>
                                                        <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">BL: ${podItem.stats.np.blPercent}%<br>TEU: ${podItem.stats.np.teuPercent}%</td>
                                                        <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">BL: ${podItem.stats.x.bl}<br>TEU: ${podItem.stats.x.teu.toFixed(2)}</td>
                                                        <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 1px solid #495057; border-right: none; ${podIdx === podStats.length - 1 ? 'border-bottom: none;' : ''}">BL: ${podItem.stats.x.blPercent}%<br>TEU: ${podItem.stats.x.teuPercent}%</td>
                                                    </tr>
                                                `;
                                            });

                                            // 添加合计行
                                            rows += `
                                                <tr style="background-color: #f8f9fa; font-weight: 600;">
                                                    <td colspan="4" style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-left: none; border-bottom: none;">合计</td>
                                                    <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-bottom: none;">BL: ${totalStats.total.bl}<br>TEU: ${totalStats.total.teu.toFixed(2)}</td>
                                                    <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-bottom: none;">BL: ${totalStats.aclf.bl}<br>TEU: ${totalStats.aclf.teu.toFixed(2)}</td>
                                                    <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-bottom: none;">BL: ${totalStats.aclf.blPercent}%<br>TEU: ${totalStats.aclf.teuPercent}%</td>
                                                    <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-bottom: none;">BL: ${totalStats.np.bl}<br>TEU: ${totalStats.np.teu.toFixed(2)}</td>
                                                    <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-bottom: none;">BL: ${totalStats.np.blPercent}%<br>TEU: ${totalStats.np.teuPercent}%</td>
                                                    <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-bottom: none;">BL: ${totalStats.x.bl}<br>TEU: ${totalStats.x.teu.toFixed(2)}</td>
                                                    <td style="padding: 12px; border: 1px solid #dee2e6; border-top: 2px solid #495057; border-right: none; border-bottom: none;">BL: ${totalStats.x.blPercent}%<br>TEU: ${totalStats.x.teuPercent}%</td>
                                                </tr>
                                            `;

                                            return rows;
                                        })() : data.map((item, idx) => {
                                            const date = new Date(item.date);
                                            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                            const isLast = idx === data.length - 1;
                                            const vesselVoyage = `${escapeHtml(item.vesselName || '')} ${escapeHtml(item.voyage || '')}`.trim() || '-';
                                            return `
                                                <tr style="border-bottom: 1px solid ${CONFIG.COLORS.BORDER}; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='${CONFIG.COLORS.HOVER}'" onmouseout="this.style.backgroundColor=''">
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; border-left: none; ${isLast ? 'border-bottom: none;' : ''}">${escapeHtml(dateStr)}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLast ? 'border-bottom: none;' : ''}">${escapeHtml(item.status)}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLast ? 'border-bottom: none;' : ''}">${escapeHtml(item.bkgParty)}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLast ? 'border-bottom: none;' : ''}">${vesselVoyage}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLast ? 'border-bottom: none;' : ''}">${escapeHtml(item.contractNo || '-')}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLast ? 'border-bottom: none;' : ''}">${escapeHtml(item.pod)}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLast ? 'border-bottom: none;' : ''}">${escapeHtml(item.ftb)}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; ${isLast ? 'border-bottom: none;' : ''}">${item.teu ? item.teu.toFixed(2) : '0.00'}</td>
                                                    <td style="${CONFIG.STYLES.TABLE_CELL} border-top: none; border-right: none; ${isLast ? 'border-bottom: none;' : ''}">${escapeHtml(item.trade)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                    </div>
                `;
                
                // 组装内容
                modalContent.appendChild(header);
                modalContent.insertAdjacentHTML('beforeend', tableHtml);
                
                // 组装弹窗
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            };

            // 全局数据存储（用于数据钻取）
            window.detailModalDataStore = {};

            /**
             * 公共函数：按键分组数据
             */
            function groupByKey(data, keyFn, defaultValue = '未分类') {
                const grouped = {};
                data.forEach(item => {
                    const key = keyFn(item) || defaultValue;
                    if (!grouped[key]) {
                        grouped[key] = [];
                    }
                    grouped[key].push(item);
                });
                return grouped;
            }

            /**
             * 公共函数：按日期分组
             */
            function groupByDate(data, dateFn) {
                const grouped = {};
                data.forEach(item => {
                    const date = dateFn(item);
                    const dateKey = date ? formatDate(new Date(date)) : '';
                    if (!grouped[dateKey]) {
                        grouped[dateKey] = [];
                    }
                    grouped[dateKey].push(item);
                });
                return grouped;
            }

            /**
             * 公共函数：应用排序
             */
            function applySorting(data, sortConfig, getValueFn) {
                if (!sortConfig.column) return data;
                
                return [...data].sort((a, b) => {
                    const aVal = getValueFn(a, sortConfig.column);
                    const bVal = getValueFn(b, sortConfig.column);
                    const result = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    return sortConfig.direction === 'asc' ? result : -result;
                });
            }

            /**
             * 公共函数：应用ETD特殊排序（没有ETD的排在前面）
             */
            function applyEtdSorting(data, sortConfig) {
                if (!sortConfig.column || sortConfig.column !== 'etd') {
                    return applySorting(data, sortConfig, getStatsValue);
                }
                
                return [...data].sort((a, b) => {
                    // 没有ETD的排在前面
                    if (!a.etd && b.etd) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (a.etd && !b.etd) return sortConfig.direction === 'asc' ? 1 : -1;
                    if (!a.etd && !b.etd) {
                        const vslCompare = (a.vslVoy || '').localeCompare(b.vslVoy || '');
                        if (vslCompare !== 0) return sortConfig.direction === 'asc' ? vslCompare : -vslCompare;
                        const tradeCompare = (a.trade || '').localeCompare(b.trade || '');
                        return sortConfig.direction === 'asc' ? tradeCompare : -tradeCompare;
                    }
                    const aVal = new Date(a.etd).getTime();
                    const bVal = new Date(b.etd).getTime();
                    const result = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    return sortConfig.direction === 'asc' ? result : -result;
                });
            }

            /**
             * 公共函数：应用排名排序
             */
            function applyRankingSort(data, rankingBy) {
                return [...data].sort((a, b) => {
                    let aVal, bVal;
                    switch (rankingBy) {
                        case 'total-bl':
                            aVal = a.stats.total.bl;
                            bVal = b.stats.total.bl;
                            break;
                        case 'total-teu':
                            aVal = a.stats.total.teu;
                            bVal = b.stats.total.teu;
                            break;
                        case 'aclf-bl':
                            aVal = a.stats.aclf.bl;
                            bVal = b.stats.aclf.bl;
                            break;
                        case 'aclf-teu':
                            aVal = a.stats.aclf.teu;
                            bVal = b.stats.aclf.teu;
                            break;
                        default:
                            return 0;
                    }
                    return bVal - aVal; // 降序
                });
            }

            /**
             * 公共函数：获取统计值（用于排序）
             */
            function getStatsValue(item, columnKey) {
                if (!item.stats) {
                    // 对于没有stats的对象（如VSL/VOY模式），直接返回属性值
                    switch (columnKey) {
                        case 'etd': return item.etd ? new Date(item.etd).getTime() : 0;
                        case 'expLine': return item.expLine || '';
                        case 'vslVoy': return item.vslVoy || '';
                        case 'trade': return item.trade || '';
                        default: return 0;
                    }
                }
                switch (columnKey) {
                    case 'time': return item.time || '';
                    case 'total-bl': return item.stats.total.bl;
                    case 'total-teu': return item.stats.total.teu;
                    case 'aclf-bl': return item.stats.aclf.bl;
                    case 'aclf-teu': return item.stats.aclf.teu;
                    case 'aclf-percent': return parseFloat(item.stats.aclf.blPercent);
                    case 'np-bl': return item.stats.np.bl;
                    case 'np-teu': return item.stats.np.teu;
                    case 'np-percent': return parseFloat(item.stats.np.blPercent);
                    case 'x-bl': return item.stats.x.bl;
                    case 'x-teu': return item.stats.x.teu;
                    case 'x-percent': return parseFloat(item.stats.x.blPercent);
                    case 'etd': return item.etd ? new Date(item.etd).getTime() : 0;
                    case 'expLine': return item.expLine || '';
                    case 'vslVoy': return item.vslVoy || '';
                    case 'trade': return item.trade || '';
                    default: return 0;
                }
            }

            /**
             * 公共函数：分批渲染表格行（性能优化）
             */
            function renderTableRowsBatch(container, rowsHtml, batchSize = CONFIG.RENDERING.BATCH_SIZE) {
                if (!rowsHtml || rowsHtml.trim().length === 0) {
                    container.innerHTML = '';
                    return;
                }

                // 先解析HTML为DOM元素（tr标签需要表格上下文）
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = `<table><tbody>${rowsHtml.trim()}</tbody></table>`;
                
                // 获取所有tr元素
                const rows = Array.from(tempDiv.querySelectorAll('tr'));
                
                if (rows.length === 0) {
                    // 如果没有tr元素，直接设置innerHTML
                    container.innerHTML = rowsHtml;
                    return;
                }

                // 如果数据量小，直接渲染
                if (rows.length <= batchSize) {
                    container.innerHTML = rowsHtml;
                    return;
                }

                // 分批渲染tr元素
                container.innerHTML = '';
                let currentIndex = 0;
                
                function renderBatch() {
                    const endIndex = Math.min(currentIndex + batchSize, rows.length);
                    const fragment = document.createDocumentFragment();
                    
                    for (let i = currentIndex; i < endIndex; i++) {
                        fragment.appendChild(rows[i].cloneNode(true));
                    }
                    
                    container.appendChild(fragment);
                    currentIndex = endIndex;
                    
                    if (currentIndex < rows.length) {
                        requestAnimationFrame(renderBatch);
                    }
                }
                
                renderBatch();
            }

            /**
             * 更新模式1：Trade维度
             */
            function updateMode1() {
                // 先按Trade分组
                const tradeMap = groupByKey(state.filteredData, item => item.trade);

                // 按Trade分组，每个Trade下按时间分组
                const tradeTimeGroups = [];
                Object.entries(tradeMap).forEach(([trade, data]) => {
                    // 按时间分组
                    const timeMap = groupByDate(data, item => item.date);

                    // 转换为数组并排序
                    const timeArray = Object.entries(timeMap)
                        .map(([time, items]) => ({ time, data: items }))
                        .sort((a, b) => a.time.localeCompare(b.time));

                    tradeTimeGroups.push({
                        trade,
                        totalStats: calculateStats(data),
                        timeGroups: timeArray
                    });
                });

                // 按Trade名称排序
                tradeTimeGroups.sort((a, b) => a.trade.localeCompare(b.trade));

                // 扁平化数据用于排序
                // 模式1默认按时间升序
                if (!sortState.mode1.column) {
                    sortState.mode1.column = 'time';
                    sortState.mode1.direction = 'asc';
                }
                let flatData = [];
                tradeTimeGroups.forEach(tradeGroup => {
                    tradeGroup.timeGroups.forEach(timeGroup => {
                        const stats = calculateStats(timeGroup.data);
                        flatData.push({
                            trade: tradeGroup.trade,
                            time: timeGroup.time,
                            stats,
                            data: timeGroup.data
                        });
                    });
                });

                // 应用排序
                flatData = applySorting(flatData, sortState.mode1, getStatsValue);

                // 重新分组（保持Trade分组显示）
                const groupedData = {};
                flatData.forEach(item => {
                    if (!groupedData[item.trade]) {
                        groupedData[item.trade] = [];
                    }
                    groupedData[item.trade].push(item);
                });

                // 生成表格
                let tableHTML = `
                    <div class="detail-table-container" style="${CONFIG.STYLES.TABLE_CONTAINER}">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: ${CONFIG.COLORS.PRIMARY}; color: ${CONFIG.COLORS.BORDER_WHITE}; border-bottom: 2px solid ${CONFIG.COLORS.BORDER_WHITE};">
                                <th style="${CONFIG.STYLES.TABLE_HEADER}">Trade</th>
                                ${createSortableHeader('时间', 'time', 1)}
                                ${createSortableHeader('总量', 'total-bl', 1)}
                                ${createSortableHeader('A/C/F/L', 'aclf-bl', 1)}
                                ${createSortableHeader('A/C/F/L占比', 'aclf-percent', 1)}
                                ${createSortableHeader('N/P', 'np-bl', 1)}
                                ${createSortableHeader('N/P占比', 'np-percent', 1)}
                                ${createSortableHeader('X', 'x-bl', 1)}
                                ${createSortableHeader('X占比', 'x-percent', 1)}
                            </tr>
                        </thead>
                        <tbody>
                `;

                Object.entries(groupedData).forEach(([trade, items]) => {
                    items.forEach((item, index) => {
                        const isFirst = index === 0;
                        const rowspan = isFirst ? items.length : 0;
                        // 使用全局数据存储，避免JSON.stringify在onclick中的问题
                        const dataKey = `detail-${trade}-${item.time}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        if (!window.detailModalDataStore) {
                            window.detailModalDataStore = {};
                        }
                        window.detailModalDataStore[dataKey] = item.data;
                        
                        tableHTML += `
                            <tr style="${CONFIG.STYLES.TABLE_ROW_HOVER}" 
                                onmouseover="this.style.backgroundColor='${CONFIG.COLORS.HOVER}'" 
                                onmouseout="this.style.backgroundColor=''"
                                title="点击查看详细记录"
                                data-detail-key="${dataKey}"
                                onclick="window.showDetailModal('${trade.replace(/'/g, "\\'")} - ${item.time.replace(/'/g, "\\'")} 详细记录', '${dataKey}')">
                                ${isFirst ? `<td rowspan="${rowspan}" style="${CONFIG.STYLES.TABLE_CELL} font-weight: 600; background-color: ${CONFIG.COLORS.BACKGROUND_LIGHT};">${trade}</td>` : ''}
                                <td style="${CONFIG.STYLES.TABLE_CELL}">${item.time}</td>
                                <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.total.bl}<br>TEU: ${item.stats.total.teu.toFixed(2)}</td>
                                <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.aclf.bl}<br>TEU: ${item.stats.aclf.teu.toFixed(2)}</td>
                                <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.aclf.blPercent}%<br>TEU: ${item.stats.aclf.teuPercent}%</td>
                                <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.np.bl}<br>TEU: ${item.stats.np.teu.toFixed(2)}</td>
                                <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.np.blPercent}%<br>TEU: ${item.stats.np.teuPercent}%</td>
                                <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.x.bl}<br>TEU: ${item.stats.x.teu.toFixed(2)}</td>
                                <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.x.blPercent}%<br>TEU: ${item.stats.x.teuPercent}%</td>
                            </tr>
                        `;
                    });
                });

                tableHTML += `
                        </tbody>
                    </table>
                    </div>
                `;

                // 使用分批渲染优化（仅对tbody内容）
                const tbodyStart = tableHTML.indexOf('<tbody>') + 7;
                const tbodyEnd = tableHTML.indexOf('</tbody>');
                if (tbodyStart > 6 && tbodyEnd > tbodyStart) {
                    const headerHtml = tableHTML.substring(0, tbodyStart);
                    const rowsHtml = tableHTML.substring(tbodyStart, tbodyEnd);
                    const footerHtml = tableHTML.substring(tbodyEnd);
                    
                    dom.mode1Table.innerHTML = headerHtml + footerHtml;
                    const tbody = dom.mode1Table.querySelector('tbody');
                    if (tbody && rowsHtml) {
                        renderTableRowsBatch(tbody, rowsHtml);
                    } else {
                        dom.mode1Table.innerHTML = tableHTML;
                    }
                } else {
                    dom.mode1Table.innerHTML = tableHTML;
                }

                // 生成图表 - 按Trade展示汇总
                const chartData = tradeTimeGroups.map(g => ({ 
                    label: g.trade, 
                    data: g.timeGroups.flatMap(tg => tg.data) 
                }));
                generateCharts(chartData, 'mode1Charts', 'Trade');
            }

            /**
             * 更新模式2：Account维度
             */
            function updateMode2() {
                // 按BKG Party分组
                const partyMap = groupByKey(state.filteredData, item => item.bkgParty);

                // 转换为数组
                let partyArray = Object.entries(partyMap)
                    .map(([party, data]) => ({ 
                        party, 
                        data,
                        stats: calculateStats(data)
                    }));

                // 模式2默认按总量降序
                if (!sortState.mode2.column) {
                    sortState.mode2.column = 'total-bl';
                    sortState.mode2.direction = 'desc';
                }

                // 应用排序
                if (sortState.mode2.column) {
                    partyArray.sort((a, b) => {
                        let aVal, bVal;
                        switch (sortState.mode2.column) {
                            case 'total-bl':
                                aVal = a.stats.total.bl;
                                bVal = b.stats.total.bl;
                                break;
                            case 'total-teu':
                                aVal = a.stats.total.teu;
                                bVal = b.stats.total.teu;
                                break;
                            case 'aclf-bl':
                                aVal = a.stats.aclf.bl;
                                bVal = b.stats.aclf.bl;
                                break;
                            case 'aclf-teu':
                                aVal = a.stats.aclf.teu;
                                bVal = b.stats.aclf.teu;
                                break;
                            case 'aclf-percent':
                                aVal = parseFloat(a.stats.aclf.blPercent);
                                bVal = parseFloat(b.stats.aclf.blPercent);
                                break;
                            case 'np-bl':
                                aVal = a.stats.np.bl;
                                bVal = b.stats.np.bl;
                                break;
                            case 'np-teu':
                                aVal = a.stats.np.teu;
                                bVal = b.stats.np.teu;
                                break;
                            case 'np-percent':
                                aVal = parseFloat(a.stats.np.blPercent);
                                bVal = parseFloat(b.stats.np.blPercent);
                                break;
                            case 'x-bl':
                                aVal = a.stats.x.bl;
                                bVal = b.stats.x.bl;
                                break;
                            case 'x-teu':
                                aVal = a.stats.x.teu;
                                bVal = b.stats.x.teu;
                                break;
                            case 'x-percent':
                                aVal = parseFloat(a.stats.x.blPercent);
                                bVal = parseFloat(b.stats.x.blPercent);
                                break;
                            default:
                                return 0;
                        }
                        const result = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                        return sortState.mode2.direction === 'asc' ? result : -result;
                    });
                } else {
                    // 默认按名称排序
                    partyArray.sort((a, b) => a.party.localeCompare(b.party));
                }

                // 生成表格
                let tableHTML = `
                    <div class="detail-table-container" style="${CONFIG.STYLES.TABLE_CONTAINER}">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: ${CONFIG.COLORS.PRIMARY}; color: ${CONFIG.COLORS.BORDER_WHITE}; border-bottom: 2px solid ${CONFIG.COLORS.BORDER_WHITE};">
                                <th style="${CONFIG.STYLES.TABLE_HEADER}">BKG Party</th>
                                ${createSortableHeader('总量', 'total-bl', 2)}
                                ${createSortableHeader('A/C/F/L', 'aclf-bl', 2)}
                                ${createSortableHeader('A/C/F/L占比', 'aclf-percent', 2)}
                                ${createSortableHeader('N/P', 'np-bl', 2)}
                                ${createSortableHeader('N/P占比', 'np-percent', 2)}
                                ${createSortableHeader('X', 'x-bl', 2)}
                                ${createSortableHeader('X占比', 'x-percent', 2)}
                            </tr>
                        </thead>
                        <tbody>
                `;

                // 应用排名筛选
                if (rankingState.enabled) {
                    partyArray = applyRankingSort(partyArray, rankingState.by);
                    // 如果count为0（全部），则不限制数量；否则只保留Top N
                    if (rankingState.count > 0) {
                        partyArray = partyArray.slice(0, rankingState.count);
                    }
                }

                partyArray.forEach((item, index) => {
                    const rankBadge = rankingState.enabled ? `<span style="display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; background: ${index < 3 ? '#0071e3' : '#6c757d'}; color: white; border-radius: 50%; font-size: 12px; font-weight: 600; margin-right: 8px;">${index + 1}</span>` : '';
                    // 使用全局数据存储，避免JSON.stringify在onclick中的问题
                    const dataKey = `detail-${item.party}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    if (!window.detailModalDataStore) {
                        window.detailModalDataStore = {};
                    }
                    window.detailModalDataStore[dataKey] = item.data;
                    
                    tableHTML += `
                        <tr style="${CONFIG.STYLES.TABLE_ROW_HOVER}" 
                            onmouseover="this.style.backgroundColor='${CONFIG.COLORS.HOVER}'" 
                            onmouseout="this.style.backgroundColor=''"
                            title="点击查看详细记录"
                            data-detail-key="${dataKey}"
                            onclick="window.showDetailModal('${String(item.party).replace(/'/g, "\\'").replace(/"/g, '&quot;')} 详细记录', '${dataKey}')">
                            <td style="${CONFIG.STYLES.TABLE_CELL} font-weight: 600;">${rankBadge}${item.party}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.total.bl}<br>TEU: ${item.stats.total.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.aclf.bl}<br>TEU: ${item.stats.aclf.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.aclf.blPercent}%<br>TEU: ${item.stats.aclf.teuPercent}%</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.np.bl}<br>TEU: ${item.stats.np.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.np.blPercent}%<br>TEU: ${item.stats.np.teuPercent}%</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.x.bl}<br>TEU: ${item.stats.x.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.x.blPercent}%<br>TEU: ${item.stats.x.teuPercent}%</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                    </div>
                `;

                // 使用分批渲染优化
                const tbodyStart = tableHTML.indexOf('<tbody>') + 7;
                const tbodyEnd = tableHTML.indexOf('</tbody>');
                if (tbodyStart > 6 && tbodyEnd > tbodyStart) {
                    const headerHtml = tableHTML.substring(0, tbodyStart);
                    const rowsHtml = tableHTML.substring(tbodyStart, tbodyEnd);
                    const footerHtml = tableHTML.substring(tbodyEnd);
                    
                    dom.mode2Table.innerHTML = headerHtml + footerHtml;
                    const tbody = dom.mode2Table.querySelector('tbody');
                    if (tbody && rowsHtml) {
                        renderTableRowsBatch(tbody, rowsHtml);
                    } else {
                        dom.mode2Table.innerHTML = tableHTML;
                    }
                } else {
                    dom.mode2Table.innerHTML = tableHTML;
                }

                // 生成图表 - 按客户展示
                const chartData = partyArray.map(item => ({
                    label: item.party,
                    data: item.data
                }));
                generateCharts(chartData, 'mode2Charts', 'BKG Party');
            }

            /**
             * 更新模式3：VSL/VOY维度
             */
            function updateMode3() {
                // 按VSL/VOY分组（船名+航次）
                const vslVoyMap = groupByKey(state.filteredData, item => `${item.vesselName || ''} ${item.voyage || ''}`.trim());

                // 转换为数组，每个元素包含VSL/VOY、ETD、EXP LINE、Trade等信息
                let vslVoyArray = [];
                Object.entries(vslVoyMap).forEach(([vslVoy, data]) => {
                    // 获取该VSL/VOY下的所有唯一ETD、EXP LINE、Trade组合
                    const combinations = {};
                    data.forEach(item => {
                        const etdKey = item.etd ? formatDate(new Date(item.etd)) : '';
                        const expLine = item.expLine || '';
                        const trade = item.trade || '';
                        const key = `${etdKey}|${expLine}|${vslVoy}|${trade}`;
                        
                        if (!combinations[key]) {
                            combinations[key] = {
                                etd: item.etd,
                                etdKey: etdKey,
                                expLine: expLine,
                                vslVoy: vslVoy,
                                trade: trade,
                                data: []
                            };
                        }
                        combinations[key].data.push(item);
                    });

                    // 将每个组合添加到数组中
                    Object.values(combinations).forEach(combo => {
                        const stats = calculateStats(combo.data);
                        vslVoyArray.push({
                            etd: combo.etd,
                            etdKey: combo.etdKey,
                            expLine: combo.expLine,
                            vslVoy: combo.vslVoy,
                            trade: combo.trade,
                            stats: stats,
                            data: combo.data
                        });
                    });
                });

                // 模式3默认按ETD升序（没有ETD的放在最上面）
                if (!sortState.mode3.column) {
                    sortState.mode3.column = 'etd';
                    sortState.mode3.direction = 'asc';
                }

                // 应用排序（ETD特殊处理）
                if (sortState.mode3.column) {
                    vslVoyArray = applyEtdSorting(vslVoyArray, sortState.mode3);
                } else {
                    // 默认排序：没有ETD的放在最上面，有ETD的按ETD升序
                    vslVoyArray.sort((a, b) => {
                        if (!a.etd && b.etd) return -1;
                        if (a.etd && !b.etd) return 1;
                        if (!a.etd && !b.etd) {
                            const vslCompare = (a.vslVoy || '').localeCompare(b.vslVoy || '');
                            if (vslCompare !== 0) return vslCompare;
                            return (a.trade || '').localeCompare(b.trade || '');
                        }
                        const etdCompare = new Date(a.etd) - new Date(b.etd);
                        if (etdCompare !== 0) return etdCompare;
                        const vslCompare = (a.vslVoy || '').localeCompare(b.vslVoy || '');
                        if (vslCompare !== 0) return vslCompare;
                        return (a.trade || '').localeCompare(b.trade || '');
                    });
                }

                // 生成表格
                let tableHTML = `
                    <div class="detail-table-container" style="${CONFIG.STYLES.TABLE_CONTAINER}">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: ${CONFIG.COLORS.PRIMARY}; color: ${CONFIG.COLORS.BORDER_WHITE}; border-bottom: 2px solid ${CONFIG.COLORS.BORDER_WHITE};">
                                ${createSortableHeader('ETD', 'etd', 3)}
                                ${createSortableHeader('EXP LINE', 'expLine', 3)}
                                ${createSortableHeader('VSL/VOY', 'vslVoy', 3)}
                                ${createSortableHeader('Trade', 'trade', 3)}
                                ${createSortableHeader('总量', 'total-bl', 3)}
                                ${createSortableHeader('A/C/F/L', 'aclf-bl', 3)}
                                ${createSortableHeader('A/C/F/L占比', 'aclf-percent', 3)}
                                ${createSortableHeader('N/P', 'np-bl', 3)}
                                ${createSortableHeader('N/P占比', 'np-percent', 3)}
                                ${createSortableHeader('X', 'x-bl', 3)}
                                ${createSortableHeader('X占比', 'x-percent', 3)}
                            </tr>
                        </thead>
                        <tbody>
                `;

                vslVoyArray.forEach((item, index) => {
                    const etdDisplay = item.etd ? formatDate(new Date(item.etd)) : '-';
                    // 使用全局数据存储，避免JSON.stringify在onclick中的问题
                    const dataKey = `detail-vslvoy-${item.vslVoy}-${item.etdKey}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    if (!window.detailModalDataStore) {
                        window.detailModalDataStore = {};
                    }
                    window.detailModalDataStore[dataKey] = item.data;
                    
                    tableHTML += `
                        <tr style="${CONFIG.STYLES.TABLE_ROW_HOVER}" 
                            onmouseover="this.style.backgroundColor='${CONFIG.COLORS.HOVER}'" 
                            onmouseout="this.style.backgroundColor=''"
                            title="点击查看详细记录"
                            data-detail-key="${dataKey}"
                            onclick="window.showDetailModal('${String(item.vslVoy).replace(/'/g, "\\'").replace(/"/g, '&quot;')} - ${etdDisplay.replace(/'/g, "\\'").replace(/"/g, '&quot;')} 详细记录', '${dataKey}')">
                            <td style="${CONFIG.STYLES.TABLE_CELL}">${etdDisplay}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">${item.expLine || '-'}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL} font-weight: 600;">${item.vslVoy}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">${item.trade || '-'}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.total.bl}<br>TEU: ${item.stats.total.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.aclf.bl}<br>TEU: ${item.stats.aclf.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.aclf.blPercent}%<br>TEU: ${item.stats.aclf.teuPercent}%</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.np.bl}<br>TEU: ${item.stats.np.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.np.blPercent}%<br>TEU: ${item.stats.np.teuPercent}%</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.x.bl}<br>TEU: ${item.stats.x.teu.toFixed(2)}</td>
                            <td style="${CONFIG.STYLES.TABLE_CELL}">BL: ${item.stats.x.blPercent}%<br>TEU: ${item.stats.x.teuPercent}%</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                    </div>
                `;

                // 使用分批渲染优化
                const tbodyStart = tableHTML.indexOf('<tbody>') + 7;
                const tbodyEnd = tableHTML.indexOf('</tbody>');
                if (tbodyStart > 6 && tbodyEnd > tbodyStart) {
                    const headerHtml = tableHTML.substring(0, tbodyStart);
                    const rowsHtml = tableHTML.substring(tbodyStart, tbodyEnd);
                    const footerHtml = tableHTML.substring(tbodyEnd);
                    
                    dom.mode3Table.innerHTML = headerHtml + footerHtml;
                    const tbody = dom.mode3Table.querySelector('tbody');
                    if (tbody && rowsHtml) {
                        renderTableRowsBatch(tbody, rowsHtml);
                    } else {
                        dom.mode3Table.innerHTML = tableHTML;
                    }
                } else {
                    dom.mode3Table.innerHTML = tableHTML;
                }

                // 生成图表 - 按VSL/VOY展示
                const chartData = vslVoyArray.map(item => ({
                    label: item.vslVoy,
                    data: item.data
                }));
                generateCharts(chartData, 'mode3Charts', 'VSL/VOY');
            }

            /**
             * 生成图表
             */
            function generateCharts(dataArray, containerId, labelKey) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';

                // 计算总体统计
                const allData = dataArray.flatMap(item => item.data || item);
                const overallStats = calculateStats(allData);

                // 创建图表容器（移除饼图，只保留堆叠柱状图）
                const chartContainer = document.createElement('div');
                chartContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;';

                // 趋势图和对比图
                if (dataArray.length > 0 && dataArray[0].data) {
                    // 趋势图：按时间展示TEU趋势
                    const trendDiv = document.createElement('div');
                    trendDiv.style.cssText = 'grid-column: 1 / -1; position: relative; height: 400px; margin-top: 20px;';
                    const trendCanvas = document.createElement('canvas');
                    trendCanvas.id = `chart-trend-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    trendDiv.appendChild(trendCanvas);
                    chartContainer.appendChild(trendDiv);

                    // 对比图：按分组展示对比
                    const compareDiv = document.createElement('div');
                    compareDiv.style.cssText = 'grid-column: 1 / -1; position: relative; height: 400px; margin-top: 20px;';
                    const compareCanvas = document.createElement('canvas');
                    compareCanvas.id = `chart-compare-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    compareDiv.appendChild(compareCanvas);
                    chartContainer.appendChild(compareDiv);

                    // 生成趋势图数据
                    const timeMap = {};
                    allData.forEach(item => {
                        const date = new Date(item.date);
                        const timeKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        if (!timeMap[timeKey]) {
                            timeMap[timeKey] = { aclf: 0, np: 0, x: 0, total: 0 };
                        }
                        if (['A', 'C', 'F', 'L'].includes(item.status)) {
                            timeMap[timeKey].aclf += item.teu;
                        } else if (['N', 'P'].includes(item.status)) {
                            timeMap[timeKey].np += item.teu;
                        } else if (item.status === 'X') {
                            timeMap[timeKey].x += item.teu;
                        }
                        timeMap[timeKey].total += item.teu;
                    });

                    const timeKeys = Object.keys(timeMap).sort();
                    // 堆叠柱状图数据（按时间）
                    const stackedTrendData = {
                        labels: timeKeys,
                        datasets: [
                            {
                                label: 'A/C/F/L TEU',
                                data: timeKeys.map(k => timeMap[k].aclf),
                                backgroundColor: '#0071e3'
                            },
                            {
                                label: 'N/P TEU',
                                data: timeKeys.map(k => timeMap[k].np),
                                backgroundColor: '#28a745'
                            },
                            {
                                label: 'X TEU',
                                data: timeKeys.map(k => timeMap[k].x),
                                backgroundColor: '#dc3545'
                            }
                        ]
                    };

                    // 生成堆叠柱状图数据（按分组）
                    const compareLabels = dataArray.map(item => item.label || '未命名');
                    const stackedCompareData = {
                        labels: compareLabels,
                        datasets: [
                            {
                                label: 'A/C/F/L TEU',
                                data: dataArray.map(item => {
                                    const stats = calculateStats(item.data);
                                    return stats.aclf.teu;
                                }),
                                backgroundColor: '#0071e3'
                            },
                            {
                                label: 'N/P TEU',
                                data: dataArray.map(item => {
                                    const stats = calculateStats(item.data);
                                    return stats.np.teu;
                                }),
                                backgroundColor: '#28a745'
                            },
                            {
                                label: 'X TEU',
                                data: dataArray.map(item => {
                                    const stats = calculateStats(item.data);
                                    return stats.x.teu;
                                }),
                                backgroundColor: '#dc3545'
                            }
                        ]
                    };

                    // 创建堆叠柱状图（按时间）
                    if (typeof Chart !== 'undefined') {
                        new Chart(trendCanvas, {
                            type: 'bar',
                            data: stackedTrendData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'TEU堆叠柱状图（按时间）',
                                        font: { size: 16, weight: 'bold' }
                                    },
                                    legend: {
                                        position: 'top',
                                        onClick: function(e, legendItem) {
                                            const index = legendItem.datasetIndex;
                                            const chart = this.chart;
                                            const meta = chart.getDatasetMeta(index);
                                            meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                                            chart.update();
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' TEU';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        stacked: true
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        // 创建堆叠柱状图（按分组）
                        const stackedCompareData = {
                            labels: compareLabels,
                            datasets: [
                                {
                                    label: 'A/C/F/L TEU',
                                    data: dataArray.map(item => {
                                        const stats = calculateStats(item.data);
                                        return stats.aclf.teu;
                                    }),
                                    backgroundColor: '#0071e3'
                                },
                                {
                                    label: 'N/P TEU',
                                    data: dataArray.map(item => {
                                        const stats = calculateStats(item.data);
                                        return stats.np.teu;
                                    }),
                                    backgroundColor: '#28a745'
                                },
                                {
                                    label: 'X TEU',
                                    data: dataArray.map(item => {
                                        const stats = calculateStats(item.data);
                                        return stats.x.teu;
                                    }),
                                    backgroundColor: '#dc3545'
                                }
                            ]
                        };

                        new Chart(compareCanvas, {
                            type: 'bar',
                            data: stackedCompareData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${labelKey}堆叠柱状图（TEU）`,
                                        font: { size: 16, weight: 'bold' }
                                    },
                                    legend: {
                                        position: 'top',
                                        onClick: function(e, legendItem) {
                                            const index = legendItem.datasetIndex;
                                            const chart = this.chart;
                                            const meta = chart.getDatasetMeta(index);
                                            meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                                            chart.update();
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' TEU';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        stacked: true
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }

                container.appendChild(chartContainer);
            }

            // 事件监听
            dom.excelFile.addEventListener('change', handleFileUpload);

            // 筛选器搜索
            if (typeof window.setupFilterSearch === 'function') {
                window.setupFilterSearch(dom.bkgPartySearch, dom.bkgPartyFilter);
                window.setupFilterSearch(dom.podSearch, dom.podFilter);
                window.setupFilterSearch(dom.ftbSearch, dom.ftbFilter);
                window.setupFilterSearch(dom.tradeSearch, dom.tradeFilter);
            } else {
                // 降级方案
                [dom.bkgPartySearch, dom.podSearch, dom.ftbSearch, dom.tradeSearch].forEach((search, index) => {
                    const selects = [dom.bkgPartyFilter, dom.podFilter, dom.ftbFilter, dom.tradeFilter];
                    search.addEventListener('input', (e) => {
                        const value = e.target.value.toLowerCase();
                        const select = selects[index];
                        Array.from(select.options).forEach(option => {
                            option.style.display = option.value === '' || option.text.toLowerCase().includes(value) ? '' : 'none';
                        });
                    });
                });
            }

            // 筛选器变化监听
            [dom.bkgPartyFilter, dom.podFilter, dom.ftbFilter, dom.tradeFilter].forEach(select => {
                select.addEventListener('change', applyFilters);
            });

            // 筛选器按钮
            document.querySelectorAll('[data-filter][data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    const action = e.target.dataset.action;
                    const selectMap = {
                        bkgParty: dom.bkgPartyFilter,
                        pod: dom.podFilter,
                        ftb: dom.ftbFilter,
                        trade: dom.tradeFilter
                    };
                    const select = selectMap[filter];
                    if (action === 'select-all') {
                        Array.from(select.options).forEach(opt => opt.selected = true);
                    } else if (action === 'clear-all') {
                        Array.from(select.options).forEach(opt => opt.selected = false);
                    }
                    applyFilters();
                });
            });

            // 模式切换
            dom.mode1Btn.addEventListener('click', () => {
                state.currentMode = 1;
                dom.mode1Btn.classList.add('active');
                dom.mode2Btn.classList.remove('active');
                dom.mode3Btn.classList.remove('active');
                dom.mode1Content.style.display = 'block';
                dom.mode2Content.style.display = 'none';
                dom.mode3Content.style.display = 'none';
                updateMode1();
            });

            dom.mode2Btn.addEventListener('click', () => {
                state.currentMode = 2;
                dom.mode2Btn.classList.add('active');
                dom.mode1Btn.classList.remove('active');
                dom.mode3Btn.classList.remove('active');
                dom.mode1Content.style.display = 'none';
                dom.mode2Content.style.display = 'block';
                dom.mode3Content.style.display = 'none';
                updateMode2();
            });

            dom.mode3Btn.addEventListener('click', () => {
                state.currentMode = 3;
                dom.mode3Btn.classList.add('active');
                dom.mode1Btn.classList.remove('active');
                dom.mode2Btn.classList.remove('active');
                dom.mode1Content.style.display = 'none';
                dom.mode2Content.style.display = 'none';
                dom.mode3Content.style.display = 'block';
                updateMode3();
            });

            // 日期范围快捷按钮
            dom.resetDateRange1Week.addEventListener('click', () => {
                const { start, end } = getLastNWeeksRange(1);
                setDateRange(start, end);
            });

            dom.resetDateRange1Month.addEventListener('click', () => {
                const { start, end } = getLastNMonthsRange(1);
                setDateRange(start, end);
            });

            dom.resetDateRange3Months.addEventListener('click', () => {
                const { start, end } = getLastNMonthsRange(3);
                setDateRange(start, end);
            });

            // 日期范围变化监听
            dom.startDate.addEventListener('change', applyFilters);
            dom.endDate.addEventListener('change', applyFilters);

            /**
             * 导出Excel
             */
            async function exportToExcel() {
                if (!state.filteredData || state.filteredData.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }

                if (typeof XLSX === 'undefined') {
                    alert('XLSX 库未加载，请刷新页面重试');
                    return;
                }

                try {
                    const workbook = XLSX.utils.book_new();
                    
                    // 根据当前模式生成不同的工作表
                    if (state.currentMode === 1) {
                        // 模式1：Trade维度数据
                        const tradeMap = {};
                        state.filteredData.forEach(item => {
                            const trade = item.trade || '未分类';
                            if (!tradeMap[trade]) {
                                tradeMap[trade] = [];
                            }
                            tradeMap[trade].push(item);
                        });

                        const tradeTimeGroups = [];
                        Object.entries(tradeMap).forEach(([trade, data]) => {
                            const timeMap = {};
                            data.forEach(item => {
                                const date = new Date(item.date);
                                const timeKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                if (!timeMap[timeKey]) {
                                    timeMap[timeKey] = [];
                                }
                                timeMap[timeKey].push(item);
                            });

                            Object.entries(timeMap).forEach(([time, items]) => {
                                const stats = calculateStats(items);
                                tradeTimeGroups.push({
                                    'Trade': trade,
                                    '时间': time,
                                    '总量-BL': stats.total.bl,
                                    '总量-TEU': stats.total.teu.toFixed(2),
                                    'A/C/F/L-BL': stats.aclf.bl,
                                    'A/C/F/L-TEU': stats.aclf.teu.toFixed(2),
                                    'A/C/F/L占比-BL%': stats.aclf.blPercent + '%',
                                    'A/C/F/L占比-TEU%': stats.aclf.teuPercent + '%',
                                    'N/P-BL': stats.np.bl,
                                    'N/P-TEU': stats.np.teu.toFixed(2),
                                    'N/P占比-BL%': stats.np.blPercent + '%',
                                    'N/P占比-TEU%': stats.np.teuPercent + '%',
                                    'X-BL': stats.x.bl,
                                    'X-TEU': stats.x.teu.toFixed(2),
                                    'X占比-BL%': stats.x.blPercent + '%',
                                    'X占比-TEU%': stats.x.teuPercent + '%'
                                });
                            });
                        });

                        const ws = XLSX.utils.json_to_sheet(tradeTimeGroups);
                        XLSX.utils.book_append_sheet(workbook, ws, 'Trade维度统计');
                    } else if (state.currentMode === 2) {
                        // 模式2：Account维度数据
                        const partyMap = {};
                        state.filteredData.forEach(item => {
                            const party = item.bkgParty || '未分类';
                            if (!partyMap[party]) {
                                partyMap[party] = [];
                            }
                            partyMap[party].push(item);
                        });

                        const partyArray = Object.entries(partyMap).map(([party, data]) => {
                            const stats = calculateStats(data);
                            return {
                                'BKG Party': party,
                                '总量-BL': stats.total.bl,
                                '总量-TEU': stats.total.teu.toFixed(2),
                                'A/C/F/L-BL': stats.aclf.bl,
                                'A/C/F/L-TEU': stats.aclf.teu.toFixed(2),
                                'A/C/F/L占比-BL%': stats.aclf.blPercent + '%',
                                'A/C/F/L占比-TEU%': stats.aclf.teuPercent + '%',
                                'N/P-BL': stats.np.bl,
                                'N/P-TEU': stats.np.teu.toFixed(2),
                                'N/P占比-BL%': stats.np.blPercent + '%',
                                'N/P占比-TEU%': stats.np.teuPercent + '%',
                                'X-BL': stats.x.bl,
                                'X-TEU': stats.x.teu.toFixed(2),
                                'X占比-BL%': stats.x.blPercent + '%',
                                'X占比-TEU%': stats.x.teuPercent + '%'
                            };
                        });

                        const ws = XLSX.utils.json_to_sheet(partyArray);
                        XLSX.utils.book_append_sheet(workbook, ws, 'Account维度统计');
                    } else if (state.currentMode === 3) {
                        // 模式3：VSL/VOY维度数据
                        const vslVoyMap = {};
                        state.filteredData.forEach(item => {
                            const vslVoy = `${item.vesselName || ''} ${item.voyage || ''}`.trim() || '未分类';
                            if (!vslVoyMap[vslVoy]) {
                                vslVoyMap[vslVoy] = [];
                            }
                            vslVoyMap[vslVoy].push(item);
                        });

                        const vslVoyArray = [];
                        Object.entries(vslVoyMap).forEach(([vslVoy, data]) => {
                            const combinations = {};
                            data.forEach(item => {
                                const etdKey = item.etd ? formatDate(new Date(item.etd)) : '';
                                const expLine = item.expLine || '';
                                const trade = item.trade || '';
                                const key = `${etdKey}|${expLine}|${vslVoy}|${trade}`;
                                
                                if (!combinations[key]) {
                                    combinations[key] = {
                                        etd: item.etd,
                                        etdKey: etdKey,
                                        expLine: expLine,
                                        vslVoy: vslVoy,
                                        trade: trade,
                                        data: []
                                    };
                                }
                                combinations[key].data.push(item);
                            });

                            Object.values(combinations).forEach(combo => {
                                const stats = calculateStats(combo.data);
                                vslVoyArray.push({
                                    'ETD': combo.etdKey || '-',
                                    'EXP LINE': combo.expLine || '-',
                                    'VSL/VOY': combo.vslVoy,
                                    'Trade': combo.trade || '-',
                                    '总量-BL': stats.total.bl,
                                    '总量-TEU': stats.total.teu.toFixed(2),
                                    'A/C/F/L-BL': stats.aclf.bl,
                                    'A/C/F/L-TEU': stats.aclf.teu.toFixed(2),
                                    'A/C/F/L占比-BL%': stats.aclf.blPercent + '%',
                                    'A/C/F/L占比-TEU%': stats.aclf.teuPercent + '%',
                                    'N/P-BL': stats.np.bl,
                                    'N/P-TEU': stats.np.teu.toFixed(2),
                                    'N/P占比-BL%': stats.np.blPercent + '%',
                                    'N/P占比-TEU%': stats.np.teuPercent + '%',
                                    'X-BL': stats.x.bl,
                                    'X-TEU': stats.x.teu.toFixed(2),
                                    'X占比-BL%': stats.x.blPercent + '%',
                                    'X占比-TEU%': stats.x.teuPercent + '%'
                                });
                            });
                        });

                        // 排序：没有ETD的放在最上面，有ETD的按ETD升序
                        vslVoyArray.sort((a, b) => {
                            if (a['ETD'] === '-' && b['ETD'] !== '-') return -1;
                            if (a['ETD'] !== '-' && b['ETD'] === '-') return 1;
                            if (a['ETD'] === '-' && b['ETD'] === '-') {
                                const vslCompare = a['VSL/VOY'].localeCompare(b['VSL/VOY']);
                                if (vslCompare !== 0) return vslCompare;
                                return a['Trade'].localeCompare(b['Trade']);
                            }
                            return a['ETD'].localeCompare(b['ETD']);
                        });

                        const ws = XLSX.utils.json_to_sheet(vslVoyArray);
                        XLSX.utils.book_append_sheet(workbook, ws, 'VSL_VOY维度统计');
                    }

                    // 导出文件
                    const now = new Date();
                    const modeNames = { 1: 'Trade维度', 2: 'Account维度', 3: 'VSL/VOY维度' };
                    const fileName = `订舱监控_${modeNames[state.currentMode]}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                } catch (error) {
                    console.error('导出Excel失败:', error);
                    alert('导出Excel失败: ' + (error.message || String(error)));
                }
            }

            /**
             * 导出PDF
             */
            async function exportToPdf() {
                if (!state.filteredData || state.filteredData.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }

                try {
                    // 等待图表渲染完成
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    if (typeof window.exportToPdfCommon === 'function') {
                        const now = new Date();
                        const modeNames = { 1: 'Trade维度', 2: 'Account维度', 3: 'VSL/VOY维度' };
                        const fileName = `订舱监控_${modeNames[state.currentMode]}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                        const targetElement = state.currentMode === 1 ? dom.mode1Content : (state.currentMode === 2 ? dom.mode2Content : dom.mode3Content);
                        
                        // 收集所有图表canvas元素的ID
                        const chartCanvasIds = [];
                        const chartsContainer = state.currentMode === 1 ? dom.mode1Charts : (state.currentMode === 2 ? dom.mode2Charts : dom.mode3Charts);
                        if (chartsContainer) {
                            const canvases = chartsContainer.querySelectorAll('canvas');
                            canvases.forEach(canvas => {
                                if (canvas.id) {
                                    chartCanvasIds.push(canvas.id);
                                }
                            });
                        }
                        
                        await window.exportToPdfCommon({
                            fileName,
                            elements: targetElement,
                            chartCanvasIds: chartCanvasIds.length > 0 ? chartCanvasIds : undefined
                        });
                    } else if (typeof window.exportToPdf === 'function') {
                        const targetElement = state.currentMode === 1 ? dom.mode1Content : (state.currentMode === 2 ? dom.mode2Content : dom.mode3Content);
                        const now = new Date();
                        const modeNames = { 1: 'Trade维度', 2: 'Account维度', 3: 'VSL/VOY维度' };
                        const fileName = `订舱监控_${modeNames[state.currentMode]}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                        await window.exportToPdf(targetElement, { fileName });
                    } else {
                        alert('PDF 导出功能所需的工具函数未找到，请刷新页面重试');
                    }
                } catch (error) {
                    console.error('导出PDF失败:', error);
                    alert('导出PDF失败: ' + (error.message || String(error)));
                }
            }

            // 导出按钮事件
            dom.exportExcelBtn.addEventListener('click', exportToExcel);
            dom.exportPdfBtn.addEventListener('click', exportToPdf);

            // 清除筛选按钮
            if (dom.clearFiltersBtn) {
                dom.clearFiltersBtn.addEventListener('click', clearAllFilters);
            }

            // ==================== 中优先级功能实现 ====================

            /**
             * 数据对比功能
             */
            function performCompare() {
                if (!dom.compareStartDate.value || !dom.compareEndDate.value) {
                    alert('请选择对比的开始和结束日期');
                    return;
                }

                const compareStart = new Date(dom.compareStartDate.value);
                const compareEnd = new Date(dom.compareEndDate.value);
                compareEnd.setHours(23, 59, 59, 999);

                // 获取对比时间段的数据
                const compareData = state.rawData.filter(item => {
                    if (state.filters.bkgParty.length > 0 && !state.filters.bkgParty.includes(item.bkgParty)) return false;
                    if (state.filters.pod.length > 0 && !state.filters.pod.includes(item.pod)) return false;
                    if (state.filters.ftb.length > 0 && !state.filters.ftb.includes(item.ftb)) return false;
                    if (state.filters.trade.length > 0 && !state.filters.trade.includes(item.trade)) return false;
                    const itemDate = new Date(item.date);
                    return itemDate >= compareStart && itemDate <= compareEnd;
                });

                const currentStats = calculateStats(state.filteredData);
                const compareStats = calculateStats(compareData);

                // 计算变化
                const changes = {
                    total: {
                        bl: currentStats.total.bl - compareStats.total.bl,
                        blPercent: compareStats.total.bl > 0 ? ((currentStats.total.bl - compareStats.total.bl) / compareStats.total.bl * 100).toFixed(2) : 0,
                        teu: currentStats.total.teu - compareStats.total.teu,
                        teuPercent: compareStats.total.teu > 0 ? ((currentStats.total.teu - compareStats.total.teu) / compareStats.total.teu * 100).toFixed(2) : 0
                    },
                    aclf: {
                        bl: currentStats.aclf.bl - compareStats.aclf.bl,
                        blPercent: compareStats.aclf.bl > 0 ? ((currentStats.aclf.bl - compareStats.aclf.bl) / compareStats.aclf.bl * 100).toFixed(2) : 0,
                        teu: currentStats.aclf.teu - compareStats.aclf.teu,
                        teuPercent: compareStats.aclf.teu > 0 ? ((currentStats.aclf.teu - compareStats.aclf.teu) / compareStats.aclf.teu * 100).toFixed(2) : 0
                    },
                    np: {
                        bl: currentStats.np.bl - compareStats.np.bl,
                        blPercent: compareStats.np.bl > 0 ? ((currentStats.np.bl - compareStats.np.bl) / compareStats.np.bl * 100).toFixed(2) : 0,
                        teu: currentStats.np.teu - compareStats.np.teu,
                        teuPercent: compareStats.np.teu > 0 ? ((currentStats.np.teu - compareStats.np.teu) / compareStats.np.teu * 100).toFixed(2) : 0
                    },
                    x: {
                        bl: currentStats.x.bl - compareStats.x.bl,
                        blPercent: compareStats.x.bl > 0 ? ((currentStats.x.bl - compareStats.x.bl) / compareStats.x.bl * 100).toFixed(2) : 0,
                        teu: currentStats.x.teu - compareStats.x.teu,
                        teuPercent: compareStats.x.teu > 0 ? ((currentStats.x.teu - compareStats.x.teu) / compareStats.x.teu * 100).toFixed(2) : 0
                    }
                };

                // 显示对比结果
                const formatChange = (val, percent) => {
                    const sign = val >= 0 ? '+' : '';
                    const color = val >= 0 ? '#28a745' : '#dc3545';
                    return `<span style="color: ${color}; font-weight: 600;">${sign}${val} (${sign}${percent}%)</span>`;
                };

                dom.compareResults.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">指标</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">当前期间</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">对比期间</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">变化</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">总量 BL</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.total.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.total.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.total.bl, changes.total.blPercent)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">总量 TEU</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.total.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.total.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.total.teu.toFixed(2), changes.total.teuPercent)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">A/C/F/L BL</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.aclf.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.aclf.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.aclf.bl, changes.aclf.blPercent)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">A/C/F/L TEU</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.aclf.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.aclf.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.aclf.teu.toFixed(2), changes.aclf.teuPercent)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">N/P BL</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.np.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.np.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.np.bl, changes.np.blPercent)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">N/P TEU</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.np.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.np.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.np.teu.toFixed(2), changes.np.teuPercent)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">X BL</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.x.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.x.bl}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.x.bl, changes.x.blPercent)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">X TEU</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${currentStats.x.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${compareStats.x.teu.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.x.teu.toFixed(2), changes.x.teuPercent)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }


            /**
             * 应用排名功能
             */
            function applyRanking() {
                if (!dom.rankingCount || !dom.rankingBy) {
                    console.error('排名设置元素未找到');
                    return;
                }
                rankingState.enabled = true;
                const countValue = parseInt(dom.rankingCount.value);
                // 如果选择"全部"（值为0），则不限制数量
                rankingState.count = countValue === 0 ? 0 : (countValue || 10);
                rankingState.by = dom.rankingBy.value || 'total-bl';
                updateAnalysis();
            }

            // 对比和排名按钮事件
            if (dom.toggleCompareBtn) {
                dom.toggleCompareBtn.addEventListener('click', () => {
                    compareState.enabled = !compareState.enabled;
                    dom.comparePanel.style.display = compareState.enabled ? 'block' : 'none';
                    dom.toggleCompareBtn.textContent = compareState.enabled ? '关闭对比' : '数据对比';
                    if (compareState.enabled) {
                        // 设置默认对比日期（当前时间段的前一个相同长度时间段）
                        const { start, end } = getDateRange();
                        if (start && end) {
                            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                            const compareEnd = new Date(start);
                            compareEnd.setDate(compareEnd.getDate() - 1);
                            const compareStart = new Date(compareEnd);
                            compareStart.setDate(compareStart.getDate() - days);
                            dom.compareEndDate.value = formatDate(compareEnd);
                            dom.compareStartDate.value = formatDate(compareStart);
                        }
                    }
                });
            }

            if (dom.applyCompareBtn) {
                dom.applyCompareBtn.addEventListener('click', () => {
                    if (!dom.compareStartDate || !dom.compareEndDate) {
                        alert('请选择对比的开始和结束日期');
                        return;
                    }
                    performCompare();
                });
            }

            if (dom.toggleRankingBtn) {
                dom.toggleRankingBtn.addEventListener('click', () => {
                    rankingState.enabled = !rankingState.enabled;
                    if (dom.rankingPanel) {
                        dom.rankingPanel.style.display = rankingState.enabled ? 'block' : 'none';
                    }
                    if (dom.toggleRankingBtn) {
                        dom.toggleRankingBtn.textContent = rankingState.enabled ? '关闭排名' : '排名视图';
                    }
                    if (rankingState.enabled) {
                        applyRanking();
                    } else {
                        rankingState.enabled = false;
                        updateAnalysis();
                    }
                });
            }

            if (dom.applyRankingBtn) {
                dom.applyRankingBtn.addEventListener('click', () => {
                    if (!dom.rankingCount || !dom.rankingBy) {
                        console.error('排名设置输入框未找到');
                        alert('排名设置元素未找到，请刷新页面重试');
                        return;
                    }
                    applyRanking();
                });
            } else {
                console.warn('applyRankingBtn 未找到，按钮可能尚未加载');
            }

            // 如果按钮未找到，尝试延迟绑定
            if (!dom.toggleCompareBtn || !dom.toggleRankingBtn) {
                console.warn('部分按钮未找到，将在DOM加载后重试');
                setTimeout(() => {
                    // 重新获取DOM元素
                    dom.toggleCompareBtn = document.getElementById('toggleCompareBtn');
                    dom.toggleRankingBtn = document.getElementById('toggleRankingBtn');
                    dom.applyCompareBtn = document.getElementById('applyCompareBtn');
                    dom.applyRankingBtn = document.getElementById('applyRankingBtn');
                    dom.comparePanel = document.getElementById('comparePanel');
                    dom.rankingPanel = document.getElementById('rankingPanel');
                    dom.compareStartDate = document.getElementById('compareStartDate');
                    dom.compareEndDate = document.getElementById('compareEndDate');
                    dom.rankingCount = document.getElementById('rankingCount');
                    dom.rankingBy = document.getElementById('rankingBy');
                    
                    // 重新绑定事件
                    if (dom.toggleCompareBtn) {
                        dom.toggleCompareBtn.addEventListener('click', () => {
                            compareState.enabled = !compareState.enabled;
                            if (dom.comparePanel) {
                                dom.comparePanel.style.display = compareState.enabled ? 'block' : 'none';
                            }
                            if (dom.toggleCompareBtn) {
                                dom.toggleCompareBtn.textContent = compareState.enabled ? '关闭对比' : '数据对比';
                            }
                            if (compareState.enabled && dom.compareStartDate && dom.compareEndDate) {
                                const { start, end } = getDateRange();
                                if (start && end) {
                                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                    const compareEnd = new Date(start);
                                    compareEnd.setDate(compareEnd.getDate() - 1);
                                    const compareStart = new Date(compareEnd);
                                    compareStart.setDate(compareStart.getDate() - days);
                                    dom.compareEndDate.value = formatDate(compareEnd);
                                    dom.compareStartDate.value = formatDate(compareStart);
                                }
                            }
                        });
                    }
                    
                    if (dom.applyCompareBtn) {
                        dom.applyCompareBtn.addEventListener('click', () => {
                            if (!dom.compareStartDate || !dom.compareEndDate) {
                                alert('请选择对比的开始和结束日期');
                                return;
                            }
                            performCompare();
                        });
                    }
                    
                    if (dom.toggleRankingBtn) {
                        dom.toggleRankingBtn.addEventListener('click', () => {
                            rankingState.enabled = !rankingState.enabled;
                            if (dom.rankingPanel) {
                                dom.rankingPanel.style.display = rankingState.enabled ? 'block' : 'none';
                            }
                            if (dom.toggleRankingBtn) {
                                dom.toggleRankingBtn.textContent = rankingState.enabled ? '关闭排名' : '排名视图';
                            }
                            if (rankingState.enabled) {
                                applyRanking();
                            } else {
                                rankingState.enabled = false;
                                updateAnalysis();
                            }
                        });
                    }
                    
                    if (dom.applyRankingBtn) {
                        dom.applyRankingBtn.addEventListener('click', () => {
                            if (!dom.rankingCount || !dom.rankingBy) {
                                alert('排名设置元素未找到，请刷新页面重试');
                                return;
                            }
                            applyRanking();
                        });
                    }
                }, 500);
            }

            // ==================== 筛选预设功能 ====================
            
            /**
             * 获取所有预设
             */
            function getAllPresets() {
                try {
                    const presets = localStorage.getItem('monitor-daily-booking-presets');
                    return presets ? JSON.parse(presets) : [];
                } catch (e) {
                    console.warn('读取预设失败:', e);
                    return [];
                }
            }

            /**
             * 保存预设
             */
            function savePreset(name) {
                if (!name || !name.trim()) {
                    alert('请输入预设名称');
                    return;
                }

                const preset = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    filters: {
                        startDate: dom.startDate.value,
                        endDate: dom.endDate.value,
                        bkgParty: state.filters.bkgParty,
                        pod: state.filters.pod,
                        ftb: state.filters.ftb,
                        trade: state.filters.trade,
                        mode: state.currentMode
                    },
                    timestamp: Date.now()
                };

                const presets = getAllPresets();
                presets.push(preset);
                localStorage.setItem('monitor-daily-booking-presets', JSON.stringify(presets));
                
                if (typeof window.Toast !== 'undefined') {
                    window.Toast.show('预设保存成功', 'success');
                }
                updatePresetsList();
            }

            /**
             * 加载预设
             */
            window.loadPreset = function(presetId) {
                const presets = getAllPresets();
                const preset = presets.find(p => p.id === presetId);
                if (!preset) return;

                if (preset.filters.startDate) dom.startDate.value = preset.filters.startDate;
                if (preset.filters.endDate) dom.endDate.value = preset.filters.endDate;
                
                if (preset.filters.mode === 2) {
                    dom.mode2Btn.click();
                } else if (preset.filters.mode === 3) {
                    dom.mode3Btn.click();
                } else {
                    dom.mode1Btn.click();
                }

                state.filters.bkgParty = preset.filters.bkgParty || [];
                state.filters.pod = preset.filters.pod || [];
                state.filters.ftb = preset.filters.ftb || [];
                state.filters.trade = preset.filters.trade || [];

                applyFilters();
                
                if (typeof window.Toast !== 'undefined') {
                    window.Toast.show(`已加载预设：${preset.name}`, 'success');
                }
            };

            /**
             * 删除预设
             */
            window.deletePreset = function(presetId) {
                if (!confirm('确定要删除这个预设吗？')) return;

                const presets = getAllPresets();
                const filtered = presets.filter(p => p.id !== presetId);
                localStorage.setItem('monitor-daily-booking-presets', JSON.stringify(filtered));
                updatePresetsList();
                
                if (typeof window.Toast !== 'undefined') {
                    window.Toast.show('预设已删除', 'success');
                }
            };

            /**
             * 更新预设列表
             */
            function updatePresetsList() {
                if (!dom.presetsList) return;

                const presets = getAllPresets();
                if (presets.length === 0) {
                    dom.presetsList.innerHTML = '<p style="color: #6c757d; padding: 20px; text-align: center;">暂无预设</p>';
                    return;
                }

                dom.presetsList.innerHTML = presets.map(preset => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div>
                            <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">${preset.name}</div>
                            <div style="font-size: 12px; color: #6c757d;">${new Date(preset.timestamp).toLocaleString('zh-CN')}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" onclick="loadPreset('${preset.id}')" class="filter-btn btn-sweep-blue" style="padding: 6px 12px; font-size: 13px; border-radius: 4px;">应用</button>
                            <button type="button" onclick="deletePreset('${preset.id}')" class="filter-btn" style="padding: 6px 12px; font-size: 13px; border-radius: 4px; background: #dc3545; color: white; border: none;">删除</button>
                        </div>
                    </div>
                `).join('');
            }

            // ==================== 数据刷新功能 ====================
            
            /**
             * 刷新数据
             */
            async function refreshData() {
                if (!currentFile) {
                    alert('没有可刷新的文件，请先上传Excel文件');
                    return;
                }

                const currentFilters = {
                    startDate: dom.startDate.value,
                    endDate: dom.endDate.value,
                    bkgParty: state.filters.bkgParty,
                    pod: state.filters.pod,
                    ftb: state.filters.ftb,
                    trade: state.filters.trade,
                    mode: state.currentMode
                };

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(currentFile);
                dom.excelFile.files = dataTransfer.files;
                
                const event = new Event('change', { bubbles: true });
                dom.excelFile.dispatchEvent(event);

                setTimeout(() => {
                    if (currentFilters.startDate) dom.startDate.value = currentFilters.startDate;
                    if (currentFilters.endDate) dom.endDate.value = currentFilters.endDate;
                    
                    if (currentFilters.mode === 2) {
                        dom.mode2Btn.click();
                    } else if (currentFilters.mode === 3) {
                        dom.mode3Btn.click();
                    } else {
                        dom.mode1Btn.click();
                    }

                    state.filters.bkgParty = currentFilters.bkgParty || [];
                    state.filters.pod = currentFilters.pod || [];
                    state.filters.ftb = currentFilters.ftb || [];
                    state.filters.trade = currentFilters.trade || [];

                    applyFilters();
                    
                    if (typeof window.Toast !== 'undefined') {
                        window.Toast.show('数据已刷新', 'success');
                    }
                }, 500);
            }

            // ==================== 数据快照功能 ====================
            
            /**
             * 获取所有快照
             */
            function getAllSnapshots() {
                try {
                    const snapshots = localStorage.getItem('monitor-daily-booking-snapshots');
                    return snapshots ? JSON.parse(snapshots) : [];
                } catch (e) {
                    console.warn('读取快照失败:', e);
                    return [];
                }
            }

            /**
             * 保存快照
             */
            function saveSnapshot(name) {
                if (!name || !name.trim()) {
                    alert('请输入快照名称');
                    return;
                }

                if (!state.filteredData || state.filteredData.length === 0) {
                    alert('没有可保存的数据');
                    return;
                }

                const stats = calculateStats(state.filteredData);
                const snapshot = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    timestamp: Date.now(),
                    data: {
                        total: stats.total,
                        aclf: stats.aclf,
                        np: stats.np,
                        x: stats.x
                    },
                    filters: {
                        startDate: dom.startDate.value,
                        endDate: dom.endDate.value,
                        bkgParty: state.filters.bkgParty,
                        pod: state.filters.pod,
                        ftb: state.filters.ftb,
                        trade: state.filters.trade,
                        mode: state.currentMode
                    },
                    recordCount: state.filteredData.length
                };

                const snapshots = getAllSnapshots();
                snapshots.push(snapshot);
                if (snapshots.length > 20) {
                    snapshots.shift();
                }
                localStorage.setItem('monitor-daily-booking-snapshots', JSON.stringify(snapshots));
                
                if (typeof window.Toast !== 'undefined') {
                    window.Toast.show('快照保存成功', 'success');
                }
                updateSnapshotsList();
            }

            /**
             * 删除快照
             */
            window.deleteSnapshot = function(snapshotId) {
                if (!confirm('确定要删除这个快照吗？')) return;

                const snapshots = getAllSnapshots();
                const filtered = snapshots.filter(s => s.id !== snapshotId);
                localStorage.setItem('monitor-daily-booking-snapshots', JSON.stringify(filtered));
                updateSnapshotsList();
                
                if (typeof window.Toast !== 'undefined') {
                    window.Toast.show('快照已删除', 'success');
                }
            };

            /**
             * 对比快照
             */
            window.compareSnapshots = function(snapshotId1, snapshotId2) {
                const snapshots = getAllSnapshots();
                const snap1 = snapshots.find(s => s.id === snapshotId1);
                const snap2 = snapshots.find(s => s.id === snapshotId2);
                
                if (!snap1 || !snap2) {
                    alert('快照不存在');
                    return;
                }

                const formatChange = (val, percent) => {
                    const sign = val >= 0 ? '+' : '';
                    const color = val >= 0 ? '#28a745' : '#dc3545';
                    return `<span style="color: ${color}; font-weight: 600;">${sign}${val} (${sign}${percent}%)</span>`;
                };

                const changes = {
                    total: {
                        bl: snap2.data.total.bl - snap1.data.total.bl,
                        blPercent: snap1.data.total.bl > 0 ? ((snap2.data.total.bl - snap1.data.total.bl) / snap1.data.total.bl * 100).toFixed(2) : 0,
                        teu: snap2.data.total.teu - snap1.data.total.teu,
                        teuPercent: snap1.data.total.teu > 0 ? ((snap2.data.total.teu - snap1.data.total.teu) / snap1.data.total.teu * 100).toFixed(2) : 0
                    },
                    aclf: {
                        bl: snap2.data.aclf.bl - snap1.data.aclf.bl,
                        blPercent: snap1.data.aclf.bl > 0 ? ((snap2.data.aclf.bl - snap1.data.aclf.bl) / snap1.data.aclf.bl * 100).toFixed(2) : 0,
                        teu: snap2.data.aclf.teu - snap1.data.aclf.teu,
                        teuPercent: snap1.data.aclf.teu > 0 ? ((snap2.data.aclf.teu - snap1.data.aclf.teu) / snap1.data.aclf.teu * 100).toFixed(2) : 0
                    },
                    np: {
                        bl: snap2.data.np.bl - snap1.data.np.bl,
                        blPercent: snap1.data.np.bl > 0 ? ((snap2.data.np.bl - snap1.data.np.bl) / snap1.data.np.bl * 100).toFixed(2) : 0,
                        teu: snap2.data.np.teu - snap1.data.np.teu,
                        teuPercent: snap1.data.np.teu > 0 ? ((snap2.data.np.teu - snap1.data.np.teu) / snap1.data.np.teu * 100).toFixed(2) : 0
                    },
                    x: {
                        bl: snap2.data.x.bl - snap1.data.x.bl,
                        blPercent: snap1.data.x.bl > 0 ? ((snap2.data.x.bl - snap1.data.x.bl) / snap1.data.x.bl * 100).toFixed(2) : 0,
                        teu: snap2.data.x.teu - snap1.data.x.teu,
                        teuPercent: snap1.data.x.teu > 0 ? ((snap2.data.x.teu - snap1.data.x.teu) / snap1.data.x.teu * 100).toFixed(2) : 0
                    }
                };

                const compareHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h5 style="margin-bottom: 15px; color: #495057;">快照对比：${snap1.name} vs ${snap2.name}</h5>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">指标</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.name}</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.name}</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">变化</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">总量 BL</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.total.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.total.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.total.bl, changes.total.blPercent)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">总量 TEU</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.total.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.total.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.total.teu.toFixed(2), changes.total.teuPercent)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">A/C/F/L BL</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.aclf.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.aclf.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.aclf.bl, changes.aclf.blPercent)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">A/C/F/L TEU</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.aclf.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.aclf.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.aclf.teu.toFixed(2), changes.aclf.teuPercent)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">N/P BL</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.np.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.np.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.np.bl, changes.np.blPercent)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">N/P TEU</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.np.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.np.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.np.teu.toFixed(2), changes.np.teuPercent)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">X BL</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.x.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.x.bl}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.x.bl, changes.x.blPercent)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">X TEU</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap1.data.x.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${snap2.data.x.teu.toFixed(2)}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">${formatChange(changes.x.teu.toFixed(2), changes.x.teuPercent)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;

                if (dom.compareResults) {
                    dom.compareResults.innerHTML = compareHTML;
                } else {
                    alert('对比结果区域未找到');
                }
            };

            /**
             * 更新快照列表
             */
            function updateSnapshotsList() {
                if (!dom.snapshotsList) return;

                const snapshots = getAllSnapshots();
                if (snapshots.length === 0) {
                    dom.snapshotsList.innerHTML = '<p style="color: #6c757d; padding: 20px; text-align: center;">暂无快照</p>';
                    return;
                }

                dom.snapshotsList.innerHTML = snapshots.map((snapshot, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">${snapshot.name}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">
                                ${new Date(snapshot.timestamp).toLocaleString('zh-CN')} | 
                                记录数: ${snapshot.recordCount} | 
                                总BL: ${snapshot.data.total.bl} | 
                                总TEU: ${snapshot.data.total.teu.toFixed(2)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${index > 0 ? `<button type="button" onclick="compareSnapshots('${snapshots[index-1].id}', '${snapshot.id}')" class="filter-btn btn-sweep-blue" style="padding: 6px 12px; font-size: 13px; border-radius: 4px;">与上一个对比</button>` : ''}
                            <button type="button" onclick="deleteSnapshot('${snapshot.id}')" class="filter-btn" style="padding: 6px 12px; font-size: 13px; border-radius: 4px; background: #dc3545; color: white; border: none;">删除</button>
                        </div>
                    </div>
                `).join('');
            }

            // ==================== 事件绑定 ====================
            
            if (dom.saveFilterPresetBtn) {
                dom.saveFilterPresetBtn.addEventListener('click', () => {
                    const name = prompt('请输入预设名称：');
                    if (name) savePreset(name);
                });
            }

            if (dom.managePresetsBtn) {
                dom.managePresetsBtn.addEventListener('click', () => {
                    updatePresetsList();
                    if (dom.presetsPanel) {
                        dom.presetsPanel.style.display = dom.presetsPanel.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            if (dom.closePresetsPanelBtn) {
                dom.closePresetsPanelBtn.addEventListener('click', () => {
                    if (dom.presetsPanel) dom.presetsPanel.style.display = 'none';
                });
            }

            if (dom.refreshDataBtn) {
                dom.refreshDataBtn.addEventListener('click', refreshData);
            }

            if (dom.saveSnapshotBtn) {
                dom.saveSnapshotBtn.addEventListener('click', () => {
                    const name = prompt('请输入快照名称：');
                    if (name) saveSnapshot(name);
                });
            }

            if (dom.manageSnapshotsBtn) {
                dom.manageSnapshotsBtn.addEventListener('click', () => {
                    updateSnapshotsList();
                    if (dom.snapshotsPanel) {
                        dom.snapshotsPanel.style.display = dom.snapshotsPanel.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            if (dom.closeSnapshotsPanelBtn) {
                dom.closeSnapshotsPanelBtn.addEventListener('click', () => {
                    if (dom.snapshotsPanel) dom.snapshotsPanel.style.display = 'none';
                });
            }

            // 数据加载后显示按钮
            const originalUpdateStatus = window.updateStatus || function() {};
            window.updateStatus = function(text, count) {
                originalUpdateStatus(text, count);
                if (dom.refreshDataBtn) dom.refreshDataBtn.style.display = 'inline-block';
                if (dom.saveSnapshotBtn) dom.saveSnapshotBtn.style.display = 'inline-block';
                if (dom.manageSnapshotsBtn) dom.manageSnapshotsBtn.style.display = 'inline-block';
            };

        })();
    </script>
</body>
</html>

