<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor Â· SCFI å†å²è¶‹åŠ¿</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/monitor-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/date-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <style>
      /* é¡µé¢ç‰¹å®šæ ·å¼ï¼ˆä¿ç•™ä¸å…¬å…±æ ·å¼ä¸åŒçš„éƒ¨åˆ†ï¼‰ */

      .upload-area {
        display: flex;
        gap: 20px;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        border: 2px dashed rgba(102, 126, 234, 0.3);
      }

      .file-btn {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .file-btn:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .file-btn input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .status-info {
        color: #6c757d;
        font-size: 14px;
      }

      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .legend-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      
    </style>
  </head>
  <body data-page="Monitor-SCFI-Trends.html">
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <h2>ğŸ” è®¿é—®éªŒè¯</h2>
        <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
        <form id="authForm">
          <div class="auth-form-group">
            <label for="userName">å§“å *</label>
            <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
            <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
          </div>
          <div class="auth-form-group">
            <label for="userPhone">æ‰‹æœºå· *</label>
            <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
            <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
          </div>
          <div class="auth-form-group">
            <label for="userEmail">é‚®ç®± *</label>
            <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
            <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
          </div>
          <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
        </form>
      </div>
    </div>
    <div class="container">
      <div class="header">
        <a href="index.html?tab=monitor" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
        <a href="Monitor-SCFI-Trends-README.html" class="readme-btn">ä½¿ç”¨è¯´æ˜ â†’</a>
        <h1>Monitor Â· SCFI å†å²è¶‹åŠ¿</h1>
        <p>è¯»å– SCFI æ–‡ä»¶ï¼Œå±•ç¤º B åˆ—åˆ° Q åˆ—çš„ç»¼åˆæŒ‡æ•°åŠåˆ† trade æŒ‡æ•°è¶‹åŠ¿ï¼ˆé»˜è®¤æœ€è¿‘3å¹´ï¼‰</p>
      </div>

      <div class="content">
        <section class="panel">
          <div class="upload-area">
            <label class="file-btn">
              é€‰æ‹© SCFI.xlsx æ–‡ä»¶
              <input id="fileInput" type="file" accept=".xlsx,.xls">
            </label>
            <span class="status-info" id="statusInfo">è¯·é€‰æ‹© SCFI æ–‡ä»¶</span>
          </div>
        </section>

        <section class="panel hidden" id="chartSection">
          <div class="controls">
            <div class="control-group">
              <label>å¼€å§‹æ—¥æœŸï¼š</label>
              <input type="date" id="startDate">
            </div>
            <div class="control-group">
              <label>ç»“æŸæ—¥æœŸï¼š</label>
              <input type="date" id="endDate">
            </div>
          </div>
          <div class="chart-container">
            <h3 style="margin-bottom: 20px; color: #495057;">SCFI å†å²è¶‹åŠ¿å›¾</h3>
            <div class="chart-wrapper">
              <canvas id="trendChart"></canvas>
            </div>
            <div class="legend-container" id="legendContainer"></div>
          </div>
        </section>

        <section class="panel hidden" id="comparisonSection">
          <h3 style="margin-bottom: 20px; color: #495057;">æŒ‡æ•°å¯¹æ¯”åˆ†æ</h3>
          <div class="controls" style="margin-bottom: 20px;">
            <div class="control-group">
              <label>é€‰æ‹©å¯¹æ¯”æ—¥æœŸï¼š</label>
              <input type="date" id="comparisonDate">
            </div>
          </div>
          <div class="table-container" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); overflow-x: auto;">
            <table id="comparisonTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">æŒ‡æ•°åç§°</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">é€‰å®šæ—¥æœŸ</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">1å‘¨å‰</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">1ä¸ªæœˆå‰<br>(4å‘¨å‰)</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">3ä¸ªæœˆå‰<br>(12å‘¨å‰)</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">1å¹´å‰<br>(52å‘¨å‰)</th>
                </tr>
              </thead>
              <tbody id="comparisonTableBody">
                <tr>
                  <td colspan="6" style="padding: 40px; text-align: center; color: #6c757d;">
                    è¯·é€‰æ‹©å¯¹æ¯”æ—¥æœŸä»¥æŸ¥çœ‹æŒ‡æ•°å¯¹æ¯”
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <div class="page-footer">
      <h2>Monitor Â· SCFI å†å²è¶‹åŠ¿ä½¿ç”¨å£°æ˜</h2>
      <p>èµ„æ–™æ•´åˆè‡ª SCFI æ•°æ®æ–‡ä»¶ï¼Œè§£æç»“æœä»…ä¾›å†…éƒ¨ç ”åˆ¤ï¼Œä¸æ„æˆå¯¹å¤–æŠ¥ä»·æˆ–æŠ•èµ„å»ºè®®ã€‚</p>
      <p>æ‰€æœ‰æ•°æ®ä»…åœ¨æœ¬åœ°æµè§ˆå™¨è§£æï¼Œä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</p>
    </div>

    <!-- ä½¿ç”¨ Gist å­˜å‚¨ç³»ç»Ÿï¼ˆç”¨æˆ·ç™½åå• + è®¿é—®è®°å½•ï¼‰ -->
    <script src="vendor/auth-gist.js"></script>
    <script>

      // ==================== è°ƒè¯•æ¨¡å¼ ====================
      // è°ƒè¯•å‡½æ•°å·²ç»Ÿä¸€åˆ° vendor/debug-utils.js
      // ä½¿ç”¨ï¼šdebugLog(), debugWarn(), debugError()

      // ==================== é”™è¯¯å¤„ç† ====================
      
      // ==================== é”™è¯¯å¤„ç† ====================
      // é”™è¯¯å¤„ç†å·²ç»Ÿä¸€åˆ° vendor/error-handler.js
      // ä½¿ç”¨ï¼šshowError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED')
      // ErrorType å’Œ showError å‡½æ•°å·²ä» error-handler.js åŠ è½½
      
      // æ·»åŠ è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
      if (typeof addErrorMessage !== 'undefined') {
          addErrorMessage(ErrorType.DATA_VALIDATION, 'NO_DATA_IN_RANGE', 'æ‰€é€‰æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰æ•°æ®');
      }

      let scfiChart = null;
      let scfiData = [];
      let columnNames = [];

      const fileInput = document.getElementById('fileInput');
      const statusInfo = document.getElementById('statusInfo');
      const chartSection = document.getElementById('chartSection');
      const comparisonSection = document.getElementById('comparisonSection');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      const comparisonDate = document.getElementById('comparisonDate');
      const legendContainer = document.getElementById('legendContainer');
      const comparisonTableBody = document.getElementById('comparisonTableBody');

      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (typeof XLSX === 'undefined') {
          showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
          return;
        }

        try {
          statusInfo.textContent = 'æ­£åœ¨è¯»å–æ–‡ä»¶...';
          const data = await readExcelFile(file);
          
          if (!data.length) {
            showError(ErrorType.FILE_LOAD, 'FILE_EMPTY');
            return;
          }

          scfiData = data;
          processData();
          statusInfo.textContent = `å·²åŠ è½½ ${data.length} æ¡æ•°æ®`;
          chartSection.classList.remove('hidden');
          comparisonSection.classList.remove('hidden');
          
          // è®¾ç½®å¯¹æ¯”æ—¥æœŸé»˜è®¤ä¸ºæœ€æ–°æ—¥æœŸ
          if (scfiData.length > 0) {
            const latestDate = scfiData[scfiData.length - 1].date;
            comparisonDate.value = formatDateForInput(latestDate);
            comparisonDate.max = formatDateForInput(latestDate);
            comparisonDate.min = formatDateForInput(scfiData[0].date);
            updateComparisonTable();
          }
        } catch (error) {
          showError(ErrorType.FILE_LOAD, 'FILE_READ_FAILED', { message: error.message }, error);
          debugError('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
          statusInfo.textContent = 'æ–‡ä»¶è¯»å–å¤±è´¥';
        }
      });

      async function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          if (typeof XLSX === 'undefined') {
            reject(new Error('XLSX åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              // ä½¿ç”¨ cellDates: true æ¥è·å–æ—¥æœŸå¯¹è±¡ï¼Œè€Œä¸æ˜¯åºåˆ—å·
              // æ³¨æ„ï¼šXLSXåº“åœ¨cellDatesæ¨¡å¼ä¸‹ï¼ŒDateå¯¹è±¡çš„æ—¶é—´éƒ¨åˆ†é€šå¸¸æ˜¯00:00:00 UTC
              const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
              
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              
              // è¯»å–ç¬¬ä¸€è¡Œä½œä¸ºåˆ—å
              const firstRow = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' })[0];
              
              // Båˆ—åˆ°Qåˆ—å¯¹åº”ç´¢å¼•1åˆ°16
              columnNames = [];
              for (let i = 1; i <= 16; i++) {
                if (firstRow[i] !== undefined && firstRow[i] !== '') {
                  columnNames.push({
                    index: i,
                    name: String(firstRow[i]).trim()
                  });
                }
              }

              // è¯»å–æ•°æ®ï¼ˆä»ç¬¬äºŒè¡Œå¼€å§‹ï¼‰
              // ä½¿ç”¨raw: trueæ¥è·å–åŸå§‹å€¼ï¼Œç„¶åæ‰‹åŠ¨å¤„ç†æ—¥æœŸ
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1, 
                defval: null,
                range: 1, // è·³è¿‡ç¬¬ä¸€è¡Œ
                raw: true // è·å–åŸå§‹å€¼ï¼Œæ‰‹åŠ¨å¤„ç†æ—¥æœŸ
              });

              // å¤„ç†æ•°æ®ï¼šAåˆ—æ˜¯æ—¥æœŸï¼ŒB-Qåˆ—æ˜¯æŒ‡æ•°å€¼
              const processedData = [];
              jsonData.forEach((row, rowIndex) => {
                if (!row[0]) return; // è·³è¿‡æ²¡æœ‰æ—¥æœŸçš„è¡Œ
                
                const dateValue = row[0];
                // ä½¿ç”¨ç»Ÿä¸€çš„æ—¥æœŸè§£æå‡½æ•°
                const date = parseDateValue(dateValue);
                if (!date || isNaN(date.getTime())) return;

                const record = {
                  date: date,
                  values: {}
                };

                // è¯»å–B-Qåˆ—çš„å€¼ï¼ˆç´¢å¼•1-16ï¼‰
                columnNames.forEach(col => {
                  const value = row[col.index];
                  if (value !== null && value !== undefined && value !== '') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                      record.values[col.name] = numValue;
                    }
                  }
                });

                if (Object.keys(record.values).length > 0) {
                  processedData.push(record);
                }
              });

              resolve(processedData);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      function processData() {
        if (!scfiData.length) return;

        // æŒ‰æ—¥æœŸæ’åº
        scfiData.sort((a, b) => a.date - b.date);

        // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼šæœ€æ–°æ•°æ®å¾€å‰3å¹´
        const latestDate = scfiData[scfiData.length - 1].date;
        const threeYearsAgo = new Date(latestDate);
        threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);

        startDate.value = formatDateForInput(threeYearsAgo);
        endDate.value = formatDateForInput(latestDate);

        // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„èŒƒå›´
        const minDate = scfiData[0].date;
        const maxDate = scfiData[scfiData.length - 1].date;
        startDate.min = formatDateForInput(minDate);
        startDate.max = formatDateForInput(maxDate);
        endDate.min = formatDateForInput(minDate);
        endDate.max = formatDateForInput(maxDate);

        updateChart();
      }

      function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      startDate.addEventListener('change', updateChart);
      endDate.addEventListener('change', updateChart);
      comparisonDate.addEventListener('change', updateComparisonTable);

      function updateChart() {
        if (!scfiData.length || typeof Chart === 'undefined') return;

        const startValue = startDate.value;
        const endValue = endDate.value;
        const startDateObj = startValue ? new Date(startValue + 'T00:00:00') : null;
        const endDateObj = endValue ? new Date(endValue + 'T23:59:59') : null;

        // ç­›é€‰æ•°æ®
        const filteredData = scfiData.filter(record => {
          if (startDateObj && record.date < startDateObj) return false;
          if (endDateObj && record.date > endDateObj) return false;
          return true;
        });

        if (!filteredData.length) {
          showError(ErrorType.DATA_VALIDATION, 'NO_DATA_IN_RANGE');
          return;
        }

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const labels = filteredData.map(record => {
          const year = record.date.getFullYear();
          const month = String(record.date.getMonth() + 1).padStart(2, '0');
          const day = String(record.date.getDate()).padStart(2, '0');
          return `${year}/${month}/${day}`;
        });

        const datasets = [];
        const colors = [
          '#667eea', '#ff6b6b', '#20c997', '#f9a826', '#845ef7', '#17a2b8',
          '#ff9f43', '#6f42c1', '#51cf66', '#ffd43b', '#ff8787', '#339af0',
          '#ff922b', '#20c997', '#845ef7', '#ff6b6b'
        ];

        columnNames.forEach((col, index) => {
          const values = filteredData.map(record => record.values[col.name] || null);
          
          datasets.push({
            label: col.name,
            data: values,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            spanGaps: true
          });
        });

        // é”€æ¯æ—§å›¾è¡¨
        if (scfiChart) {
          scfiChart.destroy();
        }

        // åˆ›å»ºæ–°å›¾è¡¨
        const ctx = document.getElementById('trendChart').getContext('2d');
        scfiChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false // ä½¿ç”¨è‡ªå®šä¹‰å›¾ä¾‹
              },
              tooltip: {
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: 'SCFI æŒ‡æ•°'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'æ—¥æœŸ'
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });

        // æ›´æ–°è‡ªå®šä¹‰å›¾ä¾‹
        updateLegend(datasets);
      }

      function updateLegend(datasets) {
        legendContainer.innerHTML = '';
        datasets.forEach(dataset => {
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `
            <div class="legend-color" style="background-color: ${dataset.borderColor};"></div>
            <span>${dataset.label}</span>
          `;
          legendContainer.appendChild(legendItem);
        });
      }

      /**
       * æ›´æ–°å¯¹æ¯”è¡¨æ ¼
       */
      function updateComparisonTable() {
        if (!scfiData.length || !comparisonDate.value) {
          comparisonTableBody.innerHTML = `
            <tr>
              <td colspan="6" style="padding: 40px; text-align: center; color: #6c757d;">
                è¯·é€‰æ‹©å¯¹æ¯”æ—¥æœŸä»¥æŸ¥çœ‹æŒ‡æ•°å¯¹æ¯”
              </td>
            </tr>
          `;
          return;
        }

        // è§£æé€‰å®šæ—¥æœŸï¼Œä½¿ç”¨æœ¬åœ°æ—¶åŒºé¿å…æ—¶åŒºé—®é¢˜
        const dateParts = comparisonDate.value.split('-');
        const selectedDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
        
        // æ‰¾åˆ°æœ€æ¥è¿‘é€‰å®šæ—¥æœŸçš„æ•°æ®
        const selectedRecord = findClosestRecord(selectedDate);
        if (!selectedRecord) {
          comparisonTableBody.innerHTML = `
            <tr>
              <td colspan="6" style="padding: 40px; text-align: center; color: #ff6b6b;">
                æœªæ‰¾åˆ°é€‰å®šæ—¥æœŸçš„æ•°æ®
              </td>
            </tr>
          `;
          return;
        }

        // è®¡ç®—å„ä¸ªæ—¶é—´ç‚¹çš„æ•°æ®
        const oneWeekAgo = findClosestRecordByWeeks(selectedDate, 1);
        const oneMonthAgo = findClosestRecordByWeeks(selectedDate, 4);
        const threeMonthsAgo = findClosestRecordByWeeks(selectedDate, 12);
        const oneYearAgo = findClosestRecordByWeeks(selectedDate, 52);

        // ç”Ÿæˆè¡¨æ ¼
        comparisonTableBody.innerHTML = '';
        columnNames.forEach(col => {
          const selectedValue = selectedRecord.values[col.name];
          const oneWeekValue = oneWeekAgo?.values[col.name];
          const oneMonthValue = oneMonthAgo?.values[col.name];
          const threeMonthsValue = threeMonthsAgo?.values[col.name];
          const oneYearValue = oneYearAgo?.values[col.name];

          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid #e9ecef';
          tr.innerHTML = `
            <td style="padding: 12px; font-weight: 500;">${col.name}</td>
            <td style="padding: 12px; text-align: right;">${formatSelectedDate(selectedValue, selectedRecord.date)}</td>
            <td style="padding: 12px; text-align: right;">${formatComparison(selectedValue, oneWeekValue, oneWeekAgo?.date)}</td>
            <td style="padding: 12px; text-align: right;">${formatComparison(selectedValue, oneMonthValue, oneMonthAgo?.date)}</td>
            <td style="padding: 12px; text-align: right;">${formatComparison(selectedValue, threeMonthsValue, threeMonthsAgo?.date)}</td>
            <td style="padding: 12px; text-align: right;">${formatComparison(selectedValue, oneYearValue, oneYearAgo?.date)}</td>
          `;
          comparisonTableBody.appendChild(tr);
        });
      }

      /**
       * æ¯”è¾ƒä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ç›¸åŒï¼ˆåªæ¯”è¾ƒå¹´æœˆæ—¥ï¼‰
       */
      function isSameDate(date1, date2) {
        if (!date1 || !date2) return false;
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
      }

      /**
       * è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°å·®ï¼ˆåªè€ƒè™‘æ—¥æœŸéƒ¨åˆ†ï¼‰
       */
      function getDateDiff(date1, date2) {
        const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.abs(d1 - d2) / (1000 * 60 * 60 * 24);
      }

      /**
       * æ‰¾åˆ°æœ€æ¥è¿‘æŒ‡å®šæ—¥æœŸçš„è®°å½•
       */
      function findClosestRecord(targetDate) {
        // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
        const exactMatch = scfiData.find(record => isSameDate(record.date, targetDate));
        if (exactMatch) {
          return exactMatch;
        }

        // å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…ï¼Œæ‰¾æœ€æ¥è¿‘çš„
        let closest = null;
        let minDiff = Infinity;

        scfiData.forEach(record => {
          const diff = getDateDiff(record.date, targetDate);
          if (diff < minDiff) {
            minDiff = diff;
            closest = record;
          }
        });

        return closest;
      }

      /**
       * æ ¹æ®å‘¨æ•°æ‰¾åˆ°å¯¹åº”çš„è®°å½•ï¼ˆå¾€å‰æ¨Nå‘¨ï¼‰
       */
      function findClosestRecordByWeeks(targetDate, weeks) {
        // è®¡ç®—ç›®æ ‡æ—¥æœŸï¼ˆå¾€å‰æ¨Nå‘¨ï¼‰
        const targetWeekDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
        targetWeekDate.setDate(targetWeekDate.getDate() - (weeks * 7));
        
        // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
        const exactMatch = scfiData.find(record => isSameDate(record.date, targetWeekDate));
        if (exactMatch) {
          return exactMatch;
        }

        // å…è®¸å‰å3å¤©çš„è¯¯å·®èŒƒå›´
        const minDate = new Date(targetWeekDate);
        minDate.setDate(minDate.getDate() - 3);
        const maxDate = new Date(targetWeekDate);
        maxDate.setDate(maxDate.getDate() + 3);

        // æ‰¾åˆ°åœ¨è¿™ä¸ªèŒƒå›´å†…çš„è®°å½•ï¼ˆåªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼‰
        const candidates = scfiData.filter(record => {
          const recordDate = new Date(record.date.getFullYear(), record.date.getMonth(), record.date.getDate());
          const min = new Date(minDate.getFullYear(), minDate.getMonth(), minDate.getDate());
          const max = new Date(maxDate.getFullYear(), maxDate.getMonth(), maxDate.getDate());
          return recordDate >= min && recordDate <= max;
        });

        if (candidates.length === 0) {
          // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ‰¾æœ€æ¥è¿‘çš„
          return findClosestRecord(targetWeekDate);
        }

        // æ‰¾åˆ°æœ€æ¥è¿‘çš„
        let closest = null;
        let minDiff = Infinity;
        candidates.forEach(record => {
          const diff = getDateDiff(record.date, targetWeekDate);
          if (diff < minDiff) {
            minDiff = diff;
            closest = record;
          }
        });

        return closest;
      }

      /**
       * æ ¼å¼åŒ–æ•°å€¼
       */
      function formatValue(value) {
        if (value === null || value === undefined || isNaN(value)) {
          return '-';
        }
        return value.toFixed(2);
      }

      /**
       * æ ¼å¼åŒ–é€‰å®šæ—¥æœŸçš„æ˜¾ç¤ºï¼ˆ3è¡Œæ ¼å¼ï¼šæŒ‡æ•°å€¼ã€æ¶¨è·Œã€æ—¥æœŸï¼‰
       */
      function formatSelectedDate(value, date) {
        if (value === null || value === undefined || isNaN(value)) {
          return '<span style="color: #999;">-</span>';
        }

        const dateStr = date ? formatDateForDisplay(date) : '';

        return `
          <div>
            <div style="font-weight: 500;">${formatValue(value)}</div>
            <div style="font-size: 12px; color: #999;">-</div>
            ${dateStr ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">${dateStr}</div>` : ''}
          </div>
        `;
      }

      /**
       * æ ¼å¼åŒ–å¯¹æ¯”æ•°æ®ï¼ˆæ˜¾ç¤ºæ•°å€¼å’Œå˜åŒ–å¹…åº¦ï¼‰
       */
      function formatComparison(currentValue, pastValue, pastDate) {
        if (pastValue === null || pastValue === undefined || isNaN(pastValue)) {
          return '<span style="color: #999;">-</span>';
        }

        const change = currentValue - pastValue;
        const changePercent = ((change / pastValue) * 100).toFixed(2);
        const isPositive = change >= 0;
        const color = isPositive ? '#20c997' : '#ff6b6b';
        const symbol = isPositive ? '+' : '';

        const dateStr = pastDate ? formatDateForDisplay(pastDate) : '';

        return `
          <div>
            <div style="font-weight: 500;">${formatValue(pastValue)}</div>
            <div style="font-size: 12px; color: ${color};">
              ${symbol}${change.toFixed(2)} (${symbol}${changePercent}%)
            </div>
            ${dateStr ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">${dateStr}</div>` : ''}
          </div>
        `;
      }

      /**
       * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼ˆé¿å…æ—¶åŒºé—®é¢˜ï¼‰
       */
      function formatDateForDisplay(date) {
        if (!date) return '';
        // ä½¿ç”¨æœ¬åœ°æ—¥æœŸï¼Œé¿å…æ—¶åŒºè½¬æ¢
        const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const year = localDate.getFullYear();
        const month = String(localDate.getMonth() + 1).padStart(2, '0');
        const day = String(localDate.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
      }
    </script>
  </body>
</html>

