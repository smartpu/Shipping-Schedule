<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor Â· SCFI å†å²è¶‹åŠ¿</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <script>
      (function ensureXlsx() {
        const remoteSources = [
          'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
        ];

        async function loadXlsxViaBlob(url) {
          try {
            const response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) throw new Error(response.statusText);
            const code = await response.text();
            const blob = new Blob([code], { type: 'text/javascript' });
            const blobUrl = URL.createObjectURL(blob);
            await new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = blobUrl;
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
            });
            console.log('XLSX loaded via fetch:', url);
            return true;
          } catch (error) {
            console.error('XLSX fetch fallback failed:', url, error);
            return false;
          }
        }

        async function loadXlsx() {
          for (const url of remoteSources) {
            try {
              await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
              });
              console.log('XLSX loaded from', url);
              return true;
            } catch (error) {
              console.warn('XLSX direct load failed:', url, error);
            }
          }
          for (const url of remoteSources) {
            if (await loadXlsxViaBlob(url)) return true;
          }
          return false;
        }

        if (typeof XLSX === 'undefined') {
          loadXlsx().then(success => {
            if (!success) {
              console.error('XLSX æ— æ³•åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ‰‹åŠ¨åˆ·æ–°åé‡è¯•');
            }
          });
        }
      })();
    </script>
    <script>
      (function ensureChartJs() {
        const remoteSources = [
          'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js',
          'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js'
        ];

        async function loadChartViaBlob(url) {
          try {
            const response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) throw new Error(response.statusText);
            const code = await response.text();
            const blob = new Blob([code], { type: 'text/javascript' });
            const blobUrl = URL.createObjectURL(blob);
            await new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = blobUrl;
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
            });
            console.log('Chart.js loaded via fetch:', url);
            return true;
          } catch (error) {
            console.error('Chart.js fetch fallback failed:', url, error);
            return false;
          }
        }

        async function loadChartJs() {
          for (const url of remoteSources) {
            try {
              await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
              });
              console.log('Chart.js loaded from', url);
              return true;
            } catch (error) {
              console.warn('Chart.js direct load failed:', url, error);
            }
          }
          for (const url of remoteSources) {
            if (await loadChartViaBlob(url)) return true;
          }
          return false;
        }

        if (typeof Chart === 'undefined') {
          loadChartJs().then(success => {
            if (!success) {
              alert('Chart.js æ— æ³•åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ‰‹åŠ¨åˆ·æ–°åé‡è¯•');
            }
          });
        }
      })();
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 0;
        margin: 0;
        color: #333;
      }

      .container {
        width: 100%;
        margin: 0;
        background: white;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #5f7ae0 0%, #4f2d8c 100%);
        color: white;
        padding: 48px 30px;
        text-align: center;
        position: relative;
      }

      .back-home-btn {
        position: absolute;
        top: 20px;
        left: 30px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
      }

      .back-home-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .header h1 {
        font-size: 30px;
        margin-bottom: 10px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      .header p {
        opacity: 0.92;
        font-size: 15px;
        letter-spacing: 0.4px;
      }

      .content {
        padding: 20px 40px 30px;
      }

      section.panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .upload-area {
        display: flex;
        gap: 20px;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        border: 2px dashed rgba(102, 126, 234, 0.3);
      }

      .file-btn {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .file-btn:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .file-btn input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .status-info {
        color: #6c757d;
        font-size: 14px;
      }

      .chart-container {
        background: white;
        border-radius: 10px;
        padding: 30px;
        margin-top: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .chart-wrapper {
        position: relative;
        height: 800px;
        margin-top: 20px;
      }

      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-group label {
        font-size: 14px;
        font-weight: 500;
        color: #495057;
      }

      .control-group input[type="date"] {
        padding: 8px 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .control-group input[type="date"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .legend-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      .hidden {
        display: none;
      }

      .page-footer {
        width: 100%;
        background: linear-gradient(135deg, #5f7ae0 0%, #4f2d8c 100%);
        color: white;
        padding: 32px 30px 36px;
        text-align: center;
        margin-top: 0;
        box-sizing: border-box;
      }

      .page-footer h2 {
        font-size: 18px;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .page-footer p {
        margin: 6px 0;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.82);
        line-height: 1.5;
      }

      
    </style>
  </head>
  <body data-page="Monitor-SCFI-Trends.html">
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <h2>ğŸ” è®¿é—®éªŒè¯</h2>
        <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
        <form id="authForm">
          <div class="auth-form-group">
            <label for="userName">å§“å *</label>
            <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
            <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
          </div>
          <div class="auth-form-group">
            <label for="userPhone">æ‰‹æœºå· *</label>
            <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
            <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
          </div>
          <div class="auth-form-group">
            <label for="userEmail">é‚®ç®± *</label>
            <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
            <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
          </div>
          <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
        </form>
      </div>
    </div>
    <div class="container">
      <div class="header">
        <a href="index.html?tab=monitor" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
        <h1>Monitor Â· SCFI å†å²è¶‹åŠ¿</h1>
        <p>è¯»å– SCFI æ–‡ä»¶ï¼Œå±•ç¤º B åˆ—åˆ° Q åˆ—çš„ç»¼åˆæŒ‡æ•°åŠåˆ† trade æŒ‡æ•°è¶‹åŠ¿ï¼ˆé»˜è®¤æœ€è¿‘3å¹´ï¼‰</p>
      </div>

      <div class="content">
        <section class="panel">
          <div class="upload-area">
            <label class="file-btn">
              é€‰æ‹© SCFI.xlsx æ–‡ä»¶
              <input id="fileInput" type="file" accept=".xlsx,.xls">
            </label>
            <span class="status-info" id="statusInfo">è¯·é€‰æ‹© SCFI æ–‡ä»¶</span>
          </div>
        </section>

        <section class="panel hidden" id="chartSection">
          <div class="controls">
            <div class="control-group">
              <label>å¼€å§‹æ—¥æœŸï¼š</label>
              <input type="date" id="startDate">
            </div>
            <div class="control-group">
              <label>ç»“æŸæ—¥æœŸï¼š</label>
              <input type="date" id="endDate">
            </div>
          </div>
          <div class="chart-container">
            <h3 style="margin-bottom: 20px; color: #495057;">SCFI å†å²è¶‹åŠ¿å›¾</h3>
            <div class="chart-wrapper">
              <canvas id="trendChart"></canvas>
            </div>
            <div class="legend-container" id="legendContainer"></div>
          </div>
        </section>
      </div>
    </div>

    <div class="page-footer">
      <h2>Monitor Â· SCFI å†å²è¶‹åŠ¿ä½¿ç”¨å£°æ˜</h2>
      <p>èµ„æ–™æ•´åˆè‡ª SCFI æ•°æ®æ–‡ä»¶ï¼Œè§£æç»“æœä»…ä¾›å†…éƒ¨ç ”åˆ¤ï¼Œä¸æ„æˆå¯¹å¤–æŠ¥ä»·æˆ–æŠ•èµ„å»ºè®®ã€‚</p>
      <p>æ‰€æœ‰æ•°æ®ä»…åœ¨æœ¬åœ°æµè§ˆå™¨è§£æï¼Œä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</p>
    </div>

    <script src="vendor/auth.js"></script>
    <script src="vendor/server-log.js"></script>
    <script>

      let scfiChart = null;
      let scfiData = [];
      let columnNames = [];

      const fileInput = document.getElementById('fileInput');
      const statusInfo = document.getElementById('statusInfo');
      const chartSection = document.getElementById('chartSection');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      const legendContainer = document.getElementById('legendContainer');

      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (typeof XLSX === 'undefined') {
          alert('XLSX åº“å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™å‡ ç§’åé‡è¯•ã€‚\n\nå¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢ã€‚');
          return;
        }

        try {
          statusInfo.textContent = 'æ­£åœ¨è¯»å–æ–‡ä»¶...';
          const data = await readExcelFile(file);
          
          if (!data.length) {
            alert('Excel æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
            return;
          }

          scfiData = data;
          processData();
          statusInfo.textContent = `å·²åŠ è½½ ${data.length} æ¡æ•°æ®`;
          chartSection.classList.remove('hidden');
        } catch (error) {
          alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼š' + error.message);
          console.error(error);
          statusInfo.textContent = 'æ–‡ä»¶è¯»å–å¤±è´¥';
        }
      });

      async function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          if (typeof XLSX === 'undefined') {
            reject(new Error('XLSX åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array', cellDates: true });
              
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              
              // è¯»å–ç¬¬ä¸€è¡Œä½œä¸ºåˆ—å
              const firstRow = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' })[0];
              
              // Båˆ—åˆ°Qåˆ—å¯¹åº”ç´¢å¼•1åˆ°16
              columnNames = [];
              for (let i = 1; i <= 16; i++) {
                if (firstRow[i] !== undefined && firstRow[i] !== '') {
                  columnNames.push({
                    index: i,
                    name: String(firstRow[i]).trim()
                  });
                }
              }

              // è¯»å–æ•°æ®ï¼ˆä»ç¬¬äºŒè¡Œå¼€å§‹ï¼‰
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1, 
                defval: null,
                range: 1 // è·³è¿‡ç¬¬ä¸€è¡Œ
              });

              // å¤„ç†æ•°æ®ï¼šAåˆ—æ˜¯æ—¥æœŸï¼ŒB-Qåˆ—æ˜¯æŒ‡æ•°å€¼
              const processedData = [];
              jsonData.forEach((row, rowIndex) => {
                if (!row[0]) return; // è·³è¿‡æ²¡æœ‰æ—¥æœŸçš„è¡Œ
                
                const dateValue = row[0];
                let date = null;
                
                // å¤„ç†æ—¥æœŸ
                if (dateValue instanceof Date) {
                  date = dateValue;
                } else if (typeof dateValue === 'number') {
                  // Excelæ—¥æœŸåºåˆ—å·
                  const excelEpoch = new Date(1899, 11, 30);
                  date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                } else if (typeof dateValue === 'string') {
                  date = new Date(dateValue);
                }

                if (!date || isNaN(date.getTime())) return;

                const record = {
                  date: date,
                  values: {}
                };

                // è¯»å–B-Qåˆ—çš„å€¼ï¼ˆç´¢å¼•1-16ï¼‰
                columnNames.forEach(col => {
                  const value = row[col.index];
                  if (value !== null && value !== undefined && value !== '') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                      record.values[col.name] = numValue;
                    }
                  }
                });

                if (Object.keys(record.values).length > 0) {
                  processedData.push(record);
                }
              });

              resolve(processedData);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      function processData() {
        if (!scfiData.length) return;

        // æŒ‰æ—¥æœŸæ’åº
        scfiData.sort((a, b) => a.date - b.date);

        // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼šæœ€æ–°æ•°æ®å¾€å‰3å¹´
        const latestDate = scfiData[scfiData.length - 1].date;
        const threeYearsAgo = new Date(latestDate);
        threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);

        startDate.value = formatDateForInput(threeYearsAgo);
        endDate.value = formatDateForInput(latestDate);

        // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„èŒƒå›´
        const minDate = scfiData[0].date;
        const maxDate = scfiData[scfiData.length - 1].date;
        startDate.min = formatDateForInput(minDate);
        startDate.max = formatDateForInput(maxDate);
        endDate.min = formatDateForInput(minDate);
        endDate.max = formatDateForInput(maxDate);

        updateChart();
      }

      function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      startDate.addEventListener('change', updateChart);
      endDate.addEventListener('change', updateChart);

      function updateChart() {
        if (!scfiData.length || typeof Chart === 'undefined') return;

        const startValue = startDate.value;
        const endValue = endDate.value;
        const startDateObj = startValue ? new Date(startValue + 'T00:00:00') : null;
        const endDateObj = endValue ? new Date(endValue + 'T23:59:59') : null;

        // ç­›é€‰æ•°æ®
        const filteredData = scfiData.filter(record => {
          if (startDateObj && record.date < startDateObj) return false;
          if (endDateObj && record.date > endDateObj) return false;
          return true;
        });

        if (!filteredData.length) {
          alert('æ‰€é€‰æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰æ•°æ®');
          return;
        }

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const labels = filteredData.map(record => {
          const year = record.date.getFullYear();
          const month = String(record.date.getMonth() + 1).padStart(2, '0');
          const day = String(record.date.getDate()).padStart(2, '0');
          return `${year}/${month}/${day}`;
        });

        const datasets = [];
        const colors = [
          '#667eea', '#ff6b6b', '#20c997', '#f9a826', '#845ef7', '#17a2b8',
          '#ff9f43', '#6f42c1', '#51cf66', '#ffd43b', '#ff8787', '#339af0',
          '#ff922b', '#20c997', '#845ef7', '#ff6b6b'
        ];

        columnNames.forEach((col, index) => {
          const values = filteredData.map(record => record.values[col.name] || null);
          
          datasets.push({
            label: col.name,
            data: values,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            spanGaps: true
          });
        });

        // é”€æ¯æ—§å›¾è¡¨
        if (scfiChart) {
          scfiChart.destroy();
        }

        // åˆ›å»ºæ–°å›¾è¡¨
        const ctx = document.getElementById('trendChart').getContext('2d');
        scfiChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false // ä½¿ç”¨è‡ªå®šä¹‰å›¾ä¾‹
              },
              tooltip: {
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: 'SCFI æŒ‡æ•°'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'æ—¥æœŸ'
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });

        // æ›´æ–°è‡ªå®šä¹‰å›¾ä¾‹
        updateLegend(datasets);
      }

      function updateLegend(datasets) {
        legendContainer.innerHTML = '';
        datasets.forEach(dataset => {
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `
            <div class="legend-color" style="background-color: ${dataset.borderColor};"></div>
            <span>${dataset.label}</span>
          `;
          legendContainer.appendChild(legendItem);
        });
      }
    </script>
  </body>
</html>

