<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor Â· èˆ¹æœŸè¡¨</title>
    <link rel="stylesheet" href="vendor/auth.css">
    <link rel="stylesheet" href="vendor/common-styles.css">
    <link rel="stylesheet" href="vendor/monitor-styles.css">
    <link rel="stylesheet" href="vendor/ai-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/pdf-utils.js"></script>
    <script src="vendor/ai-config.js"></script>
    <script src="vendor/ai-prompts.js"></script>
    <script src="vendor/ai-utils.js"></script>
    <style>
      /* é¡µé¢ç‰¹å®šæ ·å¼ */
      
      /* header-controls æ ·å¼å·²ç§»è‡³ vendor/monitor-styles.css */

      /* mode-toggle, mode-btn æ ·å¼å·²ç§»è‡³ vendor/monitor-styles.css */

      /* filters-container, filter-group, filter-search, filter-btn æ ·å¼å·²ç§»è‡³ vendor/monitor-styles.css */

      .calendar-container {
        background: white;
        border-radius: 10px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
        min-width: 100%;
      }

      .calendar-header {
        display: grid;
        grid-template-columns: 120px repeat(7, minmax(180px, 1fr));
        gap: 8px;
        margin-bottom: 12px;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
      }

      .calendar-header-cell {
        padding: 12px;
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .calendar-week {
        display: grid;
        grid-template-columns: 120px repeat(7, minmax(180px, 1fr));
        gap: 8px;
        margin-bottom: 8px;
      }

      .calendar-day-label {
        padding: 12px;
        text-align: center;
        font-weight: 500;
        color: #495057;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 13px;
      }

      .calendar-day {
        height: 750px;
        min-height: 750px;
        max-height: 750px;
        min-width: 180px;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
        position: relative;
        overflow-y: hidden;
        overflow-x: hidden;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
      }

      .calendar-day:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      .calendar-day.today {
        border-color: #667eea;
        background: linear-gradient(to bottom, rgba(102, 126, 234, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .schedule-item {
        padding: 10px 12px;
        margin-bottom: 8px;
        background: white;
        border-left: 4px solid #667eea;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.5;
        cursor: pointer;
        transition: all 0.2s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
      }

      .schedule-item:hover {
        background: rgba(102, 126, 234, 0.08);
        transform: translateX(3px);
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.2);
        border-left-color: #764ba2;
      }

      .schedule-item.highlighted {
        background: rgba(102, 126, 234, 0.15);
        border-left-color: #764ba2;
        border-left-width: 5px;
      }

      .schedule-item.highlighted:hover {
        background: rgba(102, 126, 234, 0.2);
      }

      .schedule-item .port {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 2px;
      }

      .schedule-item .carrier {
        color: #6c757d;
        font-size: 11px;
      }

      .schedule-item .vessel {
        color: #495057;
        font-size: 11px;
        margin-top: 2px;
      }

      .schedule-item .carrier {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      /* tooltip ç›¸å…³æ ·å¼å·²ç§»è‡³ vendor/common-styles.css */
      /* empty-message æ ·å¼å·²ç§»è‡³ vendor/monitor-styles.css */
      
      .more-items-indicator {
        flex-shrink: 0;
        margin-top: auto;
        padding-top: 8px;
        min-height: 24px;
      }

      .calendar-container.hidden {
        display: none;
      }

      /* æœˆåº¦æ±‡æ€»è¡¨æ ¼æ ·å¼ */
      .monthly-summary-container {
        background: white;
        border-radius: 10px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
      }

      .monthly-summary-container.hidden {
        display: none;
      }

      .monthly-summary-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        min-width: 800px;
        table-layout: fixed;
      }

      .monthly-summary-table th,
      .monthly-summary-table td {
        padding: 10px 12px;
        border: 1px solid #e9ecef;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .monthly-summary-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
        text-align: center;
      }

      .monthly-summary-table th:first-child {
        position: sticky;
        left: 0;
        z-index: 11;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        text-align: center;
      }

      .monthly-summary-table td:first-child {
        position: sticky;
        left: 0;
        background: #f8f9fa;
        font-weight: 500;
        z-index: 1;
        text-align: center;
      }

      .monthly-summary-table td:not(:first-child) {
        text-align: center;
      }

      .monthly-summary-table .vessel-info {
        text-align: center;
      }

      .monthly-summary-table tfoot {
        background: #f0f0f0;
        font-weight: 600;
      }

      .monthly-summary-table tfoot td {
        background: #f0f0f0;
        border-top: 2px solid #667eea;
        text-align: center;
      }

      .monthly-summary-table tfoot td:first-child {
        background: #e9ecef;
        border-top: 2px solid #667eea;
        text-align: center;
      }

      .monthly-summary-table tbody tr:nth-child(even) {
        background: #f8f9fa;
      }

      .monthly-summary-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.08);
      }

      .monthly-summary-table tbody tr:hover td:first-child {
        background: rgba(102, 126, 234, 0.12);
      }

      .monthly-summary-table .vessel-info {
        font-size: 12px;
        line-height: 1.6;
        color: #495057;
      }

      .monthly-summary-table .vessel-info-item {
        margin-bottom: 4px;
        padding: 2px 0;
      }

      .monthly-summary-table .vessel-info-item:last-child {
        margin-bottom: 0;
      }

      /* å“åº”å¼è®¾è®¡ï¼šå¹³æ¿å’Œçª„å± */
      @media (max-width: 1400px) {
        .calendar-header {
          grid-template-columns: 100px repeat(7, minmax(150px, 1fr));
        }
        .calendar-week {
          grid-template-columns: 100px repeat(7, minmax(150px, 1fr));
        }
        .calendar-day {
          min-width: 150px;
        }
      }

      @media (max-width: 1200px) {
        .calendar-header {
          grid-template-columns: 80px repeat(7, minmax(120px, 1fr));
        }
        .calendar-week {
          grid-template-columns: 80px repeat(7, minmax(120px, 1fr));
        }
        .calendar-day {
          min-width: 120px;
          height: 600px;
          min-height: 600px;
          max-height: 600px;
        }
      }

      /* æ‰‹æœºç«¯ï¼šæŒ‰æ—¥æ˜¾ç¤ºï¼ˆå‚ç›´å¸ƒå±€ï¼‰ */
      @media (max-width: 768px) {
        .calendar-container {
          padding: 16px;
        }
        
        .calendar-header {
          display: none; /* æ‰‹æœºç«¯éšè—è¡¨å¤´ */
        }
        
        .calendar-week {
          display: block; /* æ”¹ä¸ºå—çº§å¸ƒå±€ */
          margin-bottom: 16px;
        }
        
        .calendar-day-label {
          display: none; /* æ‰‹æœºç«¯éšè—å‘¨æ ‡ç­¾ */
        }
        
        .calendar-day {
          width: 100%;
          min-width: 100%;
          max-width: 100%;
          height: auto;
          min-height: auto;
          max-height: none;
          margin-bottom: 16px;
          padding: 16px;
          overflow-y: visible;
        }
        
        .schedule-item {
          font-size: 13px;
          padding: 12px;
        }
        
        .schedule-item .port {
          font-size: 14px;
        }
        
        .schedule-item .carrier {
          font-size: 12px;
        }
        
        .schedule-item .vessel {
          font-size: 11px;
        }
      }

      /* upload-area, upload-card, status-card æ ·å¼å·²ç§»è‡³ vendor/monitor-styles.css */

      /* AI åˆ†ææ¨¡å—æ ·å¼å·²ç§»è‡³ vendor/ai-styles.css */
    </style>
  </head>
  <body data-page="monitor-sailing-schedule.html">
    <!-- ç”¨æˆ·éªŒè¯æ¨¡æ€æ¡† -->
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <h2>ğŸ” è®¿é—®éªŒè¯</h2>
        <p>ä¸ºäº†äº†è§£å·¥å…·ä½¿ç”¨æƒ…å†µï¼Œè¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯</p>
        <form id="authForm">
          <div class="auth-form-group">
            <label for="userName">å§“å *</label>
            <input type="text" id="userName" name="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required autocomplete="name">
            <div class="auth-error" id="nameError">è¯·è¾“å…¥æ‚¨çš„å§“å</div>
          </div>
          <div class="auth-form-group">
            <label for="userPhone">æ‰‹æœºå· *</label>
            <input type="tel" id="userPhone" name="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required autocomplete="tel">
            <div class="auth-error" id="phoneError">è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·</div>
          </div>
          <div class="auth-form-group">
            <label for="userEmail">é‚®ç®± *</label>
            <input type="email" id="userEmail" name="userEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required autocomplete="email">
            <div class="auth-error" id="emailError">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
          </div>
          <button type="submit" class="auth-submit-btn">ç¡®è®¤å¹¶ç»§ç»­</button>
        </form>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <a href="index.html?tab=monitor" class="back-home-btn">â† è¿”å›é¦–é¡µ</a>
        <a href="Monitor-Sailing-Schedule-README.html" class="readme-btn">ä½¿ç”¨è¯´æ˜ â†’</a>
        <h1>Monitor Â· èˆ¹æœŸè¡¨</h1>
        <p>ä»¥æ—¥å†è§†å›¾å±•ç¤ºèˆ¹æœŸä¿¡æ¯ï¼Œæ”¯æŒèˆªçº¿åŒºåŸŸã€èˆ¹å…¬å¸ã€æ¸¯å£å¤šç»´åº¦ç­›é€‰</p>
      </div>

      <div class="content">
        <!-- æ–‡ä»¶è½½å…¥åŒºåŸŸ -->
        <section class="panel">
          <div class="upload-area">
            <label class="upload-card" for="file001">
              <svg
                width="36"
                height="36"
                viewBox="0 0 36 36"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <rect
                  x="4"
                  y="4"
                  width="28"
                  height="28"
                  rx="8"
                  fill="url(#grad001)"
                ></rect>
                <path
                  d="M18 11v14M11 18h14"
                  stroke="#fff"
                  stroke-width="2.2"
                  stroke-linecap="round"
                ></path>
                <defs>
                  <linearGradient
                    id="grad001"
                    x1="4"
                    y1="4"
                    x2="32"
                    y2="32"
                    gradientUnits="userSpaceOnUse"
                  >
                    <stop stop-color="#0071e3" />
                    <stop offset="1" stop-color="#54a4ff" />
                  </linearGradient>
                </defs>
              </svg>
              <span>
                <strong>001-03 æ–‡ä»¶</strong><br />
                <small id="status001">001-03æ–‡ä»¶æœªåŠ è½½</small>
              </span>
              <input type="file" id="file001" accept=".xlsx,.xls">
            </label>
            <label class="upload-card" for="file365">
              <svg
                width="36"
                height="36"
                viewBox="0 0 36 36"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <rect
                  x="4"
                  y="4"
                  width="28"
                  height="28"
                  rx="8"
                  fill="url(#grad365)"
                ></rect>
                <path
                  d="M18 11v14M11 18h14"
                  stroke="#fff"
                  stroke-width="2.2"
                  stroke-linecap="round"
                ></path>
                <defs>
                  <linearGradient
                    id="grad365"
                    x1="4"
                    y1="4"
                    x2="32"
                    y2="32"
                    gradientUnits="userSpaceOnUse"
                  >
                    <stop stop-color="#0071e3" />
                    <stop offset="1" stop-color="#54a4ff" />
                  </linearGradient>
                </defs>
              </svg>
              <span>
                <strong>365-03 æ–‡ä»¶</strong><br />
                <small id="status365">365-03æ–‡ä»¶æœªåŠ è½½</small>
              </span>
              <input type="file" id="file365" accept=".xlsx,.xls">
            </label>
          </div>
        </section>

        <!-- ç­›é€‰å™¨å’Œæ˜¾ç¤ºæ¨¡å¼ -->
        <section class="panel">
          <div class="header-controls">
            <h3 style="margin: 0; color: #495057;">ç­›é€‰æ¡ä»¶</h3>
            <div style="display: flex; gap: 16px; align-items: center;">
              <div class="mode-toggle">
                <span style="color: #6c757d; font-size: 14px; margin-right: 8px;">æ˜¾ç¤ºæ¨¡å¼ï¼š</span>
                <button class="mode-btn active" data-mode="001">001</button>
                <button class="mode-btn" data-mode="365">365</button>
              </div>
              <button type="button" class="mode-btn" id="exportPdfBtn" style="background: #667eea; color: white; border-color: #667eea;">
                å¯¼å‡º PDF
              </button>
            </div>
          </div>

          <div class="filters-container">
            <div class="filter-group">
              <label for="regionFilter">èˆªçº¿åŒºåŸŸç­›é€‰ï¼ˆå¯å¤šé€‰ï¼‰</label>
              <input type="text" id="regionSearch" class="filter-search" placeholder="æœç´¢èˆªçº¿åŒºåŸŸ...">
              <select id="regionFilter" multiple>
                <!-- åŠ¨æ€å¡«å…… -->
              </select>
              <div class="filter-actions">
                <button type="button" class="filter-btn" data-filter="region" data-action="select-all">å…¨éƒ¨é€‰æ‹©</button>
                <button type="button" class="filter-btn" data-filter="region" data-action="clear-all">æ¸…é™¤é€‰æ‹©</button>
              </div>
            </div>
            <div class="filter-group">
              <label for="carrierFilter">èˆ¹å…¬å¸ç­›é€‰ï¼ˆå¯å¤šé€‰ï¼‰</label>
              <input type="text" id="carrierSearch" class="filter-search" placeholder="æœç´¢èˆ¹å…¬å¸...">
              <select id="carrierFilter" multiple>
                <!-- åŠ¨æ€å¡«å…… -->
              </select>
              <div class="filter-actions">
                <button type="button" class="filter-btn" data-filter="carrier" data-action="select-all">å…¨éƒ¨é€‰æ‹©</button>
                <button type="button" class="filter-btn" data-filter="carrier" data-action="clear-all">æ¸…é™¤é€‰æ‹©</button>
              </div>
            </div>
            <div class="filter-group">
              <label for="portFilter">æ¸¯å£ç­›é€‰ï¼ˆå¯å¤šé€‰ï¼‰</label>
              <input type="text" id="portSearch" class="filter-search" placeholder="æœç´¢æ¸¯å£...">
              <select id="portFilter" multiple>
                <!-- åŠ¨æ€å¡«å…… -->
              </select>
              <div class="filter-actions">
                <button type="button" class="filter-btn" data-filter="port" data-action="select-all">å…¨éƒ¨é€‰æ‹©</button>
                <button type="button" class="filter-btn" data-filter="port" data-action="clear-all">æ¸…é™¤é€‰æ‹©</button>
              </div>
            </div>
          </div>
        </section>

        <!-- æ—¥å†è§†å›¾ -->
        <section class="panel">
          <div class="empty-message" id="emptyMessage">
            è¯·é€‰æ‹©ç­›é€‰æ¡ä»¶ä»¥æ˜¾ç¤ºèˆ¹æœŸæ—¥å†
          </div>
          <div class="calendar-container hidden" id="calendarContainer">
            <div class="calendar-header">
              <div class="calendar-header-cell">æ—¶é—´</div>
            <div class="calendar-header-cell">å‘¨æ—¥</div>
            <div class="calendar-header-cell">å‘¨ä¸€</div>
            <div class="calendar-header-cell">å‘¨äºŒ</div>
            <div class="calendar-header-cell">å‘¨ä¸‰</div>
            <div class="calendar-header-cell">å‘¨å››</div>
            <div class="calendar-header-cell">å‘¨äº”</div>
            <div class="calendar-header-cell">å‘¨å…­</div>
            </div>
            <div id="calendarBody"></div>
          </div>
        </section>

        <!-- æœˆåº¦æ±‡æ€»è¡¨æ ¼ -->
        <section class="panel">
          <div class="empty-message" id="monthlySummaryEmptyMessage" style="display: none;">
            è¯·é€‰æ‹©ç­›é€‰æ¡ä»¶ä»¥æ˜¾ç¤ºæœˆåº¦æ±‡æ€»
          </div>
          <div id="monthlySummaryContainer" class="monthly-summary-container hidden">
            <h3 style="margin: 0 0 16px 0; color: #495057; font-size: 18px;">æœˆåº¦èˆªçº¿é æ³Šæ±‡æ€»</h3>
            <div id="monthlySummaryTable" class="monthly-summary-table"></div>
          </div>
        </section>

        <!-- AI èˆ¹æœŸåˆ†ææ¨¡å— -->
        <section class="card" id="aiAnalysisSection">
          <div class="card-header">
            <h2 class="section-title">AI èˆ¹æœŸåˆ†æ <span>AI SAILING SCHEDULE ANALYSIS</span></h2>
            <p class="module-desc">DeepSeek Ã— KIMI Ã— é€šä¹‰åƒé—® ä¸‰æ¨¡å‹äº¤å‰éªŒè¯èˆ¹æœŸè§„å¾‹ã€å¼‚å¸¸æ£€æµ‹ä¸è¶‹åŠ¿åˆ†æ</p>
          </div>
          <div id="aiAnalysisContainer" class="ai-analysis-container">
            <div class="ai-header">
              <h3>AI èˆ¹æœŸåˆ†æ</h3>
              <p>åŸºäºå½“å‰ç­›é€‰æ¡ä»¶ï¼Œå¯¹åŒºåŸŸèˆªçº¿ã€èˆ¹å…¬å¸æˆ–å…·ä½“æ¸¯å£è¿›è¡Œæ·±åº¦èˆ¹æœŸåˆ†æ</p>
            </div>
            <div id="emptyAiMessage" class="empty-chart-message" style="display: none;">
              è¯·å…ˆé€‰æ‹©ç­›é€‰æ¡ä»¶ï¼ˆåŒºåŸŸèˆªçº¿ã€èˆ¹å…¬å¸æˆ–æ¸¯å£ï¼‰ä»¥å¯ç”¨ AI åˆ†æ
            </div>
            <div id="aiConfigSection" style="display: none;">
              <div class="ai-tabs">
                <div class="ai-tab-buttons">
                  <button class="ai-tab-btn active" data-provider="deepseek">DeepSeek</button>
                  <button class="ai-tab-btn" data-provider="kimi">KIMI (Moonshot)</button>
                  <button class="ai-tab-btn" data-provider="qwen">é€šä¹‰åƒé—® (Qwen)</button>
                </div>
                <span class="ai-tab-hint">å¯åˆ‡æ¢ä¸åŒæ¨¡å‹å¯¹æ¯”è§‚ç‚¹ä¸€è‡´æ€§</span>
              </div>
              <div class="ai-panels">
                <div class="ai-panel active" data-provider="deepseek">
                  <div class="api-config">
                    <h4>DeepSeek API é…ç½®</h4>
                    <div class="api-input-group">
                      <label>API Key:</label>
                      <input type="password" id="apiKeyInput" placeholder="è¯·è¾“å…¥ DeepSeek API Key">
                    </div>
                    <div class="api-input-group">
                      <label>API URL:</label>
                      <input type="text" id="apiUrlInput" placeholder="https://api.deepseek.com/v1/chat/completions" value="https://api.deepseek.com/v1/chat/completions">
                    </div>
                    <div class="api-input-group">
                      <label>æ¨¡å‹ ID:</label>
                      <input type="text" id="apiModelInput" placeholder="deepseek-chat" value="deepseek-chat" list="deepseekModelOptions">
                    </div>
                    <button class="api-save-btn" onclick="saveAiConfig('deepseek')">ä¿å­˜é…ç½®</button>
                  </div>
                  <button class="ai-analysis-btn" id="aiAnalysisBtn" onclick="runAiAnalysis('deepseek')">ä½¿ç”¨ DeepSeek åˆ†æ</button>
                  <div id="aiLoading" class="ai-loading hidden">æ­£åœ¨åˆ†æä¸­</div>
                  <div id="aiResult" class="ai-result hidden">
                    <h4>DeepSeek åˆ†æç»“æœ</h4>
                    <div class="ai-result-content" id="aiResultContent"></div>
                  </div>
                </div>
                <div class="ai-panel" data-provider="kimi">
                  <div class="api-config">
                    <h4>KIMI (Moonshot) API é…ç½®</h4>
                    <div class="api-input-group">
                      <label>API Key:</label>
                      <input type="password" id="kimiApiKeyInput" placeholder="è¯·è¾“å…¥ KIMI / Moonshot API Key">
                    </div>
                    <div class="api-input-group">
                      <label>API URL:</label>
                      <input type="text" id="kimiApiUrlInput" placeholder="https://api.moonshot.cn/v1/chat/completions" value="https://api.moonshot.cn/v1/chat/completions">
                    </div>
                    <div class="api-input-group">
                      <label>æ¨¡å‹ ID:</label>
                      <input type="text" id="kimiModelInput" placeholder="moonshot-v1-32k" value="moonshot-v1-32k" list="kimiModelOptions">
                    </div>
                    <button class="api-save-btn" onclick="saveAiConfig('kimi')">ä¿å­˜é…ç½®</button>
                  </div>
                  <button class="ai-analysis-btn secondary" id="kimiAnalysisBtn" onclick="runAiAnalysis('kimi')">ä½¿ç”¨ KIMI åˆ†æ</button>
                  <div id="kimiAiLoading" class="ai-loading hidden">æ­£åœ¨åˆ†æä¸­</div>
                  <div id="kimiAiResult" class="ai-result hidden">
                    <h4>KIMI åˆ†æç»“æœ</h4>
                    <div class="ai-result-content" id="kimiAiResultContent"></div>
                  </div>
                </div>
                <div class="ai-panel" data-provider="qwen">
                  <div class="api-config">
                    <h4>é€šä¹‰åƒé—® (Qwen) API é…ç½®</h4>
                    <div class="api-input-group">
                      <label>API Key:</label>
                      <input type="password" id="qwenApiKeyInput" placeholder="è¯·è¾“å…¥é€šä¹‰åƒé—® API Key">
                    </div>
                    <div class="api-input-group">
                      <label>API URL:</label>
                      <input type="text" id="qwenApiUrlInput" placeholder="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" value="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions">
                    </div>
                    <div class="api-input-group">
                      <label>æ¨¡å‹ ID:</label>
                      <input type="text" id="qwenModelInput" placeholder="qwen-max" value="qwen-max" list="qwenModelOptions">
                    </div>
                    <button class="api-save-btn" onclick="saveAiConfig('qwen')">ä¿å­˜é…ç½®</button>
                  </div>
                  <button class="ai-analysis-btn" id="qwenAnalysisBtn" onclick="runAiAnalysis('qwen')" style="background: #ff6b35;">ä½¿ç”¨é€šä¹‰åƒé—®åˆ†æ</button>
                  <div id="qwenAiLoading" class="ai-loading hidden">æ­£åœ¨åˆ†æä¸­</div>
                  <div id="qwenAiResult" class="ai-result hidden">
                    <h4>é€šä¹‰åƒé—® åˆ†æç»“æœ</h4>
                    <div class="ai-result-content" id="qwenAiResultContent"></div>
                  </div>
                </div>
              </div>
              <datalist id="deepseekModelOptions">
                <option value="deepseek-chat">åŸºç¡€å¯¹è¯æ¨¡å‹ï¼ˆæ¨èï¼‰</option>
                <option value="deepseek-v3">V3 é«˜æ€§èƒ½æ¨¡å‹ï¼ˆ2024å¹´12æœˆå‘å¸ƒï¼‰</option>
                <option value="deepseek-reasoner">æ¨ç†æ¨¡å‹ï¼ˆé€»è¾‘æ¨ç†ï¼‰</option>
                <option value="deepseek-r1">R1 æ¨ç†æ¨¡å‹ï¼ˆ2025å¹´1æœˆå‘å¸ƒï¼‰</option>
                <option value="deepseek-coder">ä»£ç æ¨¡å‹</option>
              </datalist>
              <datalist id="kimiModelOptions">
                <option value="moonshot-v1-8k">8K ä¸Šä¸‹æ–‡ï¼ˆç»æµå‹ï¼‰</option>
                <option value="moonshot-v1-32k">32K ä¸Šä¸‹æ–‡ï¼ˆæ¨èï¼‰</option>
                <option value="moonshot-v1-128k">128K ä¸Šä¸‹æ–‡ï¼ˆé•¿æ–‡æ¡£ï¼‰</option>
                <option value="moonshot-v1-k2">K2 æ¨¡å‹ï¼ˆ320äº¿å‚æ•°ï¼Œéœ€ç¡®è®¤APIå¯ç”¨æ€§ï¼‰</option>
              </datalist>
              <datalist id="qwenModelOptions">
                <option value="qwen-turbo">Turbo å¿«é€Ÿæ¨¡å‹ï¼ˆç»æµå‹ï¼‰</option>
                <option value="qwen-plus">Plus å¹³è¡¡æ¨¡å‹</option>
                <option value="qwen-max">Max é«˜æ€§èƒ½æ¨¡å‹ï¼ˆæ¨èï¼Œæœ€ä½³æ€§èƒ½ï¼‰</option>
                <option value="qwen-max-longcontext">Max é•¿ä¸Šä¸‹æ–‡æ¨¡å‹</option>
              </datalist>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      // ==================== å¸¸é‡å®šä¹‰ ====================
      
      /** @constant {number} é˜²æŠ–å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ */
      const DEBOUNCE_DELAY = 300;
      
      /** @constant {number} æ—¥å†æ˜¾ç¤ºå‘¨æ•° */
      const CALENDAR_WEEKS = 4;
      
      /** @constant {number} æ¯å‘¨å¤©æ•° */
      const DAYS_PER_WEEK = 7;
      
      /** @constant {number} æ—¥å†æ¯å¤©æ˜¾ç¤ºçš„æœ€å¤§é¡¹ç›®æ•° */
      const MAX_ITEMS_PER_DAY = 7;
      
      /** @constant {number} æ—¥å†å•å…ƒæ ¼é«˜åº¦ï¼ˆåƒç´ ï¼‰ */
      const CALENDAR_DAY_HEIGHT = 750;
      
      /** @constant {number} æ—¥å†å•å…ƒæ ¼æœ€å°å®½åº¦ï¼ˆåƒç´ ï¼‰ */
      const CALENDAR_DAY_MIN_WIDTH = 180;
      
      /** @constant {number} æ—¶é—´æ ‡ç­¾å®½åº¦ï¼ˆåƒç´ ï¼‰ */
      const TIME_LABEL_WIDTH = 120;
      
      /** @constant {number} æœ€å¤§å¤±è´¥è®°å½•æ•°ï¼ˆç”¨äºç»Ÿè®¡ï¼‰ */
      const MAX_FAILED_RECORDS = 20;
      
      // è°ƒè¯•å‡½æ•°å·²ç»Ÿä¸€åˆ° vendor/debug-utils.js
      // ä½¿ç”¨ï¼šdebugLog(), debugWarn(), debugError()
      
      /** @constant {string} é»˜è®¤æ¨¡å¼ */
      const DEFAULT_MODE = '001';
      
      /** @constant {string} æ¨¡å¼ 365 */
      const MODE_365 = '365';
      
      /** @constant {string} æ¨¡å¼ 001 */
      const MODE_001 = '001';
      
      /** @constant {string} Excel æ–‡ä»¶ç±»å‹ */
      const EXCEL_MIME_TYPES = '.xlsx,.xls';
      
      /** @constant {string} Schedule Sheet å…³é”®è¯ */
      const SCHEDULE_SHEET_KEYWORD = 'schedule';
      
      /** @constant {number} 001 æ–‡ä»¶é»˜è®¤ Sheet ç´¢å¼• */
      const SHEET_INDEX_001 = 0;
      
      /** @constant {number} 365 æ–‡ä»¶é»˜è®¤ Sheet ç´¢å¼• */
      const SHEET_INDEX_365 = 1;
      
      /** @constant {string} æ—¥æœŸæ ¼å¼åˆ†éš”ç¬¦ */
      const DATE_SEPARATOR = '/';
      
      /** @constant {string} æ¸¯å£åˆ†éš”ç¬¦ */
      const PORT_SEPARATOR = 'ã€';
      
      // ==================== é”™è¯¯å¤„ç† ====================
      // æ³¨æ„ï¼šErrorType å’Œ showError/showSuccess å·²åœ¨ vendor/error-handler.js ä¸­å®šä¹‰
      // è¿™é‡Œåªæ·»åŠ é¡µé¢ç‰¹å®šçš„é”™è¯¯æ¶ˆæ¯
      
      // æ·»åŠ é¡µé¢ç‰¹å®šçš„é”™è¯¯æ¶ˆæ¯ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å—ï¼‰
      if (typeof addErrorMessage === 'function') {
        addErrorMessage(ErrorType.DATA_VALIDATION, 'NO_FILTERS', 'è¯·å…ˆé€‰æ‹©ç­›é€‰æ¡ä»¶');
        addErrorMessage(ErrorType.DATA_VALIDATION, 'NO_FILTERED_DATA', 'ç­›é€‰åæ²¡æœ‰å¯åˆ†æçš„æ•°æ®');
        addErrorMessage(ErrorType.DATA_VALIDATION, 'NO_DATA_FOR_ANALYSIS', 'æ²¡æœ‰å¯åˆ†æçš„æ•°æ®ï¼Œè¯·å…ˆåŠ è½½Excelæ–‡ä»¶å¹¶é€‰æ‹©ç­›é€‰æ¡ä»¶');
        addErrorMessage(ErrorType.API_ERROR, 'API_KEY_MISSING', 'è¯·å…ˆé…ç½® {provider} çš„ API Key');
        addErrorMessage(ErrorType.DOM_ERROR, 'ELEMENT_NOT_FOUND', 'æœªæ‰¾åˆ°å¿…è¦çš„é¡µé¢å…ƒç´ ï¼š{element}');
      }
      
      // è°ƒè¯•å‡½æ•°å·²ç»Ÿä¸€åˆ° vendor/debug-utils.js

      // èˆªçº¿åŒºåŸŸåˆ†ç±»è§„åˆ™ï¼ˆæŒ‰æŒ‡å®šé¡ºåºæ’åˆ—ï¼‰
      const regionMapping = {
        'ç¾è¥¿': ['é•¿æ»©', 'æ´›æ‰çŸ¶'],
        'ç¾ä¸œ': ['çº½çº¦'],
        'åŠ æ‹¿å¤§': ['æ¸©å“¥å'],
        'å¢¨è¥¿å“¥': ['æ›¼è¨å°¼çº¦', 'å¢¨è¥¿å“¥æ›¼è¨å°¼çº¦'],
        'ä¸­å—ç¾': ['å·´å°”åšäºš', 'è€ƒèµ›å¤š', 'åº“ç‰¹æ‰å°”'],
        'å—ç¾è¥¿': ['å¸ƒåŸƒçº³æ–‡å›¾æ‹‰', 'åœ£å®‰ä¸œå°¼å¥¥'],
        'å—ç¾ä¸œ': ['æ¡‘æ‰˜æ–¯'],
        'æ¬§åŸº': ['é¹¿ç‰¹ä¸¹', 'è´¹åˆ©å…‹æ–¯æ‰˜'],
        'åœ°è¥¿': ['å·´å¡ç½—é‚£', 'å·´å¡ç½—çº³', 'ç“¦ä¼¦è¥¿äºš'],
        'é»‘æµ·': ['ä¼Šæ–¯å¦å¸ƒå°”'],
        'ä¸­ä¸œ': ['æ°è´é˜¿é‡Œ', 'è¾¾æ›¼'],
        'çº¢æµ·': ['å‰è¾¾'],
        'å°å·´': ['å‰å¤§', 'å‰å¤§æ¸¯', 'ç§‘ä¼¦å¡', 'çº³ç“¦è¥¿ç“¦', 'é‚£ç“¦è¥¿ç“¦', 'æ¸…å¥ˆ'],
        'æ¾³æ´²': ['å¸ƒé‡Œæ–¯ç­'],
        'ä¸œé': ['è’™å·´è¨'],
        'å—é': ['å¾·ç­'],
        'è¥¿é': ['é»‘è§’', 'ç‰¹é©¬'],
        'é¦™æ¸¯': ['é¦™æ¸¯'],
        'å°æ¹¾': ['é«˜é›„'],
        'æ–°åŠ å¡': ['æ–°åŠ å¡'],
        'é©¬æ¥': ['å·´ç”Ÿè¥¿', 'å·´ç”ŸåŒ—', 'å·´è¥¿å¤å•', 'æ§ŸåŸ', 'ä¸¹æˆå¸•æ‹‰å¸•æ–¯'],
        'æ³°å›½': ['æ—æŸ¥ç­'],
        'è¶Šå—': ['ç›–æ¢…æ¸¯', 'ç›–ç¾', 'æµ·é˜²', 'èƒ¡å¿—æ˜', 'åŒå¥ˆ'],
        'æŸ¬åŸ”å¯¨': ['è¥¿å“ˆåŠªå…‹'],
        'å°å°¼': ['é›…åŠ è¾¾', 'æ³—æ°´'],
        'è²å¾‹å®¾': ['é©¬å°¼æ‹‰å—', 'é©¬å°¼æ‹‰åŒ—']
      };

      // æ‰€æœ‰46ä¸ªæ¸¯å£åˆ—è¡¨ï¼ˆæŒ‰ç…§èˆªçº¿åŒºåŸŸé¡ºåºæ’åˆ—ï¼‰
      const allPorts = [
        // ç¾è¥¿
        'é•¿æ»©', 'æ´›æ‰çŸ¶',
        // ç¾ä¸œ
        'çº½çº¦',
        // åŠ æ‹¿å¤§
        'æ¸©å“¥å',
        // å¢¨è¥¿å“¥
        'æ›¼è¨å°¼çº¦', 'å¢¨è¥¿å“¥æ›¼è¨å°¼çº¦',
        // ä¸­å—ç¾
        'å·´å°”åšäºš', 'è€ƒèµ›å¤š', 'åº“ç‰¹æ‰å°”',
        // å—ç¾è¥¿
        'å¸ƒåŸƒçº³æ–‡å›¾æ‹‰', 'åœ£å®‰ä¸œå°¼å¥¥',
        // å—ç¾ä¸œ
        'æ¡‘æ‰˜æ–¯',
        // æ¬§åŸº
        'é¹¿ç‰¹ä¸¹', 'è´¹åˆ©å…‹æ–¯æ‰˜',
        // åœ°è¥¿
        'å·´å¡ç½—é‚£', 'å·´å¡ç½—çº³', 'ç“¦ä¼¦è¥¿äºš',
        // é»‘æµ·
        'ä¼Šæ–¯å¦å¸ƒå°”',
        // ä¸­ä¸œ
        'æ°è´é˜¿é‡Œ', 'è¾¾æ›¼',
        // çº¢æµ·
        'å‰è¾¾',
        // å°å·´
        'å‰å¤§', 'å‰å¤§æ¸¯', 'ç§‘ä¼¦å¡', 'çº³ç“¦è¥¿ç“¦', 'é‚£ç“¦è¥¿ç“¦', 'æ¸…å¥ˆ',
        // æ¾³æ´²
        'å¸ƒé‡Œæ–¯ç­',
        // ä¸œé
        'è’™å·´è¨',
        // å—é
        'å¾·ç­',
        // è¥¿é
        'é»‘è§’', 'ç‰¹é©¬',
        // é¦™æ¸¯
        'é¦™æ¸¯',
        // å°æ¹¾
        'é«˜é›„',
        // æ–°åŠ å¡
        'æ–°åŠ å¡',
        // é©¬æ¥
        'å·´ç”Ÿè¥¿', 'å·´ç”ŸåŒ—', 'å·´è¥¿å¤å•', 'æ§ŸåŸ', 'ä¸¹æˆå¸•æ‹‰å¸•æ–¯',
        // æ³°å›½
        'æ—æŸ¥ç­',
        // è¶Šå—
        'ç›–æ¢…æ¸¯', 'ç›–ç¾', 'æµ·é˜²', 'èƒ¡å¿—æ˜', 'åŒå¥ˆ',
        // æŸ¬åŸ”å¯¨
        'è¥¿å“ˆåŠªå…‹',
        // å°å°¼
        'é›…åŠ è¾¾', 'æ³—æ°´',
        // è²å¾‹å®¾
        'é©¬å°¼æ‹‰å—', 'é©¬å°¼æ‹‰åŒ—'
      ];

      // æ¸¯å£åç§°åŒ¹é…è§„åˆ™ï¼ˆå¤„ç†ä¸åŒæ•°æ®æºçš„æ¸¯å£åç§°å·®å¼‚ï¼ŒæŒ‰æ¸¯å£é¡ºåºæ’åˆ—ï¼‰
      const portNameMapping = {
        // ç¾è¥¿
        'LONG BEACH': 'é•¿æ»©',
        'LONG BEACH, CA': 'é•¿æ»©',
        'LONG BEACH,CA': 'é•¿æ»©',
        'LONG BEACH CA': 'é•¿æ»©',
        'é•¿æ»©,åŠ åˆ©ç¦å°¼äºšå·': 'é•¿æ»©',
        'LOS ANGELES': 'æ´›æ‰çŸ¶',
        'LOS ANGELES, CA': 'æ´›æ‰çŸ¶',
        'LOS ANGELES,CA': 'æ´›æ‰çŸ¶',
        'LOS ANGELES CA': 'æ´›æ‰çŸ¶',
        'æ´›æ‰çŸ¶,åŠ åˆ©ç¦å°¼äºšå·': 'æ´›æ‰çŸ¶',
        // ç¾ä¸œ
        'NEW YORK': 'çº½çº¦',
        'NEW YORK,NY': 'çº½çº¦',
        'NEW YORK, NY': 'çº½çº¦',
        'NEW YORK NY': 'çº½çº¦',
        'çº½çº¦,çº½çº¦å·': 'çº½çº¦',
        // åŠ æ‹¿å¤§
        'VANCOUVER': 'æ¸©å“¥å',
        'VANCOUVER.BC': 'æ¸©å“¥å',
        'VANCOUVER,BC': 'æ¸©å“¥å',
        'VANCOUVER, BC': 'æ¸©å“¥å',
        'VANCOUVER BC': 'æ¸©å“¥å',
        // å¢¨è¥¿å“¥
        'MANZANILLO': 'æ›¼è¨å°¼çº¦',
        'MANZANILLO,MX': 'æ›¼è¨å°¼çº¦',
        'MANZANILLO, MX': 'æ›¼è¨å°¼çº¦',
        'MANZANILLO MX': 'æ›¼è¨å°¼çº¦',
        'å¢¨è¥¿å“¥æ›¼è¨å°¼çº¦': 'æ›¼è¨å°¼çº¦',
        // ä¸­å—ç¾
        'BALBOA': 'å·´å°”åšäºš',
        'BALBOA(å·´å°”åšäºš)': 'å·´å°”åšäºš',
        'CAUCEDO': 'è€ƒèµ›å¤š',
        'PUERTO QUETZAL': 'åº“ç‰¹æ‰å°”',
        // å—ç¾è¥¿
        'BUENAVENTURA': 'å¸ƒåŸƒçº³æ–‡å›¾æ‹‰',
        'BUENAVENTURA(å¸ƒåŸƒçº³æ–‡å›¾æ‹‰)': 'å¸ƒåŸƒçº³æ–‡å›¾æ‹‰',
        'SAN ANTONIO': 'åœ£å®‰ä¸œå°¼å¥¥',
        'SAN ANTONIO, CHILE': 'åœ£å®‰ä¸œå°¼å¥¥',
        'SAN ANTONIO,CHILE': 'åœ£å®‰ä¸œå°¼å¥¥',
        'SAN ANTONIO CHILE': 'åœ£å®‰ä¸œå°¼å¥¥',
        // å—ç¾ä¸œ
        'SANTOS': 'æ¡‘æ‰˜æ–¯',
        'SANTOS(æ¡‘æ‰˜æ–¯)': 'æ¡‘æ‰˜æ–¯',
        // æ¬§åŸº
        'ROTTERDAM': 'é¹¿ç‰¹ä¸¹',
        'ROTTERDAM,NL': 'é¹¿ç‰¹ä¸¹',
        'ROTTERDAM, NL': 'é¹¿ç‰¹ä¸¹',
        'ROTTERDAM NL': 'é¹¿ç‰¹ä¸¹',
        'FELIXSTOWE': 'è´¹åˆ©å…‹æ–¯æ‰˜',
        'FELIXSTOWE(è´¹åˆ©å…‹æ–¯æ‰˜)': 'è´¹åˆ©å…‹æ–¯æ‰˜',
        // åœ°è¥¿
        'BARCELONA': 'å·´å¡ç½—é‚£',
        'BARCELONA(å·´å¡ç½—çº³)': 'å·´å¡ç½—é‚£',
        'å·´å¡ç½—çº³': 'å·´å¡ç½—é‚£',
        'VALENCIA': 'ç“¦ä¼¦è¥¿äºš',
        'VALENCIA,ES': 'ç“¦ä¼¦è¥¿äºš',
        'VALENCIA, ES': 'ç“¦ä¼¦è¥¿äºš',
        'VALENCIA ES': 'ç“¦ä¼¦è¥¿äºš',
        // é»‘æµ·
        'ISTANBUL': 'ä¼Šæ–¯å¦å¸ƒå°”',
        'ISTANBUL(ä¼Šæ–¯å¦å¸ƒå°”)': 'ä¼Šæ–¯å¦å¸ƒå°”',
        // ä¸­ä¸œ
        'JEBEL ALI': 'æ°è´é˜¿é‡Œ',
        'JEBEL ALI(æ°è´é˜¿é‡Œ)': 'æ°è´é˜¿é‡Œ',
        'DAMMAM': 'è¾¾æ›¼',
        'DAMMAM(è¾¾æ›¼)': 'è¾¾æ›¼',
        // çº¢æµ·
        'JEDDAH': 'å‰è¾¾',
        'JEDDAH(å‰è¾¾)': 'å‰è¾¾',
        // å°å·´
        'CHATTOGRAM': 'å‰å¤§',
        'CHATTOGRAM(å‰å¤§æ¸¯)': 'å‰å¤§',
        'å‰å¤§æ¸¯': 'å‰å¤§',
        'COLOMBO': 'ç§‘ä¼¦å¡',
        'COLOMBO(ç§‘ä¼¦å¡)': 'ç§‘ä¼¦å¡',
        'NHAVA SHEVA': 'çº³ç“¦è¥¿ç“¦',
        'NHAVA SHEVA(é‚£ç“¦è¥¿ç“¦)': 'çº³ç“¦è¥¿ç“¦',
        'é‚£ç“¦è¥¿ç“¦': 'çº³ç“¦è¥¿ç“¦',
        'CHENNAI': 'æ¸…å¥ˆ',
        'CHENNAI(æ¸…å¥ˆ)': 'æ¸…å¥ˆ',
        // æ¾³æ´²
        'BRISBANE': 'å¸ƒé‡Œæ–¯ç­',
        'BRISBANE,AU': 'å¸ƒé‡Œæ–¯ç­',
        'BRISBANE, AU': 'å¸ƒé‡Œæ–¯ç­',
        'BRISBANE AU': 'å¸ƒé‡Œæ–¯ç­',
        'BRISBANE,AU(å¸ƒé‡Œæ–¯ç­)': 'å¸ƒé‡Œæ–¯ç­',
        // ä¸œé
        'MOMBASA': 'è’™å·´è¨',
        'MOMBASA(è’™å·´è¨)': 'è’™å·´è¨',
        // å—é
        'DURBAN': 'å¾·ç­',
        'DURBAN(å¾·ç­)': 'å¾·ç­',
        // è¥¿é
        'POINTE NOIRE': 'é»‘è§’',
        'POINTE NOIRE(é»‘è§’)': 'é»‘è§’',
        'TEMA': 'ç‰¹é©¬',
        'TEMA(ç‰¹é©¬)': 'ç‰¹é©¬',
        // é¦™æ¸¯
        'HONG KONG': 'é¦™æ¸¯',
        'HONG KONG(é¦™æ¸¯)': 'é¦™æ¸¯',
        // å°æ¹¾
        'KAOHSIUNG': 'é«˜é›„',
        'KAOHSIUNG(é«˜é›„)': 'é«˜é›„',
        // æ–°åŠ å¡
        'SINGAPORE': 'æ–°åŠ å¡',
        'SINGAPORE(æ–°åŠ å¡)': 'æ–°åŠ å¡',
        // é©¬æ¥
        'PORT KELANG N': 'å·´ç”ŸåŒ—',
        'PORT KELANG N(å·´ç”ŸåŒ—)': 'å·´ç”ŸåŒ—',
        'PORT KELANG NORTH': 'å·´ç”ŸåŒ—',
        'å·´ç”ŸåŒ—': 'å·´ç”ŸåŒ—',
        'PORT KELANG S': 'å·´ç”Ÿè¥¿',
        'PORT KELANG S(å·´ç”Ÿè¥¿)': 'å·´ç”Ÿè¥¿',
        'PORT KELANG SOUTH': 'å·´ç”Ÿè¥¿',
        'å·´ç”Ÿè¥¿': 'å·´ç”Ÿè¥¿',
        'PASIR GUDANG': 'å·´è¥¿å¤å•',
        'PASIR GUDANG(å·´è¥¿å¤å•)': 'å·´è¥¿å¤å•',
        'PENANG': 'æ§ŸåŸ',
        'PENANG(æ§ŸåŸ)': 'æ§ŸåŸ',
        'TANJUNG PELEPAS': 'ä¸¹æˆå¸•æ‹‰å¸•æ–¯',
        'TANJUNG PELEPAS(ä¸¹æˆå¸•æ‹‰å¸•æ–¯)': 'ä¸¹æˆå¸•æ‹‰å¸•æ–¯',
        // æ³°å›½
        'LAEM CHABANG': 'æ—æŸ¥ç­',
        'LAEM CHABANG(æ—æŸ¥ç­)': 'æ—æŸ¥ç­',
        // è¶Šå—
        'CAI MEP': 'ç›–æ¢…æ¸¯',
        'CAI MEP, VUNG TAU': 'ç›–æ¢…æ¸¯',
        'CAI MEP,VUNG TAU': 'ç›–æ¢…æ¸¯',
        'CAI MEP, VUNG TAU(ç›–æ¢…æ¸¯,å¤´é¡¿)': 'ç›–æ¢…æ¸¯',
        'ç›–æ¢…æ¸¯,å¤´é¡¿': 'ç›–æ¢…æ¸¯',
        'ç›–æ¢…æ¸¯, å¤´é¡¿': 'ç›–æ¢…æ¸¯',
        'ç›–ç¾æ¸¯,å¤´é¡¿': 'ç›–æ¢…æ¸¯',
        'ç›–ç¾æ¸¯, å¤´é¡¿': 'ç›–æ¢…æ¸¯',
        'ç›–ç¾': 'ç›–æ¢…æ¸¯',
        'HAIPHONG': 'æµ·é˜²',
        'HAIPHONG(æµ·é˜²)': 'æµ·é˜²',
        'HOCHIMINH': 'èƒ¡å¿—æ˜',
        'HO CHI MINH': 'èƒ¡å¿—æ˜',
        'HOCHIMINH(èƒ¡å¿—æ˜)': 'èƒ¡å¿—æ˜',
        'DONG NAI': 'åŒå¥ˆ',
        'DONG NAI(åŒå¥ˆ)': 'åŒå¥ˆ',
        // æŸ¬åŸ”å¯¨
        'SIHANOUKVILLE': 'è¥¿å“ˆåŠªå…‹',
        'SIHANOUKVILLE(è¥¿å“ˆåŠªå…‹)': 'è¥¿å“ˆåŠªå…‹',
        // å°å°¼
        'JAKARTA': 'é›…åŠ è¾¾',
        'JAKARTA(é›…åŠ è¾¾)': 'é›…åŠ è¾¾',
        'SURABAYA': 'æ³—æ°´',
        'SURABAYA(æ³—æ°´)': 'æ³—æ°´',
        // è²å¾‹å®¾
        'MANILA N': 'é©¬å°¼æ‹‰åŒ—',
        'MANILA N(é©¬å°¼æ‹‰åŒ—)': 'é©¬å°¼æ‹‰åŒ—',
        'MANILA NORTH': 'é©¬å°¼æ‹‰åŒ—',
        'MANILA S': 'é©¬å°¼æ‹‰å—',
        'MANILA S(é©¬å°¼æ‹‰å—)': 'é©¬å°¼æ‹‰å—',
        'MANILA SOUTH': 'é©¬å°¼æ‹‰å—'
      };

      // è°ƒè¯•å‡½æ•°å·²ç»Ÿä¸€åˆ° vendor/debug-utils.js
      // ä½¿ç”¨ï¼šdebugLog(), debugWarn(), debugError()

      /**
       * åº”ç”¨ç¨‹åºçŠ¶æ€ç®¡ç†å¯¹è±¡
       * @type {Object}
       * @property {Array<Object>|null} data001 - 001æ¨¡å¼æ•°æ®
       * @property {Array<Object>|null} data365 - 365æ¨¡å¼æ•°æ®
       * @property {string} currentMode - å½“å‰æ˜¾ç¤ºæ¨¡å¼ï¼ˆ'001' æˆ– '365'ï¼‰
       * @property {Array<string>} selectedRegions - é€‰ä¸­çš„èˆªçº¿åŒºåŸŸ
       * @property {Array<string>} selectedCarriers - é€‰ä¸­çš„èˆ¹å…¬å¸
       * @property {Array<string>} selectedPorts - é€‰ä¸­çš„æ¸¯å£
       * @property {Set<string>} allCarriers001 - 001æ¨¡å¼æ‰€æœ‰èˆ¹å…¬å¸
       * @property {Set<string>} allCarriers365 - 365æ¨¡å¼æ‰€æœ‰èˆ¹å…¬å¸
       * @property {Set<string>} allPorts001 - 001æ¨¡å¼æ‰€æœ‰æ¸¯å£
       * @property {Set<string>} allPorts365 - 365æ¨¡å¼æ‰€æœ‰æ¸¯å£
       */
      const state = {
        data001: null,
        data365: null,
        currentMode: DEFAULT_MODE,
        selectedRegions: [],
        selectedCarriers: [],
        selectedPorts: [],
        allCarriers001: new Set(),
        allCarriers365: new Set(),
        allPorts001: new Set(),
        allPorts365: new Set()
      };

      // äº‹ä»¶ç›‘å¬å™¨ç®¡ç†ï¼ˆç”¨äºæ¸…ç†ï¼‰
      const eventListeners = {
        handlers: new Map(),
        add(element, event, handler, options) {
          if (!element) return;
          const key = `${element.constructor.name}_${event}_${handler.name || 'anonymous'}`;
          element.addEventListener(event, handler, options);
          if (!this.handlers.has(element)) {
            this.handlers.set(element, []);
          }
          this.handlers.get(element).push({ event, handler, options, key });
        },
        remove(element, event, handler) {
          if (!element) return;
          element.removeEventListener(event, handler);
          const listeners = this.handlers.get(element);
          if (listeners) {
            const index = listeners.findIndex(l => l.event === event && l.handler === handler);
            if (index > -1) {
              listeners.splice(index, 1);
            }
          }
        },
        removeAll(element) {
          if (!element) return;
          const listeners = this.handlers.get(element);
          if (listeners) {
            listeners.forEach(({ event, handler, options }) => {
              element.removeEventListener(event, handler, options);
            });
            this.handlers.delete(element);
          }
        },
        cleanup() {
          this.handlers.forEach((listeners, element) => {
            listeners.forEach(({ event, handler, options }) => {
              element.removeEventListener(event, handler, options);
            });
          });
          this.handlers.clear();
        }
      };

      /**
       * é˜²æŠ–å‡½æ•° - å»¶è¿Ÿæ‰§è¡Œå‡½æ•°ï¼Œç›´åˆ°åœæ­¢è°ƒç”¨åç­‰å¾…æŒ‡å®šæ—¶é—´
       * @param {Function} func - è¦é˜²æŠ–çš„å‡½æ•°
       * @param {number} [wait=DEBOUNCE_DELAY] - ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
       * @returns {Function} é˜²æŠ–åçš„å‡½æ•°
       */
      function debounce(func, wait = DEBOUNCE_DELAY) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      /**
       * DOM å…ƒç´ ç¼“å­˜å¯¹è±¡
       * æ‰€æœ‰ DOM æŸ¥è¯¢ç»“æœéƒ½ç¼“å­˜åœ¨è¿™é‡Œï¼Œé¿å…é‡å¤æŸ¥è¯¢
       * @type {Object<string, HTMLElement|NodeList>}
       */
      const dom = {
        file001: null,
        file365: null,
        status001: null,
        status365: null,
        modeBtns: null,
        regionFilter: null,
        regionSearch: null,
        carrierFilter: null,
        carrierSearch: null,
        portFilter: null,
        portSearch: null,
        calendarContainer: null,
        calendarBody: null,
        emptyMessage: null,
        exportPdfBtn: null,
        aiAnalysisSection: null,
        emptyAiMessage: null,
        aiConfigSection: null
      };
      
      /**
       * åˆå§‹åŒ– DOM å…ƒç´ ç¼“å­˜
       * åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼Œç¼“å­˜æ‰€æœ‰éœ€è¦çš„ DOM å…ƒç´ 
       */
      function initDOMCache() {
        dom.file001 = document.getElementById('file001');
        dom.file365 = document.getElementById('file365');
        dom.status001 = document.getElementById('status001');
        dom.status365 = document.getElementById('status365');
        dom.modeBtns = document.querySelectorAll('.mode-btn');
        dom.regionFilter = document.getElementById('regionFilter');
        dom.regionSearch = document.getElementById('regionSearch');
        dom.carrierFilter = document.getElementById('carrierFilter');
        dom.carrierSearch = document.getElementById('carrierSearch');
        dom.portFilter = document.getElementById('portFilter');
        dom.portSearch = document.getElementById('portSearch');
        dom.calendarContainer = document.getElementById('calendarContainer');
        dom.calendarBody = document.getElementById('calendarBody');
        dom.emptyMessage = document.getElementById('emptyMessage');
        dom.exportPdfBtn = document.getElementById('exportPdfBtn');
        dom.monthlySummaryContainer = document.getElementById('monthlySummaryContainer');
        dom.monthlySummaryTable = document.getElementById('monthlySummaryTable');
        dom.monthlySummaryEmptyMessage = document.getElementById('monthlySummaryEmptyMessage');
        dom.aiAnalysisSection = document.getElementById('aiAnalysisSection');
        dom.emptyAiMessage = document.getElementById('emptyAiMessage');
        dom.aiConfigSection = document.getElementById('aiConfigSection');
        
        // éªŒè¯å¿…è¦çš„ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨
        const requiredElements = [
          { key: 'file001', name: '001æ–‡ä»¶è½½å…¥' },
          { key: 'file365', name: '365æ–‡ä»¶è½½å…¥' },
          { key: 'regionFilter', name: 'åŒºåŸŸç­›é€‰å™¨' },
          { key: 'carrierFilter', name: 'èˆ¹å…¬å¸ç­›é€‰å™¨' },
          { key: 'portFilter', name: 'æ¸¯å£ç­›é€‰å™¨' },
          { key: 'calendarContainer', name: 'æ—¥å†å®¹å™¨' },
          { key: 'calendarBody', name: 'æ—¥å†ä¸»ä½“' }
        ];
        
        const missingElements = requiredElements.filter(({ key }) => !dom[key]);
        if (missingElements.length > 0) {
          const missingNames = missingElements.map(e => e.name).join('ã€');
          showError(ErrorType.DOM_ERROR, 'ELEMENT_NOT_FOUND', { element: missingNames });
          debugWarn('ç¼ºå°‘å¿…è¦çš„ DOM å…ƒç´ :', missingElements);
        }
      }

      /**
       * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
       * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨ã€å¡«å……ç­›é€‰å™¨é€‰é¡¹ç­‰
       */
      function init() {
        // åˆå§‹åŒ– DOM ç¼“å­˜
        initDOMCache();
        // å¡«å……èˆªçº¿åŒºåŸŸé€‰é¡¹
        const regions = Object.keys(regionMapping);
        regions.forEach(region => {
          const option = document.createElement('option');
          option.value = region;
          option.textContent = region;
          dom.regionFilter.appendChild(option);
        });

        // å¡«å……æ¸¯å£é€‰é¡¹
        allPorts.forEach(port => {
          const option = document.createElement('option');
          option.value = port;
          option.textContent = port;
          dom.portFilter.appendChild(option);
        });

        // äº‹ä»¶ç›‘å¬ï¼ˆä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨ç®¡ç†ï¼‰
        const handleFile001Change = (e) => handleFileUpload(e, '001');
        const handleFile365Change = (e) => handleFileUpload(e, '365');
        eventListeners.add(dom.file001, 'change', handleFile001Change);
        eventListeners.add(dom.file365, 'change', handleFile365Change);
        
        dom.modeBtns.forEach(btn => {
          const handleModeClick = () => {
            const mode = btn.dataset.mode;
            if (mode !== state.currentMode) {
              state.currentMode = mode;
              dom.modeBtns.forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              updateCarrierFilter();
              renderCalendar();
              renderMonthlySummary(); // æ¸²æŸ“æœˆåº¦æ±‡æ€»è¡¨æ ¼
              updateAiModuleVisibility(); // æ›´æ–° AI æ¨¡å—å¯è§æ€§
            }
          };
          eventListeners.add(btn, 'click', handleModeClick);
        });

        eventListeners.add(dom.regionFilter, 'change', handleFilterChange);
        eventListeners.add(dom.carrierFilter, 'change', handleFilterChange);
        eventListeners.add(dom.portFilter, 'change', handleFilterChange);

        // æœç´¢åŠŸèƒ½ï¼ˆæ·»åŠ é˜²æŠ–ï¼‰
        const handleRegionSearch = debounce((e) => filterOptions('region', e.target.value));
        const handleCarrierSearch = debounce((e) => filterOptions('carrier', e.target.value));
        const handlePortSearch = debounce((e) => filterOptions('port', e.target.value));
        eventListeners.add(dom.regionSearch, 'input', handleRegionSearch);
        eventListeners.add(dom.carrierSearch, 'input', handleCarrierSearch);
        eventListeners.add(dom.portSearch, 'input', handlePortSearch);

        // ç­›é€‰å™¨æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.filter-btn').forEach(btn => {
          const handleFilterBtnClick = () => {
            const filterType = btn.dataset.filter;
            const action = btn.dataset.action;
            handleFilterAction(filterType, action);
          };
          eventListeners.add(btn, 'click', handleFilterBtnClick);
        });

        // å¯¼å‡ºPDFæŒ‰é’®ï¼ˆä½¿ç”¨ç¼“å­˜çš„DOMå…ƒç´ ï¼‰
        if (dom.exportPdfBtn) {
          eventListeners.add(dom.exportPdfBtn, 'click', handleExportPdf);
        }
      }

      /**
       * å¤„ç†ç­›é€‰å™¨æŒ‰é’®æ“ä½œ
       * @param {string} filterType - ç­›é€‰ç±»å‹ï¼ˆ'region', 'carrier', 'port'ï¼‰
       * @param {string} action - æ“ä½œç±»å‹ï¼ˆ'select-all', 'clear-all'ï¼‰
       */
      function handleFilterAction(filterType, action) {
        let select;
        if (filterType === 'region') select = dom.regionFilter;
        else if (filterType === 'carrier') select = dom.carrierFilter;
        else select = dom.portFilter;

        if (action === 'select-all') {
          // å…¨éƒ¨é€‰æ‹©ï¼ˆåªé€‰æ‹©å¯è§çš„é€‰é¡¹ï¼‰
          Array.from(select.options).forEach(option => {
            if (!option.classList.contains('hidden') && option.style.display !== 'none') {
              option.selected = true;
            }
          });
        } else if (action === 'clear-all') {
          // æ¸…é™¤é€‰æ‹©
          Array.from(select.options).forEach(option => {
            option.selected = false;
          });
        }

        // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°ç­›é€‰
        select.dispatchEvent(new Event('change'));
      }

      // æœç´¢ç­›é€‰é€‰é¡¹
      function filterOptions(type, searchText) {
        const searchLower = searchText.toLowerCase();
        let select;
        if (type === 'region') select = dom.regionFilter;
        else if (type === 'carrier') select = dom.carrierFilter;
        else select = dom.portFilter;

        Array.from(select.options).forEach(option => {
          const text = option.textContent.toLowerCase();
          if (text.includes(searchLower)) {
            option.classList.remove('hidden');
          } else {
            option.classList.add('hidden');
          }
        });
      }

      // å¤„ç†æ–‡ä»¶è½½å…¥
      async function handleFileUpload(event, mode) {
        const file = event.target.files?.[0];
        if (!file) return;

        if (typeof window.XLSX === "undefined") {
          showError(ErrorType.FILE_LOAD, 'XLSX_NOT_LOADED');
          return;
        }

        const statusEl = mode === '001' ? dom.status001 : dom.status365;
        const filePrefix = mode === '001' ? '001-03æ–‡ä»¶' : '365-03æ–‡ä»¶';
        statusEl.textContent = `${filePrefix}è§£æä¸­...`;

        try {
          const data = await file.arrayBuffer();
          // å¯¹äº001æ–‡ä»¶ï¼Œä¸ä½¿ç”¨cellDates: trueï¼Œå› ä¸ºå¯èƒ½æ—¥æœŸæ ¼å¼ä¸ä¸€è‡´
          // ä½¿ç”¨rawæ¨¡å¼è¯»å–ï¼Œç„¶åæ‰‹åŠ¨è§£ææ—¥æœŸ
          const workbook = XLSX.read(data, { 
            type: "array", 
            cellDates: false,  // æ”¹ä¸ºfalseï¼Œæ‰‹åŠ¨è§£ææ—¥æœŸ
            cellNF: false, 
            cellText: false,
            dateNF: 'yyyy-mm-dd'  // æŒ‡å®šæ—¥æœŸæ ¼å¼ï¼ˆå¦‚æœExcelä¸­æœ‰æ ¼å¼ï¼‰
          });
          
          // æ ¹æ®æ¨¡å¼é€‰æ‹©æ­£ç¡®çš„sheet
          let sheetName;
          if (mode === MODE_001) {
            // 001-03æ–‡ä»¶ï¼šç¬¬ä¸€ä¸ªsheetæ˜¯scheduleï¼ˆç´¢å¼•0ï¼‰
            // ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€ä¸ªsheetï¼Œå¦‚æœç¬¬ä¸€ä¸ªsheetåç§°åŒ…å«scheduleåˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä¹Ÿä½¿ç”¨ç¬¬ä¸€ä¸ª
            if (workbook.SheetNames.length > 0) {
              const firstSheet = workbook.SheetNames[0];
              // å¦‚æœç¬¬ä¸€ä¸ªsheetåç§°åŒ…å«scheduleï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä¹Ÿä½¿ç”¨ç¬¬ä¸€ä¸ªsheet
              if (firstSheet.toLowerCase().includes('schedule')) {
                sheetName = firstSheet;
              } else {
                // æŸ¥æ‰¾æ˜¯å¦æœ‰å…¶ä»–sheetåŒ…å«scheduleï¼Œå¦‚æœæœ‰ä¸”æ˜¯ç¬¬ä¸€ä¸ªï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªsheet
                const scheduleSheet = workbook.SheetNames.find(name => 
                  name.toLowerCase().includes('schedule')
                );
                sheetName = scheduleSheet || firstSheet;
              }
            } else {
              // ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å—
              const noSheetsMsg = typeof getErrorMessage === 'function'
                  ? getErrorMessage(ErrorType.FILE_LOAD, 'NO_SHEETS')
                  : 'Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å·¥ä½œè¡¨';
              throw new Error(noSheetsMsg);
            }
            debugLog('001æ¨¡å¼é€‰æ‹©çš„sheet:', sheetName, 'æ‰€æœ‰sheet:', workbook.SheetNames);
          } else {
            // 365-03æ–‡ä»¶ï¼šç¬¬äºŒä¸ªsheetæ˜¯schedule
            const scheduleSheet = workbook.SheetNames.find(name => 
              name.toLowerCase().includes(SCHEDULE_SHEET_KEYWORD)
            );
            if (scheduleSheet) {
              sheetName = scheduleSheet;
            } else if (workbook.SheetNames.length > SHEET_INDEX_365) {
              // å¦‚æœæ‰¾ä¸åˆ°scheduleï¼Œä½¿ç”¨ç¬¬äºŒä¸ªsheet
              sheetName = workbook.SheetNames[SHEET_INDEX_365];
            } else {
              // å¦‚æœåªæœ‰ä¸€ä¸ªsheetï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
              sheetName = workbook.SheetNames[SHEET_INDEX_001];
            }
            debugLog('365æ¨¡å¼é€‰æ‹©çš„sheet:', sheetName, 'æ‰€æœ‰sheet:', workbook.SheetNames);
          }
          
          const sheet = workbook.Sheets[sheetName];
          // ä½¿ç”¨ raw: true æ¥è·å–åŸå§‹å€¼ï¼ŒåŒ…æ‹¬æ—¥æœŸåºåˆ—å·
          const jsonData = XLSX.utils.sheet_to_json(sheet, { raw: true, defval: null });

          // è§£ææ•°æ®ï¼ˆä½¿ç”¨ä¸åŒçš„è§£ææ–¹æ³•ï¼‰
          const parsedData = mode === MODE_001 ? parseExcelData001(jsonData) : parseExcelData365(jsonData);
          
          if (mode === MODE_001) {
            state.data001 = parsedData;
          } else {
            state.data365 = parsedData;
          }

          const filePrefix = mode === '001' ? '001-03æ–‡ä»¶' : '365-03æ–‡ä»¶';
          statusEl.textContent = `${filePrefix}å·²åŠ è½½ ${parsedData.length} æ¡è®°å½•`;
          
          // æ›´æ–°ç­›é€‰å™¨ï¼ˆè”åŠ¨æ›´æ–°ï¼‰
          updateRegionFilter();
          updateCarrierFilter();
          updatePortFilter();
          renderCalendar();
          renderMonthlySummary(); // æ¸²æŸ“æœˆåº¦æ±‡æ€»è¡¨æ ¼
          updateAiModuleVisibility(); // æ›´æ–° AI æ¨¡å—å¯è§æ€§
        } catch (error) {
          debugError('è§£ææ–‡ä»¶å¤±è´¥:', error);
          const filePrefix = mode === '001' ? '001-03æ–‡ä»¶' : '365-03æ–‡ä»¶';
          statusEl.textContent = `${filePrefix}åŠ è½½å¤±è´¥`;
          showError(ErrorType.FILE_PARSE, 'PARSE_FAILED', {}, error);
        }
      }

      // ==================== å…¬å…±è§£æå·¥å…·å‡½æ•° ====================
      
      /**
       * å°†Excelåˆ—å­—æ¯è½¬æ¢ä¸ºç´¢å¼•ï¼ˆA=0, B=1, ..., Z=25, AA=26, ...ï¼‰
       * @param {string} letter - åˆ—å­—æ¯ï¼ˆå¦‚ 'A', 'B', 'AA'ï¼‰
       * @returns {number|null} åˆ—ç´¢å¼•ï¼Œå¦‚æœæ— æ•ˆåˆ™è¿”å› null
       */
      function columnLetterToIndex(letter) {
        if (!letter) return null;
        let index = 0;
        const up = letter.trim().toUpperCase();
        for (let i = 0; i < up.length; i++) {
          const charCode = up.charCodeAt(i);
          if (charCode < 65 || charCode > 90) return null;
          index = index * 26 + (charCode - 64);
        }
        return index - 1;
      }

      /**
       * åŒ¹é…åˆ—åï¼ˆæ£€æŸ¥å•ä¸ªå…³é”®è¯ï¼‰
       * @param {string} key - è¦åŒ¹é…çš„åˆ—å
       * @param {string} keyword - å…³é”®è¯
       * @returns {boolean} æ˜¯å¦åŒ¹é…
       */
      function matchesKeyword(key, keyword) {
        if (!key || !keyword) return false;
        const lowerKey = String(key).toLowerCase();
        const lowerKeyword = String(keyword).toLowerCase();
        return lowerKey.includes(lowerKeyword);
      }

      /**
       * é€šç”¨æ•°æ®è¡Œè§£æå‡½æ•°ï¼ˆæŠ½å–å…¬å…±é€»è¾‘ï¼‰
       * @param {Object} row - Excelè¡Œæ•°æ®å¯¹è±¡
       * @param {Object} config - åˆ—é…ç½®å¯¹è±¡
       * @param {string} mode - è§£ææ¨¡å¼ï¼ˆ'001' æˆ– '365'ï¼‰
       * @returns {Object|null} è§£æåçš„æ•°æ®å¯¹è±¡ï¼Œå¦‚æœæ— æ•ˆåˆ™è¿”å› null
       */
      function parseDataRow(row, config, mode) {
        const {
          portCol,
          carrierCol,
          dateCol,
          vesselCol,
          shipTypeCol,
          weekdayCol,
          voyageDaysCol,
          originTerminalCol,
          destTerminalCol,
          routeIdCol,
          vesselNameCol,
          yearCol,
          routePathCol
        } = config;

        // æå–åŸºç¡€å­—æ®µ
        const rawPort = row[portCol];
        const port = normalizePortName(rawPort ? String(rawPort).trim() : '');
        const carrier = row[carrierCol] ? String(row[carrierCol]).trim() : '';
        const vessel = vesselCol && row[vesselCol] ? String(row[vesselCol]).trim() : '';
        const shipType = shipTypeCol && row[shipTypeCol] ? String(row[shipTypeCol]).trim() : '';

        // éªŒè¯å¿…è¦å­—æ®µ
        if (!port || !allPorts.includes(port)) return null;
        if (!carrier) return null;

        // è§£ææ—¥æœŸ
        const rawDate = row[dateCol];
        const date = parseDate(rawDate);
        if (!date || isNaN(date.getTime())) return null;

        // æå–é¢å¤–å­—æ®µ
        const weekday = weekdayCol && row[weekdayCol] ? String(row[weekdayCol]).trim() : '';
        const voyageDays = voyageDaysCol && row[voyageDaysCol] ? String(row[voyageDaysCol]).trim() : '';
        const originTerminal = originTerminalCol && row[originTerminalCol] ? String(row[originTerminalCol]).trim() : '';
        
        // ç›®çš„æ¸¯ç å¤´å¤„ç†ï¼ˆ001æ¨¡å¼ç‰¹æ®Šå¤„ç†ï¼šåªå–/å‰çš„éƒ¨åˆ†ï¼‰
        let destTerminal = '';
        if (destTerminalCol && row[destTerminalCol]) {
          const destTerminalRaw = String(row[destTerminalCol]).trim();
          if (mode === MODE_001) {
            destTerminal = destTerminalRaw.includes(DATE_SEPARATOR) ? destTerminalRaw.split(DATE_SEPARATOR)[0].trim() : destTerminalRaw;
          } else {
            destTerminal = destTerminalRaw;
          }
        }

        // æå–èˆªçº¿IDï¼ˆ001æ¨¡å¼ï¼šCåˆ—ï¼Œ365æ¨¡å¼ï¼šGåˆ—ï¼‰
        // æ¸…ç†èˆªçº¿IDï¼šå»é™¤æ— æ•ˆå­—ç¬¦ï¼Œåªä¿ç•™æ•°å­—ã€å­—æ¯å’Œå¸¸è§åˆ†éš”ç¬¦
        let routeId = '';
        if (routeIdCol && row[routeIdCol]) {
          const rawRouteId = String(row[routeIdCol]).trim();
          // åªä¿ç•™æ•°å­—ã€å­—æ¯ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿ï¼Œè¿‡æ»¤æ‰ä¹±ç å’Œç‰¹æ®Šå­—ç¬¦
          const cleaned = rawRouteId.replace(/[^\w\-]/g, '');
          // å¦‚æœæ¸…ç†åè¿˜æœ‰æœ‰æ•ˆå†…å®¹ï¼ˆè‡³å°‘åŒ…å«æ•°å­—æˆ–å­—æ¯ï¼‰ï¼Œæ‰ä½¿ç”¨
          if (cleaned && /[0-9A-Za-z]/.test(cleaned)) {
            routeId = cleaned;
          }
        }

        // æ„å»ºåŸºç¡€æ•°æ®å¯¹è±¡
        const baseData = {
          port,
          carrier,
          date,
          vessel,
          shipType,
          weekday,
          voyageDays,
          originTerminal,
          destTerminal,
          mode,
          routeId
        };

        // 365æ¨¡å¼ç‰¹æœ‰å­—æ®µ
        if (mode === MODE_365) {
          baseData.vesselName = vesselNameCol && row[vesselNameCol] ? String(row[vesselNameCol]).trim() : '';
          baseData.year = yearCol && row[yearCol] ? String(row[yearCol]).trim() : '';
          baseData.routePath = routePathCol && row[routePathCol] ? String(row[routePathCol]).trim() : '';
        }

        return baseData;
      }

      // è§£æExcelæ•°æ® - 001æ–‡ä»¶ä¸“ç”¨
      function parseExcelData001(jsonData) {
        if (!jsonData || jsonData.length === 0) return [];

        const firstRow = jsonData[0];
        const columnKeys = Object.keys(firstRow);

        const getColumnKey = (keywords, fallbackLetter = null) => {
          const key = columnKeys.find(col => 
            keywords.some(keyword => matchesKeyword(col, keyword))
          );
          if (key) return key;
          if (fallbackLetter) {
            const idx = columnLetterToIndex(fallbackLetter);
            if (idx !== null && columnKeys[idx]) {
              return columnKeys[idx];
            }
          }
          return null;
        };

        // 001æ–‡ä»¶åˆ—å®šä¹‰ï¼ˆå‚ç…§365æ¨¡å¼ï¼Œä½¿ç”¨ç´¢å¼•ä½œä¸ºfallbackï¼‰
        const portCol = getColumnKey(['æ¸¯å£', 'ç›®çš„æ¸¯', 'pod'], 'B'); // Båˆ—
        const carrierCol = getColumnKey(['å…±èˆ±èˆ¹å…¬å¸', 'å…±èˆ±', 'èˆ¹å…¬å¸'], 'G'); // Gåˆ—
        
        // èˆªçº¿IDï¼šå‚ç…§365æ¨¡å¼ï¼Œä½¿ç”¨ç´¢å¼•2ï¼ˆCåˆ—ï¼‰ä½œä¸ºfallback
        const cColIndex = columnLetterToIndex('C');
        const routeIdCol = getColumnKey(['èˆªçº¿id', 'èˆªçº¿ID', 'route id', 'group_id', 'groupid'], 'C') || 
                          (cColIndex !== null && columnKeys[cColIndex] ? columnKeys[cColIndex] : null); // Cåˆ—ï¼ˆç´¢å¼•2ï¼‰- èˆªçº¿ID
        // å¼ºåˆ¶ä½¿ç”¨Måˆ—ï¼ˆç´¢å¼•12ï¼‰ä½œä¸ºæ—¥æœŸåˆ—ï¼Œé¿å…å…³é”®è¯åŒ¹é…åˆ°é”™è¯¯åˆ—
        const mColIndexForDate = columnLetterToIndex('M');
        const dateCol = (mColIndexForDate !== null && columnKeys[mColIndexForDate]) ? columnKeys[mColIndexForDate] : getColumnKey(['èˆ¹æœŸ', 'å¼€èˆ¹', 'ç¦»æ¸¯', 'etd'], 'M'); // Måˆ—
        // å¼ºåˆ¶ä½¿ç”¨Kåˆ—ï¼ˆç´¢å¼•10ï¼‰ä½œä¸ºèˆ¹åèˆªæ¬¡åˆ—ï¼Œé¿å…å…³é”®è¯åŒ¹é…åˆ°é”™è¯¯åˆ—ï¼ˆå¦‚Iåˆ—ï¼‰
        const kColIndex = columnLetterToIndex('K');
        const vesselCol = (kColIndex !== null && columnKeys[kColIndex]) ? columnKeys[kColIndex] : getColumnKey(['èˆ¹å', 'èˆªæ¬¡', 'vessel'], 'K'); // Kåˆ— - èˆ¹åèˆªæ¬¡
        // å¼ºåˆ¶ä½¿ç”¨Låˆ—ï¼ˆç´¢å¼•11ï¼‰ä½œä¸ºèˆ¹å‹åˆ—
        const lColIndex = columnLetterToIndex('L');
        const shipTypeCol = (lColIndex !== null && columnKeys[lColIndex]) ? columnKeys[lColIndex] : null; // Låˆ— - èˆ¹å‹
        
        // 001æ¨¡å¼æ‚¬åœæ¡†é¢å¤–åˆ—ï¼šEã€Fã€Pã€Q
        const eColIndex = columnLetterToIndex('E');
        const weekdayCol = (eColIndex !== null && columnKeys[eColIndex]) ? columnKeys[eColIndex] : null; // Eåˆ— - æ ‡å‡†å¼€èˆªæ—¥
        const fColIndex = columnLetterToIndex('F');
        const voyageDaysCol = (fColIndex !== null && columnKeys[fColIndex]) ? columnKeys[fColIndex] : null; // Fåˆ— - æ ‡å‡†èˆªç¨‹
        const pColIndex = columnLetterToIndex('P');
        const originTerminalCol = (pColIndex !== null && columnKeys[pColIndex]) ? columnKeys[pColIndex] : null; // Påˆ— - èµ·è¿æ¸¯ç å¤´
        const qColIndex = columnLetterToIndex('Q');
        const destTerminalCol = (qColIndex !== null && columnKeys[qColIndex]) ? columnKeys[qColIndex] : null; // Qåˆ— - ç›®çš„æ¸¯ç å¤´

        // è°ƒè¯•ï¼šæ˜¾ç¤ºåˆ—æ˜ å°„ä¿¡æ¯ï¼ˆä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼‰
        debugLog('001æ–‡ä»¶åˆ—æ˜ å°„:');
        debugLog('æ‰€æœ‰åˆ—:', columnKeys);
        debugLog('Båˆ—ç´¢å¼•:', columnLetterToIndex('B'), 'æ¸¯å£åˆ—:', portCol, 'ç´¢å¼•:', columnKeys.indexOf(portCol));
        debugLog('Cåˆ—ç´¢å¼•:', columnLetterToIndex('C'), 'èˆªçº¿IDåˆ—:', routeIdCol, 'ç´¢å¼•:', routeIdCol ? columnKeys.indexOf(routeIdCol) : 'N/A');
        debugLog('Gåˆ—ç´¢å¼•:', columnLetterToIndex('G'), 'èˆ¹å…¬å¸åˆ—:', carrierCol, 'ç´¢å¼•:', columnKeys.indexOf(carrierCol));
        debugLog('Måˆ—ç´¢å¼•:', mColIndexForDate, 'æ—¥æœŸåˆ—:', dateCol, 'ç´¢å¼•:', columnKeys.indexOf(dateCol));
        debugLog('Kåˆ—ç´¢å¼•:', columnLetterToIndex('K'), 'èˆ¹ååˆ—:', vesselCol, 'ç´¢å¼•:', vesselCol ? columnKeys.indexOf(vesselCol) : 'N/A');
        debugLog('Låˆ—ç´¢å¼•:', lColIndex, 'èˆ¹å‹åˆ—:', shipTypeCol, 'ç´¢å¼•:', shipTypeCol ? columnKeys.indexOf(shipTypeCol) : 'N/A');
        debugLog('Eåˆ—ç´¢å¼•:', eColIndex, 'æ ‡å‡†å¼€èˆªæ—¥åˆ—:', weekdayCol, 'ç´¢å¼•:', weekdayCol ? columnKeys.indexOf(weekdayCol) : 'N/A');
        debugLog('Fåˆ—ç´¢å¼•:', fColIndex, 'æ ‡å‡†èˆªç¨‹åˆ—:', voyageDaysCol, 'ç´¢å¼•:', voyageDaysCol ? columnKeys.indexOf(voyageDaysCol) : 'N/A');
        debugLog('Påˆ—ç´¢å¼•:', pColIndex, 'èµ·è¿æ¸¯ç å¤´åˆ—:', originTerminalCol, 'ç´¢å¼•:', originTerminalCol ? columnKeys.indexOf(originTerminalCol) : 'N/A');
        debugLog('Qåˆ—ç´¢å¼•:', qColIndex, 'ç›®çš„æ¸¯ç å¤´åˆ—:', destTerminalCol, 'ç´¢å¼•:', destTerminalCol ? columnKeys.indexOf(destTerminalCol) : 'N/A');
        
        // æ£€æŸ¥Måˆ—å’ŒNåˆ—çš„å®é™…æ•°æ®ï¼ˆå‰5è¡Œï¼‰
        const nColIndex = columnLetterToIndex('N');
        if (mColIndexForDate !== null && columnKeys[mColIndexForDate]) {
          const mColKey = columnKeys[mColIndexForDate];
          debugLog('Måˆ—å®é™…åˆ—å:', mColKey, 'å‰5è¡Œæ•°æ®:', jsonData.slice(0, 5).map(r => r[mColKey]));
        }
        if (nColIndex !== null && columnKeys[nColIndex]) {
          const nColKey = columnKeys[nColIndex];
          debugLog('Nåˆ—å®é™…åˆ—å:', nColKey, 'å‰5è¡Œæ•°æ®:', jsonData.slice(0, 5).map(r => r[nColKey]));
        }

        if (!portCol || !carrierCol || !dateCol) {
          debugWarn('001æ–‡ä»¶ç¼ºå°‘å¿…è¦çš„åˆ—:', { portCol, carrierCol, dateCol, allColumns: columnKeys });
          return [];
        }

        const parsed = [];
        const carriers = state.allCarriers001;
        const ports = state.allPorts001;
        
        // ç»Ÿè®¡ä¿¡æ¯
        let totalRows = 0;
        let skippedPort = 0;
        let skippedCarrier = 0;
        let skippedDate = 0;
        const failedPorts = new Map(); // è®°å½•æ˜ å°„å¤±è´¥çš„æ¸¯å£åç§°
        const failedDates = new Map(); // è®°å½•è§£æå¤±è´¥çš„æ—¥æœŸæ ¼å¼ï¼ˆå‰20ä¸ªï¼‰

        // æ„å»ºåˆ—é…ç½®å¯¹è±¡
        const columnConfig = {
          portCol,
          carrierCol,
          dateCol,
          vesselCol,
          shipTypeCol,
          weekdayCol,
          voyageDaysCol,
          originTerminalCol,
          destTerminalCol,
          routeIdCol
        };

        jsonData.forEach(row => {
          totalRows++;
          
          // ä½¿ç”¨å…¬å…±è§£æå‡½æ•°
          const parsedRow = parseDataRow(row, columnConfig, '001');
          
          if (!parsedRow) {
            // è®°å½•å¤±è´¥åŸå› 
            const rawPort = row[portCol];
            const port = normalizePortName(rawPort ? String(rawPort).trim() : '');
            const carrier = row[carrierCol] ? String(row[carrierCol]).trim() : '';
            const rawDate = row[dateCol];
            
            if (!port || !allPorts.includes(port)) {
              skippedPort++;
              if (rawPort) {
                const rawPortStr = String(rawPort).trim();
                failedPorts.set(rawPortStr, (failedPorts.get(rawPortStr) || 0) + 1);
              }
            } else if (!carrier) {
              skippedCarrier++;
            } else {
              skippedDate++;
              // è®°å½•å¤±è´¥çš„æ—¥æœŸæ ¼å¼ï¼ˆåªè®°å½•å‰20ä¸ªä¸åŒçš„æ ¼å¼ï¼‰
              if (failedDates.size < 20 && rawDate !== null && rawDate !== undefined) {
                const dateStr = String(rawDate);
                if (!failedDates.has(dateStr)) {
                  failedDates.set(dateStr, {
                    value: rawDate,
                    type: typeof rawDate,
                    sample: dateStr.substring(0, 50)
                  });
                }
              }
            }
            return;
          }

          parsed.push(parsedRow);
          carriers.add(parsedRow.carrier);
          ports.add(parsedRow.port);
        });

        // è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼‰
        debugLog('001æ–‡ä»¶è§£æç»Ÿè®¡:');
        debugLog(`æ€»è¡Œæ•°: ${totalRows}`);
        debugLog(`æˆåŠŸè§£æ: ${parsed.length}`);
        debugLog(`è·³è¿‡-æ¸¯å£æ˜ å°„å¤±è´¥: ${skippedPort}`);
        debugLog(`è·³è¿‡-èˆ¹å…¬å¸ä¸ºç©º: ${skippedCarrier}`);
        debugLog(`è·³è¿‡-æ—¥æœŸæ— æ•ˆ: ${skippedDate}`);
        
        // è¾“å‡ºæ˜ å°„å¤±è´¥çš„æ¸¯å£ï¼ˆæŒ‰å‡ºç°æ¬¡æ•°æ’åºï¼Œåªæ˜¾ç¤ºå‰20ä¸ªï¼‰
        if (failedPorts.size > 0) {
          const sortedFailedPorts = Array.from(failedPorts.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 20);
          debugLog('æ˜ å°„å¤±è´¥çš„æ¸¯å£ï¼ˆå‰20ä¸ªï¼‰:', sortedFailedPorts);
        }
        
        // è¾“å‡ºè§£æå¤±è´¥çš„æ—¥æœŸæ ¼å¼
        if (failedDates.size > 0) {
          debugLog('è§£æå¤±è´¥çš„æ—¥æœŸæ ¼å¼ï¼ˆå‰20ä¸ªï¼‰:', Array.from(failedDates.entries()));
        }

        return parsed;
      }

      /**
       * è§£æExcelæ•°æ® - 365æ–‡ä»¶ä¸“ç”¨
       * @param {Array<Object>} jsonData - Excelè½¬æ¢åçš„JSONæ•°æ®
       * @returns {Array<Object>} è§£æåçš„èˆ¹æœŸæ•°æ®æ•°ç»„
       */
      function parseExcelData365(jsonData) {
        if (!jsonData || jsonData.length === 0) return [];

        const firstRow = jsonData[0];
        const columnKeys = Object.keys(firstRow);

        const findColumnKey = (keywords, fallbackIndex = null) => {
          const key = columnKeys.find(col => 
            keywords.some(keyword => matchesKeyword(col, keyword))
          );
          if (key) return key;
          if (typeof fallbackIndex === 'number' && columnKeys[fallbackIndex]) {
            return columnKeys[fallbackIndex];
          }
          return null;
        };

        // 365æ–‡ä»¶åˆ—å®šä¹‰
        const portCol = findColumnKey(['æ¸¯å£', 'ç›®çš„æ¸¯', 'pod'], 1); // Båˆ—ï¼ˆç´¢å¼•1ï¼‰
        const carrierCol = findColumnKey(['å…±èˆ±', 'èˆ¹å…¬å¸'], 9); // Jåˆ—ï¼ˆç´¢å¼•9ï¼‰- å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•9
        const dateCol = findColumnKey(['èˆ¹æœŸ', 'å¼€èˆ¹', 'ç¦»æ¸¯', 'etd'], 12); // Måˆ—ï¼ˆç´¢å¼•12ï¼‰
        const vesselCol = columnKeys[11] || findColumnKey(['èˆ¹å', 'èˆªæ¬¡', 'vessel'], 11); // Låˆ—ï¼ˆç´¢å¼•11ï¼‰- èˆ¹åèˆªæ¬¡
        const routeIdCol = findColumnKey(['èˆªçº¿id', 'èˆªçº¿ID', 'route id', 'group_id', 'groupid'], 6); // Gåˆ—ï¼ˆç´¢å¼•6ï¼‰- èˆªçº¿ID
        const vesselNameCol = columnKeys[16] || findColumnKey(['èˆ¹å'], 16); // Qåˆ—ï¼ˆç´¢å¼•16ï¼‰- èˆ¹å
        
        // é¢å¤–åˆ—ï¼šHã€Iã€Nã€Oã€Sã€Uã€Y
        const weekdayCol = columnKeys[7] || null; // Håˆ—ï¼ˆç´¢å¼•7ï¼‰- æ ‡å‡†å¼€èˆªæ—¥
        const voyageDaysCol = columnKeys[8] || null; // Iåˆ—ï¼ˆç´¢å¼•8ï¼‰- æ ‡å‡†èˆªç¨‹
        const originTerminalCol = columnKeys[13] || null; // Nåˆ—ï¼ˆç´¢å¼•13ï¼‰- èµ·è¿æ¸¯ç å¤´
        const destTerminalCol = columnKeys[14] || null; // Oåˆ—ï¼ˆç´¢å¼•14ï¼‰- ç›®çš„æ¸¯ç å¤´
        const shipTypeCol = columnKeys[18] || null; // Såˆ—ï¼ˆç´¢å¼•18ï¼‰- èˆ¹å‹
        const yearCol = columnKeys[20] || null; // Uåˆ—ï¼ˆç´¢å¼•20ï¼‰- å¹´ä»½
        const routePathCol = columnKeys[24] || null; // Yåˆ—ï¼ˆç´¢å¼•24ï¼‰- è·¯å¾„

        if (!portCol || !carrierCol || !dateCol) {
          debugWarn('365æ–‡ä»¶ç¼ºå°‘å¿…è¦çš„åˆ—:', { portCol, carrierCol, dateCol, allColumns: columnKeys });
          // å¦‚æœé€šè¿‡å…³é”®è¯æ‰¾ä¸åˆ°ï¼Œå¼ºåˆ¶ä½¿ç”¨ç´¢å¼•
          const portColFallback = columnKeys[1] || null;
          const carrierColFallback = columnKeys[9] || null; // Jåˆ—
          const dateColFallback = columnKeys[12] || null; // Måˆ—
          const routeIdColFallback = columnKeys[6] || null; // Gåˆ—
          const vesselNameColFallback = columnKeys[16] || null; // Qåˆ—
          
          if (!portColFallback || !carrierColFallback || !dateColFallback) {
            return [];
          }
          
          // ä½¿ç”¨fallback
          const finalPortCol = portCol || portColFallback;
          const finalCarrierCol = carrierCol || carrierColFallback;
          const finalDateCol = dateCol || dateColFallback;
          const finalRouteIdCol = routeIdCol || routeIdColFallback;
          const finalVesselNameCol = vesselNameCol || vesselNameColFallback;
          
          return parse365WithColumns(jsonData, finalPortCol, finalCarrierCol, finalDateCol, vesselCol,
            weekdayCol, voyageDaysCol, originTerminalCol, destTerminalCol, shipTypeCol, yearCol, routePathCol,
            finalRouteIdCol, finalVesselNameCol);
        }

        return parse365WithColumns(jsonData, portCol, carrierCol, dateCol, vesselCol,
          weekdayCol, voyageDaysCol, originTerminalCol, destTerminalCol, shipTypeCol, yearCol, routePathCol,
          routeIdCol, vesselNameCol);
      }

      // 365æ–‡ä»¶æ•°æ®è§£æï¼ˆä½¿ç”¨æŒ‡å®šåˆ—ï¼‰
      function parse365WithColumns(jsonData, portCol, carrierCol, dateCol, vesselCol,
        weekdayCol, voyageDaysCol, originTerminalCol, destTerminalCol, shipTypeCol, yearCol, routePathCol,
        routeIdCol, vesselNameCol) {
        const parsed = [];
        const carriers = state.allCarriers365;
        const ports = state.allPorts365;

        // æ„å»ºåˆ—é…ç½®å¯¹è±¡
        const columnConfig = {
          portCol,
          carrierCol,
          dateCol,
          vesselCol,
          shipTypeCol,
          weekdayCol,
          voyageDaysCol,
          originTerminalCol,
          destTerminalCol,
          routeIdCol,
          vesselNameCol,
          yearCol,
          routePathCol
        };

        jsonData.forEach(row => {
          // ä½¿ç”¨å…¬å…±è§£æå‡½æ•°
          const parsedRow = parseDataRow(row, columnConfig, '365');
          
          if (!parsedRow) {
            return; // è·³è¿‡æ— æ•ˆæ•°æ®
          }

          parsed.push(parsedRow);
          carriers.add(parsedRow.carrier);
          ports.add(parsedRow.port);
        });

        return parsed;
      }

      // parseDate å‡½æ•°å·²ç§»è‡³ vendor/common-utils.js

      // æ ‡å‡†åŒ–æ¸¯å£åç§°ï¼ˆæ›´æ™ºèƒ½çš„åŒ¹é…ï¼‰
      function normalizePortName(portName) {
        if (!portName) return '';
        
        // å»é™¤å¤šä½™ç©ºæ ¼
        let normalized = String(portName).trim();
        const originalNormalized = normalized;
        
        // å…ˆæ£€æŸ¥æ˜ å°„è¡¨ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
        if (portNameMapping[normalized]) {
          return portNameMapping[normalized];
        }

        // å¤„ç†è‹±æ–‡æ ¼å¼ï¼šBALBOA(å·´å°”åšäºš) æˆ– BRISBANE,AU(å¸ƒé‡Œæ–¯ç­) æˆ– CHATTOGRAM(å‰å¤§æ¸¯)
        if (normalized.includes('(') && normalized.includes(')')) {
          // å…ˆæå–æ‹¬å·å‰çš„è‹±æ–‡éƒ¨åˆ†ï¼Œå°è¯•åŒ¹é…
          const beforeBracket = normalized.split('(')[0].trim();
          const upperBeforeBracket = beforeBracket.toUpperCase();
          if (portNameMapping[upperBeforeBracket]) {
            return portNameMapping[upperBeforeBracket];
          }
          // æå–æ‹¬å·å†…çš„ä¸­æ–‡åç§°
          const match = normalized.match(/\(([^)]+)\)/);
          if (match && match[1]) {
            const chineseName = match[1].split(',')[0].trim(); // å¦‚æœæœ‰é€—å·ï¼Œå–ç¬¬ä¸€éƒ¨åˆ†
            if (portNameMapping[chineseName]) {
              return portNameMapping[chineseName];
            }
            // ç›´æ¥ä½¿ç”¨æ‹¬å·å†…çš„ä¸­æ–‡åç§°ï¼ˆå¦‚æœå®ƒåœ¨æ ‡å‡†æ¸¯å£åˆ—è¡¨ä¸­ï¼‰
            if (allPorts.includes(chineseName)) {
              return chineseName;
            }
            normalized = chineseName;
          }
        }

        // å¤„ç†åŒ…å«é€—å·çš„æƒ…å†µï¼ˆå¦‚"ç›–æ¢…æ¸¯,å¤´é¡¿" -> "ç›–æ¢…æ¸¯" æˆ– "LOS ANGELES, CA" -> "LOS ANGELES"ï¼‰
        if (normalized.includes(',')) {
          const mainPart = normalized.split(',')[0].trim();
          // å…ˆæ£€æŸ¥åŸå§‹æ ¼å¼ï¼ˆå¸¦é€—å·çš„å®Œæ•´æ ¼å¼ï¼‰
          const upperFull = normalized.toUpperCase();
          if (portNameMapping[upperFull]) {
            return portNameMapping[upperFull];
          }
          // æ£€æŸ¥ä¸»éƒ¨åˆ†ï¼ˆä¸­æ–‡æˆ–è‹±æ–‡ï¼‰
          if (portNameMapping[mainPart]) {
            return portNameMapping[mainPart];
          }
          // æ£€æŸ¥è‹±æ–‡æ ¼å¼ï¼šLOS ANGELES, CA -> LOS ANGELES
          const upperPart = mainPart.toUpperCase();
          if (portNameMapping[upperPart]) {
            return portNameMapping[upperPart];
          }
          // å¯¹äºä¸­æ–‡æ ¼å¼ï¼Œå°è¯•ç›´æ¥åŒ¹é…æ ‡å‡†æ¸¯å£åç§°
          if (/[\u4e00-\u9fa5]/.test(mainPart)) {
            // å¦‚æœä¸»éƒ¨åˆ†æ˜¯ä¸­æ–‡ï¼Œå°è¯•ç²¾ç¡®åŒ¹é…æ ‡å‡†æ¸¯å£
            if (allPorts.includes(mainPart)) {
              return mainPart;
            }
            // å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼‰
            for (const standardPort of allPorts) {
              if (mainPart.includes(standardPort) || standardPort.includes(mainPart)) {
                return standardPort;
              }
            }
          }
          normalized = mainPart;
        }

        // å¤„ç†ç‚¹å·åˆ†éš”ï¼šVANCOUVER.BC -> VANCOUVER
        if (normalized.includes('.')) {
          const mainPart = normalized.split('.')[0].trim();
          const upperPart = mainPart.toUpperCase();
          if (portNameMapping[upperPart]) {
            return portNameMapping[upperPart];
          }
          normalized = mainPart;
        }

        // å¤„ç†æ‹¬å·å†…å®¹ï¼ˆå¦‚"é’å²›(é’å²›)" -> "é’å²›"ï¼‰
        if (normalized.includes('(')) {
          const beforeBracket = normalized.split('(')[0].trim();
          if (portNameMapping[beforeBracket]) {
            return portNameMapping[beforeBracket];
          }
          normalized = beforeBracket;
        }

        // å†æ¬¡æ£€æŸ¥æ˜ å°„è¡¨ï¼ˆå¤„ç†åçš„å€¼ï¼‰
        if (normalized !== originalNormalized && portNameMapping[normalized]) {
          return portNameMapping[normalized];
        }

        // æ£€æŸ¥å¤§å†™æ ¼å¼ï¼ˆè‹±æ–‡æ¸¯å£åï¼‰
        const upperNormalized = normalized.toUpperCase();
        if (portNameMapping[upperNormalized]) {
          return portNameMapping[upperNormalized];
        }

        // å¯¹äºä¸­æ–‡æ ¼å¼ï¼Œå…ˆå°è¯•ç²¾ç¡®åŒ¹é…æ ‡å‡†æ¸¯å£åç§°
        if (/[\u4e00-\u9fa5]/.test(normalized)) {
          // ç²¾ç¡®åŒ¹é…
          if (allPorts.includes(normalized)) {
            return normalized;
          }
          // å»é™¤å¸¸è§åç¼€ï¼ˆå¦‚"æ¸¯"ã€"æ¸¯å£"ç­‰ï¼Œä½†ä¿ç•™åœ¨æ ‡å‡†åç§°ä¸­çš„ï¼‰
          const cleaned = normalized.replace(/æ¸¯$/, '').trim();
          if (cleaned !== normalized && allPorts.includes(cleaned)) {
            return cleaned;
          }
          // æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼Œä¼˜å…ˆåŒ¹é…æ›´é•¿çš„æ ‡å‡†åç§°ï¼‰
          const matches = [];
          for (const standardPort of allPorts) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ ‡å‡†æ¸¯å£åï¼ˆåŒå‘åŒ…å«ï¼‰
            if (normalized.includes(standardPort) || standardPort.includes(normalized) ||
                cleaned.includes(standardPort) || standardPort.includes(cleaned)) {
              matches.push({ port: standardPort, length: standardPort.length });
            }
          }
          if (matches.length > 0) {
            // ä¼˜å…ˆè¿”å›æ›´é•¿çš„åŒ¹é…ï¼ˆæ›´ç²¾ç¡®ï¼‰
            matches.sort((a, b) => b.length - a.length);
            return matches[0].port;
          }
        }
        
        // å¯¹äºè‹±æ–‡æ ¼å¼ï¼Œå»é™¤å¸¸è§åç¼€
        const cleaned = normalized.replace(/æ¸¯$/, '').trim();
        
        // ç²¾ç¡®åŒ¹é…
        for (const standardPort of allPorts) {
          if (normalized === standardPort || cleaned === standardPort) {
            return standardPort;
          }
        }

        // æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼Œä¼˜å…ˆåŒ¹é…æ›´é•¿çš„æ ‡å‡†åç§°ï¼‰
        const matches = [];
        for (const standardPort of allPorts) {
          // æ£€æŸ¥æ˜¯å¦åŒ…å«æ ‡å‡†æ¸¯å£å
          if (normalized.includes(standardPort) || standardPort.includes(normalized) ||
              cleaned.includes(standardPort) || standardPort.includes(cleaned)) {
            matches.push({ port: standardPort, length: standardPort.length });
          }
        }
        
        if (matches.length > 0) {
          // è¿”å›æœ€é•¿çš„åŒ¹é…ï¼ˆæ›´ç²¾ç¡®ï¼‰
          matches.sort((a, b) => b.length - a.length);
          return matches[0].port;
        }

        // å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆè·³è¿‡è¿™æ¡è®°å½•ï¼‰
        return '';
      }

      // è·å–æ¸¯å£æ‰€å±åŒºåŸŸ
      function getPortRegion(port) {
        for (const [region, ports] of Object.entries(regionMapping)) {
          if (ports.some(p => port.includes(p) || p.includes(port))) {
            return region;
          }
        }
        return null;
      }

      /**
       * æ›´æ–°èˆ¹å…¬å¸ç­›é€‰å™¨ï¼ˆè”åŠ¨æ›´æ–°ï¼‰
       * æ ¹æ®å½“å‰é€‰ä¸­çš„åŒºåŸŸå’Œæ¸¯å£ï¼Œæ›´æ–°å¯ç”¨çš„èˆ¹å…¬å¸é€‰é¡¹
       */
      function updateCarrierFilter() {
        const currentData = state.currentMode === MODE_001 ? state.data001 : state.data365;
        if (!currentData || currentData.length === 0) {
          dom.carrierFilter.innerHTML = '';
          return;
        }

        // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶ï¼Œè·å–å¯ç”¨çš„èˆ¹å…¬å¸
        const availableCarriers = getAvailableCarriers(currentData);
        
        // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
        const currentSelected = Array.from(dom.carrierFilter.selectedOptions).map(o => o.value);
        
        dom.carrierFilter.innerHTML = '';
        availableCarriers.forEach(carrier => {
          const option = document.createElement('option');
          option.value = carrier;
          option.textContent = carrier;
          if (currentSelected.includes(carrier)) {
            option.selected = true;
          }
          dom.carrierFilter.appendChild(option);
        });
      }

      /**
       * æ›´æ–°æ¸¯å£ç­›é€‰å™¨ï¼ˆè”åŠ¨æ›´æ–°ï¼‰
       * æ ¹æ®å½“å‰é€‰ä¸­çš„åŒºåŸŸå’Œèˆ¹å…¬å¸ï¼Œæ›´æ–°å¯ç”¨çš„æ¸¯å£é€‰é¡¹
       */
      function updatePortFilter() {
        const currentData = state.currentMode === MODE_001 ? state.data001 : state.data365;
        if (!currentData || currentData.length === 0) {
          return;
        }

        // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶ï¼Œè·å–å¯ç”¨çš„æ¸¯å£
        const availablePorts = getAvailablePorts(currentData);
        
        // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
        const currentSelected = Array.from(dom.portFilter.selectedOptions).map(o => o.value);
        
        // æ›´æ–°é€‰é¡¹ï¼Œåªæ˜¾ç¤ºå¯ç”¨çš„æ¸¯å£
        Array.from(dom.portFilter.options).forEach(option => {
          if (availablePorts.includes(option.value)) {
            option.style.display = '';
            if (currentSelected.includes(option.value)) {
              option.selected = true;
            }
          } else {
            option.style.display = 'none';
            option.selected = false;
          }
        });
      }

      // è·å–å¯ç”¨çš„èˆªçº¿åŒºåŸŸï¼ˆåŸºäºå½“å‰èˆ¹å…¬å¸å’Œæ¸¯å£ç­›é€‰ï¼‰
      function getAvailableRegions(data) {
        const filtered = data.filter(item => {
          // èˆ¹å…¬å¸ç­›é€‰
          if (state.selectedCarriers.length > 0) {
            if (!state.selectedCarriers.includes(item.carrier)) {
              return false;
            }
          }
          // æ¸¯å£ç­›é€‰
          if (state.selectedPorts.length > 0) {
            if (!state.selectedPorts.includes(item.port)) {
              return false;
            }
          }
          return true;
        });
        
        const regions = new Set();
        filtered.forEach(item => {
          const region = getPortRegion(item.port);
          if (region) {
            regions.add(region);
          }
        });
        return Array.from(regions).sort();
      }

      // è·å–å¯ç”¨çš„èˆ¹å…¬å¸ï¼ˆåŸºäºå½“å‰åŒºåŸŸå’Œæ¸¯å£ç­›é€‰ï¼‰
      function getAvailableCarriers(data) {
        const filtered = data.filter(item => {
          // åŒºåŸŸç­›é€‰
          if (state.selectedRegions.length > 0) {
            const itemRegion = getPortRegion(item.port);
            if (!itemRegion || !state.selectedRegions.includes(itemRegion)) {
              return false;
            }
          }
          // æ¸¯å£ç­›é€‰
          if (state.selectedPorts.length > 0) {
            if (!state.selectedPorts.includes(item.port)) {
              return false;
            }
          }
          return true;
        });
        
        const carriers = new Set(filtered.map(item => item.carrier));
        return Array.from(carriers).sort();
      }

      // è·å–å¯ç”¨çš„æ¸¯å£ï¼ˆåŸºäºå½“å‰åŒºåŸŸå’Œèˆ¹å…¬å¸ç­›é€‰ï¼‰
      function getAvailablePorts(data) {
        const filtered = data.filter(item => {
          // åŒºåŸŸç­›é€‰
          if (state.selectedRegions.length > 0) {
            const itemRegion = getPortRegion(item.port);
            if (!itemRegion || !state.selectedRegions.includes(itemRegion)) {
              return false;
            }
          }
          // èˆ¹å…¬å¸ç­›é€‰
          if (state.selectedCarriers.length > 0) {
            if (!state.selectedCarriers.includes(item.carrier)) {
              return false;
            }
          }
          return true;
        });
        
        const ports = new Set(filtered.map(item => item.port));
        return Array.from(ports).filter(p => allPorts.includes(p));
      }

      /**
       * æ›´æ–°èˆªçº¿åŒºåŸŸç­›é€‰å™¨ï¼ˆè”åŠ¨æ›´æ–°ï¼‰
       * æ ¹æ®å½“å‰é€‰ä¸­çš„èˆ¹å…¬å¸å’Œæ¸¯å£ï¼Œæ›´æ–°å¯ç”¨çš„åŒºåŸŸé€‰é¡¹
       */
      function updateRegionFilter() {
        const currentData = state.currentMode === MODE_001 ? state.data001 : state.data365;
        if (!currentData || currentData.length === 0) {
          return;
        }

        // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶ï¼Œè·å–å¯ç”¨çš„èˆªçº¿åŒºåŸŸ
        const availableRegions = getAvailableRegions(currentData);
        
        // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
        const currentSelected = Array.from(dom.regionFilter.selectedOptions).map(o => o.value);
        
        // æ›´æ–°é€‰é¡¹ï¼Œåªæ˜¾ç¤ºå¯ç”¨çš„åŒºåŸŸ
        Array.from(dom.regionFilter.options).forEach(option => {
          if (availableRegions.includes(option.value)) {
            option.style.display = '';
            if (currentSelected.includes(option.value)) {
              option.selected = true;
            }
          } else {
            option.style.display = 'none';
            option.selected = false;
          }
        });
      }

      // å¤„ç†ç­›é€‰å˜åŒ–ï¼ˆè”åŠ¨æ›´æ–°ï¼‰- ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æ€§èƒ½
      const handleFilterChange = debounce(() => {
        state.selectedRegions = Array.from(dom.regionFilter.selectedOptions).map(o => o.value);
        state.selectedCarriers = Array.from(dom.carrierFilter.selectedOptions).map(o => o.value);
        state.selectedPorts = Array.from(dom.portFilter.selectedOptions).map(o => o.value);
        
        // è”åŠ¨æ›´æ–°æ‰€æœ‰ç­›é€‰å™¨
        updateRegionFilter();
        updateCarrierFilter();
        updatePortFilter();
        
        // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½
        requestAnimationFrame(() => {
          renderCalendar();
          renderMonthlySummary(); // æ¸²æŸ“æœˆåº¦æ±‡æ€»è¡¨æ ¼
          updateAiModuleVisibility(); // æ›´æ–° AI æ¨¡å—å¯è§æ€§
        });
      }, 150); // 150ms é˜²æŠ–å»¶è¿Ÿ

      /**
       * æ¸²æŸ“æ—¥å†è§†å›¾
       * æ ¹æ®ç­›é€‰æ¡ä»¶æ˜¾ç¤ºèˆ¹æœŸæ—¥å†ï¼Œæ”¯æŒ4å‘¨æ˜¾ç¤º
       */
      function renderCalendar() {
        const hasFilters = state.selectedRegions.length > 0 || 
                          state.selectedCarriers.length > 0 || 
                          state.selectedPorts.length > 0;

        if (!hasFilters) {
          dom.calendarContainer.classList.add('hidden');
          dom.emptyMessage.classList.remove('hidden');
          return;
        }

        dom.calendarContainer.classList.remove('hidden');
        dom.emptyMessage.classList.add('hidden');

        // è·å–å½“å‰æ•°æ®
        const currentData = state.currentMode === MODE_001 ? state.data001 : state.data365;
        if (!currentData || currentData.length === 0) {
          dom.calendarContainer.classList.add('hidden');
          dom.emptyMessage.textContent = `è¯·å…ˆåŠ è½½ ${state.currentMode} æ•°æ®æ–‡ä»¶`;
          dom.emptyMessage.classList.remove('hidden');
          return;
        }

        // ç­›é€‰æ•°æ®
        const filteredData = currentData.filter(item => {
          // åŒºåŸŸç­›é€‰
          if (state.selectedRegions.length > 0) {
            const itemRegion = getPortRegion(item.port);
            if (!itemRegion || !state.selectedRegions.includes(itemRegion)) {
              return false;
            }
          }

          // èˆ¹å…¬å¸ç­›é€‰
          if (state.selectedCarriers.length > 0) {
            if (!state.selectedCarriers.includes(item.carrier)) {
              return false;
            }
          }

          // æ¸¯å£ç­›é€‰
          if (state.selectedPorts.length > 0) {
            if (!state.selectedPorts.includes(item.port)) {
              return false;
            }
          }

          return true;
        });

        // æŒ‰æ—¥æœŸåˆ†ç»„
        const dataByDate = {};
        filteredData.forEach(item => {
          const dateKey = formatDateKey(item.date);
          if (!dataByDate[dateKey]) {
            dataByDate[dateKey] = [];
          }
          dataByDate[dateKey].push(item);
        });

        // æ£€æµ‹æ˜¯å¦ä¸ºæ‰‹æœºç«¯ï¼ˆå±å¹•å®½åº¦ <= 768pxï¼‰
        const isMobile = window.innerWidth <= 768;
        
        // æ¸…ç©ºæ—¥å†å®¹å™¨ï¼ˆä¼šè‡ªåŠ¨æ¸…ç†åŠ¨æ€å…ƒç´ çš„äº‹ä»¶ç›‘å¬å™¨ï¼‰
        dom.calendarBody.innerHTML = '';

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ—¥å†é¡¹çš„ç‚¹å‡»äº‹ä»¶ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼Œé¿å…ä¸ºæ¯ä¸ªå…ƒç´ å•ç‹¬æ·»åŠ ç›‘å¬å™¨ï¼‰
        if (!dom.calendarBody.dataset.delegated) {
          const handleScheduleItemClick = (e) => {
            const itemEl = e.target.closest('.schedule-item');
            if (!itemEl) return;
            
            e.stopPropagation();
            const clickedCarrier = itemEl.dataset.carrier;
            if (!clickedCarrier) return;
            
            // åˆ‡æ¢é«˜äº®çŠ¶æ€
            const isHighlighted = itemEl.classList.contains('highlighted');
            
            // ä½¿ç”¨ç¼“å­˜çš„æŸ¥è¯¢ç»“æœï¼ˆä» calendarBody æŸ¥è¯¢ï¼Œé¿å…å…¨å±€æŸ¥è¯¢ï¼‰
            // ç”±äºä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»å®¹å™¨æŸ¥è¯¢ï¼Œæ€§èƒ½æ›´å¥½
            const scheduleItems = dom.calendarBody.querySelectorAll('.schedule-item');
            
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            scheduleItems.forEach(el => {
              el.classList.remove('highlighted');
            });
            
            // å¦‚æœä¸æ˜¯å·²é«˜äº®çŠ¶æ€ï¼Œåˆ™é«˜äº®åŒèˆªçº¿
            if (!isHighlighted) {
              scheduleItems.forEach(el => {
                if (el.dataset.carrier === clickedCarrier) {
                  el.classList.add('highlighted');
                }
              });
            }
          };
          
          eventListeners.add(dom.calendarBody, 'click', handleScheduleItemClick);
          dom.calendarBody.dataset.delegated = 'true';
        }

        // æ‰‹æœºç«¯ï¼šæŒ‰æ—¥æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºæœªæ¥28å¤©çš„æ•°æ®ï¼‰
        if (isMobile) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const days = [];
          
          // ç”Ÿæˆæœªæ¥28å¤©çš„æ—¥æœŸ
          for (let d = 0; d < 28; d++) {
            const date = new Date(today);
            date.setDate(today.getDate() + d);
            days.push(date);
          }
          
          // æŒ‰æ—¥æœŸæ¸²æŸ“
          days.forEach(date => {
            const dateKey = formatDateKey(date);
            const dayData = dataByDate[dateKey] || [];
            
            // åˆ›å»ºæ—¥æœŸå¡ç‰‡
            const dayCard = document.createElement('div');
            dayCard.className = 'calendar-day';
            if (isToday(date)) {
              dayCard.classList.add('today');
            }
            
            // æ—¥æœŸæ ‡ç­¾
            const dateLabel = document.createElement('div');
            dateLabel.style.cssText = 'font-weight: 600; margin-bottom: 16px; color: #495057; font-size: 16px; padding-bottom: 12px; border-bottom: 2px solid #e9ecef;';
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[date.getDay()];
            dateLabel.textContent = `${month}æœˆ${day}æ—¥ ${weekday}`;
            if (isToday(date)) {
              dateLabel.style.color = '#667eea';
              dateLabel.style.borderBottomColor = '#667eea';
            }
            dayCard.appendChild(dateLabel);
            
            // å»é‡å¤„ç†ï¼ˆç»Ÿä¸€ä½¿ç”¨ vendor ä¸­çš„æ ‡å‡†å»é‡ï¼‰
            let uniqueData = typeof deduplicateSailingItems === 'function'
              ? deduplicateSailingItems(dayData)
              : deduplicateItems(dayData);
            
            // åˆå¹¶åŒèˆ¹åèˆªæ¬¡èˆ¹å‹çš„æ¸¯å£
            const mergeByVessel = (items) => {
              const grouped = {};
              
              items.forEach(item => {
                let groupKey;
                let vesselName, voyageNumber, shipType, carrier;
                
                // 365æ¨¡å¼ï¼šåŒä¸€å¤© + åŒèˆ¹å(Qåˆ—) + åŒèˆªçº¿ID(Gåˆ—)
                if (item.mode === '365') {
                  const dateKey = formatDateKey(item.date);
                  vesselName = item.vesselName || getVesselName(item.vessel || '');
                  const routeId = item.routeId || '';
                  groupKey = `${dateKey}_${vesselName}_${routeId}`;
                } else {
                  // 001æ¨¡å¼ï¼šèˆ¹å + èˆªæ¬¡ + èˆ¹å‹ + èˆ¹å…¬å¸
                  vesselName = getVesselName(item.vessel || '');
                  voyageNumber = getVoyageNumber(item.vessel || '');
                  shipType = item.shipType || '';
                  carrier = item.carrier || '';
                  groupKey = `${vesselName}_${voyageNumber}_${shipType}_${carrier}`;
                }
                
                if (!grouped[groupKey]) {
                  if (item.mode === MODE_365) {
                    grouped[groupKey] = {
                      vessel: item.vessel || '',
                      vesselName: item.vesselName || getVesselName(item.vessel || ''),
                      shipType: item.shipType || '',
                      carriers: [],
                      carriersSet: new Set(),
                      ports: [],
                      portsSet: new Set(),
                      weekday: item.weekday,
                      voyageDays: item.voyageDays,
                      originTerminal: item.originTerminal,
                      destTerminal: item.destTerminal,
                      year: item.year,
                      routePath: item.routePath,
                      routeId: item.routeId || '',
                      mode: item.mode,
                      date: item.date
                    };
                  } else {
                    grouped[groupKey] = {
                      vessel: item.vessel || '',
                      vesselName: vesselName,
                      voyageNumber: voyageNumber,
                      shipType: shipType,
                      carrier: carrier,
                      ports: [],
                      portsSet: new Set(),
                      weekday: item.weekday,
                      voyageDays: item.voyageDays,
                      originTerminal: item.originTerminal,
                      destTerminal: item.destTerminal,
                      year: item.year,
                      routePath: item.routePath,
                      mode: item.mode,
                      date: item.date
                    };
                  }
                }
                
                // æ·»åŠ æ¸¯å£ï¼ˆå»é‡ï¼‰
                if (item.port && !grouped[groupKey].portsSet.has(item.port)) {
                  grouped[groupKey].ports.push(item.port);
                  grouped[groupKey].portsSet.add(item.port);
                }
                
                // 365æ¨¡å¼ï¼šæ”¶é›†å…±èˆ±èˆ¹å…¬å¸
                if (item.mode === MODE_365 && item.carrier && !grouped[groupKey].carriersSet.has(item.carrier)) {
                  grouped[groupKey].carriers.push(item.carrier);
                  grouped[groupKey].carriersSet.add(item.carrier);
                }
                // 365æ¨¡å¼ï¼šè®°å½•èˆªçº¿è·¯å¾„ï¼ˆä¼˜å…ˆä¿ç•™å·²æœ‰çš„éç©ºè·¯å¾„ï¼‰
                if (item.mode === MODE_365 && !grouped[groupKey].routePath && item.routePath) {
                  grouped[groupKey].routePath = item.routePath;
                }
              });
              
              // è½¬æ¢ä¸ºæ•°ç»„ï¼Œåˆå¹¶å¤šä¸ªæ¸¯å£çš„æ ‡è®°ä¸ºéœ€è¦åˆå¹¶æ˜¾ç¤º
              return Object.values(grouped).map(group => {
                // 365æ¨¡å¼ï¼šé€‰æ‹©æœ€é•¿çš„å…±èˆ±èˆ¹å…¬å¸
                if (group.mode === MODE_365) {
                  const longestCarrier = group.carriers.reduce((longest, current) => {
                    return current.length > longest.length ? current : longest;
                  }, group.carriers[0] || '');
                  group.carrier = longestCarrier;
                }
                
                if (group.ports.length > 1) {
                  return {
                    ...group,
                    ports: group.ports,
                    portsText: group.ports.join('ã€'),
                    isMerged: true
                  };
                } else {
                  return {
                    ...group,
                    port: group.ports[0] || '',
                    isMerged: false
                  };
                }
              });
            };
            
            // åˆå¹¶åŒèˆ¹åèˆªæ¬¡èˆ¹å‹çš„æ¸¯å£
            const mergedData = mergeByVessel(uniqueData);
            
            // æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®ï¼ˆæ‰‹æœºç«¯ä¸é™åˆ¶æ•°é‡ï¼‰
            mergedData.forEach(item => {
              const itemEl = document.createElement('div');
              itemEl.className = 'schedule-item';
              
              // ä½¿ç”¨å…¬å…±å‡½æ•°æ¸²æŸ“ï¼ˆç»Ÿä¸€å¤„ç† 001/365 æ¨¡å¼ï¼‰
              renderScheduleItem(itemEl, item, state.currentMode);
              
              dayCard.appendChild(itemEl);
            });
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
            if (mergedData.length === 0) {
              const emptyMsg = document.createElement('div');
              emptyMsg.style.cssText = 'text-align: center; color: #6c757d; font-size: 13px; padding: 20px;';
              emptyMsg.textContent = 'å½“æ—¥æ— èˆ¹æœŸ';
              dayCard.appendChild(emptyMsg);
            }
            
            dom.calendarBody.appendChild(dayCard);
          });
          
          return; // æ‰‹æœºç«¯æ¸²æŸ“å®Œæˆï¼Œç›´æ¥è¿”å›
        }

        // æ¡Œé¢ç«¯ï¼šæŒ‰å‘¨æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºå½“å‰å‘¨+æœªæ¥3å‘¨ï¼Œå…±4å‘¨ï¼Œå‘¨æ—¥å¼€å§‹ï¼‰
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weeks = [];
        
        // æ‰¾åˆ°æœ¬å‘¨æ—¥ï¼ˆä¸€å‘¨çš„å¼€å§‹ï¼‰
        const currentSunday = new Date(today);
        const dayOfWeek = today.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
        const diff = -dayOfWeek; // å¦‚æœæ˜¯å‘¨æ—¥ï¼Œdiff=0ï¼›å¦‚æœæ˜¯å‘¨ä¸€ï¼Œdiff=-1ï¼Œä»¥æ­¤ç±»æ¨
        currentSunday.setDate(today.getDate() + diff);
        
        for (let w = 0; w < CALENDAR_WEEKS; w++) {
          const weekStart = new Date(currentSunday);
          weekStart.setDate(currentSunday.getDate() + w * DAYS_PER_WEEK);
          weeks.push(weekStart);
        }

        weeks.forEach(weekStart => {
          const weekRow = document.createElement('div');
          weekRow.className = 'calendar-week';

          // æ—¶é—´æ ‡ç­¾
          const weekLabel = document.createElement('div');
          weekLabel.className = 'calendar-day-label';
          weekLabel.textContent = `ç¬¬${getWeekNumber(weekStart)}å‘¨`;
          weekRow.appendChild(weekLabel);

          // ç”Ÿæˆä¸€å‘¨çš„æ—¥æœŸï¼ˆä»å‘¨æ—¥å¼€å§‹ï¼‰
          for (let d = 0; d < DAYS_PER_WEEK; d++) {
            const date = new Date(weekStart);
            date.setDate(weekStart.getDate() + d);
            const dateKey = formatDateKey(date);
            const dayData = dataByDate[dateKey] || [];

            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (isToday(date)) {
              dayCell.classList.add('today');
            }

            // æ—¥æœŸæ ‡ç­¾
            const dateLabel = document.createElement('div');
            dateLabel.style.cssText = 'font-weight: 600; margin-bottom: 10px; color: #495057; font-size: 14px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;';
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[date.getDay()];
            dateLabel.textContent = `${month}/${day} ${weekday}`;
            if (isToday(date)) {
              dateLabel.style.color = '#667eea';
              dateLabel.style.borderBottomColor = '#667eea';
            }
            dayCell.appendChild(dateLabel);

            // å»é‡å¤„ç†ï¼ˆç»Ÿä¸€ä½¿ç”¨ vendor ä¸­çš„æ ‡å‡†å»é‡ï¼‰
            let uniqueData = typeof deduplicateSailingItems === 'function'
              ? deduplicateSailingItems(dayData)
              : deduplicateItems(dayData);
            
            // åˆå¹¶åŒä¸€å¤©ã€åŒèˆ¹åã€åŒèˆªæ¬¡ã€åŒèˆ¹å‹çš„ä¸åŒæ¸¯å£
            const mergeByVessel = (items) => {
              const grouped = {};
              
              items.forEach(item => {
                let groupKey;
                let vesselName, voyageNumber, shipType, carrier;
                
                // 365æ¨¡å¼ï¼šåŒä¸€å¤© + åŒèˆ¹å(Qåˆ—) + åŒèˆªçº¿ID(Gåˆ—)
                if (item.mode === '365') {
                  const dateKey = formatDateKey(item.date);
                  vesselName = item.vesselName || getVesselName(item.vessel || '');
                  const routeId = item.routeId || '';
                  groupKey = `${dateKey}_${vesselName}_${routeId}`;
                } else {
                  // 001æ¨¡å¼ï¼šèˆ¹å + èˆªæ¬¡ + èˆ¹å‹ + èˆ¹å…¬å¸
                  vesselName = getVesselName(item.vessel || '');
                  voyageNumber = getVoyageNumber(item.vessel || '');
                  shipType = item.shipType || '';
                  carrier = item.carrier || '';
                  groupKey = `${vesselName}_${voyageNumber}_${shipType}_${carrier}`;
                }
                
                if (!grouped[groupKey]) {
                  if (item.mode === MODE_365) {
                    // 365æ¨¡å¼ï¼šæ”¶é›†æ‰€æœ‰å…±èˆ±èˆ¹å…¬å¸ï¼Œé€‰æ‹©æœ€é•¿çš„
                    grouped[groupKey] = {
                      vessel: item.vessel || '',
                      vesselName: item.vesselName || getVesselName(item.vessel || ''),
                      shipType: item.shipType || '',
                      carriers: [], // æ”¶é›†æ‰€æœ‰å…±èˆ±èˆ¹å…¬å¸
                      carriersSet: new Set(),
                      ports: [],
                      portsSet: new Set(),
                      weekday: item.weekday,
                      voyageDays: item.voyageDays,
                      originTerminal: item.originTerminal,
                      destTerminal: item.destTerminal,
                      year: item.year,
                      routePath: item.routePath,
                      routeId: item.routeId || '',
                      mode: item.mode,
                      date: item.date
                    };
                  } else {
                    grouped[groupKey] = {
                      vessel: item.vessel || '',
                      vesselName: vesselName,
                      voyageNumber: voyageNumber,
                      shipType: shipType,
                      carrier: carrier,
                      ports: [],
                      portsSet: new Set(),
                      weekday: item.weekday,
                      voyageDays: item.voyageDays,
                      originTerminal: item.originTerminal,
                      destTerminal: item.destTerminal,
                      year: item.year,
                      routePath: item.routePath,
                      mode: item.mode,
                      date: item.date
                    };
                  }
                }
                
                // æ·»åŠ æ¸¯å£ï¼ˆå»é‡ï¼‰
                if (item.port && !grouped[groupKey].portsSet.has(item.port)) {
                  grouped[groupKey].ports.push(item.port);
                  grouped[groupKey].portsSet.add(item.port);
                }
                
                // 365æ¨¡å¼ï¼šæ”¶é›†å…±èˆ±èˆ¹å…¬å¸
                if (item.mode === MODE_365 && item.carrier && !grouped[groupKey].carriersSet.has(item.carrier)) {
                  grouped[groupKey].carriers.push(item.carrier);
                  grouped[groupKey].carriersSet.add(item.carrier);
                }
                // 365æ¨¡å¼ï¼šè®°å½•èˆªçº¿è·¯å¾„ï¼ˆä¼˜å…ˆä¿ç•™å·²æœ‰çš„éç©ºè·¯å¾„ï¼‰
                if (item.mode === MODE_365 && !grouped[groupKey].routePath && item.routePath) {
                  grouped[groupKey].routePath = item.routePath;
                }
              });
              
              // è½¬æ¢ä¸ºæ•°ç»„ï¼Œåˆå¹¶å¤šä¸ªæ¸¯å£çš„æ ‡è®°ä¸ºéœ€è¦åˆå¹¶æ˜¾ç¤º
              return Object.values(grouped).map(group => {
                // 365æ¨¡å¼ï¼šé€‰æ‹©æœ€é•¿çš„å…±èˆ±èˆ¹å…¬å¸
                if (group.mode === MODE_365) {
                  const longestCarrier = group.carriers.reduce((longest, current) => {
                    return current.length > longest.length ? current : longest;
                  }, group.carriers[0] || '');
                  group.carrier = longestCarrier;
                }
                
                if (group.ports.length > 1) {
                  return {
                    ...group,
                    ports: group.ports,
                    portsText: group.ports.join('ã€'),
                    isMerged: true
                  };
                } else {
                  return {
                    ...group,
                    port: group.ports[0] || '',
                    isMerged: false
                  };
                }
              });
            };
            
            // åˆå¹¶åŒèˆ¹åèˆªæ¬¡èˆ¹å‹çš„æ¸¯å£
            const mergedData = mergeByVessel(uniqueData);
            
            // æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤ºå®Œæ•´3è¡Œï¼ˆä¸å†è¿›è¡Œç‰¹æ®Šåˆ†ç»„ï¼‰
            let displayItems = mergedData.slice(0, MAX_ITEMS_PER_DAY);
            let remainingItems = mergedData.slice(MAX_ITEMS_PER_DAY);
            
            displayItems.forEach(item => {
              const itemEl = document.createElement('div');
              itemEl.className = 'schedule-item';
              
              // ä½¿ç”¨å…¬å…±å‡½æ•°æ¸²æŸ“ï¼ˆç»Ÿä¸€å¤„ç† 001/365 æ¨¡å¼ï¼‰
              renderScheduleItem(itemEl, item, state.currentMode);
              
              dayCell.appendChild(itemEl);
            });

            // å¦‚æœè¶…è¿‡7æ¡ï¼Œæ˜¾ç¤ºæç¤ºå¹¶æ·»åŠ æ‚¬åœåŠŸèƒ½
            if (remainingItems && remainingItems.length > 0) {
              const moreEl = document.createElement('div');
              moreEl.className = 'more-items-indicator';
              moreEl.style.cssText = 'font-size: 11px; color: #6c757d; font-style: italic; cursor: pointer; text-decoration: underline;';
              moreEl.textContent = `è¿˜æœ‰ ${remainingItems.length} æ¡...`;
              
              // åˆ›å»ºæ‚¬åœæç¤ºæ¡†æ˜¾ç¤ºå‰©ä½™èˆ¹æœŸä¿¡æ¯
              const moreTooltip = document.createElement('div');
              moreTooltip.className = 'tooltip';
              moreTooltip.style.display = 'none';
              
              // æ„å»ºå‰©ä½™èˆ¹æœŸä¿¡æ¯
              const moreTooltipContent = document.createElement('div');
              moreTooltipContent.style.padding = '8px';
              moreTooltipContent.style.maxHeight = '400px';
              moreTooltipContent.style.overflowY = 'auto';
              
              const moreTitle = document.createElement('div');
              moreTitle.style.cssText = 'font-weight: 600; color: #667eea; margin-bottom: 8px; font-size: 13px;';
              moreTitle.textContent = `è¿˜æœ‰ ${remainingItems.length} æ¡èˆ¹æœŸï¼š`;
              moreTooltipContent.appendChild(moreTitle);
              
              remainingItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'padding: 6px 0; border-bottom: 1px solid #e9ecef; font-size: 12px;';
                
                if (state.currentMode === MODE_365 && item.mode === MODE_365) {
                  const vesselText = item.vessel || '';
                  const shipTypeText = item.shipType ? ` ${item.shipType}TEU` : '';
                  const thirdLine = vesselText + shipTypeText;
                  const portText = item.isMerged ? item.portsText : (item.port || '');
                  
                  itemDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; color: #1f2d3d;">${item.carrier || ''}</div>
                    <div style="color: #667eea; font-weight: 500; margin-bottom: 4px; font-size: 12px;">${portText}</div>
                    <div style="color: #495057; font-size: 11px; line-height: 1.5;">${thirdLine || ''}</div>
                  `;
                } else {
                  // 001æ¨¡å¼ï¼šç¬¬ä¸€è¡Œå…±èˆ±èˆ¹å…¬å¸ï¼Œç¬¬äºŒè¡Œæ¸¯å£ï¼Œç¬¬ä¸‰è¡Œèˆ¹åèˆªæ¬¡+èˆ¹å‹
                  const portText = item.isMerged ? item.portsText : (item.port || '');
                  const vesselText = item.vessel || '';
                  const shipTypeText = item.shipType ? ` ${item.shipType}TEU` : '';
                  const thirdLine = vesselText + shipTypeText;
                  
                  itemDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; color: #1f2d3d;">${item.carrier || ''}</div>
                    <div style="color: #667eea; font-weight: 500; margin-bottom: 4px; font-size: 12px;">${portText}</div>
                    ${thirdLine ? `<div style="color: #495057; font-size: 11px; line-height: 1.5;">${thirdLine}</div>` : ''}
                  `;
                }
                
                moreTooltipContent.appendChild(itemDiv);
              });
              
              moreTooltip.appendChild(moreTooltipContent);
              document.body.appendChild(moreTooltip);
              
              // æ·»åŠ æ‚¬åœäº‹ä»¶
              let moreTooltipTimeout;
              moreEl.addEventListener('mouseenter', (e) => {
                clearTimeout(moreTooltipTimeout);
                moreTooltip.style.display = 'block';
                positionTooltip(moreTooltip, moreEl);
              });
              moreEl.addEventListener('mouseleave', () => {
                moreTooltipTimeout = setTimeout(() => {
                  moreTooltip.style.display = 'none';
                }, 100);
              });
              moreEl.addEventListener('mousemove', (e) => {
                clearTimeout(moreTooltipTimeout);
                if (moreTooltip.style.display === 'block') {
                  positionTooltip(moreTooltip, moreEl);
                }
              });
              
              dayCell.appendChild(moreEl);
            }

            weekRow.appendChild(dayCell);
          }

          dom.calendarBody.appendChild(weekRow);
        });
      }

      /**
       * æ¸²æŸ“æœˆåº¦æ±‡æ€»è¡¨æ ¼
       * æ˜¾ç¤ºå„èˆªçº¿æŒ‰æœˆæ±‡æ€»çš„é æ³Šæƒ…å†µ
       */
      function renderMonthlySummary() {
        const hasFilters = state.selectedRegions.length > 0 || 
                          state.selectedCarriers.length > 0 || 
                          state.selectedPorts.length > 0;

        if (!hasFilters) {
          dom.monthlySummaryContainer.classList.add('hidden');
          dom.monthlySummaryEmptyMessage.style.display = 'block';
          return;
        }

        // è·å–å½“å‰æ•°æ®
        const currentData = state.currentMode === MODE_001 ? state.data001 : state.data365;
        if (!currentData || currentData.length === 0) {
          dom.monthlySummaryContainer.classList.add('hidden');
          dom.monthlySummaryEmptyMessage.style.display = 'block';
          dom.monthlySummaryEmptyMessage.textContent = `è¯·å…ˆåŠ è½½ ${state.currentMode} æ•°æ®æ–‡ä»¶`;
          return;
        }

        // ç­›é€‰æ•°æ®ï¼ˆä½¿ç”¨ä¸æ—¥å†ç›¸åŒçš„ç­›é€‰é€»è¾‘ï¼‰
        const filteredData = currentData.filter(item => {
          // åŒºåŸŸç­›é€‰
          if (state.selectedRegions.length > 0) {
            const itemRegion = getPortRegion(item.port);
            if (!itemRegion || !state.selectedRegions.includes(itemRegion)) {
              return false;
            }
          }

          // èˆ¹å…¬å¸ç­›é€‰
          if (state.selectedCarriers.length > 0) {
            if (!state.selectedCarriers.includes(item.carrier)) {
              return false;
            }
          }

          // æ¸¯å£ç­›é€‰
          if (state.selectedPorts.length > 0) {
            if (!state.selectedPorts.includes(item.port)) {
              return false;
            }
          }

          return true;
        });

        if (filteredData.length === 0) {
          dom.monthlySummaryContainer.classList.add('hidden');
          dom.monthlySummaryEmptyMessage.style.display = 'block';
          return;
        }

        dom.monthlySummaryContainer.classList.remove('hidden');
        dom.monthlySummaryEmptyMessage.style.display = 'none';

        // å»é‡å¤„ç†ï¼ˆä½¿ç”¨ä¸æ—¥å†ç›¸åŒçš„å»é‡è§„åˆ™ï¼‰
        let uniqueData = typeof deduplicateSailingItems === 'function'
          ? deduplicateSailingItems(filteredData)
          : deduplicateItems(filteredData);

        // åˆå¹¶åŒèˆ¹åèˆªæ¬¡èˆ¹å‹çš„æ•°æ®ï¼ˆä½¿ç”¨ä¸æ—¥å†ç›¸åŒçš„åˆå¹¶è§„åˆ™ï¼‰
        const mergeByVessel = (items) => {
          const grouped = {};
          
          items.forEach(item => {
            let groupKey;
            let vesselName, voyageNumber, shipType, carrier;
            
            // 365æ¨¡å¼ï¼šåŒä¸€å¤© + åŒèˆ¹å(Qåˆ—) + åŒèˆªçº¿ID(Gåˆ—)
            if (item.mode === '365') {
              const dateKey = formatDateKey(item.date);
              vesselName = item.vesselName || getVesselName(item.vessel || '');
              const routeId = item.routeId || '';
              groupKey = `${dateKey}_${vesselName}_${routeId}`;
            } else {
              // 001æ¨¡å¼ï¼šèˆ¹å + èˆªæ¬¡ + èˆ¹å‹ + èˆ¹å…¬å¸
              vesselName = getVesselName(item.vessel || '');
              voyageNumber = getVoyageNumber(item.vessel || '');
              shipType = item.shipType || '';
              carrier = item.carrier || '';
              groupKey = `${vesselName}_${voyageNumber}_${shipType}_${carrier}`;
            }
            
            if (!grouped[groupKey]) {
              if (item.mode === MODE_365) {
                grouped[groupKey] = {
                  vessel: item.vessel || '',
                  vesselName: item.vesselName || getVesselName(item.vessel || ''),
                  shipType: item.shipType || '',
                  carriers: [],
                  carriersSet: new Set(),
                  ports: [],
                  portsSet: new Set(),
                  routeId: item.routeId || '',
                  mode: item.mode,
                  date: item.date
                };
              } else {
                grouped[groupKey] = {
                  vessel: item.vessel || '',
                  vesselName: vesselName,
                  voyageNumber: voyageNumber,
                  shipType: shipType,
                  carrier: carrier,
                  ports: [],
                  portsSet: new Set(),
                  mode: item.mode,
                  date: item.date
                };
              }
            }
            
            // æ·»åŠ æ¸¯å£ï¼ˆå»é‡ï¼‰
            if (item.port && !grouped[groupKey].portsSet.has(item.port)) {
              grouped[groupKey].ports.push(item.port);
              grouped[groupKey].portsSet.add(item.port);
            }
            
            // 365æ¨¡å¼ï¼šæ”¶é›†å…±èˆ±èˆ¹å…¬å¸
            if (item.mode === MODE_365 && item.carrier && !grouped[groupKey].carriersSet.has(item.carrier)) {
              grouped[groupKey].carriers.push(item.carrier);
              grouped[groupKey].carriersSet.add(item.carrier);
            }
            // 365æ¨¡å¼ï¼šè®°å½•èˆªçº¿è·¯å¾„ï¼ˆä¼˜å…ˆä¿ç•™å·²æœ‰çš„éç©ºè·¯å¾„ï¼‰
            if (item.mode === MODE_365 && !grouped[groupKey].routePath && item.routePath) {
              grouped[groupKey].routePath = item.routePath;
            }
          });
          
          return Object.values(grouped).map(group => {
            // 365æ¨¡å¼ï¼šé€‰æ‹©æœ€é•¿çš„å…±èˆ±èˆ¹å…¬å¸
            if (group.mode === MODE_365) {
              const longestCarrier = group.carriers.reduce((longest, current) => {
                return current.length > longest.length ? current : longest;
              }, group.carriers[0] || '');
              group.carrier = longestCarrier;
            }
            
            if (group.ports.length > 1) {
              return {
                ...group,
                ports: group.ports,
                portsText: group.ports.join('ã€'),
                isMerged: true
              };
            } else {
              return {
                ...group,
                port: group.ports[0] || '',
                isMerged: false
              };
            }
          });
        };

        const mergedData = mergeByVessel(uniqueData);

        // å®šä¹‰èˆªçº¿ï¼šä½¿ç”¨èˆªçº¿IDä½œä¸ºåˆ†ç»„é”®
        const getRouteKey = (item) => {
          // ä½¿ç”¨èˆªçº¿IDä½œä¸ºåˆ†ç»„é”®ï¼ˆ001æ¨¡å¼ï¼šCåˆ—ï¼Œ365æ¨¡å¼ï¼šGåˆ—ï¼‰
          // å¦‚æœèˆªçº¿IDä¸ºç©ºæˆ–æ— æ•ˆï¼Œä½¿ç”¨å…±èˆ±èˆ¹å…¬å¸ä½œä¸ºåˆ†ç»„é”®ï¼ˆä½œä¸ºfallbackï¼‰
          if (item.routeId && item.routeId.trim()) {
            return item.routeId.trim();
          }
          // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„èˆªçº¿IDï¼Œä½¿ç”¨å…±èˆ±èˆ¹å…¬å¸ä½œä¸ºåˆ†ç»„é”®
          return item.carrier || 'æœªçŸ¥';
        };

        // æŒ‰èˆªçº¿IDåˆ†ç»„ï¼Œå¹¶æ”¶é›†æ¯ä¸ªèˆªçº¿IDä¸‹çš„æ‰€æœ‰å…±èˆ±èˆ¹å…¬å¸
        const routesMap = new Map(); // key: routeId, value: { items: [], carriers: Set }
        mergedData.forEach(item => {
          const routeKey = getRouteKey(item);
          if (!routesMap.has(routeKey)) {
            routesMap.set(routeKey, {
              items: [],
              carriers: new Set()
            });
          }
          const routeData = routesMap.get(routeKey);
          routeData.items.push(item);
          if (item.carrier) {
            routeData.carriers.add(item.carrier);
          }
        });

        // è·å–æ‰€æœ‰æœˆä»½ï¼ˆä»æ•°æ®ä¸­æå–ï¼‰
        const monthsSet = new Set();
        mergedData.forEach(item => {
          const year = item.date.getFullYear();
          const month = String(item.date.getMonth() + 1).padStart(2, '0');
          const monthKey = `${year}${month}`;
          monthsSet.add(monthKey);
        });

        const months = Array.from(monthsSet).sort();

        // æ„å»ºè¡¨æ ¼
        let tableHTML = '<table class="monthly-summary-table"><thead><tr>';
        tableHTML += '<th>èˆªçº¿</th>';
        months.forEach(month => {
          const year = month.substring(0, 4);
          const monthNum = month.substring(4);
          tableHTML += `<th>${year}${monthNum}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        // æŒ‰èˆªçº¿IDæ’åº
        const sortedRoutes = Array.from(routesMap.entries()).sort((a, b) => {
          // å…ˆæŒ‰èˆªçº¿IDæ’åºï¼ˆæ•°å­—ä¼˜å…ˆï¼Œç„¶åå­—æ¯ï¼‰
          const aKey = a[0];
          const bKey = b[0];
          const aNum = parseInt(aKey);
          const bNum = parseInt(bKey);
          if (!isNaN(aNum) && !isNaN(bNum)) {
            return aNum - bNum;
          }
          if (!isNaN(aNum)) return -1;
          if (!isNaN(bNum)) return 1;
          return aKey.localeCompare(bKey, 'zh-Hans-CN');
        });

        // ç»Ÿè®¡æ¯ä¸ªæœˆçš„æ€»èˆ¹æ¬¡ï¼ˆç”¨äºæ€»è®¡è¡Œï¼‰
        const monthlyTotals = new Map();
        months.forEach(month => {
          monthlyTotals.set(month, 0);
        });

        sortedRoutes.forEach(([routeKey, routeData]) => {
          const items = routeData.items;
          // é€‰æ‹©è¯¥èˆªçº¿IDä¸‹å…±èˆ±èˆ¹å…¬å¸åå­—æœ€é•¿çš„ä½œä¸ºæ˜¾ç¤ºåç§°
          const carriers = Array.from(routeData.carriers);
          const longestCarrier = carriers.reduce((longest, current) => {
            return current.length > longest.length ? current : longest;
          }, carriers[0] || 'æœªçŸ¥');
          
          tableHTML += '<tr>';
          const routePathRaw = items.find(item => item.routePath)?.routePath || '';
          const routePath = normalizeRoutePath(routePathRaw);
          const routePathAttr = routePath ? ` data-route-path="${escapeAttr(routePath)}"` : '';
          
          // åˆ¤æ–­å½“å‰æ¨¡å¼
          const is365Mode = state.currentMode === MODE_365;
          
          // åˆ¤æ–­routeKeyæ˜¯å¦æ˜¯æœ‰æ•ˆçš„èˆªçº¿IDï¼ˆæ•°å­—æˆ–å­—æ¯æ•°å­—ç»„åˆï¼‰
          const isValidRouteId = routeKey && routeKey !== 'æœªçŸ¥' && /^[0-9A-Za-z\-_]+$/.test(routeKey) && /[0-9A-Za-z]/.test(routeKey);
          
          // æ˜¾ç¤ºæ ¼å¼ï¼š
          // 365æ¨¡å¼ï¼šåªæ˜¾ç¤ºå…±èˆ±èˆ¹å…¬å¸ï¼ˆæœ€é•¿çš„ï¼‰ï¼Œä¸æ˜¾ç¤ºèˆªçº¿ID
          // 001æ¨¡å¼ï¼šå¦‚æœæœ‰æœ‰æ•ˆçš„èˆªçº¿IDï¼Œæ˜¾ç¤º"èˆªçº¿ID - å…±èˆ±èˆ¹å…¬å¸ï¼ˆæœ€é•¿çš„ï¼‰"ï¼Œå¦åˆ™åªæ˜¾ç¤ºå…±èˆ±èˆ¹å…¬å¸
          const displayText = is365Mode
            ? longestCarrier
            : (isValidRouteId ? `${routeKey} - ${longestCarrier}` : longestCarrier);
          tableHTML += `<td class="route-cell"${routePathAttr}>${escapeHtml(displayText)}</td>`;

          // æŒ‰æœˆä»½å¡«å……æ•°æ®
          months.forEach(month => {
            const year = parseInt(month.substring(0, 4));
            const monthNum = parseInt(month.substring(4)) - 1; // JavaScriptæœˆä»½ä»0å¼€å§‹

            // ç­›é€‰è¯¥æœˆä»½çš„æ•°æ®
            const monthItems = items.filter(item => {
              const itemYear = item.date.getFullYear();
              const itemMonth = item.date.getMonth();
              return itemYear === year && itemMonth === monthNum;
            });

            if (monthItems.length === 0) {
              tableHTML += '<td></td>';
            } else {
              // æŒ‰æ—¥æœŸæ’åº
              monthItems.sort((a, b) => a.date.getTime() - b.date.getTime());

              // ç»Ÿè®¡èˆ¹æ¬¡
              monthlyTotals.set(month, monthlyTotals.get(month) + monthItems.length);

              // æ„å»ºæ˜¾ç¤ºå†…å®¹ï¼šèˆ¹åèˆªæ¬¡(å¼€èˆªæ—¶é—´)
              const vesselInfoItems = monthItems.map(item => {
                const vesselText = item.vessel || '';
                const dateStr = formatDateForSummary(item.date);
                return `${vesselText}(${dateStr})`;
              });

              tableHTML += `<td><div class="vessel-info">`;
              vesselInfoItems.forEach(info => {
                tableHTML += `<div class="vessel-info-item">${info}</div>`;
              });
              tableHTML += `</div></td>`;
            }
          });

          tableHTML += '</tr>';
        });

        // æ·»åŠ æ€»è®¡è¡Œ
        tableHTML += '</tbody><tfoot><tr>';
        tableHTML += '<td>åˆè®¡</td>';
        months.forEach(month => {
          const total = monthlyTotals.get(month) || 0;
          tableHTML += `<td style="text-align: center; font-weight: 600; color: #667eea;">${total} è‰˜æ¬¡</td>`;
        });
        tableHTML += '</tr></tfoot></table>';
        dom.monthlySummaryTable.innerHTML = tableHTML;

        // ç»‘å®šèˆªçº¿è·¯å¾„æ‚¬åœæç¤º
        bindMonthlyRouteTooltips();
      }

      /**
       * æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ±‡æ€»è¡¨æ ¼æ˜¾ç¤º
       * @param {Date} date - æ—¥æœŸå¯¹è±¡
       * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆMM/DDï¼‰
       */
      function formatDateForSummary(date) {
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${month}/${day}`;
      }

      /**
       * è½¬ä¹‰HTMLå­—ç¬¦ä¸²ï¼Œé¿å…æ ‡é¢˜ä¸­çš„ç‰¹æ®Šå­—ç¬¦ç ´åç»“æ„
       * @param {string} str - å¾…è½¬ä¹‰çš„å­—ç¬¦ä¸²
       * @returns {string} è½¬ä¹‰åçš„å­—ç¬¦ä¸²
       */
      function escapeHtml(str) {
        if (typeof str !== 'string') return '';
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      /**
       * è½¬ä¹‰ç”¨äº HTML å±æ€§çš„å­—ç¬¦ä¸²ï¼ˆåŒ…å«æ¢è¡Œå¤„ç†ï¼‰
       * @param {string} str - åŸå§‹å­—ç¬¦ä¸²
       * @returns {string} è½¬ä¹‰åçš„å­—ç¬¦ä¸²
       */
      function escapeAttr(str) {
        if (typeof str !== 'string') return '';
        return escapeHtml(str).replace(/\r?\n/g, '&#10;');
      }

      /**
       * è§„èŒƒåŒ–èˆªçº¿è·¯å¾„æ–‡æœ¬ï¼šå»é™¤é‡å¤ç©ºç™½ã€åˆå¹¶é‡å¤è¡Œ
       * @param {string} str
       * @returns {string}
       */
      function normalizeRoutePath(str) {
        if (typeof str !== 'string') return '';
        const lines = str
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(Boolean);
        const uniq = [];
        lines.forEach(line => {
          if (!uniq.includes(line)) {
            uniq.push(line);
          }
        });
        return uniq.join('\n');
      }

      /**
       * åˆ›å»ºæ—¥å†é¡¹çš„æ‚¬åœæç¤ºäº‹ä»¶å¤„ç†å™¨
       * @param {HTMLElement} itemEl - æ—¥å†é¡¹å…ƒç´ 
       * @param {Object} item - æ•°æ®é¡¹
       * @returns {void}
       */
      function attachTooltipToItem(itemEl, item) {
        const tooltip = createTooltip(item);
        if (!tooltip) return;
        
        document.body.appendChild(tooltip);
        
        let tooltipTimeout;
        const handleMouseEnter = (e) => {
          clearTimeout(tooltipTimeout);
          tooltip.style.display = 'block';
          positionTooltip(tooltip, itemEl);
        };
        const handleMouseLeave = () => {
          tooltipTimeout = setTimeout(() => {
            tooltip.style.display = 'none';
          }, 100);
        };
        const handleMouseMove = (e) => {
          clearTimeout(tooltipTimeout);
          if (tooltip.style.display === 'block') {
            positionTooltip(tooltip, itemEl);
          }
        };
        
        itemEl.addEventListener('mouseenter', handleMouseEnter);
        itemEl.addEventListener('mouseleave', handleMouseLeave);
        itemEl.addEventListener('mousemove', handleMouseMove);
      }
      
      /**
       * æ¸²æŸ“æ—¥å†é¡¹ï¼ˆæŠ½å– 001/365 å…¬å…±é€»è¾‘ï¼‰
       * @param {HTMLElement} itemEl - æ—¥å†é¡¹å…ƒç´ 
       * @param {Object} item - æ•°æ®é¡¹
       * @param {string} currentMode - å½“å‰æ¨¡å¼ï¼ˆ'001' æˆ– '365'ï¼‰
       */
      function renderScheduleItem(itemEl, item, currentMode) {
        // å‡†å¤‡æ•°æ®
        const portText = item.isMerged ? item.portsText : (item.port || '');
        const vesselText = item.vessel || '';
        const shipTypeText = item.shipType ? ` ${item.shipType}TEU` : '';
        const thirdLine = vesselText + shipTypeText;
        
        // 001 æ¨¡å¼ï¼šåªåœ¨æœ‰ thirdLine æ—¶æ˜¾ç¤ºç¬¬ä¸‰è¡Œ
        // 365 æ¨¡å¼ï¼šæ€»æ˜¯æ˜¾ç¤ºç¬¬ä¸‰è¡Œ
        const showThirdLine = currentMode === MODE_365 || thirdLine;
        
        // æ„å»º HTML
        itemEl.innerHTML = `
          <div class="carrier" style="font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; color: #1f2d3d;">${item.carrier || ''}</div>
          <div class="port" style="color: #667eea; font-weight: 500; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px;">${portText}</div>
          ${showThirdLine ? `<div class="vessel" style="color: #495057; font-size: 12px; line-height: 1.5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${thirdLine || ''}</div>` : ''}
        `;
        
        // å­˜å‚¨èˆªçº¿ä¿¡æ¯ç”¨äºç‚¹å‡»é«˜äº®
        itemEl.dataset.carrier = item.carrier || '';
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜¾ç¤º tooltip
        // 365 æ¨¡å¼ï¼šåªè¦æœ‰ä»»æ„ä¸€ä¸ªå­—æ®µå°±æ˜¾ç¤º
        // 001 æ¨¡å¼ï¼šåªè¦æœ‰ carrier æˆ– shipType æˆ–å…¶ä»–é¢å¤–ä¿¡æ¯å°±æ˜¾ç¤º
        const shouldShowTooltip = currentMode === MODE_365
          ? (item.weekday || item.voyageDays || item.originTerminal || item.destTerminal || 
             item.shipType || item.year || item.routePath)
          : (item.carrier || item.shipType || item.weekday || item.voyageDays || 
             item.originTerminal || item.destTerminal);
        
        if (shouldShowTooltip) {
          attachTooltipToItem(itemEl, item);
        }
      }
      
      /**
       * æ¸²æŸ“å‰©ä½™é¡¹ç›®ï¼ˆç”¨äº"è¿˜æœ‰ X æ¡"æç¤ºæ¡†ï¼‰
       * @param {Object} item - æ•°æ®é¡¹
       * @param {string} currentMode - å½“å‰æ¨¡å¼
       * @returns {string} HTML å­—ç¬¦ä¸²
       */
      function renderRemainingItem(item, currentMode) {
        const portText = item.isMerged ? item.portsText : (item.port || '');
        const vesselText = item.vessel || '';
        const shipTypeText = item.shipType ? ` ${item.shipType}TEU` : '';
        const thirdLine = vesselText + shipTypeText;
        const showThirdLine = currentMode === MODE_365 || thirdLine;
        
        return `
          <div style="font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; color: #1f2d3d;">${item.carrier || ''}</div>
          <div style="color: #667eea; font-weight: 500; margin-bottom: 4px; font-size: 12px;">${portText}</div>
          ${showThirdLine ? `<div style="color: #495057; font-size: 11px; line-height: 1.5;">${thirdLine || ''}</div>` : ''}
        `;
      }

      // æå–èˆ¹åï¼ˆå»é™¤èˆªæ¬¡å·ï¼‰
      function getVesselName(vesselText) {
        if (!vesselText) return '';
        // èˆ¹åèˆªæ¬¡æ ¼å¼é€šå¸¸æ˜¯ "èˆ¹å/èˆªæ¬¡" æˆ– "èˆ¹å èˆªæ¬¡" æˆ– "èˆ¹åèˆªæ¬¡"
        const parts = vesselText.split(/[\/\s]/);
        return parts[0] ? parts[0].trim() : '';
      }
      
      // æå–èˆªæ¬¡å·
      function getVoyageNumber(vesselText) {
        if (!vesselText) return '';
        const parts = vesselText.split(/[\/\s]/);
        return parts.length > 1 ? parts[1].trim() : '';
      }

      // å»é‡å‡½æ•°ï¼šç»Ÿä¸€è°ƒç”¨ vendor ä¸­çš„æ ‡å‡†å®ç°ï¼ˆå…¼å®¹è€é€»è¾‘ï¼‰
      function deduplicateItems(items) {
        if (typeof deduplicateSailingItems === 'function') {
          return deduplicateSailingItems(items);
        }
        if (!items || items.length === 0) return [];
        // å›é€€åˆ°åŸæœ‰é€»è¾‘ï¼ˆä¸ä¼šè§¦å‘ï¼Œå› ä¸ºå·²å¯¼å‡ºå…¬å…±å‡½æ•°ï¼‰
        return items;
      }

      // å·¥å…·å‡½æ•°
      function formatDateKey(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function isToday(date) {
        const today = new Date();
        return date.getFullYear() === today.getFullYear() &&
               date.getMonth() === today.getMonth() &&
               date.getDate() === today.getDate();
      }

      function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      }

      // åˆ›å»ºæ‚¬åœæç¤ºæ¡†
      function createTooltip(item) {
        const lines = [];
        const is001Mode = item.mode === MODE_001;
        
        // ç¬¬ä¸€è¡Œï¼šå…±èˆ±èˆ¹å…¬å¸ï¼ˆå®Œæ•´æ˜¾ç¤ºï¼Œé¿å…èˆ¹æœŸè¡¨ä¸­æ˜¾ç¤ºä¸å…¨ï¼‰
        if (item.carrier) {
          lines.push(`
            <div class="tooltip-line">
              <span class="tooltip-label">å…±èˆ±èˆ¹å…¬å¸ï¼š</span>
              <span class="tooltip-value" style="grid-column: 2 / -1;">${item.carrier}</span>
            </div>
          `);
        }
        
        // ç¬¬äºŒè¡Œï¼šæ ‡å‡†å¼€èˆªæ—¥ + æ ‡å‡†èˆªç¨‹ï¼ˆå¯¹é½æ ¼å¼ï¼‰
        if (item.weekday || item.voyageDays) {
          // å¤„ç†weekdayï¼šå¦‚æœå·²ç»æ˜¯"å‘¨x"æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦‚æœæ˜¯æ•°å­—ï¼Œè½¬æ¢ä¸º"å‘¨x"
          let weekdayText = '';
          if (item.weekday) {
            const weekdayStr = String(item.weekday).trim();
            // å¦‚æœå·²ç»åŒ…å«"å‘¨"å­—ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™æ·»åŠ "å‘¨"å‰ç¼€
            if (weekdayStr.includes('å‘¨')) {
              weekdayText = weekdayStr.replace(/å‘¨+/g, 'å‘¨'); // å»æ‰é‡å¤çš„"å‘¨"å­—
            } else {
              weekdayText = `å‘¨${weekdayStr}`;
            }
          }
          
          // å¤„ç†voyageDaysï¼šå»æ‰é‡å¤çš„"å¤©"å­—
          let voyageText = '';
          if (item.voyageDays) {
            const voyageStr = String(item.voyageDays).trim();
            // å»æ‰æœ«å°¾çš„"å¤©"å­—ï¼Œç„¶åç»Ÿä¸€æ·»åŠ ä¸€ä¸ª"å¤©"
            voyageText = voyageStr.replace(/å¤©+$/, '') + 'å¤©';
          }
          
          lines.push(`
            <div class="tooltip-line">
              <span class="tooltip-label">æ ‡å‡†å¼€èˆªæ—¥ï¼š</span>
              <span class="tooltip-value">${weekdayText}</span>
              <span class="tooltip-label">æ ‡å‡†èˆªç¨‹ï¼š</span>
              <span class="tooltip-value">${voyageText}</span>
            </div>
          `);
        }
        
        // ç¬¬ä¸‰è¡Œï¼šèµ·è¿æ¸¯ç å¤´ + ç›®çš„æ¸¯ç å¤´ï¼ˆå¯¹é½æ ¼å¼ï¼‰
        if (item.originTerminal || item.destTerminal) {
          const originText = item.originTerminal || '';
          const destText = item.destTerminal || '';
          lines.push(`
            <div class="tooltip-line">
              <span class="tooltip-label">èµ·è¿æ¸¯ç å¤´ï¼š</span>
              <span class="tooltip-value">${originText}</span>
              <span class="tooltip-label">ç›®çš„æ¸¯ç å¤´ï¼š</span>
              <span class="tooltip-value">${destText}</span>
            </div>
          `);
        }
        
        // ç¬¬å››è¡Œï¼šèˆ¹èˆ¶èˆ¹å‹ + å»ºé€ å¹´ä»½ï¼ˆä»…365æ¨¡å¼æ˜¾ç¤ºï¼‰
        if (!is001Mode) {
          if (item.shipType || item.year) {
            const shipTypeText = item.shipType ? `${item.shipType} TEU` : '';
            const yearText = item.year || '';
            lines.push(`
              <div class="tooltip-line">
                <span class="tooltip-label">èˆ¹èˆ¶èˆ¹å‹ï¼š</span>
                <span class="tooltip-value">${shipTypeText}</span>
                <span class="tooltip-label">å»ºé€ å¹´ä»½ï¼š</span>
                <span class="tooltip-value">${yearText}</span>
              </div>
            `);
          }
        }
        
        // ç¬¬äº”è¡Œï¼šèˆªçº¿è·¯å¾„ï¼ˆä»…365æ¨¡å¼æ˜¾ç¤ºï¼‰
        if (!is001Mode && item.routePath) {
          lines.push(`
            <div class="tooltip-line">
              <span class="tooltip-label">èˆªçº¿è·¯å¾„ï¼š</span>
              <span class="tooltip-value tooltip-path" style="grid-column: 2 / -1;">${item.routePath}</span>
            </div>
          `);
        }
        
        // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œè¿”å›null
        if (lines.length === 0) {
          return null;
        }
        
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.style.display = 'none';
        tooltip.innerHTML = lines.join('');
        return tooltip;
      }

      // å®šä½æç¤ºæ¡†
      function positionTooltip(tooltip, target) {
        const rect = target.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        
        // é»˜è®¤æ˜¾ç¤ºåœ¨å³ä¾§
        let left = rect.right + 10;
        let top = rect.top;
        
        // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨å·¦ä¾§
        if (left + tooltipRect.width > window.innerWidth) {
          left = rect.left - tooltipRect.width - 10;
        }
        
        // ç¡®ä¿ä¸è¶…å‡ºå·¦è¾¹ç•Œ
        if (left < 10) {
          left = 10;
        }
        
        // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œå‘ä¸Šè°ƒæ•´
        if (top + tooltipRect.height > window.innerHeight) {
          top = window.innerHeight - tooltipRect.height - 10;
        }
        
        // ç¡®ä¿ä¸è¶…å‡ºä¸Šè¾¹ç•Œ
        if (top < 10) {
          top = 10;
        }
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
      }

      // loadScript, loadPdfLibraries, exportToPdf å‡½æ•°å·²ç§»è‡³ vendor/pdf-utils.js å’Œ vendor/common-utils.js
      
      /**
       * å¯¼å‡ºPDFåŠŸèƒ½ï¼ˆä½¿ç”¨ vendor/pdf-utils.js ä¸­çš„å‡½æ•°ï¼‰
       */
      async function handleExportPdf() {
        const exportBtn = dom.exportPdfBtn;
        if (!exportBtn) return;

        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        const currentData = state.currentMode === MODE_001 ? state.data001 : state.data365;
        if (!currentData || currentData.length === 0) {
          showError(ErrorType.DATA_VALIDATION, 'NO_DATA');
          return;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰ç»“æœ
        const hasFilters = state.selectedRegions.length > 0 || 
                          state.selectedCarriers.length > 0 || 
                          state.selectedPorts.length > 0;
        if (!hasFilters) {
          showError(ErrorType.DATA_VALIDATION, 'NO_FILTERS');
          return;
        }

        try {
          exportBtn.disabled = true;
          exportBtn.textContent = 'å¯¼å‡ºä¸­...';

          // ç”Ÿæˆæ–‡ä»¶åï¼šMonitor-Sailing-Schedule_å¹´æœˆæ—¥.pdf
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const fileName = `Monitor-Sailing-Schedule_${year}${month}${day}`;

          // ä½¿ç”¨ vendor/pdf-utils.js ä¸­çš„ exportToPdf å‡½æ•°
          // å¯¼å‡ºæ•´ä¸ªé¡µé¢å†…å®¹ï¼ŒåŒ…æ‹¬å¤´éƒ¨ã€å†…å®¹åŒºåŸŸå’Œé¡µè„š
          // åˆ›å»ºä¸€ä¸ªä¸´æ—¶åŒ…è£…å™¨åŒ…å«æ‰€æœ‰éœ€è¦å¯¼å‡ºçš„å†…å®¹
          const tempWrapper = document.createElement('div');
          tempWrapper.style.cssText = 'position: absolute; left: -9999px; top: -9999px; width: 100%;';
          
          const container = document.querySelector('.container');
          const footer = document.querySelector('.page-footer');
          
          if (container) {
            const containerClone = container.cloneNode(true);
            tempWrapper.appendChild(containerClone);
          }
          
          if (footer) {
            const footerClone = footer.cloneNode(true);
            tempWrapper.appendChild(footerClone);
          }
          
          document.body.appendChild(tempWrapper);
          
          try {
            await exportToPdf(tempWrapper, {
            fileName: fileName,
            onStart: () => {
              exportBtn.disabled = true;
              exportBtn.textContent = 'å¯¼å‡ºä¸­...';
            },
            onComplete: () => {
              exportBtn.textContent = 'å¯¼å‡º PDF';
              exportBtn.disabled = false;
            },
            onError: (error) => {
              debugError('å¯¼å‡ºPDFå¤±è´¥:', error);
              showError(ErrorType.API_ERROR, 'API_REQUEST_FAILED', { 
                message: error.message || String(error) 
              }, error);
              exportBtn.textContent = 'å¯¼å‡º PDF';
              exportBtn.disabled = false;
            }
          });
          } finally {
            // æ¸…ç†ä¸´æ—¶åŒ…è£…å™¨
            if (tempWrapper && tempWrapper.parentNode) {
              tempWrapper.parentNode.removeChild(tempWrapper);
            }
          }
        } catch (error) {
          debugError('å¯¼å‡ºPDFå¤±è´¥:', error);
          showError(ErrorType.API_ERROR, 'API_REQUEST_FAILED', { 
            message: error.message || String(error) 
          }, error);
          exportBtn.textContent = 'å¯¼å‡º PDF';
          exportBtn.disabled = false;
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      // ==================== AI åˆ†ææ¨¡å— ====================
      
      // AI æä¾›å•†é…ç½®ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å·¥å…·æ¨¡å—ï¼‰
      const aiProviders = createAiProviders('sailing', {
        deepseek: { maxTokens: 8000 },
        kimi: { maxTokens: 8000 },
        qwen: { maxTokens: 8000 }
      });

      let activeAiProvider = 'deepseek';
      let setActiveAiPanelBound = null;

      /**
       * åˆå§‹åŒ–AIæ¨¡å—ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å·¥å…·æ¨¡å—ï¼‰
       */
      function initSailingAiModule() {
        // ä½¿ç”¨ç»Ÿä¸€çš„ AI å·¥å…·æ¨¡å—åˆå§‹åŒ–ï¼ˆç›´æ¥è°ƒç”¨å…¨å±€å‡½æ•°ï¼Œé¿å…é€’å½’ï¼‰
        setActiveAiPanelBound = initAiModule(aiProviders, eventListeners);
        
        loadAiConfigsFromStorage(aiProviders);
        updateAiModuleVisibility();
      }

      /**
       * è®¾ç½®æ´»åŠ¨çš„ AI é¢æ¿ï¼ˆä½¿ç”¨ç»Ÿä¸€å·¥å…·æ¨¡å—ï¼‰
       * @param {string} providerId - æä¾›å•† ID
       */
      function setActiveAiPanel(providerId = 'deepseek') {
        const result = setActiveAiPanelBound(providerId);
        if (result) {
          activeAiProvider = result;
        }
      }

      /**
       * åŠ è½½ AI é…ç½®ï¼ˆä½¿ç”¨ç»Ÿä¸€å·¥å…·æ¨¡å—ï¼‰
       */
      function loadAiConfigs() {
        loadAiConfigsFromStorage(aiProviders);
      }

      /**
       * è·å– AI é…ç½®ï¼ˆä½¿ç”¨ç»Ÿä¸€å·¥å…·æ¨¡å—ï¼‰
       * @param {string} providerId - æä¾›å•† ID
       * @returns {Object|null} é…ç½®å¯¹è±¡
       */
      function getAiConfig(providerId = 'deepseek') {
        return getAiConfigFromInputs(providerId, aiProviders);
      }

      /**
       * ä¿å­˜ AI é…ç½®ï¼ˆä½¿ç”¨ç»Ÿä¸€å·¥å…·æ¨¡å—ï¼‰
       * @param {string} providerId - æä¾›å•† ID
       */
      function saveAiConfig(providerId = 'deepseek') {
        saveAiConfigToStorage(providerId, aiProviders, (providerName) => {
          // ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å—
          const configSavedMsg = typeof getErrorMessage === 'function'
              ? getErrorMessage(ErrorType.USER_ACTION, 'CONFIG_SAVED', { provider: providerName })
              : `${providerName} API é…ç½®å·²ä¿å­˜`;
          showSuccess(configSavedMsg);
        });
      }

      /**
       * æ›´æ–°AIæ¨¡å—å¯è§æ€§
       * æ ¹æ®æ•°æ®åŠ è½½çŠ¶æ€å’Œç­›é€‰æ¡ä»¶æ˜¾ç¤º/éšè—AIåˆ†ææ¨¡å—
       */
      function updateAiModuleVisibility() {
        const aiSection = dom.aiAnalysisSection;
        const emptyMessage = dom.emptyAiMessage;
        const configSection = dom.aiConfigSection;
        
        if (!aiSection) return;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶
        const hasFilters = (state.selectedRegions.length > 0 || 
                           state.selectedCarriers.length > 0 || 
                           state.selectedPorts.length > 0);
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ï¼ˆéœ€è¦å…ˆæ£€æŸ¥æ˜¯å¦ä¸º nullï¼‰
        const hasData = (state.currentMode === MODE_001 && state.data001 && state.data001.length > 0) ||
                        (state.currentMode === MODE_365 && state.data365 && state.data365.length > 0);
        
        if (hasFilters && hasData) {
          aiSection.style.display = 'block';
          if (emptyMessage) emptyMessage.style.display = 'none';
          if (configSection) configSection.style.display = 'block';
        } else {
          aiSection.style.display = 'block';
          if (emptyMessage) emptyMessage.style.display = 'block';
          if (configSection) configSection.style.display = 'none';
        }
      }

      /**
       * æ„å»ºAIåˆ†ææç¤ºè¯
       * @returns {string|null} æ„å»ºçš„æç¤ºè¯ï¼Œå¦‚æœæ•°æ®æ— æ•ˆåˆ™è¿”å› null
       */
      function buildAiPrompt() {
        // è·å–å½“å‰ç­›é€‰åçš„æ•°æ®
        const currentData = state.currentMode === MODE_001 ? state.data001 : state.data365;
        if (!currentData || currentData.length === 0) {
          showError(ErrorType.DATA_VALIDATION, 'NO_DATA_FOR_ANALYSIS');
          return null;
        }

        // åº”ç”¨ç­›é€‰æ¡ä»¶
        let filteredData = currentData.filter(item => {
          // åŒºåŸŸç­›é€‰
          if (state.selectedRegions.length > 0) {
            const itemRegion = getPortRegion(item.port);
            if (!state.selectedRegions.includes(itemRegion)) {
              return false;
            }
          }
          
          // èˆ¹å…¬å¸ç­›é€‰
          if (state.selectedCarriers.length > 0) {
            if (!state.selectedCarriers.includes(item.carrier)) {
              return false;
            }
          }
          
          // æ¸¯å£ç­›é€‰
          if (state.selectedPorts.length > 0) {
            if (!state.selectedPorts.includes(item.port)) {
              return false;
            }
          }
          
          return true;
        });

        if (filteredData.length === 0) {
          showError(ErrorType.DATA_VALIDATION, 'NO_FILTERED_DATA');
          return null;
        }

        // æŒ‰åŒºåŸŸå’Œèˆªçº¿åˆ†ç»„æ•°æ®
        const groupedByRegion = {};
        filteredData.forEach(item => {
          const region = getPortRegion(item.port);
          if (!groupedByRegion[region]) {
            groupedByRegion[region] = {};
          }
          
          // æŒ‰èˆ¹å…¬å¸åˆ†ç»„ï¼ˆä½œä¸ºèˆªçº¿æ ‡è¯†ï¼‰
          const routeKey = item.carrier || 'æœªçŸ¥èˆ¹å…¬å¸';
          if (!groupedByRegion[region][routeKey]) {
            groupedByRegion[region][routeKey] = [];
          }
          
          groupedByRegion[region][routeKey].push(item);
        });

        // æ„å»ºæ•°æ®æè¿°
        let dataDescription = `ã€ç­›é€‰æ¡ä»¶ã€‘\n`;
        if (state.selectedRegions.length > 0) {
          dataDescription += `åŒºåŸŸï¼š${state.selectedRegions.join('ã€')}\n`;
        }
        if (state.selectedCarriers.length > 0) {
          dataDescription += `èˆ¹å…¬å¸ï¼š${state.selectedCarriers.join('ã€')}\n`;
        }
        if (state.selectedPorts.length > 0) {
          dataDescription += `æ¸¯å£ï¼š${state.selectedPorts.join('ã€')}\n`;
        }
        dataDescription += `æ•°æ®æ¨¡å¼ï¼š${state.currentMode}\n\n`;

        dataDescription += `ã€èˆ¹æœŸæ•°æ®ã€‘\n`;
        dataDescription += `å…± ${filteredData.length} æ¡èˆ¹æœŸè®°å½•\n\n`;

        // æŒ‰åŒºåŸŸç»„ç»‡æ•°æ®
        Object.keys(groupedByRegion).sort().forEach(region => {
          dataDescription += `## ${region}\n\n`;
          const routes = groupedByRegion[region];
          
          Object.keys(routes).sort().forEach(routeKey => {
            const items = routes[routeKey];
            // æŒ‰æ—¥æœŸæ’åº
            items.sort((a, b) => a.date.getTime() - b.date.getTime());
            
            dataDescription += `### èˆªçº¿ï¼š${routeKey}\n`;
            dataDescription += `èˆ¹æœŸè®°å½•æ•°ï¼š${items.length}\n\n`;
            
            // æŒ‰å‘¨åˆ†ç»„æ˜¾ç¤º
            const weeklyData = {};
            items.forEach(item => {
              const weekKey = getWeekKey(item.date);
              if (!weeklyData[weekKey]) {
                weeklyData[weekKey] = [];
              }
              weeklyData[weekKey].push(item);
            });
            
            Object.keys(weeklyData).sort().forEach(weekKey => {
              const weekItems = weeklyData[weekKey];
              dataDescription += `**${weekKey}**ï¼š\n`;
              weekItems.forEach(item => {
                const dateStr = formatDate(item.date);
                const port = item.port || '';
                const carrier = item.carrier || '';
                const vessel = item.vessel || '';
                const shipType = item.shipType ? `${item.shipType}TEU` : '';
                dataDescription += `  - ${dateStr} | ${port} | ${carrier} | ${vessel}${shipType ? ' ' + shipType : ''}\n`;
              });
              dataDescription += `\n`;
            });
            
            dataDescription += `\n`;
          });
          
          dataDescription += `\n`;
        });

        // ç»„åˆå®Œæ•´æç¤ºè¯
        const fullPrompt = `${sailingScheduleInstructionTemplate}\n\n${dataDescription}`;
        
        return fullPrompt;
      }

      /**
       * ä¸ºæœˆåº¦æ±‡æ€»ä¸­çš„èˆªçº¿åˆ—ç»‘å®šæ‚¬åœæç¤º
       */
      function bindMonthlyRouteTooltips() {
        const routeCells = dom.monthlySummaryTable?.querySelectorAll('.route-cell') || [];
        routeCells.forEach(cell => {
          const routePath = normalizeRoutePath(cell.dataset.routePath || '');
          if (!routePath) return;
          cell.dataset.routePath = routePath; // åŒæ­¥è§„èŒƒåŒ–åçš„æ–‡æœ¬

          // æ‡’åˆ›å»º tooltip
          let tooltip = null;
          let hideTimer = null;
          let moveHandler = null;

          const show = () => {
            clearTimeout(hideTimer);
            if (!tooltip) {
              tooltip = document.createElement('div');
              tooltip.className = 'tooltip';
              tooltip.style.display = 'none';
              const span = document.createElement('span');
              span.textContent = routePath;
              span.style.whiteSpace = 'pre-wrap';
              span.style.display = 'block';
              span.style.lineHeight = '1.5';
              span.style.fontSize = '12px';
              tooltip.appendChild(span);
              document.body.appendChild(tooltip);
            }

            const updatePosition = (event) => {
              if (!tooltip || !tooltip.parentNode) return;
              const mouseX = event.clientX;
              const mouseY = event.clientY;
              const rect = tooltip.getBoundingClientRect();
              const width = rect.width || tooltip.offsetWidth;
              const height = rect.height || tooltip.offsetHeight;
              const pad = 10;

              let left = mouseX + pad;
              let top = mouseY + pad;
              if (left + width > window.innerWidth) left = mouseX - width - pad;
              if (left < 0) left = (window.innerWidth - width) / 2;
              if (top + height > window.innerHeight) top = mouseY - height - pad;
              if (top < 0) top = mouseY + pad;

              tooltip.style.left = `${left}px`;
              tooltip.style.top = `${top}px`;
            };

            moveHandler = updatePosition;
            tooltip.style.display = 'block';
            requestAnimationFrame(() => updatePosition(window.event || { clientX: cell.getBoundingClientRect().right, clientY: cell.getBoundingClientRect().bottom }));
            eventListeners.add(cell, 'mousemove', moveHandler);
          };

          const hide = () => {
            hideTimer = setTimeout(() => {
              if (tooltip) tooltip.style.display = 'none';
              if (moveHandler) {
                cell.removeEventListener('mousemove', moveHandler);
                moveHandler = null;
              }
            }, 100);
          };

          eventListeners.add(cell, 'mouseenter', show);
          eventListeners.add(cell, 'mouseleave', hide);
          // mousemove åœ¨ show é‡Œç»‘å®š
        });
      }

      // è·å–å‘¨é”®ï¼ˆç”¨äºåˆ†ç»„ï¼‰
      function getWeekKey(date) {
        const year = date.getFullYear();
        const week = getWeekNumber(date);
        return `${year}å¹´ç¬¬${week}å‘¨`;
      }

      // æ ¼å¼åŒ–æ—¥æœŸ
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        const weekday = weekdays[date.getDay()];
        return `${year}/${month}/${day}(${weekday})`;
      }

      /**
       * è¿è¡ŒAIåˆ†æï¼ˆä½¿ç”¨ç»Ÿä¸€å·¥å…·æ¨¡å—ï¼‰
       * @param {string} providerId - æä¾›å•† ID
       */
      async function runAiAnalysis(providerId = 'deepseek') {
        await executeAiAnalysis(
          providerId,
          aiProviders,
          buildAiPrompt,
          sailingScheduleSystemPrompt,
          {
            onError: (message) => {
              showError(ErrorType.API_ERROR, 'API_REQUEST_FAILED', { message });
            }
          }
        );
      }

      // é¡µé¢å¸è½½æ—¶æ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
      window.addEventListener('beforeunload', () => {
        eventListeners.cleanup();
      });

      // åˆå§‹åŒ– - ä½¿ç”¨ requestIdleCallback ä¼˜åŒ–åˆå§‹åŠ è½½æ€§èƒ½
      const initializeApp = () => {
        init();
        // AIæ¨¡å—å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
        if ('requestIdleCallback' in window) {
          requestIdleCallback(() => {
            initSailingAiModule();
          }, { timeout: 2000 });
        } else {
          // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ setTimeout
          setTimeout(() => {
            initSailingAiModule();
          }, 100);
        }
      };

      if (document.readyState === 'loading') {
        const handleDOMContentLoaded = () => {
          initializeApp();
        };
        eventListeners.add(document, 'DOMContentLoaded', handleDOMContentLoaded);
      } else {
        // å¦‚æœæ–‡æ¡£å·²åŠ è½½ï¼Œä½¿ç”¨ requestAnimationFrame å»¶è¿Ÿåˆå§‹åŒ–
        requestAnimationFrame(() => {
          initializeApp();
        });
      }
    </script>

    <div class="page-footer">
      <h2>Monitor Â· èˆ¹æœŸè¡¨ä½¿ç”¨å£°æ˜</h2>
      <p>èµ„æ–™æ•´åˆè‡ªç”¨æˆ· Excel æ•°æ®ï¼Œè§£æç»“æœä»…ä¾›å†…éƒ¨ç ”åˆ¤ï¼Œä¸æ„æˆå¯¹å¤–æŠ¥ä»·æˆ–æŠ•èµ„å»ºè®®ã€‚</p>
      <p>æ‰€æœ‰æ•°æ®ä»…åœ¨æœ¬åœ°æµè§ˆå™¨è§£æï¼Œä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</p>
      <p>AI æœåŠ¡ç”± DeepSeek / KIMI / é€šä¹‰åƒé—® API é©±åŠ¨ï¼Œæ‰€æœ‰è°ƒç”¨è´¹ç”¨ä¸åˆè§„è´£ä»»ç”±ä½¿ç”¨è€…è‡ªæ‹…ï¼Œæ¶‰åŠå®¢æˆ·æˆ–æ•æ„Ÿæ•°æ®æ—¶è¯·å…ˆå®Œæˆè„±æ•å¤„ç†ã€‚</p>
    </div>

    <!-- ä½¿ç”¨ Gist å­˜å‚¨ç³»ç»Ÿï¼ˆç”¨æˆ·ç™½åå• + è®¿é—®è®°å½•ï¼‰ -->
    <script src="vendor/auth-gist.js"></script>
  </body>
</html>


