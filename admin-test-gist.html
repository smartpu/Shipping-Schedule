<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Â· Gist è®¿é—®æ—¥å¿—æµ‹è¯•</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
    <script src="vendor/lib-loader.js"></script>
    <script src="vendor/common-utils.js"></script>
    <script src="vendor/error-handler.js"></script>
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/auth-gist.js"></script>
</head>
<body data-page="admin-test-gist.html">
    <div class="dashboard-container">
        <!-- å·¦ä¾§å¯¼èˆªæ å ä½å®¹å™¨ï¼ˆå°†ç”±sidebar-loader.jsåŠ¨æ€åŠ è½½ï¼‰ -->
        <div id="sidebar-placeholder"></div>

        <!-- å³ä¾§å†…å®¹ -->
        <main class="dashboard-content">
            <div class="container">
                <!-- é¡¶éƒ¨ä»‹ç»å¡ç‰‡ -->
                <div class="section-intro">
                    <div class="section-intro-header">
                        <div class="section-intro-content">
                            <h2>Admin Â· Gist è®¿é—®æ—¥å¿—æµ‹è¯•</h2>
                            <p>æ£€æŸ¥è®¿é—®æ—¥å¿—è®°å½•ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ï¼Œå¸®åŠ©å®šä½é—®é¢˜</p>
                        </div>
                        <div class="section-intro-actions">
                            <a href="dashboard.html?tab=admin" class="tool-link" aria-label="è¿”å›å·¥å…·é›†é¦–é¡µ">â† è¿”å›é¦–é¡µ</a>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                <div class="card-white">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button type="button" class="filter-btn btn-sweep-blue" onclick="runDiagnostics()">
                            ğŸ” å¼€å§‹è¯Šæ–­
                        </button>
                        <button type="button" class="filter-btn btn-sweep-blue" onclick="testSaveLog()">
                            ğŸ“ æµ‹è¯•ä¿å­˜è®¿é—®è®°å½•
                        </button>
                    </div>
                </div>

                <!-- è¯Šæ–­ç»“æœåŒºåŸŸ -->
                <section class="feature-section">
                    <div class="module-header">
                        <span class="module-badge">è¯Šæ–­ç»“æœ</span>
                        <div>
                            <h2 class="section-title">ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ <span>SYSTEM STATUS</span></h2>
                            <p class="module-desc">æ£€æŸ¥åè®®ã€API è¿æ¥ã€ç”¨æˆ·è®¤è¯ç­‰å…³é”®ç»„ä»¶</p>
                        </div>
                    </div>
                    <div class="card-white module-card mt-20" id="results">
                        <div style="text-align: center; padding: 40px; color: var(--color-text-tertiary);">
                            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­
                        </div>
                    </div>
                </section>

                <!-- ä½¿ç”¨å£°æ˜ -->
                <div class="card-white mt-20">
                    <h2 class="usage-statement-title">Admin Â· Gist è®¿é—®æ—¥å¿—æµ‹è¯•ä½¿ç”¨å£°æ˜</h2>
                    <p class="usage-statement-text">æ­¤å·¥å…·ç”¨äºè¯Šæ–­è®¿é—®æ—¥å¿—è®°å½•ç³»ç»Ÿçš„é—®é¢˜ï¼Œæ‰€æœ‰æµ‹è¯•æ•°æ®ä»…ç”¨äºè°ƒè¯•ç›®çš„ã€‚</p>
                    <p class="usage-statement-text">è¯Šæ–­ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸ä¼šå½±å“å®é™…çš„è®¿é—®æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚</p>
                </div>
            </div>
        </main>
    </div>

    <!-- å¼•å…¥å¯¼èˆªæ å…¬å…±ç»„ä»¶ -->
    <script src="vendor/sidebar-loader.js"></script>
    <script>
        init001ToolPage('admin-test-gist.html', 'admin');
    </script>
    <script>
        const GIST_API_URL = '/api/gist-storage';
        
        async function runDiagnostics() {
            const results = document.getElementById('results');
            results.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">æ­£åœ¨è¯Šæ–­...</div>';
            
            const checks = [];
            
            // æ£€æŸ¥ 1: åè®®å’Œæœ¬åœ°æµ‹è¯•æ¨¡å¼
            const protocol = window.location.protocol;
            const isLocalTest = protocol === 'file:' || new URLSearchParams(window.location.search).get('localtest') === 'true';
            checks.push({
                name: 'åè®®å’Œæœ¬åœ°æµ‹è¯•æ¨¡å¼',
                status: isLocalTest ? 'warning' : 'ok',
                message: isLocalTest 
                    ? `âš ï¸ å½“å‰ä¸ºæœ¬åœ°æµ‹è¯•æ¨¡å¼ï¼ˆ${protocol === 'file:' ? 'file:// åè®®' : 'localtest=true'}ï¼‰ï¼Œè®¿é—®è®°å½•å°†è¢«è·³è¿‡`
                    : `âœ… åè®®æ­£å¸¸ï¼š${protocol}`
            });
            
            // æ£€æŸ¥ 2: API URL
            checks.push({
                name: 'API URL é…ç½®',
                status: 'ok',
                message: `âœ… API URL: ${GIST_API_URL}`
            });
            
            // æ£€æŸ¥ 3: æµ‹è¯• API è¿æ¥
            try {
                const response = await fetch(`${GIST_API_URL}?type=logs`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    checks.push({
                        name: 'API è¿æ¥æµ‹è¯•',
                        status: 'ok',
                        message: `âœ… API è¿æ¥æ­£å¸¸ï¼Œå½“å‰æœ‰ ${Array.isArray(data) ? data.length : 0} æ¡è®¿é—®è®°å½•`
                    });
                } else {
                    const errorText = await response.text();
                    checks.push({
                        name: 'API è¿æ¥æµ‹è¯•',
                        status: 'error',
                        message: `âŒ API è¿”å›é”™è¯¯: ${response.status} ${response.statusText} - ${errorText.substring(0, 200)}`
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'API è¿æ¥æµ‹è¯•',
                    status: 'error',
                    message: `âŒ API è¿æ¥å¤±è´¥: ${error.message}`
                });
            }
            
            // æ£€æŸ¥ 4: è®¤è¯æ•°æ®
            const authData = localStorage.getItem('shipping_tools_auth');
            if (authData) {
                try {
                    const auth = JSON.parse(authData);
                    // æ³¨æ„ï¼šè®¤è¯æ•°æ®ä¸­ä½¿ç”¨çš„æ˜¯ expiryï¼Œä¸æ˜¯ expiryTime
                    const expiryTime = auth.expiry || auth.expiryTime || 0;
                    const isExpired = expiryTime > 0 && Date.now() > expiryTime;
                    
                    if (expiryTime === 0) {
                        // å¦‚æœæ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œå¯èƒ½æ˜¯æ—§æ ¼å¼æ•°æ®
                        checks.push({
                            name: 'ç”¨æˆ·è®¤è¯çŠ¶æ€',
                            status: 'warning',
                            message: `âš ï¸ è®¤è¯æ•°æ®æ ¼å¼å¼‚å¸¸ï¼ˆç¼ºå°‘è¿‡æœŸæ—¶é—´ï¼‰ï¼Œå»ºè®®é‡æ–°ç™»å½•: ${auth.name || 'æœªçŸ¥'} (${auth.email || 'æœªçŸ¥'})`
                        });
                    } else if (isExpired) {
                        checks.push({
                            name: 'ç”¨æˆ·è®¤è¯çŠ¶æ€',
                            status: 'warning',
                            message: `âš ï¸ è®¤è¯å·²è¿‡æœŸï¼ˆè¿‡æœŸæ—¶é—´: ${new Date(expiryTime).toLocaleString('zh-CN')}ï¼‰`
                        });
                    } else {
                        const remainingDays = Math.ceil((expiryTime - Date.now()) / (24 * 60 * 60 * 1000));
                        checks.push({
                            name: 'ç”¨æˆ·è®¤è¯çŠ¶æ€',
                            status: 'ok',
                            message: `âœ… ç”¨æˆ·å·²è®¤è¯: ${auth.name || 'æœªçŸ¥'} (${auth.email || 'æœªçŸ¥'})ï¼Œå‰©ä½™ ${remainingDays} å¤©`
                        });
                    }
                } catch (e) {
                    checks.push({
                        name: 'ç”¨æˆ·è®¤è¯çŠ¶æ€',
                        status: 'error',
                        message: `âŒ è®¤è¯æ•°æ®æ ¼å¼é”™è¯¯: ${e.message}`
                    });
                }
            } else {
                checks.push({
                    name: 'ç”¨æˆ·è®¤è¯çŠ¶æ€',
                    status: 'warning',
                    message: 'âš ï¸ æœªæ‰¾åˆ°è®¤è¯æ•°æ®ï¼Œç”¨æˆ·å¯èƒ½æœªç™»å½•'
                });
            }
            
            // æ¸²æŸ“ç»“æœ
            let html = '';
            checks.forEach(check => {
                const statusClass = check.status === 'ok' ? 'stat-card' : 
                                   check.status === 'warning' ? 'stat-card' : 'stat-card';
                const statusIcon = check.status === 'ok' ? 'âœ…' : 
                                  check.status === 'warning' ? 'âš ï¸' : 'âŒ';
                const statusColor = check.status === 'ok' ? 'var(--color-brand-blue)' : 
                                    check.status === 'warning' ? 'var(--color-brand-orange)' : '#dc3545';
                
                html += `
                    <div class="stat-card" style="border-left: 4px solid ${statusColor}; margin-bottom: 16px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 15px; color: var(--color-text-primary);">
                            ${statusIcon} ${check.name}
                        </h3>
                        <p style="margin: 0; font-size: 13px; color: var(--color-text-secondary); line-height: 1.6;">
                            ${check.message}
                        </p>
                    </div>
                `;
            });
            
            // æ·»åŠ å»ºè®®
            html += '<div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--color-border);">';
            html += '<h3 style="margin: 0 0 12px 0; font-size: 15px; color: var(--color-text-primary);">ğŸ’¡ å»ºè®®</h3>';
            html += '<ul style="margin: 0; padding-left: 20px; color: var(--color-text-secondary); font-size: 13px; line-height: 1.8;">';
            if (isLocalTest) {
                html += '<li>å¦‚æœåœ¨æœ¬åœ°æµ‹è¯•ï¼Œè®¿é—®è®°å½•ä¼šè¢«è·³è¿‡ã€‚éƒ¨ç½²åˆ°æœåŠ¡å™¨åä¼šè‡ªåŠ¨è®°å½•ã€‚</li>';
            }
            if (!authData) {
                html += '<li>ç”¨æˆ·éœ€è¦å…ˆç™»å½•æ‰èƒ½è®°å½•è®¿é—®æ—¥å¿—ã€‚</li>';
            }
            html += '<li>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ã€‚</li>';
            html += '<li>æ£€æŸ¥ Vercel ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®ï¼šGITHUB_TOKEN, ACCESS_LOG_GIST_ID</li>';
            html += '<li>æ£€æŸ¥ Vercel å‡½æ•°æ—¥å¿—ï¼ŒæŸ¥çœ‹ API è°ƒç”¨æ˜¯å¦æœ‰é”™è¯¯ã€‚</li>';
            html += '</ul></div>';
            
            results.innerHTML = html;
        }
        
        async function testSaveLog() {
            const results = document.getElementById('results');
            results.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">æ­£åœ¨æµ‹è¯•ä¿å­˜è®¿é—®è®°å½•...</div>';
            
            try {
                const testLogEntry = {
                    page: 'è¯Šæ–­å·¥å…·',
                    name: 'æµ‹è¯•ç”¨æˆ·',
                    phone: 'test',
                    email: 'test@example.com',
                    timestamp: Date.now(),
                    date: new Date().toLocaleString('zh-CN')
                };
                
                const response = await fetch(GIST_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'addLog',
                        data: { logEntry: testLogEntry }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    results.innerHTML = `
                        <div class="stat-card" style="border-left: 4px solid var(--color-brand-blue);">
                            <h3 style="margin: 0 0 12px 0; font-size: 15px; color: var(--color-text-primary);">
                                âœ… æµ‹è¯•æˆåŠŸ
                            </h3>
                            <p style="margin: 0 0 12px 0; font-size: 13px; color: var(--color-text-secondary);">
                                <strong>ä¿å­˜æˆåŠŸï¼</strong>
                            </p>
                            <pre style="background: var(--color-bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto; margin: 0;">${JSON.stringify(result, null, 2)}</pre>
                            <details style="margin-top: 16px;">
                                <summary style="cursor: pointer; color: var(--color-text-secondary); font-size: 13px;">æŸ¥çœ‹æµ‹è¯•æ•°æ®</summary>
                                <pre style="background: var(--color-bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto; margin-top: 8px;">${JSON.stringify(testLogEntry, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    results.innerHTML = `
                        <div class="stat-card" style="border-left: 4px solid #dc3545;">
                            <h3 style="margin: 0 0 12px 0; font-size: 15px; color: var(--color-text-primary);">
                                âŒ æµ‹è¯•å¤±è´¥
                            </h3>
                            <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--color-text-secondary);">
                                <strong>ä¿å­˜å¤±è´¥</strong>
                            </p>
                            <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--color-text-secondary);">
                                çŠ¶æ€ç : ${response.status} ${response.statusText}
                            </p>
                            <pre style="background: var(--color-bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto; margin: 0; color: #dc3545;">${errorText.substring(0, 500)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `
                    <div class="stat-card" style="border-left: 4px solid #dc3545;">
                        <h3 style="margin: 0 0 12px 0; font-size: 15px; color: var(--color-text-primary);">
                            âŒ æµ‹è¯•å¤±è´¥
                        </h3>
                        <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--color-text-secondary);">
                            <strong>è¯·æ±‚å¤±è´¥</strong>
                        </p>
                        <p style="margin: 0; font-size: 13px; color: var(--color-text-secondary);">
                            é”™è¯¯: ${error.message}
                        </p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>

