<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Tools · 登录</title>
    <link rel="stylesheet" href="vendor/theme-styles.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <h1>Shipping Tools</h1>
            <p class="subtitle">航运工具集 · 一站式船期运费数据解析与分析平台</p>
            
            <form id="loginForm" role="form" aria-label="登录表单">
                <div class="login-form-group">
                    <label for="userName">用户</label>
                    <input type="text" id="userName" name="userName" placeholder="请输入您的用户名" required autocomplete="username" aria-required="true" aria-describedby="nameError">
                    <div class="login-error" id="nameError" role="alert" aria-live="polite">请输入您的用户名</div>
                </div>

                <div class="login-form-group">
                    <label for="userPassword">密码</label>
                    <input type="password" id="userPassword" name="userPassword" placeholder="请输入您的密码" required autocomplete="current-password" aria-required="true" aria-describedby="passwordError">
                    <div class="login-error" id="passwordError" role="alert" aria-live="polite">请输入您的密码</div>
                </div>

                <div class="login-form-group">
                    <label for="userEmail">邮箱</label>
                    <input type="email" id="userEmail" name="userEmail" placeholder="请输入您的邮箱地址" required autocomplete="email" aria-required="true" aria-describedby="emailError">
                    <div class="login-error" id="emailError" role="alert" aria-live="polite">请输入有效的邮箱地址</div>
                </div>

                <button type="submit" class="login-submit-btn" aria-label="提交登录表单">登录</button>
            </form>
        </div>
    </div>

    <!-- 使用 Gist 存储系统（用户白名单 + 访问记录） -->
    <script src="vendor/debug-utils.js"></script>
    <script src="vendor/auth-gist.js"></script>
    <!-- 登录页面逻辑（可考虑提取到 vendor/login-handler.js） -->
    <script>
        /**
         * 登录页面配置
         */
        const LOGIN_CONFIG = {
            AUTH_STORAGE_KEY: 'shipping_tools_auth',
            AUTH_WAIT_TIMEOUT: 1000, // 等待auth-gist.js加载的超时时间（毫秒）
            REDIRECT_DELAY: 300,      // 跳转延迟（毫秒）
            MAX_AUTH_WAIT_ATTEMPTS: 10 // 最大等待尝试次数
        };

        /**
         * 表单验证器
         */
        const FormValidator = {
            /**
             * 验证密码 - 允许字母、数字和特殊符号
             * @param {string} password - 密码
             * @returns {boolean} 是否有效
             */
            validatePassword(password) {
                const passwordRegex = /^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]+$/;
                return password.length > 0 && passwordRegex.test(password);
            },

            /**
             * 验证邮箱
             * @param {string} email - 邮箱地址
             * @returns {boolean} 是否有效
             */
            validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },

            /**
             * 验证所有字段
             * @param {Object} fields - 字段对象 {name, password, email}
             * @returns {Object} {isValid: boolean, errors: Object}
             */
            validateAll(fields) {
                const errors = {};
                let isValid = true;

                if (!fields.name || !fields.name.trim()) {
                    errors.name = '请输入您的用户名';
                    isValid = false;
                }

                if (!fields.password || !fields.password.trim()) {
                    errors.password = '请输入您的密码';
                    isValid = false;
                } else if (!this.validatePassword(fields.password)) {
                    errors.password = '密码只能包含字母、数字和特殊符号';
                    isValid = false;
                }

                if (!fields.email || !fields.email.trim()) {
                    errors.email = '请输入您的邮箱地址';
                    isValid = false;
                } else if (!this.validateEmail(fields.email.trim())) {
                    errors.email = '请输入有效的邮箱地址';
                    isValid = false;
                }

                return { isValid, errors };
            }
        };

        /**
         * 错误处理工具
         */
        const ErrorHandler = {
            /**
             * 清除错误状态
             * @param {HTMLElement} formGroup - 表单组元素
             */
            clearError(formGroup) {
                if (formGroup) {
                    formGroup.classList.remove('error');
                }
            },

            /**
             * 显示错误
             * @param {string} inputId - 输入框ID
             * @param {string} errorId - 错误信息ID
             * @param {string} message - 错误消息
             */
            showError(inputId, errorId, message) {
                const input = document.getElementById(inputId);
                if (!input) return;

                const formGroup = input.closest('.login-form-group');
                if (formGroup) {
                    formGroup.classList.add('error');
                }

                const errorEl = document.getElementById(errorId);
                if (errorEl) {
                    errorEl.textContent = message;
                }
            },

            /**
             * 显示所有错误
             * @param {Object} errors - 错误对象 {name: string, password: string, email: string}
             */
            showAllErrors(errors) {
                if (errors.name) {
                    this.showError('userName', 'nameError', errors.name);
                }
                if (errors.password) {
                    this.showError('userPassword', 'passwordError', errors.password);
                }
                if (errors.email) {
                    this.showError('userEmail', 'emailError', errors.email);
                }
            }
        };

        /**
         * 等待 auth-gist.js 加载完成
         * @returns {Promise<void>}
         */
        async function waitForAuthGist() {
            let attempts = 0;
            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.authGistInitialized !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= LOGIN_CONFIG.MAX_AUTH_WAIT_ATTEMPTS) {
                        clearInterval(checkInterval);
                        // 即使未加载完成也继续（降级处理）
                        resolve();
                    }
                }, LOGIN_CONFIG.AUTH_WAIT_TIMEOUT / LOGIN_CONFIG.MAX_AUTH_WAIT_ATTEMPTS);
            });
        }

        /**
         * 设置按钮加载状态
         * @param {HTMLButtonElement} button - 按钮元素
         * @param {boolean} isLoading - 是否加载中
         * @param {string} originalText - 原始文本
         */
        function setButtonLoading(button, isLoading, originalText) {
            if (isLoading) {
                button.disabled = true;
                button.classList.add('loading');
                button.innerHTML = '<span class="loading-spinner"></span>登录中...';
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                button.textContent = originalText;
            }
        }

        // DOM元素
        const loginForm = document.getElementById('loginForm');
        const nameInput = document.getElementById('userName');
        const passwordInput = document.getElementById('userPassword');
        const emailInput = document.getElementById('userEmail');
        const submitBtn = document.querySelector('.login-submit-btn');

        if (!loginForm || !nameInput || !passwordInput || !emailInput || !submitBtn) {
            console.error('登录表单元素未找到');
        } else {
            // 实时验证
            nameInput.addEventListener('blur', () => {
                const value = nameInput.value.trim();
                if (!value) {
                    ErrorHandler.showError('userName', 'nameError', '请输入您的用户名');
                } else {
                    ErrorHandler.clearError(nameInput.closest('.login-form-group'));
                }
            });

            passwordInput.addEventListener('blur', () => {
                const value = passwordInput.value.trim();
                if (!value) {
                    ErrorHandler.showError('userPassword', 'passwordError', '请输入您的密码');
                } else if (!FormValidator.validatePassword(value)) {
                    ErrorHandler.showError('userPassword', 'passwordError', '密码只能包含字母、数字和特殊符号');
                } else {
                    ErrorHandler.clearError(passwordInput.closest('.login-form-group'));
                }
            });

            emailInput.addEventListener('blur', () => {
                const value = emailInput.value.trim();
                if (!value) {
                    ErrorHandler.showError('userEmail', 'emailError', '请输入您的邮箱地址');
                } else if (!FormValidator.validateEmail(value)) {
                    ErrorHandler.showError('userEmail', 'emailError', '请输入有效的邮箱地址');
                } else {
                    ErrorHandler.clearError(emailInput.closest('.login-form-group'));
                }
            });
                
            // Enter 键提交表单
            [nameInput, passwordInput, emailInput].forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        loginForm.dispatchEvent(new Event('submit'));
                    }
                });
            });
                
            // 表单提交
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const originalText = submitBtn.textContent;
                setButtonLoading(submitBtn, true, originalText);
                
                const formData = {
                    name: nameInput.value.trim(),
                    password: passwordInput.value.trim(),
                    email: emailInput.value.trim()
                };
                
                // 验证所有字段
                const validation = FormValidator.validateAll(formData);
                
                if (!validation.isValid) {
                    ErrorHandler.showAllErrors(validation.errors);
                    setButtonLoading(submitBtn, false, originalText);
                    return;
                }
                
                // 等待 auth-gist.js 加载完成
                await waitForAuthGist();
                
                // 保存到 localStorage（auth-gist.js 会读取）
                // 注意：password 也作为 phone 保存（用于本地测试用户验证）
                const authData = {
                    name: formData.name,
                    password: formData.password,
                    email: formData.email,
                    phone: formData.password, // 密码作为手机号（用于本地测试用户）
                    level: 'user',
                    timestamp: Date.now()
                };
                localStorage.setItem(LOGIN_CONFIG.AUTH_STORAGE_KEY, JSON.stringify(authData));
                
                // 触发 storage 事件（让其他标签页也能知道登录状态）
                window.dispatchEvent(new StorageEvent('storage', {
                    key: LOGIN_CONFIG.AUTH_STORAGE_KEY,
                    newValue: JSON.stringify(authData)
                }));
                
                // 短暂延迟后跳转，让用户看到成功状态
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, LOGIN_CONFIG.REDIRECT_DELAY);
            });
        }
    </script>
</body>
</html>
